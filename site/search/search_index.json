{"config":{"lang":["ja"],"separator":"[\\s\\-\uff0c\u3002]+","pipeline":["stemmer"]},"docs":[{"location":"","title":"Home","text":""},{"location":"#welcome-to-roll-docs","title":"Welcome to Roll-Docs!","text":"<p>\u6b22\u8fce\u6765\u5230\u6211\u7684\u4e2a\u4eba\u6587\u6863\u3002</p> <p>\u4e86\u89e3\u66f4\u591a\u8bf7\u70b9\u51fb Roll\u3002</p>"},{"location":"#introduction","title":"Introduction","text":"<ul> <li>  \u5f00\u59cb\u4e8e2023.3.20</li> <li>  \u4e3b\u8981\u7528\u4e8e\u6574\u7406\u5b66\u4e60\u7b14\u8bb0</li> <li> \u5c0f\u767d\u4e00\u53ea\uff0c\u5982\u9047\u5230\u9519\u8bef\uff0c\u8bf7\u591a\u8c05\u89e3</li> <li>  \u4f60\u53ef\u4ee5\u901a\u8fc7<code>rollroll520@qq.com</code>\u4e3a\u6211\u63d0\u51fa\u4efb\u4f55\u5b9d\u8d35\u7684\u5efa\u8bae\uff01</li> <li>  \u5f00\u59cb\u9605\u8bfb\u5427~</li> </ul>"},{"location":"LearnTech/LearnGLTF/","title":"xr-frame\u8d44\u6e90","text":"<p>\u7b80\u4ecb</p> <p>\u5728\u5fae\u4fe1\u5c0f\u7a0b\u5e8f<code>xr-frame</code>\u6846\u67b6\u4e0b\u901a\u8fc7<code>gltf/glb</code>\u5b9e\u73b0<code>AR+VR</code>\u65f6\u7531\u5df2\u67093D\u8d44\u6e90\u83b7\u53d6<code>gltf/glb</code>\u7684\u4e00\u79cd\u89e3\u51b3\u65b9\u6848</p>"},{"location":"LearnTech/LearnGLTF/#unitygltf","title":"\u4eceunity\u4e2d\u5bfc\u51fagltf","text":""},{"location":"LearnTech/LearnGLTF/#univrmunitygltfglb","title":"UniVRM\u4eceunity\u5bfc\u51fagltf/glb","text":"<ol> <li>\u5728unity\u4e2d\u6dfb\u52a0UniVRM\u63d2\u4ef6</li> <li>\u5728scene\u4e2d\u6dfb\u52a0\u9700\u8981\u5bfc\u51fa\u7684\u6a21\u578b</li> <li>\u9009\u4e2d\u76ee\u6807\u6a21\u578b\u5bfc\u51fa</li> <li>\u5728\u9009\u62e9\u6587\u4ef6\u65f6\u4fee\u6539\u6587\u4ef6\u6269\u5c55\u540d\u53ef\u4ee5\u5206\u522b\u5bfc\u51fagltf/glb\u4e24\u79cd\u683c\u5f0f</li> <li>\u5bfc\u51fa\u8bbe\u7f6e\u4e2d\u7b2c1\u9879\u7b2c2\u9879\u53ef\u4ee5\u52fe\u9009</li> </ol> \u5b98\u65b9\u7684\u7b80\u4ecb <p>Unity-Supports 2019.4 and later You can import and export <code>glTF-2.0 in</code> Unity's editor and runtime. implement <code>KHR_materials_unlit</code> implement <code>KHR_texture_transform</code> (partial)</p> <p>\u53ef\u80fd\u5b58\u5728\u7684\u95ee\u9898</p> <ul> <li> <p><code>XR-frame</code>\u5728\u63a5\u6536<code>glb/gltf</code>\u8d44\u6e90\u6587\u4ef6\u65f6,\u53ef\u80fd\u4f1a\u663e\u793a\u6240\u9700\u7684<code>KHR_texture_transform</code>\u63d2\u4ef6\u4e0d\u5b58\u5728\uff0c\u5bfc\u81f4\u52a0\u8f7d\u6a21\u578b\u5931\u8d25\u3002</p> </li> <li> <p>\u5e76\u4e14\u5728\u4f7f\u7528<code>XR-frame-cli</code>\u8fdb\u884c\u4f18\u5316\u65f6\u5b58\u5728\u7f51\u683c\u7d22\u5f15\u8fc7\u5927\u7684\u60c5\u51b5\uff0c\u53ea\u6709\u5728\u5bfc\u51fa\u8bbe\u7f6e\u4e2d\u52fe\u9009\u7b2c1\u9879\u7b2c2\u9879\u65f6\u624d\u80fd\u6210\u529f\u3002</p> </li> </ul>"},{"location":"LearnTech/LearnGLTF/#seinjsunitytoolkit","title":"SeinJSUnityToolkit","text":"<ol> <li>\u5b98\u65b9\u63d0\u793a\u4e0b\u8f7d<code>unitypackage</code>\u5230unity\u5373\u53ef\u4f7f\u7528<code>SeinToolkit</code>\uff0c\u4f46\u662f\u6700\u65b0\u7248\u7684\u5305\u5bfc\u5165\u9879\u76ee\u4e2d\u540e\u5b58\u5728\u95ee\u9898\uff0c\u53ef\u80fd\u662f\u56e0\u4e3a\u7248\u672c\u4e0d\u517c\u5bb9\u3002</li> <li>\u901a\u8fc7\u6587\u6863\u4e2d\u63d0\u793a\u7684\u901a\u8fc7npm\u521b\u5efasein\u547d\u4ee4\u884c\u5de5\u5177\u53ef\u4ee5\u7a7f\u4ef6sein\u9879\u76ee\u4f46\u4e0b\u8f7d\u7684\u7248\u672c\u662f1.2.6\uff0c\u6700\u65b0\u7248\u4e3a1.3.3\uff0c\u5e76\u4e14\u901a\u8fc7<code>sein new</code>\u521b\u5efa\u7684sein\u9879\u76ee\u5fc5\u987b\u7528</li> </ol> \u5bfc\u5165fbx\u5e76\u5bfc\u51fa <ol> <li>\u5bfc\u5165fbx\u65f6\u51fa\u73b0\u65e0\u6750\u8d28\u7684\u73b0\u8c61</li> </ol> \u8e29\u7684\u5751 <ul> <li>\u901a\u8fc7<code>gltfpack</code>\u7684-cc\u62d3\u5c55\u6307\u4ee4\u538b\u7f29\u7684<code>gltf</code>\u6a21\u578b\u65e0\u6cd5\u6b63\u786e<code>import</code>\u5230<code>sein</code>\u9879\u76ee\u4e2d</li> <li><code>seinJS</code>\u5bfc\u51fa\u7684<code>gltf</code>\u6587\u4ef6\u4e5f\u53ef\u80fd\u65e0\u6cd5\u5728<code>xr-frame</code>\u4e2d\u6253\u5f00\uff0c\u5e76\u4e0d\u662f\u5b8c\u5168\u4f18\u4e8e<code>UniVRM</code></li> <li>\u76f8\u5bf9\u4e8e\u6bd4\u8f83\u5927\u76843D\u6a21\u578b\u6587\u4ef6\uff0c<code>sein</code>\u7684\u8868\u73b0\u4f1a\u6bd4<code>UniVRM</code></li> <li>\u6a21\u578b\u8fc7\u5927\u65f6<code>UniVRM</code>\u7684\u5bfc\u51fa\u6ca1\u6709\u538b\u7f29\u4f5c\u7528\uff0c\u4f46<code>seinJS</code>\u4e2d\u5fc5\u987b\u4f7f\u7528\u7684<code>sein/pbr</code>\u7740\u8272\u5668\u8c03\u6574\u4e0d\u597d\u4f1a\u8ba9\u6a21\u578b\u8f83\u4e3a\u4e25\u91cd\u5730\u5931\u771f</li> <li>\u56e0\u6b64\u5f53<code>seinJS</code>\u5bfc\u5165<code>xr-frame</code>\u4e2d\u4e0d\u8d77\u4f5c\u7528\u65f6\u5e94\u53ca\u65f6\u6539\u7528<code>UniVRM</code></li> <li><code>fbx</code>\u6587\u4ef6\u5bfc\u5165<code>unity</code>\u4e2d\u65e0\u6cd5\u663e\u793a\u80cc\u9762</li> </ul>"},{"location":"LearnTech/LearnGLTF/#gltf","title":"\u4f18\u5316gltf\u6587\u4ef6","text":""},{"location":"LearnTech/LearnGLTF/#gltfpack","title":"gltfpack\u4f18\u5316\u538b\u7f29","text":"<ol> <li>\u5728gltfpack\u5b98\u7f51\u4e2d\u83b7\u53d6\u5408\u9002\u7684gltfpack\u7248\u672c</li> <li>\u5c06<code>gltfpack</code>\u5de5\u5177\u5305\u4e0b\u8f7d\u5230\u672c\u5730</li> <li>\u5728\u5de5\u5177\u5305\u7684\u8def\u5f84\u4e0b\u6253\u5f00\u547d\u4ee4\u884c\u7a97\u53e3</li> <li>\u901a\u8fc7<code>gltfpack -i scene.gltf -o scene.glb</code>\u5c06\u6307\u5b9agltf/glb\u6587\u4ef6\u8fdb\u884c\u538b\u7f29\u5230\u6307\u5b9a\u76ee\u5f55</li> </ol> \u6307\u4ee4\u7684\u6269\u5c55\u53ef\u9009\u9879 <ul> <li> <p><code>-cc</code>: produce compressed gltf/glb files (requires <code>EXT_meshopt_compression</code>)</p> </li> <li> <p><code>-tc</code>: convert all textures to KTX2 with BasisU supercompression (requires <code>KHR_texture_basisu</code> and may require<code>-tp</code> flag for compatibility with WebGL 1)</p> </li> <li> <p><code>-mi</code>: use mesh instancing when serializing references to the same meshes (requires <code>EXT_mesh_gpu_instancing</code>)</p> </li> <li> <p><code>-si R</code>: simplify meshes targeting triangle count ratio R (default: 1; R should be between 0 and 1) The following settings are frequently used to restrict some optimizations:</p> </li> <li> <p><code>-kn</code>: keep named nodes and meshes attached to named nodes so that named nodes can be transformed externally</p> </li> <li> <p><code>-km</code>: keep named materials and disable named material merging</p> </li> <li> <p><code>-ke</code>: keep extras data</p> </li> </ul>"},{"location":"LearnTech/LearnGLTF/#xr-frame-cli","title":"xr-frame-cli\u4f18\u5316\u538b\u7f29","text":"<ol> <li> <p>\u901a\u8fc7npm\u5c06xr-frame-cli\u6dfb\u52a0\u5230\u9879\u76ee\u4e2d</p> <p><code>md \"\u6dfb\u52a0\u547d\u4ee4\u884c\u5de5\u5177\" npm i xr-frame-cli</code></p> </li> <li> <p>\u6253\u5f00\u547d\u4ee4\u884c\u5de5\u5177\uff08\u56e0\u4e3a\u5df2\u7ecf\u5168\u5c40\u6dfb\u52a0\u4e86<code>xr-frame-cli</code>\uff0c\u4efb\u610f\u4e00\u4e2a\u76ee\u5f55\u4e0b\u90fd\u53ef\u4ee5\u4f7f\u7528\u8be5\u5de5\u5177\uff09</p> </li> <li>\u901a\u8fc7<code>xr-frame gltf -h</code>\u6216<code>xr-frame env-data -h</code>\u83b7\u53d6\u5de5\u5177\u4f7f\u7528\u6307\u4ee4</li> </ol> <p><code>gltfpack</code>\u4e0e<code>xr-frame-cli</code>\u7684\u533a\u522b</p> <ul> <li> <p><code>gltfpack</code>\u7684\u5bf9\u4e8e\u6587\u4ef6\u5927\u5c0f\u7684\u538b\u7f29\u6548\u679c\u660e\u663e\u9ad8\u4e8e<code>xr-frame-cli</code></p> </li> <li> <p><code>gltfpack</code>\u53ef\u4ee5\u538b\u7f29<code>glb/gltf</code>\u4e24\u79cd\u683c\u5f0f\uff1b\u800c<code>xr-frame-cli</code>\u4ec5\u80fd\u538b\u7f29<code>gltf</code>\u6587\u4ef6</p> </li> <li> <p><code>gltfpack</code>\u751f\u6210\u7684<code>gltf/glb</code>\u6587\u4ef6\u53ef\u80fd\u5728\u88ab<code>xr-frame</code>\u52a0\u8f7d\u65f6\u5b58\u5728\u9519\u8bef</p> </li> </ul>"},{"location":"LearnTech/LearnGLTF/#env-data","title":"\u83b7\u53d6\u73af\u5883\u6570\u636eenv-data","text":"<p>xr-frame-cli\u63d0\u4f9b\u4e86\u73af\u5883\u6570\u636e\u7684\u751f\u6210\u529f\u80fd\u3002\u4f7f\u7528\u6b63\u786e\u7684\u73af\u5883\u8d34\u56fe\u5373\u53ef\u5bfc\u51faxr-frame\u6240\u9700\u7684\u73af\u5883\u6570\u636eenv-data \u56e0\u6b64\u5173\u952e\u5728\u4e8e\u83b7\u53d6\u73af\u5883\u8d34\u56fe</p>"},{"location":"LearnTech/LearnGit/","title":"Git\u7684\u4f7f\u7528\uff08\u5907\u5fd8\uff09","text":"<p>\u6559\u7a0b</p> <p>Click Git\u83dc\u9e1f\u6559\u7a0b</p>"},{"location":"LearnTech/LearnMkdocs/","title":"Mkdocs\u6587\u6863\u7528\u6cd5","text":"<p>\u53c2\u8003</p> <p>Click MkDocs\u5b98\u7f51</p>"},{"location":"LearnTech/LearnMkdocs/#hide","title":"hide \u7684\u7528\u6cd5","text":""},{"location":"LearnTech/LearnMkdocs/#_1","title":"\u7528\u6cd5\u793a\u4f8b","text":"<p>\u5728md\u6587\u4ef6\u5934\u90e8\u6dfb\u52a0\u4e00\u4e0b\u4ee3\u7801\u5373\u53ef\u9009\u62e9\u6027\u5730\u9690\u85cf\u5bfc\u822a\u680f</p> \u4ee3\u7801 <pre><code>---\nhide:\n- navigation\n- toc\n---\n</code></pre>"},{"location":"LearnTech/LearnMkdocs/#admonition","title":"Admonition\u7684\u7528\u6cd5","text":""},{"location":"LearnTech/LearnMkdocs/#_2","title":"\u7528\u6cd5\u793a\u4f8b","text":"<p>Note</p> \u6458\u8981\u4ee3\u7801 <p>\u8fd9\u662f\u4e00\u4e2a\u666e\u901a\u7684Admonition</p> <pre><code>!!! note\n    ...\n</code></pre> Note \u6458\u8981\u4ee3\u7801 <p>\u8fd9\u662f\u4e00\u4e2a\u53ef\u6298\u53e0\u7684Admonition</p> <pre><code>??? note\n    ...\n</code></pre> Note \u6458\u8981\u4ee3\u7801 <p>\u8fd9\u662f\u4e00\u4e2a\u9ed8\u8ba4\u5c55\u5f00\u7684\u53ef\u6298\u53e0Admonition</p> <pre><code>???+ note\n    ...\n</code></pre> <p>Success</p> \u6458\u8981\u4ee3\u7801 <p>\u8fd9\u662f\u4e00\u4e2a\u5176\u4ed6type\u7684Admonition</p> <pre><code>???+ success|(or other types listed below)\n    ...\n</code></pre> <p>\u8fd8\u80fd\u66f4\u6539Admonition\u5c0f\u6807\u9898</p> \u6458\u8981\u4ee3\u7801 <p>\u8fd8\u80fd\u66f4\u6539Admonition\u5c0f\u6807\u9898</p> <pre><code>!!! note \"your title\"\n    ...\n</code></pre>"},{"location":"LearnTech/LearnMkdocs/#_3","title":"\u81ea\u5b9a\u4e49\u793a\u4f8b","text":"\u5185\u7f6e\u7684type\u4fee\u6539\u9ed8\u8ba4\u56fe\u6807\u7684\u65b9\u5f0f \u4ee5\u4e0b\u662f\u6240\u6709\u652f\u6301\u7684Admonition\u7684type <p>Note</p> <p>Abstract</p> <p>Info</p> <p>Tip</p> <p>Success</p> <p>Question</p> <p>Warning</p> <p>Failure</p> <p>Danger</p> <p>Bug</p> <p>Example</p> <p>Quote</p> \u5728yml\u6587\u4ef6\u4e2d\u6dfb\u52a0\u4e00\u4e0b\u90e8\u5206\u53ef\u4ee5\u4fee\u6539Admonition\u7684\u56fe\u6807 <pre><code>theme:\nicon:\nadmonition:\n&lt;type&gt;: &lt;icon&gt;\n</code></pre>"},{"location":"LearnTech/LearnMkdocs/#content-tabs","title":"Content tabs\u9009\u9879\u5361\u7684\u7528\u6cd5","text":""},{"location":"LearnTech/LearnMkdocs/#button","title":"Button\u7684\u7528\u6cd5","text":""},{"location":"LearnTech/LearnMkdocs/#_4","title":"\u7528\u6cd5\u793a\u4f8b","text":"\u900f\u660eButton\u5b9e\u5fc3Button\u5e26\u56fe\u6807\u7684Button\u94fe\u63a5\u5230\u7f51\u9875\u7684Button <p>\u900f\u660eButton\u793a\u4f8b</p> <p>\u4ee3\u7801</p> <pre><code>[\u900f\u660eButton\u793a\u4f8b](# Button\u7684\u7528\u6cd5){ .md-button }\n</code></pre> <p>\u5b9e\u5fc3Button\u793a\u4f8b</p> <p>\u4ee3\u7801</p> <pre><code>[\u5b9e\u5fc3Button\u793a\u4f8b](# Button\u7684\u7528\u6cd5){ .md-button .md-button--primary }\n</code></pre> <p>\u56fe\u6807\u793a\u4f8b </p> <p>\u4ee3\u7801</p> <pre><code>[\u56fe\u6807\u793a\u4f8b :fontawesome-solid-paper-plane:](# Button\u7684\u7528\u6cd5){ .md-button }\n</code></pre> <p>\u7f51\u9875\u94fe\u63a5\u793a\u4f8b </p> <p>\u4ee3\u7801</p> <pre><code>[\u7f51\u9875\u94fe\u63a5\u793a\u4f8b :homes:](https://roll0814.cn){ .md-button }\n</code></pre>"},{"location":"LearnTech/LearnMkdocs/#code-copy-button","title":"code copy button\u7684\u7528\u6cd5","text":""},{"location":"LearnTech/LearnMkdocs/#_5","title":"\u4ee3\u7801\u590d\u5236\u6309\u94ae","text":"\u5f00\u542fcode copy button(\u9ed8\u8ba4\u6253\u5f00)\u5173\u95edcode copy button <p>\u4ee3\u7801</p> <pre><code>    ```{.md .copy}\n        content\n    ```\n</code></pre> <p>\u4ee3\u7801</p> <pre><code>    ```{.md .no-copy}\n        content\n    ```\n</code></pre>"},{"location":"LearnTech/LearnMkdocs/#code-block","title":"code block\u7684\u7528\u6cd5","text":""},{"location":"LearnTech/LearnMkdocs/#_6","title":"\u57fa\u7840\u4f7f\u7528","text":"\u8fd9\u662f\u4e00\u4e2a\u52a0\u4e86\u6807\u9898\u7684code block<pre><code>    ```md title=\"\u8fd9\u662f\u4e00\u4e2acode block\"\ncontent\n```\n</code></pre>"},{"location":"LearnTech/LearnMkdocs/#_7","title":"\u9ad8\u4eae","text":"\u8fd9\u662f\u4e00\u4e2a\u52a0\u4e86\u884c\u53f7\u7684code block<pre><code>    ``` yaml linenums=\"1\" title=\"\u8fd9\u662f\u4e00\u4e2a\u52a0\u4e86\u884c\u53f7\u7684code block\"\ncontent\n```\n</code></pre> \u7279\u6b8a\u884c\u9ad8\u4eae \u6548\u679c\u5b9e\u73b0 \u8fd9\u662f\u4e00\u4e2a\u52a0\u4e86\u7279\u6b8a\u884c\u9ad8\u4eae\u7684code block<pre><code>\u674e\u767d\u524d\u65f6\u539f\u6709\u6708\uff0c\u60df\u6709\u674e\u767d\u8bd7\u80fd\u8bf4\u3002 \n\u674e\u767d\u5982\u4eca\u5df2\u4ed9\u53bb\uff0c\u6708\u5728\u9752\u5929\u51e0\u5706\u7f3a\u3002 \n\u4eca\u4eba\u72b9\u6b4c\u674e\u767d\u8bd7\uff0c\u660e\u6708\u8fd8\u5982\u674e\u767d\u65f6\u3002 \n\u6211\u5b66\u674e\u767d\u5bf9\u660e\u6708\uff0c\u767d\u4e0e\u660e\u6708\u5b89\u80fd\u77e5\uff1f \n\u674e\u767d\u80fd\u8bd7\u590d\u80fd\u9152\uff0c\u6211\u4eca\u767e\u676f\u590d\u5343\u9996\u3002 \n\u6211\u6127\u867d\u65e0\u674e\u767d\u624d\uff0c\u6599\u5e94\u6708\u4e0d\u5acc\u6211\u4e11\u3002 \n\u6211\u4e5f\u4e0d\u767b\u5929\u5b50\u8239\uff0c\u6211\u4e5f\u4e0d\u4e0a\u957f\u5b89\u7720\u3002 \n\u59d1\u82cf\u57ce\u5916\u4e00\u8305\u5c4b\uff0c\u4e07\u6811\u6885\u82b1\u6708\u6ee1\u5929\u3002 \n            \u5510\u5bc5\u300a\u628a\u9152\u5bf9\u6708\u6b4c\u300b \n</code></pre> <pre><code>    ``` md hl_lines=\"5 6\" title=\"\u8fd9\u662f\u4e00\u4e2a\u52a0\u4e86\u7279\u6b8a\u884c\u9ad8\u4eae\u7684code block\"\n    \u674e\u767d\u524d\u65f6\u539f\u6709\u6708\uff0c\u60df\u6709\u674e\u767d\u8bd7\u80fd\u8bf4\u3002 \n    \u674e\u767d\u5982\u4eca\u5df2\u4ed9\u53bb\uff0c\u6708\u5728\u9752\u5929\u51e0\u5706\u7f3a\u3002 \n    \u4eca\u4eba\u72b9\u6b4c\u674e\u767d\u8bd7\uff0c\u660e\u6708\u8fd8\u5982\u674e\u767d\u65f6\u3002 \n    \u6211\u5b66\u674e\u767d\u5bf9\u660e\u6708\uff0c\u767d\u4e0e\u660e\u6708\u5b89\u80fd\u77e5\uff1f \n    \u674e\u767d\u80fd\u8bd7\u590d\u80fd\u9152\uff0c\u6211\u4eca\u767e\u676f\u590d\u5343\u9996\u3002 \n    \u6211\u6127\u867d\u65e0\u674e\u767d\u624d\uff0c\u6599\u5e94\u6708\u4e0d\u5acc\u6211\u4e11\u3002 \n    \u6211\u4e5f\u4e0d\u767b\u5929\u5b50\u8239\uff0c\u6211\u4e5f\u4e0d\u4e0a\u957f\u5b89\u7720\u3002 \n    \u59d1\u82cf\u57ce\u5916\u4e00\u8305\u5c4b\uff0c\u4e07\u6811\u6885\u82b1\u6708\u6ee1\u5929\u3002 \n                \u5510\u5bc5\u300a\u628a\u9152\u5bf9\u6708\u6b4c\u300b \n    ```\n</code></pre>"},{"location":"LearnTech/LearnMkdocs/#_8","title":"\u884c\u5185\u4ee3\u7801","text":"\u884c\u5185code block \u6548\u679c\u5b9e\u73b0 <p>The <code>inline()</code> function is used to generate a sequence of numbers.</p> \u5b9e\u73b0\u4ee3\u7801<pre><code>    \u00b7\u00b7\u00b7 `#!python inline()` \u00b7\u00b7\u00b7\n</code></pre>"},{"location":"LearnTech/LearnMkdocs/#code-block_1","title":"\u5b9a\u4e49code block\u7684\u989c\u8272","text":"<p>\u66f4\u6539code block\u7684\u989c\u8272</p> \u66f4\u6539extra.css\u6240\u7528\u5230\u7684\u53c2\u6570\u66f4\u6539\u524d\u666f\u80cc\u666f\u989c\u8272\u6240\u7528\u5230\u7684\u53c2\u6570\u66f4\u6539\u65b9\u5f0f <pre><code>--md-code-hl-number-color\n--md-code-hl-special-color\n--md-code-hl-function-color\n--md-code-hl-constant-color\n--md-code-hl-keyword-color\n--md-code-hl-string-color\n--md-code-hl-name-color\n--md-code-hl-operator-color\n--md-code-hl-punctuation-color\n--md-code-hl-comment-color\n--md-code-hl-generic-color\n--md-code-hl-variable-color\n</code></pre> <pre><code>--md-code-fg-color\n--md-code-bg-color\n--md-code-hl-color\n</code></pre> <p>\u6ce8\u610froot\u540e\u63a5 &gt; *</p> <pre><code>:root &gt; * {\n--md-code-hl-string-color: #0FF1CE;\n}\n</code></pre>"},{"location":"LearnTech/LearnMkdocs/#data-tables","title":"Data tables\u7684\u7528\u6cd5","text":""},{"location":"LearnTech/LearnMkdocs/#data-tables_1","title":"Data tables\u7528\u6cd5\u793a\u4f8b","text":"\u5de6\u5bf9\u9f50\u5c45\u4e2d\u5bf9\u9f50\u53f3\u5bf9\u9f50 \u6548\u679c\u5b9e\u73b0 Method Description <code>GET</code>      Fetch resource <code>PUT</code>  Update resource <code>DELETE</code>      Delete resource code<pre><code>| Method      | Description                          |\n| :---------- | :----------------------------------- |\n| `GET`       | :material-check:     Fetch resource  |\n| `PUT`       | :material-check-all: Update resource |\n| `DELETE`    | :material-close:     Delete resource |\n</code></pre> \u6548\u679c\u5b9e\u73b0 Method Description <code>GET</code>      Fetch resource <code>PUT</code>  Update resource <code>DELETE</code>      Delete resource code<pre><code>| Method      | Description                          |\n| :---------: | :----------------------------------: |\n| `GET`       | :material-check:     Fetch resource  |\n| `PUT`       | :material-check-all: Update resource |\n| `DELETE`    | :material-close:     Delete resource |\n</code></pre> \u6548\u679c\u5b9e\u73b0 Method Description <code>GET</code>      Fetch resource <code>PUT</code>  Update resource <code>DELETE</code>      Delete resource code<pre><code>| Method      | Description                          |\n| ----------: | -----------------------------------: |\n| `GET`       | :material-check:     Fetch resource  |\n| `PUT`       | :material-check-all: Update resource |\n| `DELETE`    | :material-close:     Delete resource |\n</code></pre>"},{"location":"LearnTech/LearnMkdocs/#_9","title":"\u4ece\u6587\u4ef6\u4e2d\u8f7d\u5165\u8868\u683c","text":"\u6548\u679c\u7b49\u540c\u4e8e\u5b9e\u73b0 \u65e5\u671f \u5929\u6c14 \u5fc3\u60c5 23.3.18 rain \u8fd8\u884c\u5427 23.3.19 rain \u8fd8\u884c\u5427 23.3.20 rain \u8fd8\u884c\u5427 <pre><code>| \u65e5\u671f      | \u5929\u6c14   | \u5fc3\u60c5   |\n|:--------|:-----|:-----|\n| 23.3.18 | rain | \u8fd8\u884c\u5427  |\n| 23.3.19 | rain | \u8fd8\u884c\u5427  |\n| 23.3.20 | rain | \u8fd8\u884c\u5427  |\n</code></pre> code<pre><code>**\u6b64\u5904\u4e3a\u4e86\u5c55\u793a\u4ee3\u7801\uff0c\u5728\u8bed\u53e5\u4e2d\u63d2\u5165\u4e86\\*\u53f7,\u4f7f\u7528\u65f6\u5e94\u5220\u53bb**\n{*{ read_excel('./example.xlsx', engine='openpyxl', sheet_name=\"Sheet1\") }*}\n</code></pre> <p>\u6ce8\u610f</p> <ul> <li>\u8f7d\u5165\u8868\u683c\u7684\u6548\u679c\u6bd4\u8f83\u5c40\u9650\uff0c\u5408\u5e76\u7b49\u5176\u4ed6\u6548\u679c\u5747\u65e0\u6cd5\u5b9e\u73b0</li> <li>\u6700\u540e\u7684\u6548\u679c\u4e0e\u666e\u901a\u7684data table\u7c7b\u4f3c</li> <li>\u6587\u6863\u6253\u5f00\u65f6\u65e0\u6cd5\u8f7d\u5165</li> <li>\u6587\u6863\u4e2d\u5bf9\u8f7d\u5165\u8bed\u53e5\u6ce8\u91ca\u65e0\u6548</li> </ul>"},{"location":"LearnTech/LearnOffiaccount/","title":"\u5fae\u4fe1\u516c\u4f17\u53f7","text":""},{"location":"LearnTech/LearnUnityCorgiEngine/","title":"Corgi Engine\uff08\u67ef\u57fa\u5f15\u64ce\uff09","text":"<p>\u53c2\u8003</p> <p>Click \u4e2d\u6587\u6587\u6863</p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/note/","title":"\u64cd\u4f5c\u7cfb\u7edf\u8bfe\u7a0b\u8bbe\u8ba1","text":""},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/note/#lab1_challenge1","title":"lab1_challenge1","text":"<p>\u4efb\u52a1\u76ee\u7684</p> <p>\u5c06\u7528\u6237\u7a0b\u5e8f\u51fd\u6570\u8c03\u7528\u5173\u7cfb\u901a\u8fc7<code>#!print_backtrace</code>\u56de\u6eaf\u6253\u5370\u51fa\u6765</p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/note/#_2","title":"\u9700\u8981\u5b8c\u5584\u7684\u5185\u5bb9","text":"<ul> <li>\u7cfb\u7edf\u8c03\u7528\u8def\u5f84</li> </ul> <p>\u901a\u8fc7ecall\u6307\u4ee4\u5b8c\u6210\u7cfb\u7edf\u8c03\u7528\u7684\uff0c\u4e14\u5728\u6267\u884cecall\u6307\u4ee4\u524d\uff0c\u6240\u6709\u7684\u53c2\u6570\uff08\u5373do_user_call\u51fd\u6570\u76848\u4e2a\u53c2\u6570\uff09\u5b9e\u9645\u4e0a\u90fd\u5df2\u7ecf\u8f7d\u5165\u5230RISC-V\u673a\u5668\u7684a0\u5230a7\uff0c\u8fd98\u4e2a\u5bc4\u5b58\u5668\u4e2d\uff08\u8fd9\u4e00\u6b65\u662f\u6211\u4eec\u7684\u7f16\u8bd1\u5668\u751f\u6210\u7684\u4ee3\u7801\u5e2e\u6211\u4eec\u5b8c\u6210\u7684\uff09\u3002ecall\u6307\u4ee4\u7684\u6267\u884c\u5c06\u6839\u636ea0\u5bc4\u5b58\u5668\u4e2d\u7684\u503c\u83b7\u5f97\u7cfb\u7edf\u8c03\u7528\u53f7\uff0c\u5e76\u4f7fRISC-V\u8f6c\u5230S\u6a21\u5f0f\uff08\u56e0\u4e3a\u6211\u4eec\u7684\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u542f\u52a8\u65f6\u5c06\u6240\u6709\u7684\u4e2d\u65ad\u3001\u5f02\u5e38\u3001\u7cfb\u7edf\u8c03\u7528\u90fd\u4ee3\u7406\u7ed9\u4e86S\u6a21\u5f0f\uff09\u7684trap\u5904\u7406\u5165\u53e3\u6267\u884c\uff08\u5728kernel/strap_vector.S\u6587\u4ef6\u4e2d\u5b9a\u4e49\uff09</p> <ul> <li>\u5728\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u4e2d\u83b7\u53d6\u7528\u6237\u7a0b\u5e8f\u7684\u6808\uff0c\u9700\u8981\u5728\u9677\u5165\u5230\u5185\u6838\u65f6\u627e\u5230\u7528\u6237\u8fdb\u7a0b\u7684\u7528\u6237\u6001\u6808</li> </ul> <p>\u901a\u8fc7fp(process.h\u91cc\u7684)\u8ffd\u8e2a\u6808\u5e95 \u51fd\u6570\u8c03\u7528\u65f6\u6808\u5e27\u7684\u7ed3\u6784\uff0c\u901a\u8fc7fp\u5bc4\u5b58\u5668(s0)\u5bfb\u627e\u5404\u4e2a\u6808\u5e27</p> <ul> <li>\u627e\u5230\u7528\u6237\u6001\u6808\u540e\uff0c\u901a\u8fc7\u7528\u6237\u6001\u6808\u7684\u7ed3\u6784\u8fdb\u884c\u6253\u5370\u64cd\u4f5c</li> </ul> <p>\u8bfb\u53d6\u51fa.symtab\u548c.strtab\u7684\u4fe1\u606f\u4e4b\u540e\u5c31\u53ef\u4ee5\u5f00\u59cb\u6253\u5370</p> <ul> <li>\u518d\u901a\u8fc7\u7528\u6237\u6808\u627e\u5230\u51fd\u6570\u7684\u8fd4\u56de\u5730\u5740\uff0c\u9700\u8981\u5c06\u865a\u62df\u5730\u5740\u8f6c\u6362\u4e3a\u6e90\u7a0b\u5e8f\u4e2d\u7684\u7b26\u53f7\u3002\u56e0\u6b64\u9700\u8981\u4e86\u89e3elf\u6587\u4ef6\u4e2d\u7684\u7b26\u53f7\u8282(.symTab section)(symTab\u6bb5\u662fELF\u4e2d\u5b58\u50a8\u7b26\u53f7\u8868\u7684\u6bb5\uff0c\u4e3b\u8981\u7528\u4e8e\u7f16\u8bd1\u94fe\u63a5\uff0c\u4e5f\u53ef\u4ee5\u53c2\u4e0e\u52a8\u6001\u5e93\u7684\u52a0\u8f7d)\u4ee5\u53ca\u5b57\u7b26\u4e32\u8282(.strTab section)\u7684\u76f8\u5173\u77e5\u8bc6\u3002\u901a\u8fc7\u4e24\u4e2a\u8282\u91cc\u5b58\u50a8\u7684\u5185\u5bb9\u4ee5\u53ca\u5b58\u50a8\u7684\u683c\u5f0f\u7b49\u5185\u5bb9\u3002</li> </ul>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/note/#elf","title":"Elf\u6587\u4ef6","text":"<ul> <li>elf\u6587\u4ef6</li> </ul> <p>\u57fa\u4e8eLinking view\u7684\u65b9\u5f0f\uff1a\u6839\u636eSection Header Table\u89e3\u6790Section\uff0c\u8fd9\u4e2a\u65f6\u5019\u6309\u7167\u57fa\u4e8e\u6587\u4ef6\u7684\u504f\u79fb\u91cf\u6765\u8bfb\u53d6\u4e0d\u540c\u7684Section\u7684\u5185\u5bb9\uff0c\u518d\u6839\u636eSection\u4e2d\u5bf9\u5e94\u7684\u6570\u636e\u6765\u89e3\u6790\u3002 \u57fa\u4e8eExecution view\u7684\u65b9\u5f0f\uff0c\u5148\u6253\u5f00\u6587\u4ef6\uff0c\u7136\u540e\u9010\u4e2a\u5c06PH Table\u4e2d\u7684segment\u901a\u8fc7m-map\u6620\u5c04\u5230\u5bf9\u5e94\u7684\u865a\u62df\u5185\u5b58\u7a7a\u95f4\uff0c\u7136\u540e\u904d\u5386segment\u7684\u5185\u5bb9\u3002</p> <ul> <li> <p>\u4e00\u4e2a ELF \u5934\u5728\u6587\u4ef6\u7684\u5f00\u59cb\uff0c\u4fdd\u5b58\u4e86\u8def\u7ebf\u56fe(road map)\uff0c\u63cf\u8ff0\u4e86\u8be5\u6587\u4ef6\u7684\u7ec4\u7ec7\u60c5\u51b5\u3002\u53ef\u4ee5\u8bf4\uff0c ELF \u5934\u662f\u6574\u4e2aELF\u6587\u4ef6\u7684\u201c\u7075\u9b42\u201d\u6240\u5728</p> </li> <li> <p>ELF\u5934\u5b58\u50a8\u7684\u5185\u5bb9:shoff\u8bb0\u5f55\u4e86\u7b2c\u4e00\u4e2aSection Header\u7684\u4f4d\u7f6e\uff0cshentsize\u4ee3\u8868\u4e86\u4e00\u4e2aSection Header\u7684\u5927\u5c0f\uff0cshnum\u4ee3\u8868\u4e00\u5171\u6709\u591a\u5c11\u4e2aSection Header\uff0cshstrndx\u4ee3\u8868\u4e86String Table\u7684\u7d22\u5f15\u503c</p> </li> </ul> ELF Header \u548c Section Header ELF Header \u7684\u7ed3\u6784Section Header \u7684\u7ed3\u6784section header type \u53d6\u503csection header flags\u53d6\u503c elf header<pre><code>typedef struct elf_header_t {\nuint32 magic;\nuint8 elf[12];\nuint16 type;      /* Object file type */\nuint16 machine;   /* Architecture */\nuint32 version;   /* Object file version */\nuint64 entry;     /* Entry point virtual address */\nuint64 phoff;     /* Program header table file offset */\nuint64 shoff;     /* Section header table file offset */\nuint32 flags;     /* Processor-specific flags */\nuint16 ehsize;    /* ELF header size in bytes */\nuint16 phentsize; /* Program header table entry size */\nuint16 phnum;     /* Program header table entry count */\nuint16 shentsize; /* Section header table entry size */\nuint16 shnum;     /* Section header table entry count */\nuint16 shstrndx;  /* Section header string table index */\n} elf_header;\n</code></pre> Section Header<pre><code>typedef struct{  /*Section Header \u7684\u7ed3\u6784*/\nElf32_Word sh_name; /*Section name (string tbl index)*/  Elf32_Word sh_type; /*Section type*/  Elf32_Word sh_flags; /*Section flags*/  Elf32_Addr sh_addr; /*Section virtual addr at execution*/  Elf32_Off sh_offset; /*Section file offset*/  Elf32_Word sh_size; /*Section size in bytes*/  Elf32_Word sh_link; /*Link to another section*/  Elf32_Word sh_info; /*Additional section information*/  Elf32_Word sh_addralign; /*Section alignment*/  Elf32_Word sh_entsize; /*Entry size if section holds table*/\n}\nElf32_Shdr;\n</code></pre> sh_type<pre><code>0 SHT_NULL \u65e0\u5bf9\u5e94\u8282\u533a\uff0c\u8be5\u8282\u5176\u4ed6\u5b57\u6bb5\u53d6\u503c\u65e0\u610f\u4e49\n1 SHT_PROGBITS \u7a0b\u5e8f\u6570\u636e\n2 SHT_SYMTAB \u7b26\u53f7\u8868\n3 SHT_STRTAB \u5b57\u7b26\u4e32\u8868\n4 SHT_RELA \u5e26\u9644\u52a0\u7684\u91cd\u5b9a\u4f4d\u9879\n5 SHT_HASH \u7b26\u53f7\u54c8\u5e0c\u8868\n6 SHT_DYNAMIC \u52a8\u6001\u94fe\u63a5\u4fe1\u606f\n7 SHT_NOTE \u63d0\u793a\u6027\u4fe1\u606f\n8 SHT_NOBITS \u65e0\u6570\u636e\u7a0b\u5e8f\u7a7a\u95f4\uff08bss\uff09\n9 SHT_REL \u65e0\u9644\u52a0\u7684\u91cd\u5b9a\u4f4d\u9879\n10 SHT_SHLIB \u4fdd\u7559\n11 SHT_DYNSYM \u52a8\u6001\u94fe\u63a5\u7b26\u53f7\u8868\n14 SHT_INIT_ARRAY \u6784\u9020\u51fd\u6570\u6570\u7ec4\n15 SHT_FINI_ARRAY \u6790\u6784\u51fd\u6570\u6570\u7ec4\n16 SHT_PREINIT_ARRAY\n17 SHT_GROUP\n18 SHT_SYMTAB_SHNDX\n19 SHT_NUM\n0x70000000 SHT_LOPROC\n0x7fffffff SHT_HIPROC\n0x80000000 SHT_LOUSER\n0x8fffffff SHT_HIUSER\n</code></pre> sh_flags<pre><code>1 SHF_WRITE\n2 SHF_ALLOC\n4 SHF_EXECINSTR\n8 SHF_MASKPROC\n</code></pre> <ul> <li>\u901a\u8fc7String Table\u53ef\u4ee5\u8bfb\u53d6\u51fa\u6bcf\u4e2aSection Header\u5bf9\u5e94\u7684Section\u7684\u540d\u5b57\uff0c\u901a\u8fc7C\u8bed\u8a00\u7684\u5b57\u7b26\u4e32\u6bd4\u8f83\u51fd\u6570\uff0c\u53ef\u4ee5\u8bfb\u53d6\u6211\u4eec\u60f3\u8981\u7684Section\u7684\u5185\u5bb9\u3002</li> <li>\u5bf9\u4e8e.symtab\u548c.strtab\uff0c\u9700\u8981\u67e5\u8be2.symtab\u8868\u4e2d\u6bcf\u4e00\u4e2asymbols\u7684\u7ed3\u6784\u5b9a\u4e49\uff0c\u5176\u4e2d\u7684name\u4e5f\u662f\u4e00\u4e2auint32\u7c7b\u578b\u7684\u53d8\u91cf</li> <li>\u8bfb\u53d6\u51fa.symtab\u548c.strtab\u7684\u4fe1\u606f\u4e4b\u540e\u5c31\u53ef\u4ee5\u5f00\u59cb\u6253\u5370\u4e86\uff0c\u5728\u8fdb\u5165\u4e2d\u65ad\u4e4b\u524d\u5176\u5b9e\u6240\u6709\u7684\u4fe1\u606f\u5df2\u7ecf\u8fdb\u5165\u5230\u4e86trapframe\u91cc\u9762\uff0c\u6240\u4ee5\u8bf4\u53ef\u4ee5\u8bfb\u53d6trapframe\u91cc\u9762\u7684\u4fe1\u606f\u8bfb\u53d6\u67d0\u4e2a\u5bc4\u5b58\u5668\u5728\u8fdb\u5165S\u6001\u4e4b\u524d\u7684\u503c\u3002</li> <li>\u4e0b\u9762\u8fd9\u4e2a\u51fd\u6570\u4eceoffset\u8fd9\u4e2a\u5730\u5740\u4e2d\u53d6\u51fanb\u5b57\u8282\u7684\u6570\u636e\u653e\u5165\u5230dest\u5bf9\u5e94\u7684\u5730\u5740\u4e2d\u3002</li> </ul> <pre><code>uint64 elf_fpread(elf_ctx *ctx, void *dest, uint64 nb, uint64 offset)\n</code></pre>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/note/#_3","title":"\u5b9e\u9a8c\u8fc7\u7a0b","text":"<p>\u83b7\u53d6elf</p> ctx-info\u83b7\u53d6msg-&gt;f\u83b7\u53d6magic\u83b7\u53d6type\u83b7\u53d6shoff\u83b7\u53d6shentsize\u83b7\u53d6shnum\u83b7\u53d6shstrndx info define <pre><code>typedef struct elf_info_t {\nspike_file_t *f;\nprocess *p;\n} elf_info;\n</code></pre> <pre><code>///ctx:800065f8\nTry print ctx-&gt;info:0x800065e8\nTry print dest:80006600\nTry print nb:64\nTry print offset:0\n---\nTry print ctx-&gt;info:0x800065e8\nTry print dest:80006568\nTry print nb:56\nTry print offset:64\n---\nTry print ctx-&gt;info:0x800065e8\nTry print dest:81000000\nTry print nb:1052\nTry print offset:4096\n</code></pre> msg <p>msg define<pre><code>elf_info *msg = (elf_info *)ctx-&gt;info;\n</code></pre> process define<pre><code>// the extremely simple definition of process, used for begining labs of PKE\ntypedef struct process_t {\n// pointing to the stack used in trap handling.\nuint64 kstack;\n// trapframe storing the context of a (User mode) process.\ntrapframe* trapframe;\n}process;\n</code></pre></p> <pre><code>Try print msg-&gt;f:0x80005018\nTry print dest:80006600\nTry print nb:64\nTry print offset:0\nTry print msg-&gt;f:0x80005018\nTry print dest:80006568\nTry print nb:56\nTry print offset:64\nTry print msg-&gt;f:0x80005018\nTry print dest:81000000\nTry print nb:1052\nTry print offset:4096\n</code></pre> <pre><code>Try print ctx-&gt;ehdr.magic:0x80006690\nTry print dest:80006600\nTry print nb:64\nTry print offset:0\nTry print ctx-&gt;ehdr.magic:0x464c457f\nTry print dest:80006568\nTry print nb:56\nTry print offset:64\nTry print ctx-&gt;ehdr.magic:0x464c457f\nTry print dest:81000000\nTry print nb:1052\nTry print offset:4096\n</code></pre> Object file type<pre><code>Try print ctx-&gt;header-&gt;type:5132\nTry print dest:-2147457536\nTry print nb:64\nTry print offset:0\nTry print ctx-&gt;header-&gt;type:2\nTry print dest:-2147457688\nTry print nb:56\nTry print offset:64\nTry print ctx-&gt;header-&gt;type:2\nTry print dest:-2130706432\nTry print nb:1052\nTry print offset:4096\n</code></pre> Section header table file offset<pre><code>Try print ctx-&gt;ehdr.shoff:0x800066a8\nTry print dest:80006600\nTry print nb:64\nTry print offset:0\nTry print ctx-&gt;ehdr.shoff:0x00003de0(15840)\nTry print dest:80006568\nTry print nb:56\nTry print offset:64\nTry print ctx-&gt;ehdr.shoff:0x00003de0(15840)\nTry print dest:81000000\nTry print nb:1052\nTry print offset:4096\n</code></pre> Section header table entry size<pre><code>Try print ctx-&gt;ehdr.shentsize:0\nTry print dest:-2147457536\nTry print nb:64\nTry print offset:0\nTry print ctx-&gt;ehdr.shentsize:64\nTry print dest:-2147457688\nTry print nb:56\nTry print offset:64\nTry print ctx-&gt;ehdr.shentsize:64\nTry print dest:-2130706432\nTry print nb:1052\nTry print offset:4096\n</code></pre> Section header table entry count<pre><code>Try print ctx-&gt;ehdr.shnum:1\nTry print dest:-2147457536\nTry print nb:64\nTry print offset:0\nTry print ctx-&gt;ehdr.shnum:17\nTry print dest:-2147457688\nTry print nb:56\nTry print offset:64\nTry print ctx-&gt;ehdr.shnum:17\nTry print dest:-2130706432\nTry print nb:1052\nTry print offset:4096\n</code></pre> Section header string table index(String Table\u7684\u7d22\u5f15\u503c)<pre><code>Try print ctx-&gt;ehdr.shstrndx:0\nTry print dest:-2147457536\nTry print nb:64\nTry print offset:0\nTry print ctx-&gt;ehdr.shstrndx:16\nTry print dest:-2147457688\nTry print nb:56\nTry print offset:64\nTry print ctx-&gt;ehdr.shstrndx:16\nTry print dest:-2130706432\nTry print nb:1052\nTry print offset:4096\n</code></pre> <p>ToDo</p> <p>\u627e\u5230section header\uff01</p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/note/#lab1_challenge2","title":"lab1_challenge2","text":"<p>\u4efb\u52a1\u76ee\u7684</p> <p>\u4fee\u6539\u5185\u6838\uff08\u5305\u62ecmachine\u6587\u4ef6\u5939\u4e0b\uff09\u7684\u4ee3\u7801\uff0c\u4f7f\u5f97\u7528\u6237\u7a0b\u5e8f\u5728\u53d1\u751f\u5f02\u5e38\u65f6\uff0c\u5185\u6838\u80fd\u591f\u8f93\u51fa\u89e6\u53d1\u5f02\u5e38\u7684\u7528\u6237\u7a0b\u5e8f\u7684\u6e90\u6587\u4ef6\u540d\u548c\u5bf9\u5e94\u4ee3\u7801\u884c</p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/note/#_4","title":"\u5f85\u5b8c\u5584\u7684\u5185\u5bb9","text":"<ol> <li> <p>\u672c\u5b9e\u9a8c\u5728<code>elf.c</code>\u4e2d\u7ed9\u51fa\u4e86<code>debug_line</code>\u6bb5\u7684\u89e3\u6790\u51fd\u6570<code>make_addr_line</code>\u3002</p> </li> <li> <p>\u8fd9\u4e2a\u51fd\u6570\u63a5\u53d7\u4e09\u4e2a\u53c2\u6570\uff0c<code>ctx</code>\u4e3a<code>elf</code>\u6587\u4ef6\u7684\u4e0a\u4e0b\u6587\u6307\u9488\uff0c\u8fd9\u4e2a\u53ef\u4ee5\u53c2\u8003\u6587\u4ef6\u4e2d\u7684\u5176\u4ed6\u51fd\u6570</p> </li> <li> <p><code>debug_line</code>\u4e3a\u6307\u5411<code>.debug_line</code>\u6bb5\u6570\u636e\u7684\u6307\u9488 \u4f60\u9700\u8981\u8bfb\u53d6<code>elf</code>\u6587\u4ef6\u4e2d\u540d\u4e3a<code>.debug_line</code>\u7684\u6bb5\u4fdd\u5b58\u5230\u7f13\u51b2\u533a\u4e2d \u7136\u540e\u5c06\u7f13\u51b2\u533a\u6307\u9488\u4f20\u5165\u8fd9\u4e2a\u53c2\u6570\uff1b<code>length</code>\u4e3a<code>.debug_line</code>\u6bb5\u6570\u636e\u7684\u957f\u5ea6\u3002</p> </li> </ol>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter1_riscv/","title":"Chapter1 riscv","text":""},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter1_riscv/#risc-v","title":"\u7b2c\u4e00\u7ae0\uff0eRISC-V\u4f53\u7cfb\u7ed3\u6784","text":""},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter1_riscv/#_1","title":"\u76ee\u5f55","text":"<ul> <li>1.1 RISC-V\u53d1\u5c55\u5386\u53f2 </li> <li>1.2 RISC-V\u6c47\u7f16\u8bed\u8a00 </li> <li>1.3 \u673a\u5668\u7684\u7279\u6743\u72b6\u6001 </li> <li>1.4 \u4e2d\u65ad\u548c\u4e2d\u65ad\u5904\u7406 </li> <li>1.5 \u9875\u5f0f\u865a\u5b58\u7ba1\u7406 </li> <li>1.6 \u76f8\u5173\u5de5\u5177\u8f6f\u4ef6 </li> </ul> <p>\u672c\u7ae0\u76841.1\u8282\u5c06\u7b80\u5355\u4ecb\u7ecdRISC-V\u7684\u8bde\u751f\u548c\u53d1\u5c55\u5386\u53f2\uff0c\u5176\u540e\u5c06\u4ecb\u7ecd\u548c\u8ba8\u8bbaRISC-V\u4f53\u7cfb\u7ed3\u6784\u7684\u5404\u4e2a\u65b9\u9762\uff0c\u59821.2\u8282\u4ecb\u7ecd\u6c47\u7f16\u8bed\u8a00\u30011.3\u8282\u8ba8\u8bba\u673a\u5668\u72b6\u6001\u30011.4\u8282\u5206\u6790\u4e2d\u65ad\u548c\u4e2d\u65ad\u5904\u7406\u673a\u5236\u30011.5\u8282\u8ba8\u8bba\u5206\u9875\u673a\u5236\u3002\u6700\u540e\uff0c\u57281.6\u8282\u4ecb\u7ecdPKE\u5b9e\u9a8c\u6d89\u53ca\u7684\u5de5\u5177\u8f6f\u4ef6\uff0c\u4ee5\u53ca\u5b83\u4eec\u7684\u4f7f\u7528\u65b9\u6cd5\u3002\u503c\u5f97\u6ce8\u610f\u7684\u662f\uff0cRISC-V\u7684\u4f53\u7cfb\u7ed3\u6784\u672c\u8eab\u5c31\u662f\u4e00\u4e2a\u5e9e\u5927\u7684\u77e5\u8bc6\u4f53\u7cfb\uff0c\u5b9e\u9645\u4e0a\u662f\u5f88\u96be\u7528\u4e00\u7ae0\u7684\u5185\u5bb9\u5b8c\u5168\u8bb2\u6e05\u695a\u7684\uff08\u6211\u4eec\u9f13\u52b1\u5bf9\u8be5\u4f53\u7cfb\u7ed3\u6784\u611f\u5174\u8da3\u7684\u8bfb\u8005\u5ef6\u7533\u9605\u8bfb\u53c2\u8003\u6587\u732e\u5f00\u6e90\u6307\u4ee4\u96c6\u7684\u6307\u5357\u4ee5\u53caRISC-V instruction set manual\uff09\u3002\u7136\u800c\uff0c\u4e0d\u61c2\u4f53\u7cfb\u7ed3\u6784\u53c8\u65e0\u6cd5\u7406\u89e3\u64cd\u4f5c\u7cfb\u7edf\u548c\u5f00\u5c55PKE\u7684\u5b9e\u9a8c\uff0c\u6240\u4ee5\u672c\u7ae0\u5c06\u91cd\u70b9\u9610\u8ff0\u548c\u8ba8\u8bba\u4e0e\u64cd\u4f5c\u7cfb\u7edf\u8bbe\u8ba1\u6709\u5173\u7684\u77e5\u8bc6\u5185\u5bb9\uff0c\u529b\u6c42\u7cbe\u7b80\u548c\u7a81\u51fa\u91cd\u70b9\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter1_riscv/#11-risc-v","title":"1.1 RISC-V\u53d1\u5c55\u5386\u53f2","text":"<p>RISC-V\uff08\u8bfb\u505a\u201crisk-five\u201d\uff09\u662f\u4e00\u79cd\u5178\u578b\u7684\u7cbe\u7b80\uff08Reduced Instruction Set Computer\uff0c\u7b80\u5199\u4e3aRISC\uff09\u6307\u4ee4\u96c6\uff08Instruction Set Architecture\uff0c\u7b80\u5199\u4e3aISA\uff09\uff0c\u5b83\u662f\u52a0\u5229\u798f\u5c3c\u4e9a\u5927\u5b66\u4f2f\u514b\u5229\u5206\u6821\u7684David Patterson\u6559\u6388\u4e0eKrste Asanovic\u6559\u6388\u7814\u7a76\u56e2\u961f\u4e8e2010\u5e74\u63d0\u51fa\u7684\u4e00\u4e2a\u5f00\u653e\u6307\u4ee4\u96c6\u67b6\u6784\u3002\u540d\u79f0\u4e2d\u7684\u201cV\u201d\u6307\u7684\u662f\u8be5ISA\u7684\u7b2c\u4e94\u4e2a\u7248\u672c\uff0c\u6709\u65f6\u201cV\u201d\u4e5f\u88ab\u89e3\u8bfb\u4e3a\u5411\u91cf\uff08Vector\uff09\u6269\u5c55\u3002\u4e0e\u4e4b\u524d\u7684\u8bf8\u591a\u5546\u7528\u6307\u4ee4\u96c6\uff08\u5982x86\u3001ARM\uff0c\u4ee5\u53caMIPS\u7b49\uff09\u4e0d\u540c\u7684\u662f\uff0cRISC-V\u662f\u4e00\u4e2a\u5f00\u653e\u6307\u4ee4\u96c6\uff0c\u5b83\u7684\u63d0\u51fa\u53d7\u5230\u4e86\u5168\u7403\u5de5\u4e1a\u754c\u548c\u5b66\u672f\u754c\u7684\u5e7f\u6cdb\u5173\u6ce8\u3002\u5728\u6211\u56fd\uff0cRISC-V\u7684\u53d1\u5c55\u3001\u7814\u7a76\u548c\u5e94\u7528\u540c\u6837\u5f97\u5230\u4e86\u5e7f\u6cdb\u5173\u6ce8\uff0c\u5728\u7f51\u4fe1\u529e\u3001\u5de5\u4fe1\u90e8\u3001\u4e2d\u79d1\u9662\u7b49\u591a\u4e2a\u56fd\u5bb6\u90e8\u59d4\u652f\u6301\u548c\u6307\u5bfc\u4e0b\uff0c\u4e2d\u56fd\u5f00\u653e\u6307\u4ee4\u751f\u6001\uff08RISC-V\uff09\u8054\u76df\u4e8e2018\u5e7411\u67088\u65e5\u6d59\u6c5f\u4e4c\u9547\u4e3e\u884c\u7684\u7b2c\u4e94\u5c4a\u4e92\u8054\u7f51\u5927\u4f1a\u4e0a\u6b63\u5f0f\u5ba3\u5e03\u6210\u7acb\u3002</p> <p>\u76f8\u6bd4\u4e8e\u4f20\u7edf\u7684\u5546\u7528\u6307\u4ee4\u96c6\u67b6\u6784\uff0cRISC-V\u6307\u4ee4\u96c6\u4ee5\u53ca\u5176\u80cc\u540e\u7684\u8ba1\u7b97\u673a\u67b6\u6784\u5177\u6709\u4ee5\u4e0b\u4f18\u70b9\uff1a</p> <p>\u25cf \u540e\u53d1\u4f18\u52bf\u3002RISC-V\u6307\u4ee4\u96c6\u7684\u63d0\u51fa\uff0c\u662f\u501f\u9274\u4e86\u4e4b\u524d\u7684\u4f20\u7edf\u5546\u4e1a\u6307\u4ee4\u96c6\uff0c\u901a\u8fc7\u53d6\u957f\u8865\u77ed\u800c\u5f97\u5230\u7684\u3002\u76f8\u6bd4\u4e8e\u4e4b\u524d\u7684\u6307\u4ee4\u96c6\uff0cRISC-V\u907f\u514d\u4e86\u5f88\u591a\u524d\u4eba\u8e29\u8fc7\u7684\u975e\u5e38\u591a\u7684\u5751\u3002</p> <p>\u25cf \u5f00\u653e\u67b6\u6784\u3002RISC-V\u6307\u4ee4\u96c6\u662f\u4e00\u4e2a\u5f00\u653e\u7684\u6307\u4ee4\u96c6\uff0c\u610f\u5473\u7740\u4efb\u4f55\u7ec4\u7ec7\u6216\u4e2a\u4eba\u90fd\u53ef\u4ee5\u81ea\u7531\u5730\u8bbe\u8ba1\u786c\u4ef6\uff0c\u4ee5\u652f\u6491\u91c7\u7528RISC-V\u6307\u4ee4\u6240\u7f16\u5199\u7684\u4ee3\u7801\uff0c\u800c\u4e0d\u4f1a\u88ab\u8d77\u8bc9\u6216\u6536\u5230\u6cd5\u9662\u4f20\u7968\u3002\u540c\u65f6\uff0c\u5bf9\u8be5\u6307\u4ee4\u96c6\u7684\u4f7f\u7528\u4e0d\u53d7\u7f8e\u56fd\u7684\u8d38\u6613\u7ba1\u5236\u7ea6\u675f\u3002\u9700\u8981\u6307\u51fa\u7684\u662f\uff0cRISC-V\u6307\u4ee4\u662f\u5f00\u653e\u7684\uff0c\u4f46\u91c7\u7528\u8be5\u6307\u4ee4\u96c6\u7684\u5177\u4f53\u8bbe\u8ba1\uff08IP\uff09\u786e\u662f\u53d7\u5230\u7248\u6743\u4fdd\u62a4\u7684\uff0c\u8fd9\u6837\u505a\u7684\u76ee\u7684\u662f\u5728\u5f00\u653e\u7684\u524d\u63d0\u4e0b\u9f13\u52b1\u521b\u65b0\u548c\u4fdd\u62a4\u5f00\u53d1\u8005\u7684\u5546\u4e1a\u5229\u76ca\u3002</p> <p>\u25cf \u573a\u666f\u4e30\u5bcc\u3002RISC-V\u6307\u4ee4\u96c6\u7684\u8bbe\u8ba1\uff0c\u7efc\u5408\u8003\u8651\u4e86\u591a\u79cd\u5e94\u7528\u573a\u666f\uff08\u6db5\u76d6\u4e86\u4ece\u5d4c\u5165\u5f0f\u4f4e\u529f\u8017\u5e94\u7528\u5230\u9ad8\u6027\u80fd\u670d\u52a1\u5668\u573a\u666f\uff09\uff0c\u4e3a\u5404\u79cd\u573a\u666f\u8003\u8651\u5e76\u8bbe\u8ba1\u4e86\u591a\u4e2a\u4e0d\u540c\u4f46\u6307\u4ee4\u4e0a\u63a5\u8fd1\u7684\u5206\u652f\u3002\u5728\u8fd9\u4e00\u70b9\u4e0a\uff0cRISC-V\u8ddfARM\u7c7b\u4f3c\uff0c\u9488\u5bf9\u4e0d\u540c\u5e94\u7528\u573a\u666f\uff0cRISC-V\u4e5f\u90fd\u6709\u5bf9\u5e94\u7248\u672c\u3002</p> <p>\u25cf \u5f00\u6e90\u53c2\u8003\u3002\u81eaRISC-V\u63d0\u51fa\u4ee5\u6765\uff0c\u5de5\u4e1a\u754c\u548c\u5b66\u672f\u754c\u90fd\u79ef\u6781\u5f00\u5c55\u4e86\u5bf9\u5176\u7684\u5e94\u7528\u548c\u7814\u7a76\uff0c\u51fa\u73b0\u4e86\u5927\u91cf\u7684\u5f00\u6e90\u5b9e\u73b0\uff08\u53c2\u89c1RISC-V\u5f00\u6e90\u9879\u76ee\u5217\u8868\uff09\u3002\u8fd9\u4e9b\u5f00\u6e90\u5b9e\u73b0\uff0c\u4e3a\u5177\u4f53\u5e94\u7528\u9886\u57df\u7684\u5f00\u53d1\u8005\u63d0\u4f9b\u4e86\u5927\u91cf\u53ef\u501f\u9274\u7684\u53c2\u8003\uff0c\u540c\u65f6\u4e5f\u6781\u5927\u5730\u964d\u4f4e\u4e86CPU\u7684\u8bbe\u8ba1\u95e8\u69db\u3002\u53ef\u4ee5\u9884\u89c1\u7684\u662f\uff0c\u968f\u7740\u5927\u91cf\u57fa\u4e8e\u8be5\u6307\u4ee4\u96c6\u7684\u82af\u7247\u5f00\u6e90\u9879\u76ee\u7684\u8bde\u751f\uff0cRISC-V\u7684\u53d1\u5c55\u5c06\u50cf\u5f00\u6e90\u8f6f\u4ef6\u751f\u6001\u4e2d\u7684Linux\u90a3\u6837\uff0c\u6210\u4e3a\u8ba1\u7b97\u673a\u82af\u7247\u4e0e\u7cfb\u7edf\u9886\u57df\u521b\u65b0\u7684\u57fa\u77f3\u3002</p> <p>\u5728\u672c\u4e66\u6240\u8bbe\u8ba1\u7684\u5b9e\u9a8c\u4e2d\u6211\u4eec\u4e3b\u8981\u8003\u8651\u901a\u7528\u8ba1\u7b97\u573a\u666f\uff0c\u6240\u4ee5\u9009\u62e9RV64G\u4f5c\u4e3a\u6211\u4eec\u76ee\u6807\u8ba1\u7b97\u673a\u7684\u6307\u4ee4\u96c6\u3002\u5176\u4e2d\uff0cRV64G\u4e2d\u7684\u201cRV\u201d\u4ee3\u8868RISC-V\uff1b\u201c64\u201d\u4ee3\u8868\u6240\u652f\u6301\u7684\u6307\u4ee4\u662f64\u4f4d\u7684\uff08\u5b9e\u9645\u4e0a\uff0c\u4ea4\u53c9\u7f16\u8bd1\u5668\u5728\u751f\u6210\u4ee3\u7801\u65f6\u53ef\u80fd\u4f1a\u91c7\u752832\u4f4d\u6307\u4ee4\u51cf\u5c0f\u751f\u6210\u7684\u76ee\u6807\u4ee3\u7801\u957f\u5ea6\uff09\uff0c\u5730\u5740\u957f\u5ea6\u548c\u5bc4\u5b58\u5668\u957f\u5ea6\u90fd\u4e3a64\u4f4d\uff1b\u800c\u201cG\u201d\u4ee3\u8868\u901a\u7528\uff08general\uff09\u8ba1\u7b97\u5e73\u53f0\u3002\u5b9e\u9645\u4e0a\uff0c\u201cG\u201d\u7b49\u6548\u4e8e\u201cIMAFD\u201d\uff0c\u5176\u4e2d\u201cI\u201d\u4ee3\u8868\u6574\u6570\uff08Integer\uff09\u8ba1\u7b97\u6307\u4ee4\u3001\u6574\u6570load\u3001\u6574\u6570store\u4ee5\u53ca\u63a7\u5236\u6d41\uff08\u5982\u5206\u652f\u8df3\u8f6c\uff09\u6307\u4ee4\uff0c\u8fd9\u4e9b\u6307\u4ee4\u5728\u4efb\u4f55RISC-V\u7684\u5b9e\u73b0\u4e2d\u90fd\u662f\u5fc5\u987b\u7684\uff1b\u201cM\u201d\u4ee3\u8868\u4e58\u6cd5\uff08Multiply\uff09\uff0c\u5373\u5e73\u53f0\u652f\u6301\u4e58\u6cd5\u548c\u9664\u6cd5\u8fd0\u7b97\uff1b\u201cA\u201d\u4ee3\u8868\u539f\u5b50\uff08Atomic\uff09\u6269\u5c55\uff0c\u652f\u6301\u5bf9\u5bc4\u5b58\u5668\u8fdb\u884c\u7684\u539f\u5b50\u8bfb\u3001\u4fee\u6539\u548c\u539f\u5b50\u5199\u64cd\u4f5c\uff0c\u8fd9\u4e9b\u64cd\u4f5c\u5728\u591a\u6838\u8bbe\u8ba1\u4e2d\u975e\u5e38\u6709\u7528\uff1b\u201cF\u201d\u4ee3\u8868\u5355\u7cbe\u5ea6\u6d6e\u70b9\uff08Float\uff09\u8fd0\u7b97\u652f\u6301\uff0c\u201cD\u201d\u4ee3\u8868\u53cc\u7cbe\u5ea6\u6d6e\u70b9\uff08Double\uff09\u8fd0\u7b97\u652f\u6301\u3002</p> <p>\u5b9e\u9645\u4e0a\uff0c\u6309\u7167RISC-V\u7684\u6307\u4ee4\u96c6\u89c4\u8303\uff0cRISC-V\u7684\u8ba1\u7b97\u673a\u53ef\u4ee5\u8bbe\u8ba1\u4e3a\u66f4\u4f4e\u4f4d\u6570\uff08\u598232\u4f4d\uff0c\u751a\u81f316\u4f4d\uff09\uff0c\u4e5f\u53ef\u4ee5\u8bbe\u8ba1\u4e3a\u66f4\u9ad8\u4f4d\u6570\uff08\u5982128\u4f4d\uff09\uff0c\u8fd9\u4e9b\u90fd\u53d6\u51b3\u4e8e\u6240\u8bbe\u8ba1\u7684\u8ba1\u7b97\u673a\u6240\u9762\u5411\u7684\u76ee\u6807\u9886\u57df\u3002\u4e00\u822c\u8bf4\u6765\uff0c\u5982\u679c\u8ba1\u7b97\u673a\u9762\u5411\u7684\u76ee\u6807\u9886\u57df\u662f\u5d4c\u5165\u5f0f\u9886\u57df\uff0c32\u4f4d\uff08\u751a\u81f316\u4f4d\uff09\u5c31\u5df2\u7ecf\u8db3\u591f\uff1b\u5982\u679c\u76ee\u6807\u9886\u57df\u4e3a\u684c\u9762\u7684\u529e\u516c\u73af\u5883\u6216\u8005\u624b\u673a\uff0c64\u4f4d\u5e94\u5df2\u8db3\u591f\uff1b\u4f46\u5982\u679c\u76ee\u6807\u9886\u57df\u4e3a\u670d\u52a1\u5668\uff0c\u5219\u53ef\u80fd128\u4f4d\u7684\u6307\u4ee4\u67b6\u6784\u624d\u662f\u5408\u9002\u7684\u3002\u66f4\u9ad8\u7684\u6307\u4ee4\u96c6\u4f4d\u6570\u5f80\u5f80\u610f\u5473\u7740\u66f4\u5927\u89c4\u6a21\u7684\u5e94\u7528\u7a0b\u5e8f\uff08\u66f4\u5927\u7684\u903b\u8f91\u5730\u5740\u7a7a\u95f4\uff09\uff0c\u4ee5\u53ca\u7ba1\u7406\u66f4\u5927\u89c4\u6a21\u7684\u5185\u5b58\uff08\u6ce8\u610f\uff1a\u5e76\u4e0d\u610f\u5473\u7740\u66f4\u5feb\u7684\u901f\u5ea6\uff09\u3002\u53e6\u5916\uff0c\u6307\u4ee4\u96c6\u672c\u8eab\u4e5f\u662f\u53ef\u4ee5\u88c1\u526a\u7684\uff0c\u4f8b\u5982\u5728\u4e3a\u5d4c\u5165\u5f0f\u73af\u5883\u8bbe\u7f6e\u7684\u5355\u6838\u5904\u7406\u5668\u4e0a\uff0c\u6211\u4eec\u53ef\u4ee5\u53ea\u4fdd\u7559\u201cIMF\u201d\u800c\u4e0d\u652f\u6301\u201cAD\u201d\uff0c\u4ece\u800c\u964d\u4f4e\u5904\u7406\u5668\u8bbe\u8ba1\u7684\u590d\u6742\u5ea6\u4ee5\u53ca\u80fd\u8017\u3002</p> <p>\u8003\u8651\u5230\u4eca\u592964\u4f4d\u7535\u8111\uff08x86_64\uff09\u5df2\u5e7f\u6cdb\u666e\u53ca\u5230\u684c\u9762\u3001\u670d\u52a1\u5668\uff0c\u6211\u4eec\u901a\u5e38\u63a5\u89e6\u5230\u7684\u64cd\u4f5c\u7cfb\u7edf\uff08\u5982Ubuntu\u3001Windows10\u7b49\uff09\u90fd\u662f\u5185\u7f6e\u768464\u4f4d\u7f16\u8bd1\u5668\uff0c\u7f16\u8bd1\u51fa\u6765\u7684\u4e8c\u8fdb\u5236\u4ee3\u7801\uff08\u7279\u522b\u662f\u6211\u4eec\u5c06\u8981\u7528\u5230\u7684RISC-V\u6a21\u62df\u5668\uff09\u4e5f\u90fd\u9ed8\u8ba4\u662f64\u4f4d\uff0c\u6211\u4eec\u5c06PKE\u5b9e\u9a8c\u7684\u76ee\u6807\u5e73\u53f0\u7c7b\u578b\u8bbe\u5b9a\u4e3a\u684c\u9762\u7535\u8111\uff08\u91c7\u7528\u901a\u7528\u7248\u672cRV64G\uff09\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter1_riscv/#12-risc-v","title":"1.2 RISC-V\u6c47\u7f16\u8bed\u8a00","text":"<p>\u5173\u4e8eRISC-V\u6c47\u7f16\u8bed\u8a00\uff0c\u8f83\u597d\u7684\u4e2d\u6587\u53c2\u8003\u8d44\u6599\u6709\u300aRISC-V\u624b\u518c\u2014\u2014\u4e00\u672c\u5f00\u6e90\u6307\u4ee4\u96c6\u7684\u6307\u5357\u300b\uff08\u53c2\u89c1\u5f00\u6e90\u6307\u4ee4\u96c6\u7684\u6307\u5357\uff09\uff0c\u91cc\u9762\u5b8c\u6574\u5217\u4e3e\u548c\u89e3\u91ca\u4e86RISC-V\u7684\u6240\u6709\u6c47\u7f16\u6307\u4ee4\uff0c\u611f\u5174\u8da3\u7684\u8bfb\u8005\u53ef\u4ee5\u901a\u8fc7\u9605\u8bfb\u8be5\u4e66\u4e86\u89e3RISC-V\u6c47\u7f16\u3002\u5728\u8fd9\u91cc\uff0c\u6211\u4eec\u4e0d\u6253\u7b97\u8be6\u7ec6\u8ba8\u8bbaRISC-V\u7684\u6c47\u7f16\u77e5\u8bc6\uff0c\u53ea\u91cd\u70b9\u8ba8\u8bbaRISC-V\u6c47\u7f16\u4e0e8086\u6c47\u7f16\u7684\u4e0d\u540c\uff0c\u4ee5\u53caPKE\u7684\u4ee3\u7801\u6d89\u53ca\u5230\u7684\u4e00\u4e9b\u6c47\u7f16\u8bed\u6cd5\u548c\u6307\u4ee4\u3002</p> <p>1.2.1 \u5bc4\u5b58\u5668</p> <p>\u88681.1\u5217\u51fa\u4e86\u91c7\u7528RV64G\u6307\u4ee4\u96c6\u7684RISC-V\u8ba1\u7b97\u673a\u4e2d\u768432\u4e2a\u901a\u7528\u5bc4\u5b58\u5668\u3002</p> <p>\u88681.1 RV64G\u768432\u4e2a\u901a\u7528\u5bc4\u5b58\u5668\uff08\u5bc4\u5b58\u5668\u7684\u5bbd\u5ea6\u90fd\u662f64\u4f4d\uff09</p> \u5bc4\u5b58\u5668 \u7f16\u7a0b\u63a5\u53e3\u540d\u79f0  \uff08ABI\uff09 \u63cf\u8ff0 \u4f7f\u7528 x0 zero Hard-wired  zero \u786c\u4ef6\u96f6 x1 ra Return  address \u5e38\u7528\u4e8e\u4fdd\u5b58\uff08\u51fd\u6570\u7684\uff09\u8fd4\u56de\u5730\u5740 x2 sp Stack  pointer \u6808\u9876\u6307\u9488 x3 gp Global  pointer \u2014 x4 tp Thread  pointer \u2014 x5-7 t0-2 Temporary \u4e34\u65f6\u5bc4\u5b58\u5668 x8 s0/fp Saved  Register/ Frame pointer \uff08\u51fd\u6570\u8c03\u7528\u65f6\uff09\u4fdd\u5b58\u7684\u5bc4\u5b58\u5668\u548c\u6808\u9876\u6307\u9488 x9 s1 Saved  register \uff08\u51fd\u6570\u8c03\u7528\u65f6\uff09\u4fdd\u5b58\u7684\u5bc4\u5b58\u5668 x10-11 a0-1 Function  argument/ return value \uff08\u51fd\u6570\u8c03\u7528\u65f6\uff09\u7684\u53c2\u6570/\u51fd\u6570\u7684\u8fd4\u56de\u503c x12-17 a2-7 Function  argument \uff08\u51fd\u6570\u8c03\u7528\u65f6\uff09\u7684\u53c2\u6570 x18-27 s2-11 Saved  register \uff08\u51fd\u6570\u8c03\u7528\u65f6\uff09\u4fdd\u5b58\u7684\u5bc4\u5b58\u5668 x28-31 t3-6 Temporary \u4e34\u65f6\u5bc4\u5b58\u5668 <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u540c\u4e00\u4e2a\u901a\u7528\u5bc4\u5b58\u5668\u53ef\u4ee5\u7528\u4e0d\u540c\u7684\u540d\u5b57\u6765\u5bf9\u5b83\u8fdb\u884c\u8bbf\u95ee\u3002\u4f8b\u5982x0\u548czero\u5bf9\u5e94\u7684\u662f\u540c\u4e00\u4e2a\u5bc4\u5b58\u5668\uff0c\u4e14\u8be5\u5bc4\u5b58\u5668\u662f\u4e00\u4e2a\u786c\u4ef6\u96f6\uff08hardware zero\uff09\uff0c\u4e5f\u5c31\u662f\u4ece\u8be5\u5bc4\u5b58\u5668\u4e2d\u8bfb\u51fa\u6765\u7684\u6570\u636e\u6c38\u8fdc\u662f\u96f6\u3002x8\u3001s0\u3001fp\u8fd9\u4e9b\u7b26\u53f7\uff0c\u5bf9\u5e94\u7684\u4e5f\u662f\u540c\u4e00\u4e2a\u5bc4\u5b58\u5668\u3002\u4e00\u822c\u6765\u8bf4\uff0c\u6c47\u7f16\u8bed\u8a00\u5728\u4e66\u5199\u65f6\u5f80\u5f80\u91c7\u7528\u88681.1\u4e2d\u7684\u7f16\u7a0b\u63a5\u53e3\u540d\u79f0\uff08ABI\uff09\u6765\u5b9e\u73b0\u5bf9\u5bc4\u5b58\u5668\u7684\u8bbf\u95ee\uff0c\u4ee5\u63d0\u9ad8\u6c47\u7f16\u4ee3\u7801\u7684\u53ef\u8bfb\u6027\u3002</p> <p>\u9664\u4e86\u88681.1\u4e2d\u7684\u901a\u7528\u5bc4\u5b58\u5668\u5916\uff0cRV64G\u5904\u7406\u5668\u4e2d\u8fd8\u6709\u4e00\u4e2a\u91cd\u8981\u7684\u5bc4\u5b58\u5668\uff1aprogram counter\uff08pc\uff09\u3002\u5b83\u4e5f\u662f\u4e00\u4e2a64\u4f4d\u5bc4\u5b58\u5668\uff0c\u4f46\u5bf9\u5b83\u7684\u8bfb\u53d6\u9700\u8981\u91c7\u7528\u7279\u6b8a\u6307\u4ee4\uff08\u5982auipc\u6307\u4ee4\uff09\u8fdb\u884c\u3002\u53e6\u5916\uff0cRISC-V\u8ba1\u7b97\u673a\u4e3a\u8fd9\u4e9b\u901a\u7528\u5bc4\u5b58\u5668\u8d4b\u4e88\u4e86\u4e0d\u540c\u7684\u7528\u9014\u3002\u4f8b\u5982\uff0csp\uff08stack pointer\uff09\u5bc4\u5b58\u5668\u7528\u4e8e\u6307\u5411\u6808\u9876\uff08\u51c6\u786e\u5730\u8bb2\u662f\u6808\u7684\u4f4e\u5730\u5740\u7aef\u3002\u76f8\u5e94\u5730\uff0c\u6211\u4eec\u5c06\u6808\u7684\u9ad8\u7269\u7406\u5730\u5740\u7aef\u79f0\u4e3a\u6808\u5e95\uff09\uff0cfp\uff08frame pointer\uff09\u5bc4\u5b58\u5668\u5219\u4f1a\u5728\u53d1\u751f\u51fd\u6570\u8c03\u7528\u65f6\u88ab\u8d4b\u503c\u4e3asp\u7684\u5185\u5bb9\u5e76\u538b\u6808\uff1b\u5b57\u6bcda\u5f00\u59cb\uff08argument register\uff09\u7684\u5bc4\u5b58\u5668\u5e38\u7528\u4e8e\u51fd\u6570\u8c03\u7528\u65f6\u7684\u53c2\u6570\uff0c\u4ee5\u53ca\u8fd4\u56de\u503c\u7684\u4f20\u9012\uff1b\u5b57\u6bcds\u5f00\u59cb\uff08save register\uff09\u7684\u5bc4\u5b58\u5668\u7528\u4e8e\u5728\u53d1\u751f\u51fd\u6570\u8c03\u7528\u65f6\u4fdd\u5b58\u91cd\u8981\u8ba1\u7b97\u7ed3\u679c\uff1b\u5b57\u6bcdt\u5f00\u59cb\uff08temporary register\uff09\u7684\u5bc4\u5b58\u5668\u5219\u5f80\u5f80\u7528\u4e8e\u4e0d\u91cd\u8981\u7684\u4e2d\u95f4\u7ed3\u679c\u7684\u4fdd\u5b58\u3002\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u5728RISC-V\u8ba1\u7b97\u673a\u4e2d\u9664\u4e86\u786c\u4ef6\u96f6\u5bc4\u5b58\u5668zero\u3001\u6808\u9876\u6307\u9488sp\u3001\u51fd\u6570\u8fd4\u56de\u5730\u5740ra\u5916\uff0c\u5176\u4f59\u5bc4\u5b58\u5668\u7684\u4f7f\u7528\u5b9e\u9645\u4e0a\u53d6\u51b3\u4e8e\u6c47\u7f16\u7a0b\u5e8f\u5458\u6216\u8005\u7f16\u8bd1\u5668\uff08\u5982\u6211\u4eec\u5c06\u8981\u7528\u5230\u7684RISC-V\u7248\u672c\u7684GCC\u4ea4\u53c9\u7f16\u8bd1\u5668\uff09\u3002\u4f8b\u5982\uff0c\u5bf9\u4e8es\u5f00\u59cb\u7684\u5bc4\u5b58\u5668\uff0c\u867d\u7136RISC-V\u89c4\u8303\u8981\u6c42\u5728\u8c03\u7528\u51fd\u6570\u7684\u65f6\u5019\uff0c\u7531\u88ab\u8c03\u7528\u7684\u51fd\u6570\u5c06\u5b83\u4eec\u90fd\u4fdd\u5b58\uff08\u5230\u6808\u4e2d\uff09\uff0c\u4f46\u5b9e\u9645\u7684\u51fd\u6570\u4ee3\u7801\u4e3a\u4e86\u8ffd\u6c42\u66f4\u9ad8\u7684\u901f\u5ea6\uff0c\u5f80\u5f80\u53ea\u4fdd\u5b58\u88ab\u51fd\u6570\u4f7f\u7528\u8fc7\u7684\u5bc4\u5b58\u5668\u3002\u8fd9\u4e00\u70b9\uff0c\u6211\u4eec\u5c06\u57281.2.5\u8282\u7684\u4f8b\u5b50\u4e2d\u7ed9\u4e88\u5c55\u793a\u3002</p> <p>\u4e0d\u540c\u4e8e8086\uff0cRISC-V\u4e2d\u65e0\u6cd5\u5bf9\u201c\u534a\u4e2a\u201d\u5bc4\u5b58\u5668\u8fdb\u884c\u76f4\u63a5\u8bbf\u95ee\uff08\u4f8b\u5982AL\u4e4b\u4e8eAX\uff09\uff0c\u6307\u4ee4\u59cb\u7ec8\u9700\u8981\u8bbf\u95ee\u5b8c\u6574\u7684\u5bc4\u5b58\u5668\u3002\u53e6\u5916\uff0c\u5bf9\u4e8e\u6808\u7684\u8bbf\u95ee\uff0cRISC-V\u5904\u7406\u5668\u4e5f\u5e76\u672a\u63d0\u4f9b\u7c7b\u4f3cpush\u6216\u8005pop\u7b49\u6307\u4ee4\u6765\u5b8c\u6210\uff0c\u800c\u662f\u91c7\u7528load/store\u6765\u5b9e\u73b0\u5bf9\u5185\u5b58\u4e2d\u6808\u7684\u8bbf\u95ee\u3002</p> <p>1.2.2 \u6307\u4ee4\u683c\u5f0f</p> <p>\u56fe1.1\u5217\u51fa\u4e86RV64I\uff08RV64G\u7684\u6574\u6570\u6307\u4ee4\u5b50\u96c6\uff09\u7684\u5e38\u7528\u57fa\u7840\u6307\u4ee4\u3002</p> <p></p> <p>\u56fe1.1 RV64I\u7684\u5e38\u7528\u57fa\u7840\u6307\u4ee4\uff0c\u5e26\u4e0b\u5212\u7ebf\u7684\u7c97\u4f53\u5b57\u6bcd\u4ece\u5de6\u5230\u53f3\u8fde\u8d77\u6765\u6784\u6210RV64I\u6307\u4ee4\u3002</p> <p>\u4ece\u56fe1.1\u4e2d\uff0c\u6211\u4eec\u770b\u5230RV64I\u7684\u5e38\u7528\u57fa\u7840\u6307\u4ee4\u5e76\u4e0d\u591a\uff0c\u5206\u4e3a\u6574\u6570\u6307\u4ee4\uff08Integer computation\uff09\u3001\u8bbf\u5b58\u6307\u4ee4\uff08Load and Store\uff09\u548c\u63a7\u5236\u8f6c\u79fb\u6307\u4ee4\uff08\u5373\u8df3\u8f6c\u6307\u4ee4\uff0cControl transfer\uff09\uff0c\u6bcf\u6761\u6307\u4ee4\u7684\u540d\u79f0\u53d6\u56fe\u4e2d\u4e0b\u5212\u7ebf\u548c\u6807\u9ed1\u7684\u5b57\u6bcd\u6784\u6210\u3002\u4f8b\u5982\uff0c\u6700\u57fa\u7840\u7684\u52a0\u6cd5\u6307\u4ee4\u4e3aadd\uff0c\u5982\u679c\u7d2f\u52a0\u7684\u5176\u4e2d\u4e00\u4e2a\u64cd\u4f5c\u6570\u4e3a\u7acb\u5373\u6570\uff0c\u5219\u6307\u4ee4\u4e3aaddi\u3002\u5b9e\u9645\u4e0a\uff0c\u9664\u4e86\u5217\u51fa\u7684\u6307\u4ee4\u5916\uff0cRV64I\u8fd8\u5305\u62ec\u5f88\u591a\u5176\u4ed6\u7684\u6307\u4ee4\uff0c\u4f8b\u5982\u7528\u4e8e\u673a\u5668\u72b6\u6001\u63a7\u5236\u7684\u6307\u4ee4\u3001\u5185\u5b58\u5899\u6307\u4ee4\u7b49\u3002\u6211\u4eec\u5c06\u57281.4\u8282\u4e2d\u8ba8\u8bba\u673a\u5668\u72b6\u6001\u63a7\u5236\u6307\u4ee4\uff0c\u57281.5\u8282\u8ba8\u8bba\u4e0e\u865a\u62df\u5b58\u50a8\u76f8\u5173\u7684\u6307\u4ee4\u3002</p> <p>RISC-V\u6c47\u7f16\u6307\u4ee4\u7684\u683c\u5f0f\u4e0e8086\u6c47\u7f16\u662f\u622a\u7136\u4e0d\u540c\u7684\u3002\u4ee5\u6700\u57fa\u7840\u7684\u52a0\u6cd5\u6307\u4ee4\u4e3a\u4f8b\uff0c\u5b83\u7684\u6307\u4ee4\u683c\u5f0f\uff08\u4ee5\u52a0\u6cd5\u6307\u4ee4add\u4e3a\u4f8b\uff09\u4e3a\uff1a</p> <p><code>add rd, rs1, rs2</code></p> <p>\u6216\u8005</p> <p><code>addi rd, rs1, immediate</code></p> <p>\u5176\u4e2d\uff0crd\u4ee3\u8868\u76ee\u6807\u5bc4\u5b58\u5668\uff08register destination\uff09\uff0crs1\u548crs2\u5206\u522b\u4ee3\u8868\u6e90\u5bc4\u5b58\u56681\uff08register source\uff09\u548c\u6e90\u5bc4\u5b58\u56682\uff0cimmediate\u4ee3\u8868\u7acb\u5373\u6570\u3002\u524d\u4e00\u6761\u6307\u4ee4\u7684\u6267\u884c\u6548\u679c\u662f\u5c06\u4e24\u4e2a\u6e90\u5bc4\u5b58\u5668\uff08rs1\u548crs2\uff09\u4e2d\u6240\u5b58\u50a8\u7684\u503c\u8fdb\u884c\u6c42\u548c\uff0c\u5e76\u5c06\u7ed3\u679c\u5199\u5230rd\u5bc4\u5b58\u5668\uff1b\u540e\u4e00\u6761\u6307\u4ee4\u7684\u6267\u884c\uff0c\u5c06\u6e90\u5bc4\u5b58\u56681\u4e2d\u7684\u503c\u4e0e\u7acb\u5373\u6570\u76f8\u52a0\uff0c\u7ed3\u679c\u5199\u5230rd\u5bc4\u5b58\u5668\uff08\u5ffd\u7565\u7b97\u672f\u6ea2\u51fa\uff09\u3002\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u7531\u4e8e\u6211\u4eec\u91c7\u7528\u4e8664\u4f4d\u6307\u4ee4\u96c6\uff0c\u610f\u5473\u7740\u4ee5\u4e0a\u6307\u4ee4\u4e2d\u6240\u6709\u7684\u64cd\u4f5c\u6570\uff08\u65e0\u8bba\u662frd\u8fd8\u662frs\u4e2d\u7684\u503c\uff0c\u4ee5\u53caimmediate\uff09\u90fd\u662f64\u4f4d\u7684\u3002\u5982\u679cimmediate\u4e0d\u8db364\u4f4d\uff0c\u5219\u5bf9\u5176\u8fdb\u884c\u7b26\u53f7\u4f4d\uff08\u6700\u9ad8\u4f4d\uff09\u6269\u5c55\u523064\u4f4d\u3002\u5982\u679c\u8981\u64cd\u4f5c\u66f4\u5c0f\u4e00\u70b9\u7684\u6570\uff0c\u5219\u9700\u8981\u7528\u5230addw\uff0c\u5b83\u6700\u540e\u7684w\u7b26\u53f7\u8868\u793a\u64cd\u4f5c\u6570\u4e3a\u4e00\u4e2a\u5b57\uff0832\u4f4d\uff09\u3002</p> <p>\u4ee5\u4e0a\u6211\u4eec\u53ea\u662f\u4ee5add\u6c47\u7f16\u6307\u4ee4\u4f5c\u4e3a\u4f8b\u5b50\uff0c\u4e3e\u4f8b\u8bf4\u660e\u4e86RISC-V\u6c47\u7f16\u8bed\u8a00\u3002\u8bfb\u8005\u4f1a\u53d1\u73b0\u8ddf8086\u6c47\u7f16\u8bed\u8a00\u76f8\u6bd4\uff0cRISC-V\u6c47\u7f16\u8bed\u8a00\u5728\u8bed\u6cd5\u4e0a\u6709\u7740\u6839\u672c\u7684\u533a\u522b\uff0c\u6e90\u548c\u76ee\u7684\u5bc4\u5b58\u5668\u7684\u4f4d\u7f6e\u662f\u4e0d\u4e00\u6837\u7684\u3002\u7531\u4e8e\u672c\u4e66\u662f\u64cd\u4f5c\u7cfb\u7edf\u8bfe\u7a0b\u7684\u5b9e\u9a8c\u6307\u5bfc\uff0c\u65e0\u6cd5\u5b8c\u6574\u5730\u5217\u4e3e\u548c\u89e3\u91ca\u6240\u6709RISC-V\u6c47\u7f16\u6307\u4ee4\uff0c\u6211\u4eec\u5f3a\u70c8\u5efa\u8bae\u8bfb\u8005\u7ee7\u7eed\u9605\u8bfb\u53c2\u8003\u6587\u732e\u4e2d\u7684\u5f00\u6e90\u6307\u4ee4\u96c6\u7684\u6307\u5357\uff0c\u8fdb\u4e00\u6b65\u4e86\u89e3RISC-V\u6c47\u7f16\u8bed\u8a00\u3002</p> <p>1.2.3\u8bbf\u5b58\u548c\u5bfb\u5740\u6a21\u5f0f</p> <p>\u5728\u5185\u5b58\u8bbf\u95ee\u4e0a\uff0cRISC-V\u63d0\u4f9b\u7684\u63a5\u53e3\uff08\u76f8\u6bd4\u4e8e8086\u6c47\u7f16\uff09\u6781\u5176\u7b80\u5355\uff1a\u8bfb\u5185\u5b58\uff08load\uff09\u548c\u5199\u5185\u5b58\uff08store\uff09\u3002\u800c\u4e14\u6240\u6709\u5176\u4ed6\u6307\u4ee4\u90fd\u53ea\u4e0e\u5bc4\u5b58\u5668\u6253\u4ea4\u9053\uff0c\u4e0d\u80fd\u4f7f\u7528\u4efb\u4f55\u95f4\u63a5\u5f62\u5f0f\u5bf9\u5185\u5b58\u8fdb\u884c\u8bbf\u95ee\u3002\u8fd9\u6837\u8bbe\u8ba1\u7684\u597d\u5904\u662f\uff1a\u907f\u514d\u4e868086\u6c47\u7f16\u91cc\u4ee4\u4eba\u201c\u773c\u82b1\u7f2d\u4e71\u201d\u7684\u8bbf\u5b58\u5bfb\u5740\u6a21\u5f0f\uff0c\u8fd9\u4e5f\u662fRISC-V\u7684\u91cd\u8981\u201c\u540e\u53d1\u4f18\u52bf\u201d\u4e4b\u4e00\u3002</p> <p>\u6211\u4eec\u4ee5ld\uff08load\uff09\u6307\u4ee4\u548csw\uff08store word\uff09\u6307\u4ee4\u4e3a\u4f8b\u6765\u8bf4\u660eRISC-V\u7684\u8bbf\u5b58\u6307\u4ee4\uff0c\u4ee5\u4e0b\u662fld\u6307\u4ee4\u7684\u8bed\u6cd5\uff1a</p> <p><code>ld rd, offset(rs1)</code></p> <p>\u6267\u884cld\u6307\u4ee4\u7684\u52a8\u4f5c\u662f\u5c06\u7acb\u5373\u6570offset\u8fdb\u884c\u7b26\u53f7\u6269\u5c55\uff0c\u4e0e\u6e90\u5bc4\u5b58\u5668rs1\u4e2d\u7684\u503c\u8fdb\u884c\u6c42\u548c\uff0c\u5f97\u5230\u5730\u5740A\uff0c\u7136\u540e\u8bfb\u51fa\u5185\u5b58\u4e2dA\u6240\u5bf9\u5e94\u5730\u5740\u76848\u4e2a\u5b57\u8282\uff0864\u4f4d\uff09\uff0c\u5199\u5230\u76ee\u7684\u5bc4\u5b58\u5668rd\u4e2d\u3002</p> <p>\u4ee5\u4e0b\u662fsw\u6307\u4ee4\u7684\u8bed\u6cd5\uff1a</p> <p><code>sw rs2, offset(rs1)</code></p> <p>\u5b83\u7684\u4f5c\u7528\u662f\u5c06\u7acb\u5373\u6570offset\u8fdb\u884c\u7b26\u53f7\u6269\u5c55\uff0c\u4e0e\u6e90\u5bc4\u5b58\u5668rs1\u4e2d\u7684\u503c\u8fdb\u884c\u6c42\u548c\uff0c\u5f97\u5230\u5730\u5740A\uff0c\u7136\u540e\u5c06\u6e90\u5bc4\u5b58\u5668rs2\u4e2d\u7684\u4f4e\u4f4d4\u5b57\u8282\uff08\u6ce8\u610f\uff0c\u4e0d\u662f8\u4e2a\u5b57\u8282\uff0c\u56e0\u4e3a\u64cd\u7eb5\u7684\u662fword\uff0c\u537332\u4f4d4\u5b57\u8282\uff09\u5199\u5230\u5185\u5b58\u4e2d\u4ee5\u5730\u5740A\u5f00\u59cb\u76844\u4e2a\u5b57\u8282\u4e2d\u3002\u5f53RISC-V\u5904\u7406\u5668\u91c7\u7528s\u5f00\u59cb\u7684\u6307\u4ee4\uff08\u5982\u4f8b\u5b50\u4e2d\u7684sw\u3001\u53cc\u5b57\u5b58\u50a8\u6307\u4ee4sd\u7b49\uff09\u5411\u5185\u5b58\u4e2d\u5199\u5165\u6570\u636e\u7684\u65f6\u5019\uff0c\u5730\u5740\u662f\u4ece\u4f4e\u7aef\u5730\u5740\u5411\u9ad8\u7aef\u5730\u5740\u53d1\u5c55\u7684\u3002\u540c\u65f6\uff0c\u91c7\u7528\u4e86\u5c0f\u7aef\u5bf9\u9f50\uff08little-endian\uff09\u7684\u5b57\u8282\u5e8f\uff1a\u5f53\u5199\u5165\u4e00\u4e2a8\u5b57\u8282\u7684\u6570\u503c\u5230\u5185\u5b58\u4e2d\u65f6\uff0c\u5c06\u8be5\u6570\u503c\u7684\u4f4e\u4f4d\u90e8\u5206\u653e\u5728\u4f4e\u5730\u5740\u7aef\u3002</p> <p>\u4ee5\u4e0a\u7684\u4f8b\u5b50\u4e2d\uff0c\u5047\u8bbeA=0x0000 0000 0000 0800\uff0crs2\u5bc4\u5b58\u5668\u4e2d\u7684\u4f4e\u4f4d4\u5b57\u8282\u6570\u503c\u4e3a0x1234ABCD\uff0c\u5219sw\u6307\u4ee4\u6267\u884c\u5b8c\u540e\u5185\u5b58\u4e2d\u7684\u6570\u503c\u4e3a\uff1a</p> <pre><code>[0x0000 0000 0000 0800] = 0xCD\n[0x0000 0000 0000 0801] = 0xAB\n[0x0000 0000 0000 0802] = 0x34\n[0x0000 0000 0000 0803] = 0x12\n</code></pre> <p>1.2.4 C\u8bed\u8a00\u5185\u5d4c\u6c47\u7f16</p> <p>\u4e3a\u5b9e\u73b0\u5bf9\u786c\u4ef6\u7684\u201c\u5305\u88c5\u201d\uff0c\u64cd\u4f5c\u7cfb\u7edf\u5f80\u5f80\u9700\u8981\u64cd\u7eb5\u786c\u4ef6\u5b9e\u73b0\u4f8b\u5982\u6539\u53d8\u673a\u5668\u72b6\u6001\u7b49\u52a8\u4f5c\uff0c\u8fd9\u4e9b\u529f\u80fd\u9ad8\u7ea7\u8bed\u8a00\uff08\u5982C\uff09\u5e76\u672a\u63d0\u4f9b\uff0c\u5f80\u5f80\u9700\u8981\u6c47\u7f16\u8bed\u8a00\u6765\u5b8c\u6210\u3002\u7136\u800c\uff0c\u7eaf\u7cb9\u7528\u6c47\u7f16\u8bed\u8a00\u6765\u5b9e\u73b0\u64cd\u4f5c\u7cfb\u7edf\u53c8\u4f1a\u5bfc\u81f4\u4ee3\u7801\u91cf\u592a\u5927\uff0c\u4e14\u4ee3\u7801\u7684\u53ef\u8bfb\u6027\u4e0d\u597d\u3002\u7efc\u5408\u4e24\u8005\uff08\u6c47\u7f16\u8bed\u8a00\u548cC\u8bed\u8a00\uff09\u957f\u5904\u7684\u65b9\u6848\uff0c\u662f\u5728C\u8bed\u8a00\u4e2d\u5b9e\u73b0\u6c47\u7f16\u7684\u5d4c\u5165\uff0c\u800cPKE\u5b9e\u9a8c\u6240\u9009\u62e9\u7684\u57fa\u4e8eGCC\u7684RISC-V\u4ea4\u53c9\u7f16\u8bd1\u5668\u5c31\u63d0\u4f9b\u4e86\u4e24\u79cd\u5f62\u5f0f\u7684\u5185\u5d4c\u6c47\u7f16\u7684\u652f\u6301\uff1a\u57fa\u672c\u5185\u8054\u6c47\u7f16\u548c\u6269\u5c55\u5185\u8054\u6c47\u7f16\u3002</p> <p>\u25cf \u57fa\u672c\u5185\u8054\u6c47\u7f16\u8bed\u53e5</p> <p>\u57fa\u672c\u884c\u5185\u6c47\u7f16\u5f88\u5bb9\u6613\u7406\u89e3\uff0c\u4e00\u822c\u662f\u6309\u7167\u4e0b\u9762\u7684\u683c\u5f0f\uff1a</p> <p><code>asm(\u201cstatements\u201d);</code></p> <p>\u8be5\u8bed\u53e5\u4e2d\u201casm\u201d\u4e5f\u53ef\u4ee5\u7531\u201c__asm__\u201d\u6765\u4ee3\u66ff\u3002\u5728\u201casm\u201d\u540e\u9762\u6709\u65f6\u4e5f\u4f1a\u52a0\u4e0a\u201c__volatile__\u201d\u8868\u793a\u7f16\u8bd1\u5668\u4e0d\u8981\u5bf9\u62ec\u5f27\u5185\u7684\u6c47\u7f16\u4ee3\u7801\u8fdb\u884c\u4efb\u4f55\u4f18\u5316\uff0c\u4fdd\u6301\u6307\u4ee4\u7684\u539f\u6837\u3002\u201casm\u201d\u540e\u9762\u62ec\u53f7\u91cc\u9762\u7684\u4fbf\u662f\u6c47\u7f16\u6307\u4ee4\u3002\u4f8b\u5982\uff1a</p> <pre><code>asm(\u201cli x17,81\u201d);      //\u5c06\u7acb\u5373\u657081\u5b58\u5165x17\u5bc4\u5b58\u5668\nasm(\u201cecall\u201d);         //\u8c03\u7528ecall\u6307\u4ee4\uff08\u4f5c\u7528\u7c7b\u4f3c8086\u4e0a\u7684int\u6307\u4ee4\uff09\n</code></pre> <p>\u7f16\u8bd1\u5668\u78b0\u5230\u4ee5\u4e0a\u8bed\u53e5\u540e\uff0c\u4f1a\u5c06\u5f15\u53f7\u4e2d\u7684\u6c47\u7f16\u8bed\u53e5\u76f4\u63a5\u7ffb\u8bd1\u6210\u5bf9\u5e94\u7684\u673a\u5668\u7801\uff0c\u653e\u5230\u6240\u751f\u6210\u7684\u76ee\u6807\u4ee3\u7801\u4e2d\u3002\u8fd9\u4e24\u884c\u4ee3\u7801\u7684\u4f5c\u7528\u662f\u8c03\u752881\u53f7\u8f6f\u4e2d\u65ad\uff08\u53731.4\u8282\u4e2d\u7684trap\uff09\uff0c\u4f46\u56e0\u4e3a\u5b83\u4eec\u662f\u76f8\u90bb\u7684\u6c47\u7f16\u8bed\u53e5\uff0c\u6240\u4ee5\u53ef\u4ee5\u7528\u4ee5\u4e0b\u7684\u5f62\u5f0f\u4e66\u5199\uff1a</p> <pre><code>asm(\u201cli x17,81\\n\\t\u201d\n  \u201cecall\u201d);`\n</code></pre> <p>\u4e5f\u5c31\u662f\u91c7\u7528\u5206\u9694\u7b26\u201c\\n\\t\u201d\u9694\u5f00\u591a\u6761\u6c47\u7f16\u6307\u4ee4\u3002\u5bf9\u4e8e\u7f16\u8bd1\u5668\u800c\u8a00\uff0c\u4ee5\u4e0a\u4e24\u79cd\u5199\u6cd5\u662f\u7b49\u6548\u7684\u3002\u5b9e\u9645\u4e0aGCC\u7f16\u8bd1\u5668\u5728\u5904\u7406\u5185\u8054\u6c47\u7f16\u8bed\u53e5\u65f6\uff0c\u662f\u8981\u628aasm(\u2026)\u7684\u5185\u5bb9\u201c\u6253\u5370\u201d\u5230\u6c47\u7f16\u6587\u4ef6\u4e2d\uff0c\u6240\u4ee5\u683c\u5f0f\u63a7\u5236\u5b57\u7b26\u662f\u5fc5\u8981\u7684\u3002</p> <p>\u25cf \u6269\u5c55\u5185\u8054\u6c47\u7f16</p> <p>\u6269\u5c55\u5185\u8054\u6c47\u7f16\u4f7f\u5f97\u5d4c\u5165\u5728C\u8bed\u8a00\u4e2d\u7684\u4ee3\u7801\u80fd\u591f\u5e26\u8f93\u5165\u3001\u8f93\u51fa\u53c2\u6570\uff0c\u540c\u65f6\u5c06\u88ab\u6c47\u7f16\u4ee3\u7801\u5757\u6539\u53d8\u7684\u5bc4\u5b58\u5668\u201c\u901a\u77e5\u201d\u7ed9GCC\u7f16\u8bd1\u5668\uff0c\u4f5c\u4e3a\u540e\u8005\u5728\u8c03\u5ea6\u5bc4\u5b58\u5668\u65f6\u7684\u53c2\u8003\u3002\u6269\u5c55\u5185\u8054\u6c47\u7f16\u7684\u683c\u5f0f\u4e3a\uff1a</p> <pre><code>asm volatile( \n\"statements\"\uff08\u6c47\u7f16\u8bed\u53e5\u6a21\u677f\uff09: \noutput_regs\uff08\u8f93\u51fa\u90e8\u5206\uff09: \ninput_regs\uff08\u8f93\u5165\u90e8\u5206\uff09:\nclobbered_regs\uff08\u7834\u574f\u63cf\u8ff0\u90e8\u5206\uff09\n) \uff1b\n</code></pre> <p>\u5176\u4e2dasm \u8868\u793a\u540e\u9762\u7684\u4ee3\u7801\u4e3a\u5185\u5d4c\u6c47\u7f16\uff0c\u4e5f\u53ef\u4ee5\u5199\u4f5c__asm__\uff1bvolatile \u8868\u793a\u4e0d\u60f3\u8ba9\u7f16\u8bd1\u5668\u5bf9\u91cc\u9762\u7684\u6c47\u7f16\u4ee3\u7801\u8fdb\u884c\u4f18\u5316\uff0c\u4e5f\u53ef\u4ee5\u5199\u4f5c__volatile__ \u3002\"statements\"\u662f\u6c47\u7f16\u8bed\u53e5\u6a21\u677f\uff1boutput_regs\u662f\u5185\u8054\u6c47\u7f16\u7684\u8f93\u51fa\u90e8\u5206\uff0c\u53ef\u4ee5\u7406\u89e3\u4e3a\u5c06\u8981\u88ab\u6c47\u7f16\u8bed\u53e5\u4fee\u6539\u7684\u5bc4\u5b58\u5668\u7ec4\uff1binput_regs\u662f\u5185\u8054\u6c47\u7f16\u7684\u8f93\u5165\u90e8\u5206\uff0c\u5373\u8bed\u53e5\u6267\u884c\u6240\u9700\u8981\u7684\u8f93\u5165\u5bc4\u5b58\u5668\uff1bclobbered_regs\u662f\u7834\u574f\u63cf\u8ff0\u90e8\u5206\uff0c\u4ee3\u8868\u5c06\u8981\u88ab\u6c47\u7f16\u8bed\u53e5\u6539\u53d8\uff08\u7834\u574f\uff09\u7684\u5185\u5bb9\u3002\u6269\u5c55\u5185\u8054\u6c47\u7f16\u4e2d\u6c47\u7f16\u8bed\u53e5\u6a21\u7248\u662f\u5fc5\u987b\u8981\u7684\uff0c\u5176\u5b833\u90e8\u5206\u5219\u90fd\u662f\u53ef\u9009\u5185\u5bb9\uff0c\u4ee5\u4e0b\u5bf9\u8fd9\u4e9b\u90e8\u5206\u5206\u522b\u8fdb\u884c\u89e3\u91ca\uff1a</p> <p>\u6c47\u7f16\u4ee3\u7801\u6a21\u677f\uff1a\u6c47\u7f16\u8bed\u53e5\u6a21\u677f\u7531\u6c47\u7f16\u8bed\u53e5\u5e8f\u5217\u7ec4\u6210\uff0c\u8bed\u53e5\u4e4b\u95f4\u4f7f\u7528\u201c;\u201d\u3001\u201c\\n\u201d\u6216\u201c\\n\\t\u201d\u5206\u5f00\u3002\u6307\u4ee4\u4e2d\u7684\u64cd\u4f5c\u6570\u53ef\u4ee5\u4f7f\u7528\u5360\u4f4d\u7b26\u5f15\u7528C\u8bed\u8a00\u53d8\u91cf\uff0c\u64cd\u4f5c\u6570\u5360\u4f4d\u7b26\u6700\u591a10\u4e2a\uff0c\u540d\u79f0\u5982\u4e0b\uff1a%0\uff0c%1\u2026\uff0c%9\u3002\u6307\u4ee4\u4e2d\u4f7f\u7528\u4e0a\u8ff0\u5360\u4f4d\u7b26\u8868\u793a\u7684\u64cd\u4f5c\u6570\uff0c\u5360\u4f4d\u7b26\u4ece%0\u8d77\uff0c\u4f9d\u6b21\u8868\u793a\u8f93\u51fa\u64cd\u4f5c\u6570\u3001\u8f93\u5165\u64cd\u4f5c\u6570\u3002</p> <p>\u8f93\u51fa\u90e8\u5206\uff1a\u63cf\u8ff0\u8f93\u51fa\u64cd\u4f5c\u6570\uff0c\u53ef\u4ee5\u6709\u591a\u4e2a\u7ea6\u675f\uff0c\u4e0d\u540c\u7684\u64cd\u4f5c\u6570\u63cf\u8ff0\u7b26\u4e4b\u95f4\u7528\u9017\u53f7\u683c\u5f00\uff0c\u6bcf\u4e2a\u7ea6\u675f\u7528\u201c=\u201d\u5f00\u5934\uff0c\u63a5\u7740\u7528\u5b57\u6bcd\u8868\u793a\u64cd\u4f5c\u6570\u7684\u7c7b\u578b\u3002\u5e38\u7528\u7ea6\u675f\u6709\uff1a\"=r\"\uff0c\u8868\u793a\u76f8\u5e94\u64cd\u4f5c\u6570\u53ef\u4ee5\u4f7f\u7528\u4e00\u4e2a\u901a\u7528\u5bc4\u5b58\u5668\uff0c\"=m\",\u8868\u793a\u64cd\u4f5c\u6570\u5b58\u653e\u5728\u5185\u5b58\u5355\u5143\u4e2d\u3002\u4f8b\u5982:\"=m\" (ret)\uff0c\u5728\u8fd9\u91cc\u7684ret\u662f\u6700\u7ec8\u5b58\u653e\u8f93\u51fa\u7ed3\u679c\u7684C\u7a0b\u5e8f\u53d8\u91cf\uff0c\u800c\u201c=m\u201d\u5219\u662f\u9650\u5b9a\u5b57\u7b26\u4e32\uff0c\u9650\u5b9a\u5b57\u7b26\u4e32\u8868\u793a\u4e86\u5bf9\u5b83\u4e4b\u540e\u7684\u53d8\u91cf\u7684\u9650\u5236\u6761\u4ef6\uff0c\u8fd9\u6837GCC\u5c31\u53ef\u4ee5\u6839\u636e\u8fd9\u4e9b\u6761\u4ef6\u51b3\u5b9a\u5982\u4f55\u5206\u914d\u5bc4\u5b58\u5668\uff0c\u5982\u4f55\u4ea7\u751f\u5fc5\u8981\u7684\u4ee3\u7801\u5904\u7406\u6307\u4ee4\uff0c\u4ee5\u53ca\u5982\u4f55\u5904\u7406\u64cd\u4f5c\u6570\u4e0eC\u8868\u8fbe\u5f0f\u6216C\u53d8\u91cf\u4e4b\u95f4\u7684\u5173\u7cfb\u3002\u201c=\u201d\u540e\u9762\u6240\u8ddf\u7684\u5b57\u6bcd\u4ee5\u53ca\u542b\u4e49\u89c1\u88681.2\u3002</p> <p>\u8f93\u5165\u90e8\u5206\uff1a\u8f93\u5165\u90e8\u5206\u4e0e\u8f93\u51fa\u90e8\u5206\u76f8\u4f3c\uff0c\u4f46\u662f\u6ca1\u6709\u201c=\u201d\u7b26\u53f7\u3002</p> <p>\u7834\u574f\u63cf\u8ff0\u90e8\u5206\uff1a\u7834\u574f\u63cf\u8ff0\u7b26\u7528\u4e8e\u901a\u77e5\u7f16\u8bd1\u5668\u6211\u4eec\u4f7f\u7528\u4e86\u54ea\u4e9b\u5bc4\u5b58\u5668\u6216\u5185\u5b58\uff0c \u53ef\u4ee5\u9632\u6b62\u5185\u5d4c\u6c47\u7f16\u5728\u4f7f\u7528\u67d0\u4e9b\u5bc4\u5b58\u5668\u65f6\u5bfc\u81f4\u9519\u8bef\u3002\u4fee\u6539\u63cf\u8ff0\u7b26\u662f\u7531\u9017\u53f7\u9694\u5f00\u7684\u5b57\u7b26\u4e32\u7ec4\u6210\u7684\uff0c\u6bcf\u4e2a\u5b57\u7b26\u4e32\u63cf\u8ff0\u4e00\u79cd\u60c5\u51b5\uff0c\u4e00\u822c\u662f\u5bc4\u5b58\u5668\uff0c\u6709\u65f6\u4e5f\u4f1a\u6709\u201cmemory\u201d\u3002\u5177\u4f53\u7684\u610f\u601d\u5c31\u662f\u544a\u8bc9\u7f16\u8bd1\u5668\u5728\u7f16\u8bd1\u5185\u5d4c\u6c47\u7f16\u7684\u65f6\u5019\u4e0d\u80fd\u4f7f\u7528\u67d0\u4e2a\u5bc4\u5b58\u5668\u6216\u8005\u4e0d\u80fd\u4f7f\u7528\u5185\u5b58\u7684\u7a7a\u95f4\u3002</p> <p>\u88681.2 \u5185\u8054\u6c47\u7f16\u5e38\u7528\u7ea6\u675f</p> \u5b57\u6bcd \u542b\u4e49 m\u3001o \u5185\u5b58\u5355\u5143 r \u52a8\u6001\u5206\u914d\u7684\u5bc4\u5b58\u5668 i \u7acb\u5373\u6570 f \u6d6e\u70b9\u5bc4\u5b58\u5668 <p>\u6211\u4eec\u6765\u770b\u4e00\u4e2aC\u8bed\u8a00\u5185\u5d4c\u6c47\u7f16\u4ee3\u7801\u7684\u4f8b\u5b50\uff1a</p> <p><code>int dest=0;</code></p> <p><code>int value=1;</code></p> <p><code>asm volatile (</code></p> <p><code>\"lw t0,%1 \\n\\t\"</code></p> <p><code>\"add t0,t0,t0 \\n\\t\"</code></p> <p><code>\"sd t0,%0\"</code></p> <p><code>:\"=m\"(dest)       //\u8f93\u51fa\u90e8\u5206</code></p> <p><code>:\"m\" (value)      //\u8f93\u5165\u90e8\u5206</code></p> <p><code>: \"memory\");      //\u7834\u574f\u63cf\u8ff0\u90e8\u5206</code></p> <p>\u5728\u8fd9\u4e2a\u4f8b\u5b50\u5b9a\u4e49\u4e86\u4e24\u4e2a\u5c40\u90e8\u53d8\u91cfdest\u548cvalue\uff0c\u5b83\u4eec\u7684\u521d\u503c\u5206\u522b\u4e3a0\u548c1\u3002\u63a5\u4e0b\u6765\u7684\u6269\u5c55\u5185\u8054\u6c47\u7f16\u4ee3\u7801\u5c06value\u7684\u503c\u8bfb\u5165t0\u5bc4\u5b58\u5668\uff0c\u4f5c\u4e3a\u8f93\u5165\uff1b\u63a5\u7740\u4f7f\u7528add\u6307\u4ee4\u4f7ft0\u4e2d\u7684\u503c\u81ea\u6211\u76f8\u52a0\uff08\u5373t0=t0+t0\uff09\uff1b\u6700\u540e\u518d\u5c06\u7ed3\u679c\u5199\u56dedest\u5c40\u90e8\u53d8\u91cf\u3002\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u8fd9\u91cc%0\u5bf9\u5e94\u8f93\u51fa\u90e8\u5206\u7684dest\uff0c\u800c%1\u5bf9\u5e94\u7740\u8f93\u5165\u90e8\u5206\u7684value\uff0c\u56e0\u4e3adest\u5728\u6c47\u7f16\u4ee3\u7801\u6a21\u677f\u4e4b\u540e\u5148\u51fa\u73b0\u7684\u662fdest\uff0c\u540e\u51fa\u73b0\u7684\u662fvalue\u3002</p> <p>1.2.5 \u4e00\u4e2a\u4f8b\u5b50</p> <p>\u6211\u4eec\u518d\u770b\u4e00\u4e2a\u7a0d\u5fae\u5927\u4e00\u70b9\u7684\u4f8b\u5b50\uff0c\u901a\u8fc7\u8fd9\u4e2a\u4f8b\u5b50\u6211\u4eec\u5e0c\u671b\u80fd\u5c3d\u91cf\u628a\u4ee5\u4e0a\u7684\u77e5\u8bc6\u70b9\u4e32\u8d77\u6765\uff0c\u52a0\u6df1\u8bfb\u8005\u5bf9RISC-V\u6c47\u7f16\u8bed\u8a00\u7684\u7406\u89e3\u3002\u5047\u8bbe\u6709\u4ee5\u4e0bC\u8bed\u8a00\u7a0b\u5e8ftest_asm.c\uff0c\u5176\u6e90\u4ee3\u7801\u5982\u4f8b1.1\u6240\u793a\uff1a</p> <pre><code> 1 #include &lt;stdio.h&gt;\n 2\n 3 void bar()\n 4 {\n 5   asm volatile( \"li s5, 300\" );\n 6 }\n 7\n 8 int foo( int foo_arg )\n 9 {\n 10   int x;\n 11   asm volatile( \"li s5, 500\" );\n 12   bar();\n 13   asm volatile (\n 14      \"sd s5,%0\"\n 15      :\"=m\"(x)\n 16      :\n 17      : \"memory\");\n 18   printf( \"x=%d\\n\", x );\n 19   return 10;\n 20 }\n 21\n 22 int main()\n 23 {\n 24   foo( 10 );\n 25   return 0;\n 26 }\n</code></pre> <p>\u4f8b1.1 test_asm.c\u4ee3\u7801\u5217\u8868</p> <p>\u4f8b1.1\u4e2d\u7684\u4ee3\u7801\uff0c\u9664\u4e86main\u51fd\u6570\u5916\uff0c\u8fd8\u5b9a\u4e49\u4e86\u53e6\u5916\u4e24\u4e2a\u51fd\u6570foo(int)\u548cbar()\uff0c\u524d\u8005\u7684\u8fd4\u56de\u503c\u4e3a\u6574\u578b\u800c\u540e\u8005\u65e0\u8fd4\u56de\u503c\u3002\u4e3b\u51fd\u6570\u5728\u6267\u884c\u8fc7\u7a0b\u4e2d\u5148\u8c03\u7528foo(int)\u51fd\u6570\uff0c\u800cfoo(int)\u51fd\u6570\u5728\u6267\u884c\u8fc7\u7a0b\u4e2d\u8c03\u7528bar()\u51fd\u6570\u3002\u4ee3\u7801\u5728foo(int)\u51fd\u6570\u4e2d\u5185\u5d4c\u4e86\u4e24\u6bb5\u6c47\u7f16\u4ee3\u7801\uff0c\u7b2c11\u884c\u7684\u57fa\u672c\u6c47\u7f16\u8bed\u53e5\u5c06\u5bc4\u5b58\u5668s5\u7684\u503c\u8d4b\u503c\u4e3a500\uff0c\u800c\u7b2c13\u884c\u81f317\u884c\u7684\u6269\u5c55\u5185\u8054\u6c47\u7f16\u5219\u5c06\u5bc4\u5b58\u5668s5\u7684\u503c\u8bfb\u51fa\u5230\u5c40\u90e8\u53d8\u91cfx\uff0c\u5e76\u5728\u7b2c18\u884c\u6253\u5370\u51fa\u6765\u3002\u4e24\u7aef\u5185\u5d4c\u6c47\u7f16\u4e4b\u95f4\u88ab\u8c03\u7528\u7684bar()\u51fd\u6570\u4e5f\u6267\u884c\u4e86\u4e00\u4e2a\u5185\u5d4c\u6c47\u7f16\u8bed\u53e5\uff0c\u4f5c\u7528\u662f\u5c06\u5bc4\u5b58\u5668s5\u7684\u503c\u8d4b\u503c\u4e3a300\u3002\u4ee5\u4e0a\u8fc7\u7a0b\u7684\u76ee\u7684\u5728\u4e8e\u9a8c\u8bc1s5\u5bc4\u5b58\u5668\u5728\u8c03\u7528\u5b50\u51fd\u6570\u7684\u8fc7\u7a0b\u4e2d\uff0c\u51fd\u6570\u662f\u5426\u5c06\u5bc4\u5b58\u5668\u7684\u503c\u8fdb\u884c\u4e86\u4fdd\u7559\u3002\u6309\u7167RISC-V\u89c4\u8303\uff0c\u5bf9\u4e8e\u540d\u5b57\u4e3as\u5f00\u59cb\u7684\u5bc4\u5b58\u5668\uff0c\u5728\u8fdb\u884c\u51fd\u6570\u8c03\u7528\u65f6\u5e94\u8be5\u5bf9\u5176\u503c\u8fdb\u884c\u4fdd\u7559\uff0c\u5982\u679c\u8fd9\u4e00\u70b9\u88ab\u4e25\u683c\u9075\u5b88\u7684\u8bdd\uff0c\u4f8b1.1\u5728\u7b2c18\u884c\u7684\u8f93\u51fa\u5c31\u5e94\u8be5\u8f93\u51fa500\u3002</p> <p>\u5c06\u4f8b1.1\u91c7\u7528RISC-V\u4ea4\u53c9\u7f16\u8bd1\u5668\u7f16\u8bd1\u4e3a\u4e8c\u8fdb\u5236\u4ee3\u7801\uff0c\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u884c\uff1a </p> <p><code>$riscv64-unknown-elf-gcc test_asm.c -march='rv64g' -o test</code></p> <p>\u7f16\u8bd1\u65f6\u6211\u4eec\u901a\u8fc7GCC\u7684\u201c-march\u201d\u5f00\u5173\u6307\u5b9a\u76ee\u6807\u6307\u4ee4\u96c6\u662fRV64G\u3002\u63a5\u4e0b\u6765\u91c7\u7528\u4ee5\u4e0b\u547d\u4ee4\u6267\u884c\u4f8b1.1\u4e2d\u7684\u4ee3\u7801\uff08\u5176\u4e2dspike\u4e3a\u6a21\u62df\u5668\uff0cpke\u4e3a\u6211\u4eec\u7684PKE\u5185\u6838\uff0ctest\u4e3a\u4f8b1.1\u6240\u5bf9\u5e94\u7684\u4e8c\u8fdb\u5236\u4ee3\u7801\uff09\uff1a</p> <p><code>$ spike pke test</code></p> <p>\u4ee5\u4e0a\u547d\u4ee4\u7684\u6267\u884c\u7ed3\u679c\u4e3a\u201cx=300\u201d\u3002</p> <p>\u8fd9\u8bf4\u660e\u7f16\u8bd1\u5668\u4e3a\u4e86\u4ee3\u7801\u7684\u6548\u7387\uff0c\u5e76\u672a\u5b8c\u5168\u9075\u5b88RISC-V\u5bf9\u5bc4\u5b58\u5668\u4f7f\u7528\u7684\u89c4\u8303\u3002\u6211\u4eec\u53ef\u4ee5\u5bf9\u6240\u751f\u6210\u7684test\u6587\u4ef6\u8fdb\u884c\u53cd\u6c47\u7f16\uff1a</p> <p><code>$riscv64-unknown-elf-objdump -D ./test | less</code></p> <p>\u5f97\u5230\u4ee5\u4e0b\u8f93\u51fa\uff1a</p> <pre><code>00000000000101a4 &lt;bar&gt;:\n  101a4:    ff010113        addi  sp,sp,-16\n  101a8:    00813423        sd   s0,8(sp)\n  101ac:    01010413        addi  s0,sp,16\n  101b0:    12c00a93        li   s5,300\n  101b4:    00000013        nop\n  101b8:    00813403        ld    s0,8(sp)\n  101bc:    01010113        addi  sp,sp,16\n  101c0:    00008067        ret\n00000000000101c4 &lt;foo&gt;:\n  101c4:    fd010113        addi  sp,sp,-48\n  101c8:    02113423        sd   ra,40(sp)\n  101cc:    02813023        sd   s0,32(sp)\n  101d0:    03010413        addi  s0,sp,48\n  101d4:    00050793        mv   a5,a0\n  101d8:    fcf42e23        sw   a5,-36(s0)\n  101dc:    1f400a93        li   s5,500\n  101e0:    fc5ff0ef        jal   ra,101a4 &lt;bar&gt;\n  101e4:    ff543623        sd   s5,-20(s0)\n  101e8:    fec42783        lw   a5,-20(s0)\n  101ec:    00078593        mv   a1,a5\n  101f0:    0001c7b7        lui   a5,0x1c\n  101f4:    f7078513        addi  a0,a5,-144 # 1bf70 &lt;__clzdi2+0x2e&gt;\n  101f8:    1e2000ef        jal   ra,103da &lt;printf&gt;\n  101fc:    00a00793        li    a5,10\n  10200:    00078513        mv   a0,a5\n  10204:    02813083        ld   ra,40(sp)\n  10208:    02013403        ld   s0,32(sp)\n  1020c:    03010113        addi  sp,sp,48\n  10210:    00008067        ret\n0000000000010214 &lt;main&gt;:\n  10214:    ff010113        addi  sp,sp,-16\n  10218:    00113423        sd   ra,8(sp)\n  1021c:    00813023        sd   s0,0(sp)\n  10220:    01010413         addi  s0,sp,16\n  10224:    00a00513        li   a0,10\n  10228:    f9dff0ef        jal   ra,101c4 &lt;foo&gt;\n  1022c:    00000793        li   a5,0\n  10230:    00078513        mv   a0,a5\n  10234:    00813083        ld   ra,8(sp)\n  10238:    00013403        ld   s0,0(sp)\n  1023c:    01010113        addi  sp,sp,16\n  10240:    00008067        ret\n</code></pre> <p>\u8f93\u51fa\u7684\u7b2c\u4e00\u5217\u662f\u6211\u4eec\u7684\u7a0b\u5e8f\u5730\u5740\uff08\u4e5f\u79f0\u903b\u8f91\u5730\u5740\uff09\uff1b\u7b2c\u4e8c\u5217\u662f\u673a\u5668\u7801\uff0c\u6211\u4eec\u770b\u5230RV64G\u7684\u673a\u5668\u7801\u90fd\u662f\u89c4\u6574\u768432\u4f4d\uff084\u4e2a\u5b57\u8282\uff09\uff0c\u8fd9\u7b26\u5408RISC\u6307\u4ee4\u96c6\u7684\u7279\u70b9\uff1b\u4e4b\u540e\u7684\u5217\u5c31\u662f\u5bf9\u5e94\u7684\u6c47\u7f16\u4ee3\u7801\u4e86\u3002\u5176\u4e2d\u6bd4\u8f83\u91cd\u8981\u7684\u6307\u4ee4\u662fjal\uff08jump and link\uff09\uff0c\u5176\u4f5c\u7528\u662f\u5c06\u8fd4\u56de\u5730\u5740\uff08pc+4\uff09\u5199\u9053ra\u5bc4\u5b58\u5668\u4e2d\uff0c\u4e14\u5c06pc\u8d4b\u503c\u4e3a\u7b2c\u4e8c\u4e2a\u53c2\u6570\uff08\u5373\u8df3\u8f6c\u5230\u7b2c\u4e8c\u4e2a\u53c2\u6570\u6240\u6307\u5411\u7684\u903b\u8f91\u5730\u5740\uff09\u3002\u53e6\u4e00\u4e2a\u91cd\u8981\u7684\u6307\u4ee4\u662fret\uff0c\u5176\u4f5c\u7528\u662f\u5c06pc\u7684\u8d4b\u503c\u4e3ara\u5bc4\u5b58\u5668\u7684\u5185\u5bb9\uff08\u5373\u8df3\u8f6c\u5230\u51fd\u6570\u88ab\u8c03\u7528\u4e4b\u524d\u4fdd\u5b58\u7684\u51fd\u6570\u8fd4\u56de\u5730\u5740\uff09\u3002\u4ece\u53cd\u6c47\u7f16\u7684\u7ed3\u679c\u4e0a\u6765\u770b\uff0ctest\u4e2d\u5e76\u672a\u5bf9s\u5f00\u59cb\u7684\u5bc4\u5b58\u5668\u8fdb\u884c\u4efb\u4f55\u7684\u4fdd\u62a4\u52a8\u4f5c\uff0c\u8fd9\u5c31\u662f\u4e3a\u4ec0\u4e48\u6211\u4eec\u5f97\u5230\u201cx=300\u201d\u7ed3\u679c\u7684\u539f\u56e0\u3002</p> <p>\u6211\u4eec\u4ecd\u7136\u4ee5\u4f8b1.1\u4e3a\u4f8b\u5206\u6790RISC-V\u7a0b\u5e8f\u6267\u884c\u8fc7\u7a0b\u4e2d\uff0c\u6808\u7684\u53d8\u5316\u3002RISC-V\u5e76\u672a\u63d0\u4f9bpush\u548cpop\u6307\u4ee4\uff0c\u6240\u4ee5\u51fd\u6570\u5f00\u59cb\u65f6\u5bf9sp\u5bc4\u5b58\u5668\u7684\u64cd\u4f5c\u90fd\u662fRISC-V\u7248\u672c\u7684\u5165\u6808\u52a8\u4f5c\u3002\u4f8b\u5982\uff0cmain\u51fd\u6570\u4e2d\u7684\u201caddi sp,sp,-16\u201d\u6307\u4ee4\uff0c\u5c06sp\u51cf\u53bb16\u7136\u540e\u8d4b\u503c\u7ed9sp\uff0c\u5176\u5b9e\u8d28\u662f\u5728\u6808\u9876\u201c\u7a7a\u51fa\u201d16\u4e2a\u5b57\u8282\u7684\u7a7a\u95f4\uff0c\u7136\u540e\u5c06\u5fc5\u8981\u7684\u5185\u5bb9\u8fdb\u884c\u538b\u6808\u3002\u5982\u540e\u7eed\u7684\u201csd ra,8(sp)\u201d\u5c31\u662f\u5c06\u8fd4\u56de\u5730\u5740\uff08ra\u5bc4\u5b58\u5668\u4e2d\u7684\u5185\u5bb9\uff09\u538b\u6808\uff1b\u800c\u201csd s0,0(sp)\u201d\u662f\u5c06fp\u5bc4\u5b58\u5668\u4e2d\u7684\u5185\u5bb9\u538b\u6808\uff08s0\u548cfp\u662f\u540c\u4e00\u4e2a\u5bc4\u5b58\u5668\uff0c\u53c2\u89c1\u88681.1\uff09\u3002\u4f8b1.1\u4e2d\u7a0b\u5e8f\u4ecemain\u51fd\u6570\u5230bar\u51fd\u6570\u7684\u51fd\u6570\u8c03\u7528\u8fc7\u7a0b\u4e2d\uff0c\u5b83\u7684\u7a0b\u5e8f\u6808\u5c06\u5f62\u6210\u56fe1.2\u4e2d\u6240\u793a\u7684\u7ed3\u6784\uff1a</p> <p></p> <p></p> <p>\u56fe1.2 \u4f8b1.1\u7a0b\u5e8f\u7684\u51fd\u6570\u8c03\u7528\u6808\u7ed3\u6784\uff08\u4ecemain\u51fd\u6570\u5230bar\u51fd\u6570\uff09</p> <p>\u6211\u4eec\u770b\u5230\uff0c\u4e0d\u540c\u7684\u51fd\u6570\u5177\u6709\u7684\u6808\u5e27\uff08stack frame\uff09\u7684\u5927\u5c0f\u5b9e\u9645\u4e0a\u662f\u5f88\u4e0d\u4e00\u6837\u7684\uff0c\u4e00\u822c\u6765\u8bf4\uff0c\u7b80\u5355\u7684\u51fd\u6570\uff08\u5982main\u548cbar\uff09\u7684\u6808\u5e27\u6bd4\u8f83\u5c0f\u90fd\u53ea\u670916\u4e2a\u5b57\u8282\u3002\u8fd9\u662f\u56e0\u4e3a\u5bf9\u4e8e\u51fd\u6570\u6765\u8bf4\uff0c\u6808\u7684\u4f5c\u7528\u5728\u4e8e\u4fdd\u5b58\u8fdb\u5165\u65f6\u7684\u73b0\u573a\u3001\u51fd\u6570\u4e2d\u88ab\u4f7f\u7528\u7684\u5bc4\u5b58\u5668\uff0c\u4ee5\u53ca\u51fd\u6570\u7684\u5c40\u90e8\u53d8\u91cf\u3002\u5bf9\u4e8e\u7b80\u5355\u7684\u51fd\u6570\u800c\u8a00\uff0c\u5176\u4f7f\u7528\u7684\u5bc4\u5b58\u5668\u8f83\u5c11\uff0c\u540c\u65f6\u4e5f\u6ca1\u5565\u5c40\u90e8\u53d8\u91cf\uff0c\u8fd9\u4e9b\u56e0\u7d20\u5c31\u5bfc\u81f4\u4e86\u8f83\u5c0f\u7684\u6808\u5e27\u3002\u53e6\u5916\uff0c\u8fd9\u4e2a\u51fd\u6570\u8c03\u7528\u8fc7\u7a0b\u4e2d\u6bd4\u8f83\u6709\u8da3\u7684\u662fra\u548cfp\u4e24\u4e2a\u5bc4\u5b58\u5668\u3002ra\u5bc4\u5b58\u5668\u6307\u5411\u51fd\u6570\u7684\u8fd4\u56de\u5730\u5740\uff0c\u4e00\u822c\u4f1a\u5728\u51fd\u6570\u5165\u53e3\u5904\u5165\u6808\u3002\u4f46\u662f\u5bf9\u4e8ebar\u51fd\u6570\u6765\u8bf4\uff0c\u56e0\u4e3a\u5b83\u662f\u53f6\u5b50\u51fd\u6570\uff08leaf function\uff09\u5904\u4e8e\u51fd\u6570\u8c03\u7528\u7684\u6700\u540e\u4e00\u7ea7\uff0c\u6240\u4ee5\u5c31\u65e0\u9700\u5c06ra\u5bc4\u5b58\u5668\u5165\u6808\u3002fp\u5bc4\u5b58\u5668\u5219\u6307\u5411\u4e0a\u4e00\u7ea7\u51fd\u6570\u7684\u6808\u5e27\uff0c\u51fd\u6570\u5728\u5165\u53e3\u5904\u90fd\u9700\u8981\u5c06\u5b83\u5b58\u5165\u6808\u4e2d\uff0c\u56e0\u4e3a\u53ea\u6709\u8fd9\u6837\u51fd\u6570\u624d\u80fd\u591f\u627e\u5230\u6765\u65f6\u7684\u8def\uff0c\u5728\u8fd4\u56de\u65f6\u505a\u5230\u6709\u8def\u53ef\u8d70\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter1_riscv/#13","title":"1.3 \u673a\u5668\u7684\u7279\u6743\u72b6\u6001","text":"<p>\u91c7\u7528RV64G\u6307\u4ee4\u96c6\u7684\u5904\u7406\u5668\uff0c\u5b9a\u4e49\u4e86\u4e09\u79cd\u7279\u6743\u6a21\u5f0f\uff1a\u8fd0\u884c\u5728\u6700\u9ad8\u7279\u6743\u7ea7\u7684\u673a\u5668\u6a21\u5f0f\uff08machine mode\uff09\uff0c\u8fd0\u884c\u5728\u6b21\u9ad8\u7279\u6743\u7ea7\u7684\u76d1\u7ba1\u8005\u6a21\u5f0f\uff08supervisor mode\uff09\uff0c\u4ee5\u53ca\u6700\u4f4e\u7279\u6743\u7ea7\u7684\u7528\u6237\u6a21\u5f0f\uff08user mode\uff09\u3002\u673a\u5668\u6a21\u5f0f\u662f\u542f\u52a8\u540e\uff0c\u8ba1\u7b97\u673a\u6240\u5904\u7684\u6a21\u5f0f\uff0c\u5728\u8be5\u6a21\u5f0f\u4e0b\u80fd\u591f\u8fd0\u884c\u6240\u6709\u7279\u6743\u6307\u4ee4\uff0c\u8bbf\u95ee\u6240\u6709\u5185\u5b58\u7a7a\u95f4\u3002\u76d1\u7ba1\u8005\u6a21\u5f0f\u6240\u5904\u7684\u7279\u6743\u7ea7\u7565\u4f4e\u4e8e\u673a\u5668\u6a21\u5f0f\uff0c\u4f46\u4ecd\u80fd\u591f\u8fd0\u884c\u90e8\u5206\u7279\u6743\u6307\u4ee4\uff0c\u4ee5\u53ca\u8bbf\u95ee\u673a\u5668\u6a21\u5f0f\u6240\u89c4\u5b9a\u7684\u6240\u6709\u5185\u5b58\u7a7a\u95f4\u3002\u7528\u6237\u6a21\u5f0f\u7684\u7279\u6743\u7ea7\u6700\u4f4e\uff0c\u65e0\u6cd5\u6267\u884c\u6539\u53d8\u673a\u5668\u72b6\u6001\u7684\u7279\u6743\u6307\u4ee4\uff0c\u548c\u8bbf\u95ee\u8d85\u8fc7\u5e94\u7528\u7a0b\u5e8f\u8303\u56f4\u7684\u5185\u5b58\u7a7a\u95f4\u3002\u4e3a\u540e\u7eed\u8ba8\u8bba\u7684\u65b9\u4fbf\uff0c\u6211\u4eec\u6709\u65f6\u4f1a\u7b80\u79f0\u673a\u5668\u6a21\u5f0f\u4e3aM\u6a21\u5f0f\uff0c\u76d1\u7ba1\u8005\u6a21\u5f0f\u4e3aS\u6a21\u5f0f\uff0c\u7528\u6237\u6a21\u5f0f\u4e3aU\u6a21\u5f0f\u3002</p> <p>\u5b9e\u9645\u4e0a\uff0cRISC-V\u6307\u4ee4\u96c6\u7684\u8bbe\u8ba1\u7efc\u5408\u8003\u8651\u4e86\u4ece\u5fae\u578b\u5d4c\u5165\u5f0f\u8bbe\u5907\u5230\u4e91\u670d\u52a1\u5668\u7684\u591a\u79cd\u5e94\u7528\u573a\u5408\uff0c\u6839\u636e\u5e94\u7528\u573a\u5408\u7684\u4e0d\u540c\uff0c\u5c31\u51fa\u73b0\u4e86\u591a\u79cd\u7279\u6743\u7ea7\u7684\u7ec4\u5408\u3002\u4f8b\u5982\uff0c\u5bf9\u4e8e\u7b80\u5355\u7684\u5d4c\u5165\u5f0f\u8bbe\u5907\uff08\u4f8b\u5982\u6211\u4eec\u7684U\u76d8\u63a7\u5236\u5668\uff09\u53ea\u8bbe\u8ba1\u673a\u5668\u6a21\u5f0f\uff08M\uff09\u5c31\u8db3\u591f\u4e86\uff1b\u5bf9\u4e8e\u6709\u5b89\u5168\u6027\u8003\u8651\u7684\u5d4c\u5165\u5f0f\u8bbe\u5907\uff08\u4f8b\u5982\u8f66\u8f86\u7684\u4e2d\u63a7\u3001\u8def\u7531\u5668\u7b49\uff09\uff0c\u5219\u9700\u8981\u642d\u914d\u673a\u5668\u6a21\u5f0f\u548c\u7528\u6237\u6a21\u5f0f\u7684\u7ec4\u5408\uff08M+U\uff09\uff1b\u5bf9\u4e8e\u901a\u7528\u8ba1\u7b97\u673a\uff08\u4f8b\u5982\u53f0\u5f0f\u7535\u8111\u3001\u624b\u673a\uff0c\u4ee5\u53ca\u4e91\u670d\u52a1\u5668\uff09\uff0c\u7531\u4e8e\u9700\u8981\u8fd0\u884c\u901a\u7528\u64cd\u4f5c\u7cfb\u7edf\uff0c\u5219\u9700\u8981\u673a\u5668\u6a21\u5f0f\u3001\u76d1\u7ba1\u6a21\u5f0f\u4ee5\u53ca\u7528\u6237\u6a21\u5f0f\u7684\u7ec4\u5408\uff08M+S+U\uff09\u3002\u7531\u4e8e\u672c\u4e66\u7684\u4e3b\u9898\u662f\u64cd\u4f5c\u7cfb\u7edf\uff0c\u5728\u4ee5\u540e\u7684\u5b9e\u9a8c\u4e2d\u6211\u4eec\u5c06\u5047\u8bbe\u6211\u4eec\u7684RISC-V\u8ba1\u7b97\u673a\u91c7\u7528\u4e86M+S+U\u7684\u7ec4\u5408\u3002</p> <p></p> <p>\u56fe1.3 RISC-V\u673a\u5668\u7684\u7279\u6743\u6a21\u5f0f\u4e0e\u7279\u6743\u7ea7\u8f6c\u6362</p> <p>\u901a\u8fc7\u300a\u64cd\u4f5c\u7cfb\u7edf\u539f\u7406\u300b\u8bfe\u6211\u4eec\u77e5\u9053\uff0c\u73b0\u4ee3\u7684\u5904\u7406\u5668\u5b9a\u4e49\u4e0d\u540c\u7279\u6743\u7ea7\u7684\u6839\u672c\u539f\u56e0\uff0c\u662f\u4e3a\u4e86\u5bf9\u64cd\u4f5c\u7cfb\u7edf\u8fdb\u884c\u4fdd\u62a4\u3002\u4f8b\u5982\uff0c\u8ba9\u64cd\u4f5c\u7cfb\u7edf\u8fd0\u884c\u5728\u8f83\u9ad8\u7684\u7279\u6743\u6a21\u5f0f\uff0c\u800c\u7528\u6237\u4ee3\u7801\u5219\u8fd0\u884c\u5728\u8f83\u4f4e\u7684\u7279\u6743\u6a21\u5f0f\uff0c\u4ee5\u9632\u6b62\u7528\u6237\u6001\u4ee3\u7801\u6267\u884c\u6076\u610f\u7684\u52a8\u4f5c\u7834\u574f\u64cd\u4f5c\u7cfb\u7edf\u3002\u7136\u800c\uff0c\u7528\u6237\u6001\u7684\u4ee3\u7801\u5728\u5b83\u7684\u751f\u547d\u5468\u671f\u91cc\u5f80\u5f80\u4f1a\u8981\u6c42\u505a\u4e00\u4e9b\u201c\u5408\u6cd5\u201d\u7684\u7279\u6743\u6a21\u5f0f\u884c\u4e3a\uff08\u4f8b\u5982\u8fdb\u884cI/O\uff0c\u5178\u578b\u4f8b\u5b50\u5982\u5e38\u7528\u7684printf\u51fd\u6570\uff09\uff0c\u8fd9\u5c31\u610f\u5473\u7740\u5904\u7406\u5668\u540c\u65f6\u9700\u8981\u652f\u6301\u7279\u6743\u6a21\u5f0f\u7684\u8f6c\u6362\uff08control transfer\uff09\u3002\u5728RISC-V\u5904\u7406\u5668\u4e2d\uff0c\u5b9e\u73b0\u8fd9\u79cd\u7279\u6743\u6a21\u5f0f\u8f6c\u6362\u7684\u5de5\u5177\u5c31\u662f\u4e2d\u65ad\uff0c\u5f53\u6267\u884c\u5728\u4f4e\u7279\u6743\u6a21\u5f0f\u7684\u4ee3\u7801\u88ab\u4e2d\u65ad\u65f6\uff0c\u5904\u7406\u5668\u5c06\u8fdb\u5165\u66f4\u9ad8\u7279\u6743\u6a21\u5f0f\u6267\u884c\u4e2d\u65ad\u5904\u7406\u4f8b\u7a0b\u6765\u5904\u7406\u6253\u65ad\uff08\u4f4e\u7279\u6743\uff09\u4ee3\u7801\u6267\u884c\u7684\u4e8b\u4ef6\u3002\u4e2d\u65ad\u5904\u7406\u5b8c\u6210\u540e\uff0c\u5904\u7406\u5668\u5c06\u4ece\u9ad8\u7279\u6743\u6a21\u5f0f\u8fd4\u56de\u4f4e\u7279\u6743\u6a21\u5f0f\u3002\u8fd9\u91cc\u7684\u4e2d\u65ad\u6709\u65f6\u88ab\u79f0\u4e3a\u5f02\u5e38\u6216\u7cfb\u7edf\u8c03\u7528\uff0c\u6211\u4eec\u5c06\u57281.4\u8282\u8be6\u7ec6\u8ba8\u8bba\u4e2d\u65ad\u7684\u5206\u7c7b\u3001\u76f8\u5173\u672f\u8bed\u548c\u5904\u7406\u8fc7\u7a0b\u3002\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0cRISC-V\u5904\u7406\u5668\u53ef\u4ee5\u5b9e\u73b0\u8de8\u7279\u6743\u6a21\u5f0f\u7684\u8f6c\u6362\uff0c\u4f8b\u5982\u4eceU\u6a21\u5f0f\u76f4\u63a5\u8fdb\u5165M\u6a21\u5f0f\uff0c\u6216\u8005\u4eceM\u6a21\u5f0f\u8fd4\u56deU\u6a21\u5f0f\uff0c\u8fd9\u4e9b\u8f6c\u6362\u7684\u53d1\u751f\u90fd\u53d6\u51b3\u4e8e\u673a\u5668\u7684\u72b6\u6001\u5bc4\u5b58\u5668\u7684\u8bbe\u7f6e\u3002</p> <p>RISC-V\u4e3a\u6bcf\u4e00\u79cd\u7279\u6743\u6a21\u5f0f\u5b9a\u4e49\u4e86\u4e00\u7ec4\u5bc4\u5b58\u5668\uff0c\u7528\u4e8e\u63a7\u5236\u673a\u5668\u7684\u72b6\u6001\uff08status\uff09\u4ee5\u53ca\u5b9e\u73b0\u72b6\u6001\u7684\u8f6c\u6362\u3002\u5bf9\u4e8e\u64cd\u4f5c\u7cfb\u7edf\u800c\u8a00\uff0c\u6bd4\u8f83\u91cd\u8981\u7684\u662f\u673a\u5668\u6a21\u5f0f\u548c\u76d1\u7ba1\u6a21\u5f0f\u7684\u4e00\u7ec4\u5bc4\u5b58\u5668\uff08Control and Status Registers\uff0c\u7b80\u5199\u4e3aCSRs\uff09\uff0c\u4e0b\u9762\u6211\u4eec\u5c06\u5206\u522b\u8ba8\u8bba\u8fd9\u4e24\u79cd\u6a21\u5f0f\u4e0b\u7684CSR\uff0c\u4ee5\u53ca\u72b6\u6001\u8f6c\u6362\u7684\u5b9e\u73b0\u3002\u9700\u8981\u8bf4\u660e\u7684\u662f\uff0c\u5173\u4e8eRISC-V\u673a\u5668\u7684\u7279\u6743\u72b6\u6001\uff0cRISC-V instruction set manual\u662f\u4e00\u4e2a\u6bd4\u8f83\u597d\u7684\u6587\u6863\uff0c\u8fd9\u91cc\u6211\u4eec\u5c06\u91cd\u70b9\u8ba8\u8bba\u4e0e\u64cd\u4f5c\u7cfb\u7edf\u76f8\u5173\u7684\u5185\u5bb9\u3002</p> <p>1.3.1 \u673a\u5668\u6a21\u5f0f\u4e0b\u7684CSR</p> <p>\u88681.3\u5217\u51fa\u4e86\u5728\u673a\u5668\u6a21\u5f0f\u4e0b\uff0cRV64G\u5904\u7406\u4e2d\u63a7\u5236\u673a\u5668\u72b6\u6001\u548c\u4e0e\u72b6\u6001\u8f6c\u6362\u7684\u4e3b\u8981\u5bc4\u5b58\u5668\uff1a</p> <p>\u88681.3 RV64G\u673a\u5668\u6a21\u5f0f\u4e0b\u7684CSR\uff08\u5b83\u4eec\u7684\u957f\u5ea6\u90fd\u662f64\u4f4d\uff09</p> \u5bc4\u5b58\u5668 \u4f5c\u7528 mscratch Machine  Scratch\u3002\u4fdd\u5b58\u673a\u5668\u6a21\u5f0f\u7684\u6808\u9876\u6307\u9488\uff0c\u8fd9\u4e00\u70b9\u5728\u79bb\u5f00\u673a\u5668\u6a21\u5f0f\u8fdb\u5165\u4f4e\u7279\u6743\u7ea7\u6a21\u5f0f\uff08\u5982\u76d1\u7ba1\u6a21\u5f0f\uff09\u65f6\u975e\u5e38\u91cd\u8981\uff0c\u56e0\u4e3a\u4e00\u65e6\u5728\u4f4e\u7279\u6743\u7ea7\u6a21\u5f0f\u53d1\u751f\u5f02\u5e38\uff0c\u5c06\u53ef\u80fd\u4f1a\u56de\u5230\u673a\u5668\u6a21\u5f0f\u5904\u7406\uff0c\u8fd9\u65f6\u673a\u5668\u6a21\u5f0f\u9700\u8981\u6709\u81ea\u5df1\u7684\u6808\u6765\u4fdd\u5b58M\u6a21\u5f0f\u4e0b\u7684\u6267\u884c\u6240\u8c03\u7528\u7684\u51fd\u6570\u53c2\u6570\u548c\u8fd4\u56de\u5730\u5740\u3002 mstatus Machine  Status\u3002\u4fdd\u5b58\u673a\u5668\u72b6\u6001\u7684\u5bc4\u5b58\u5668\u3002 mtvec Machine  Trap Vector\u3002\u6307\u5411\u4e2d\u65ad\u5904\u7406\u51fd\u6570\u7684\u5165\u53e3\u5730\u5740\u3002 mepc Machine  Exception PC\u3002\u6307\u5411\u53d1\u751f\u5f02\u5e38\u7684\u90a3\u6761\u6307\u4ee4\u7684\u5730\u5740\u3002 mcause Machine  Cause\u3002\u53d1\u751f\u4e2d\u65ad\u7684\u539f\u56e0\uff0c\u5982\u679c\u53d1\u751f\u7684\u4e2d\u65ad\u662f\u5f02\u5e38\uff0c\u5176\u6700\u9ad8\u4f4d\u4e3a0\uff0c\u4f4e\u4f4d\u4e3a\u5f02\u5e38\u7f16\u53f7\uff1b\u5982\u679c\u53d1\u751f\u7684\u662f\u5176\u4ed6\u7c7b\u578b\u7684\u4e2d\u65ad\uff0c\u5219\u5176\u6700\u9ad8\u4f4d\u4e3a1\uff0c\u4f4e\u4f4d\u4e3a\u4e2d\u65ad\u7f16\u53f7\u3002 mtval Machine  Trap Value\u3002\u5f02\u5e38\u53d1\u751f\u65f6\uff0c\u9644\u5e26\u7684\u53c2\u6570\u503c\u3002\u4f8b\u5982\uff0c\u5f53\u7f3a\u9875\u5f02\u5e38\u53d1\u751f\u65f6\uff0cmtval\u7684\u503c\u5c31\u662f\u7a0b\u5e8f\u60f3\u8981\u8bbf\u95ee\u7684\u865a\u5730\u5740\u3002 mie Machine  Interrupt Enable\u3002\u4e2d\u65ad\u5f00\u542f\u5bc4\u5b58\u5668\u3002 mip Machine  Interrupt Pending\u3002\u4e2d\u65ad\u7b49\u5f85\u5bc4\u5b58\u5668\u3002 mideleg Machine  Interrupt Delegation Registers\u3002\u4e2d\u65ad\u4ee3\u7406\u5bc4\u5b58\u5668\u3002 medeleg Machine  Exception Delegation Registers\u3002\u5f02\u5e38\u4ee3\u7406\u5bc4\u5b58\u5668\u3002 <p>\u88681.3\u4e2d\u7684\u5bc4\u5b58\u5668\u5f88\u591a\u53ea\u662f\u5b58\u653e\u4e86\u4e00\u4e2a\u6307\u5411\u5185\u5b58\u5730\u5740\u7684\u6307\u9488\uff08\u5982mscratch\u3001mtvec\u3001mepc\uff09\uff0c\u76f8\u5bf9\u7b80\u5355\uff1b\u800cmcause\u3001mtval\u3001mideleg\u4ee5\u53camedeleg\u90fd\u4e0e\u4e2d\u65ad\u5904\u7406\u7d27\u5bc6\u76f8\u5173\uff0c\u6211\u4eec\u5c06\u57281.4\u8282\u8ba8\u8bba\u4e2d\u65ad\u65f6\u518d\u5bf9\u5b83\u4eec\u7684\u4f5c\u7528\u8fdb\u884c\u8ba8\u8bba\u3002M\u6a21\u5f0f\u7684CSR\u4e2d\u6bd4\u8f83\u7279\u6b8a\u7684\u662fmstatus\uff0c\u5b83\u5b58\u653e\u4e86\u673a\u5668\u7684\u72b6\u6001\uff0c\u5176\u7ed3\u6784\u5982\u4e0b\u56fe\u6240\u793a\uff1a</p> <p></p> <p>\u56fe1.4 mstatus\u5bc4\u5b58\u5668\u7ed3\u6784</p> <p>\u4ee5\u4e0b\u662f\u5bf9mstatus\u4e2d\u5404\u4e2a\u4f4d\u7684\u8bf4\u660e\uff1a</p> <p>\u25cf MIE\uff0cSIE\uff0cUIE: \u4e2d\u65ad\u4f7f\u80fd\u4f4d\u3002\u53ea\u6709\u5f53\u8fd9\u4e2a\u4f4d\u4e3a1\u65f6\uff0c\u5904\u7406\u5668\u624d\u80fd\u591f\u5206\u522b\u5728\u673a\u5668\u6a21\u5f0f\u3001\u76d1\u7ba1\u6a21\u5f0f\u6216\u8005\u7528\u6237\u6a21\u5f0f\u5904\u7406\u4e2d\u65ad\u3002\u5b9e\u9645\u4e0a\uff0c\u5904\u7406\u5668\u5728M\u6a21\u5f0f\u4e0b\u5904\u7406\u4e2d\u65ad\uff0c\u8fd8\u8981\u53d6\u51b3\u4e8e\u5bf9\u5e94\u7279\u6743\u6a21\u5f0f\u7684mie\uff08\u5373Machine Interrupt Enable\uff09\u5bc4\u5b58\u5668\u4e2d\u5bf9\u5e94\u7684\u4e2d\u65ad\u4f4d\u662f\u5426\u8bbe\u7f6e\uff0c\u4ee5\u53ca\u662f\u5426\u6709\u4e2d\u65ad\u4ea7\u751f\uff08mip\u5bc4\u5b58\u5668\u7684\u503c\uff09\uff0c\u5373\u5bf9\u5e94\u4f4d\u662f\u5426\u88ab\u8bbe\u7f6e\u3002RISC-V\u7684\u4e2d\u65ad\u5e76\u4e0d\u4e00\u5b9a\u975e\u8981\u5728\u673a\u5668\u6a21\u5f0f\u4e0b\u5904\u7406\uff0c\u5904\u7406\u5668\u53ef\u4ee5\u5c06\u7279\u5b9a\u4e2d\u65ad\u201c\u4ee3\u7406\u201d\u7ed9\u5176\u4ed6\u7279\u6743\u6a21\u5f0f\uff08\u5982\u76d1\u7ba1\u6a21\u5f0f\u6216\u7528\u6237\u6a21\u5f0f\uff09\u5904\u7406\uff0c\u6211\u4eec\u5c06\u57281.4\u8282\u8ba8\u8bba\u8fd9\u79cd\u4e2d\u65ad\u4ee3\u7406\u7684\u65b9\u6cd5\u548c\u76f8\u5173\u5bc4\u5b58\u5668\uff08\u5982\u88681.4\u4e2d\u7684mideleg\u548cmedeleg\uff09\u7684\u8bbe\u7f6e\u3002</p> <p>\u25cf MPIE\uff0cSPIE\uff0cUPIE\uff1a\u4e2d\u65ad\u4f7f\u80fd\u4fdd\u5b58\u4f4d\u3002\u8fd9\u4e9b\u4f4d\u7684\u4f5c\u7528\u662f\u4fdd\u7559\u6216\u6682\u5b58MIE\uff0cSIE\u6216UIE\u7684\u503c\u3002\u4f8b\u5982\uff0c\u82e5\u4e2d\u65ad\u53d1\u751f\u4e14\u5728\u673a\u5668\u6a21\u5f0f\u5904\u7406\uff0c\u4e2d\u65ad\u53d1\u751f\u65f6MIE\u7684\u503c\u5c06\u81ea\u52a8\u4fdd\u5b58\u5230MPIE\u4e2d\uff0c\u4e2d\u65ad\u8fd4\u56de\u65f6\uff0c\u5904\u7406\u5668\u5c06\u5229\u7528MPIE\u4f4d\u7684\u503c\u6062\u590dMIE\u4f4d\u3002</p> <p>\u25cf SPP\uff0cMPP\uff1a\u53d1\u751f\u4e2d\u65ad\u5f02\u5e38\u4e4b\u524d\u7684\u673a\u5668\u6a21\u5f0f\u3002MPP\u6709\u4e24\u4f4d\uff0c00\u8868\u793a\u7528\u6237\u6a21\u5f0f\uff0c01\u8868\u793a\u76d1\u7ba1\u6a21\u5f0f\uff0c11\u5219\u8868\u793a\u673a\u5668\u6a21\u5f0f\u3002\u8fd9\u662f\u56e0\u4e3a\u673a\u5668\u6a21\u5f0f\u5177\u6709\u6700\u9ad8\u7279\u6743\u7ea7\uff0c\u5f53\u4e2d\u65ad\u8fd4\u56de\u65f6\uff08\u6267\u884cmret\u6307\u4ee4\uff09\u4ece\u673a\u5668\u6a21\u5f0f\u53ef\u4ee5\u8fd4\u56de\u6240\u6709\u53ef\u80fd\u7684\u6a21\u5f0f\u3002\u7136\u800c\uff0c\u5177\u4f53\u8fd4\u56de\u5230\u54ea\u4e2a\u6a21\u5f0f\uff0c\u5c06\u5c06\u53c2\u8003MPP\u7684\u53d6\u503c\u3002\u4f8b\u5982\uff0c\u5982\u679c\u7528\u6237\u6a21\u5f0f\u53d1\u751f\u4e86\u4e2d\u65ad\uff0c\u4e14\u4e2d\u65ad\u4f8b\u7a0b\u5728\u673a\u5668\u6a21\u5f0f\u4e0b\u6267\u884c\uff0c\u5219\u8fdb\u5165\u4e2d\u65ad\u65f6mstatus\u7684MPP\u4e3a00\u3002\u5728\u4e2d\u65ad\u4f8b\u7a0b\u5b8c\u6210\u65f6\uff0cmret\u6307\u4ee4\u5c06\u8ba9\u5904\u7406\u5668\u8fd4\u56de\u5230\u7528\u6237\u6a21\u5f0f\uff08\u76ee\u6807\u6a21\u5f0f\u4fdd\u5b58\u5728MPP\u4e2d\uff09\u3002\u800cSPP\u53ea\u67091\u4f4d\uff0c\u56e0\u4e3a\u4ece\u76d1\u7ba1\u6a21\u5f0f\u8fd4\u56de\uff0c\u53ef\u80fd\u5230\u76d1\u7ba1\u6a21\u5f0f\u672c\u8eab\u6216\u8005\u7528\u6237\u6a21\u5f0f\uff08\u4e0d\u80fd\u8fd4\u56de\u673a\u5668\u6a21\u5f0f\uff09\u3002</p> <p>\u25cf FS\uff0cXS\uff0cSD\uff1aFS\u548cXS\u8fd9\u4e24\u4e2a\u4f4d\uff0c\u5206\u522b\u7528\u4e8e\u7528\u6237\u6a21\u5f0f\u4e0b\u7684\u6d6e\u70b9\u6269\u5c55\u548c\u5185\u5b58\u9875\u9762\u6807\u8bb0\u6269\u5c55\uff08\u810f\u6570\u636e\u7b49\uff09\u3002\u5f53\u5904\u7406\u5668\u5177\u5907\u6d6e\u70b9\u8fd0\u7b97\u5355\u5143\uff0c\u4ee5\u53ca\u5bf9\u5e94\u7684\u7528\u6237\u6001\u6269\u5c55\u65f6\uff0c\u8fd9\u4e9b\u4f4d\u5728mstatus\u4e2d\u5b58\u5728\u3002\u6839\u636e\u5b83\u4eec\u7684\u53d6\u503c\uff0c\u5904\u7406\u5668\u53ef\u4ee5\u5e2e\u52a9\u64cd\u4f5c\u7cfb\u7edf\u5224\u65ad\u5728\u7528\u6237\u8fdb\u7a0b\u5207\u6362\u65f6\u662f\u5426\u9700\u8981\u4fdd\u5b58\u4e0a\u4e0b\u6587\u3002\u4f8b\u5982\uff0c\u5982\u679c\u5904\u7406\u5668\u8ba4\u4e3a\u64cd\u4f5c\u7cfb\u7edf\u5728\u7528\u6237\u8fdb\u7a0b\u5207\u6362\u65f6\u9700\u8981\u4fdd\u5b58\u66f4\u591a\u7684\u4e0a\u4e0b\u6587\uff08\u5982\u6d6e\u70b9\u534f\u5904\u7406\u5668\u4e0a\u7684\u4e0a\u4e0b\u6587\uff0c\u6216\u5185\u5b58\u4e2d\u7684\u9875\u9762\uff09\uff0c\u5b83\u5c06\u628aSD\u4f4d\u8bbe\u7f6e\u4e3a1\uff0c\u5426\u5219\u4e3a0\u3002\u5f53\u7136\uff0c\u5982\u679c\u5904\u7406\u5668\u4e0d\u5177\u5907\u6d6e\u70b9\u8fd0\u7b97\u5355\u5143\u4e14\u4e0d\u652f\u6301\u7528\u6237\u6001\u6269\u5c55\uff0c\u5219SD\u4f4d\u7684\u503c\u6052\u5b9a\u4e3a0\u3002</p> <p>\u25cf MPRV\uff0cMXR\uff0cSUM\uff1a\u8fd9\u51e0\u4e2a\u4f4d\u90fd\u4e0e\u8bbf\u5b58\u63a7\u5236\u6709\u5173\uff0c\u5173\u4e8eRISC-V\u7684\u9875\u5f0f\u5185\u5b58\u7ba1\u7406\u673a\u5236\u5c06\u57281.5\u8282\u8ba8\u8bba\u3002MPRV\uff08Modify PRiVilege\uff09\u4f4d\u7528\u4e8e\u63a7\u5236load\u548cstore\u7684\u8bbf\u95ee\u6743\u9650\uff0c\u5f53MPRV=0\u65f6\uff0cload\u4e0estore\u6307\u4ee4\u6309\u7167\u5f53\u524d\u7684\u7279\u6743\u6a21\u5f0f\u8fdb\u884c\u5730\u5740\u8f6c\u6362\u4e0e\u5185\u5b58\u4fdd\u62a4\uff0c\u5f53MPRV=1\u65f6\uff0cload\u548cstore\u5c06\u6309\u7167MPP\u4e2d\u5b58\u50a8\u7684\u7279\u6743\u6a21\u5f0f\u7684\u6743\u9650\u8fdb\u884c\u5185\u5b58\u4fdd\u62a4\u68c0\u67e5\u3002\u4f8b\u5982\u53d1\u751f\u4e2d\u65ad\u524d\u5904\u7406\u5668\u5904\u4e8eU\u6a21\u5f0f\uff0c\u4e2d\u65ad\u540e\u8fdb\u5165M\u6a21\u5f0f\u5904\u7406\uff0c\u8fd9\u65f6MPP\u7684\u503c\u4e3a00\u3002\u82e5\u6b64\u65f6MPRV=1\uff0c\u5219\u5728M\u6a21\u5f0f\u7684\u4e2d\u65ad\u5904\u7406\u4f8b\u7a0b\u5bf9\u5185\u5b58\u8bbf\u95ee\u7684load\u548cstore\u4f9d\u7136\u6309\u7167U\u6a21\u5f0f\u7684\u6743\u9650\u8fdb\u884c\u3002</p> <p>MXR\uff08Make eXecutable Readable\uff09\u4f4d\u7528\u4e8e\u4fee\u6539load\u8bbf\u5b58\u7684\u6743\u9650\u3002\u5f53MXR=0\u65f6\uff0c\u53ea\u80fd\u4ece\u6807\u8bb0\u4e3a\u53ef\u8bfb\uff08\u9875\u8868\u9879\u7684R=1\uff09\u7684\u5185\u5b58\u9875\u9762\u4e2d\u8bfb\u53d6\u6570\u636e\uff1b\u5f53MXR=1\u65f6\uff0c\u53ef\u4ee5\u4ece\u6807\u8bb0\u4e3a\u53ef\u8bfb\uff08\u9875\u8868\u9879\u7684R=1\uff09\u6216\u8005\u53ef\u6267\u884c\uff08\u9875\u8868\u9879\u7684X=1\uff09\u7684\u5185\u5b58\u9875\u9762\u4e2d\u8bfb\u53d6\u6570\u636e\u3002</p> <p>SUM\uff08permit Supervisor User Memory access\uff09\u4f4d\u7528\u4e8e\u63a7\u5236S\u6a21\u5f0f\u4e0b\u7684\u865a\u62df\u5185\u5b58\u8bbf\u95ee\u7279\u6743\u68c0\u67e5\u3002\u5f53SUM=0\u65f6\uff0c\u7cfb\u7edf\u5c06\u4e0d\u5141\u8bb8S\u6a21\u5f0f\u7684\u4ee3\u7801\u5bf9U\u6a21\u5f0f\u4e0b\u5141\u8bb8\u8bbf\u95ee\u7684\u9875\u9762\u7684\u8bbf\u95ee\uff1b\u5f53SUM = 1\u65f6\uff0c\u5219\u5141\u8bb8\u8fd9\u4e9b\u8bbf\u95ee\u3002</p> <p>\u25cf TVM\uff08Trap Virtual Memory\uff09\uff0cTW\uff08Timeout Wait\uff09\uff0cTSR\uff08Trap SRET\uff09\uff1a\u8fd9\u4e09\u4e2a\u57df\u7528\u4e8eRISC-V\u7684\u865a\u62df\u5316\u652f\u6301\u3002\u867d\u7136\u865a\u62df\u5316\u548c\u64cd\u4f5c\u7cfb\u7edf\u4e4b\u95f4\u6709\u7740\u975e\u5e38\u7d27\u5bc6\u7684\u8054\u7cfb\uff0c\u4f46\u7531\u4e8e\u5c5e\u4e8e\u66f4\u9ad8\u7ea7\u7684\u8bdd\u9898\uff0c\u5728\u8fd9\u91cc\u4e2d\u4e0d\u505a\u8be6\u7ec6\u8bba\u8ff0\u3002</p> <p>\u25cf SXL\uff0cUXL\uff1a\u53ef\u4ee5\u901a\u8fc7\u8bbe\u7f6e\u8fd9\u4e24\u4e2a\u57df\uff0c\u6539\u53d8\u4f4e\u7279\u6743\u7ea7\u4e0bCSR\u7684\u957f\u5ea6\uff08\u5982\u5c06\u5b83\u4eec\u8bbe\u7f6e\u4e3a32\u4f4d\uff09\u3002\u4e3a\u4e86\u7b80\u5316\u8ba8\u8bba\uff0c\u6211\u4eec\u5ffd\u7565\u8fd9\u4e24\u4e2a\u57df\uff0c\u8ba4\u4e3aCSR\u957f\u5ea6\u4e3a\u673a\u5668\u7684\u603b\u7ebf\u5bbd\u5ea6\uff08\u5168\u90e8\u4e3a64\u4f4d\uff09\u3002</p> <p>1.3.2 \u76d1\u7ba1\u6a21\u5f0f\u4e0b\u7684CSR</p> <p>\u4e0e\u673a\u5668\u6a21\u5f0f\u7c7b\u4f3c\uff0cRISC-V\u5904\u7406\u5668\u5728\u76d1\u7ba1\u6a21\u5f0f\u4e5f\u5b9a\u4e49\u4e86\u4e00\u7ec4CSR\uff0c\u5982\u88681.4\u6240\u793a\u3002</p> <p>\u88681.4 RV64G\u76d1\u7ba1\u6a21\u5f0f\u4e0b\u7684\u91cd\u8981CSR</p> \u5bc4\u5b58\u5668 \u4f5c\u7528 sscratch Supervisor  Scratch\u3002\u4fdd\u5b58\u76d1\u7ba1\u6a21\u5f0f\u7684\u6808\u9876\u6307\u9488\uff0c\u8fd9\u4e00\u70b9\u5728\u79bb\u5f00\u673a\u5668\u6a21\u5f0f\u8fdb\u5165\u4f4e\u7279\u6743\u7ea7\u6a21\u5f0f\uff08\u5982\u7528\u6237\u6a21\u5f0f\uff09\u65f6\u975e\u5e38\u91cd\u8981\uff0c\u56e0\u4e3a\u4e00\u65e6\u5728\u4f4e\u7279\u6743\u7ea7\u6a21\u5f0f\u53d1\u751f\u5f02\u5e38\uff0c\u5c06\u53ef\u80fd\u4f1a\u56de\u5230\u76d1\u7ba1\u6a21\u5f0f\u5904\u7406\uff08\u5047\u8bbe\u5df2\u901a\u8fc7\u5f02\u5e38\u6388\u6743\uff09\uff0c\u8fd9\u65f6\u76d1\u7ba1\u6a21\u5f0f\u9700\u8981\u7528\u81ea\u5df1\u7684\u6808\u4fdd\u5b58\u7a0b\u5e8f\u6267\u884c\u7684\u8fd4\u56de\u5730\u5740\u7b49\u3002 sstatus Supervisor  Status\u3002\u4fdd\u5b58\u76d1\u7ba1\u72b6\u6001\u7684\u5bc4\u5b58\u5668\u3002 stvec Supervisor  Trap Vector\u3002\u6307\u5411\u76d1\u7ba1\u6a21\u5f0f\u4e2d\u65ad\u5904\u7406\u51fd\u6570\u7684\u5165\u53e3\u5730\u5740\u3002 sepc Supervisor  Exception PC\u3002\u6307\u5411\u53d1\u751f\u5f02\u5e38\u7684\u90a3\u6761\u6307\u4ee4\u7684\u5730\u5740\u3002 scause Supervisor  Cause\u3002\u53d1\u751f\u4e2d\u65ad\u7684\u539f\u56e0\uff0c\u5982\u679c\u53d1\u751f\u7684\u4e2d\u65ad\u662f\u5f02\u5e38\uff0c\u5176\u6700\u9ad8\u4f4d\u4e3a0\uff0c\u4f4e\u4f4d\u4e3a\u5f02\u5e38\u7f16\u53f7\uff1b\u5982\u679c\u53d1\u751f\u7684\u662f\u5176\u4ed6\u4e2d\u65ad\u5176\u6700\u9ad8\u4f4d\u4e3a1\uff0c\u4f4e\u4f4d\u4e3a\u4e2d\u65ad\u7f16\u53f7\u3002 stval Supervisor  Trap Value\u3002\u5f02\u5e38\u53d1\u751f\u65f6\uff0c\u9644\u5e26\u7684\u53c2\u6570\u503c\u3002\u4f8b\u5982\uff0c\u5f53\u7f3a\u9875\u5f02\u5e38\u53d1\u751f\u65f6\uff0cmtval\u7684\u503c\u5c31\u662f\u7a0b\u5e8f\u60f3\u8981\u8bbf\u95ee\u7684\u865a\u5730\u5740\u3002 sie Supervisor  Interrupt Enable\u3002\u4e2d\u65ad\u5f00\u542f\u5bc4\u5b58\u5668\u3002 sip Supervisor  Interrupt Pending\u3002\u4e2d\u65ad\u7b49\u5f85\u5bc4\u5b58\u5668\u3002 sideleg Supervisor  Interrupt Delegation Registers\u3002\u4e2d\u65ad\u4ee3\u7406\u5bc4\u5b58\u5668\u3002 sedeleg Supervisor  Exception Delegation Registers\u3002\u5f02\u5e38\u4ee3\u7406\u5bc4\u5b58\u5668\u3002 <p>\u8fd9\u4e9b\u5bc4\u5b58\u5668\u7684\u957f\u5ea6\u5b9e\u9645\u4e0a\u53d6\u51b3\u4e8eM\u6a21\u5f0f\u4e0bmstatus\u5bc4\u5b58\u5668\u4e2d\u7684SXL\u4f4d\u7684\u503c\u3002\u4f46\u4e3a\u4e86\u7b80\u5316\u540e\u7eed\u8ba8\u8bba\uff0c\u6211\u4eec\u4ecd\u5047\u8bbe\u5b83\u4eec\u7684\u957f\u5ea6\u4e3a64\u4f4d\u3002</p> <p>\u6bd4\u8f83\u88681.3\u548c1.4\uff0c\u6211\u4eec\u53d1\u73b0S\u6a21\u5f0f\u4e0b\u7684CSR\u548cM\u6a21\u5f0f\u4e0b\u7684CSR\u662f\u4e00\u4e00\u5bf9\u5e94\u7684\u3002\u5b9e\u9645\u4e0a\uff0c\u5b83\u4eec\u7684\u4f5c\u7528\u4e5f\u662f\u4e00\u4e00\u5bf9\u5e94\u7684\u5173\u7cfb\uff0c\u4e0d\u540c\u7684\u5730\u65b9\u5728\u4e8eS\u6a21\u5f0f\u7684\u7279\u6743\u7ea7\u522b\u6bd4M\u6a21\u5f0f\u7a0d\u4f4e\uff0c\u8fd9\u4e5f\u4f53\u73b0\u5728\u72b6\u6001\u5bc4\u5b58\u5668sstatus\u4e0a\uff0c\u5b83\u7684\u7ed3\u6784\u5982\u56fe1.5\u6240\u793a\uff1a</p> <p></p> <p>\u56fe1.5 sstatus\u5bc4\u5b58\u5668</p> <p>\u76f8\u6bd4\u4e8e\u56fe1.4\u4e2d\u7684mstatus\uff0c\u56fe1.5\u4e2d\u7684sstatus\u50cf\u662f\u4e00\u4e2a\u201c\u7f29\u6c34\u201d\u7248\u7684mstatus\u3002sstatus\u4e2d\u4e0emstatus\u76f8\u540c\u7684\u4f4d\u5177\u6709\u4e0emstatus\u6a21\u5f0f\u4e2d\u76f8\u540c\u7684\u4f5c\u7528\uff08\u89c11.3.1\u8282\u4e2d\u7684\u8ba8\u8bba\uff09\uff0c\u5982UIE\u548cSIE\u7684\u4f5c\u7528\u4ecd\u7136\u662f\u63a7\u5236\u662f\u5426\u5141\u8bb8\u5728U\u6a21\u5f0f\u6216S\u6a21\u5f0f\u5904\u7406\u4e2d\u65ad\uff0cUPIE\u548cSPIE\u4ecd\u7136\u662f\u53d1\u6325\u4fdd\u5b58UIE\u548cSIE\u4f4d\u7684\u4f5c\u7528\uff0c\u7b49\u7b49\u3002\u9664sstatus\u5916\uff0cscause\u3001stval\u3001sideleg\u4ee5\u53casedeleg\u7684\u4f5c\u7528\u4e5f\u4e0eM\u6a21\u5f0f\u4e0b\u5bf9\u5e94\u7684mcause\u3001mtval\u3001mideleg\u4ee5\u53camedeleg\u7c7b\u4f3c\uff0c\u5bf9\u5b83\u4eec\u7684\u8ba8\u8bba\u4e5f\u653e\u57281.4\u8282\u3002</p> <p>\u76f8\u5e94\u7684\uff0cRISC-V\u5904\u7406\u5668\u5728U\u6a21\u5f0f\u4e5f\u5b9a\u4e49\u4e86\u5982\u88681.3\u6216\u88681.4\u7684\u4e00\u5957CSR\u3002U\u6a21\u5f0f\u4e0bCSR\u7684\u4f5c\u7528\u4e5f\u8ddfM\u6a21\u5f0f\u6216S\u6a21\u5f0f\u7c7b\u4f3c\uff0c\u53ea\u662fU\u6a21\u5f0f\u662f\u6700\u4f4e\u7279\u6743\u7ea7\u6a21\u5f0f\uff0c\u5b83\u4eec\u7684\u4f5c\u7528\u6bd4M\u6216S\u6a21\u5f0f\u4e0b\u5bf9\u5e94\u7684CSR\u66f4\u7b80\u5355\u3002\u6211\u4eec\u7684PKE\u5b9e\u9a8c\u5e76\u672a\u7528\u5230U\u6a21\u5f0f\u4e0b\u7684CSR\uff0c\u6240\u4ee5\u6211\u4eec\u4e0d\u518d\u5bf9\u5b83\u4eec\u8fdb\u884c\u8ba8\u8bba\u3002</p> <p>1.3.3 CSR\u5bc4\u5b58\u5668\u7684\u8bfb\u5199\u6307\u4ee4</p> <p>\u5728RISC-V\u5904\u7406\u5668\u4e0a\uff0c\u5bf9\u4e8eCSR\u5bc4\u5b58\u5668\u7684\u8bfb\u5199\u4e0d\u80fd\u4f7f\u7528\u666e\u901a\u7684load\u6307\u4ee4\uff0c\u800c\u5e94\u91c7\u7528csr\u5f00\u5934\u7684\u6c47\u7f16\u6307\u4ee4\u3002\u88681.5\u5217\u51fa\u4e86\u6211\u4eec\u91c7\u7528\u7684RISC-V\u4ea4\u53c9\u6c47\u7f16\u5668\uff08riscv64-unknown-elf-as\uff09\u6240\u652f\u6301\u7684CSR\u8bfb\u5199\u6307\u4ee4\u3002</p> <p>\u88681.5 \u5e38\u7528\u7684CSR\u8bfb\u5199\u6307\u4ee4</p> \u6307\u4ee4 \u529f\u80fd csrr  rd, csr Control  and Status Register Read\uff0c\u8bfbCSR\u6307\u4ee4\u3002  \u628acsr\u5bc4\u5b58\u5668\u4e2d\u7684\u503c\u5199\u5165\u5230rd\u5bc4\u5b58\u5668\u4e2d\u3002 csrw  csr, rs1 Control  and Status Register Write\uff0c\u5199CSR\u6307\u4ee4\u3002  \u628ars1\u7684\u503c\u5199\u5230csr\u5bc4\u5b58\u5668\u4e2d\u3002 csrs  csr, rs1 Control  and Status Register Set\uff0c\u8bbe\u7f6eCSR\u6307\u4ee4\u3002  \u5bf9\u4e8ers1\u4e2d\u6bcf\u4e00\u4e2a\u4e3a1\u7684\u4f4d\uff0c\u5c06csr\u5bc4\u5b58\u5668\u4e2d\u5bf9\u5e94\u4f4d\u7f6e\u4f4d\u3002 csrc  csr, rs1 Control  and Status Register Clear\uff0c\u6e05\u9664CSR\u6307\u4ee4\u3002  \u5bf9\u4e8ers1\u4e2d\u6bcf\u4e00\u4e2a\u4e3a1\u7684\u4f4d\uff0c\u5c06csr\u5bc4\u5b58\u5668\u4e2d\u5bf9\u5e94\u4f4d\u6e05\u96f6\u3002 csrrs  rd, csr, rs1 Control  and Status Register Read and Set\uff0c\u8bfb\u540e\u7f6e\u4f4dCSR\u6307\u4ee4\u3002  \u8bb0\u63a7\u5236\u5bc4\u5b58\u5668\u4e2d\u7684\u503c\u4e3at\uff0c\u628at\u548c\u5bc4\u5b58\u5668rs1\u6309\u4f4d\u6216\u7684\u7ed3\u679c\u5199\u5165csr\u5bc4\u5b58\u5668\uff0c\u518d\u628at\u5199\u5165rd\u5bc4\u5b58\u5668\u3002 csrrc  rd, csr, rs1 Control  and Status Register Read and Clear\uff0c\u8bfb\u540e\u6e05\u9664CSR\u6307\u4ee4\u3002  \u8bb0\u63a7\u5236\u5bc4\u5b58\u5668\u4e2d\u7684\u503c\u4e3at\uff0c\u628at\u548c\u5bc4\u5b58\u5668rs1\u4e2d\u7684\u503c\u6309\u4f4d\u4e0e\u7684\u7ed3\u679c\u5199\u5165csr\u5bc4\u5b58\u5668\uff0c\u518d\u628at\u5199\u5165rd\u5bc4\u5b58\u5668\u3002 csrrw  rd, csr, rs1 Control  and Status Register Read and Write\uff0c\u8bfb\u540e\u5199CSR\u6307\u4ee4\u3002  \u8bb0\u63a7\u5236\u5bc4\u5b58\u5668\u4e2d\u7684\u503c\u4e3at\uff0c\u628a\u5bc4\u5b58\u5668rs1\u7684\u503c\u5199\u5165csr\u5bc4\u5b58\u5668\uff0c\u518d\u628at\u5199\u5165rd\u5bc4\u5b58\u5668\u3002 <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u5bf9\u4e8e\u88681.5\u4e2d\u7684csrc\u3001csrs\u3001csrrs\u3001csrrc\u4ee5\u53cacsrrw\u6307\u4ee4\uff0c\u90fd\u6709\u5176\u7acb\u5373\u6570\u7248\u672c\u3002\u4f8b\u5982csrci\u5c31\u662fcsrc\u7684\u7acb\u5373\u6570\u7248\u672c\uff0c\u7acb\u5373\u6570\u7248\u672c\u5c06rs1\u66ff\u6362\u4e3a\u7acb\u5373\u6570\uff0c\u5e76\u53d6\u7acb\u5373\u6570\u7684\u4f4e5\u4f4d\u53c2\u4e0e\u8fd0\u7b97\u3002\u7acb\u5373\u6570\u7248\u672c\u7684\u529f\u80fd\u8ddf\u975e\u7acb\u5373\u6570\u7248\u672c\u4e00\u81f4\uff0c\u4f46\u56e0\u4e3a\u6211\u4eec\u8bbe\u8ba1\u7684\u5b9e\u9a8c\uff08PKE\uff09\u8f83\u5c11\u7528\u5230\u8fd9\u7c7b\u6307\u4ee4\uff0c\u6240\u4ee5\u6211\u4eec\u5e76\u672a\u628a\u5b83\u4eec\u5217\u5165\u88681.5\u4e2d\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter1_riscv/#14","title":"1.4 \u4e2d\u65ad\u548c\u4e2d\u65ad\u5904\u7406","text":"<p>\u901a\u8fc7\u4e0a\u4e00\u8282\u7684\u8ba8\u8bba\uff0c\u6211\u4eec\u77e5\u9053\u4e2d\u65ad\u662f\u5904\u7406\u5668\u5728\u5b9e\u73b0\u7279\u6743\u7ea7\u4e4b\u95f4 \u201c\u7a7f\u8d8a\u201d\uff0c\u7279\u522b\u662f\u4ece\u4f4e\u7279\u6743\u6a21\u5f0f\u5411\u9ad8\u7279\u6743\u6a21\u5f0f\u8fdb\u884c\u63a7\u5236\u8f6c\u79fb\u7684\u91cd\u8981\u5de5\u5177\u548c\u624b\u6bb5\u3002\u7531\u4e8e\u5386\u53f2\u6216\u7ffb\u8bd1\u7684\u539f\u56e0\uff0c\u5404\u79cd\u6587\u732e\uff08\u7279\u522b\u662f\u539f\u7406\u8bfe\u7684\u6559\u6750\uff09\u4e2d\u4e0e\u4e2d\u65ad\u76f8\u5173\u7684\u540d\u8bcd\u591a\u4e14\u7e41\u6742\uff0c\u7136\u800c\u5bf9\u4e2d\u65ad\u6982\u5ff5\u7684\u7406\u89e3\u53c8\u662f\u64cd\u4f5c\u7cfb\u7edf\u4e2d\u975e\u5e38\u91cd\u8981\u7684\u4e00\u73af\u3002\u6211\u4eec\u5c06\u57281.4.1\u8282\u5bf9\u4e2d\u65ad\u7684\u6982\u5ff5\u548c\u5206\u7c7b\u8fdb\u884c\u8ba8\u8bba\uff0c\u529b\u6c42\u5398\u6e05\u4e0e\u4e2d\u65ad\u76f8\u5173\u7684\u5404\u79cd\u8868\u8ff0\uff0c\u5e2e\u52a9\u8bfb\u8005\u5f62\u6210\u5bf9\u4e2d\u65ad\u7684\u51c6\u786e\u7406\u89e3\u548c\u8868\u8fbe\u3002\u57281.4.3\u8282\uff0c\u6211\u4eec\u5c06\u8ba8\u8bbaRISC-V\u5904\u7406\u5668\u7684\u4e2d\u65ad\u5904\u7406\uff0c\u5e76\u57281.4.4\u8282\u4ecb\u7ecdRISC-V\u5e73\u53f0\u7684\u4e2d\u65ad\u4ee3\u7406\u673a\u5236\u3002</p> <p>1.4.1 \u4e2d\u65ad\u7684\u6982\u5ff5\u4e0e\u5206\u7c7b</p> <p>\u5bf9\u4e8e\u4e2d\u65ad\uff0c\u6211\u4eec\u5fc5\u987b\u8ba4\u8bc6\u5230\uff1a\u5b83\u7684\u672c\u8d28\u662f\u6253\u65ad\u5904\u7406\u5668\u4e0a\u6b63\u5728\u6267\u884c\u7684\u7a0b\u5e8f\uff0c\u8f6c\u800c\u53bb\u6267\u884c\u53e6\u4e00\u6bb5\u7a0b\u5e8f\uff0c\u5e76\u4e14\u5728\u6267\u884c\u5b8c\u8fd9\u4e00\u6bb5\u7a0b\u5e8f\u540e\uff0c\u8fd4\u56de\u53bb\u6267\u884c\u539f\u5148\u5728\u5904\u7406\u5668\u4e0a\u6267\u884c\u7684\u4e4b\u524d\u88ab\u6253\u65ad\u7684\u7a0b\u5e8f\u7684\u8fc7\u7a0b\u3002\u4f8b\u5982\uff0c\u67d0\u7a0b\u5e8f\u5728\uff08\u4f4e\u7279\u6743\u7ea7\u6a21\u5f0f\u7684\uff09\u5904\u7406\u5668\u4e0a\u6267\u884c\u65f6\uff0c\u7531\u4e8e\u67d0\u4e8b\u4ef6\u7684\u53d1\u751f\uff0c\u5904\u7406\u5668\u4e0d\u5f97\u4e0d\u8f6c\u800c\uff08\u8fdb\u5165\u66f4\u9ad8\u7279\u6743\u7ea7\uff09\u6267\u884c\u8be5\u4e8b\u4ef6\u7684\u5904\u7406\u7a0b\u5e8f\uff0c\u5e76\u5728\u6267\u884c\u5b8c\u5904\u7406\u7a0b\u5e8f\u540e\u8fd4\u56de\u4e4b\u524d\u7684\uff08\u4f4e\u7279\u6743\u7ea7\u6a21\u5f0f\uff09\u7a0b\u5e8f\u7ee7\u7eed\u6267\u884c\u3002</p> <p>\u5728RISC-V\u5904\u7406\u5668\u4e0a\uff0c\u4e2d\u65ad\u5e76\u4e0d\u4e00\u5b9a\u610f\u5473\u7740\u7279\u6743\u7ea7\u7684\u53d8\u8fc1\uff08RISC-V\u652f\u6301\u5e73\u7ea7\u4e2d\u65ad\uff0c\u4f8b\u5982\u7b80\u5355\u5d4c\u5165\u5f0f\u8bbe\u5907\u4e0a\u4eceM\u6a21\u5f0f\u5230M\u6a21\u5f0f\u7684\u4e2d\u65ad\uff09\uff0c\u4f46\u662f\u5bf9\u4e8e\u4f20\u7edf\u610f\u4e49\u7684\u64cd\u4f5c\u7cfb\u7edf\u800c\u8a00\uff0c\u7531\u4e8e\u591a\u4e2a\u7279\u6743\u7ea7\uff08\u4f8b\u5982\u6211\u4eec\u8003\u8651\u7684M+S+U\u6a21\u5f0f\u7684RISC-V\u673a\u5668\uff09\u7684\u5b58\u5728\uff0c\u4e2d\u65ad\u5904\u7406\u4f8b\u7a0b\u5f80\u5f80\u5728\u6bd4\u7528\u6237\u6a21\u5f0f\uff08\u4e5f\u5c31\u662f\u88ab\u4e2d\u65ad\u7684\u7528\u6237\u7a0b\u5e8f\u6240\u8fd0\u884c\u7684\u7279\u6743\u6a21\u5f0f\uff09\u66f4\u9ad8\u7ea7\u522b\u7684\u7279\u6743\u6a21\u5f0f\u4e2d\uff08\u5982\u76d1\u7ba1\u6a21\u5f0f\u6216\u673a\u5668\u6a21\u5f0f\uff09\u6267\u884c\u3002\u5bf9\u64cd\u4f5c\u7cfb\u7edf\u800c\u8a00\uff0c\u8fd9\u6837\u505a\u4e5f\u53ef\u4ee5\u66f4\u597d\u5730\u5bf9\u64cd\u4f5c\u7cfb\u7edf\u672c\u8eab\uff0c\u4ee5\u53ca\u8ba1\u7b97\u673a\u7684\u5185\u5b58\u8d44\u6e90\u4ee5\u53caI/O\u8d44\u6e90\u8fdb\u884c\u4fdd\u62a4\u3002</p> <p>\u5b9e\u9645\u7cfb\u7edf\u4e2d\u5bfc\u81f4\u4e2d\u65ad\u53d1\u751f\u7684\u4e8b\u4ef6\u5f80\u5f80\u662f\u6bd4\u8f83\u590d\u6742\u7684\uff0c\u5b83\u4eec\u7684\u6765\u6e90\u3001\u5904\u7406\u65f6\u673a\u548c\u8fd4\u56de\u65b9\u5f0f\u90fd\u4e0d\u5c3d\u76f8\u540c\u3002\u4e3a\u4e86\u4fbf\u4e8e\u8bfb\u8005\u5bf9\u4e2d\u65ad\u7684\u7406\u89e3\u4ee5\u53ca\u8868\u8fbe\u7684\u51c6\u786e\u6027\uff0c\u6211\u4eec\u501f\u9274\u53c2\u8003\u6587\u732eSiFive Interrupt\u7684\u4e2d\u65ad\u5206\u7c7b\u6807\u51c6\uff0c\u5c06\u7cfb\u7edf\u4e2d\u53d1\u751f\u7684\u53ef\u80fd\u4e2d\u65ad\u5f53\u524d\u6267\u884c\u7a0b\u5e8f\u7684\u4e8b\u4ef6\u5206\u4e3a3\u7c7b\uff1a</p> <p>\u25cf Exception\uff08\u5f02\u5e38\uff09\uff1a\u8fd9\u7c7b\u4e2d\u65ad\u662f\u5904\u7406\u5668\u5728\u6267\u884c\u67d0\u6761\u6307\u4ee4\u65f6\uff0c\u7531\u4e8e\u6761\u4ef6\u4e0d\u6ee1\u8db3\u800c\u4ea7\u751f\u7684\u3002\u5178\u578b\u7684\u5f02\u5e38\u6709\u7f3a\u9875\u3001\u6267\u884c\u5f53\u524d\u7279\u6743\u7ea7\u4e0d\u652f\u6301\u7684\u6307\u4ee4\u7b49\u3002\u76f8\u5bf9\u4e8e\u6b63\u5728\u6267\u884c\u7684\u7a0b\u5e8f\u800c\u8a00\uff0cexception\u662f\u540c\u6b65\uff08synchronous\uff09\u53d1\u751f\u7684\u3002exception\u4ea7\u751f\u7684\u65f6\u673a\u662f\u6307\u4ee4\u6267\u884c\u7684\u8fc7\u7a0b\u4e2d\uff08\u5373\u5904\u7406\u5668\u6d41\u6c34\u7ebf\u7684\u6267\u884c\u9636\u6bb5\uff09\uff0c\u5728exception\u5904\u7406\u5b8c\u6bd5\u540e\uff0c\u7cfb\u7edf\u5c06\u8fd4\u56de\u53d1\u751fexception\u7684\u90a3\u6761\u6307\u4ee4\u91cd\u65b0\u6267\u884c\u3002</p> <p>\u25cf Trap\uff08\u5373\u6211\u4eec\u901a\u5e38\u7406\u89e3\u7684\u201c\u7cfb\u7edf\u8c03\u7528\u201d\u6216\u8005\u201c\u8f6f\u4ef6\u4e2d\u65ad\u201d\uff0c\u4f46\u662f\u6211\u4eec\u4e0d\u5efa\u8bae\u628a\u5b83\u7ffb\u8bd1\u4e3a\u201c\u9677\u9631\u201d\uff01\u56e0\u4e3a\u201c\u9677\u9631\u201d\u8fd9\u4e2a\u8bcd\u5728\u4e2d\u6587\u8bed\u5883\u7684\u542b\u4e49\u751a\u81f3\u548c\u201c\u4e2d\u65ad\u201d\u4e00\u6837\u5bbd\u6cdb\u3002RISC-V\u4e2dtrap\u7b49\u540c\u4e8esyscall\uff0c\u4e3a\u4e86\u4e0e\u5176\u4ed6\u7c7b\u578b\u7684\u4e2d\u65ad\u8fdb\u884c\u533a\u5206\uff0c\u6211\u4eec\u66f4\u63a8\u8350\u4f7f\u7528syscall\u6765\u6307\u4ee3\u8fd9\u7c7b\u4e2d\u65ad\uff09\uff1a\u8fd9\u7c7b\u4e2d\u65ad\u662f\u5f53\u524d\u6267\u884c\u7684\u7a0b\u5e8f\u4e3b\u52a8\u53d1\u51fa\u7684ecall\u6307\u4ee4\uff08\u7c7b\u4f3c8086\u4e2d\u7684int\u6307\u4ee4\uff09\u5bfc\u81f4\u7684\u3002\u5178\u578b\u7684trap\u6709\u5c4f\u5e55\u8f93\u51fa\uff08printf\uff09\u3001\u78c1\u76d8\u6587\u4ef6\u8bfb\u5199\uff08read/write\uff09\u7b49\uff0c\u8fd9\u4e9b\u9ad8\u7ea7\u8bed\u8a00\u51fd\u6570\u8c03\u7528\u901a\u8fc7\u7cfb\u7edf\u51fd\u6570\u5e93\uff08libc\uff09\u7684\u8f6c\u6362\uff0c\u5728RISC-V\u5e73\u53f0\u90fd\u4f1a\u8f6c\u6362\u6210ecall\u6307\u4ee4\u3002\u4e0eexception\u7c7b\u4f3c\uff0c\u76f8\u5bf9\u4e8e\u6b63\u5728\u6267\u884c\u7684\u7a0b\u5e8f\u800c\u8a00\uff0csyscall\u4e5f\u662f\u540c\u6b65\uff08synchronous\uff09\u53d1\u751f\u7684\u3002\u4f46\u4e0eexception\u4e0d\u540c\u7684\u5730\u65b9\u5728\u4e8e\uff0csyscall\u5728\u5904\u7406\u5b8c\u6210\u540e\u8fd4\u56de\u7684\u662f\u4e0b\u4e00\u6761\u6307\u4ee4\u3002</p> <p>\u25cf Interrupt\uff08\u6211\u4eec\u4e0d\u5efa\u8bae\u5bf9\u5b83\u8fdb\u884c\u4efb\u4f55\u5f62\u5f0f\u7684\u7ffb\u8bd1\uff01\u56e0\u4e3a\u201c\u4e2d\u65ad\u201d\u5728\u4e2d\u6587\u8bed\u5883\u4e2d\u7684\u542b\u4e49\u8fc7\u4e8e\u5bbd\u6cdb\uff09\uff1a\u8fd9\u7c7b\u4e2d\u65ad\u4e00\u822c\u662f\u7531\u5916\u90e8\u8bbe\u5907\u4ea7\u751f\u7684\u4e8b\u4ef6\u800c\u5bfc\u81f4\u7684\u3002\u5728Intel\u7684x86\u7cfb\u5217\u5904\u7406\u5668\u4e2d\uff0cinterrupt\u4e5f\u88ab\u79f0\u4e3aIRQ\uff08Interrupt ReQuest\uff0c\u5b9e\u9645\u4e0a\uff0c\u6211\u4eec\u66f4\u63a8\u8350\u4f7f\u7528IRQ\u6765\u6307\u4ee3\u5916\u90e8\u4e2d\u65ad\uff0c\u7528Interrupt\u5f80\u5f80\u5bfc\u81f4\u6307\u4ee3\u8303\u56f4\u592a\u5bbd\u6cdb\u7684\u95ee\u9898\uff09\u3002\u5178\u578b\u7684IRQ\u6709\uff1a\u53ef\u7f16\u7a0b\u65f6\u949f\u8ba1\u65f6\u5668\uff08PIT\uff09\u6240\u4ea7\u751f\u7684timer\u4e8b\u4ef6\u3001DMA\u63a7\u5236\u5668\u53d1\u51fa\u7684I/O\u5b8c\u6210\u4e8b\u4ef6\u3001\u58f0\u5361\u53d1\u51fa\u7684\u7f13\u5b58\u7a7a\u95f4\u7528\u5b8c\u4e8b\u4ef6\u7b49\u3002\u76f8\u5bf9\u4e8e\u6b63\u5728\u6267\u884c\u7684\u7a0b\u5e8f\u800c\u8a00\uff0cinterrupt\u662f\u5f02\u6b65\uff08asynchronous\uff09\u53d1\u751f\u7684\u3002\u53e6\u5916\uff0c\u5bf9\u4e8e\u5904\u7406\u5668\u6d41\u6c34\u7ebf\u800c\u8a00\uff0cinterrupt\u7684\u5904\u7406\u65f6\u673a\u662f\u6307\u4ee4\u7684\u95f4\u9699\u3002\u4e0d\u540c\u4e8eexception\u4f46\u4e0etrap\u7c7b\u4f3c\uff0cinterrupt\u5728\u5904\u7406\u5b8c\u6210\u540e\u8fd4\u56de\u7684\u662f\u4e0b\u4e00\u6761\u6307\u4ee4\u3002</p> <p>\u88681.6 \u4e2d\u65ad\u7684\u5206\u7c7b</p> \u4e2d\u65ad\u7c7b\u578b \u4ea7\u751f\u65f6\u673a \u5904\u7406\u65f6\u673a \u8fd4\u56de\u5730\u5740 Exception \u540c\u6b65\uff08\u4e8e\u5f53\u524d\u7a0b\u5e8f\uff09 \u6307\u4ee4\u6267\u884c\u9636\u6bb5 \u53d1\u751f\u5f02\u5e38\u7684\u6307\u4ee4 Trap (syscall) \u540c\u6b65\uff08\u4e8e\u5f53\u524d\u7a0b\u5e8f\uff09 - \u4e0b\u4e00\u6761\u6307\u4ee4 Interrupt (IRQ) \u5f02\u6b65\uff08\u4e8e\u5f53\u524d\u7a0b\u5e8f\uff09 \u6307\u4ee4\u6267\u884c\u95f4\u9699 \u4e0b\u4e00\u6761\u6307\u4ee4 <p>\u88681.6\u5bf9\u8fd93\u7c7b\u4e2d\u65ad\u8fdb\u884c\u4e86\u5f52\u7eb3\u548c\u6bd4\u8f83\u3002\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u4e0d\u540c\u6587\u732e\uff08\u7279\u522b\u662f\u4e2d\u6587\u6587\u732e\uff09\u5bf9\u4e8e\u67d0\u4e2a\u7c7b\u578b\u7684\u4e2d\u65ad\u53ef\u80fd\u7528\u4e86\u4e0d\u540c\u7684\u540d\u5b57\uff0c\u4f8b\u5982trap\u5728\u5f88\u591a\u6587\u732e\u548c\u53c2\u8003\u4e66\u4e2d\u53c8\u88ab\u79f0\u4e3a\u201c\u9677\u9631\u201d\u3001\u201c\u9677\u5165\u201d\u3001\u201c\u8f6f\u4ef6\u4e2d\u65ad\u201d\u6216\u201c\u7cfb\u7edf\u8c03\u7528\u201d\u7b49\u7b49\u3002</p> <p>\u9762\u5bf9\u7eb7\u7e41\u590d\u6742\u7684\u672f\u8bed\uff0c\u6211\u4eec\u7ed9\u8bfb\u8005\u7684\u5efa\u8bae\u662f\uff1a\u63cf\u8ff0\u67d0\u4e2a\u786e\u5b9a\u7684\u4e2d\u65ad\u65f6\uff0c\u5c3d\u91cf\u7528\u82f1\u6587\u5355\u8bcd\u6765\u8868\u8fbe\uff08\u4e0d\u8981\u7ffb\u8bd1\u6210\u4e2d\u6587\uff0c\u7279\u522b\u662f\u907f\u514d\u4f7f\u7528\u201c\u4e2d\u65ad\u201d\u6216\u201c\u9677\u5165\u201d\u8fd9\u7c7b\u542b\u4e49\u592a\u5bbd\u6cdb\u7684\u540d\u8bcd\uff09\u3002\u5b9e\u9645\u4e0a\uff0c\u5f53\u9700\u8981\u63cf\u8ff0\u67d0\u4e2a\u65b0\u7c7b\u578b\u7684\u4e2d\u65ad\u65f6\uff0c\u53ef\u4ee5\u8bd5\u7740\u6839\u636e\u8fd9\u4e2a\u4e2d\u65ad\u7684\u4ea7\u751f\u3001\u5904\u7406\u7684\u65f6\u673a\uff0c\u4ee5\u53ca\u8fd4\u56de\u7684\u4f4d\u7f6e\u6765\u5bf9\u5b83\u8fdb\u884c\u5206\u7c7b\u548c\u5f52\u7eb3\uff0c\u5e76\u7ffb\u8bd1\u6210\u5b83\u5bf9\u5e94\u7684\u7c7b\u540d\u3002\u8fd9\u6837\uff0c\u542c\u4f17\u4e00\u542c\u5c31\u77e5\u9053\u8be5\u4e2d\u65ad\u7684\u7c7b\u578b\u4ee5\u53ca\u5bf9\u5e94\u7684\u5904\u7406\u65b9\u5f0f\u4e86\uff0c\u907f\u514d\u4e86\u5f88\u591a\u4e0d\u5fc5\u8981\u3001\u5570\u55e6\u4e14\u542b\u7cca\u7684\u89e3\u91ca\u3002</p> <p>1.4.2\u4e2d\u65ad\u5411\u91cf\u8868</p> <p>\u7cfb\u7edf\u53d1\u751f\u4e2d\u65ad\uff08\u6211\u4eec\u7528\u4e2d\u6587\u7684\u201c\u4e2d\u65ad\u201d\u8fd9\u4e2a\u540d\u8bcd\u6765\u6307\u4ee3\u5e7f\u4e49\u7684\u4e2d\u65ad\uff0c\u5e76\u975e\u4ee5\u4e0a\u7684interrupt\uff09\u65f6\u6267\u884c\u7684\u8fd9\u6bb5\u7a0b\u5e8f\uff0c\u5f80\u5f80\u88ab\u79f0\u4e3a\u4e2d\u65ad\u4f8b\u7a0b\uff08interrupt routine\uff09\u3002\u56e0\u4e3a\u4e8b\u4ef6\u7684\u591a\u6837\u6027\uff0c\u7cfb\u7edf\u53ef\u80fd\u6709\u591a\u4e2a\u8fd9\u6837\u7684\u4e2d\u65ad\u4f8b\u7a0b\uff0c\u901a\u5e38\u7684\u505a\u6cd5\u662f\u628a\u8fd9\u4e9b\u4f8b\u7a0b\u7684\u5165\u53e3\u653e\u5728\u4e00\u5f20\u8868\u4e2d\uff0c\u800c\u8fd9\u5f20\u8868\u4e00\u822c\u79f0\u4e3a\u4e2d\u65ad\u5411\u91cf\u8868\uff08interrupt table\uff09\u3002RV64G\u5904\u7406\u5668\u5728\u53d1\u751f\u4e2d\u65ad\u540e\uff0c\u4f1a\u5c06\u53d1\u751f\u7684\u4e2d\u65ad\u7c7b\u578b\u3001\u7f16\u53f7\u81ea\u52a8\u8bb0\u5f55\uff08\u786c\u4ef6\u5b8c\u6210\uff09\u5230\u76ee\u6807\u6a21\u5f0f\u7684CSR\u4e2d\u3002\u5047\u8bbe\u53d1\u751f\u4e2d\u65ad\u7684\u76ee\u6807\u6a21\u5f0f\u4e3aM\u6a21\u5f0f\uff0c\u5219\u4e2d\u65ad\u7684\u8fd9\u4e9b\u4fe1\u606f\u4f1a\u8bb0\u5f55\u5230mcause\u5bc4\u5b58\u5668\u3002\u88681.7\u5217\u51fa\u4e86mcause\u7684\u53ef\u80fd\u53d6\u503c\u4ee5\u53ca\u5bf9\u5e94\u7684\u4e2d\u65ad\u4fe1\u606f\uff08\u4e3a\u7b80\u5316\u8ba8\u8bba\uff0c\u6211\u4eec\u53ea\u8003\u8651\u4e3a\u5904\u7406\u5668\u914d\u7f6e\u672c\u5730\u4e2d\u65ad\u63a7\u5236\u5668Core Local Interrupt\u5373CLINT\u7684\u60c5\u51b5SiFive Interrupt\uff09\u3002</p> <p>\u88681.7 mcause\u5bc4\u5b58\u5668\u7684\u53d6\u503c\uff08\u7531Interrupt\u53caCode\u5b57\u6bb5\u62fc\u63a5\uff09\u53ca\u503c\u7684\u542b\u4e49</p> Interrupt Code \u4e2d\u65ad\u63cf\u8ff0 1 0 User  software interrupt 1 1 Superior  software interrupt 1 2 \u4fdd\u7559 1 3 Machine  software interrupt 1 4 User  timer interrupt 1 5 Supervisor  timer interrupt 1 6 \u4fdd\u7559 1 7 Machine  timer interrupt 1 8 User  external interrupt 1 9 Supervisor  external interrupt 1 10 \u4fdd\u7559 1 11 Machine  external interrupt 1 &gt;=12  &amp;&amp; &lt;16 \u4fdd\u7559 1 &gt;=16 Implementation  defined local interrupts 0 0 Instruction  address misaligned 0 1 Instruction  access fault 0 2 Illegal  Instruction 0 3 Breakpoint 0 4 Load address  misaligned 0 5 Load  access fault 0 6 Store/AMO  address misaligned 0 7 Store/AMO  access fault 0 8 Environment  call from U-mode 0 9 Environment  call from S-mode 0 10 \u4fdd\u7559 0 11 Environment  call from M-mode 0 12 Instruction  page fault 0 13 Load  page fault 0 14 \u4fdd\u7559 0 15 Store/AMO  page fault 0 &gt;=16 \u4fdd\u7559 <p>\u4ece\u88681.7\u4e2d\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230\uff1a\u9996\u5148\uff0c\u5f53\u53d1\u751f\u7684\u4e2d\u65ad\u7c7b\u578b\u662finterrupt\u65f6\uff0cmcause\u7684\u9ad8\u4f4d\u4e3a1\uff0c\u800c\u5982\u679c\u53d1\u751f\u7684\u4e2d\u65ad\u7c7b\u578b\u662fexception\uff08\u6216trap\uff09\u65f6\uff0cmcause\u7684\u9ad8\u4f4d\u4e3a0\uff1b\u5176\u6b21\uff0c\u5bf9\u4e8einterrupt\u800c\u8a00\uff0c\u4e00\u4e2a\u7279\u6743\u6a21\u5f0f\u53ea\u6709\u4e00\u4e9b\u53ef\u80fd\u7684\u53d6\u503c\u3002\u4f8b\u5982\uff0c\u5bf9\u4e8eM\u6a21\u5f0f\uff0cinterrupt\u7684code\u7684\u53ef\u80fd\uff08\u5178\u578b\uff09\u53d6\u503c\u548c\u542b\u4e49\u4e3a\uff1a</p> <p>\u25cf 3\uff1aMachine software interrupt\u3002\u8fd9\u79cd\u7c7b\u578b\u7684\u4e2d\u65ad\u662f\u7531\u8f6f\u4ef6\u4ea7\u751f\u7684\uff0c\u4f46\u662f\u5374\u4e0d\u662fexception\u6216\u8005trap\uff01\u5b9e\u9645\u4e0a\uff0c\u8fd9\u7c7binterrupt\u4e3b\u8981\u662f\u6307\u5728\u591a\u6838\uff08\u5b9e\u9645\u4e0a\uff0cRISC-V\u4e2d\u7684\u786c\u4ef6\u5904\u7406\u5355\u5143\u79f0\u4f5c\u786c\u4ef6\u7ebf\u7a0b\uff0cHardware Threads\u7b80\u79f0Harts\uff0c\u4e00\u822c\u60c5\u51b5\u4e0b\u5b83\u7b49\u540c\u4e8e\u201c\u5904\u7406\u5668\u6838\u201d\u7684\u6982\u5ff5\uff09\u73af\u5883\u4e0b\u7684\u5904\u7406\u671f\u95f4\u4e2d\u65ad\u3002\u4e3a\u4e86\u5b9e\u73b0\u8fd9\u7c7b\u4e2d\u65ad\uff0cRISC-V\u662f\u901a\u8fc7\u8ba9\u4e00\u4e2a\u6838\u76f4\u63a5\u5199\u53e6\u4e00\u4e2a\u6838\u7684\u672c\u5730\u4e2d\u65ad\u63a7\u5236\u5668\u6765\u5b9e\u73b0\u7684\u3002\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u8fd9\u91cc\u7684software interrupt\u5e76\u4e0d\u662f\u6211\u4eec\u901a\u5e38\u7406\u89e3\u7684\u201c\u8f6f\u4ef6\u4e2d\u65ad\u201d\uff0c\u66f4\u4e0d\u662ftrap\uff08\u6216syscall\uff09\uff01</p> <p>\u25cf 7\uff1aMachine timer interrupt\u3002\u5373\u65f6\u949f\u4e2d\u65ad\uff0c\u5b83\u4e5f\u662f\u7531\u5904\u7406\u5668\u6838\u6240\u5e26\u7684\u672c\u5730\u4e2d\u65ad\u63a7\u5236\u5668\u4ea7\u751f\u7684\u3002</p> <p>\u25cf 11\uff1aMachine external interrupt\u3002\u5373\u9664\u4e86\u65f6\u949f\u4e2d\u65ad\u4e4b\u5916\u7684\u5176\u4ed6\u4e2d\u65ad\uff0c\u4f8b\u5982\u952e\u76d8\u3001\u5176\u4ed6\u5916\u8bbe\u7b49\u3002</p> <p>\u25cf &gt;=16\uff1aImplementation defined local interrupts\u3002\u4e0e\u5b9e\u73b0\u76f8\u5173\u7684\u5176\u4ed6\u4e2d\u65ad\u6e90\uff0c\u5bf9\u4e8eRV64G\u6307\u4ee4\u96c6\u800c\u8a00\uff0c\u8fd9\u4e2a\u6570\u5b57\u53ef\u4ee5\u523048\uff08RV32G\u662f16\uff09\u3002\u6570\u5b57\u8d8a\u5927\uff0c\u610f\u5473\u7740\u53ef\u4ee5\u63a5\u66f4\u591a\u7684\u5916\u90e8\u4e2d\u65ad\u6e90\u3002</p> <p>\u6700\u540e\uff0c\u5bf9\u4e8e\u975einterrupt\uff08\u5373\u88681.7\u7684Interrupt=0\uff09\u60c5\u51b5\uff0cCode=8\u65f6\u8868\u793a\u53d1\u751f\u7684\u662f\u4e00\u4e2a\u6765\u81eaU\u6a21\u5f0f\u7684trap\uff08Environment call from U-mode\uff09\uff1bCode=9\u65f6\u8868\u793a\u53d1\u751f\u7684\u662f\u4e00\u4e2a\u6765\u81eaS\u6a21\u5f0f\u7684trap\uff08Environment call from S-mode\uff09\uff1b\u800cCode=11\u65f6\u8868\u793a\u53d1\u751f\u7684\u662f\u4e00\u4e2a\u6765\u81eaM\u6a21\u5f0f\u7684trap\uff08Environment call from M-mode\uff09\u3002\u9700\u8981\u518d\u6b21\u5f3a\u8c03\u7684\u662f\uff0c\u8fd9\u91cc\u7684trap\u5c31\u662f\u6211\u4eec\u5e73\u65f6\u6240\u8bf4\u7684\u201c\u7cfb\u7edf\u8c03\u7528\u201d\u6216\u8005\u201csyscall\u201d\uff0c\u57288086\u73af\u5883\u4e0b\u5b83\u4eec\u7531int\u6307\u4ee4\u4ea7\u751f\uff0c\u800c\u5728RISC-V\u73af\u5883\u4e0b\u5b83\u4eec\u7531ecall\u6307\u4ee4\u4ea7\u751f\u3002</p> <p>\u9664\u4e86\u8fd9\u51e0\u4e2a\u53d6\u503c\u5916\uff0c\u88681.7\u4e2d\u5176\u4ed6\u7684Interrupt=0\u7684\u60c5\u51b5\u5c31\u90fd\u662fexception\u3002\u4f8b\u5982\uff0c\u5f53Code=13\uff08Load page fault\uff09\u5c31\u662f\u5e38\u89c1\u7684\u6240\u8c13\u201c\u7f3a\u9875\u4e2d\u65ad\uff08\u5b9e\u9645\u4e0a\u5e94\u8be5\u53eb\u5b83\u7f3a\u9875exception\uff09\u201d\u4e86\uff1bCode=15\uff08Store/AMO page fault\uff09\u5c31\u662f\u8bbf\u5b58\uff08Store\uff09\u6216\u539f\u5b50\u64cd\u4f5c\uff08AMO\uff09\u5f02\u5e38\uff0c\u8fd9\u4e9b\u5f02\u5e38\u5728\u6211\u4eec\u7684PKE\u5b9e\u9a8c\u4e2d\u90fd\u80fd\u63a5\u89e6\u5230\u3002</p> <p>\u4ecd\u7136\u4ee5\u673a\u5668\u6a21\u5f0f\u4e3a\u4f8b\uff0c\u5728RISC-V\u5904\u7406\u5668\u4e2d\uff0c\u4e2d\u65ad\u5411\u91cf\u8868\u7684\u7ec4\u7ec7\u548c\u5b9e\u73b0\u6709\u4e24\u79cd\u65b9\u5f0f\uff0c\u4e00\u79cd\u662f\u76f4\u63a5\u6a21\u5f0f\uff08Direct Mode\uff09\uff0c\u53e6\u4e00\u79cd\u662f\u5411\u91cf\u6a21\u5f0f\uff08Vectored Mode\uff09\u3002\u524d\u4e00\u79cd\u6a21\u5f0f\u5c06CSR\u4e2d\u7684mtvec\u6307\u5411\u6240\u6709\u4e2d\u65ad\uff08\u5305\u62ec\u88681.7\u4e2d\u6240\u6709\u7684interruption\u3001trap\u548cexception\uff09\u7684\u603b\u5165\u53e3\u51fd\u6570\uff0c\u7136\u540e\u7531\u8be5\u51fd\u6570\u6839\u636emcause\u4e2d\u5177\u4f53\u7684\u503c\u8c03\u7528\u5bf9\u5e94\u7684\u4e2d\u65ad\u4f8b\u7a0b\u3002\u5411\u91cf\u6a21\u5f0f\u5219\u4e25\u683c\u6309\u7167\u88681.7\u6240\u793a\u7684\u987a\u5e8f\uff0c\u5c06\u6240\u6709\u4e2d\u65ad\u4f8b\u7a0b\u7684\u5165\u53e3\u5730\u5740\u7ec4\u7ec7\u6210\u4e00\u4e2a\u5411\u91cf\uff08\u7c7b\u4f3c8086\u4e2d\u7684\u4e2d\u65ad\u5411\u91cf\u8868\uff09\uff0c\u5e76\u5c06mtvec\u6307\u5411\u8be5\u8868\u7684\u9996\u5730\u5740\u3002\u5f53\u53d1\u751f\u4e2d\u65ad\u65f6\uff0c\u6839\u636emcause\u4e2d\u7684\u503c\u8ba1\u7b97\u5411\u91cf\u4e2d\u7684\u504f\u79fb\u5e76\u8c03\u7528\u5bf9\u5e94\u4f8b\u7a0b\u3002RISC-V\u662f\u6839\u636emtvec\u7684\u6700\u4f4e\u4f4d\uff08mtvec.mode\uff09\u6765\u5224\u65ad\u7cfb\u7edf\u5177\u4f53\u91c7\u7528\u4e86\u54ea\u79cd\u6a21\u5f0f\uff1a\u5982\u679c\u91c7\u7528\u4e86\u76f4\u63a5\u6a21\u5f0f\uff0c\u5176\u6700\u4f4e\u4f4d\u4e3a0\uff1b\u5982\u679c\u91c7\u7528\u4e86\u5411\u91cf\u6a21\u5f0f\uff0c\u5219\u5176\u6700\u4f4e\u4f4d\u4e3a1\u3002\u9700\u8981\u6307\u51fa\u7684\u662f\uff0c\u6211\u4eec\u7684PKE\u5728\u4e2d\u65ad\u5411\u91cf\u4e0a\u4f7f\u7528\u7684\u662f\u76f4\u63a5\u6a21\u5f0f\u3002</p> <p>1.4.3\u4e2d\u65ad\u5904\u7406\u4f8b\u7a0b</p> <p>\u5f53\u53d1\u751f\u4e00\u4e2a\u4e2d\u65ad\uff0c\u5047\u8bbe\u5176\u76ee\u6807\u6a21\u5f0f\uff08\u5373\u6267\u884c\u4e2d\u65ad\u4f8b\u7a0b\u7684\u6a21\u5f0f\uff09\u4e3a\u673a\u5668\u6a21\u5f0f\uff0cRISC-V\u5904\u7406\u5668\u786c\u4ef6\u5c06\u6267\u884c\u4ee5\u4e0b\u52a8\u4f5c\uff1a</p> <p>1\uff09\u4fdd\u5b58\uff08\u8fdb\u5165\u4e2d\u65ad\u5904\u7406\u5386\u7a0b\u4e4b\u524d\u7684\uff09pc\uff08\u5982\u679c\u662ftrap\u6216\u8005interrupt\uff0c\u5219\u4fdd\u5b58\u4e0b\u4e00\u6761\u6307\u4ee4\u7684pc\uff09\u5230mepc\u5bc4\u5b58\u5668\uff1b</p> <p>2\uff09\u5c06\uff08\u8fdb\u5165\u4e2d\u65ad\u5904\u7406\u5386\u7a0b\u4e4b\u524d\u7684\uff09\u7279\u6743\u7ea7\u4fdd\u5b58\u5230mstatus\u5bc4\u5b58\u5668\u7684MPP\u5b57\u6bb5\uff1b</p> <p>3\uff09\u5c06mstatus\u5bc4\u5b58\u5668\u4e2d\u7684MIE\u5b57\u6bb5\u4fdd\u5b58\u5230\uff08\u5b83\u81ea\u5df1\u7684\uff09MPIE\u5b57\u6bb5\uff1b</p> <p>4\uff09\u8bbe\u7f6emcause\uff0c\u5176\u503c\u4e0e\u88681.6\u4e2d\u7684Interrupt\u548cException code\u5bf9\u5e94\uff1b</p> <p>5\uff09\u5c06pc\u8bbe\u7f6e\u4e3a\u4e2d\u65ad\u4f8b\u7a0b\u7684\u5165\u53e3\uff0c\u5982\u679c\u4e3a\u76f4\u63a5\u6a21\u5f0f\u5219\u8bbe\u7f6e\u4e3amtvec\u7684\u503c\uff1b</p> <p>6\uff09\u5c06mstatus\u5bc4\u5b58\u5668\u7684MIE\u5b57\u6bb5\u6e05\u96f6\uff0c\u8f6c\u5165\u673a\u5668\u6a21\u5f0f\u3002</p> <p>\u5728\u6211\u4eec\u7684PKE\u5b9e\u9a8c\u4e2d\uff0c\u7cfb\u7edf\u7684\u4e2d\u65ad\u5b9e\u9645\u4e0a\u662f\u4ee3\u7406\u7ed9\u76d1\u7ba1\u6a21\u5f0f\uff08S\u6a21\u5f0f\uff09\u5904\u7406\u7684\uff0c\u5728\u53d1\u751f\u4e2d\u65ad\u65f6\u5904\u7406\u5668\u786c\u4ef6\u7684\u6d41\u7a0b\u4e0e\u4ee5\u4e0a\u7684\u673a\u5668\u6a21\u5f0f\u7c7b\u4f3c\uff0c\u53ea\u662fmepc\u3001mstatus\u3001mcause\u4ee5\u53camtvec\u6362\u6210\u4e86sepc\u3001sstatus\u3001scause\u4ee5\u53castvec\u3002</p> <p>\u5178\u578b\u7684\u4e2d\u65ad\u5904\u7406\u6d41\u7a0b\u5982\u4ee5\u4e0b\u4ee3\u7801\uff1a</p> <pre><code>.align 6\n.global handler_interrupt\nhandler_interrupt:\naddi sp, sp, -32*REGBYTES\nSTORE x1, 1* REGBYTES(sp)\nSTORE x2, 2* REGBYTES(sp)\n...\nSTORE x31, 31* REGBYTES(sp)\n//call C code handler\ncall software_handler\n//finished interrupt handling, ready to return\nLOAD x1, 1* REGBYTES(sp)\nLOAD x2, 2* REGBYTES(sp)\n...\nLOAD x31, 31* REGBYTES(sp)\naddi sp, sp, 32*REGBYTES\nmret\n</code></pre> <p>\u5728\u4ee5\u4e0a\u7684\u4ee3\u7801\u4e2d\uff0c\u4e2d\u65ad\u4f8b\u7a0b\u5c06\u9996\u5148\u5bf9\u901a\u7528\u5bc4\u5b58\u5668\u8fdb\u884c\u4fdd\u5b58\uff08x0\u56e0\u4e3a\u662f\u786c\u4ef6\u96f6\uff0c\u6ca1\u6709\u4fdd\u5b58\u7684\u4ef7\u503c\uff09\uff0c\u63a5\u4e0b\u6765\u8c03\u7528\u7531C\u8bed\u8a00\u7f16\u5199\u7684\u4e2d\u65ad\u5904\u7406\u51fd\u6570\u201csoftware_handler\u201d\uff0c\u5728\u5904\u7406\u51fd\u6570\u6267\u884c\u5b8c\u6bd5\u540e\u6062\u590d\u901a\u7528\u5bc4\u5b58\u5668\u7684\u503c\uff0c\u5e76\u8c03\u7528mret\uff08S\u6a21\u5f0f\u4e0b\u5bf9\u5e94sret\uff09\u6307\u4ee4\u8fd4\u56de\u3002</p> <p>\u5904\u7406\u5668\u5728\u6267\u884cmret\u6307\u4ee4\u65f6\uff0c\u5c06\u6267\u884c\u4ee5\u4e0b\u52a8\u4f5c\uff1a</p> <p>1\uff09\u5c06mstatus\u5bc4\u5b58\u5668\u7684MPIE\u5b57\u6bb5\u6062\u590d\u5230\u8be5\u5bc4\u5b58\u5668\u7684MIE\u5b57\u6bb5\uff1b</p> <p>2\uff09\u5904\u7406\u5668\u8f6c\u6362\u5230mstatus\u5bc4\u5b58\u5668\u4e2dMPP\u5b57\u6bb5\u6240\u5bf9\u5e94\u7684\u7279\u6743\u6a21\u5f0f\uff1b</p> <p>3\uff09\u5c06mepc\u4e2d\u7684\u5185\u5bb9\u6062\u590d\u5230pc\u4e2d\u3002</p> <p>\u4ece\u4ee5\u4e0a\u4e2d\u65ad\u4f8b\u7a0b\u7684\u5904\u7406\u6d41\u7a0b\u53ef\u4ee5\u770b\u5230\uff0c\u4e2d\u65ad\u7684\u5904\u7406\u5b9e\u9645\u4e0a\u662f\u786c\u4ef6\u548c\u8f6f\u4ef6\u5171\u540c\u5b8c\u6210\u7684\u3002\u786c\u4ef6\u8d1f\u8d23\u4fdd\u5b58\u4e00\u90e8\u5206\u7684\u4e2d\u65ad\u73b0\u573a\uff0c\u800c\u8f6f\u4ef6\u5219\u4e3b\u8981\u6839\u636e\u6240\u53d1\u751f\u4e2d\u65ad\u7684\u7c7b\u578b\u9009\u62e9\u9002\u5408\u7684\u4e2d\u65ad\u4f8b\u7a0b\u6765\u8fdb\u884c\u5904\u7406\uff0c\u8f6f\u4ef6\u90e8\u5206\u4e5f\u9700\u8981\u8d1f\u8d23\u4fdd\u5b58\u4e00\u90e8\u5206\u7684\u73b0\u573a\uff0c\u5982\u901a\u7528\u5bc4\u5b58\u5668\u90e8\u5206\u3002</p> <p>1.4.4 RISC-V\u7684\u4e2d\u65ad\u4ee3\u7406\u673a\u5236</p> <p>RISC-V\u5728\u4e2d\u65ad\u5904\u7406\u4e0a\u6709\u4e00\u4e2a\u5f88\u6709\u610f\u601d\u7684\u8bbe\u8ba1\uff0c\u5c31\u662f\u53ef\u4ee5\u5c06\u7cfb\u7edf\u4e2d\u7684\u7279\u5b9a\u4e2d\u65ad\u6216\u8005\u5f02\u5e38\uff0c\u901a\u8fc7\u8bbe\u7f6e\u8f83\u9ad8\u7279\u6743\u7ea7\u7684CSR\u5bc4\u5b58\u5668\uff0c\u201c\u4ee3\u7406\u7ed9\u201d\u67d0\u4e2a\u66f4\u4f4e\u7684\u7279\u6743\u7ea7\u5904\u7406\u3002\u4f8b\u5982\uff0c\u6211\u4eec\u53ef\u4ee5\u8bbe\u7f6e\u673a\u5668\u6a21\u5f0f\u7684mideleg\u4ee5\u53camedeleg\u4e2d\u7684\u67d0\u4e9b\u4f4d\uff0c\u5c06\u7cfb\u7edf\u4e2d\u7684\u90e8\u5206\u4e2d\u65ad\uff08\u5bf9\u5e94mideleg\uff09\u6216\u5f02\u5e38\uff08\u5bf9\u5e94medeleg\uff09\u201c\u4ee3\u7406\u201d\u7ed9\u8f83\u4f4e\u7279\u6743\u7ea7\u7684\u76d1\u7ba1\u6a21\u5f0f\u6765\u5904\u7406\uff1b\u540c\u7406\uff0c\u6211\u4eec\u4e5f\u53ef\u4ee5\u8bbe\u7f6e\u76d1\u7ba1\u6a21\u5f0f\u7684sideleg\u4ee5\u53casedeleg\u4e2d\u7684\u67d0\u4e9b\u4f4d\uff0c\u5c06\u7cfb\u7edf\u4e2d\u7684\u90e8\u5206\u4e2d\u65ad\u6216\u5f02\u5e38\u201c\u4ee3\u7406\u201d\u7ed9\u7528\u6237\u7279\u6743\u7ea7\u7684\u4ee3\u7801\u6765\u5904\u7406\u3002</p> <p>\u4f8b\u5982\uff0c\u6211\u4eec\u7684PKE\u4ee3\u7801\u4e2d\uff0c\u6709\u4ee5\u4e0b\u7684\u7b49\u6548\u4ee3\u7801\uff1a</p> <pre><code>csrw mideleg, 1&lt;&lt;1 | 1&lt;&lt;5 | 1&lt;&lt;9\ncsrw medeleg, 1&lt;&lt;0 | 1&lt;&lt; 3 | 1&lt;&lt;8 | 1&lt;&lt;12 | 1&lt;&lt;13 | 1&lt;&lt;15 \n</code></pre> <p>\u8fd9\u6bb5\u4ee3\u7801\u7684\u4f5c\u7528\u662f\u5c06M\u6a21\u5f0f\u4e2dinterrupt\u4e2d\u76841\u30015\u548c9\u53f7\uff0c\u5206\u522b\u5bf9\u5e94Supervisor software interrupt\uff0cSupervisor timer interrupt\u548cSupervisor external interrupt\u4ee3\u7406\u51fa\u53bb\uff0c\u5230S\u6a21\u5f0f\u5904\u7406\uff1b\u518d\u5c06M\u6a21\u5f0f\u4e2d\u7684exception\uff08\u6216trap\uff09\u4e2d\u76840\u30013\u30018\u300112\u300113\u548c15\u53f7\uff0c\u5206\u522b\u5bf9\u5e94Instruction address misaligned\uff0c\u8c03\u8bd5\u4e2d\u65adBreakpoint\uff083\u53f7\uff09\uff0c\u7528\u6237\u6001\u7cfb\u7edf\u8c03\u7528Environment call from U-mode\uff088\u53f7\uff09\uff0c\u7f3a\u9875\u6216\u8bbf\u5b58\u5f02\u5e38\uff0812\u300113\u548c15\u53f7\uff09\u4ee3\u7406\u51fa\u53bb\uff0c\u5230S\u6a21\u5f0f\u5904\u7406\u3002\u5b9e\u9645\u4e0a\uff0c\u5c06\u8fd9\u4e9b\u91cd\u8981\u7684\u4e2d\u65ad\u4ee3\u7406\u51fa\u53bb\u540e\uff0c\u7cfb\u7edf\u4e2d\u4ea7\u751f\u7684\u7edd\u5927\u90e8\u5206\u4e2d\u65ad\u4e8b\u4ef6\u5c06\u90fd\u5728S\u6a21\u5f0f\u5904\u7406\u3002\u6240\u4ee5\uff0c\u5728\u5176\u540e\u7684PKE\u5b9e\u9a8c\u4e2d\uff0c\u8bfb\u8005\u4e3b\u8981\u8ddfU\u6a21\u5f0f\u4ee5\u53caS\u6a21\u5f0f\u7684\u4ee3\u7801\u6253\u4ea4\u9053\uff0c\u9664\u542f\u52a8\u8fc7\u7a0b\u548c\u4e00\u4e9b\u7b80\u5355\u7684\u8bbe\u7f6e\uff08\u5982\u8bbf\u5b58\u3001\u4e2d\u65ad\u4ee3\u7406\u7b49\uff09\uff0c\u5b9e\u9a8c\u4e5f\u57fa\u672c\u4e0d\u6d89\u53caM\u6a21\u5f0f\u7684\u4ee3\u7801\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter1_riscv/#15","title":"1.5 \u9875\u5f0f\u865a\u5b58\u7ba1\u7406","text":"<p>\u6211\u4eec\u77e5\u9053\uff0c\u7a0b\u5e8f\u4e2d\u7684\u4ee3\u7801\u5bf9\u6570\u636e\u8fdb\u884c\u8bbf\u95ee\uff08\u5982\u4f7f\u7528load\u548cstore\u6307\u4ee4\uff09\u65f6\uff0c\u91c7\u7528\u7684\u662f\u6570\u636e\u7684\u903b\u8f91\u5730\u5740\uff08\u5373\u7a0b\u5e8f\u5730\u5740\uff09\u3002\u7136\u800c\uff0c\u5c06\u7a0b\u5e8f\u88c5\u5165\u5185\u5b58\u65f6\uff0c\u88c5\u8f7d\u5668\u65e0\u6cd5\u4fdd\u8bc1\u6570\u636e\u7684\u903b\u8f91\u5730\u5740\u548c\u7269\u7406\u5730\u5740\uff08\u5185\u5b58\u7684\u7f16\u5740\uff09\u4e4b\u95f4\u6709\u5b8c\u5168\u76f8\u7b49\u7684\u5173\u7cfb\u3002\u5b9e\u9645\u4e0a\uff0c\u7531\u4e8e\u64cd\u4f5c\u7cfb\u7edf\u5f80\u5f80\u662f\u8ba1\u7b97\u673a\u88c5\u5165\u7269\u7406\u5185\u5b58\u7684\u7b2c\u4e00\u4e2a\u7a0b\u5e8f\uff0c\u5982\u679c\u4ed4\u7ec6\u89c4\u5212\u903b\u8f91\u5730\u5740\u7a7a\u95f4\uff0c\u8fd8\u80fd\u52c9\u5f3a\u5efa\u7acb\uff08\u64cd\u4f5c\u7cfb\u7edf\u7a0b\u5e8f\u5185\u90e8\uff09\u903b\u8f91\u5730\u5740\u5230\uff08\u5176\u6240\u88c5\u5165\u7684\u7269\u7406\u5185\u5b58\u7684\uff09\u7269\u7406\u5730\u5740\u95f4\u7684\u76f8\u7b49\u5173\u7cfb\uff0c\u4f46\u662f\u8fd9\u4e00\u70b9\u5bf9\u4e8e\u540e\u7eed\u88c5\u5165\u7684\u5e94\u7528\u7a0b\u5e8f\uff0c\u51e0\u4e4e\u662f\u65e0\u6cd5\u4e5f\u4e0d\u53ef\u80fd\u4fdd\u8bc1\u7684\u3002</p> <p>\u4e3a\u4e86\u5b9e\u73b0\u7a0b\u5e8f\u903b\u8f91\u5730\u5740\u5230\uff08\u5176\u88c5\u5165\u7269\u7406\u5185\u5b58\u540e\u7684\uff09\u7269\u7406\u5730\u5740\u7684\u8f6c\u6362\uff0c\u4fdd\u8bc1\u7a0b\u5e8f\u5bf9\u6570\u636e\u7684\u6b63\u786e\u5bfb\u5740\uff0c\u91c7\u7528RV64G\u6307\u4ee4\u96c6\u7684RISC-V\u5904\u7406\u5668\u5728\u76d1\u7ba1\u6a21\u5f0f\uff08\u5373S\u6a21\u5f0f\uff0c\u4e5f\u5c31\u662f\u6211\u4eec\u7684PKE\u64cd\u4f5c\u7cfb\u7edf\u4ee3\u7801\u8fd0\u884c\u7684\u7279\u6743\u6a21\u5f0f\uff09\u63d0\u4f9b\u4e86\u4e09\u79cd\u903b\u8f91\u5730\u5740\u5230\u7269\u7406\u5730\u5740\u7684\u8f6c\u6362\u65b9\u5f0f\uff1aBare\uff0cSv39\u548cSv48\u3002\u7531\u4e8e\u903b\u8f91\u5730\u5740\u5230\u7269\u7406\u5730\u5740\u7684\u8f6c\u6362\u4e0e\u7269\u7406\u5185\u5b58\u7684\u7ba1\u7406\u6709\u7740\u7d27\u5bc6\u7684\u5173\u8054\uff0c\u6240\u4ee5\u4ee5\u4e0a\u4e09\u79cd\u65b9\u5f0f\u4e5f\u88ab\u79f0\u4e3a\u865a\u62df\u5185\u5b58\u7ba1\u7406\uff08Virtual Memory Management\uff0c\u7b80\u79f0VMM\uff09\u65b9\u5f0f\u3002\u5176\u4e2dBare\u6a21\u5f0f\u662f\u6700\u7b80\u5355\u7684VMM\u65b9\u5f0f\uff0c\u5373\u5bfb\u5740\u65f6\u4e0d\u5bf9\u865a\u62df\u5730\u5740\u8fdb\u884c\u4efb\u4f55\u8f6c\u6362\uff0c\u6240\u8bbf\u95ee\u7684\u7269\u7406\u5185\u5b58\u5730\u5740\u5c31\u7b49\u4e8e\u865a\u62df\u5185\u5b58\u5730\u5740\uff0c\u8fd9\u79cd\u65b9\u5f0f\u5728\u64cd\u4f5c\u7cfb\u7edf\u542f\u52a8\u548c\u521a\u8fdb\u5165S\u6a21\u5f0f\u65f6\u5f88\u6709\u7528\uff0c\u5355\u4efb\u52a1\u6a21\u5f0f\uff08\u53ea\u6267\u884c\u4e00\u4e2a\u5e94\u7528\uff09\u4e0b\u4ecd\u7136\u53ef\u7528\uff0c\u4f46\u591a\u4efb\u52a1\u6a21\u5f0f\uff08\u542f\u52a8\u591a\u4e2a\u8fdb\u7a0b\uff09\u4e0b\u5c31\u6ca1\u6cd5\u7528\u4e86\uff1bSv39\u548cSv48\u662f\u9875\u5f0f\u865a\u62df\u5185\u5b58\u7684\u7ba1\u7406\u65b9\u5f0f\uff0c\u5b83\u4eec\u5206\u522b\u652f\u630139\u4f4d\u548c48\u4f4d\u7684\u903b\u8f91\u5730\u5740\uff0c\u4e14\u5c06\u7269\u7406\u5185\u5b58\u4ee5\u9875\u9762\uff08page\uff09\u7684\u7c92\u5ea6\u8fdb\u884c\u7ba1\u7406\u3002Sv39\u548cSv48\u8fd9\u4e24\u79cdVMM\u7528\u5f97\u8f83\u591a\u7684\u662fSv39\uff0cSv48\u53ea\u662f\u5728Sv39\u4e0a\u7684\u4e00\u4e2a\u7b80\u5355\u6269\u5c55\uff0c\u6240\u4ee5\u5728\u540e\u7eed\u8ba8\u8bba\u4e2d\uff0c\u6211\u4eec\u5c06\u7740\u91cd\u8ba8\u8bbaSv39\u3002</p> <p>1.5.1 Sv39\u4e2d\u7684\u7269\u7406\u5730\u5740\u4e0e\u903b\u8f91\u5730\u5740</p> <p>\u9996\u5148\u6211\u4eec\u6765\u770b\u7269\u7406\u5730\u5740\u3002\u4eceRV64G\u7684\u540d\u5b57\u4e0a\u6765\u770b\uff0c\u91c7\u7528\u8be5\u6307\u4ee4\u96c6\u7684\u5904\u7406\u5668\u7684\u7269\u7406\u5730\u5740\u5e94\u8be5\u670964\u4f4d\uff0c\u4f46\u662f\u76ee\u524d\u7684\u8bbe\u8ba1\u662f\u4e0d\u662f\u628a64\u4e2a\u5730\u5740\u4f4d\u90fd\u7528\u4e86\u5462\uff1f\u7b54\u6848\u662f\u5176\u5b9e\u5e76\u6ca1\u6709\uff01\u76ee\u524d\u7684\u8bbe\u8ba1\u53ea\u7528\u5230\u4e86\u5176\u4e2d\u768456\u4e2a\u4f4d\u3002\u8fd9\u610f\u5473\u7740\u73b0\u6709\u7684\u8bbe\u8ba1\u80fd\u591f\u652f\u6491\u7684\u7269\u7406\u5185\u5b58\u7a7a\u95f4\u5927\u5c0f\u5df2\u7ecf\u9ad8\u8fbe2^56B=2^16TB\uff0c\u537365536\u4e2aTB\uff01\u8fd9\u4e2a\u6570\u5b57\u5728\u5185\u5b58\u6761\u4ecd\u7136\u6bd4\u8f83\u6602\u8d35\u7684\u4eca\u5929\uff0c\u5df2\u7ecf\u662f\u4e00\u4e2a\u60ca\u4eba\u7684\u6570\u5b57\u4e86\uff0c\u56e0\u4e3a\u5373\u4f7f\u5bf9\u4e8e\u4eca\u5929\u7684\u670d\u52a1\u5668\u800c\u8a00\uff0c\u7269\u7406\u5185\u5b58\u8fbe\u52301TB\u4ee5\u4e0a\u4f9d\u65e7\u662f\u4e00\u4e2a\u6bd4\u8f83\u5bcc\u8c6a\u7684\u914d\u7f6e\u3002</p> <p>\u63a5\u4e0b\u6765\u6211\u4eec\u6765\u8ba8\u8bba\u903b\u8f91\u5730\u5740\u3002\u5bf9\u4e8eSv39\u800c\u8a00\uff0c\u8be5\u865a\u5b58\u7ba1\u7406\u65b9\u6848\u5b9e\u9645\u4e0a\u53ea\u7528\u5230\u4e8664\u4f4d\u4e2d\u768439\u4f4d\uff08\u662f\u7684\uff0c\u4e5f\u6ca1\u6709\u7528\u5230\u5168\u90e864\u4f4d\uff0c\u4e0d\u8fc7\u76f8\u4fe1\u8bfb\u8005\u7406\u89e3\u4e86VMM\u7684\u539f\u7406\u5c31\u80fd\u660e\u767d\u4e3a\u4ec0\u4e48\u65e0\u8bba\u662f\u7269\u7406\u5730\u5740\u8fd8\u662f\u903b\u8f91\u5730\u5740\u90fd\u672a\u7528\u6ee164\u4f4d\u4e86\uff09\uff01\u6709\u4e86\u8fd9\u4e2a\u6570\u5b57\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u8ba1\u7b97\u51fa\u903b\u8f91\u5730\u5740\u7a7a\u95f4\u7684\u5927\u5c0f\u4e3a\uff1a2^39B=512GB\uff0c\u8fd9\u610f\u5473\u7740\u6211\u4eec\u5199\u7684\u7a0b\u5e8f\u6700\u5927\u53ef\u4ee5\u5199\u5230512GB\uff01\u5f53\u7136\uff0c\u8fd9\u4e2a\u6570\u5b57\u5bf9\u4e8e\u6211\u4eec\u5728\u5b9e\u9a8c\u4e2d\u6240\u5199\u7684\u5c0f\u7a0b\u5e8f\u6ca1\u6709\u4ec0\u4e48\u610f\u4e49\uff08\u6211\u4eec\u5199\u7684hello world\u4e4b\u7c7b\u7684\u5c0f\u7a0b\u5e8f\uff0c\u903b\u8f91\u5730\u5740\u7a7a\u95f4\u53ea\u6709\u51e0\u4e2aKB\uff09\uff0c\u4f46\u662f\u8fd9\u4e2a\u6570\u5b57\u5bf9\u4e8e\u5927\u578b\u6e38\u620f\u8f6f\u4ef6\u3001\u4ee5\u53ca\u90e8\u5206\u5927\u6570\u636e\u5904\u7406\u8f6f\u4ef6\u662f\u6709\u8db3\u591f\u5438\u5f15\u529b\u7684\uff0c\u8fd9\u5176\u5b9e\u4e5f\u662f\u4e3a\u4ec0\u4e48\u8ba1\u7b97\u673a\u5de5\u4e1a\u201c\u4e49\u65e0\u53cd\u987e\u201d\u5730\u629b\u5f0332\u4f4d\u53bb\u62e5\u62b164\u4f4d\u7684\u6839\u672c\u539f\u56e0\uff01\u901a\u8fc7\u4ee5\u4e0a\u7684\u8ba8\u8bba\uff0c\u6211\u4eec\u53d1\u73b0\u4e00\u4e2a\u6709\u8da3\u7684\u73b0\u8c61\uff0c\u90a3\u5c31\u662f\uff1a</p> <p>\u903b\u8f91\u5730\u5740\u7a7a\u95f4\u5927\u5c0f \u2260 \u7269\u7406\u5730\u5740\u7a7a\u95f4\u5927\u5c0f</p> <p>\u5e94\u8be5\u6765\u8bf4\uff0c\u8fd9\u4e2a\u73b0\u8c61\u5bf9\u4e8e\u4eca\u5929\u5e7f\u6cdb\u5b58\u5728\u768464\u4f4d\u7cfb\u7edf\uff0c\u5df2\u7ecf\u662f\u4e00\u4e2a\u53f8\u7a7a\u89c1\u60ef\u7684\u73b0\u8c61\u4e86\u3002\u540c\u7406\uff0c\u5bf9\u4e8eSv48\u800c\u8a00\uff0c\u5176\u903b\u8f91\u5730\u5740\u7684\u957f\u5ea6\u662f48\u4f4d\uff0c\u8ddf\u7269\u7406\u5730\u5740\u957f\u5ea6\u768456\u4f4d\u4e5f\u4e0d\u7b49\u957f\u3002</p> <p>1.5.2 Sv39\u4e2d\u7684\u9875\u5f0f\u5730\u5740\u7a7a\u95f4\u7ba1\u7406\u4e0e\u9875\u8868</p> <p>\u6211\u4eec\u6765\u5206\u6790Sv39\u865a\u5b58\u7ba1\u7406\u65b9\u6848\u4e2d\u903b\u8f91\u5730\u5740\u5230\u7269\u7406\u5730\u5740\u7684\u8f6c\u6362\u3002\u7531\u4e8eSv39\u662f\u4e00\u4e2a\u9875\u5f0f\u865a\u5b58\u7ba1\u7406\u65b9\u6cd5\uff0c\u6211\u4eec\u9996\u5148\u9700\u8981\u641e\u6e05\u695a\u7684\u95ee\u9898\u5c31\u662f\u9875\u9762\uff08\u5305\u62ec\u865a\u9875virtual page\u548c\u5b9e\u9875physical page\uff09\u7684\u5927\u5c0f\u3002\u5bf9\u4e8eSv39\u800c\u8a00\uff08\u5b9e\u9645\u4e0a\uff0c\u5305\u62ecSv48\uff09\uff0c\u5176\u57fa\u7840\u9875\u9762\u5927\u5c0f\u662f4KB\u3002\u5b9e\u9645\u4e0aSv39\u4e5f\u652f\u6301\u66f4\u5927\u7684\u9875\u9762\uff0c\u4f8b\u59822MB\u7684\u5146\u9875\uff08megapage\uff09\u548c1GB\u7684\u5409\u9875\uff08gigapage\uff09\uff0c\u8fd9\u4e9b\u6211\u4eec\u5c06\u5728\u5f04\u660e\u767d\u9875\u5f0f\u5730\u5740\u53d8\u6362\u540e\u8ba8\u8bba\uff0c\u73b0\u9636\u6bb5\u8bfb\u8005\u53ef\u4ee5\u53ea\u8003\u86514KB\u7684\u57fa\u7840\u9875\u3002</p> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5bf939\u4f4d\u7684\u903b\u8f91\u5730\u5740\u8fdb\u884c\u201c\u5207\u5206\u201d\uff0c\u5982\u56fe1.6\u6240\u793a</p> <p></p> <p>\u56fe1.6 Sv39\u4e2d\u903b\u8f91\u5730\u5740\u7684\u7ed3\u6784</p> <p>\u4ece\u56fe1.6\u4e2d\uff0c\u6211\u4eec\u770b\u5230\u903b\u8f91\u5730\u5740\u5728\u5207\u5206\u540e\uff0c\u4ece\u53f3\u5230\u5de6\u4f9d\u6b21\u7684\u5206\u5e03\u662f\uff1a12\u4f4d\u7684page offset\uff08\u5373\u9875\u5185\u504f\u79fb\uff09\u30019\u4f4d\u7684\u4e00\u7ea7\u865a\u9875\u53f7VPN[0]\uff08Virtual Page Number\uff09\u30019\u4f4d\u7684\u4e8c\u7ea7\u865a\u9875\u53f7VPN[1]\uff08Virtual Page Number\uff09\u30019\u4f4d\u7684\u4e09\u7ea7\u865a\u9875\u53f7VPN[2]\uff08Virtual Page Number\uff09\u3002\u5176\u4e2d\u7684\u4e00\u7ea7\u865a\u9875\u53f7\u53c8\u5e38\u88ab\u79f0\u4e3a\u9875\u8868\uff08Page Table\uff0c\u7b80\u5199\u4e3aPT\uff09\u7f16\u53f7\uff0c\u800c\u4e8c\u7ea7\u548c\u4e09\u7ea7\u865a\u9875\u53f7\u53c8\u5e38\u5206\u522b\u88ab\u79f0\u4e3a\u9875\u76ee\u5f55\uff08Page Directory\uff0c\u7b80\u5199\u4e3aPD\uff09\u548c\u6839\u76ee\u5f55\u7f16\u53f7\u3002</p> <p>\u9875\u5185\u504f\u79fb\u4e3a12\u4f4d\uff0c\u8fd9\u5f88\u5bb9\u6613\u7406\u89e3\uff1a\u56e0\u4e3a\u6211\u4eec\u7684\u57fa\u7840\u9875\u7684\u5927\u5c0f\u662f4KB\u7684\uff0c\u5176\u5730\u5740\u957f\u5ea6\u5c31\u662f12\u4f4d\u3002\u4f46\u662f\uff0c\u4e3a\u4ec0\u4e48\u6211\u4eec\u7684VPN\u90fd\u662f9\u4f4d\u7684\u5462\uff1f\u8fd9\u662f\u56e0\u4e3a\u6211\u4eec\u7684\u9875\u8868\uff08\u6216\u8005\u9875\u76ee\u5f55\uff09\u662f\u9700\u8981\u4fdd\u5b58\u5728\u5185\u5b58\uff08\u7269\u7406\uff09\u9875\u9762\u4e2d\u7684\uff0c\u800c4KB\u5927\u5c0f\u7684\u57fa\u7840\u9875\u80fd\u591f\u4fdd\u5b58\u7684\u9875\u8868\u9879\uff08Page Table Entry\uff0c\u7b80\u79f0\u4e3aPTE\uff09\u6216\u9875\u76ee\u5f55\u9879\uff08Page Directory Entry\uff0c\u7b80\u79f0\u4e3aPDE\uff09\u7684\u4e2a\u6570\u662f512\uff08=2^9\uff09\u4e2a\uff01\u4e3a\u4e86\u8bb2\u6e05\u695a\u8fd9\u4e2a\u95ee\u9898\uff0c\u6211\u4eec\u9700\u8981\u8fdb\u4e00\u6b65\u89c2\u5bdf\u56fe1.7\u4e2dPTE\u6216PDE\u7684\u683c\u5f0f\u3002</p> <p></p> <p>\u56fe1.7 Sv39\u4e2dPDE/PTE\u683c\u5f0f</p> <p>\u5bf9\u56fe1.7\u4e2dPDE/PTE\u683c\u5f0f\u7684\u89e3\u91ca\uff1a</p> <p>\u25cf V\uff08Valid\uff09\u4f4d\u51b3\u5b9a\u4e86\u8be5PDE/PTE\u662f\u5426\u6709\u6548\uff08V=1\u65f6\u6709\u6548\uff09\uff0c\u5373\u662f\u5426\u6709\u5bf9\u5e94\u7684\u5b9e\u9875\u3002</p> <p>\u25cf R\uff08Read\uff09\u3001W\uff08Write\uff09\u548cX\uff08eXecutable\uff09\u4f4d\u5206\u522b\u8868\u793a\u6b64\u9875\u5bf9\u5e94\u7684\u5b9e\u9875\u662f\u5426\u53ef\u8bfb\u3001\u53ef\u5199\u548c\u53ef\u6267\u884c\u3002\u8fd93\u4e2a\u4f4d\u53ea\u5bf9PTE\u6709\u610f\u4e49\uff0c\u5bf9\u4e8ePDE\u800c\u8a00\u8fd93\u4e2a\u4f4d\u90fd\u4e3a0\u3002</p> <p>\u25cf U\uff08User\uff09\u4f4d\u8868\u793a\u8be5\u9875\u662f\u4e0d\u662f\u4e00\u4e2a\u7528\u6237\u6a21\u5f0f\u9875\u3002\u5982\u679cU=1\uff0c\u8868\u793a\u7528\u6237\u6a21\u5f0f\u4e0b\u7684\u4ee3\u7801\u53ef\u4ee5\u8bbf\u95ee\u8be5\u9875\uff0c\u5426\u5219\u5c31\u8868\u793a\u4e0d\u80fd\u8bbf\u95ee\u3002S\u6a21\u5f0f\u4e0b\u7684\u4ee3\u7801\u5bf9U=1\u9875\u9762\u7684\u8bbf\u95ee\u53d6\u51b3\u4e8esstatus\u5bc4\u5b58\u5668\u4e2d\u7684SUM\u5b57\u6bb5\u53d6\u503c\u3002</p> <p>\u25cf G\uff08Global\uff09\u4f4d\u8868\u793a\u8be5PDE/PTE\u662f\u4e0d\u662f\u5168\u5c40\u7684\u3002\u6211\u4eec\u53ef\u4ee5\u628a\u64cd\u4f5c\u7cfb\u7edf\u4e2d\u8fd0\u884c\u7684\u4e00\u4e2a\u8fdb\u7a0b\uff0c\u8ba4\u4e3a\u662f\u4e00\u4e2a\u72ec\u7acb\u7684\u5730\u5740\u7a7a\u95f4\uff0c\u6709\u65f6\u4f1a\u5e0c\u671b\u67d0\u4e2a\u865a\u5730\u5740\u7a7a\u95f4\u8f6c\u6362\u53ef\u4ee5\u5728\u4e00\u7ec4\u8fdb\u7a0b\u4e2d\u5171\u4eab\uff0c\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u5c31\u53ef\u4ee5\u5c06\u67d0\u4e2aPDE\u7684G\u4f4d\u8bbe\u7f6e\u4e3a1\uff0c\u8fbe\u5230\u8fd9\u79cd\u5171\u4eab\u7684\u6548\u679c\u3002</p> <p>\u25cf A\uff08Access\uff09\u4f4d\u8868\u793a\u8be5\u9875\u662f\u5426\u88ab\u8bbf\u95ee\u8fc7\u3002</p> <p>\u25cf D\uff08Dirty\uff09\u4f4d\u8868\u793a\u8be5\u9875\u7684\u5185\u5bb9\u662f\u5426\u88ab\u4fee\u6539\u3002</p> <p>\u25cf RSW\u4f4d\uff082\u4f4d\uff09\u662f\u4fdd\u7559\u4f4d\uff0c\u4e00\u822c\u7531\u8fd0\u884c\u5728S\u6a21\u5f0f\u7684\u4ee3\u7801\uff08\u5982\u64cd\u4f5c\u7cfb\u7edf\uff09\u6765\u4f7f\u7528\u3002</p> <p>\u25cf PPN\uff0844\u4f4d\uff09\u662f\u7269\u7406\u9875\u53f7\uff08Physical Page Number\uff0c\u7b80\u5199\u4e3aPPN\uff09\u3002</p> <p>\u56fe1.7\u7684PDE/PTE\u683c\u5f0f\u4e2d\u6709\u4e00\u4e2a\u5f88\u91cd\u8981\u7684\u95ee\u9898\uff1a\u4e3a\u4ec0\u4e48\u91cc\u9762\u7684PPN\u662f44\u4f4d\u7684\u5462\uff1f\u901a\u8fc71.5.1\u5c0f\u8282\u7684\u4ecb\u7ecd\uff0c\u6211\u4eec\u77e5\u9053\u76ee\u524d\u9636\u6bb5\u7684RV64G\u5904\u7406\u5668\u5b9e\u9645\u4f7f\u7528\u7684\u7269\u7406\u5185\u5b58\u5730\u5740\u662f56\u4e2a\u4f4d\uff0c\u800c\u8fd9\u4e2a2^56B\u7684\u7269\u7406\u5730\u5740\u7a7a\u95f4\u53ef\u4ee5\u770b\u6210\u662f\u591a\u5c11\u4e2a4KB\u7684\u57fa\u7840\u7269\u7406\u9875\u5462\uff1f\u7b54\u6848\u662f2^(56-12)=2^44\u4e2a\uff01\u4e5f\u5c31\u662fPPN\u5b9e\u9645\u4e0a\u5c31\u662f\u6211\u4eec\u5728\u64cd\u4f5c\u7cfb\u7edf\u539f\u7406\u8bfe\u4e2d\u6240\u5b66\u4e60\u5230\u7684\u201c\u7269\u7406\u5757\u53f7\u201d\uff0c\u4e00\u4e2a\u7269\u7406\u9875\u7f16\u53f7\u800c\u5df2\uff0c\u4f46\u5982\u679c\u6211\u4eec\u77e5\u9053\u4e00\u4e2a\u7269\u7406\u9875\u7684\u7f16\u53f7\uff0c\u5b83\u7684\uff0864\u4f4d\uff09\u8d77\u59cb\u5730\u5740\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7\u5c06\u5176\u4f4e12\u4f4d\u548c\u9ad88\u4f4d\u6dfb\u52a00\u800c\u5f97\u5230\u3002</p> <p>\u5728\u77e5\u9053Sv39\u7684\u903b\u8f91\u5730\u5740\u7ed3\u6784\u4ee5\u53caPDE/PTE\u683c\u5f0f\u540e\uff0c\u6211\u4eec\u5c31\u80fd\u591f\u7406\u89e3Sv39\u7684\u903b\u8f91\u5730\u5740\u5230\u7269\u7406\u5730\u5740\u7684\u53d8\u6362\u8fc7\u7a0b\u4e86\uff0c\u8fd9\u4e2a\u8fc7\u7a0b\u5982\u56fe1.8\u6240\u793a\uff1a</p> <p></p> <p>\u56fe1.8 Sv39\u4e2d\u865a\u62df\u5730\u5740\u5230\u7269\u7406\u5730\u5740\u7684\u8f6c\u6362\u8fc7\u7a0b</p> <p>\u5730\u5740\u53d8\u6362\u673a\u6784\u9996\u5148\u83b7\u5f97\u903b\u8f91\u5730\u5740va\u7684VPN[2]\uff0c\u5728\u9875\u76ee\u5f55\u7684\u6839\u76ee\u5f55\uff08\u6839\u76ee\u5f55\u7684\u5730\u5740\u7531satp\u5bc4\u5b58\u5668\u4fdd\u5b58\uff09\u4e2d\u67e5\u627e\u5bf9\u5e94\u7684PDE\uff0c\u4f9d\u6b64\u5f97\u77e5\u4ee5\u53ca\u9875\u76ee\u5f55\u7684PPN\uff1b\u8fdb\u800c\u627e\u5230\u9875\u76ee\u5f55\u5b9e\u9645\u5b58\u50a8\u7684\u57fa\u7840\u7269\u7406\u9875\uff0c\u518d\u6839\u636e\u903b\u8f91\u5730\u5740\u4e2d\u7684VPN[1]\u53d6\u5f97\u9875\u76ee\u5f55\u5185\u5bf9\u5e94\u7684PDE\uff1b\u63a5\u7740\u627e\u5230\u9875\u8868\u5b9e\u9645\u5b58\u50a8\u7684\u57fa\u7840\u7269\u7406\u9875\uff0c\u518d\u6839\u636e\u903b\u8f91\u5730\u5740\u4e2d\u7684VPN[0]\u53d6\u5f97\u9875\u8868\u5185\u7684PTE\uff0c\u6700\u540e\u83b7\u5f97\u7ed9\u5b9a\u865a\u62df\u5730\u5740\u7684\u7269\u7406\u5730\u5740\u5bf9\u5e94\u7684PPN\uff0c\u518d\u5c06PPN\u548c\u865a\u62df\u5730\u5740\u4e2d\u7684page offset\u8fdb\u884c\u79fb\u4f4d\u76f8\u52a0\uff0c\u6700\u7ec8\u5f97\u5230\u7269\u7406\u5730\u5740pa\u3002</p> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u56fe1.8\u4e2d\u6240\u793a\u7684\u5730\u5740\u53d8\u6362\u8fc7\u7a0b\u662f\u7531RISC-V\u5904\u7406\u5668\u786c\u4ef6\u5b8c\u6210\u7684\uff0c\u4f46\u662f\u9875\u8868\u7684\u6784\u9020\u5374\u662f\u64cd\u4f5c\u7cfb\u7edf\u5b8c\u6210\u7684\uff01\u5bf9\u4e8e\u7cfb\u7edf\u4e2d\u8fd0\u884c\u7684\u6bcf\u4e2a\u8fdb\u7a0b\uff08\u64cd\u4f5c\u7cfb\u7edf\u672c\u8eab\u4e5f\u53ef\u4ee5\u770b\u4f5c\u662f\u4e00\u4e2a\u7279\u6b8a\u7684\u8fdb\u7a0b\uff09\uff0c\u90fd\u5e94\u8be5\u6709\u4e2a\u4e00\u9875\u8868\u4e0e\u5176\u5bf9\u5e94\uff0c\u5f53\u5904\u7406\u5668\u9700\u8981\u6267\u884c\u67d0\u4e2a\u8fdb\u7a0b\u65f6\uff0c\u5c31\u5e94\u8be5\u5c06satp\u6307\u5411\u60f3\u8981\u6267\u884c\u7684\u8fdb\u7a0b\u3002\u53e6\u5916\uff0c\u5bf9\u4e8e\u4e00\u4e2a\u8fdb\u7a0b\u800c\u8a00\uff08\u4f8b\u5982\u6211\u4eec\u7684hello world\u7a0b\u5e8f\uff09\uff0c\u5b83\u53ef\u80fd\u7528\u4e0d\u6ee1\u5168\u90e8\u865a\u62df\u5730\u5740\u7a7a\u95f4\uff08Sv39\u7684\u865a\u62df\u5730\u5740\u7a7a\u95f4\u9ad8\u8fbe512GB\uff01\uff09\uff0c\u8fd9\u79cd\u60c5\u51b5\u4e0b\u5b83\u7684\u9875\u8868\u4e2d\u53ef\u80fd\u53ea\u6709\u975e\u5e38\u5c11\u90e8\u5206\u7684PDE/PTE\u662f\u6709\u6548\u7684\uff08V\u4f4d\u4e3a1\uff09\uff0c\u800c\u5176\u4ed6PDE/PTE\u5e76\u4e0d\u6307\u5411\u4efb\u4f55\u7269\u7406\u5185\u5b58\u9875\u9762\u3002</p> <p>\u5c06\u4e00\u4e2a\u8fdb\u7a0b\u7684\uff08\u90e8\u5206\uff09\u5730\u5740\u7a7a\u95f4\u201c\u5171\u4eab\u201d\u7ed9\u53e6\u4e00\u4e2a\u8fdb\u7a0b\uff0c\u662f\u64cd\u4f5c\u7cfb\u7edf\u4e2d\u7684\u5e38\u89c4\u64cd\u4f5c\uff0c\u4f8b\u5982\u5c06\u64cd\u4f5c\u7cfb\u7edf\u672c\u8eab\u7684\u5730\u5740\u7a7a\u95f4\u90e8\u5206\u5f00\u653e\u7ed9\u67d0\u7528\u6237\u8fdb\u7a0b\u3002\u6709\u4e86\u9875\u8868\u7684\u5e2e\u52a9\uff0c\u8fd9\u79cd\u5171\u4eab\u4e5f\u975e\u5e38\u4fbf\u6377\uff0c\u4f8b\u5982\u6211\u4eec\u53ef\u4ee5\u628a\u67d0\u7528\u6237\u8fdb\u7a0b\u7684PDE\u6307\u5411\u64cd\u4f5c\u7cfb\u7edf\u7684PD\u6216PT\u3002\u4f46\u662f\uff0c\u8fd9\u79cd\u5171\u4eab\u5fc5\u987b\u8003\u8651\u5230\u6743\u9650\u95ee\u9898\uff01\u4f8b\u5982\uff0c\u5c06\u7528\u6237\u8fdb\u7a0b\u7684PDE\u6216PTE\u4e2d\u7684\u6743\u9650\u4f4d\u8fdb\u884c\u76f8\u5e94\u7684\u8bbe\u7f6e\uff0c\u907f\u514d\u5bf9\u64cd\u4f5c\u7cfb\u7edf\u4ee3\u7801\u53ef\u80fd\u7684\u7834\u574f\uff08\u5982\u4e0d\u5141\u8bb8\u5199\u6216\u6267\u884c\uff09\u3002\u7531\u4e8e\u9875\u9762\u6743\u9650\u7684\u9650\u5236\uff0c\u7528\u6237\u8fdb\u7a0b\u7684\u6267\u884c\u53ef\u80fd\u4f1a\u78b0\u5230\u8bbf\u5b58\u65b9\u9762\u7684exception\uff0c\u5982\u8bbf\u95ee\u67d0\u4e2aV=0\u7684\u9875\u9762\uff08\u7f3a\u9875\u5f02\u5e38\uff09\uff0c\u6216\u8005\u6267\u884cX=0\u7684\u9875\u4e2d\u7684\u4ee3\u7801\uff0c\u8fd9\u4e9bexception\u90fd\u4f1a\u5bfc\u81f4\u5f53\u524d\u7a0b\u5e8f\u7684\u4e2d\u65ad\uff0c\u5e76\u8fdb\u5165\u66f4\u9ad8\u7279\u6743\u7ea7\uff08\u5982PKE\u64cd\u4f5c\u7cfb\u7edf\u8fd0\u884c\u7684S\u6a21\u5f0f\uff09\u4e2d\u5904\u7406\u3002</p> <p>1.5.3 satp\u3001Sv48\u3001TLB\u548c\u975e\u57fa\u7840\u9875</p> <p>\u5728\u56fe1.8\u7684\u865a\u62df\u5730\u5740\u53d8\u6362\u4e2d\uff0c\u4e00\u4e2a\u91cd\u8981\u7684\u5bc4\u5b58\u5668\u662fsatp\uff0c\u5b83\u7684\u7ed3\u6784\u5982\u56fe1.9\u6240\u793a\u3002</p> <p></p> <p>\u56fe1.9 satp\u5bc4\u5b58\u5668\u683c\u5f0f</p> <p>satp\u5bc4\u5b58\u5668\u5305\u542b\u4e00\u4e2a44\u4f4d\u7684PPN\uff0c\u5b83\u6307\u5411\u4e86\u4e00\u4e2a\u9875\u8868\u7684\u6839\u76ee\u5f55\u6240\u5b58\u50a8\u7684\u57fa\u7840\u9875\uff1b\u4e00\u4e2aASID\uff08Address Space IDentifier\uff09\uff0c\u7528\u4e8e\u6807\u8bc6\u4e00\u4e2a\u5730\u5740\u7a7a\u95f4\uff0c\u5f53\u53d1\u751f\u5730\u5740\u7a7a\u95f4\u7684\u5207\u6362\u65f6\u7cfb\u7edf\u5c06\u9700\u8981\u8c03\u7528SFENCE.VMA\u6307\u4ee4\u6765\u5237\u65b0\u5730\u5740\u53d8\u6362\u673a\u6784\uff0c\u5982TLB\uff08Translation Lookaside Buffer\uff0c\u5373\u539f\u7406\u8bfe\u6240\u8bb2\u7684\u201c\u5feb\u8868\u201d\uff09\uff0c\u6211\u4eec\u5c06\u5728\u540e\u7eed\u8ba8\u8bba\u4e2d\u4ecb\u7ecdTLB\u548cSFENCE.VMA\u6307\u4ee4\uff1b\u548c\u4e00\u4e2a4\u4f4d\u7684\u6a21\u5f0fMODE\uff0c\u88681.8\u5217\u51fa\u4e86\u6a21\u5f0f\u57df\u53ef\u80fd\u7684\u53d6\u503c\u53ca\u542b\u4e49\u3002</p> <p>\u88681.8 satp\u5bc4\u5b58\u5668\u4e2dMODE\u57df\u7684\u53d6\u503c\u548c\u542b\u4e49</p> \u53d6\u503c \u865a\u5b58\u65b9\u6848 \u8bf4\u660e 0 Bare \u4e0d\u5bf9\u865a\u5730\u5740\u8fdb\u884c\u8f6c\u6362\u548c\u5185\u5b58\u4fdd\u62a4 8 Sv39 \u91c7\u7528Sv39\u7684\u65b9\u6848\u5bf9\u865a\u5730\u5740\u8fdb\u884c\u8f6c\u6362 9 Sv48 \u91c7\u7528Sv48\u7684\u65b9\u6848\u5bf9\u865a\u5730\u5740\u8fdb\u884c\u8f6c\u6362 <p>\u5b9e\u9645\u4e0a\u9664\u4e86Sv39\u548cSv48\u5916\uff0c\u7cfb\u7edf\u5728\u672a\u6765\u7684\u6269\u5c55\u4e2d\u8fd8\u53ef\u80fd\u652f\u6301\u66f4\u591a\u7684\u6269\u5c55\uff0c\u5982Sv57\u4ee5\u53caSv64\uff08\u89c1RISC-V instruction set manual\uff09\u3002\u4ece39\u300148\u4ee5\u53ca57\u8fd9\u51e0\u4e2a\u6570\u5b57\uff0c\u6211\u4eec\u53ef\u4ee5\u53d1\u73b0\u7684\u89c4\u5f8b\u662f\uff0c\u5b83\u4eec\u4e4b\u95f4\u4e24\u4e24\u7684\u5dee\u662f9\uff01\u7ed3\u5408\u56fe1.9\u4e2d\u7684\u5730\u5740\u7ffb\u8bd1\u8fc7\u7a0b\uff0c\u6211\u4eec\u5c31\u5f88\u5bb9\u6613\u7406\u89e3\u4ec0\u4e48\u662fSv48\u4e86\uff1a\u5b83\u5728Sv39\u7684\u57fa\u7840\u4e0a\uff0c\u7528\u4e0a\u4e86\u865a\u5730\u5740\u4e2d\u768439~47\u8fd99\u4e2a\u4f4d\uff08\u4e00\u5171\u7528\u4e86\u865a\u5730\u5740\u4e2d\u768448\u4e2a\u4f4d\uff09\uff0c\u4f5c\u4e3a\u7b2c\u56db\u7ea7\u865a\u9875\u53f7VPN[3]\u3002\u8fd9\u6837\u505a\u7684\u7ed3\u679c\u662f\uff1a\u5728\u8fdb\u884c\u5730\u5740\u7ffb\u8bd1\u7684\u65f6\u5019\u65b0\u589e\u4e86\u4e00\u7ea7\u5730\u5740\u7ffb\u8bd1\u3002\u663e\u7136\uff0cSv48\u63d0\u4f9b\u4e86\u6bd4Sv39\u66f4\u5927\u7684\u865a\u62df\u5730\u5740\u7a7a\u95f4\uff082^48B=256TB&gt;512GB\uff09\uff0c\u4ece\u800c\u80fd\u591f\u652f\u6491\u66f4\u5927\u7684\u5e94\u7528\u7a0b\u5e8f\u7684\u6267\u884c\uff0c\u90a3\u4e48\u9009\u62e9Sv48\u662f\u4e0d\u662f\u6bd4\u9009\u62e9Sv39\u66f4\u5177\u4f18\u52bf\u5462\uff1f\u7b54\u6848\u662f\uff1a\u53d6\u51b3\u4e8e\u662f\u5426\u771f\u7684\u6709\u5fc5\u8981\u652f\u6491\u8d85\u8fc7512GB\u865a\u5730\u5740\u7a7a\u95f4\u7684\u5e94\u7528\uff0c\u5982\u679c\u4e0d\u9700\u8981\uff0c\u5219Sv39\u662f\u66f4\u5408\u7406\u7684\u9009\u62e9\u3002\u4ece\u56fe1.9\u4e2d\u7684\u5730\u5740\u7ffb\u8bd1\u8fc7\u7a0b\uff0c\u6211\u4eec\u8fd8\u53ef\u4ee5\u770b\u5230\uff0c\u4e00\u6b21\u865a\u5730\u5740va\u5230\u5b9e\u5730\u5740pa\u7684\u8f6c\u6362\u6d89\u53ca\u52304\u6b21\uff08\u6839\u76ee\u5f55+\u9875\u76ee\u5f55+\u9875\u8868+pa\u6240\u5728\u7684\u9875\uff09\u8bbf\u95ee\u5185\u5b58\u64cd\u4f5c\uff01\u800c\u76f8\u6bd4\u4e8e\u5904\u7406\u5668\u5185\u90e8\u8fdb\u884c\u7684\u8fd0\u7b97\u800c\u8a00\uff0c\u8bbf\u5b58\u663e\u7136\u662f\u66f4\u4e3a\u8017\u65f6\u7684\u64cd\u4f5c\u3002\u53ef\u4ee5\u60f3\u8c61\uff0c\u5982\u679c\u91c7\u7528Sv48\uff0c\u8fd9\u4e2a\u8f6c\u6362\u6240\u9700\u8981\u7684\u8bbf\u5b58\u64cd\u4f5c\u662f\uff085\u6b21\uff09\u6bd4Sv39\u66f4\u591a\u7684\u3002</p> <p>\u4e3a\u4e86\u52a0\u5feb\u865a\u5730\u5740\u5230\u5b9e\u5730\u5740\u7684\u8f6c\u6362\uff0c\u4eca\u5929\u7684\u5904\u7406\u5668\uff08RISC-V\u5904\u7406\u5668\u4e5f\u4e0d\u4f8b\u5916\uff0c\u4f46\u53d6\u51b3\u4e8e\u5177\u4f53\u7684\u8bbe\u8ba1\uff09\u4e00\u822c\u90fd\u5185\u7f6e\u4e86TLB\uff08Translation Lookaside Buffer\uff09\u5355\u5143\uff0c\u5176\u901f\u5ea6\u63a5\u8fd1\u5bc4\u5b58\u5668\u3002\u5728\u8fdb\u884c\u5730\u5740\u8f6c\u6362\u65f6\uff0c\u5c06\u5e38\u7528\u7684PDE/PTE\u5b58\u50a8\u5728TLB\u4e2d\u4ee5\u52a0\u901f\u865a\u5b9e\u5730\u5740\u7684\u8f6c\u6362\u901f\u5ea6\u3002\u7136\u800c\uff0c\u8fd9\u53c8\u5e26\u6765\u4e00\u4e2a\u65b0\u7684\u95ee\u9898\uff0c\u5373\u5f53\u53d1\u751f\u8fdb\u7a0b\u5207\u6362\u65f6\uff0cTLB\u4e2d\u5f88\u6709\u53ef\u80fd\u8fd8\u4fdd\u7559\u4e86\u4e0a\u4e00\u4e2a\u8fdb\u7a0b\u7684\u5730\u5740\u53d8\u6362\u6240\u6d89\u53ca\u7684PDE/PTE\uff01\u8fd9\u65f6\uff0c\u6211\u4eec\u5c31\u9700\u8981\u501f\u52a9satp\u5bc4\u5b58\u5668\u4e2d\u7684ASID\uff08Application Specific ID\uff09\u5b57\u6bb5\u6765\u5224\u65ad\u662f\u5426\u53d1\u751f\u4e86\u8fdb\u7a0b\u5207\u6362\uff0c\u5982\u679c\u53d1\u751f\u4e86\uff0c\u64cd\u4f5c\u7cfb\u7edf\u5c31\u9700\u8981\u8c03\u7528SFENCE.VMA\u6307\u4ee4\u6765\u5c06TLB\u4e2d\u7684\u5185\u5bb9\u5237\u65b0\u3002</p> <p>\u7531\u4e8e\u4eca\u5929\u5e94\u7528\u5bf9\u903b\u8f91\u5730\u5740\u7a7a\u95f4\u9700\u6c42\u7684\u81a8\u80c0\uff08\u5982\u903b\u8f91\u5730\u5740\u7a7a\u95f4\u8fbe\u5230\u4e8610GB\uff0c\u4e14\u76f8\u5bf9\u8fde\u7eed\uff09\uff0c\u91c7\u7528\u4f20\u7edf\u76844KB\u57fa\u7840\u9875\u6765\u7ec4\u7ec7\u8fd9\u7c7b\u5e94\u7528\u7684\u865a\u5730\u5740\u7a7a\u95f4\u663e\u7136\u4f1a\u663e\u5f97\u975e\u5e38\u5570\u55e6\uff08\u5927\u91cf\u7684PDE\u548cPTE\uff09\uff0c\u4e14\u5bfc\u81f4\u4e86\u5730\u5740\u7ffb\u8bd1\u65f6\u7684\u4f4e\u6548\u7387\u3002\u4e3a\u4e86\u5e94\u5bf9\u8fd9\u7c7b\u53d8\u5316\uff0cSv39\u865a\u62df\u5185\u5b58\u7ba1\u7406\u65b9\u6848\u63d0\u4f9b\u4e862MB\u7684\u5146\u9875\uff08megapage\uff09\u548c1GB\u7684\u5409\u9875\uff08gigapage\uff09\u6765\u6d88\u51cf\u56fe1.9\u6240\u793a\u7684\u903b\u8f91\u5730\u5740\u7ffb\u8bd1\u5c42\u6570\uff0c\u4ece\u800c\u63d0\u9ad8\u5730\u5740\u7ffb\u8bd1\u7684\u6548\u7387\u3002\u5b9e\u9645\u4e0a\u5b83\u4eec\u7684\u539f\u7406\u975e\u5e38\u7b80\u5355\uff1a\u5bf9\u4e8e2MB\u7684\u5146\u9875\uff0c\u53ea\u9700\u8981\u5c06\u865a\u62df\u5730\u5740\u90e8\u5206\u7684VPN[0]\u90e8\u5206\u4f5c\u4e3a\u9875\u5185\u504f\u79fb\u7684\u4e00\u90e8\u5206\u5373\u53ef\uff0812+9=21\uff0c2^21B=2MB\uff09\uff1b\u800c\u5bf9\u4e8e1GB\u7684\u5409\u9875\uff0c\u53ea\u9700\u8981\u5c06\u865a\u62df\u5730\u5740\u90e8\u5206\u7684VPN[0]\u548cVPN[1]\u90fd\u5f53\u4f5c\u9875\u5185\u504f\u79fb\u5373\u53ef\uff0821+9=30\uff0c2^30B=1GB\uff09\u3002</p> <p>\u5b9e\u9645\u4e0a\uff0c\u5f00\u542f\u91c7\u7528\u5146\u9875\u6216\u5409\u9875\u7684\u65b9\u6cd5\uff0c\u5728RISC-V\u89c4\u8303\u4e2d\u5e76\u672a\u63d0\u4f9b\uff0c\u5e94\u8be5\u662f\u8ba9\u5404\u4e2a\u8bbe\u8ba1RISC-V\u5904\u7406\u5668\u7684\u5355\u4f4d\u81ea\u884c\u5236\u5b9a\u3002\u8003\u8651\u5230\u6211\u4eec\u7684PKE\u5b9e\u9a8c\u5e76\u672a\u6d89\u53ca\u8fd9\u4e9b\u975e\u57fa\u7840\u9875\uff0c\u6240\u4ee5\u5728\u8fd9\u91cc\u6211\u4eec\u4e0d\u6253\u7b97\u5bf9\u8fd9\u90e8\u5206\u5185\u5bb9\u8fdb\u4e00\u6b65\u8ba8\u8bba\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter1_riscv/#16","title":"1.6 \u76f8\u5173\u5de5\u5177\u8f6f\u4ef6","text":"<p>PKE\u7684\u5b9e\u9a8c\u5c06\u6d89\u53caLinux\u73af\u5883\u4e0b\u8f83\u591a\u5de5\u5177\u8f6f\u4ef6\u7684\u4f7f\u7528\uff0c\u4ee5\u4e0b\u5217\u51fa\u4e00\u4e9b\u6211\u4eec\u8ba4\u4e3a\u6bd4\u8f83\u91cd\u8981\u7684\u5de5\u5177\u8f6f\u4ef6\uff0c\u5e76\u7b80\u8981\u4ecb\u7ecd\u5176\u4f7f\u7528\u65b9\u6cd5\u3002\u8be6\u7ec6\u7684\u4f7f\u7528\u65b9\u6cd5\uff0c\u5e0c\u671b\u8bfb\u8005\u901a\u8fc7\u9605\u8bfb\u5176\u4f7f\u7528\u624b\u518c\u8fdb\u4e00\u6b65\u638c\u63e1\u3002</p> <p>\u25cf git</p> <p>git\u662f\u4e00\u4e2a\u5f00\u6e90\u7684\u5206\u5e03\u5f0f\u7248\u672c\u63a7\u5236\u7cfb\u7edf\uff0c\u5bf9\u4e8e\u4e00\u4e2a\u672c\u5730\u4ed3\u5e93\uff0c\u4f60\u53ef\u4ee5\u4f7f\u7528\u5982\u4e0b\u547d\u4ee4\u521b\u5efa\uff1a</p> <p><code>$git init</code></p> <p>\u5bf9\u5df2\u5b58\u5728\u6587\u4ef6\u8fdb\u884c\u7248\u672c\u63a7\u5236</p> <p><code>$git add *.c</code></p> <p><code>$git add LICENSE</code></p> <p><code>$git commit -m 'Initial project version'</code></p> <p>\u5bf9\u4e8e\u4e00\u4e2a\u8fdc\u7a0b\u7684git\u4ed3\u5e93\uff0c\u4f60\u60f3\u8981\u628a\u4ee3\u7801\u514b\u9686\u5230\u672c\u5730\uff0c\u9700\u8981\u4f7f\u7528git clone\u547d\u4ee4</p> <p><code>$git clone url</code></p> <p>\u5f53clone\u5b8c\u6210\uff0c\u4f60\u5c31\u4f1a\u6709\u672c\u5730\u7684\u5de5\u4f5c\u76ee\u5f55\uff0c\u8fdb\u5165\u8be5\u76ee\u5f55\uff0c\u6bcf\u4e2a\u6587\u4ef6\u90fd\u6709\u4e24\u79cd\u72b6\u6001\uff1atracked or untracked\u3002\u5df2\u8ddf\u8e2a\u7684\u6587\u4ef6\u662f\u6307\u90a3\u4e9b\u88ab\u7eb3\u5165\u4e86\u7248\u672c\u63a7\u5236\u7684\u6587\u4ef6\uff0c\u5728\u4e0a\u4e00\u6b21\u5feb\u7167\u4e2d\u6709\u5b83\u4eec\u7684\u8bb0\u5f55\uff0c\u5728\u5de5\u4f5c\u4e00\u6bb5\u65f6\u95f4\u540e\uff0c\u5b83\u4eec\u7684\u72b6\u6001\u53ef\u80fd\u662f\u672a\u4fee\u6539\uff0c\u5df2\u4fee\u6539\u6216\u5df2\u653e\u5165\u6682\u5b58\u533a\u3002\u7b80\u800c\u8a00\u4e4b\uff0c\u5df2\u8ddf\u8e2a\u7684\u6587\u4ef6\u5c31\u662f git \u5df2\u7ecf\u77e5\u9053\u7684\u6587\u4ef6\u3002\u5176\u72b6\u6001\u8f6c\u6362\u5982\u56fe\uff1a</p> <p></p> <p>\u56fe1.13 git\u4ed3\u5e93\u4e2d\u6587\u4ef6\u7684\u72b6\u6001\u8f6c\u6362</p> <p>\u4f7f\u7528git status\u53ef\u4ee5\u67e5\u770b\u76ee\u5f55\u4e0b\u7684\u6587\u4ef6\u72b6\u6001</p> <p><code>$ git status</code></p> <p>\u4f7f\u7528add\u547d\u4ee4\u53ef\u4ee5\u9012\u5f52\u5730\u8ddf\u8e2a\u8be5\u76ee\u5f55\u4e0b\u7684\u6240\u6709\u6587\u4ef6\u3001\u6216\u6682\u5b58\u5df2\u4fee\u6539\u7684\u6587\u4ef6</p> <p><code>$ git add fileName/directory</code></p> <p>\u4f7f\u7528commit\u547d\u4ee4\u53ef\u4ee5\u63d0\u4ea4\u66f4\u65b0</p> <p><code>$ git commit -m \"commit information\"</code></p> <p>\u25c7 \u5206\u652f\u76f8\u5173\u547d\u4ee4</p> <p>\u67e5\u770b\u5206\u652f\uff1a</p> <p><code>$ git branch</code></p> <p>\u672c\u5730\u521b\u5efa\u8fdc\u7aef\u5206\u652fdev\uff08dev\u4e3a\u5206\u652f\u540d\uff0c\u4e0b\u540c\uff09\uff1a</p> <p><code>$ git checkout -b dev origin/de</code></p> <p>\u5408\u5e76\u5206\u652fdev\uff1a</p> <p><code>$ git merge dev</code></p> <p>\u672c\u5730\u5220\u9664\u5206\u652fdev\uff1a</p> <p><code>$ git branch -D/d dev</code></p> <p>\u5207\u6362\u5230\u5df2\u6709\u5206\u652fdev\uff1a</p> <p><code>$ git checkout dev</code></p> <p>\u672c\u5730\u521b\u5efa\u5e76\u5207\u6362\u5230\u5206\u652fdev\uff1a</p> <p><code>$ git checkout -b dev</code></p> <p>\u63a8\u9001\u5206\u652fdev\u5230\u8fdc\u7aef\uff1a</p> <p><code>$ git push origin</code></p> <p>\u25c7 \u8c03\u8bd5\u76f8\u5173\u547d\u4ee4</p> <p><code>$ git log</code></p> <p>\u663e\u793a\u6bcf\u6b21\u63d0\u4ea4\u63d0\u4ea4\u65e5\u671f\u7684\u5dee\u5f02\uff0c-2\u9009\u9879\u6765\u53ea\u663e\u793a\u6700\u8fd1\u76842\u6b21\u63d0\u4ea4\uff1a</p> <p><code>$ git log -p -2</code></p> <p>\u6bcf\u6b21\u63d0\u4ea4\u7684\u7b80\u7565\u7edf\u8ba1\u4fe1\u606f\uff1a</p> <p><code>$ git log --stat</code></p> <p>\u683c\u5f0f\u5316log\u8f93\u51fa\uff1a</p> <p><code>$ git log --pretty=oneline [short\u3001full\u3001fuller]//\u7528\u4e00\u884c\u663e\u793a\u6bcf\u4e00\u6b21\u63d0\u4ea4</code></p> <p><code>$ git log --pretty=format:\"%h - %an, %ar : %s\"</code></p> <p>\u25cf riscv64-unknown-elf-gcc</p> <p>\u547d\u4ee4\u683c\u5f0f\uff1ariscv64-unknown-elf-gcc [options] file</p> <p>\u5e38\u89c1\u53c2\u6570\uff1a</p> <p>-o      Place the output into \uff08\u6307\u5b9a\u8f93\u51fa\u6587\u4ef6\u7684\u540d\u79f0\uff09 <p>-E      Preprocess only; do not compile, assemble or link\uff08\u9884\u5904\u7406\uff09</p> <p>-S     Compile only; do not assemble or link\uff08\u7f16\u8bd1\uff09</p> <p>-c      Compile and assemble, but do not link\uff08\u6c47\u7f16\uff09</p> <p>\u4e3e\u4f8b\uff1a</p> <p>\\1. -o\u9009\u9879\u6307\u5b9a\u8f93\u51fa\u6587\u4ef6\u540d\u79f0\u4e3ahello</p> <p><code>$ riscv64-unknown-elf-gcc  hello.cpp  -o hello</code></p> <p>\\2. \u4f7f\u7528-E\u9009\u9879\uff0c\u8f93\u51fa\u9884\u5904\u7406\u9636\u6bb5\u7684hello.i\u6587\u4ef6</p> <p><code>$ riscv64-unknown-elf-gcc -E hello.cpp  -o hello.i</code></p> <p>\\3. \u4f7f\u7528-S\u9009\u9879\uff0c\u8f93\u51fa\u7f16\u8bd1\u9636\u6bb5\u7684hello.s\u6587\u4ef6</p> <p><code>$ riscv64-unknown-elf-gcc -S hello.cpp -o hello.s</code></p> <p>\\4. \u4f7f\u7528-c\u9009\u9879\uff0c\u8f93\u51fa\u4e8c\u8fdb\u5236\u6587\u4ef6hello.o</p> <p><code>$ riscv64-unknown-elf-gcc -c hello.s  -o hello.o</code></p> <p>\u25cf riscv64-unknown-elf-objdump</p> <p>\u547d\u4ee4\u683c\u5f0f\uff1ariscv64-unknown-elf-objdump   <p>\u5e38\u89c1\u53c2\u6570\uff1a</p> <p>-h,  Display the contents of the section headers\uff08\u663e\u793asection header\u7684\u5185\u5bb9\uff09</p> <p>-f Display the contents of the overall file header\uff08\u663e\u793a\u6574\u4f53file header\u7684\u5185\u5bb9\uff09</p> <p>\u4e3e\u4f8b\uff1a</p> <p>\\1. \u67e5\u770b\u5bf9\u8c61\u6587\u4ef6\u6240\u6709\u7684\u8282sections.</p> <p><code>$riscv64-unknown-elf-objdump -h  elf_file</code> </p> <p>\u8f93\u51fa\u5982\u4e0b\uff1a</p> <pre><code>hello_elf:   file format elf64-littleriscv\n\nSections:\nIdx Name     Size   VMA        LMA        File off Algn\n 0 .text     000024cc 00000000000100b0 00000000000100b0 000000b0 2**1\n\u200b         CONTENTS, ALLOC, LOAD, READONLY, CODE\n 1 .rodata    0000000a 0000000000012580 0000000000012580 00002580 2**3\n\u200b         CONTENTS, ALLOC, LOAD, READONLY, DATA\n 2 .eh_frame   00000004 000000000001358c 000000000001358c 0000258c 2**2\n\u200b         CONTENTS, ALLOC, LOAD, DATA\n 3 .init_array  00000010 0000000000013590 0000000000013590 00002590 2**3\n\u200b         CONTENTS, ALLOC, LOAD, DATA\n 4 .fini_array  00000008 00000000000135a0 00000000000135a0 000025a0 2**3\n\u200b         CONTENTS, ALLOC, LOAD, DATA\n 5 .data     00000f58 00000000000135a8 00000000000135a8 000025a8 2**3\n\u200b         CONTENTS, ALLOC, LOAD, DATA\n 6 .sdata    00000040 0000000000014500 0000000000014500 00003500 2**3\n\u200b         CONTENTS, ALLOC, LOAD, DATA\n 7 .sbss     00000020 0000000000014540 0000000000014540 00003540 2**3\n\u200b         ALLOC\n 8 .bss     00000068 0000000000014560 0000000000014560 00003540 2**3\n\u200b         ALLOC\n 9 .comment   00000011 0000000000000000 0000000000000000 00003540 2**0\n\u200b         CONTENTS, READONLY\n 10 .riscv.attributes 00000035 0000000000000000 0000000000000000 00003551 2**0\n\u200b         CONTENTS, READONLY\n</code></pre> <p>\u53ef\u4ee5\u770b\u5f97\u4e00\u4e2asection\u5728\u6587\u4ef6\u4e2d\u5bf9\u5e94\u7684\u5c5e\u6027\u6709\u516d\u4e2a\uff0c\u5176\u4e2dname\u4e3asection\u7684\u540d\u5b57\uff0csize\u4e3asection\u7684\u5927\u5c0f\uff0cVMA\u4e3a\u8be5section\u671f\u671b\u4ece\u4e2d\u6267\u884c\u7684\u5185\u5b58\u5730\u5740\uff0cLAM\u4e3a\u52a0\u8f7d\u5230\u5185\u5b58\u7684\u5185\u5b58\u5730\u5740\uff0cFile off\u4e3a\u8be5section\u5728\u6587\u4ef6\u4e2d\u7684\u504f\u79fb\u91cf\uff0calgn\u5219\u4e3a\u5b57\u8282\u5bf9\u9f50\u3002</p> <p>\\2. \u663e\u793a\u6587\u4ef6\u7684\u6458\u8981\u4fe1\u606f\uff0c\u5305\u62ecstart address</p> <p><code>$riscv64-unknown-elf-objdump -f elf_file</code> </p> <p>\u4f8b\u5982\u6211\u4eec\u4f7f\u7528\uff1ariscv64-unknown-elf-objdump -f hello_elf\uff0c\u8f93\u51fa\u5982\u4e0b\uff1a</p> <pre><code>hello_elf:   file format elf64-littleriscv\narchitecture: riscv:rv64, flags 0x00000112:\nEXEC_P, HAS_SYMS, D_PAGED\nstart address 0x00000000000100c2\n</code></pre> <p>\u25cf riscv64-unknown-elf-as</p> <p>\u547d\u4ee4\u683c\u5f0f\uff1ariscv64-unknown-elf-as [option...] [asmfile...]</p> <p>\u7f16\u8bd1\u6c47\u7f16\u6e90\u6587\u4ef6\u5230\u76ee\u6807\u6587\u4ef6\uff0c\u4f8b\u5982\uff1a</p> <p><code>$ riscv64-unknown-elf-as hello.S -o hello.o</code></p> <p>\u25cf file</p> <p>\u547d\u4ee4\u683c\u5f0f\uff1afile [OPTION...] [FILE...]</p> <p>file\u547d\u4ee4\u7528\u4e8e\u8fa8\u8bc6\u6587\u4ef6\u7c7b\u578b\uff0c\u4f8b\u5982\uff1a</p> <p><code>$ file app/elf/app1</code></p> <p>\u6211\u4eec\u5c06\u770b\u5230\u4ee5\u4e0b\u8f93\u51fa\uff1a</p> <pre><code>app/elf/app1: ELF 64-bit LSB executable, UCB RISC-V, version 1 (SYSV), statically linked, with debug_info, not stripped\n</code></pre> <p>\u8868\u660eapp/elf/app1\u6587\u4ef6\u662f\u4e00\u4e2a\u53ef\u6267\u884c\u7684\u4e8c\u8fdb\u5236\u4ee3\u7801\uff08ELF\uff09\u6587\u4ef6\uff0c\u91c7\u7528\u4e86RISC-V\u6307\u4ee4\u96c6\u4e14\u4e3a\u9759\u6001\u94fe\u63a5\u6240\u751f\u6210\u3002</p> <p>\u25cf spike</p> <p>\u547d\u4ee4\u683c\u5f0f\uff1aspike [host options]  [target options] <p>\u5e38\u89c1\u53c2\u6570\uff1a</p> <p>-m    Provide  MiB of target memory [default 2048]\uff08\u63d0\u4f9bMiB\u5185\u5b58\uff09 <p>--isa= RISC-V ISA string [default RV64IMAFDC]\uff08\u8bbe\u7f6eISA\uff09 <p>spike\u662fRISC-V\u4eff\u771f\u5668\uff0c\u6211\u4eec\u5c06\u9700\u8981\u4f7f\u7528\u5b83\u7ed3\u5408pke\u8fd0\u884c\u6211\u4eec\u7684\u4e8c\u8fdb\u5236\u7a0b\u5e8f\uff0c\u4f8b\u5982\uff1a</p> <p><code>$ spike pke  helloworld</code></p> <p>\u5f97\u5230\u8f93\u51fa\u5982\u4e0b\uff1a</p> <pre><code>Hello World! \n</code></pre> <p>spike\u9ed8\u8ba4\u63d0\u4f9b\u7684\u5185\u5b58\u4e3a2048MiB\uff0c\u4f7f\u7528-m\u9009\u9879\u53ef\u4ee5\u6307\u5b9a\u5185\u5b58\u5927\u5c0f\uff08\u5355\u4f4d\u662fMiB\uff09\uff0c\u4f8b\u5982\uff1a</p> <p><code>$ spike -m1024  pke  helloworld</code></p> <p>\u5c31\u53ef\u4ee5\u5c06\u6a21\u62df\u51fa\u6765\u7684RISC-V\u673a\u5668\u7684\u5185\u5b58\u5927\u5c0f\u6307\u5b9a\u4e3a1024MiB\u3002</p> <p>RISC-V\u662f\u4e00\u4e2a\u53ef\u6269\u5c55\u6307\u4ee4\u96c6\uff0cspike\u9ed8\u8ba4\u652f\u6301\u7684ISA\u4e3aRV64IMAFDC\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7--isa\u9009\u9879\u8bbe\u7f6e\u6a21\u62df\u51fa\u6765\u7684\u673a\u5668\u7684ISA\uff0c\u4f8b\u5982\uff1a</p> <p><code>$ spike --isa=RV64GCV  pke  helloworld</code></p> <p>\u6211\u4eec\u5c06\u76ee\u6807\u673a\u5668\u7684ISA\u6307\u5b9a\u4e3aRV64GCV\u3002</p> <p> \u53c2\u8003\u6587\u732e\uff1a</p> <p>[RISC-V\u5f00\u6e90\u9879\u76ee\u5217\u8868]  RISC-V\u5f00\u6e90\u9879\u76ee\u5217\u8868. https://riscv.org/risc-v-cores/</p> <p>[\u5f00\u6e90\u6307\u4ee4\u96c6\u7684\u6307\u5357] \u52fe\u51cc\u777f\u3001\u9ec4\u6210\u3001\u5218\u5fd7\u521a\uff0c\u300aRISC-V\u624b\u518c\u2014\u2014\u4e00\u672c\u5f00\u6e90\u6307\u4ee4\u96c6\u7684\u6307\u5357\u300b. Avail at: http://crva.ict.ac.cn/documents/RISC-V-Reader-Chinese-v2p1.pdf</p> <p>[RISC-V instruction set manual] A. Waterman, Y. Lee, and et al. The RISC-V Instruction Set Manual Volume II: Privileged Architecture (version 20191213). Avail at: https://content.riscv.org/wp-content/uploads/2019/12/riscv-spec-20191213.pdf</p> <p>[RISC-V User-Level ISA]   A. Waterman, K. Asanovi\u00b4c, and et al. The RISC-V Instruction Set Manual Volume I: Unprivileged ISA (version 20191213) Avail. at: https://content.riscv.org/wp-content/uploads/2019/06/riscv-spec.pdf</p> <p>[SiFive Interrupt] SiFive, SiFive Interrupt Cookbook (version 1.0). Avail. at: https://sifive.cdn.prismic.io/sifive/0d163928-2128-42be-a75a-464df65e04e0_sifive-interrupt-cookbook.pdf</p> <p>[Zedboard] Digilent Zedboard. https://reference.digilentinc.com/programmable-logic/zedboard/start</p> <p>[Proxy Kernel] RISC-V Proxy Kernel and Boot Loader. https://github.com/riscv/riscv-pk</p> <p>[fpga-zynq] Rocket Chip on Zynq FPGAs. https://github.com/ucb-bar/fpga-zynq</p> <p>[Spike] Spike RISC-V ISA Simulator. https://github.com/riscv/riscv-isa-sim</p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter2_installation/","title":"Chapter2 installation","text":""},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter2_installation/#_1","title":"\u7b2c\u4e8c\u7ae0\uff0e\u5b9e\u9a8c\u73af\u5883\u914d\u7f6e\u4e0e\u5b9e\u9a8c\u6784\u6210","text":""},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter2_installation/#_2","title":"\u76ee\u5f55","text":"<ul> <li>2.1 \u64cd\u4f5c\u7cfb\u7edf\u90e8\u5206\u5b9e\u9a8c\u73af\u5883\u5b89\u88c5</li> <li>2.1.1 \u5b89\u88c5\u5f00\u53d1\u73af\u5883</li> <li>2.1.2 \u5b89\u88c5\u652f\u6491\u8f6f\u4ef6</li> <li>2.1.3 \u5934\u6b4c\u5e73\u53f0 </li> <li>2.2 riscv-pke\uff08\u5b9e\u9a8c\uff09\u4ee3\u7801\u7684\u83b7\u53d6</li> <li>2.3 PKE\u5b9e\u9a8c\u6784\u6210</li> </ul>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter2_installation/#21","title":"2.1 \u64cd\u4f5c\u7cfb\u7edf\u90e8\u5206\u5b9e\u9a8c\u73af\u5883\u5b89\u88c5","text":""},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter2_installation/#211","title":"2.1.1 \u5b89\u88c5\u5f00\u53d1\u73af\u5883","text":"<p>\u5b89\u88c5\u5373\u5c06\u7f16\u8bd1\u3001\u6784\u5efa\uff08build\uff09\u548c\u6267\u884criscv-pke\u7684\u73af\u5883\uff0c\u6211\u4eec\u7ed9\u51fa\u4ee5\u4e0b3\u79cd\u9009\u62e9\uff1a</p> <p>\u65b9\u6848\u4e00\uff1aWindows Subversion Linux\uff08WSL\uff09</p> <p>\u5982\u679c\u8bfb\u8005\u7684\u5de5\u4f5c\u73af\u5883\u662fWindows10\u7684\u4e13\u4e1a\u7248\uff0c\u53ef\u91c7\u7528WSL\uff08Windows Subversion Linux\uff09+MobaXterm\u7684\u7ec4\u5408\u6765\u642d\u5efaPKE\u7684\u5b9e\u9a8c\u73af\u5883\u3002\u5728Windows10\u4e13\u4e1a\u7248\u4e0a\u914d\u7f6e\u8be5\u73af\u5883\u7684\u8bf4\u660e\uff0c\u53ef\u4ee5\u53c2\u8003\u8fd9\u91cc\u3002\u5173\u4e8eWSL\uff0c\u5e94\u5c3d\u91cf\u4f7f\u7528WSL1\u4e0d\u8981\u5347\u7ea7\u5230WSL2\uff0c\u56e0\u4e3a\u5982\u679c\u4ee3\u7801\u5b58\u653e\u7684\u4f4d\u7f6e\u5728/mnt\u76ee\u5f55\u4e0b\uff0cWSL1\u4e2d\u8fd0\u884c\u7f16\u8bd1\u3001\u6784\u5efa\u7684\u901f\u5ea6\u6bd4WSL2\u5feb\u5f88\u591a\uff08\u53c2\u8003\u8fd9\u91cc\uff09\u3002</p> <p>\u9700\u8981\u8bf4\u660e\u7684\u662f\uff0cPKE\u5b9e\u9a8c\u5e76\u4e0d\u9700\u8981\u4e2d\u6587\u5b57\u4f53\u3001\u56fe\u5f62\u754c\u9762\u6216\u8005JAVA\u7684\u652f\u6301\uff0c\u6240\u4ee5\u8bfb\u8005\u5728\u5b89\u88c5WSL\u7684\u8fc7\u7a0b\u4e2d\u65e0\u987b\u5b89\u88c5\u4e8e\u6c49\u5316\u76f8\u5173\u7684\u5305\uff0c\u4e5f\u65e0\u9700\u5b89\u88c5xfce\u3001JDK\u7b49\u3002\u53ea\u9700\u8981\u5b89\u88c5WSL\u7684\u57fa\u7840\u73af\u5883\u540e\uff0c\u518d\u6309\u7167\u4e0b\u4e00\u8282\u7684\u8bf4\u660e\u7ee7\u7eed\u5b8c\u6210rsicv-pke\u5f00\u53d1\u73af\u5883\u7684\u5b89\u88c5\u3002</p> <p>\u65b9\u6848\u4e8c\uff1aUbuntu\u6216\u8005\u5176\u4ed6Linux\u53d1\u884c\u7248</p> <p>\u8bfb\u8005\u53ef\u4ee5\u91c7\u7528VMware\u3001VirtualBox\u7b49\u8f6f\u4ef6\uff0c\u5728\u5ba2\u6237\u673a\u4e2d\u5b89\u88c5\u5ba2\u6237\u673a\uff0c\u518d\u5728\u5ba2\u6237\u673a\u4e2d\u5b89\u88c5\u6267\u884c\u652f\u6491\u8f6f\u4ef6\u6765\u6784\u5efa\u5b9e\u9a8c\u73af\u5883\u3002\u5ba2\u6237\u673a\u7684\u9009\u62e9\u6211\u4eec\u63a8\u8350\u91c7\u7528Ubuntu 16.04LTS\uff08x86_64\uff09\u6216\u66f4\u9ad8\u7248\u672c\u7684Ubuntu\u53d1\u884c\u7248\uff08\u598218.04LTS\u300120.04LTS\u6216\u66f4\u9ad8\uff09\u64cd\u4f5c\u7cfb\u7edf\uff0c\u6216\u8005\u534e\u4e3aopenEuler\u64cd\u4f5c\u7cfb\u7edf\u3002\u6211\u4eec\u672a\u5728\u5176\u4ed6\u7cfb\u7edf\uff08\u5982arch\uff0cRHEL\u7b49\uff09\u4e0a\u505a\u8fc7\u6d4b\u8bd5\uff0c\u4f46\u7406\u8bba\u4e0a\u53ea\u8981\u5c06\u5b9e\u9a8c\u4e2d\u6240\u6d89\u53ca\u5230\u7684\u5b89\u88c5\u5305\u66ff\u6362\u6210\u5176\u4ed6\u7cfb\u7edf\u4e2d\u7684\u7b49\u6548\u8f6f\u4ef6\u5305\uff0c\u5c31\u53ef\u5b8c\u6210\u540c\u6837\u6548\u679c\u3002</p> <p>\u65b9\u6848\u4e09\uff1a\u5934\u6b4c\u5b9e\u9a8c\u5e73\u53f0</p> <p>\u6211\u4eec\u5728EduCoder\u5b9e\u9a8c\u5e73\u53f0\uff08\u7f51\u5740\uff1ahttps://www.educoder.net \uff09\u4e0a\u521b\u5efa\u4e86riscv-pke\u7684\u540c\u6b65\u5b9e\u9a8c\u8bfe\u7a0b\uff0c\u8bfe\u7a0b\u7684\u7ec8\u7aef\u73af\u5883\uff08docker\u865a\u62df\u673a\uff09\u4e2d\u5df2\u5b8c\u6210\u5b9e\u9a8c\u6240\u9700\u8f6f\u4ef6\u5de5\u5177\u7684\u5b89\u88c5\uff0c\u6240\u4ee5\u5982\u679c\u8bfb\u8005\u662f\u5728\u5934\u6b4c\u5e73\u53f0\u4e0a\u9009\u62e9\u7684\u672c\u8bfe\u7a0b\uff0c\u5219\u53ef\u8df3\u8fc7\u672c\u8282\u7684\u5b9e\u9a8c\u73af\u5883\u642d\u5efa\u8fc7\u7a0b\u4ee5\u53ca\u6267\u884c\u652f\u6491\u8f6f\u4ef6\u7684\u5b89\u88c5\u8fc7\u7a0b\uff0c\u76f4\u63a5\u8fdb\u5165\u901a\u8fc7\u7ec8\u7aef\uff08\u547d\u4ee4\u884c\uff09\u8fdb\u5165\u5b9e\u9a8c\u73af\u5883\uff0c\u5934\u6b4c\u5b9e\u9a8c\u5e73\u53f0\u7684\u4f7f\u7528\u65b9\u6cd5\u89c12.1.3\u8282\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter2_installation/#212","title":"2.1.2 \u5b89\u88c5\u652f\u6491\u8f6f\u4ef6","text":"<p>riscv-pke\u7684\u6e90\u4ee3\u7801\u7684\u7f16\u8bd1\uff08compile\uff09\u3001\u6784\u5efa\uff08build\uff09\u9700\u8981\u4e13\u95e8\u7684risc-v\u4ea4\u53c9\u7f16\u8bd1\u5668\uff0c\u6240\u6784\u5efa\u7684\u4ee3\u7406\u5185\u6838\uff08\u53ca\u5e94\u7528\uff09\u7684\u6267\u884c\u4e5f\u9700\u8981\u4e13\u95e8\u7684risc-v\u865a\u62df\u673a\uff08spike\uff09\u7684\u652f\u6301\u3002\u8fd9\u4e00\u8282\u5c06\u4ecb\u7ecd\u8fd9\u4e9b\u652f\u6491\u8f6f\u4ef6\u7684\u5b89\u88c5\u8fc7\u7a0b\uff0c\u9700\u8981\u8bf4\u660e\u7684\u662f\uff0c\u8be5\u5b89\u88c5\u8fc7\u7a0b\u9002\u5408\u64cd\u4f5c\u7cfb\u7edf\u73af\u5883\uff08\u89c12.1.1\u8282\uff09\u4e3aWSL\uff0c\u6216\u8005Ubuntu\u53d1\u884c\u7248\u7684\u60c5\u51b5\u3002\u5bf9\u4e8e\u5934\u6b4c\u5b9e\u9a8c\u5e73\u53f0\uff0c\u5219\u65e0\u9700\u5bf9\u6267\u884c\u652f\u6491\u8f6f\u4ef6\u8fdb\u884c\u4efb\u4f55\u5b89\u88c5\u3002</p> <p>PKE\u5b9e\u9a8c\u6d89\u53ca\u5230\u7684\u6267\u884c\u652f\u6491\u8f6f\u4ef6\u6709\uff1a</p> <ul> <li>RISC-V\u4ea4\u53c9\u7f16\u8bd1\u5668\uff08\u53ca\u9644\u5e26\u7684\u4e3b\u673a\u7f16\u8bd1\u5668\u3001\u6784\u9020\u5de5\u5177\u7b49\uff09\uff1b</li> <li>spike\u6a21\u62df\u5668\uff1b</li> </ul> <p>\u4ee5\u4e0b\u5206\u522b\u4ecb\u7ecd\u8fd9\u4e9b\u6267\u884c\u652f\u6491\u8f6f\u4ef6\u7684\u5b89\u88c5\u8fc7\u7a0b\uff0c\u6211\u4eec\u7ed9\u51fa\u4ee5\u4e0b\u4e09\u79cd\u65b9\u6848\uff1a</p> <p>\u65b9\u6848\u4e00\uff1a\u4e0b\u8f7d\u81ea\u5305\u542b\u4ea4\u53c9\u7f16\u8bd1\u5668+\u6267\u884c\u73af\u5883</p> <p>\u25cf \u7b2c\u4e00\u6b65\uff0c\u5b89\u88c5\u4f9d\u8d56\u5e93</p> <p>RISC-V\u4ea4\u53c9\u7f16\u8bd1\u5668\u7684\u6267\u884c\u4ecd\u7136\u9700\u8981\u4e00\u4e9b\u672c\u5730\u652f\u6491\u8f6f\u4ef6\u5305\uff0c\u53ef\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u5b89\u88c5\uff1a</p> <p><code>$ sudo apt-get install autoconf automake autotools-dev curl libmpc-dev libmpfr-dev libgmp-dev gawk build-essential bison flex texinfo gperf libtool patchutils bc zlib1g-dev libexpat-dev device-tree-compiler</code></p> <p>\u25cf \u7b2c\u4e8c\u6b65\uff0c\u4e0b\u8f7d\u81ea\u5305\u542b\u4ea4\u53c9\u7f16\u8bd1\u5668+\u6267\u884c\u73af\u5883</p> <p>\u5230\u8fd9\u91cc\u4e0b\u8f7d\u81ea\u5305\u542b\u4ea4\u53c9\u7f16\u8bd1\u5668+\u6267\u884c\u73af\u5883\u7684tgz\u5305\uff08\u5927\u5c0f\u7ea6\u4e3a72MB\uff0c\u611f\u8c22\u5f20\u6770\u8001\u5e08\u4e3a\u5927\u5bb6\u5236\u4f5c\uff09\uff0c\u91c7\u7528\u4ee5\u4e0b\u547d\u4ee4\u89e3\u5f00tgz\u5305\uff1a</p> <p>$ tar xf riscv64-elf-gcc-20210923.tgz</p> <p>\u89e3\u538b\u5b8c\u6210\u540e\uff0c\u5c06\u5728\u5f53\u524d\u76ee\u5f55\u4ea7\u751f\u540d\u4e3ariscv64-elf-gcc\u7684\u76ee\u5f55\uff0c\u8be5\u76ee\u5f55\u4e0b\u5305\u542bRISC-V\u4ea4\u53c9\u7f16\u8bd1\u5668\u4ee5\u53caspike\u6a21\u62df\u5668\u3002</p> <p>\u25cf \u7b2c\u4e09\u6b65\uff0c\u8bbe\u7f6e\u73af\u5883\u53d8\u91cf</p> <p><code>$ export RISCV=$PWD/riscv64-elf-gcc</code></p> <p><code>$ export PATH=$PATH:$RISCV/bin</code></p> <p>\u4ee5\u4e0a\u547d\u4ee4\u8bbe\u7f6e\u4e86RISCV\u73af\u5883\u53d8\u91cf\uff0c\u6307\u5411\u5728\u7b2c\u4e8c\u6b65\u4e2d\u7684tgz\u5305\u5c55\u5f00\u76ee\u5f55\uff0c\u5e76\u4e14\u5c06\u4ea4\u53c9\u7f16\u8bd1\u5668\u7684\u53ef\u6267\u884c\u6587\u4ef6\u6240\u5728\u7684\u76ee\u5f55\u52a0\u5165\u5230\u4e86\u7cfb\u7edf\u8def\u5f84\u4e2d\u3002\u8fd9\u6837\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u5728riscv-pke\u7684\u5de5\u4f5c\u76ee\u5f55\u8c03\u7528RISC-V\u4ea4\u53c9\u7f16\u8bd1\u5668\u6240\u5305\u542b\u7684\u5de5\u5177\u8f6f\u4ef6\u4e86\u3002</p> <p>\u5efa\u8bae\u8bfb\u8005\u5c06\u4ee5\u4e0a\u4e24\u4e2aexport\u547d\u4ee4\uff0c\u52a0\u5165\u5230<code>~/.bashrc</code>\uff0c<code>~/.profile</code>\u6216 <code>/etc/profile</code>\u6587\u4ef6\u7684\u672b\u5c3e\uff08\u6ce8\u610f\u66ff\u6362$PWD\u73af\u5883\u53d8\u91cf\uff09\u3002\u8fd9\u6837\uff0c\u6bcf\u6b21\u91cd\u65b0\u542f\u52a8\uff08\u5e76\u6253\u5f00\u7ec8\u7aef\u7a0b\u5e8f\uff09\u540e\uff0c\u7cfb\u7edf\u4f1a\u81ea\u52a8\u8bbe\u7f6e\u8fd9\u4e24\u4e2a\u73af\u5883\u53d8\u91cf\uff0c\u800c\u4e0d\u7528\u6bcf\u6b21\u90fd\u8981\u624b\u52a8\u8f93\u5165\u4ee5\u4e0a\u547d\u4ee4\u3002</p> <p>\u65b9\u6848\u4e8c\uff1a\u5b8c\u6574\u81ea\u884c\u6784\u5efa\u4ea4\u53c9\u7f16\u8bd1\u5668\u548c\u6267\u884c\u73af\u5883</p> <p>\u5bf9\u4e8e\u65b0\u5b89\u88c5\u7684Ubuntu\u64cd\u4f5c\u7cfb\u7edf\uff0c\u6211\u4eec\u5f3a\u70c8\u5efa\u8bae\u8bfb\u8005\u5728\u65b0\u88c5\u73af\u5883\u4e2d\u5b8c\u6574\u6784\u5efa\uff08build\uff09RISC-V\u4ea4\u53c9\u7f16\u8bd1\u5668\uff0c\u4ee5\u53caspike\u6a21\u62df\u5668\u3002\u5982\u679c\u5f3a\u8c03\u73af\u5883\u7684\u53ef\u79fb\u690d\u6027\uff0c\u53ef\u4ee5\u8003\u8651\u5728\u865a\u62df\u673a\u4e2d\u5b89\u88c5\u5b8c\u6574\u7cfb\u7edf\u548c\u73af\u5883\uff0c\u4e4b\u540e\u5c06\u865a\u62df\u673a\u8fdb\u884c\u514b\u9686\u548c\u8fc1\u79fb\u3002</p> <p>RISC-V\u4ea4\u53c9\u7f16\u8bd1\u5668\u662f\u4e0eLinux\u81ea\u5e26\u7684GCC\u7f16\u8bd1\u5668\u7c7b\u4f3c\u7684\u4e00\u5957\u5de5\u5177\u8f6f\u4ef6\u96c6\u5408\uff0c\u4e0d\u540c\u7684\u662f\uff0cx86_64\u5e73\u53f0\u4e0aLinux\u81ea\u5e26\u7684GCC\u7f16\u8bd1\u5668\u4f1a\u5c06\u6e90\u4ee3\u7801\u7f16\u8bd1\u3001\u94fe\u63a5\u6210\u4e3a\u9002\u5408\u5728x86_64\u5e73\u53f0\u4e0a\u8fd0\u884c\u7684\u4e8c\u8fdb\u5236\u4ee3\u7801\uff08\u79f0\u4e3anative code\uff09\uff0c\u800cRISC-V\u4ea4\u53c9\u7f16\u8bd1\u5668\u5219\u4f1a\u5c06\u6e90\u4ee3\u7801\u7f16\u8bd1\u3001\u94fe\u63a5\u6210\u4e3a\u5728RISC-V\u5e73\u53f0\u4e0a\u8fd0\u884c\u7684\u4ee3\u7801\u3002\u540e\u8005\uff08RISC-V\u4ea4\u53c9\u7f16\u8bd1\u5668\u751f\u6210\u7684\u4e8c\u8fdb\u5236\u4ee3\u7801\uff09\u662f\u65e0\u6cd5\u5728x86_64\u5e73\u53f0\uff08\u5373x86_64\u67b6\u6784\u7684Ubuntu\u73af\u5883\u4e0b\uff09\u76f4\u63a5\u8fd0\u884c\u7684\uff0c\u5b83\u7684\u8fd0\u884c\u9700\u8981\u6a21\u62df\u5668\uff08\u6211\u4eec\u91c7\u7528\u7684spike\uff09\u7684\u652f\u6301\u3002</p> <p>\u4e00\u822c\u60c5\u51b5\u4e0b\uff0c\u6211\u4eec\u79f0x86_64\u67b6\u6784\u7684Ubuntu\u73af\u5883\u4e3ahost\uff0c\u800c\u5728host\u4e0a\u6267\u884cspike\u540e\u6240\u865a\u62df\u51fa\u6765\u7684RISC-V\u73af\u5883\uff0c\u5219\u88ab\u79f0\u4e3atarget\u3002RISC-V\u4ea4\u53c9\u7f16\u8bd1\u5668\u7684\u6784\u5efa\uff08build\uff09\u3001\u5b89\u88c5\u8fc7\u7a0b\u5982\u4e0b\uff1a</p> <p>\u25cf \u7b2c\u4e00\u6b65\uff0c\u5b89\u88c5\u4f9d\u8d56\u5e93</p> <p>RISC-V\u4ea4\u53c9\u7f16\u8bd1\u5668\u7684\u6784\u5efa\u9700\u8981\u4e00\u4e9b\u672c\u5730\u652f\u6491\u8f6f\u4ef6\u5305\uff0c\u53ef\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\u5b89\u88c5\uff1a</p> <p><code>$ sudo apt-get install autoconf automake autotools-dev curl libmpc-dev libmpfr-dev libgmp-dev gawk build-essential bison flex texinfo gperf libtool patchutils bc zlib1g-dev libexpat-dev device-tree-compiler</code></p> <p>\u25cf \u7b2c\u4e8c\u6b65\uff0c\u83b7\u53d6RISC-V\u4ea4\u53c9\u7f16\u8bd1\u5668\u7684\u6e90\u4ee3\u7801</p> <p>\u6709\u4e24\u79cd\u65b9\u5f0f\u83b7\u5f97RISC-V\u4ea4\u53c9\u7f16\u8bd1\u5668\u7684\u6e90\u4ee3\u7801\uff1a\u4e00\u79cd\u662f\u901a\u8fc7\u6e90\u4ee3\u7801\u4ed3\u5e93\u83b7\u53d6\uff0c\u4f7f\u7528\u4ee5\u4e0b\u547d\u4ee4\uff1a</p> <p><code>$ git clone --recursive https://github.com/riscv/riscv-gnu-toolchain.git</code></p> <p>\u4f46\u7531\u4e8eRISC-V\u4ea4\u53c9\u7f16\u8bd1\u5668\u7684\u4ed3\u5e93\u5305\u542b\u4e86Qemu\u6a21\u62df\u5668\u7684\u4ee3\u7801\uff0c\u4e0b\u8f7d\u540e\u7684\u76ee\u5f55\u5360\u7528\u7684\u78c1\u76d8\u7a7a\u95f4\u5927\u5c0f\u7ea6\u4e3a4.8GB\uff0c\uff08\u4ece\u56fd\u5185\u4e0b\u8f7d\uff09\u6574\u4f53\u4e0b\u8f7d\u6240\u9700\u7684\u65f6\u95f4\u8f83\u957f\u3002\u4e3a\u4e86\u65b9\u4fbf\u56fd\u5185\u7528\u6237\uff0c\u6211\u4eec\u63d0\u4f9b\u4e86\u53e6\u4e00\u79cd\u65b9\u5f0f\u5c31\u662f\u901a\u8fc7\u767e\u5ea6\u4e91\u76d8\u83b7\u53d6\u6e90\u4ee3\u7801\u538b\u7f29\u5305\uff0c\u94fe\u63a5\u548c\u63d0\u53d6\u7801\u5982\u4e0b\uff1a</p> <p><code>\u94fe\u63a5: https://pan.baidu.com/s/1cMGt0zWhRidnw7vNUGcZhg \u63d0\u53d6\u7801: qbjh</code></p> <p>\u4ece\u767e\u5ea6\u4e91\u76d8\u4e0b\u8f7dRISCV-packages/riscv-gnu-toolchain-clean.tar.gz\u6587\u4ef6\uff08\u5927\u5c0f\u4e3a2.7GB\uff09\uff0c\u518d\u5728Ubuntu\u73af\u5883\u4e0b\u89e3\u538b\u8fd9\u4e2a.tar.gz\u6587\u4ef6\uff0c\u91c7\u7528\u5982\u4e0b\u547d\u4ee4\u884c\uff1a</p> <p><code>$ tar xf  riscv-gnu-toolchain-clean.tar.gz</code></p> <p>\u4e4b\u540e\u5c31\u80fd\u591f\u770b\u5230\u548c\u8fdb\u5165\u5f53\u524d\u76ee\u5f55\u4e0b\u7684riscv-gnu-toolchain\u6587\u4ef6\u5939\u4e86\u3002</p> <p>\u25cf \u7b2c\u4e09\u6b65\uff0c\u6784\u5efa\uff08build\uff09RISC-V\u4ea4\u53c9\u7f16\u8bd1\u5668</p> <p><code>$ cd riscv-gnu-toolchain</code></p> <p><code>$ ./configure --prefix=[your.RISCV.install.path]</code></p> <p><code>$ make</code></p> <p>\u4ee5\u4e0a\u547d\u4ee4\u4e2d\uff0c[your.RISCV.install.path]\u6307\u5411\u7684\u662f\u4f60\u7684RISC-V\u4ea4\u53c9\u7f16\u8bd1\u5668\u5b89\u88c5\u76ee\u5f55\u3002\u5982\u679c\u5b89\u88c5\u662f\u4f60home\u76ee\u5f55\u4e0b\u7684\u4e00\u4e2a\u5b50\u76ee\u5f55\uff08\u5982~/riscv-install-dir\uff09\uff0c\u5219\u6700\u540e\u7684make install\u65e0\u9700sudoer\u6743\u9650\u3002\u4f46\u5982\u679c\u5b89\u88c5\u76ee\u5f55\u662f\u7cfb\u7edf\u76ee\u5f55\uff08\u5982/opt/riscv-install-dir\uff09\uff0c\u5219\u9700\u8981sudoer\u6743\u9650\uff08\u5373\u5728make install\u547d\u4ee4\u524d\u52a0\u4e0asudo\uff09\u3002</p> <p>\u25cf \u7b2c\u56db\u6b65\uff0c\u8bbe\u7f6e\u73af\u5883\u53d8\u91cf</p> <p><code>$ export RISCV=[your.RISCV.install.path]</code></p> <p><code>$ export PATH=$PATH:$RISCV/bin</code></p> <p>\u4ee5\u4e0a\u547d\u4ee4\u8bbe\u7f6e\u4e86RISCV\u73af\u5883\u53d8\u91cf\uff0c\u6307\u5411\u5728\u7b2c\u4e09\u6b65\u4e2d\u7684\u5b89\u88c5\u76ee\u5f55\uff0c\u5e76\u4e14\u5c06\u4ea4\u53c9\u7f16\u8bd1\u5668\u7684\u53ef\u6267\u884c\u6587\u4ef6\u6240\u5728\u7684\u76ee\u5f55\u52a0\u5165\u5230\u4e86\u7cfb\u7edf\u8def\u5f84\u4e2d\u3002\u8fd9\u6837\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u5728PKE\u7684\u5de5\u4f5c\u76ee\u5f55\u8c03\u7528RISC-V\u4ea4\u53c9\u7f16\u8bd1\u5668\u6240\u5305\u542b\u7684\u5de5\u5177\u8f6f\u4ef6\u4e86\u3002</p> <p>\u5efa\u8bae\u8bfb\u8005\u5c06\u4ee5\u4e0a\u4e24\u4e2aexport\u547d\u4ee4\uff0c\u52a0\u5165\u5230<code>~/.bashrc</code>\uff0c<code>~/.profile</code>\u6216 <code>/etc/profile</code>\u6587\u4ef6\u7684\u672b\u5c3e\u3002\u8fd9\u6837\uff0c\u6bcf\u6b21\u91cd\u65b0\u542f\u52a8\uff08\u5e76\u6253\u5f00\u7ec8\u7aef\u7a0b\u5e8f\uff09\u540e\uff0c\u7cfb\u7edf\u4f1a\u81ea\u52a8\u8bbe\u7f6e\u8fd9\u4e24\u4e2a\u73af\u5883\u53d8\u91cf\uff0c\u800c\u4e0d\u7528\u6bcf\u6b21\u90fd\u8981\u624b\u52a8\u8f93\u5165\u4ee5\u4e0a\u547d\u4ee4\u3002</p> <p>\u25cf \u7b2c\u4e94\u6b65\uff0c\u5b89\u88c5spike\u6a21\u62df\u5668</p> <p>\u63a5\u4e0b\u6765\uff0c\u5b89\u88c5spkie\u6a21\u62df\u5668\u3002\u9996\u5148\u53d6\u5f97spike\u7684\u6e90\u4ee3\u7801\uff0c\u6709\u4e24\u4e2a\u9014\u5f84\uff1a\u4e00\u4e2a\u662f\u4ecegithub\u4ee3\u7801\u4ed3\u5e93\u4e2d\u83b7\u53d6\uff1a</p> <p><code>$ git clone https://github.com/riscv/riscv-isa-sim.git</code></p> <p>\u4e5f\u53ef\u4ee5\u4ece\u767e\u5ea6\u4e91\u76d8\u4e2d\u4e0b\u8f7dspike-riscv-isa-sim.tar.gz\u6587\u4ef6\uff08\u7ea64.2MB\uff09\uff0c\u7136\u540e\u7528tar\u547d\u4ee4\u89e3\u538b\u7f29\u3002\u767e\u5ea6\u4e91\u76d8\u7684\u5730\u5740\uff0c\u4ee5\u53catar\u547d\u4ee4\u89e3\u538b\u7f29\u53ef\u4ee5\u53c2\u80032.1.1\u8282RISC-V\u4ea4\u53c9\u7f16\u8bd1\u5668\u7684\u5b89\u88c5\u8fc7\u7a0b\u3002\u83b7\u5f97spike\u6e90\u4ee3\u7801\u6216\u89e3\u538b\u540e\uff0c\u5c06\u5728\u672c\u5730\u76ee\u5f55\u770b\u5230\u4e00\u4e2ariscv-isa-sim\u76ee\u5f55\u3002</p> <p>\u63a5\u4e0b\u6765\u6784\u5efa\uff08build\uff09spike\uff0c\u5e76\u5b89\u88c5\uff1a</p> <p><code>$ cd riscv-isa-sim</code></p> <p><code>$ ./configure --prefix=$RISCV</code></p> <p><code>$ make</code></p> <p><code>$ make install</code></p> <p>\u5728\u4ee5\u4e0a\u547d\u4ee4\u4e2d\uff0c\u6211\u4eec\u5047\u8bbeRISCV\u73af\u5883\u53d8\u91cf\u5df2\u7ecf\u6307\u5411\u4e86RISC-V\u4ea4\u53c9\u7f16\u8bd1\u5668\u7684\u5b89\u88c5\u76ee\u5f55\uff0c\u5373[your.RISCV.install.path]\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter2_installation/#213","title":"2.1.3 \u5934\u6b4c\u5e73\u53f0","text":"<p>\u4e3a\u652f\u6491\u300a\u64cd\u4f5c\u7cfb\u7edf\u539f\u7406\u300b\u8bfe\u7a0b\u7684\u6559\u5b66\uff0cPKE\u7cfb\u5217\u5b9e\u9a8c\u5728\u5934\u6b4c\u5e73\u53f0\uff08educoder.net\uff09\u4e0a\u8fdb\u884c\u4e86\u90e8\u7f72\u3002</p> <p></p> <p>\u8bfb\u8005\u53ef\u4ee5\u5728\u5934\u6b4c\u5e73\u53f0\u7684\u4e3b\u9875\u4e0a\uff0c\u901a\u8fc7\u9009\u62e9\u5de6\u4e0a\u89d2\u7684\u201c\u5b9e\u8df5\u8bfe\u7a0b\u201d\u5165\u53e3\uff0c\u7136\u540e\u5728\u641c\u7d22\u6846\u4e2d\u8f93\u5165\u201c\u57fa\u4e8eRISCV\u7684\u64cd\u4f5c\u7cfb\u7edf\u5b9e\u9a8c\u201d\u627e\u5230PKE\u5b9e\u9a8c\u5bf9\u5e94\u7684\u5b9e\u8df5\u8bfe\u7a0b\uff1a</p> <p></p> <p>\u8fdb\u5165\u8bfe\u7a0b\u540e\uff0c\u53ef\u4ee5\u5148\u9605\u8bfb\u8bfe\u7a0b\u5b9e\u9a8c\u8bf4\u660e\uff0c\u7ffb\u5230\u8bfe\u7a0b\u4e0b\u7684\u5b9e\u9a8c\u540e\u5c31\u53ef\u4ee5\u901a\u8fc7\u70b9\u51fb\u201c\u5f00\u59cb\u5b9e\u6218\u201d\u6765\u8fdb\u5165\u5b9e\u9a8c\u4e86\u3002</p> <p></p> <p>\u8fdb\u5165\u5b9e\u6218\u540e\uff0c\u4f1a\u770b\u5230\u5982\u4e0b\u7684\u754c\u9762\uff1a</p> <p></p> <p>\u4ee5\u4e0a\u754c\u9762\u4e2d\uff0c\u5de6\u4fa7\u663e\u793a\u7684\u662f\u5b9e\u9a8c\u7684\u4efb\u52a1\u63cf\u8ff0\u4ee5\u53ca\u53c2\u8003\u6587\u732e\u94fe\u63a5\u3002\u53f3\u4fa7\u662f\u505a\u5b9e\u9a8c\u8981\u7528\u5230\uff08\u4fee\u6539\uff09\u7684\u6e90\u4ee3\u7801\u6587\u4ef6\uff0c\u5728\u53f3\u4fa7\u754c\u9762\u7684\u9876\u7aef\uff0c\u6709\u4e00\u4e2a\u201c\u547d\u4ee4\u884c\u201d\u6807\u7b7e\uff0c\u70b9\u51fb\u8fdb\u5165\u540e\u53ef\u8fdb\u5165\u547d\u4ee4\u884c\u6a21\u5f0f\uff1b\u9876\u7aef\u7684\u53f3\u4fa7\u7684\u6587\u4ef6\u5939\u56fe\u6807\u70b9\u51fb\u540e\u4f1a\u51fa\u73b0\u6574\u4e2a\u6587\u4ef6\u76ee\u5f55\u6811\uff0c\u8bfb\u8005\u53ef\u4ee5\u901a\u8fc7\u76ee\u5f55\u6811\u9009\u62e9\u8981\u9605\u8bfb\u7684\u6587\u4ef6\uff1b\u6700\u540e\uff0c\u5728\u53f3\u4e0b\u89d2\u6709\u4e2a\u201c\u8bc4\u6d4b\u201d\u6309\u94ae\uff0c\u8bfb\u8005\u53ef\u4ee5\u5728\u5b8c\u6210\u5b9e\u9a8c\u540e\u70b9\u51fb\u8be5\u6309\u94ae\u5bf9\u81ea\u5df1\u7684\u5b9e\u9a8c\u7ed3\u679c\u8fdb\u884c\u8bc4\u6d4b\u3002</p> <p>\u5b9e\u9645\u4e0a\uff0c\u8bfb\u8005\u770b\u5230\u7684\u8fd9\u4e2a\u754c\u9762\u80cc\u540e\u662f\u4e00\u4e2aLinux docker\u865a\u62df\u673a\uff0c\u5728\u8be5\u865a\u62df\u673a\u4e2d\u5df2\u7ecf\u5b89\u88c5\u597d\u4e86\u5b9e\u9a8c\u6240\u9700\u8981\u7684\u73af\u5883\u3002\u5305\u62ec\u5404\u79cd\u5f00\u53d1\u5de5\u5177\u5305\u3001RISC-V\u4ea4\u53c9\u7f16\u8bd1\u5668\u7b49\uff1b\u800c\u8bc4\u6d4b\u6309\u94ae\u6309\u4e0b\u540e\uff0c\u4f1a\u89e6\u53d1\u865a\u62df\u673a\u4e2d\u7684\u6784\u5efa\uff08build\uff09\u811a\u672c\uff0c\u8be5\u811a\u672c\u4f1a\u81ea\u52a8\u5bf9\u4ee3\u7801\u6811\u8fdb\u884c\u6784\u5efa\u3001\u6267\u884c\u7ed9\u5b9a\u7684\u7528\u6237\u7a0b\u5e8f\uff08\u5982lab1_1\u4e2d\u7684user/app_helloworld\uff09\u3001\u6700\u540e\u6839\u636e\u8f93\u51fa\u7684\u5185\u5bb9\u5bf9\u5b9e\u9a8c\u7ed3\u679c\u7684\u6b63\u786e\u6027\u8fdb\u884c\u5224\u65ad\u3002</p> <p>\u7136\u800c\uff0c\u7531\u4e8e\u5728\u5934\u6b4c\u5e73\u53f0\u4e0a\u7684\u8bfe\u7a0b\uff0c\u6bcf\u4e2a\u5b9e\u9a8c\u90fd\u5bf9\u5e94\u4e86\u4e00\u4e2a\u72ec\u7acb\u7684\u4ee3\u7801\u4ed3\u5e93\uff0c\u6240\u4ee5\u4ece\u4e00\u4e2a\u5b9e\u9a8c\u5230\u53e6\u4e00\u4e2a\u5b9e\u9a8c\u7684\u5207\u6362\u65e0\u6cd5\u901a\u8fc7<code>git merge</code>\u547d\u4ee4\u5b9e\u73b0\u5bf9\u4e0a\u4e00\u4e2a\u5b9e\u9a8c\u7684\u5b9e\u9a8c\u7ed3\u679c\u7684\u7ee7\u627f\u3002\u5b66\u751f\u5728\u8fdb\u884c\u5b9e\u9a8c\u5207\u6362\u65f6\uff0c\u9700\u8981\u5c06\u4e4b\u524d\u5b9e\u9a8c\u7684\u4ee3\u7801\u624b\u52a8\u5730\u8d34\u5165\u4e0b\u4e00\u4e2a\u5b9e\u9a8c\u7684\u5bf9\u5e94\u6587\u4ef6\u4e2d\u3002\u8fd9\u4e00\u70b9\uff0c\u6211\u4eec\u5728\u8bfe\u7a0b\u7684\u201c\u8bfe\u7a0b\u987b\u77e5\u201d\u4e2d\u505a\u4e86\u8bf4\u660e\u3002\u4e00\u4e2a\u6bd4\u8f83\u597d\u7684\u65b9\u6cd5\uff0c\u662f\u91c7\u7528\u7c7b\u4f3cNotepad++\u8fd9\u6837\u7c7b\u578b\u7684\u8f6f\u4ef6\uff0c\u8bb0\u5f55\u6bcf\u4e2a\u5b9e\u9a8c\u7684\u7b54\u6848\uff08\u5305\u62ec\u7b54\u6848\u6240\u5728\u7684\u6587\u4ef6\uff09\uff0c\u5e76\u5728\u5207\u6362\u5230\u4e0b\u4e00\u4e2a\u5b9e\u9a8c\u65f6\uff0c\u5c06\u7b54\u6848\u62f7\u8d1d\u7c98\u8d34\u5230\u5bf9\u5e94\u6587\u4ef6\u3002</p> <p>\u8003\u8651\u5230\u5934\u6b4c\u5e73\u53f0\u7684\u7528\u6237\u8eab\u4efd\uff08\u4e3b\u8981\u6709\u8001\u5e08\u548c\u5b66\u751f\uff09\u7684\u4e0d\u540c\uff0c\u4ee5\u53ca\u8001\u5e08\u5f00\u8bfe\u548c\u5b66\u751f\u9009\u8bfe\u7684\u8fc7\u7a0b\u7684\u4e0d\u540c\uff0c\u5934\u6b4c\u5e73\u53f0\u7ed9\u51fa\u4e86\u6559\u5e08\u4f7f\u7528\u624b\u518c\u548c\u5b66\u751f\u4f7f\u7528\u624b\u518c\u3002\u7b80\u5355\u6765\u8bf4\uff0c\u4e3a\u4e86\u5c06\u5934\u6b4c\u5e73\u53f0\u4e0a\u7684PKE\u5b9e\u9a8c\u8bfe\u7a0b\u5e94\u7528\u5230\u300a\u64cd\u4f5c\u7cfb\u7edf\u539f\u7406\u300b\u8bfe\u7a0b\u6559\u5b66\uff0c\u6559\u5e08\u9700\u8981\u5728\u5934\u6b4c\u5e73\u53f0\u4e0a\u5efa\u7acb\u4e00\u4e2a\u6559\u5b66\u8bfe\u5802\uff0c\u5e76\u5728\u8be5\u6559\u5b66\u8bfe\u5802\u4e2d\u9009\u7528\u201c\u57fa\u4e8eRISCV\u7684\u64cd\u4f5c\u7cfb\u7edf\u5b9e\u9a8c\u201d\u8bfe\u7a0b\uff0c\u5c06\u8be5\u5b9e\u9a8c\u8bfe\u7a0b\u4e2d\u7684\u5b9e\u9a8c\u6709\u9009\u62e9\u6027\u7684\u5bfc\u5165\u5230\u6240\u5efa\u7acb\u7684\u6559\u5b66\u8bfe\u5802\u4e2d\uff0c\u5e76\u6700\u540e\u5427\u6240\u5efa\u7acb\u7684\u6559\u5b66\u8bfe\u5802\u7684\u9080\u8bf7\u7801\u53d1\u7ed9\u5b66\u751f\u3002\u5bf9\u4e8e\u5b66\u751f\u800c\u8a00\uff0c\u53ea\u9700\u8981\u7528\u8001\u5e08\u6240\u7ed9\u7684\u9080\u8bf7\u7801\u5728\u5934\u6b4c\u5e73\u53f0\u4e0a\u52a0\u5165\u6559\u5b66\u8bfe\u5802\u5373\u53ef\u3002\u4ee5\u4e0a\u8fc7\u7a0b\u90fd\u53ef\u4ee5\u901a\u8fc7\u5934\u6b4c\u4e3b\u9875\u53f3\u4e0a\u4fa7\u7684\u201c+\u201d\u7b26\u53f7\uff08\u5c06\u9f20\u6807\u79fb\u52a8\u5230\u8be5\u7b26\u53f7\u4e0a\uff09\u5bf9\u5e94\u7684\u5f39\u51fa\u83dc\u5355\u4e2d\u9009\u62e9\u5373\u53ef\u3002</p> <p>\u201c\u57fa\u4e8eRISCV\u7684\u64cd\u4f5c\u7cfb\u7edf\u5b9e\u9a8c\u201d\u8bfe\u7a0b\u7684\u8bbe\u8ba1\uff0c\u5145\u5206\u8003\u8651\u5230\u4e86\u5b9e\u9a8c\u7684\u6a21\u5757\u5316\u4ee5\u53ca\u5b66\u5236\u5b89\u6392\u7684\u95ee\u9898\u3002\u8bfe\u7a0b\u5171\u8bbe\u8ba1\u4e8615\u4e2a\u5b9e\u9a8c\uff0c\u5176\u4e2d\u5305\u542b9\u4e2a\u57fa\u7840\u5b9e\u9a8c\u548c6\u4e2a\u6311\u6218\u5b9e\u9a8c\uff08\u968f\u7740\u65f6\u95f4\u63a8\u79fb\uff0c\u8fd9\u4e2a\u5217\u8868\u53ef\u80fd\u4f1a\u8fdb\u4e00\u6b65\u589e\u52a0\uff09\uff0c\u5b9e\u9a8c\u95f4\u7684\u5173\u8054\u89c1PKE\u5b9e\u9a8c\u7684\u7ec4\u6210\u3002\u6559\u5e08\u5f00\u8bbe\u6559\u5b66\u8bfe\u5802\u7684\u65f6\u5019\uff0c\u53ef\u4ee5\u6839\u636e\u5b66\u751f\u7684\u6c34\u5e73\u3001\u6559\u5b66\u9884\u671f\u6309\u9700\u9009\u62e9\u4e0d\u540c\u7684\u5b9e\u9a8c\u5185\u5bb9\uff0c\u5206\u671f\u5206\u6279\u5730\u7ed9\u5b66\u751f\u5b89\u6392\u5b9e\u9a8c\u4efb\u52a1\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter2_installation/#22-riscv-pke","title":"2.2 riscv-pke\uff08\u5b9e\u9a8c\uff09\u4ee3\u7801\u7684\u83b7\u53d6","text":"<p>\u4ee5\u4e0b\u8ba8\u8bba\uff0c\u6211\u4eec\u5047\u8bbe\u8bfb\u8005\u662f\u4f7f\u7528\u7684Ubuntu/openEuler\u64cd\u4f5c\u7cfb\u7edf\uff0c\u4e14\u5df2\u6309\u71672.1.2\u7684\u8bf4\u660e\u5b89\u88c5\u4e86\u9700\u8981\u7684\u5de5\u5177\u8f6f\u4ef6\u3002\u5bf9\u4e8e\u5934\u6b4c\u5e73\u53f0\u800c\u8a00\uff0c\u4ee3\u7801\u5df2\u7ecf\u90e8\u7f72\u5230\u5b9e\u9a8c\u73af\u5883\uff0c\u8bfb\u8005\u53ef\u4ee5\u901a\u8fc7\u5934\u6b4c\u7f51\u7ad9\u754c\u9762\u6216\u8005\u754c\u9762\u4e0a\u7684\u201c\u547d\u4ee4\u884c\u201d\u9009\u9879\u770b\u5230\u5b9e\u9a8c\u4ee3\u7801\uff0c\u6240\u4ee5\u5934\u6b4c\u5e73\u53f0\u7528\u6237\u65e0\u987b\u8003\u8651\u4ee3\u7801\u83b7\u53d6\u73af\u8282\u3002</p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter2_installation/#_3","title":"\u4ee3\u7801\u83b7\u53d6","text":"<p>\u5728Ubuntu/WSL/openEuler\u64cd\u4f5c\u7cfb\u7edf\uff0c\u53ef\u4ee5\u901a\u8fc7\u4ee5\u4e0b\u547d\u4ee4\u4e0b\u8f7driscv-pke\u7684\u5b9e\u9a8c\u4ee3\u7801\uff1a</p> <p>\uff08\u514b\u9686\u4ee3\u7801\u4ed3\u5e93\uff09</p> <pre><code>`$ git clone https://gitee.com/hustos/riscv-pke.git\nCloning into 'riscv-pke-prerelease'...\nremote: Enumerating objects: 195, done.\nremote: Counting objects: 100% (195/195), done.\nremote: Compressing objects: 100% (195/195), done.\nremote: Total 227 (delta 107), reused 1 (delta 0), pack-reused 32\nReceiving objects: 100% (227/227), 64.49 KiB | 335.00 KiB/s, done.\nResolving deltas: 100% (107/107), done.`\n</code></pre> <p>\u514b\u9686\u5b8c\u6210\u540e\uff0c\u5c06\u5728\u5f53\u524d\u76ee\u5f55\u5e94\u8be5\u80fd\u770b\u5230riscv-pke-prerelease\u76ee\u5f55\u3002\u8fd9\u65f6\uff0c\u53ef\u4ee5\u5230riscv-pke\u76ee\u5f55\u4e0b\u67e5\u770b\u6587\u4ef6\u7ed3\u6784\uff0c\u4f8b\u5982\uff1a</p> <p><code>$ cd riscv-pke</code></p> <p>\u5207\u6362\u5230lab1_1_syscall\u5206\u652f\uff08\u56e0\u4e3alab1_1_syscall\u662f\u9ed8\u8ba4\u5206\u652f\uff0c\u8fd9\u91cc\u4e5f\u53ef\u4ee5\u4e0d\u5207\u6362\uff09 <code>$ git checkout lab1_1_syscall</code></p> <p><code>$ tree -L 3</code></p> <p>\uff08\u5c06\u770b\u5230\u5982\u4e0b\u8f93\u51fa\uff09</p> <pre><code>.\n\u251c\u2500\u2500 LICENSE.txt\n\u251c\u2500\u2500 Makefile\n\u251c\u2500\u2500 README.md\n\u251c\u2500\u2500 kernel\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 config.h\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 elf.c\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 elf.h\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 kernel.c\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 kernel.lds\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 machine\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u251c\u2500\u2500 mentry.S\n\u2502\u00a0\u00a0 \u2502\u00a0\u00a0 \u2514\u2500\u2500 minit.c\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 process.c\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 process.h\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 riscv.h\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 strap.c\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 strap.h\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 strap_vector.S\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 syscall.c\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 syscall.h\n\u251c\u2500\u2500 spike_interface\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 atomic.h\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 dts_parse.c\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 dts_parse.h\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 spike_file.c\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 spike_file.h\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 spike_htif.c\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 spike_htif.h\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 spike_memory.c\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 spike_memory.h\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 spike_utils.c\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 spike_utils.h\n\u251c\u2500\u2500 user\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 app_helloworld.c\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 user.lds\n\u2502\u00a0\u00a0 \u251c\u2500\u2500 user_lib.c\n\u2502\u00a0\u00a0 \u2514\u2500\u2500 user_lib.h\n\u2514\u2500\u2500 util\n    \u251c\u2500\u2500 functions.h\n    \u251c\u2500\u2500 load_store.S\n    \u251c\u2500\u2500 snprintf.c\n    \u251c\u2500\u2500 snprintf.h\n    \u251c\u2500\u2500 string.c\n    \u251c\u2500\u2500 string.h\n    \u2514\u2500\u2500 types.h\n</code></pre> <p>\u5728\u4ee3\u7801\u7684\u6839\u76ee\u5f55\u6709\u4ee5\u4e0b\u6587\u4ef6\uff1a</p> <ul> <li> <p>Makefile\u6587\u4ef6\uff0c\u5b83\u662fmake\u547d\u4ee4\u5373\u5c06\u4f7f\u7528\u7684\u201c\u81ea\u52a8\u5316\u7f16\u8bd1\u201d\u811a\u672c\uff1b</p> </li> <li> <p>LICENSE.txt\u6587\u4ef6\uff0c\u5373riscv-pke\u7684\u7248\u6743\u6587\u4ef6\uff0c\u91cc\u9762\u5305\u542b\u4e86\u6240\u6709\u53c2\u4e0e\u5f00\u53d1\u7684\u4eba\u5458\u4fe1\u606f\u3002riscv-pke\u662f\u5f00\u6e90\u8f6f\u4ef6\uff0c\u4f60\u53ef\u4ee5\u4ee5\u4efb\u610f\u65b9\u5f0f\u81ea\u7531\u5730\u4f7f\u7528\uff0c\u524d\u63d0\u662f\u4f7f\u7528\u65f6\u5305\u542bLICENSE.txt\u6587\u4ef6\u5373\u53ef\uff1b</p> </li> <li> <p>README.md\u6587\u4ef6\uff0c\u4e00\u4e2a\u7b80\u8981\u7684\u82f1\u6587\u7248\u4ee3\u7801\u8bf4\u660e\u3002</p> </li> </ul> <p>\u53e6\u5916\u662f\u4e00\u4e9b\u5b50\u76ee\u5f55\uff0c\u5176\u4e2d\uff1a</p> <ul> <li>kernel\u76ee\u5f55\u5305\u542b\u4e86riscv-pke\u7684\u5185\u6838\u90e8\u5206\u4ee3\u7801\uff1b</li> <li>spike_interface\u76ee\u5f55\u662friscv-pke\u5185\u6838\u4e0espike\u6a21\u62df\u5668\u7684\u63a5\u53e3\u4ee3\u7801\uff08\u5982\u8bbe\u5907\u6811DTB\u3001\u4e3b\u673a\u8bbe\u5907\u63a5\u53e3HTIF\u7b49\uff09\uff0c\u7528\u4e8e\u63a5\u53e3\u7684\u521d\u59cb\u5316\u548c\u8c03\u7528\uff1b</li> <li>user\u76ee\u5f55\u5305\u542b\u4e86\u5b9e\u9a8c\u7ed9\u5b9a\u5e94\u7528\uff08\u5982lab1_1\u4e2d\u7684app_helloworld.c\uff09\uff0c\u4ee5\u53ca\u7528\u6237\u6001\u7684\u7a0b\u5e8f\u5e93\u6587\u4ef6\uff08\u5982lab1_1\u4e2d\u7684user_lib.c\uff09\uff1b</li> <li>util\u76ee\u5f55\u5305\u542b\u4e86\u4e00\u4e9b\u5185\u6838\u548c\u7528\u6237\u7a0b\u5e8f\u516c\u7528\u7684\u4ee3\u7801\uff0c\u5982\u5b57\u7b26\u4e32\u5904\u7406\uff08string.c\uff09\uff0c\u7c7b\u578b\u5b9a\u4e49\uff08types.h\uff09\u7b49\u3002</li> </ul>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter2_installation/#_4","title":"\u73af\u5883\u9a8c\u8bc1","text":"<p>\u5bf9\u4e8eUbuntu/WSL/openEuler\u7528\u6237\uff08\u5bf9\u4e8e\u5934\u6b4c\u7528\u6237\uff0c\u53ef\u4ee5\u901a\u8fc7\u9009\u62e9\u201c\u547d\u4ee4\u884c\u201d\u6807\u7b7e\uff0c\u8fdb\u5165shell\u73af\u5883\u3001\u8fdb\u5165\u63d0\u793a\u7684\u4ee3\u7801\u8def\u5f84\uff0c\u5f00\u59cb\u6784\u9020\u8fc7\u7a0b\uff09\uff0c\u53ef\u4ee5\u5728\u4ee3\u7801\u7684\u6839\u76ee\u5f55\uff08\u8fdb\u5165riscv-pke-prerelease\u5b50\u76ee\u5f55\u540e\uff09\u8f93\u5165\u4ee5\u4e0b\u6784\u9020\u547d\u4ee4\uff0c\u5e94\u770b\u5230\u5982\u4e0b\u8f93\u51fa\uff1a</p> <pre><code>$ make\ncompiling util/snprintf.c\ncompiling util/string.c\nlinking  obj/util.a ...\nUtil lib has been build into \"obj/util.a\"\ncompiling spike_interface/dts_parse.c\ncompiling spike_interface/spike_htif.c\ncompiling spike_interface/spike_utils.c\ncompiling spike_interface/spike_file.c\ncompiling spike_interface/spike_memory.c\nlinking  obj/spike_interface.a ...\nSpike lib has been build into \"obj/spike_interface.a\"\ncompiling kernel/syscall.c\ncompiling kernel/elf.c\ncompiling kernel/process.c\ncompiling kernel/strap.c\ncompiling kernel/kernel.c\ncompiling kernel/machine/minit.c\ncompiling kernel/strap_vector.S\ncompiling kernel/machine/mentry.S\nlinking obj/riscv-pke ...\nPKE core has been built into \"obj/riscv-pke\"\ncompiling user/app_helloworld.c\ncompiling user/user_lib.c\nlinking obj/app_helloworld ...\nUser app has been built into \"obj/app_helloworld\"\n</code></pre> <p>\u5982\u679c\u73af\u5883\u5b89\u88c5\u4e0d\u5bf9\uff08\u5982\u7f3a\u5c11\u5fc5\u8981\u7684\u652f\u6491\u8f6f\u4ef6\u5305\uff09\uff0c\u4ee5\u4e0a\u6784\u9020\u8fc7\u7a0b\u53ef\u80fd\u4f1a\u5728\u4e2d\u95f4\u62a5\u9519\uff0c\u5982\u679c\u78b0\u5230\u62a5\u9519\u60c5\u51b5\uff0c\u8bf7\u56de\u52302.2\u7684\u73af\u5883\u5b89\u88c5\u8fc7\u7a0b\u68c0\u67e5\u5b9e\u9a8c\u73af\u5883\u7684\u6b63\u786e\u6027\u3002</p> <p>\u6784\u9020\u5b8c\u6210\u540e\uff0c\u5728\u4ee3\u7801\u6839\u76ee\u5f55\u4f1a\u51fa\u73b0\u4e00\u4e2aobj\u5b50\u76ee\u5f55\uff0c\u8be5\u5b50\u76ee\u5f55\u5305\u542b\u4e86\u6784\u9020\u8fc7\u7a0b\u4e2d\u6240\u751f\u6210\u7684\u6240\u6709\u5bf9\u8c61\u6587\u4ef6\uff08.o\uff09\u3001\u7f16\u8bd1\u4f9d\u8d56\u6587\u4ef6\uff08.d\uff09\u3001\u9759\u6001\u5e93\uff08.a\uff09\u6587\u4ef6\uff0c\u548c\u6700\u7ec8\u76ee\u6807ELF\u6587\u4ef6\uff08\u5982./obj/riscv-pke\u548c./obj/app_helloworld\uff09\u3002</p> <p>\u8fd9\u65f6\uff0c\u6211\u4eec\u53ef\u4ee5\u5c1d\u8bd5\u501f\u52a9riscv-pke\u5185\u6838\u8fd0\u884capp_helloworld\u7684\u201cHello world!\u201d\u7a0b\u5e8f\uff1a</p> <pre><code>$ spike ./obj/riscv-pke ./obj/app_helloworld\nIn m_start, hartid:0\nHTIF is available!\n(Emulated) memory size: 2048 MB\nEnter supervisor mode...\nApplication: ./obj/app_helloworld\nApplication program entry point (virtual address): 0x0000000081000000\nSwitching to user mode...\ncall do_syscall to accomplish the syscall and lab1_1 here.\n\nSystem is shutting down with exit code -1.\n</code></pre> <p>\u5982\u679c\u80fd\u770b\u5230\u4ee5\u4e0a\u8f93\u51fa\uff0criscv-pke\u7684\u4ee3\u7801\u83b7\u53d6\uff08\u548c\u9a8c\u8bc1\uff09\u5c31\u5df2\u7ecf\u5b8c\u6210\uff0c\u53ef\u4ee5\u5f00\u59cb\u5b9e\u9a8c\u4e86\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter2_installation/#23-pke","title":"2.3 PKE\u5b9e\u9a8c\u7684\u7ec4\u6210","text":"<p>\u5bf9\u4e8e\u300a\u64cd\u4f5c\u7cfb\u7edf\u539f\u7406\u300b\u8bfe\u5802\u6765\u8bf4\uff0cPKE\u5b9e\u9a8c\u75313\u7ec4\u57fa\u7840\u5b9e\u9a8c\u4ee5\u53ca\u57fa\u7840\u8bd5\u9a8c\u540e\u7684\u6311\u6218\u5b9e\u9a8c\u7ec4\u6210\uff08\u89c1\u56fe1.2\uff09\uff1a</p> <ul> <li>\u5bf9\u4e8e\u57fa\u7840\u5b9e\u9a8c\u800c\u8a00\uff0c\u7b2c\u4e00\u7ec4\u57fa\u7840\u5b9e\u9a8c\u91cd\u70b9\u6d89\u53ca\u7cfb\u7edf\u8c03\u7528\u3001\u5f02\u5e38\u548c\u5916\u90e8\u4e2d\u65ad\u7684\u77e5\u8bc6\uff1b\u7b2c\u4e8c\u7ec4\u57fa\u7840\u5b9e\u9a8c\u91cd\u70b9\u6d89\u53ca\u4e3b\u5b58\u7ba1\u7406\u65b9\u9762\u7684\u77e5\u8bc6\uff1b\u7b2c\u4e09\u7ec4\u5b9e\u9a8c\u91cd\u70b9\u6d89\u53ca\u8fdb\u7a0b\u7ba1\u7406\u65b9\u9762\u7684\u77e5\u8bc6\u3002\u57fa\u7840\u5b9e\u9a8c\u90e8\u5206\u5b9e\u9a8c\u6307\u5bfc\u6587\u6863\u8f83\u4e3a\u8be6\u7ec6\uff0c\u5b66\u751f\uff08\u8bfb\u8005\uff09\u9700\u8981\u586b\u5199\u7684\u4ee3\u7801\u91cf\u5f88\u5c0f\uff0c\u53ef\u4ee5\u770b\u4f5c\u662f\u201c\u9605\u8bfb\u7406\u89e3+\u586b\u7a7a\u201d\u9898\uff0c\u6d89\u53ca\u7684\u77e5\u8bc6\u4e5f\u975e\u5e38\u57fa\u7840\u3002</li> <li>\u5bf9\u4e8e\u6311\u6218\u5b9e\u9a8c\u800c\u8a00\uff0c\u6bcf\u4e00\u7ec4\u5b9e\u9a8c\u7684\u6311\u6218\u5b9e\u9a8c\u90fd\u53ef\u4ee5\u7406\u89e3\u4e3a\u5728\u8be5\u7ec4\u5b9e\u9a8c\u4e0a\u7684\u6311\u6218\u6027\u5185\u5bb9\uff0c\u53ea\u7ed9\u51fa\u9898\u76ee\uff08\u5e94\u7528\u7a0b\u5e8f\uff09\u548c\u9884\u671f\u7684\u6548\u679c\uff08\u9700\u8981\u505a\u5230\u7684\u76ee\u6807\uff09\u3002\u8fd9\u4e00\u90e8\u5206\u5b9e\u9a8c\u6307\u5bfc\u6587\u6863\u53ea\u7ed9\u51fa\u5927\u7684\u65b9\u5411\uff0c\u9700\u8981\u5b66\u751f\uff08\u8bfb\u8005\uff09\u67e5\u9605\u548c\u7406\u89e3\u8f83\u591a\u8bfe\u5916\u5185\u5bb9\uff0c\u4e3a\u5b9e\u73b0\u9884\u671f\u7684\u6548\u679c\u9700\u8981\u586b\u5199\u7684\u4ee3\u7801\u91cf\u4e5f\u8f83\u5927\uff0c\u53ef\u4ee5\u770b\u4f5c\u662f\u201c\u4f5c\u6587\u9898\u201d\u3002</li> </ul> <p>\u5982\u56fe1.2\u6240\u793a\uff0c\u57fa\u7840\u5b9e\u9a8c\u90e8\u5206\u5b58\u5728\u7ee7\u627f\u6027\uff0c\u5373\u5b66\u751f\uff08\u8bfb\u8005\uff09\u9700\u8981\u6309\u7167\u5b9e\u7ebf\u7bad\u5934\u7684\u987a\u5e8f\u4f9d\u6b21\u5b8c\u6210\u5b9e\u9a8c\uff0c\u662f\u4e0d\u53ef\u8df3\u8dc3\u7684\uff01\u8fd9\u662f\u56e0\u4e3aPKE\u7684\u5b9e\u9a8c\u8bbe\u8ba1\uff0c\u540e\u4e00\u4e2a\u5b9e\u9a8c\u4f9d\u8d56\u524d\u4e00\u4e2a\u5b9e\u9a8c\u7684\u7b54\u6848\uff0c\u5728\u5f00\u59cb\u540e\u4e00\u4e2a\u5b9e\u9a8c\u524d\u9700\u8981\u5148\u5c06\u4e4b\u524d\u7684\u7b54\u6848\u7ee7\u627f\u4e0b\u6765\uff08\u901a\u8fc7git commit/git merge\u547d\u4ee4\uff09\u3002</p> <p>\u800c\u6311\u6218\u90e8\u5206\u7684\u5b9e\u9a8c\u53ea\u4f9d\u8d56\u4e8e\u6bcf\u7ec4\u5b9e\u9a8c\u7684\u6700\u540e\u4e00\u4e2a\u5b9e\u9a8c\uff0c\u4f8b\u5982\uff0c\u5982\u679c\u5b66\u751f\uff08\u8bfb\u8005\uff09\u5b8c\u6210\u4e86\u5b9e\u9a8c1\u76843\u4e2a\u57fa\u7840\u8bd5\u9a8c\u540e\uff0c\u5c31\u53ef\u4ee5\u5f00\u59cb\u505a\u5b9e\u9a8c1\u7684\u6311\u6218\u5b9e\u9a8c\u4e86\uff0c\u4e0d\u9700\u8981\u7b49\u5230\u5b8c\u6210\u6240\u6709\u57fa\u7840\u5b9e\u9a8c\u518d\u5f00\u59cb\u3002</p> <p></p> <p>\u56fe1.2 PKE\u5b9e\u9a8c\u7684\u7ec4\u7ec7\u7ed3\u6784</p> <p>PKE\u5b9e\u9a8c\u5373\u53ef\u7528\u4e8e\u81ea\u5b66\u76ee\u7684\uff0c\u4e5f\u53ef\u4ee5\u7528\u4e8e\u6559\u5b66\u76ee\u7684\u3002\u5bf9\u4e8e\u81ea\u5b66\u7684\u8bfb\u8005\uff0c\u53ef\u4ee5\u5b8c\u5168\u6309\u7167PKE\u6587\u6863\uff0c\u4ee5\u53ca\u5728gitee\u7684\u4ee3\u7801\u4ed3\u5e93\u4e2d\u6240\u83b7\u5f97\u7684\u4ee3\u7801\u8fdb\u884c\uff1b\u51fa\u4e8e\u6559\u5b66\u76ee\u7684\uff0c\u6240\u6709\u7684PKE\u5b9e\u9a8c\uff0c\u6211\u4eec\u90fd\u5728\u5934\u6b4c\u5e73\u53f0\u8fdb\u884c\u4e86\u90e8\u7f72\uff0c\u5b9e\u9a8c\u7ed3\u679c\u7684\u68c0\u6d4b\u5168\u90e8\u5728\u5934\u6b4c\u5e73\u53f0\u4e0a\u8fdb\u884c\uff0c\u5b9e\u9a8c\u5b8c\u6210\u540e\u5934\u6b4c\u5e73\u53f0\u4f1a\u751f\u6210\u5b9e\u9a8c\u60c5\u51b5\u7684\u7b80\u62a5\u3002\u6559\u5e08\u53ef\u4ee5\u6839\u636e\u7b80\u62a5\uff0c\u5bf9\u5b66\u751f\u7684\u5b9e\u9a8c\u5b8c\u6210\u60c5\u51b5\u7ed9\u51fa\u5177\u4f53\u7684\u5206\u6570\u3002</p> <p>\u8003\u8651\u5230\u300a\u64cd\u4f5c\u7cfb\u7edf\u539f\u7406\u300b\u8bfe\u5802\u7684\u5b9e\u9a8c\u5b89\u6392\uff0c\u5f88\u591a\u5b66\u6821\uff08\u4f8b\u5982\u534e\u4e2d\u79d1\u6280\u5927\u5b66\u8ba1\u7b97\u673a\u5b66\u9662\uff09\u662f\u5c06\u5b9e\u9a8c\u5206\u6210\u4e86\u4e24\u90e8\u5206\uff1a\u8bfe\u5185\u5b9e\u9a8c\u548c\u8bfe\u7a0b\u8bbe\u8ba1\u3002\u5982\u679c\u91c7\u7eb3PKE\u5b9e\u9a8c\uff0c\u6839\u636e\u5b66\u751f\u7684\u6c34\u5e73\uff0c\u6211\u4eec\u7ed9\u51fa\u4e24\u4e2a\u65b9\u6848\uff1a</p> <p>\u65b9\u6848\u4e00\uff08\u5b66\u751f\u5176\u4ed6\u8bfe\u7a0b\u8d1f\u62c5\u8f83\u91cd\uff0c\u6216\u4e0d\u5e0c\u671b\u5b9e\u9a8c\u592a\u96be\u7684\u60c5\u51b5\uff09\uff1a</p> <ul> <li>\u8bfe\u5185\u5b9e\u9a8c\u5305\u62ec\u6240\u6709\u7684\u57fa\u7840\u5b9e\u9a8c\uff1b</li> <li>\u8bfe\u7a0b\u8bbe\u8ba1\u5b66\u751f\u53ef\u5728\u6bcf\u7ec4\u5b9e\u9a8c\u4e2d\uff0c\u9009\u62e9\uff08\u5b66\u751f\u81ea\u9009\uff09\u4e00\u4e2a\u6311\u6218\u5b9e\u9a8c\u3002</li> </ul> <p>\u8fd9\u79cd\u60c5\u51b5\uff0c\u5bf9\u4e8e\u8bfe\u5185\u5b9e\u9a8c\u6211\u4eec\u7684\u5efa\u8bae\u662f\uff1a\u6bcf\u4e2a\u57fa\u7840\u5b9e\u9a8c=30\u5206\uff0c\u6bcf\u7ec4\u5b9e\u9a8c\u603b\u520690\u5206\uff1b3\u7ec4\u5b9e\u9a8c\u53d6\u5e73\u5747\u5206\uff08\u603b\u5206\u4ecd\u7136\u662f90\uff09\u540e\uff0c\u603b\u5206\u52a0\u4e0a\u5b9e\u9a8c\u62a5\u544a\u768410\u5206\uff0c\u7b49\u4e8e\u8bfe\u5185\u5b9e\u9a8c\u7684\u603b\u5206\u6570\uff1b\u5bf9\u4e8e\u8bfe\u7a0b\u8bbe\u8ba1\u6211\u4eec\u7684\u5efa\u8bae\u662f\uff1a\u6bcf\u4e2a\u6311\u6218\u5b9e\u9a8c=30\u5206\uff0c3\u4e2a\u6311\u6218\u5b9e\u9a8c\u603b\u5206\u6c42\u548c\uff08\u603b\u520690\uff09\uff0c\u6700\u540e\u52a0\u4e0a\u5b9e\u9a8c\u62a5\u544a\u768410\u5206\uff0c\u7b49\u4e8e\u8bfe\u7a0b\u8bbe\u8ba1\u7684\u603b\u5206\u6570\u3002</p> <p>\u65b9\u6848\u4e8c\uff08\u5b66\u751f\u5e73\u5747\u80fd\u529b\u8f83\u5f3a\uff0c\u4e14\u5e0c\u671b\u5b9e\u9a8c\u5206\u6570\u6709\u533a\u5206\u5ea6\u7684\u60c5\u51b5\uff09\uff1a</p> <ul> <li>\u8bfe\u5185\u5b9e\u9a8c\u5305\u62ec\u6240\u6709\u7684\u57fa\u7840\u5b9e\u9a8c\uff0c\u5916\u52a0\u57fa\u7840\u5b9e\u9a8c\u76841\u4e2a\uff08\u5b66\u751f\u81ea\u9009\uff09\u6311\u6218\u5b9e\u9a8c\uff1b</li> <li>\u8bfe\u7a0b\u8bbe\u8ba1\u5b66\u751f\u53ef\u5728\u6bcf\u7ec4\u5b9e\u9a8c\u4e2d\uff0c\u9009\u62e9\u4e4b\u524d\u672a\u5b8c\u6210\u7684\u4e00\u4e2a\u6311\u6218\u5b9e\u9a8c\u3002</li> </ul> <p>\u8fd9\u79cd\u60c5\u51b5\uff0c\u5bf9\u4e8e\u8bfe\u5185\u5b9e\u9a8c\u6211\u4eec\u7684\u5efa\u8bae\u662f\uff1a\u6bcf\u4e2a\u57fa\u7840\u5b9e\u9a8c=20\u5206\uff0c\u5916\u52a0\u4e00\u4e2a\u6311\u6218\u5b9e\u9a8c\uff0c\u6bcf\u7ec4\u5b9e\u9a8c\u603b\u5206\u662f3*20+30=90\u5206\uff1b3\u7ec4\u5b9e\u9a8c\u53d6\u5e73\u5747\u5206\uff08\u603b\u5206\u4ecd\u7136\u662f90\uff09\u540e\uff0c\u603b\u5206\u52a0\u4e0a\u5b9e\u9a8c\u62a5\u544a\u768410\u5206\uff0c\u7b49\u4e8e\u8bfe\u5185\u5b9e\u9a8c\u7684\u603b\u5206\u6570\uff1b\u5bf9\u4e8e\u8bfe\u7a0b\u8bbe\u8ba1\u6211\u4eec\u7684\u5efa\u8bae\u662f\uff1a\u6bcf\u4e2a\u6311\u6218\u5b9e\u9a8c=30\u5206\uff0c3\u4e2a\u6311\u6218\u5b9e\u9a8c\u603b\u5206\u6c42\u548c\uff08\u603b\u520690\uff09\uff0c\u6700\u540e\u52a0\u4e0a\u5b9e\u9a8c\u62a5\u544a\u768410\u5206\uff0c\u7b49\u4e8e\u8bfe\u7a0b\u8bbe\u8ba1\u7684\u603b\u5206\u6570\u3002</p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter3_traps/","title":"Chapter3 traps","text":""},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter3_traps/#1","title":"\u7b2c\u4e09\u7ae0\uff0e\u5b9e\u9a8c1\uff1a\u7cfb\u7edf\u8c03\u7528\u3001\u5f02\u5e38\u548c\u5916\u90e8\u4e2d\u65ad","text":""},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter3_traps/#_1","title":"\u76ee\u5f55","text":"<ul> <li>3.1 \u5b9e\u9a8c1\u7684\u57fa\u7840\u77e5\u8bc6 </li> <li>3.1.1 RISC-V\u7a0b\u5e8f\u7684\u7f16\u8bd1\u548c\u94fe\u63a5</li> <li>3.1.2 \u6307\u5b9a\u7b26\u53f7\u7684\u903b\u8f91\u5730\u5740</li> <li>3.1.3 \u4ee3\u7406\u5185\u6838\u7684\u6784\u9020\u8fc7\u7a0b</li> <li>3.1.4 \u4ee3\u7406\u5185\u6838\u7684\u542f\u52a8\u8fc7\u7a0b</li> <li>3.1.5 ELF\u6587\u4ef6\uff08app\uff09\u7684\u52a0\u8f7d\u8fc7\u7a0b</li> <li>3.1.6 spike\u7684HTIF\u63a5\u53e3</li> <li>3.2 lab1_1 \u7cfb\u7edf\u8c03\u7528 </li> <li>\u7ed9\u5b9a\u5e94\u7528</li> <li>\u5b9e\u9a8c\u5185\u5bb9</li> <li>\u5b9e\u9a8c\u6307\u5bfc</li> <li>3.3 lab1_2 \u5f02\u5e38\u5904\u7406 </li> <li>\u7ed9\u5b9a\u5e94\u7528</li> <li>\u5b9e\u9a8c\u5185\u5bb9</li> <li>\u5b9e\u9a8c\u6307\u5bfc</li> <li>3.4 lab1_3\uff08\u5916\u90e8\uff09\u4e2d\u65ad </li> <li>\u7ed9\u5b9a\u5e94\u7528</li> <li>\u5b9e\u9a8c\u5185\u5bb9</li> <li>\u5b9e\u9a8c\u6307\u5bfc</li> <li>3.5 lab1_challenge1 \u6253\u5370\u7528\u6237\u7a0b\u5e8f\u8c03\u7528\u6808\uff08\u96be\u5ea6\uff1a\u2605\u2605\u2605\u2606\u2606\uff09 </li> <li>\u7ed9\u5b9a\u5e94\u7528</li> <li>\u5b9e\u9a8c\u5185\u5bb9</li> <li>\u5b9e\u9a8c\u6307\u5bfc</li> <li>3.6 lab1_challenge2 \u6253\u5370\u5f02\u5e38\u4ee3\u7801\u884c\uff08\u96be\u5ea6\uff1a\u2605\u2605\u2605\u2606\u2606\uff09 </li> <li>\u7ed9\u5b9a\u5e94\u7528</li> <li>\u5b9e\u9a8c\u5185\u5bb9</li> <li>\u5b9e\u9a8c\u6307\u5bfc</li> </ul>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter3_traps/#31-1","title":"3.1 \u5b9e\u9a8c1\u7684\u57fa\u7840\u77e5\u8bc6","text":"<p>\u672c\u7ae0\u6211\u4eec\u5c06\u9996\u5148\u83b7\u5f97\u4ee3\u7801\uff0c\u63a5\u4e0b\u6765\u4ecb\u7ecd\u7a0b\u5e8f\u7684\u7f16\u8bd1\u94fe\u63a5\u548cELF\u6587\u4ef6\u7684\u57fa\u7840\u77e5\u8bc6\uff0c\u63a5\u7740\u8bb2\u8ff0riscv-pke\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u7684\u542f\u52a8\u539f\u7406\uff0c\u6700\u540e\u5f00\u59cb\u5b9e\u9a8c1\u76843\u4e2a\u5b9e\u9a8c\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter3_traps/#311-risc-v","title":"3.1.1 RISC-V\u7a0b\u5e8f\u7684\u7f16\u8bd1\u548c\u94fe\u63a5","text":"<p>\u4e0b\u9762\uff0c\u6211\u4eec\u5c06\u7b80\u8981\u4ecb\u7ecdRISC-V\u7a0b\u5e8f\u7684\u7f16\u8bd1\u548c\u94fe\u63a5\u76f8\u5173\u77e5\u8bc6\u3002\u8fd9\u91cc\uff0c\u6211\u4eec\u4ecd\u7136\u5047\u8bbe\u4f60\u5df2\u7ecf\u6309\u7167\u7b2c\u4e8c\u7ae0\u7684\u8981\u6c42\u5b8c\u6210\u4e86\u57fa\u4e8eUbuntu\u6216\u8005openEular\u7684\u5f00\u53d1\u73af\u5883\u6784\u5efa\uff0c\u5982\u679c\u662f\u5728\u5934\u6b4c\u5e73\u53f0\uff0c\u53ef\u4ee5\u901a\u8fc7\u4ed6\u4eec\u63d0\u4f9b\u7684\u4ea4\u4e92??\u8fdb\u5165\u7ec8\u7aef\u4f7f\u7528\uff08\u91cc\u9762\u7684\u4ea4\u53c9\u7f16\u8bd1\u5668\u5df2\u7ecf\u5b89\u88c5\u4e14\u5df2\u52a0\u5165\u7cfb\u7edf\u8def\u5f84\uff09\u3002\u5728PKE\u5b9e\u9a8c\u7684\u5f00\u53d1\u73af\u5883\u4e2d\uff0c\u6211\u4eec\u901a\u8fc7\u6a21\u62df\u5668\uff08spike\uff09\u6240\u6784\u5efa\u7684\u76ee\u6807\u673a\u662frisc-v\u673a\u5668\uff0c\u800c\u4e3b\u673a\u4e00\u822c\u91c7\u7528\u7684\u662f\u91c7\u7528x86\u6307\u4ee4\u96c6\u7684Intel\u5904\u7406\u5668\uff08openEular\u53ef\u80fd\u91c7\u7528\u7684\u662f\u57fa\u4e8eARM\u6307\u4ee4\u96c6\u7684\u534e\u4e3a\u9cb2\u9e4f\u5904\u7406\u5668\uff09\uff0c\u5728\u8fd9\u79cd\u914d\u7f6e\u4e0b\u6211\u4eec\u7684\u7a0b\u5e8f\uff0c\u5305\u62ecPKE\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u4ee5\u53ca\u5e94\u7528\u90fd\u901a\u8fc7\u4ea4\u53c9\u7f16\u8bd1\u5668\u6240\u63d0\u4f9b\u7684\u5de5\u5177\u8fdb\u884c\u7f16\u8bd1\u548c\u94fe\u63a5\u3002\u867d\u7136risc-v\u4ea4\u53c9\u7f16\u8bd1\u5668\u548c\u4e3b\u673a\u73af\u5883\u4e0b\u7684GCC\u662f\u540c\u4e00\u5957\u4f53\u7cfb\uff0c\u4f46\u5b83\u7684\u4f7f\u7528\u548c\u8f93\u51fa\u8fd8\u662f\u6709\u4e9b\u7ec6\u5fae\u7684\u4e0d\u540c\uff0c\u6240\u4ee5\u6709\u5fc5\u8981\u5bf9\u5b83\u8fdb\u884c\u4e00\u5b9a\u7684\u4e86\u89e3\u3002</p> <p>\u5b9e\u9645\u4e0a\uff0c\u91c7\u7528RV64G\u6307\u4ee4\u96c6\u7684RISC-V\u4f53\u7cfb\u7ed3\u6784\uff08\u53c2\u89c1\u7b2c\u4e00\u7ae0\u7684\u5185\u5bb9\uff09\u8ddf\u4f20\u7edf\u7684x86\u6216\u8005ARM\u4f53\u7cfb\u7ed3\u6784\u975e\u5e38\u7c7b\u4f3c\uff08\u4ece\u91c7\u7528\u7cbe\u7b80\u6307\u4ee4\u96c6\u8fd9\u4e2a\u89d2\u5ea6\uff0c\u8ddfARM\u66f4\u52a0\u7c7b\u4f3c\u4e00\u4e9b\uff09\uff0c\u4ece\u8f6f\u4ef6\u5c42\u9762\u4e0a\u6765\u770b\u4e5f\u6ca1\u6709\u4ec0\u4e48\u4e0d\u540c\u3002\u6240\u4ee5\uff0c\u4e3aRISC-V\u4f53\u7cfb\u7ed3\u6784\u7f16\u5199\u3001\u7f16\u8bd1\u548c\u94fe\u63a5\u7a0b\u5e8f\uff0c\u4ee5\u53caELF\u6587\u4ef6\u7684\u7ed3\u6784\u8fd9\u4e9b\u57fa\u7840\u77e5\u8bc6\uff0c\u8bfb\u8005\u53ef\u4ee5\u4ece\u300a\u8ba1\u7b97\u673a\u7cfb\u7edf\u57fa\u7840\u300b\u8bfe\u7a0b\u7684\u7b2c\u56db\u7ae0\uff08\u91c7\u7528x86\u6307\u4ee4\u96c6\uff09\u91cc\u627e\u5230\uff0c\u4ee5\u4e0b\u7684\u8bb2\u89e3\u6211\u4eec\u5c06\u66f4\u4fa7\u91cd\u7528\u6211\u4eec\u7684PKE\u5b9e\u9a8c\u91cc\u53ef\u80fd\u78b0\u5230\u7684\u95ee\u9898\u3002</p> <p>\u6211\u4eec\u77e5\u9053\uff0c\u91c7\u7528C\u8bed\u8a00\u7f16\u5199\u4e00\u4e2a\u5e94\u7528\u7684\u8fc7\u7a0b\u5927\u6982\u53ef\u4ee5\u5f52\u7eb3\u4e3a\uff1a\u9996\u5148\uff0c\u7f16\u8f91\uff08edit\uff09.c\u7684\u6e90\u6587\u4ef6\uff1b\u63a5\u4e0b\u6765\uff0c\u7f16\u8bd1\uff08compile\uff09\u4e3a\u5bf9\u8c61\u6587\u4ef6.o\uff1b\u6700\u540e\uff0c\u5c06\u5bf9\u8c61\u6587\u4ef6\u94fe\u63a5\uff08link\uff09\u4e3a\u53ef\u6267\u884c\u7a0b\u5e8f\u6587\u4ef6\u3002\u5f53\u7136\uff0c\u5728\u4ece\u6e90\u4ee3\u7801\u7f16\u8bd1\u4e3a\u5bf9\u8c61\u6587\u4ef6\u7684\u8fc7\u7a0b\u4e2d\uff0c\u53ef\u80fd\u4f1a\u51fa\u73b0\u8bed\u6cd5\u9519\u8bef\uff1b\u518d\u94fe\u63a5\u8fc7\u7a0b\u4e2d\uff0c\u4e5f\u53ef\u80fd\u51fa\u73b0\u7b26\u53f7\u627e\u4e0d\u5230\u6216\u51fd\u6570\u672a\u5b9a\u4e49\u7684\u9519\u8bef\uff0c\u8fd9\u4e9b\u9519\u8bef\u90fd\u9700\u8981\u6211\u4eec\u56de\u5230\u6e90\u4ee3\u7801\u6216\u8005\u4fee\u6539\u94fe\u63a5\u547d\u4ee4\u884c\u6765\u8fdb\u884c\u4fee\u6b63\uff0c\u5e76\u6700\u7ec8\u5f97\u5230\u7b26\u5408\u9884\u671f\u7684\u5e94\u7528\u7a0b\u5e8f\u3002</p> <ul> <li>\u7f16\u8f91</li> </ul> <p>\u4f8b\u5982\uff0c\u6211\u4eec\u6709\u4ee5\u4e0b\u7b80\u5355Hello world!\u7a0b\u5e8f\uff08\u5728\u5f53\u524d\u76ee\u5f55\u7f16\u8f91helloworld.c\u6587\u4ef6\uff09\uff1a</p> <pre><code>  1 #include &lt;stdio.h&gt;\n2\n3 int main()\n4 {\n5   printf( \"Hello world!\\n\" );\n6   return 0;\n7 }\n</code></pre> <ul> <li>\u7f16\u8bd1</li> </ul> <p>\u4f7f\u7528\u4ea4\u53c9\u7f16\u8bd1\u5668\u5bf9\u4ee5\u4e0a\u7a0b\u5e8f\u8fdb\u884c\u7f16\u8bd1\uff1a</p> <p><code>$ riscv64-unknown-elf-gcc -c ./helloworld.c</code></p> <p>\u4ee5\u4e0a\u547d\u4ee4\u4e2d<code>-c</code>\u5f00\u5173\u544a\u8bc9riscv64-unknown-elf-gcc\u547d\u4ee4\u53ea\u5bf9\u6e90\u4ee3\u7801\u505a\u7f16\u8bd1\uff0c\u5373compile\u52a8\u4f5c\u3002\u5982\u679c\u4e0d\u52a0\u8be5\u5f00\u5173\uff0cgcc\u9ed8\u8ba4\u5730\u5c06\u5bf9\u6e90\u6587\u4ef6\u8fdb\u884c\u7f16\u8bd1+\u94fe\u63a5\u52a8\u4f5c\uff0c\u76f4\u63a5\u751f\u6210\u53ef\u6267\u884c\u7a0b\u5e8f\u3002</p> <p>\u8be5\u547d\u4ee4\u6267\u884c\u540e\uff0c\u6211\u4eec\u5c06\u5728\u5f53\u524d\u76ee\u5f55\u5f97\u5230helloworld.o\u6587\u4ef6\uff0c\u4f7f\u7528file\u547d\u4ee4\u5bf9\u8be5\u6587\u4ef6\u8fdb\u884c\u89c2\u5bdf\uff1a</p> <pre><code>$ file ./helloworld.o\n./helloworld.o: ELF 64-bit LSB relocatable, UCB RISC-V, version 1 (SYSV), not stripped\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0chelloworld.o\u6587\u4ef6\u7684\u5c5e\u6027\u4e3a\uff1a</p> <ol> <li>ELF 64-bit: 64\u4f4d\u7684ELF\u6587\u4ef6\uff1b</li> <li>LSB: \u4f4e\u4f4d\u6709\u6548\uff0c\u5373\u4f4e\u5730\u5740\u5b58\u653e\u6700\u4f4e\u6709\u6548\u5b57\u8282\u3002\u5173\u4e8eLSB\u548cMSB\u53c2\u89c1\u767e\u5ea6\u77e5\u9053\u7684\u89e3\u91ca\uff1b</li> <li>relocatable\uff1a\u53ef\u6d6e\u52a8\u4ee3\u7801\uff0c\u610f\u5473\u7740\u8be5ELF\u6587\u4ef6\u4e2d\u7684\u7b26\u53f7\u5e76\u65e0\u6307\u5b9a\u7684\u903b\u8f91\u5730\u5740\uff1b</li> <li>UCB RISC-V\uff1a\u4ee3\u7801\u7684\u76ee\u6807\u6307\u4ee4\u96c6\u4e3aRISC-V\u6307\u4ee4\u96c6\uff1b</li> <li>version 1 (SYSV)\uff1a\u8bf4\u660e\u8be5ELF\u6587\u4ef6\u662fSYSV\u7248\u672c\u7684\uff0c\u5373ELF\u5934\u4e2d\u7684e_ident [EI_OSABI]\u5b57\u6bb5\u8bbe\u7f6e\u4e3a0\uff1b</li> <li> <p>not stripped\uff1a\u8bf4\u660e\u8be5ELF\u6587\u4ef6\u4fdd\u7559\u4e86\u7a0b\u5e8f\u4e2d\u7684\u7b26\u53f7\u8868\uff08symbol table\uff09\u3002\u7b26\u53f7\uff08symbol\uff09\u5e7f\u6cdb\u5b58\u5728\u4e8e\u6211\u4eec\u7f16\u5199\u7684\u6e90\u7a0b\u5e8f\u4e2d\uff0c\u7f16\u8bd1\u5668\u4f1a\u628a\u6240\u6709\u51fd\u6570\u540d\u3001\u53d8\u91cf\u540d\u5904\u7406\u4e3a\u7b26\u53f7\u3002\u4f8b\u5982\uff0chelloworld.c\u4e2d\u7684main\u5c31\u662f\u4e00\u4e2a\u7b26\u53f7\u3002</p> </li> <li> <p>\u94fe\u63a5</p> </li> </ol> <p>\u6700\u540e\uff0c\u6211\u4eec\u5bf9\u751f\u6210\u7684\u76ee\u6807\u6587\u4ef6\u8fdb\u884c\u94fe\u63a5\uff1a</p> <p><code>$ riscv64-unknown-elf-gcc -o ./helloworld ./helloworld.o</code></p> <p>\u8be5\u547d\u4ee4\u5c06\u5728\u5f53\u524d\u76ee\u5f55\u751f\u6210helloworld\u6587\u4ef6\uff0c\u6211\u4eec\u4ecd\u7136\u7528file\u547d\u4ee4\u67e5\u770b\u8be5\u6587\u4ef6\u7684\u4fe1\u606f\uff1a</p> <pre><code>$ file ./helloworld\n./helloworld: ELF 64-bit LSB executable, UCB RISC-V, version 1 (SYSV), statically linked, not stripped\n</code></pre> <p>\u5bf9\u6bd4\u4e8ehelloworld.o\u6587\u4ef6\uff0c\u6211\u4eec\u53d1\u73b0helloworld\u6587\u4ef6\u662f\u53ef\u6267\u884c\uff08executable\uff09\u6587\u4ef6\u800c\u4e0d\u662f\u53ef\u6d6e\u52a8\u4ee3\u7801\uff0c\u4e5f\u5c31\u662f\u8bf4\u901a\u8fc7\u94fe\u63a5\uff0c\u5df2\u7ecf\u7ed9\u6e90\u4ee3\u7801\u4e2d\u7684\u7b26\u53f7\u6307\u5b9a\u597d\u4e86\u903b\u8f91\u5730\u5740\u3002\u53e6\u5916\uff0cstatically linked\u8bf4\u660ehelloworld\u7a0b\u5e8f\u662f\u901a\u8fc7\u9759\u6001\u94fe\u63a5\u751f\u6210\u7684\u3002\u5b9e\u9645\u4e0a\uff0cnewlib\u7248\u672c\u7684RISC-V\u4ea4\u53c9\u7f16\u8bd1\uff08\u4e5f\u5c31\u662f\u6211\u4eec\u7528\u7684riscv64-unknown-elf-gcc\uff09\u9ed8\u8ba4\u4f1a\u5c06\u8f93\u5165\u7a0b\u5e8f\u4e0e\u5b83\u81ea\u5e26\u7684\u9759\u6001\u5e93\u8fdb\u884c\u94fe\u63a5\uff0c\u4ece\u800c\u751f\u6210\u76f4\u63a5\u53ef\u4ee5\u5728RISC-V\u673a\u5668\u4e0a\u6267\u884c\u7684\u53ef\u6267\u884c\u4ee3\u7801\u3002\u5177\u4f53\u5230helloworld.c\u7a0b\u5e8f\uff0c\u5b83\u6240\u8c03\u7528\u7684printf\u51fd\u6570\u5c06\u4ece\u4ea4\u53c9\u7f16\u8bd1\u5668\u7684\u9759\u6001\u5e93\u4e2d\u83b7\u5f97\uff0c\u5e76\u5728\u6700\u7ec8\u751f\u6210\u7684./helloworld\u6ce8\u5165printf\u51fd\u6570\u7684\u5b9e\u73b0\u3002\u8fd9\u6837\uff0c./helloworld\u7684\u6267\u884c\u5c06\u65e0\u9700\u4f9d\u8d56\u5176\u4ed6\u52a8\u6001\u5e93\uff0c\u907f\u514d\u4e8c\u8fdb\u5236\u7a0b\u5e8f\u56e0\u7f3a\u5c11\u4e8c\u8fdb\u5236\u5e93\u800c\u65e0\u6cd5\u6267\u884c\u7684\u95ee\u9898\u3002PKE\u5b9e\u9a8c\u5c06\u5168\u90e8\u91c7\u7528\u9759\u6001\u94fe\u63a5\u7684\u65b9\u6cd5\uff0c\u751f\u6210\u6240\u6709\u4e8c\u8fdb\u5236\u6587\u4ef6\u3002</p> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u4e86\u89e3\u4e00\u4e0bhelloworld\u7684\u7ed3\u6784\u3002\u9996\u5148\u901a\u8fc7riscv64-unknown-elf-readelf -h\u547d\u4ee4\uff0c\u4e86\u89e3\u8be5ELF\u6587\u4ef6\u7684\u6587\u4ef6\u5934\u4fe1\u606f\uff1a</p> <pre><code>$ riscv64-unknown-elf-readelf -h ./helloworld\nELF Header:\n  Magic:   7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00\nClass:                             ELF64\n  Data:                              2's complement, little endian\n  Version:                           1 (current)\nOS/ABI:                            UNIX - System V\n  ABI Version:                       0\nType:                              EXEC (Executable file)\nMachine:                           RISC-V\n  Version:                           0x1\n  Entry point address:               0x100c0\n  Start of program headers:          64 (bytes into file)\nStart of section headers:          19440 (bytes into file)\nFlags:                             0x5, RVC, double-float ABI\n  Size of this header:               64 (bytes)\nSize of program headers:           56 (bytes)\nNumber of program headers:         2\nSize of section headers:           64 (bytes)\nNumber of section headers:         15\nSection header string table index: 14\n</code></pre> <p>\u4ece\u4ee5\u4e0a\u8f93\u51fa\u6211\u4eec\u53ef\u4ee5\u770b\u5230\uff0chelloworld\u5305\u542b\u4e862\u4e2a\u7a0b\u5e8f\u6bb5\uff08segment\uff09\uff0c\u4ee5\u53ca15\u4e2a\u8282\uff08section\uff09\uff0c\u5b83\u7684\u5165\u53e3\u5730\u5740\u4e3a0x100c0\u3002</p> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7riscv64-unknown-elf-readelf -S\u547d\u4ee4\u4e86\u89e3helloworld\u53ef\u6267\u884c\u7a0b\u5e8f\u5305\u542b\u54ea\u4e9b\u7a0b\u5e8f\u8282\uff1a</p> <pre><code>$ riscv64-unknown-elf-readelf -S ./helloworld\nThere are 15 section headers, starting at offset 0x4bf0:\n\nSection Headers:\n  [Nr] Name              Type             Address           Offset\n       Size              EntSize          Flags  Link  Info  Align\n  [ 0]                   NULL             0000000000000000  00000000\n0000000000000000  0000000000000000           0     0     0\n[ 1] .text             PROGBITS         00000000000100b0  000000b0\n       00000000000024ca  0000000000000000  AX       0     0     2\n[ 2] .rodata           PROGBITS         0000000000012580  00002580\n0000000000000012  0000000000000000   A       0     0     8\n[ 3] .eh_frame         PROGBITS         0000000000013594  00002594\n0000000000000004  0000000000000000  WA       0     0     4\n[ 4] .init_array       INIT_ARRAY       0000000000013598  00002598\n0000000000000010  0000000000000008  WA       0     0     8\n[ 5] .fini_array       FINI_ARRAY       00000000000135a8  000025a8\n       0000000000000008  0000000000000008  WA       0     0     8\n[ 6] .data             PROGBITS         00000000000135b0  000025b0\n       0000000000000f58  0000000000000000  WA       0     0     8\n[ 7] .sdata            PROGBITS         0000000000014508  00003508\n0000000000000040  0000000000000000  WA       0     0     8\n[ 8] .sbss             NOBITS           0000000000014548  00003548\n0000000000000020  0000000000000000  WA       0     0     8\n[ 9] .bss              NOBITS           0000000000014568  00003548\n0000000000000068  0000000000000000  WA       0     0     8\n[10] .comment          PROGBITS         0000000000000000  00003548\n0000000000000011  0000000000000001  MS       0     0     1\n[11] .riscv.attributes RISCV_ATTRIBUTE  0000000000000000  00003559\n0000000000000035  0000000000000000           0     0     1\n[12] .symtab           SYMTAB           0000000000000000  00003590\n0000000000000f48  0000000000000018          13    78     8\n[13] .strtab           STRTAB           0000000000000000  000044d8\n       0000000000000695  0000000000000000           0     0     1\n[14] .shstrtab         STRTAB           0000000000000000  00004b6d\n       000000000000007e  0000000000000000           0     0     1\nKey to Flags:\n  W (write), A (alloc), X (execute), M (merge), S (strings), I (info),\n  L (link order), O (extra OS processing required), G (group), T (TLS),\n  C (compressed), x (unknown), o (OS specific), E (exclude),\n  p (processor specific)\n</code></pre> <p>\u4ee5\u4e0a\u8f93\u51fa\u4e2d\u6bd4\u8f83\u91cd\u8981\u7684\u6709\uff1a.text\u8868\u793a\u53ef\u6267\u884c\u8282\uff08section\uff09\uff0c.rodata\u8282\u662f\u53ea\u8bfb\u6570\u636e\u8282\uff0c.data\uff0c.sdata\uff0c.sbss\u4ee5\u53ca.bss\u8282\u90fd\u53ef\u4ee5\u89c6\u4e3ahelloworld\u7a0b\u5e8f\u7684\u6570\u636e\u6bb5\uff08.data\u662f\u6570\u636e\u8282\uff0c.sdata\u4e3a\u7cbe\u7b80\u6570\u636e\u8282\uff0c.bss\u4e3a\u672a\u521d\u59cb\u5316\u6570\u636e\u8282\uff0c.sbss\u5219\u4e3a\u7cbe\u7b80\u672a\u521d\u59cb\u5316\u6570\u636e\u8282\uff09\u3002\u5176\u4ed6\u7684\u8282\uff0c\u5982.symtab\u4e3a\u7b26\u53f7\u8282\uff0c\u5373\u7a0b\u5e8f\u4e2d\u51fa\u73b0\u7684\u7b26\u53f7\uff08\u5982main\u51fd\u6570\uff09\u5217\u8868\uff1b.strtab\u8282\u4e3a\u7a0b\u5e8f\u4e2d\u51fa\u73b0\u7684\u5b57\u7b26\u4e32\u5217\u8868\u7b49\u3002</p> <p>\u7531\u4e8ehelloworld\u662f\u53ef\u6267\u884c\u7a0b\u5e8f\uff0c\u4e14\u6839\u636eriscv64-unknown-elf-readelf -h\u547d\u4ee4\u7684\u8f93\u51fa\uff0c\u6211\u4eec\u5df2\u77e5\u8be5\u7a0b\u5e8f\u67092\u4e2a\u7a0b\u5e8f\u6bb5\uff08segment\uff09\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u518d\u901a\u8fc7riscv64-unknown-elf-readelf -l\u67e5\u770b\u8be5\u53ef\u6267\u884c\u7a0b\u5e8f\u7684\u7a0b\u5e8f\u6bb5\u7ec4\u6210\uff1a</p> <pre><code>$ riscv64-unknown-elf-readelf -l ./helloworld\n\nElf file type is EXEC (Executable file)\nEntry point 0x100c0\nThere are 2 program headers, starting at offset 64\nProgram Headers:\n  Type           Offset             VirtAddr           PhysAddr\n                 FileSiz            MemSiz              Flags  Align\n  LOAD           0x0000000000000000 0x0000000000010000 0x0000000000010000\n                 0x0000000000002592 0x0000000000002592  R E    0x1000\n  LOAD           0x0000000000002594 0x0000000000013594 0x0000000000013594\n                 0x0000000000000fb4 0x000000000000103c  RW     0x1000\n\nSection to Segment mapping:\n  Segment Sections...\n   00     .text .rodata\n   01     .eh_frame .init_array .fini_array .data .sdata .sbss .bss\n</code></pre> <p>\u4ee5\u4e0a\u8f93\u51fa\u8868\u660e\uff0chelloworld\u7684\u4e24\u4e2a\u6bb5\uff0c\u5176\u4e2d\u4e00\u4e2a\uff0800\uff09\u662f\u7531.text\u8282\u548c.rodata\u8282\u6240\u7ec4\u6210\u7684\uff08\u53ef\u6267\u884c\u4ee3\u7801\u6bb5\uff09\uff0c\u53e6\u4e00\u4e2a\uff0801\uff09\u662f\u7531.eh_frame\uff0c.init_array\uff0c.fini_arry\uff0c.data\uff0c.sdata\uff0c.sbss\u4ee5\u53ca.bss\u8282\u6240\u7ec4\u6210\u7684\uff08\u6570\u636e\u6bb5\uff09\u3002\u8fd9\u91cc\uff0c\u8bfb\u8005\u53ef\u4ee5\u601d\u8003\uff1ahelloworld\u6587\u4ef6\u4e2d\u4e3a\u4ec0\u4e48\u6ca1\u6709\u51fa\u73b0\u5806\u6808\uff08.stack\uff09\u6bb5\u5462\uff1f</p> <p>\u4e3a\u4e86\u5bf9helloworld\u6587\u4ef6\u8fdb\u884c\u8fdb\u4e00\u6b65\u7406\u89e3\uff0c\u6211\u4eec\u4f7f\u7528objdump\u547d\u4ee4\u5c06\u5b83\u8fdb\u884c\u53cd\u6c47\u7f16\u5904\u7406\uff08\u4f7f\u7528<code>-D</code>\u5f00\u5173\u53cd\u6c47\u7f16\u6240\u6709\u7684\u6bb5\uff09\uff0c\u5e76\u5217\u51fa3\u4e2a\u6709\u6548\u6bb5\uff08\u7701\u7565\u8f85\u52a9\u6bb5\uff0c\u4e5f\u7701\u7565gcc\u52a0\u5165\u7684\u4e00\u4e9b\u8f85\u52a9\u51fd\u6570\u548c\u8f85\u52a9\u6570\u636e\u7ed3\u6784\uff09\uff1a</p> <pre><code>$ riscv64-unknown-elf-objdump -D ./helloworld | less\n\n./helloworld:     file format elf64-littleriscv\n\nDisassembly of section .text:\n\n000000000001014e &lt;main&gt;:\n   1014e:       1141                    addi    sp,sp,-16\n   10150:       e406                    sd      ra,8(sp)\n10152:       e022                    sd      s0,0(sp)\n10154:       0800                    addi    s0,sp,16\n   10156:       67c9                    lui     a5,0x12\n   10158:       58078513                addi    a0,a5,1408 # 12580 &lt;__errno+0xc&gt;\n1015c:       1c0000ef                jal     ra,1031c &lt;puts&gt;\n   10160:       4781                    li      a5,0\n   10162:       853e                    mv      a0,a5\n   10164:       60a2                    ld      ra,8(sp)\n10166:       6402                    ld      s0,0(sp)\n10168:       0141                    addi    sp,sp,16\n   1016a:       8082                    ret\n        ...\n</code></pre> <p>\u5b9e\u9645\u4e0a\uff0c\u7531\u4e8ehelloworld\u662f\u9759\u6001\u94fe\u63a5\u6587\u4ef6\uff0c\u91cc\u9762\u7684\u5185\u5bb9\u975e\u5e38\u7e41\u6742\uff0c\u800c\u4ee5\u4e0a\u8f93\u51fa\u4e2d\u7684main\u51fd\u6570\u662f\u6211\u4eec\u5728<code>riscv64-unknown-elf-objdump -D ./helloworld</code>\u7684\u8f93\u51fa\u4e2d\u62bd\u53d6\u51fa\u6765\u7684\uff0c\u53ef\u4ee5\u89c2\u5bdf\u4ecehelloworld.c\u4e2dC\u6e90\u7a0b\u5e8f\u5230RISC-V\u6c47\u7f16\u7684\u8f6c\u6362\u3002\u9996\u5148\uff0c\u6211\u4eec\u53ef\u4ee5\u770b\u5230main\u51fd\u6570\u5bf9\u5e94\u7684\u903b\u8f91\u5730\u5740\u4e3a000000000001014e\uff0c\u8fd9\u91cc\u8bfb\u8005\u53ef\u4ee5\u601d\u8003\u4e0b\u4e3a\u4ec0\u4e48\u5b83\u4e0d\u662f<code>riscv64-unknown-elf-readelf -h ./helloworld</code>\u547d\u4ee4\u8f93\u51fa\u4e2d\u7684\u7a0b\u5e8f\u5165\u53e3\u5730\u57400x100c0\uff1f</p> <p>\u53e6\u5916\uff0c\u6211\u4eec\u770b\u5230main\u51fd\u6570\u4e2d\u8fdb\u884c\u7684printf\u8c03\u7528\u5b9e\u9645\u4e0a\u8f6c\u6362\u6210\u4e86\u5bf9puts\u51fd\u6570\u7684\u8c03\u7528\uff0c\u800c\u6211\u4eec\u5e76\u672a\u5b9e\u73b0\u8be5\u51fd\u6570\u3002\u8fd9\u662f\u56e0\u4e3a\u91c7\u7528<code>riscv64-unknown-elf-gcc</code>\u5bf9\u6e90\u7a0b\u5e8f\u8fdb\u884c\u7684\u7f16\u8bd1\u548c\u94fe\u63a5\uff0c\u5b9e\u9645\u4e0a\u662f\u9759\u6001\u94fe\u63a5\uff0c\u4e5f\u5c31\u662f\u4f1a\u5c06\u5e94\u7528\u7a0b\u5e8f\u4e2d\u7684\u5e38\u7528\u51fd\u6570\u8c03\u7528\u8f6c\u6362\u4e3a\u7f16\u8bd1\u5668\u81ea\u5e26\u7684\u7a0b\u5e8f\u5e93\u7684\u8c03\u7528\uff0c\u5e76\u5728\u6700\u7ec8\u751f\u6210\u7684ELF\u6587\u4ef6\u4e2d\u5e26\u5165\u81ea\u5e26\u7a0b\u5e8f\u5e93\u4e2d\u7684\u5b9e\u73b0\u3002\u5bf9\u4e8eprintf\uff0c\u7f16\u8bd1\u5668\u5728\u5bf9\u5176\u5b57\u7b26\u4e32\u53c2\u6570\u8fdb\u884c\u8f6c\u5316\u540e\u5c31\u81ea\u7136\u8f6c\u6362\u4e3aputs\u5e93\u51fd\u6570\u8c03\u7528\u4e86\uff0c\u8fd9\u4e5f\u662f\u4e3a\u4ec0\u4e48\u6211\u4eec\u5728\u53cd\u6c47\u7f16\u7684\u4ee3\u7801\u4e2d\u627e\u4e0d\u5230printf\u7684\u539f\u56e0\u3002</p> <p>\u901a\u8fc7\u4ee5\u4e0a\u8bb2\u89e3\uff0c\u53ef\u4ee5\u770b\u5230RISC-V\u7a0b\u5e8f\u7684\u7f16\u8bd1\u94fe\u63a5\u5176\u5b9e\u8ddf\u6211\u4eec\u5728x86\u5e73\u53f0\u4e0a\u7f16\u5199\u3001\u7f16\u8bd1\u548c\u94fe\u63a5\u4e00\u4e2aC\u8bed\u8a00\u7a0b\u5e8f\u7684\u8fc7\u7a0b\u4e00\u6478\u4e00\u6837\uff0c\u552f\u4e00\u7684\u4e0d\u540c\u662f\u5c06\u4ee5\u4e0a\u7684\u547d\u4ee4\u52a0\u4e0a\u4e86<code>riscv64-unknown-elf-</code>\u524d\u7f00\u800c\u5df2\uff0c\u57fa\u672c\u7684\u8fc7\u7a0b\u662f\u5b8c\u5168\u4e00\u6837\u7684\u3002\u9664\u6b64\u4e4b\u5916\uff0c\u6211\u4eec\u751f\u6210\u7684\u53ef\u6267\u884c\u4ee3\u7801\uff08\u5982\u4ee5\u4e0a\u7684helloworld\uff09\u91c7\u7528\u662fRISC-V\u6307\u4ee4\u96c6\uff08\u66f4\u51c6\u786e\u7684\u8bf4\uff0c\u662fRV64G\u6307\u4ee4\u96c6\uff09\uff0c\u662f\u4e0d\u80fd\u5728\u6211\u4eec\u7684x86\u5f00\u53d1\u7535\u8111\u4e0a\u76f4\u63a5\u6267\u884c\u7684\uff01\u4e5f\u5c31\u662f\u8bf4\uff0c\u6211\u4eec\u4e0d\u80fd\u901a\u8fc7<code>./helloworld</code>\u547d\u4ee4\u76f4\u63a5\u6267\u884c\u4e4b\u524d\u7f16\u5199\u7684C\u8bed\u8a00\u7a0b\u5e8f\u3002</p> <p>\u4e3a\u4e86\u6267\u884chelloworld\u6587\u4ef6\uff0c\u9996\u5148\u6211\u4eec\u9700\u8981\uff1a1\uff09\u4e00\u4e2a\u652f\u6301RISC-V\u6307\u4ee4\u96c6\u7684\u673a\u5668\uff1b2\uff09\u4e00\u4e2a\u80fd\u591f\u5728\u8be5RISC-V\u673a\u5668\u4e0a\u8fd0\u884c\u7684\u64cd\u4f5c\u7cfb\u7edf\u3002\u5728PKE\u5b9e\u9a8c\u4e2d\uff0c\u6211\u4eec\u91c7\u7528spike\u6a21\u62dfRISC-V\u673a\u5668\u4ee5\u6ee1\u8db3\u7b2c\u4e00\u4e2a\u8981\u6c42\uff1b\u901a\u8fc7\u5b9e\u9a8c\u8bbe\u8ba1\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\uff0c\u4ee5\u6ee1\u8db3\u7b2c\u4e8c\u4e2a\u8981\u6c42\u3002\u5b9e\u9645\u4e0a\uff0cPKE\u7684\u5b9e\u9a8c\u8bbe\u8ba1\u6b63\u662f\u4ece\u5e94\u7528\u51fa\u53d1\uff0c\u8003\u8651\u4e3a\u7ed9\u5b9a\u5e94\u7528\u8bbe\u8ba1\u201c\u521a\u521a\u597d\u201d\u7684\u5185\u6838\uff0c\u4f7f\u5f97\u7ed9\u5b9a\u5e94\u7528\u80fd\u591f\u5728spike\u6a21\u62df\u7684RISC-V\u673a\u5668\u4e0a\u6b63\u786e\u5730\u6267\u884c\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter3_traps/#312","title":"3.1.2 \u6307\u5b9a\u7b26\u53f7\u7684\u903b\u8f91\u5730\u5740","text":"<p>\u7f16\u8bd1\u5668\u5728\u94fe\u63a5\u8fc7\u7a0b\u4e2d\uff0c\u4e00\u4e2a\u91cd\u8981\u7684\u4efb\u52a1\u5c31\u662f\u4e3a\u6e90\u7a0b\u5e8f\u4e2d\u7684\u7b26\u53f7\uff08symbol\uff09\u8d4b\u4e88\u903b\u8f91\u5730\u5740\u3002\u4f8b\u5982\uff0c\u5728\u4ee5\u4e0a<code>sections</code>\u7684\u4f8b\u5b50\u4e2d\uff0c\u6211\u4eec\u901a\u8fc7<code>objdump</code>\u547d\u4ee4\uff0c\u5f97\u77e5helloworld.c\u6e90\u6587\u4ef6\u7684main\u51fd\u6570\u6240\u5bf9\u5e94\u7684\u903b\u8f91\u5730\u5740\u4e3a0x000000000001014e\uff0c\u800c\u4e14\u5bf9\u4e8e\u4efb\u610fELF\u4e2d\u7684\u6bb5\uff08segment\uff09\u6216\u8282\uff08section\uff09\u800c\u8a00\uff0c\u5b83\u7684\u903b\u8f91\u5730\u5740\u5fc5\u7136\u662f\u4ece\u67d0\u4e2a\u5730\u5740\u5f00\u59cb\u7684\u4e00\u6bb5\u8fde\u7eed\u5730\u5740\u7a7a\u95f4\u3002</p> <p>\u90a3\u4e48\uff0c\u662f\u5426\u6709\u529e\u6cd5\u6307\u5b9a\u67d0\u7b26\u53f7\u5bf9\u5e94\u7684\u903b\u8f91\u5730\u5740\u5462\uff1f\u7b54\u6848\u662f\u53ef\u4ee5\uff0c\u4f46\u53ea\u80fd\u6307\u5b9a\u7b26\u53f7\u6240\u5728\u7684\u6bb5\u7684\u8d77\u59cb\u903b\u8f91\u5730\u5740\uff0c\u65b9\u6cd5\u662f\u901a\u8fc7lds\u94fe\u63a5\u811a\u672c\u3002\u6211\u4eec\u8fd8\u662f\u7528\u4ee5\u4e0a\u7684helloworld.c\u4f5c\u4e3a\u4f8b\u5b50\uff0c\u53e6\u5916\u521b\u5efa\u548c\u7f16\u8f91\u4e00\u4e2alds\u94fe\u63a5\u811a\u672c\uff0c\u5373helloworld_lds.lds\u6587\u4ef6\uff1a</p> <pre><code>  1 OUTPUT_ARCH( \"riscv\" )\n2\n3 ENTRY(main)\n4\n5 SECTIONS\n  6 {\n7   . = 0x81000000;\n8   . = ALIGN(0x1000);\n9   .text : { *(.text) }\n10   . = ALIGN(16);\n11   .data : { *(.data) }\n12   . = ALIGN(16);\n13   .bss : { *(.bss) }\n14 }\n</code></pre> <p>\u5728\u8be5\u811a\u672c\u4e2d\uff0c\u6211\u4eec\u89c4\u5b9a\u4e86\u7a0b\u5e8f\u7684\u76ee\u6807\u6307\u4ee4\u96c6\u4e3aRISC-V\uff08\u7b2c1\u884c\uff09\uff1b\u5165\u53e3\u5730\u5740\u4e3amain\uff08\u7b2c3\u884c\uff09\u3002\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u5bf9\u7a0b\u5e8f\u7684\u51e0\u4e2a\u6bb5\u5730\u5740\u8fdb\u884c\u4e86\u201c\u89c4\u5212\u201d\uff0c\u5176\u4e2d\u4ee3\u7801\u6bb5\u7684\u9996\u5730\u5740\u4e3a0x81000000\uff08\u5982\u679c\u76ee\u6807\u5e73\u53f0\u662f64\u4f4d\uff0c\u7f16\u8bd1\u5668\u4f1a\u5bf9\u8be5\u903b\u8f91\u5730\u5740\u7684\u9ad8\u5730\u5740\u4f4d\u586b0\uff09\uff0c.data\u6bb5\u548c.bss\u6bb5\u8ddf\u5728.text\u6bb5\u4e4b\u540e\uff1bALIGN(0x1000)\u8868\u793a\u63094KB\u5bf9\u9f50\uff0cALIGN(16)\u8868\u793a\u6309\u716716\u5b57\u8282\u5bf9\u9f50\u3002</p> <p>\u4e3a\u4e86\u907f\u514d\u5e93\u51fd\u6570\u7684\u201c\u5e72\u6270\u201d\uff0c\u6211\u4eec\u5c063.1.2\u4e2d\u7684helloworld.c\u4ee3\u7801\u8fdb\u884c\u4e86\u4fee\u6539\uff08helloworld_with_lds.c\uff09\uff0c\u53bb\u6389\u4e86printf\u7684\u8c03\u7528\u8f6c\u7528\u4e00\u4e2a\u52a0\u6cd5\u8bed\u53e5\u4f5c\u4e3amain\u51fd\u6570\u7684\u4e3b\u4f53\uff1a</p> <pre><code>  1 #include &lt;stdio.h&gt;\n2\n3 int main()\n4 {\n5   int global_var=0;\n6   global_var = 1;\n7   return 0;\n8 }\n</code></pre> <p>\u91c7\u7528\u4ee5\u4e0b\u547d\u4ee4\u5bf9helloworld_with_lds.c\u8fdb\u884c\u7f16\u8bd1\uff1a</p> <p><code>$ riscv64-unknown-elf-gcc -nostartfiles helloworld_with_lds.c -T helloworld_lds.lds -o helloworld_with_lds</code></p> <p>\u5e76\u5bf9\u91cd\u65b0\u751f\u6210\u7684helloworld_with_lds\u6587\u4ef6\u8fdb\u884c\u89c2\u5bdf\uff1a</p> <pre><code>$ riscv64-unknown-elf-readelf -h ./helloworld_with_lds\nELF Header:\n  Magic:   7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00\nClass:                             ELF64\n  Data:                              2's complement, little endian\n  Version:                           1 (current)\nOS/ABI:                            UNIX - System V\n  ABI Version:                       0\nType:                              EXEC (Executable file)\nMachine:                           RISC-V\n  Version:                           0x1\n  Entry point address:               0x81000000\n  Start of program headers:          64 (bytes into file)\nStart of section headers:          4424 (bytes into file)\nFlags:                             0x5, RVC, double-float ABI\n  Size of this header:               64 (bytes)\nSize of program headers:           56 (bytes)\nNumber of program headers:         1\nSize of section headers:           64 (bytes)\nNumber of section headers:         7\nSection header string table index: 6\n</code></pre> <p>\u4ee5\u4e0a\u7684\u8f93\u51fa\u8868\u660e\uff0c\u5b83\u7684\u5165\u53e3\u5730\u5740\u53d8\u6210\u4e860x81000000\uff08\u4e5f\u5c31\u662f\u7531helloworld_lds.lds\u6240\u6307\u5b9a\u7684\u5730\u5740\uff09\uff0c\u53e6\u5916\u91c7\u7528<code>riscv64-unknown-elf-objdump -D ./helloworld_with_lds</code>\u547d\u4ee4\u89c2\u5bdfhelloworld_with_lds\u6587\u4ef6\u4e2d\u7b26\u53f7\u5730\u5740main\u6240\u5bf9\u5e94\u7684\u903b\u8f91\u5730\u5740\uff0c\u6709\u4ee5\u4e0b\u8f93\u51fa\uff1a</p> <pre><code>$ riscv64-unknown-elf-objdump -D ./helloworld_with_lds | less\n\n./helloworld_with_lds:     file format elf64-littleriscv\n\nDisassembly of section .text:\n\n0000000081000000 &lt;main&gt;:\n    81000000:   1101                    addi    sp,sp,-32\n    81000002:   ec22                    sd      s0,24(sp)\n81000004:   1000                    addi    s0,sp,32\n    81000006:   fe042623                sw      zero,-20(s0)\n8100000a:   4785                    li      a5,1\n    8100000c:   fef42623                sw      a5,-20(s0)\n81000010:   4781                    li      a5,0\n    81000012:   853e                    mv      a0,a5\n    81000014:   6462                    ld      s0,24(sp)\n81000016:   6105                    addi    sp,sp,32\n    81000018:   8082                    ret\n        ...\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0cmain\u51fd\u6570\u6210\u4e3a\u4e86helloworld_with_lds\u6587\u4ef6\u7684\u771f\u6b63\u5165\u53e3\uff08\u800c\u4e0d\u662f3.1.2\u4e2d\u7684helloworld\u6587\u4ef6\u4e2dmain\u51fd\u6570\u5e76\u4e0d\u662f\u8be5\u53ef\u6267\u884c\u7a0b\u5e8f\u7684\u771f\u6b63\u5165\u53e3\u7684\u60c5\u5f62\uff09\u3002</p> <p>\u901a\u8fc7lds\u6587\u4ef6\u7684\u529e\u6cd5\u63a7\u5236\u7a0b\u5e8f\u4e2d\u7b26\u53f7\u5730\u5740\u5230\u903b\u8f91\u5730\u5740\u7684\u8f6c\u6362\uff0c\u5bf9\u4e8ePKE\u7684\u7b2c\u4e00\u7ec4\u5b9e\u9a8c\uff08lab1\uff09\u800c\u8a00\uff0c\u662f\u4e00\u4e2a\u5f88\u91cd\u8981\u7684\u77e5\u8bc6\u70b9\u3002\u56e0\u4e3a\u5728\u7b2c\u4e00\u7ec4\u5b9e\u9a8c\u4e2d\uff0c\u6211\u4eec\u5c06\u91c7\u7528\u76f4\u63a5\u6620\u5c04\uff08Bare-mode mapping\uff09\u7684\u529e\u6cd5\u5b8c\u6210\u5e94\u7528\u7a0b\u5e8f\u4e2d\u865a\u5730\u5740\u5230\u5b9e\u9645\u7269\u7406\u5730\u5740\u7684\u8f6c\u6362\uff08\u6211\u4eec\u5728\u7b2c\u4e8c\u7ec4\u5b9e\u9a8c\u4e2d\u624d\u4f1a\u6253\u5f00RISC-V\u7684SV39\u9875\u5f0f\u5730\u5740\u6620\u5c04\uff09\uff0c\u6240\u4ee5\u9700\u8981\u63d0\u524d\u5bf9PKE\u7684\u5185\u6838\u4ee5\u53ca\u5e94\u7528\u7684\u903b\u8f91\u5730\u5740\u8fdb\u884c\u201c\u89c4\u5212\u201d\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter3_traps/#313","title":"3.1.3 \u4ee3\u7406\u5185\u6838\u7684\u6784\u9020\u8fc7\u7a0b","text":"<p>\u8fd9\u91cc\u6211\u4eec\u8ba8\u8bbalab1_1\u4e2d\u4ee3\u7406\u5185\u6838\uff0c\u4ee5\u53ca\u5176\u4e0a\u8fd0\u884c\u7684\u5e94\u7528\u7684\u6784\u9020\uff08build\uff09\u8fc7\u7a0b\u3002PKE\u5b9e\u9a8c\u91c7\u7528\u4e86Linux\u4e2d\u5e7f\u6cdb\u91c7\u7528\u7684make\u8f6f\u4ef6\u5305\u5b8c\u6210\u5185\u6838\u3001\u652f\u6491\u5e93\uff0c\u4ee5\u53ca\u5e94\u7528\u7684\u6784\u9020\u3002\u5173\u4e8eMakefile\u7684\u7f16\u5199\uff0c\u6211\u4eec\u5efa\u8bae\u8bfb\u8005\u9605\u8bfb\u8fd9\u91cc\u4e86\u89e3make\u6587\u4ef6\u7684\u57fa\u7840\u77e5\u8bc6\uff0c\u8fd9\u91cc\u4ec5\u8ba8\u8bbalab1_1\u7684Makefile\u4ee5\u53ca\u5bf9\u5e94\u7684\u6784\u9020\u8fc7\u7a0b\u3002PKE\u7684\u540e\u7eed\u5b9e\u9a8c\u5b9e\u9645\u4e0a\u91c7\u7528\u7684Makefile\u8ddflab1_1\u7684\u975e\u5e38\u7c7b\u4f3c\uff0c\u6240\u4ee5\u6211\u4eec\u5728\u540e\u7eed\u7ae0\u8282\u4e2d\u4e0d\u518d\u5bf9\u5b83\u4eec\u7684\u6784\u5efa\u8fc7\u7a0b\u8fdb\u884c\u8ba8\u8bba\u3002</p> <p>\u6211\u4eec\u9996\u5148\u89c2\u5bdflab1_1\u4e2d\u4f4d\u4e8e\u6839\u76ee\u5f55\u7684Makefile\u6587\u4ef6\uff08\u6458\u53d6\u5176\u4e2d\u6211\u4eec\u8ba4\u4e3a\u91cd\u8981\u7684\u5185\u5bb9\uff09\uff1a</p> <pre><code>  8 CROSS_PREFIX    := riscv64-unknown-elf-\n  9 CC              := $(CROSS_PREFIX)gcc\n 10 AR              := $(CROSS_PREFIX)ar\n 11 RANLIB          := $(CROSS_PREFIX)ranlib\n 12\n13 SRC_DIR         := .\n 14 OBJ_DIR         := obj\n 15 SPROJS_INCLUDE  := -I.\n 16\n...\n 26 #---------------------  utils -----------------------\n27 UTIL_CPPS   := util/*.c\n 28\n29 UTIL_CPPS  := $(wildcard $(UTIL_CPPS))\n30 UTIL_OBJS  :=  $(addprefix $(OBJ_DIR)/, $(patsubst %.c,%.o,$(UTIL_CPPS)))\n31\n32\n33 UTIL_LIB   := $(OBJ_DIR)/util.a\n 34\n35 #---------------------  kernel -----------------------\n36 KERNEL_LDS      := kernel/kernel.lds\n 37 KERNEL_CPPS     := \\\n38     kernel/*.c \\\n39     kernel/machine/*.c \\\n40     kernel/util/*.c\n 41\n42 KERNEL_ASMS     := \\\n43     kernel/*.S \\\n44     kernel/machine/*.S \\\n45     kernel/util/*.S\n 46\n47 KERNEL_CPPS     := $(wildcard $(KERNEL_CPPS))\n48 KERNEL_ASMS     := $(wildcard $(KERNEL_ASMS))\n49 KERNEL_OBJS     :=  $(addprefix $(OBJ_DIR)/, $(patsubst %.c,%.o,$(KERNEL_CPPS)))\n50 KERNEL_OBJS     +=  $(addprefix $(OBJ_DIR)/, $(patsubst %.S,%.o,$(KERNEL_ASMS)))\n51\n52 KERNEL_TARGET = $(OBJ_DIR)/riscv-pke\n 53\n54\n55 #---------------------  spike interface library -----------------------\n56 SPIKE_INF_CPPS  := spike_interface/*.c\n 57\n58 SPIKE_INF_CPPS  := $(wildcard $(SPIKE_INF_CPPS))\n59 SPIKE_INF_OBJS  :=  $(addprefix $(OBJ_DIR)/, $(patsubst %.c,%.o,$(SPIKE_INF_CPPS)))\n60\n61\n62 SPIKE_INF_LIB   := $(OBJ_DIR)/spike_interface.a\n 63\n64\n65 #---------------------  user   -----------------------\n66 USER_LDS  := user/user.lds\n 67 USER_CPPS       := user/*.c\n 68\n70 USER_OBJS       := $(addprefix $(OBJ_DIR)/, $(patsubst %.c,%.o,$(USER_CPPS)))\n71\n72 USER_TARGET     := $(OBJ_DIR)/app_helloworld\n 73\n74 #------------------------targets------------------------\n75 $(OBJ_DIR):\n 76     @-mkdir -p $(OBJ_DIR)\n77     @-mkdir -p $(dir $(UTIL_OBJS))\n78     @-mkdir -p $(dir $(SPIKE_INF_OBJS))\n79     @-mkdir -p $(dir $(KERNEL_OBJS))\n80     @-mkdir -p $(dir $(USER_OBJS))\n81\n82 $(OBJ_DIR)/%.o : %.c\n 83     @echo \"compiling\" $&lt;\n 84     @$(COMPILE) -c $&lt; -o $@\n85\n86 $(OBJ_DIR)/%.o : %.S\n 87     @echo \"compiling\" $&lt;\n 88     @$(COMPILE) -c $&lt; -o $@\n89\n90 $(UTIL_LIB): $(OBJ_DIR) $(UTIL_OBJS)\n91     @echo \"linking \" $@ ...\n 92     @$(AR) -rcs $@ $(UTIL_OBJS)\n93     @echo \"Util lib has been build into\" \\\"$@\\\"\n94\n95 $(SPIKE_INF_LIB): $(OBJ_DIR) $(UTIL_OBJS) $(SPIKE_INF_OBJS)\n96     @echo \"linking \" $@ ...\n 97     @$(AR) -rcs $@ $(SPIKE_INF_OBJS) $(UTIL_OBJS)\n98     @echo \"Spike lib has been build into\" \\\"$@\\\"\n99\n100 $(KERNEL_TARGET): $(OBJ_DIR) $(UTIL_LIB) $(SPIKE_INF_LIB) $(KERNEL_OBJS) $(KERNEL_LDS)\n101     @echo \"linking\" $@ ...\n102     @$(COMPILE) $(KERNEL_OBJS) $(UTIL_LIB) $(SPIKE_INF_LIB) -o $@ -T $(KERNEL_LDS)\n103     @echo \"PKE core has been built into\" \\\"$@\\\"\n104\n105 $(USER_TARGET): $(OBJ_DIR) $(UTIL_LIB) $(USER_OBJS) $(USER_LDS)\n106     @echo \"linking\" $@  ...\n107     @$(COMPILE) $(USER_OBJS) $(UTIL_LIB) -o $@ -T $(USER_LDS)\n108     @echo \"User app has been built into\" \\\"$@\\\"\n109\n...\n113 .DEFAULT_GOAL := $(all)\n114\n115 all: $(KERNEL_TARGET) $(USER_TARGET)\n116 .PHONY:all\n...\n</code></pre> <p>\u901a\u8fc7\u9605\u8bfb\u8be5\u6587\u4ef6\uff0c\u6211\u4eec\u770b\u5230\u6784\u5efa\u8fc7\u7a0b\u7684\u6700\u7ec8\u76ee\u6807\u662f\u7b2c115\u884c\u7684all\uff0c\u800c\u5b83\u6709\u4e24\u4e2a\u4f9d\u8d56\u76ee\u6807\uff1a<code>$(KERNEL_TARGET)</code>\u548c<code>$(USER_TARGET)</code>\u3002\u6211\u4eec\u4ece\u53f3\u5f80\u5de6\u770b\uff0c<code>$(USER_TARGET)</code>\u7684\u5b9a\u4e49\u572872\u884c\uff0c\u5bf9\u5e94\u7684\u662f<code>$(OBJ_DIR)/app_helloworld</code> \uff08\u5373./obj/app_helloworld\uff09\u3002\u6784\u5efa<code>$(USER_TARGET)</code>\u7684\u89c4\u5219\u5728\u7b2c105--108\u884c\uff0c\u5176\u4e2d\u7b2c105\u884c\u8bf4\u660e<code>$(USER_TARGET)</code>\u7684\u6784\u5efa\u4f9d\u8d56<code>$(OBJ_DIR)</code>\uff0c<code>$(UTIL_LIB)</code>\uff0c<code>$(USER_OBJS)</code>\u4ee5\u53ca<code>$(USER_LDS)</code>\u8fd94\u4e2a\u76ee\u6807\u3002</p> <ul> <li><code>$(OBJ_DIR)</code>\uff1a\u5b83\u5bf9\u5e94\u7684\u52a8\u4f5c\u662f\u5efa\u7acb5\u4e2a\u76ee\u5f55\uff08\u7b2c75--80\u884c\uff09\uff1a./obj\uff0c./obj/util\uff0c./obj/spike_interface\uff0c./obj/user\u4ee5\u53ca./obj/kernel\uff1b</li> <li><code>$(UTIL_LIB)</code>\uff1a\u5b83\u7684\u5b9a\u4e49\u5728\u7b2c33\u884c\uff0c\u5b83\u5bf9\u5e94\u7684\u662f<code>$(OBJ_DIR)/util.a</code>\uff0c\u800c\u5b83\u7684\u7f16\u8bd1\u89c4\u5219\u5728\u7b2c90\u884c--\u7b2c93\u884c\uff0c\u4f9d\u8d56<code>$(UTIL_OBJS)</code>\u7684\u5904\u7406\u3002\u800c\u540e\u8005\u7684\u5b9a\u4e49\u5728\u7b2c30\u884c\uff0c\u5bf9\u5e94<code>$(addprefix $(OBJ_DIR)/, $(patsubst %.c,%.o,$(UTIL_CPPS)))</code> \uff0c\u9700\u8981\u5c06<code>$(UTIL_CPPS)</code>\u4e5f\u5c31\u662futil/*.c\uff08\u89c1\u7b2c27\u884c\uff09\u5168\u90e8\u7f16\u8bd1\u6210.o\u6587\u4ef6\uff0c\u5e76\u94fe\u63a5\u4e3a\u9759\u6001\u5e93\uff08\u7b2c92\u884c\u7684\u52a8\u4f5c\uff09\uff1b</li> <li><code>$(USER_OBJS)</code>\uff1a\u5b83\u5bf9\u5e94\uff08\u7b2c70\u884c\uff09\u7684\u662f<code>$(addprefix $(OBJ_DIR)/, $(patsubst %.c,%.o,$(USER_CPPS)))</code>\uff0c\u9700\u8981\u5c06<code>$(USER_CPPS)</code>\u4e5f\u5c31\u662fuser/*.c\u90fd\u7f16\u8bd1\u4e3a.o\u6587\u4ef6\uff08\u5177\u4f53\u7684\u7f16\u8bd1\u52a8\u4f5c\u753182--84\u884c\u5b8c\u6210\uff09\uff1b</li> <li><code>$(USER_LDS)</code>\uff1a\u5b83\u5bf9\u5e94\uff08\u89c1\u7b2c66\u884c\uff09user/user.lds\uff0c\u7531\u4e8e\u540e\u8005\u5df2\u7ecf\u5b58\u5728\u4e8e\u6e90\u4ee3\u7801\u6811\u4e2d\uff0c\u6240\u4ee5\u4e0d\u4f1a\u5bfc\u81f4\u4efb\u4f55\u52a8\u4f5c\u3002</li> </ul> <p>\u4ee5\u4e0a\u6784\u9020<code>$(USER_TARGET)</code>\u6240\u4f9d\u8d56\u7684\u76ee\u6807\u5168\u90e8\u5b8c\u6210\u540e\uff0c\u6784\u9020\u8fc7\u7a0b\u5c06\u6267\u884c\u7b2c105--108\u884c\u7684\u52a8\u4f5c\uff0c\u5373\u5c06user/\u76ee\u5f55\u4e0b\u901a\u8fc7\u7f16\u8bd1\u51fa\u6765\u7684.o\u6587\u4ef6\u4e0eutil\u4e2d\u7f16\u8bd1\u548c\u94fe\u63a5\u51fa\u6765\u7684\u9759\u6001\u5e93\u6587\u4ef6\u4e00\u8d77\u94fe\u63a5\uff0c\u751f\u6210\u91c7\u7528RISC-V\u6307\u4ee4\u96c6\u7684\u53ef\u6267\u884c\u6587\u4ef6\u3002\u540c\u65f6\uff0c\u94fe\u63a5\u8fc7\u7a0b\u91c7\u7528user/user.lds\u811a\u672c\u4ee5\u6307\u5b9a\u751f\u6210\u7684\u53ef\u6267\u884c\u6587\u4ef6\u4e2d\u7684\u7b26\u53f7\u6240\u5bf9\u5e94\u7684\u903b\u8f91\u5730\u5740\u3002</p> <p>\u5b8c\u6210<code>$(USER_TARGET)</code>\u7684\u6784\u9020\u540e\uff0c\u6211\u4eec\u56de\u5230\u7b2c115\u884c\uff0c\u7ee7\u7eed$(KERNEL_TARGET)\u76ee\u6807\u7684\u6784\u9020\u3002\u5b83\u7684\u5b9a\u4e49\u5728100-103\u884c\uff0c\u53ef\u4ee5\u770b\u5230\u5b83\u53c8\u67095\u4e2a\u4f9d\u8d56\u76ee\u6807\uff1a<code>$(OBJ_DIR)</code>\uff0c<code>$(UTIL_LIB)</code>\uff0c<code>$(SPIKE_INF_LIB)</code>\uff0c<code>$(KERNEL_OBJS)</code>\u548c<code>$(KERNEL_LDS)</code>\u3002\u5176\u4e2d<code>$(OBJ_DIR)</code>\u3001<code>$(UTIL_LIB)</code>\u5728\u6784\u9020<code>$(USER_TARGET)</code>\u76ee\u6807\u65f6\u5c31\u5df2\u7ecf\u987a\u5e26\u5730\u5b9e\u73b0\u4e86\uff0c\u5269\u4e0b\u7684<code>$(KERNEL_LDS)</code>\u4e5f\u662f\u5df2\u7ecf\u5b58\u5728\u7684\u6587\u4ef6\u3002\u8fd9\u6837\uff0c\u5c31\u5269\u4e0b\u4e24\u4e2a\u201c\u65b0\u201d\u76ee\u6807\uff1a</p> <ul> <li><code>$(SPIKE_INF_LIB)</code>\uff1a\u5b83\u7684\u5b9a\u4e49\u5728\u7b2c62\u884c\uff0c\u5bf9\u5e94<code>$(OBJ_DIR)/spike_interface.a</code>\u6587\u4ef6\uff0c\u5bf9\u5e94\u7684\u6784\u9020\u52a8\u4f5c\u5728\u7b2c95--98\u884c\uff0c\u53c8\u4f9d\u8d56<code>$(OBJ_DIR)</code>\u3001<code>$(UTIL_OBJS)</code>\u548c<code>$(SPIKE_INF_OBJS)</code>\u8fd93\u4e2a\u76ee\u6807\u3002\u5176\u4e2d<code>$(OBJ_DIR)</code>\u548c<code>$(UTIL_OBJS)</code>\u4e24\u4e2a\u76ee\u6807\u6211\u4eec\u5728\u4e4b\u524d\u6784\u9020<code>$(USER_TARGET)</code>\u65f6\u5df2\u7ecf\u89e3\u51b3\uff0c\u5269\u4e0b\u7684<code>$(SPIKE_INF_OBJS)</code>\u76ee\u6807\u5bf9\u5e94\u7684\u662f<code>$(addprefix $(OBJ_DIR)/, $(patsubst %.c,%.o,$(SPIKE_INF_CPPS)))</code>\u5c06\u5bfc\u81f4<code>$(SPIKE_INF_CPPS)</code>\uff0c\u4e5f\u5c31\u662fspike_interface/*.c\u88ab\u5bf9\u5e94\u5730\u7f16\u8bd1\u6210.o\u6587\u4ef6\u3002\u6700\u540e\uff0c\u7b2c96--98\u884c\u7684\u52a8\u4f5c\uff0c\u4f1a\u5c06\u7f16\u8bd1spike_interface\u76ee\u5f55\u4e0b\u6587\u4ef6\u751f\u6210\u7684.o\u6587\u4ef6\u94fe\u63a5\u4e3a\u9759\u6001\u5e93\uff08<code>$(OBJ_DIR)/spike_interface.a</code>\uff09\u6587\u4ef6\uff1b</li> <li><code>$(KERNEL_OBJS)</code>\uff1a\u5b83\u5bf9\u5e94\u7684\u5b9a\u4e49\u5728\u7b2c49--50\u884c\uff0c\u5185\u5bb9\u5f88\u7b80\u5355\uff0c\u5c31\u662fkernel\u4e0b\u7684\u6240\u6709\u6c47\u7f16.S\u6587\u4ef6\u548c\u6240\u6709\u7684.c\u6587\u4ef6\u3002\u5904\u7406\u8be5\u4f9d\u8d56\u6784\u9020\u76ee\u6807\uff0c\u4f1a\u5c06kernel\u5b50\u76ee\u5f55\u4e0b\u7684\u6240\u6709\u6c47\u7f16\u548cC\u6e90\u6587\u4ef6\u7f16\u8bd1\u6210\u5bf9\u5e94\u7684.o\u6587\u4ef6\u3002</li> </ul> <p>\u4ee5\u4e0a\u4f9d\u8d56\u76ee\u6807\u5168\u90e8\u6784\u9020\u5b8c\u6bd5\u540e\uff0c\u56de\u5230\u7b2c101--103\u884c\u7684<code>$(KERNEL_TARGET)</code>\u76ee\u6807\u6240\u5bf9\u5e94\u7684\u52a8\u4f5c\uff0c\u5c06\u7f16\u8bd1kernel\u76ee\u5f55\u4e0b\u7684\u6e90\u6587\u4ef6\u6240\u5f97\u5230\u7684.o\u6587\u4ef6\u4e0e<code>$(OBJ_DIR)/spike_interface.a</code>\u8fdb\u884c\u94fe\u63a5\uff0c\u5e76\u6700\u7ec8\u751f\u6210\u6211\u4eec\u7684\u4ee3\u7406\u5185\u6838<code>$(OBJ_DIR)/riscv-pke</code>\u3002\u81f3\u6b64\uff0cPKE\u5b9e\u9a8c\u6240\u9700\u8981\u7684\u4ee3\u7801\u6784\u9020\u5b8c\u6bd5\u3002\u603b\u7ed3\u4e00\u4e0b\uff0c\u8fd9\u4e2a\u6784\u9020\u8fc7\u7a0b\u662f\uff1a</p> <ul> <li>1\uff09\u6784\u9020util\u76ee\u5f55\u4e0b\u7684\u9759\u6001\u5e93\u6587\u4ef6<code>$(OBJ_DIR)/util.a</code>\uff1b</li> <li>2\uff09\u6784\u9020\u5e94\u7528\u7a0b\u5e8f\uff0c\u5f97\u5230<code>$(OBJ_DIR)/app_helloworld</code>\uff1b</li> <li>3\uff09\u6784\u9020<code>$(OBJ_DIR)/spike_interface.a</code>\uff0c\u5373spike\u6240\u63d0\u4f9b\u7684\u5de5\u5177\u5e93\u6587\u4ef6\uff1b</li> <li>4\uff09\u6700\u540e\u6784\u9020\u4ee3\u7406\u5185\u6838<code>$(OBJ_DIR)/riscv-pke</code>\u3002</li> </ul> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter3_traps/#314","title":"3.1.4 \u4ee3\u7406\u5185\u6838\u7684\u542f\u52a8\u8fc7\u7a0b","text":"<p>\u57283.1.1\u4e2d\uff0c\u6211\u4eec\u83b7\u53d6riscv-pke\u7684\u4ee3\u7801\u5e76\u5b8c\u6210\u6784\u9020\u6b65\u9aa4\u540e\uff0c\u6211\u4eec\u5c06\u901a\u8fc7\u4ee5\u4e0b\u547d\u4ee4\u5f00\u59cblab1_1\u6240\u7ed9\u5b9a\u7684\u5e94\u7528\u7684\u6267\u884c\uff1a</p> <pre><code>$ spike ./obj/riscv-pke ./obj/app_helloworld\nIn m_start, hartid:0\nHTIF is available!\n(Emulated) memory size: 2048 MB\nEnter supervisor mode...\nApplication: ./obj/app_helloworld\nApplication program entry point (virtual address): 0x0000000081000000\nSwitching to user mode...\ncall do_syscall to accomplish the syscall and lab1_1 here.\n\nSystem is shutting down with exit code -1.\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u8be5\u547d\u4ee4\u67093\u4e2a\u90e8\u5206\u7ec4\u6210\uff1aspike\u3001./obj/riscv-pke\u4ee5\u53ca./obj/app_helloworld\u3002\u5176\u4e2dspike\u662f\u6211\u4eec\u5728\u7b2c\u4e8c\u7ae0\u5b89\u88c5\u7684RISC-V\u6a21\u62df\u5668\uff0c\u6267\u884c\u5b83\u7684\u6548\u679c\u662f\u6a21\u62df\u51fa\u4e00\u4e2a\u652f\u6301RV64G\u6307\u4ee4\u96c6\u7684RISC-V\u673a\u5668\uff1b./obj/riscv-pke\u662f\u6211\u4eec\u7684PKE\u4ee3\u7406\u5185\u6838\uff1b\u800c./obj/app_helloworld\u662f\u6211\u4eec\u5728lab1_1\u4e2d\u7ed9\u5b9a\u7684\u5e94\u7528\u3002</p> <p>\u90a3\u4e48\u4ee3\u7406\u5185\u6838\u662f\u5982\u4f55\u5728spike\u6a21\u62df\u7684RISC-V\u673a\u5668\u4e0a\u542f\u52a8\u7684\u5462\uff1f\u5b9e\u9645\u4e0a\uff0c\u8fd9\u4e2a\u542f\u52a8\u8fc7\u7a0b\u6bd4\u6211\u4eec\u5b9e\u9645\u7684\u7269\u7406\u673a\u7684\u542f\u52a8\u8fc7\u7a0b\u7b80\u5355\u5f97\u591a\uff0c\u4ee3\u7406\u5185\u6838\u5b9e\u9645\u4e0a\u662fspike\u6a21\u62df\u5668\u5c06\u5176\u5f53\u4f5c\u662f\u4e00\u4e2a\u6807\u51c6ELF\u6587\u4ef6\u8f7d\u5165\u7684\u3002\u90a3\u4e48\u65e2\u7136\u662f\u201c\u53ef\u6267\u884c\u201d\u7684ELF\u6587\u4ef6\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u7528\u4ea4\u53c9\u7f16\u8bd1\u5668\u91cc\u63d0\u4f9b\u7684\u5de5\u5177\u89c2\u5bdf\u5b83\u7684\u7ed3\u6784\uff1a</p> <pre><code>$ riscv64-unknown-elf-readelf -h ./obj/riscv-pke\nELF Header:\n  Magic:   7f 45 4c 46 02 01 01 00 00 00 00 00 00 00 00 00\nClass:                             ELF64\n  Data:                              2's complement, little endian\n  Version:                           1 (current)\nOS/ABI:                            UNIX - System V\n  ABI Version:                       0\nType:                              EXEC (Executable file)\nMachine:                           RISC-V\n  Version:                           0x1\n  Entry point address:               0x80000548\n  Start of program headers:          64 (bytes into file)\nStart of section headers:          130760 (bytes into file)\nFlags:                             0x5, RVC, double-float ABI\n  Size of this header:               64 (bytes)\nSize of program headers:           56 (bytes)\nNumber of program headers:         2\nSize of section headers:           64 (bytes)\nNumber of section headers:         18\nSection header string table index: 17\n$ riscv64-unknown-elf-readelf -l ./obj/riscv-pke\n\nElf file type is EXEC (Executable file)\nEntry point 0x80000548\nThere are 2 program headers, starting at offset 64\nProgram Headers:\n  Type           Offset             VirtAddr           PhysAddr\n                 FileSiz            MemSiz              Flags  Align\n  LOAD           0x0000000000001000 0x0000000080000000 0x0000000080000000\n                 0x0000000000003564 0x0000000000003564  R E    0x1000\n  LOAD           0x0000000000005000 0x0000000080004000 0x0000000080004000\n                 0x0000000000001411 0x00000000000098b8  RW     0x1000\n\nSection to Segment mapping:\n  Segment Sections...\n   00     .text .rodata\n   01     .htif .data .bss\n</code></pre> <p>\u901a\u8fc7\u4ee5\u4e0a\u547d\u4ee4\u548c\u8f93\u51fa\uff0c\u6211\u4eec\u53ef\u4ee5\u5f97\u77e5./obj/riscv-pke\u8fd9\u4e2aELF\u6587\u4ef6\u7684\u5165\u53e3\u5730\u5740\u662f0x80000548\uff0c\u4e14\u5b83\u6709\u4e24\u4e2a\u7a0b\u5e8f\u6bb5\uff08segment\uff09\uff0c\u5206\u522b\u662f00\u53f7\u4ee3\u7801\u6bb5\u548c01\u53f7\u6570\u636e\u6bb5\u3002\u5176\u4e2d00\u53f7\u4ee3\u7801\u6bb5\u7684\u6bb5\u9996\u5730\u5740\u662f0x80000000\uff0c\u957f\u5ea6\u662f0x3564\uff1b01\u53f7\u6570\u636e\u6bb5\u7684\u6bb5\u9996\u5730\u5740\u662f0x80004000\uff0c\u957f\u5ea6\u662f0x98b8\u3002</p> <p>\u90a3\u4e48\u4e3a\u4ec0\u4e48./obj/riscv-pke\u7684\u6bb5\u9996\u5730\u5740\u662f0x80000000\u5462\uff1f\u8fd9\u662f\u95ee\u9898\u901a\u8fc7\u9605\u8bfbkernel/kernel.lds\u5c31\u4e00\u76ee\u4e86\u7136\u4e86\uff0c\u56e0\u4e3a\u540e\u8005\u89c4\u5b9a\u4e86<code>. = 0x80000000</code>\u5373\u6240\u6709\u865a\u5730\u5740\u4ece0x80000000\u5f00\u59cb\u3002\u66f4\u8fdb\u4e00\u6b65\uff0c\u4e3a\u4ec0\u4e48\u8981\u901a\u8fc7\u5c06\u903b\u8f91\u5730\u5740\u7684\u5f00\u59cb\u56fa\u5b9a\u57280x80000000\u8fd9\u4e2a\u4f4d\u7f6e\u5462\uff1f\u8fd9\u662f\u56e0\u4e3aspike\u5728\u6a21\u62df\u4e00\u4e2aRISC-V\u673a\u5668\u65f6\uff0c\u4f1a\u5c06\u5176\u6a21\u62df\u7684\u5185\u5b58\uff08\u53ef\u901a\u8fc7spike\u7684-m\u5f00\u5173\u6307\u5b9a\u5927\u5c0f\uff09\u653e\u7f6e\u57280x80000000\u8fd9\u4e2a\u7269\u7406\u5730\u5740\u5f00\u59cb\u7684\u5730\u65b9\u3002\u4f8b\u5982\uff0c\u9ed8\u8ba4\u60c5\u51b5\u4e0bspike\u4f1a\u4e3a\u5b83\u521b\u5efa\u7684RISC-V\u673a\u5668\u6a21\u62df2GB\uff082^31\uff0c0x80000000\uff09\u5185\u5b58\uff0c\u6b64\u65f6\uff0c\u6709\u6548\u7269\u7406\u5185\u5b58\u7684\u8303\u56f4\u5c31\u4e3a[0x80000000, 0xffffffff]\u3002\u8fd9\u6837\uff0c\u6211\u4eec\u5c31\u53d1\u73b0\u4e86\u4e00\u4e2a\u201c\u5de7\u5408\u201d\uff0c\u5373\u4ee3\u7406\u5185\u6838\u7684\u865a\u5730\u5740\u8d77\u59cb\u5730\u5740=\u7269\u7406\u5185\u5b58\u7684\u8d77\u59cb\u5730\u5740\uff01\u6709\u4e86\u8fd9\u4e2a\u5de7\u5408\uff0cspike\u5c31\u53ea\u9700\u8981\u5c06\u4ee3\u7406\u5185\u6838\u7684\u4e24\u4e2a\u6bb5\u52a0\u8f7d\u5230RISC-V\u673a\u5668\u5185\u5b58\u5f00\u59cb\u7684\u5730\u65b9\uff0c\u6700\u540e\u5c06\u63a7\u5236\u6743\u4ea4\u7ed9\u4ee3\u7406\u5185\u6838\uff08\u5c06\u4ee3\u7406\u5185\u6838\u7684\u5165\u53e3\u5730\u5740\u5199\u5230epc\u4e2d\uff09\u5373\u53ef\u3002\u540c\u65f6\uff0c\u7531\u4e8e\u4ee3\u7406\u5185\u6838\u5728\u7f16\u8bd1\u7684\u65f6\u5019\u9ed8\u8ba4\u7684\u8d77\u59cb\u5730\u5740\u4e5f\u662f0x80000000\uff0c\u6240\u4ee5\u5b83\u7684\u6267\u884c\u65e0\u9700\u505a\u4efb\u4f55\u865a\u62df\u5730\u5740\u5230\u7269\u7406\u5730\u5740\u7684\u8f6c\u6362\uff0c\u4e14\u4e0d\u4f1a\u53d1\u751f\u9519\u8bef\u3002</p> <p>\u53e6\u5916\uff0c./obj/riscv-pke\u7684\u5165\u53e3\u5730\u57400x80000548\u5bf9\u5e94\u4ee3\u7801\u4e2d\u7684\u54ea\u4e2a\u51fd\u6570\u5462\uff1f\u8fd9\u7ed9\u6211\u4eec\u4e5f\u53ef\u4ee5\u901a\u8fc7\u9605\u8bfbkernel/kernel.lds\u5f97\u77e5\uff1a</p> <pre><code>  1 /* See LICENSE for license details. */\n  2\n3 OUTPUT_ARCH( \"riscv\" )\n4\n5 ENTRY( _mentry )\n6\n7 SECTIONS\n  8 {\n9\n10   /*--------------------------------------------------------------------*/\n 11   /* Code and read-only segment                                         */\n 12   /*--------------------------------------------------------------------*/\n 13\n14   /* Begining of code and text segment, starts from DRAM_BASE to be effective before enabling paging */\n 15   . = 0x80000000;\n16   _ftext = .;\n17\n18   /* text: Program code section */\n 19   .text :\n 20   {\n21     *(.text)\n22     *(.text.*)\n23     *(.gnu.linkonce.t.*)\n24     . = ALIGN(0x1000);\n25\n26     _trap_sec_start = .;\n27     *(trapsec)\n28     . = ALIGN(0x1000);\n29   /*   ASSERT(. - _trap_sec_start == 0x1000, \"error: trap section larger than one page\");   */\n 30   }\n</code></pre> <p>\u4ee5\u4e0a\u5217\u51fa\u4e86\u90e8\u5206kernel/kernel.lds\u7684\u5185\u5bb9\uff0c\u4ece\u7b2c5\u884c\u53ef\u77e5\u5185\u6838\u7684\u5165\u53e3\u5730\u5740\u662f_mentry \u51fd\u6570\uff0c\u901a\u8fc7:</p> <pre><code>$ riscv64-unknown-elf-objdump -D ./obj/riscv-pke | grep _mentry\n0000000080000548 &lt;_mentry&gt;:\n</code></pre> <p>\u6211\u4eec\u8fdb\u4e00\u6b65\u786e\u5b9a\u4e86\u4ee3\u7406\u5185\u6838\u7684\u5165\u53e3\uff0c\u5373_mentry\u51fd\u6570\u3002</p> <p>\u5b9e\u9645\u4e0a_mentry\u51fd\u6570\u662f\u5728kernel/machine/mentry.S\u6587\u4ef6\u4e2d\u5b9a\u4e49\u7684\uff1a</p> <pre><code> 13   .globl _mentry\n 14 _mentry:\n 15     # [mscratch] = 0; mscratch points the stack bottom of machine mode computer\n 16     csrw mscratch, x0\n 17\n 18     # following codes allocate a 4096-byte stack for each HART, although we use only\n 19     # ONE HART in this lab.\n 20     la sp, stack0       # stack0 is statically defined in kernel/machine/minit.c\n 21     li a3, 4096         # 4096-byte stack\n 22     csrr a4, mhartid    # [mhartid] = core ID\n 23     addi a4, a4, 1\n 24     mul a3, a3, a4\n 25     add sp, sp, a3      # re-arrange the stack points so that they don't overlap\n 26\n 27     # jump to mstart(), i.e., machine state start function in kernel/machine/minit.c\n 28     call m_start\n</code></pre> <p>\u5b83\u7684\u6267\u884c\u5c06\u673a\u5668\u590d\u4f4d\uff0816\u884c\uff09\u4e3a\u5728\u4e0d\u540c\u5904\u7406\u5668\u4e0a\uff08\u6211\u4eec\u5728PKE\u7684\u57fa\u7840\u5b9e\u9a8c\u4e2d\u53ea\u8003\u8651\u5355\u4e2a\u5904\u7406\u5668\u7684\u60c5\u51b5\uff09\u8fd0\u884c\u7684\u5185\u6838\u5206\u914d\u5927\u5c0f\u4e3a4KB\u7684\u6808\uff0820--25\u884c\uff09\uff0c\u5e76\u5728\u6700\u540e\uff0828\u884c\uff09\u8c03\u7528m_start\u51fd\u6570\u3002m_start\u51fd\u6570\u662f\u5728kernel/machine/minit.c\u6587\u4ef6\u4e2d\u5b9a\u4e49\u7684\uff1a</p> <pre><code> 77 void m_start(uintptr_t hartid, uintptr_t dtb) {\n78   // init the spike file interface (stdin,stdout,stderr)\n79   // functions with \"spike_\" prefix are all defined in codes under spike_interface/,\n80   // sprint is also defined in spike_interface/spike_utils.c\n81   spike_file_init();\n82   sprint(\"In m_start, hartid:%d\\n\", hartid);\n83\n84   // init HTIF (Host-Target InterFace) and memory by using the Device Table Blob (DTB)\n85   // init_dtb() is defined above.\n86   init_dtb(dtb);\n87\n88   // set previous privilege mode to S (Supervisor), and will enter S mode after 'mret'\n89   // write_csr is a macro defined in kernel/riscv.h\n90   write_csr(mstatus, ((read_csr(mstatus) &amp; ~MSTATUS_MPP_MASK) | MSTATUS_MPP_S));\n91\n92   // set M Exception Program Counter to sstart, for mret (requires gcc -mcmodel=medany)\n93   write_csr(mepc, (uint64)s_start);\n94\n95   // delegate all interrupts and exceptions to supervisor mode.\n96   // delegate_traps() is defined above.\n97   delegate_traps();\n98\n99   // switch to supervisor mode (S mode) and jump to s_start(), i.e., set pc to mepc\n100   asm volatile(\"mret\");\n101 }\n</code></pre> <p>\u5b83\u7684\u4f5c\u7528\u662f\u9996\u5148\u521d\u59cb\u5316spike\u7684\u5ba2\u6237\u673a-\u4e3b\u673a\u63a5\u53e3\uff08Host-Target InterFace\uff0c\u7b80\u79f0HTIF\uff09\uff0c\u4ee5\u53ca\u627f\u8f7d\u4e8e\u5176\u4e0a\u7684\u6587\u4ef6\u63a5\u53e3\uff0881-86\u884c\uff09\uff1b\u4eba\u4e3a\u7684\u5c06\u4e0a\u4e00\u4e2a\u72b6\u6001\uff08\u673a\u5668\u542f\u52a8\u65f6\u7684\u72b6\u6001\u4e3aM\u6001\uff0c\u5373Machine\u6001\uff09\u8bbe\u7f6e\u4e3aS\uff08Supervisor\uff09\u6001\uff0c\u5e76\u5c06\u201c\u9000\u56de\u201d\u5230S\u6001\u7684\u51fd\u6570\u6307\u9488s_start\u5199\u5230mepc\u5bc4\u5b58\u5668\u4e2d\uff0890--93\u884c\uff09\uff1b\u63a5\u4e0b\u6765\uff0c\u5c06\u4e2d\u65ad\u5f02\u5e38\u5904\u7406\u201c\u4ee3\u7406\u201d\u7ed9S\u6001\uff0897\u884c\uff09\uff1b\u6700\u540e\uff0c\u6267\u884c\u8fd4\u56de\u52a8\u4f5c\uff08100\u884c\uff09\u3002\u7531\u4e8e\u4e4b\u524d\u4eba\u4e3a\u5730\u5c06\u4e0a\u4e00\u4e2a\u72b6\u6001\u8bbe\u7f6e\u4e3aS\u6001\uff0c\u6240\u4ee5\u7b2c100\u884c\u7684\u8fd4\u56de\u52a8\u4f5c\u5c06\u201c\u8fd4\u56de\u201dS\u6001\uff0c\u5e76\u8fdb\u5165s_start\u51fd\u6570\u6267\u884c\u3002</p> <p>s_start\u51fd\u6570\u5728kernel/kernel.c\u6587\u4ef6\u4e2d\u5b9a\u4e49\uff1a</p> <pre><code> 34 int s_start(void) {\n35   sprint(\"Enter supervisor mode...\\n\");\n36   // Note: we use direct (i.e., Bare mode) for memory mapping in lab1.\n37   // which means: Virtual Address = Physical Address\n38   // therefore, we need to set satp to be 0 for now. we will enable paging in lab2_x.\n39   //\n40   // write_csr is a macro defined in kernel/riscv.h\n41   write_csr(satp, 0);\n42\n43   // the application code (elf) is first loaded into memory, and then put into execution\n44   load_user_program(&amp;user_app);\n45\n46   sprint(\"Switch to user mode...\\n\");\n47   // switch_to() is defined in kernel/process.c\n48   switch_to(&amp;user_app);\n49\n50   // we should never reach here.\n51   return 0;\n52 }\n</code></pre> <p>\u8be5\u51fd\u6570\u7684\u52a8\u4f5c\u4e5f\u975e\u5e38\u7b80\u5355\uff1a\u9996\u5148\u5c06\u5730\u5740\u6620\u5c04\u6a21\u5f0f\u7f6e\u4e3a\uff0841\u884c\uff09\u76f4\u6620\u5c04\u6a21\u5f0f\uff08Bare mode\uff09\uff0c\u63a5\u4e0b\u6765\u8c03\u7528\uff0844\u884c\uff09load_user_program()\u51fd\u6570\uff0c\u5c06\u5e94\u7528\uff08\u4e5f\u5c31\u662f\u6700\u5f00\u59cb\u7684\u547d\u4ee4\u884c\u4e2d\u7684./obj/app_helloworld\uff09\u8f7d\u5165\u5185\u5b58\uff0c\u5c01\u88c5\u6210\u4e00\u4e2a\u6700\u7b80\u5355\u7684\u201c\u8fdb\u7a0b\uff08process\uff09\u201d\uff0c\u6700\u7ec8\u8c03\u7528switch_to()\u51fd\u6570\uff0c\u5c06\u8fd9\u4e2a\u7b80\u5355\u5f97\u4e0d\u80fd\u518d\u7b80\u5355\u7684\u8fdb\u7a0b\u6295\u5165\u8fd0\u884c\u3002</p> <p>\u4ee5\u4e0a\u8fc7\u7a0b\u4e2d\uff0cload_user_program()\u51fd\u6570\u7684\u4f5c\u7528\u662f\u5c06\u6211\u4eec\u7684\u7ed9\u5b9a\u5e94\u7528\uff08user/app_helloworld.c\uff09\u6240\u5bf9\u5e94\u7684\u53ef\u6267\u884cELF\u6587\u4ef6\uff08\u5373./obj/app_helloworld\u6587\u4ef6\uff09\u8f7d\u5165spike\u865a\u62df\u5185\u5b58\uff0c\u8fd9\u4e2a\u8fc7\u7a0b\u6211\u4eec\u5c06\u57283.1.5\u4e2d\u8be6\u7ec6\u8ba8\u8bba\u3002\u53e6\u4e00\u4e2a\u51fd\u6570\u662fswitch_to()\uff0c\u4e3a\u4e86\u7406\u89e3\u8fd9\u4e2a\u51fd\u6570\u7684\u884c\u4e3a\uff0c\u9700\u8981\u5148\u5bf9lab1\u4e2d\u201c\u8fdb\u7a0b\u201d\u7684\u5b9a\u4e49\u6709\u4e00\u5b9a\u7684\u4e86\u89e3\uff08kernel/process.h\uff09\uff1a</p> <pre><code> 19 typedef struct process {\n20   // pointing to the stack used in trap handling.\n21   uint64 kstack;\n22   // trapframe storing the context of a (User mode) process.\n23   trapframe* trapframe;\n24 }process;\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0clab1\u4e2d\u5b9a\u4e49\u7684\u201c\u8fdb\u7a0b\u201d\u975e\u5e38\u7b80\u5355\uff0c\u5b83\u53ea\u5305\u542b\u4e86\u4e00\u4e2a\u6808\u6307\u9488\uff08kstack\uff09\u4ee5\u53ca\u4e00\u4e2a\u6307\u5411trapframe\u7ed3\u6784\u7684\u6307\u9488\u3002trapframe\u7ed3\u6784\u4e5f\u5728kernel/process.h\u6587\u4ef6\u4e2d\u88ab\u5b9a\u4e49\uff1a</p> <pre><code>  6 typedef struct trapframe {\n7   // space to store context (all common registers)\n8   /* offset:0   */ riscv_regs regs;\n9\n10   // process's \"user kernel\" stack\n11   /* offset:248 */ uint64 kernel_sp;\n12   // pointer to smode_trap_handler\n13   /* offset:256 */ uint64 kernel_trap;\n14   // saved user process counter\n15   /* offset:264 */ uint64 epc;\n16 }trapframe;\n</code></pre> <p>\u8be5\u7ed3\u6784\u9664\u4e86\u8bb0\u5f55\u8fdb\u7a0b\u4e0a\u4e0b\u6587\u7684RISC-V\u673a\u5668\u7684\u901a\u7528\u5bc4\u5b58\u5668\u7ec4\uff08regs\u6210\u5458\uff09\u5916\uff0c\u8fd8\u5305\u62ec\u5f88\u5c11\u7684\u5176\u4ed6\u6210\u5458\uff08\u5982\u6307\u5411\u5185\u6838\u6001\u6808\u9876\u7684kernel_sp\uff0c\u6307\u5411\u5185\u6838\u6001trap\u5904\u7406\u51fd\u6570\u5165\u53e3\u7684kernel_trap\u6307\u9488\uff0c\u8fdb\u7a0b\u6267\u884c\u7684\u5f53\u524d\u4f4d\u7f6eepc\uff09\u3002</p> <p>\u56de\u5230switch_to()\u51fd\u6570\uff0c\u5b83\u5728kernel/process.c\u6587\u4ef6\u4e2d\u5b9a\u4e49\uff1a</p> <pre><code> 28 void switch_to(process* proc) {\n29   assert(proc);\n30   current = proc;\n31\n32   // write the smode_trap_vector (64-bit func. address) defined in kernel/strap_vector.S\n33   // to the stvec privilege register, such that trap handler pointed by smode_trap_vector\n34   // will be triggered when an interrupt occurs in S mode.\n35   write_csr(stvec, (uint64)smode_trap_vector);\n36\n37   // set up trapframe values (in process structure) that smode_trap_vector will need when\n38   // the process next re-enters the kernel.\n39   proc-&gt;trapframe-&gt;kernel_sp = proc-&gt;kstack;  // process's kernel stack\n40   proc-&gt;trapframe-&gt;kernel_trap = (uint64)smode_trap_handler;\n41\n42   // SSTATUS_SPP and SSTATUS_SPIE are defined in kernel/riscv.h\n43   // set S Previous Privilege mode (the SSTATUS_SPP bit in sstatus register) to User mode.\n44   unsigned long x = read_csr(sstatus);\n45   x &amp;= ~SSTATUS_SPP;  // clear SPP to 0 for user mode\n46   x |= SSTATUS_SPIE;  // enable interrupts in user mode\n47\n48   // write x back to 'sstatus' register to enable interrupts, and sret destination mode.\n49   write_csr(sstatus, x);\n50\n51   // set S Exception Program Counter (sepc register) to the elf entry pc.\n52   write_csr(sepc, proc-&gt;trapframe-&gt;epc);\n53\n54   // return_to_user() is defined in kernel/strap_vector.S. switch to user mode with sret.\n55   return_to_user(proc-&gt;trapframe);\n56 }\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u8be5\u51fd\u6570\u7684\u4f5c\u7528\u662f\u521d\u59cb\u5316\u8fdb\u7a0b\u7684process\u7ed3\u6784\u4f53\uff0c\u5e76\u6700\u7ec8\u8c03\u7528return_to_user(proc-&gt;trapframe)\u51fd\u6570\u5c06\u8f7d\u5165\u7684\u5e94\u7528\uff08\u6240\u5c01\u88c5\u7684\u8fdb\u7a0b\uff09\u6295\u5165\u8fd0\u884c\u3002return_to_user()\u51fd\u6570\u5728kernel/strap_vector.S\u6587\u4ef6\u4e2d\u5b9a\u4e49\uff1a</p> <pre><code> 49 .globl return_to_user\n 50 return_to_user:\n 51     # [sscratch]=[a0], save a0 in sscratch, so sscratch points to a trapframe now.\n 52     csrw sscratch, a0\n 53\n 54     # let [t6]=[a0]\n 55     addi t6, a0, 0\n 56\n 57     # restore_all_registers is a assembly macro defined in util/load_store.S.\n 58     # the macro restores all registers from trapframe started from [t6] to all general\n 59     # purpose registers, so as to resort the execution of a process.\n 60     restore_all_registers\n 61\n 62     # return to user mode and user pc.\n 63     sret\n</code></pre> <p>\u5176\u4f5c\u7528\u662f\u6062\u590d\u8fdb\u7a0b\u7684\u4e0a\u4e0b\u6587\uff0860\u884c\uff09\u5230RISC-V\u673a\u5668\u7684\u6240\u6709\u5bc4\u5b58\u5668\uff0c\u5e76\u8c03\u7528sret\u6307\u4ee4\uff0c\u4eceS\u6a21\u5f0f\u201c\u8fd4\u56de\u201d\u5e94\u7528\u6a21\u5f0f\uff08\u5373U\u6a21\u5f0f\uff09\u3002\u8fd9\u6837\uff0c\u6240\u8f7d\u5165\u7684\u5e94\u7528\u7a0b\u5e8f\uff08\u5373obj/app_helloworld\u6240\u5bf9\u5e94\u7684\u201c\u8fdb\u7a0b\u201d\uff09\u5c31\u6295\u5165\u8fd0\u884c\u4e86\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter3_traps/#315-elfapp","title":"3.1.5 ELF\u6587\u4ef6\uff08app\uff09\u7684\u52a0\u8f7d\u8fc7\u7a0b","text":"<p>\u8fd9\u91cc\u6211\u4eec\u5bf9load_user_program()\u51fd\u6570\u8fdb\u884c\u8ba8\u8bba\uff0c\u5b83\u5728kernel/kernel.c\u4e2d\u5b9a\u4e49\uff1a</p> <pre><code> 19 void load_user_program(process *proc) {\n20   // USER_TRAP_FRAME is a physical address defined in kernel/config.h\n21   proc-&gt;trapframe = (trapframe *)USER_TRAP_FRAME;\n22   memset(proc-&gt;trapframe, 0, sizeof(trapframe));\n23   // USER_KSTACK is also a physical address defined in kernel/config.h\n24   proc-&gt;kstack = USER_KSTACK;\n25   proc-&gt;trapframe-&gt;regs.sp = USER_STACK;\n26\n27   // load_bincode_from_host_elf() is defined in kernel/elf.c\n28   load_bincode_from_host_elf(proc);\n29 }\n</code></pre> <p>\u6211\u4eec\u770b\u5230\uff0c\u5b83\u7684\u4f5c\u7528\u662f\u9996\u5148\u5bf9\u8fdb\u7a0b\u58f3\u505a\u4e86\u4e00\u5b9a\u7684\u521d\u59cb\u5316\uff0c\u6700\u540e\u8c03\u7528load_bincode_from_host_elf()\u51fd\u6570\u5c06\u5e94\u7528\u7a0b\u5e8f\u5bf9\u5e94\u7684\u4e8c\u8fdb\u5236\u4ee3\u7801\u5b9e\u9645\u5730\u8f7d\u5165\u3002load_bincode_from_host_elf()\u51fd\u6570\u5728kernel/elf.c\u6587\u4ef6\u4e2d\u5b9e\u9645\u5b9a\u4e49\uff1a</p> <pre><code>107 void load_bincode_from_host_elf(process *p) {\n108   arg_buf arg_bug_msg;\n109\n110   // retrieve command line arguements\n111   size_t argc = parse_args(&amp;arg_bug_msg);\n112   if (!argc) panic(\"You need to specify the application program!\\n\");\n113\n114   sprint(\"Application: %s\\n\", arg_bug_msg.argv[0]);\n115\n116   //elf loading. elf_ctx is defined in kernel/elf.h, used to track the loading process.\n117   elf_ctx elfloader;\n118   // elf_info is defined above, used to tie the elf file and its corresponding process.\n119   elf_info info;\n120\n121   info.f = spike_file_open(arg_bug_msg.argv[0], O_RDONLY, 0);\n122   info.p = p;\n123   // IS_ERR_VALUE is a macro defined in spike_interface/spike_htif.h\n124   if (IS_ERR_VALUE(info.f)) panic(\"Fail on openning the input application program.\\n\");\n125\n126   // init elfloader context. elf_init() is defined above.\n127   if (elf_init(&amp;elfloader, &amp;info) != EL_OK)\n128     panic(\"fail to init elfloader.\\n\");\n129\n130   // load elf. elf_load() is defined above.\n131   if (elf_load(&amp;elfloader) != EL_OK) panic(\"Fail on loading elf.\\n\");\n132\n133   // entry (virtual, also physical in lab1_x) address\n134   p-&gt;trapframe-&gt;epc = elfloader.ehdr.entry;\n135\n136   // close the host spike file\n137   spike_file_close( info.f );\n138\n139   sprint(\"Application program entry point (virtual address): 0x%lx\\n\", p-&gt;trapframe-&gt;epc);\n140 }\n</code></pre> <p>\u8be5\u51fd\u6570\u7684\u5927\u81f4\u8fc7\u7a0b\u662f\uff1a</p> <ul> <li>\uff08108--114\u884c\uff09\u9996\u5148\uff0c\u89e3\u6790\u547d\u4ee4\u884c\u53c2\u6570\uff0c\u83b7\u5f97\u9700\u8981\u52a0\u8f7d\u7684ELF\u6587\u4ef6\u6587\u4ef6\u540d\uff1b</li> <li>\uff08117--128\u884c\uff09\u63a5\u4e0b\u6765\uff0c\u521d\u59cb\u5316ELF\u52a0\u8f7d\u6570\u636e\u7ed3\u6784\uff0c\u5e76\u6253\u5f00\u5373\u5c06\u88ab\u52a0\u8f7d\u7684ELF\u6587\u4ef6\uff1b</li> <li>\uff08131\u884c\uff09\u52a0\u8f7dELF\u6587\u4ef6\uff1b</li> <li>\uff08134\u884c\uff09\u901a\u8fc7ELF\u6587\u4ef6\u63d0\u4f9b\u7684\u5165\u53e3\u5730\u5740\u8bbe\u7f6e\u8fdb\u7a0b\u7684trapframe-&gt;epc\uff0c\u4fdd\u8bc1\u201c\u8fd4\u56de\u201d\u7528\u6237\u6001\u7684\u65f6\u5019\uff0c\u6240\u52a0\u8f7d\u7684ELF\u6587\u4ef6\u88ab\u6267\u884c\uff1b</li> <li>\uff08137--139\u884c\uff09\u5173\u95edELF\u6587\u4ef6\u5e76\u8fd4\u56de\u3002</li> </ul> <p>\u8be5\u51fd\u6570\u7528\u5230\u4e86\u540c\u6587\u4ef6\u4e2d\u7684\u8bf8\u591a\u5de5\u5177\u51fd\u6570\uff0c\u8fd9\u4e9b\u51fd\u6570\u7684\u7ec6\u8282\u8bf7\u8bfb\u8005\u81ea\u884c\u9605\u8bfb\u76f8\u5173\u4ee3\u7801\uff0c\u8fd9\u91cc\u6211\u4eec\u53ea\u8d34\u6211\u4eec\u8ba4\u4e3a\u91cd\u8981\u7684\u4ee3\u7801\uff1a</p> <ul> <li>spike_file_open/spike_file_close\uff1a\u8fd9\u4e24\u4e2a\u51fd\u6570\u5728spike_interface/spike_file.c\u6587\u4ef6\u4e2d\u5b9a\u4e49\uff0c\u5b83\u7684\u4f5c\u7528\u662f\u901a\u8fc7spike\u7684HTIF\u63a5\u53e3\u6253\u5f00/\u5173\u95ed\u4f4d\u4e8e\u4e3b\u673a\u4e0a\u7684ELF\u6587\u4ef6\u3002spike\u7684HTIF\u63a5\u53e3\u76f8\u5173\u77e5\u8bc6\uff0c\u6211\u4eec\u5c06\u57283.1.7\u4e2d\u505a\u7b80\u8981\u7684\u8ba8\u8bba\uff1b</li> <li>elf_init\uff1a\u8be5\u51fd\u6570\u7684\u4f5c\u7528\u662f\u521d\u59cb\u5316elf_ctx\u7c7b\u578b\u7684elfloader\u7ed3\u6784\u4f53\u3002\u8be5\u521d\u59cb\u5316\u8fc7\u7a0b\u5c06\u8bfb\u53d6\u7ed9\u5b9aELF\u7684\u6587\u4ef6\u5934\uff0c\u786e\u4fdd\u5b83\u662f\u4e00\u4e2a\u6b63\u786e\u7684ELF\u6587\u4ef6\uff1b</li> <li>elf_load\uff1a\u8bfb\u5165ELF\u6587\u4ef6\u4e2d\u6240\u5305\u542b\u7684\u7a0b\u5e8f\u6bb5\uff08segment\uff09\u5230\u7ed9\u5b9a\u7684\u5185\u5b58\u5730\u5740\u4e2d\u3002elf_load\u7684\u5177\u4f53\u5b9e\u73b0\u5982\u4e0b\uff1a</li> </ul> <pre><code> 53 elf_status elf_load(elf_ctx *ctx) {\n54   // elf_prog_header structure is defined in kernel/elf.h\n55   elf_prog_header ph_addr;\n56   int i, off;\n57\n58   // traverse the elf program segment headers\n59   for (i = 0, off = ctx-&gt;ehdr.phoff; i &lt; ctx-&gt;ehdr.phnum; i++, off += sizeof(ph_addr)) {\n60     // read segment headers\n61     if (elf_fpread(ctx, (void *)&amp;ph_addr, sizeof(ph_addr), off) != sizeof(ph_addr)) return EL    _EIO;\n62\n63     if (ph_addr.type != ELF_PROG_LOAD) continue;\n64     if (ph_addr.memsz &lt; ph_addr.filesz) return EL_ERR;\n65     if (ph_addr.vaddr + ph_addr.memsz &lt; ph_addr.vaddr) return EL_ERR;\n66\n67     // allocate memory block before elf loading\n68     void *dest = elf_alloc_mb(ctx, ph_addr.vaddr, ph_addr.vaddr, ph_addr.memsz);\n69\n70     // actual loading\n71     if (elf_fpread(ctx, dest, ph_addr.memsz, ph_addr.off) != ph_addr.memsz)\n72       return EL_EIO;\n73   }\n74\n75   return EL_OK;\n76 }\n</code></pre> <p>\u8fd9\u4e2a\u51fd\u6570\u91cc\uff0c\u6211\u4eec\u9700\u8981\u8bf4\u4e00\u4e0belf_alloc_mb()\u51fd\u6570\uff0c\u8be5\u51fd\u6570\u8fd4\u56de\u4ee3\u7801\u6bb5\u5c06\u8981\u52a0\u8f7d\u8fdb\u5165\u7684\u5730\u5740dest\u3002\u7531\u4e8e\u6211\u4eec\u5728lab1\u5168\u9762\u91c7\u7528\u4e86\u76f4\u5730\u5740\u6620\u5c04\u6a21\u5f0f\uff08Bare mode\uff0c\u4e5f\u5c31\u662f\u8bf4\uff1a\u903b\u8f91\u5730\u5740=\u7269\u7406\u5730\u5740\uff09\uff0c\u5bf9\u4e8elab1\u5168\u7cfb\u5217\u7684\u5b9e\u9a8c\u6765\u8bf4\uff0celf_alloc_mb()\u8fd4\u56de\u7684\u88c5\u8f7d\u5730\u5740\u5b9e\u9645\u4e0a\u5c31\u662f\u7269\u7406\u5730\u5740\u3002</p> <pre><code> 19 static void *elf_alloc_mb(elf_ctx *ctx, uint64 elf_pa, uint64 elf_va, uint64 size) {\n20   // directly returns the virtual address as we are in the Bare mode in lab1\n21   return (void *)elf_va;\n22 }\n</code></pre> <p>\u4f46\u662f\uff0c\u5230\u4e86\u5b9e\u9a8c\u4e8c\uff08lab2\u7cfb\u5217\uff09\uff0c\u6211\u4eec\u5c06\u5f00\u542fRISC-V\u7684\u5206\u9875\u6a21\u5f0f\uff08sv39\uff09\uff0c\u5c4a\u65f6elf_alloc_mb\u51fd\u6570\u5c06\u53d1\u751f\u53d8\u5316\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter3_traps/#316-spikehtif","title":"3.1.6 spike\u7684HTIF\u63a5\u53e3","text":"<p>spike\u63d0\u4f9b\u7684HTIF\uff08Host-Target InterFace\uff09\u63a5\u53e3\u7684\u539f\u7406\u53ef\u4ee5\u7528\u4e0b\u56fe\u8bf4\u660e\uff1a</p> <p></p> <p>\u56fe2.1 HTIF\u7684\u539f\u7406</p> <p>\u6211\u4eec\u77e5\u9053spike\u662f\u8fd0\u884c\u5728\u4e3b\u673a\uff08host\uff09\u4e0a\u7684\uff0c\u5728\u521b\u5efa\u76ee\u6807\uff08target\uff09\u673a\u5668\u7684\u65f6\u5019\uff0cspike\u6a21\u62df\u5668\u5c06\u81ea\u8eab\u7684\u4e00\u6bb5\u5185\u5b58\uff08\u56fe\u4e2d\u7684HTIF\u5185\u5b58\u6bb5\uff09\u63d0\u4f9b\u7ed9\u76ee\u6807\u673a\u3002PKE\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u5728\u6784\u9020\u65f6\u5f15\u5165\u4e86\u8fd9\u6bb5\u5185\u5b58\uff08\u53c2\u8003kernel/kernel.lds\u6587\u4ef6\uff09\uff0c\u5728\u542f\u52a8\u65f6\u901a\u8fc7\u76ee\u6807\u673a\u5668\u4f20\u7ed9PKE\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u7684\u8bbe\u5907\u53c2\u6570\uff08DTS\uff0cDevice Tree String\uff09\u4e2d\u53d1\u73b0\u8fd9\u6bb5\u5185\u5b58\uff1b\u63a5\u4e0b\u6765\u901a\u8fc7spike_interface\u76ee\u5f55\u4e2d\u7684\u4ee3\u7801\u5bf9\u8fd9\u6bb5\u5185\u5b58\u8fdb\u884c\u521d\u59cb\u5316\u548c\u5c01\u88c5\u52a8\u4f5c\uff0c\u5c06\u5176\u5305\u88c5\u6210\u4e00\u7ec4\u53ef\u4ee5\u7531\u64cd\u4f5c\u7cfb\u7edf\u8c03\u7528\u7684\u51fd\u6570\u8c03\u7528\uff0c\u5178\u578b\u7684\u5982sprint\u3001spike_file_open\u3001spike_file_close\u8fd9\u4e9b\uff1b\u6700\u540ePKE\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u5c31\u80fd\u591f\u76f4\u63a5\u4f7f\u7528\u8fd9\u4e9b\u5c01\u88c5\u540e\u7684\u51fd\u6570\u8c03\u7528\u5b8c\u6210\u5bf9\u6a21\u62df\u786c\u4ef6\u7684\u64cd\u7eb5\uff0c\u5982\u6253\u5370\u5b57\u7b26\u4e32\u5230\u5c4f\u5e55\u3001\u8bbf\u95ee\u4e3b\u673a\u4e0a\u7684\u6587\u4ef6\u6216\u8bbe\u5907\u8fd9\u4e9b\u52a8\u4f5c\u3002</p> <p>spike\u57fa\u4e8eHTIF\u5185\u5b58\u7684\u4f20\u9012\uff0c\u5b9a\u4e49\u4e86\u4e00\u7ec4HTIF\u8c03\u7528\uff08\u7c7b\u4f3c\u4e8e\u64cd\u4f5c\u7cfb\u7edf\u7684\u7cfb\u7edf\u8c03\u7528\u7684\u6982\u5ff5\uff09\uff0c\u6bcf\u4e2aHTIF\u8c03\u7528\u5b9e\u73b0\u4e00\u4e2a\u65e2\u5b9a\u7684\u529f\u80fd\u3002\u5728\u4f7f\u7528\u65f6\uff0cPKE\u5185\u6838\u53ef\u4ee5\u901a\u8fc7\u8bbe\u5b9a\u5f80HTIF\u5185\u5b58\u4e2d\u5199\u5165\u7279\u5b9a\u7684HTIF\u8c03\u7528\u53f7\uff0cspike\u5728\u4eceHTIF\u5185\u5b58\u4e2d\u83b7\u5f97\u8c03\u7528\u53f7\u540e\u5c31\u4f1a\u6267\u884c\u8c03\u7528\u53f7\u5bf9\u5e94\u7684\u52a8\u4f5c\uff0c\u5e76\u4f20\u9012\u8fd4\u56de\u503c\u5230HTIF\u5185\u5b58\u4e2d\u3002\u6700\u540e\uff0cPKE\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u901a\u8fc7\u8bfb\u53d6HTIF\u4e2d\u7684\u4fe1\u606f\u83b7\u5f97\u8fd4\u56de\u503c\u7684\u5185\u5bb9\u3002</p> <p>\u5bf9\u4e8ePKE\u5b9e\u9a8c\u800c\u8a00\uff0c\u5229\u7528HTIF\u63a5\u53e3\u53ef\u4ee5\u5c4f\u853d\u4e00\u4e9b\u64cd\u4f5c\u7cfb\u7edf\u5e95\u5c42\u529f\u80fd\uff08\u5982\u8bbe\u5907\u64cd\u7eb5\uff09\u7684\u5b9e\u73b0\uff0c\u8fd9\u4e9b\u529f\u80fd\u5f80\u5f80\u662f\u8ddf\u5177\u4f53\u7684\u786c\u4ef6\u5b9e\u73b0\u6709\u5173\uff08\u4e0d\u540c\u5e73\u53f0\u8fd8\u4e0d\u4e00\u6837\uff09\uff0c\u5f80\u5f80\u7528\u6c47\u7f16\u8bed\u8a00\u4e66\u5199\uff0c\u9605\u8bfb\u8d77\u6765\u975e\u5e38\u67af\u71e5\u4e5f\u5f88\u96be\u8bfb\u61c2\u3002\u66f4\u91cd\u8981\u7684\uff0c\u8fd9\u4e9b\u5b9e\u73b0\u7ec6\u8282\u8ddf\u64cd\u4f5c\u7cfb\u7edf\u53ef\u80fd\u5e76\u65e0\u5173\u7cfb\uff01\u91c7\u7528HTIF\u8fd9\u79cd\u5f62\u5f0f\uff0c\u7528\u9ad8\u7ea7\u8bed\u8a00\uff08C\u8bed\u8a00\uff09\u6765\u4e66\u5199\u8fd9\u6bb5\u4ee3\u7801\uff08spike_interface\u76ee\u5f55\u4e0b\u7684\u6587\u4ef6\uff09\u4f1a\u7b80\u5355\u6613\u61c2\uff0c\u6ee1\u8db3\u64cd\u4f5c\u7cfb\u7edf\u539f\u7406\u8bfe\u7a0b\u7684\u6559\u5b66\u8981\u6c42\u3002</p> <p>\u53e6\u5916\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0cHTIF\u673a\u5236\u5e76\u4e0d\u662f\u7eaf\u7cb9\u4e3a\u6ee1\u8db3\u6559\u5b66\u8981\u6c42\u800c\u5199\u7684\u201c\u73a9\u5177\u201d\u3002\u6211\u4eec\u5728ZedBoard\u8fd9\u79cd\u5f00\u53d1\u677f\u7684PL\uff08Programmable Logic\uff09\u90e8\u5206\u90e8\u7f72\u6211\u4eec\u5f00\u53d1\u7684RISC-V\u5904\u7406\u5668\u65f6\uff0c\u4e3a\u4e86\u68c0\u9a8c\u6240\u5f00\u53d1\u7684\u5904\u7406\u5668\u5bf9\u64cd\u4f5c\u7cfb\u7edf\u7684\u652f\u6301\u80fd\u529b\uff0c\u5f80\u5f80\u4f1a\u5728RISC-V\u5904\u7406\u5668\u4e0a\u542f\u52a8\u4ee3\u7406\u5185\u6838\uff08\u53ef\u4ee5\u76f4\u63a5\u7528\u6211\u4eec\u5728\u5b9e\u9a8c\u4e2d\u5f00\u53d1\u7684PKE\u4ee3\u7406\u5185\u6838\uff09\uff0c\u800c\u540e\u8005\u5c31\u662f\u901a\u8fc7HTIF\u7684\u673a\u5236\u5b8c\u6210\u4e0e\u4e3b\u673a\uff08\u5373\u5728PS\u4e0a\u8fd0\u884c\u7684ARM Linux\uff09\u7684\u4ea4\u4e92\u7684\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter3_traps/#32-lab1_1","title":"3.2 lab1_1 \u7cfb\u7edf\u8c03\u7528","text":""},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter3_traps/#_2","title":"\u7ed9\u5b9a\u5e94\u7528","text":"<ul> <li>user/app_helloworld.c</li> </ul> <pre><code>  1 /*\n  2  * Below is the given application for lab1_1.\n  3  *\n  4  * You can build this app (as well as our PKE OS kernel) by command:\n  5  * $ make\n  6  *\n  7  * Or run this app (with the support from PKE OS kernel) by command:\n  8  * $ make run\n  9  */\n10\n11 #include \"user_lib.h\"\n12\n13 int main(void) {\n14   printu(\"Hello world!\\n\");\n15\n16   exit(0);\n17 }\n</code></pre> <p>\u5e94\u7528\u5b9e\u73b0\u7684\u529f\u80fd\u975e\u5e38\u7b80\u5355\uff0c\u5373\u5728\u5c4f\u5e55\u4e0a\u6253\u5370\"Hello world!\\n\"\u3002</p> <ul> <li>make\u540e\u7684\u76f4\u63a5\u8fd0\u884c\u7ed3\u679c\uff1a</li> </ul> <pre><code>$ spike ./obj/riscv-pke ./obj/app_helloworld\nIn m_start, hartid:0\nHTIF is available!\n(Emulated) memory size: 2048 MB\nEnter supervisor mode...\nApplication: ./obj/app_helloworld\nelf_load: ctx-&gt;ehdr.phoff = 64, ctx-&gt;ehdr.phnum =1, sizeof(ph_addr)=56.\nelf_load: ph_addr.memsz = 744, ph_addr.off =4096.\nApplication program entry point (virtual address): 0x0000000081000000\nSwitching to user mode...\ncall do_syscall to accomplish the syscall and lab1_1 here.\n\nSystem is shutting down with exit code -1.\n</code></pre> <p>\u4ece\u7ed3\u679c\u4e0a\u6765\u770b\uff0c\u5e76\u672a\u8fbe\u5230\u6211\u4eec\u7684\u9884\u671f\u7ed3\u679c\uff0c\u5373\u5728\u5c4f\u5e55\u4e0a\u8f93\u51fa\"Hello world!\\n\"\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter3_traps/#_3","title":"\u5b9e\u9a8c\u5185\u5bb9","text":"<p>\u5982\u8f93\u51fa\u63d0\u793a\u6240\u8868\u793a\u7684\u90a3\u6837\uff0c\u9700\u8981\u627e\u5230\u5e76\u5b8c\u6210\u5bf9do_syscall\u7684\u8c03\u7528\uff0c\u5e76\u83b7\u5f97\u4ee5\u4e0b\u9884\u671f\u7ed3\u679c\uff1a</p> <pre><code>$ spike ./obj/riscv-pke ./obj/app_helloworld\nIn m_start, hartid:0\nHTIF is available!\n(Emulated) memory size: 2048 MB\nEnter supervisor mode...\nApplication: ./obj/app_helloworld\nApplication program entry point (virtual address): 0x0000000081000000\nSwitching to user mode...\nHello world!\nUser exit with code:0.\nSystem is shutting down with exit code 0.\n</code></pre> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter3_traps/#_4","title":"\u5b9e\u9a8c\u6307\u5bfc","text":"<p>lab1_1\u5b9e\u9a8c\u9700\u8981\u8bfb\u8005\u4e86\u89e3\u548c\u638c\u63e1\u64cd\u4f5c\u7cfb\u7edf\u4e2d\u7cfb\u7edf\u8c03\u7528\u673a\u5236\u7684\u5b9e\u73b0\u539f\u7406\u3002\u4ece\u5e94\u7528\u51fa\u53d1\uff0c\u6211\u4eec\u53d1\u73b0user/app_helloworld.c\u6587\u4ef6\u4e2d\u6709\u4e24\u4e2a\u51fd\u6570\u8c03\u7528\uff1aprintu\u548cexit\u3002\u5bf9\u4ee3\u7801\u8fdb\u884c\u8ddf\u8e2a\uff0c\u6211\u4eec\u53d1\u73b0\u8fd9\u4e24\u4e2a\u51fd\u6570\u90fd\u5728user/user_lib.c\u4e2d\u8fdb\u884c\u4e86\u5b9e\u73b0\uff0c\u540c\u65f6\uff0c\u8fd9\u4e24\u4e2a\u51fd\u6570\u6700\u540e\u90fd\u8f6c\u6362\u6210\u4e86\u5bf9do_user_call\u7684\u8c03\u7528\u3002\u67e5\u770bdo_user_call\u51fd\u6570\u7684\u5b9e\u73b0\uff1a</p> <pre><code> 13 int do_user_call(uint64 sysnum, uint64 a1, uint64 a2, uint64 a3, uint64 a4, uint64 a5, uint64 a6,\n14                  uint64 a7) {\n15   int ret;\n16\n17   // before invoking the syscall, arguments of do_user_call are already loaded into the argument\n18   // registers (a0-a7) of our (emulated) risc-v machine.\n19   asm volatile(\n20       \"ecall\\n\"\n21       \"sw a0, %0\"  // returns a 32-bit value\n22       : \"=m\"(ret)\n23       :\n24       : \"memory\");\n25\n26   return ret;\n27 }\n</code></pre> <p>\u6211\u4eec\u53d1\u73b0\uff0cdo_user_call\u51fd\u6570\u662f\u901a\u8fc7ecall\u6307\u4ee4\u5b8c\u6210\u7cfb\u7edf\u8c03\u7528\u7684\uff0c\u4e14\u5728\u6267\u884cecall\u6307\u4ee4\u524d\uff0c\u6240\u6709\u7684\u53c2\u6570\uff08\u5373do_user_call\u51fd\u6570\u76848\u4e2a\u53c2\u6570\uff09\u5b9e\u9645\u4e0a\u90fd\u5df2\u7ecf\u8f7d\u5165\u5230RISC-V\u673a\u5668\u7684a0\u5230a7\uff0c\u8fd98\u4e2a\u5bc4\u5b58\u5668\u4e2d\uff08\u8fd9\u4e00\u6b65\u662f\u6211\u4eec\u7684\u7f16\u8bd1\u5668\u751f\u6210\u7684\u4ee3\u7801\u5e2e\u6211\u4eec\u5b8c\u6210\u7684\uff09\u3002ecall\u6307\u4ee4\u7684\u6267\u884c\u5c06\u6839\u636ea0\u5bc4\u5b58\u5668\u4e2d\u7684\u503c\u83b7\u5f97\u7cfb\u7edf\u8c03\u7528\u53f7\uff0c\u5e76\u4f7fRISC-V\u8f6c\u5230S\u6a21\u5f0f\uff08\u56e0\u4e3a\u6211\u4eec\u7684\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u542f\u52a8\u65f6\u5c06\u6240\u6709\u7684\u4e2d\u65ad\u3001\u5f02\u5e38\u3001\u7cfb\u7edf\u8c03\u7528\u90fd\u4ee3\u7406\u7ed9\u4e86S\u6a21\u5f0f\uff09\u7684trap\u5904\u7406\u5165\u53e3\u6267\u884c\uff08\u5728kernel/strap_vector.S\u6587\u4ef6\u4e2d\u5b9a\u4e49\uff09\uff1a</p> <pre><code> 16 .globl smode_trap_vector\n 17 .align 4\n 18 smode_trap_vector:\n 19     # swap a0 and sscratch, so that points a0 to the trapframe of current process\n 20     csrrw a0, sscratch, a0\n 21\n 22     # save the context (user registers) of current process in its trapframe.\n 23     addi t6, a0 , 0\n 24\n 25     # store_all_registers is a macro defined in util/load_store.S, it stores contents\n 26     # of all general purpose registers into a piece of memory started from [t6].\n 27     store_all_registers\n 28\n 29     # come back to save a0 register before entering trap handling in trapframe\n 30     # [t0]=[sscratch]\n 31     csrr t0, sscratch\n 32     sd t0, 72(a0)\n 33\n 34     # use the \"user kernel\" stack (whose pointer stored in p-&gt;trapframe-&gt;kernel_sp)\n 35     ld sp, 248(a0)\n 36\n 37     # load the address of smode_trap_handler() from p-&gt;trapframe-&gt;kernel_trap\n 38     ld t0, 256(a0)\n 39\n 40     # jump to smode_trap_handler() that is defined in kernel/trap.c\n 41     jr t0\n</code></pre> <p>\u4ece\u4ee5\u4e0a\u4ee3\u7801\u6211\u4eec\u53ef\u4ee5\u770b\u5230\uff0ctrap\u7684\u5165\u53e3\u5904\u7406\u51fd\u6570\u9996\u5148\u5c06\u201c\u8fdb\u7a0b\u201d\uff08\u5373\u6211\u4eec\u7684obj/app_helloworld\u7684\u8fd0\u884c\u73b0\u573a\uff09\u8fdb\u884c\u4fdd\u5b58\uff08\u7b2c27\u884c\uff09\uff1b\u63a5\u4e0b\u6765\u5c06a0\u5bc4\u5b58\u5668\u4e2d\u7684\u7cfb\u7edf\u8c03\u7528\u53f7\u4fdd\u5b58\u5230\u5185\u6838\u5806\u6808\uff08\u7b2c31--32\u884c\uff09\uff0c\u518d\u5c06p-&gt;trapframe-&gt;kernel_sp\u6307\u5411\u7684\u4e3a\u5e94\u7528\u8fdb\u7a0b\u5206\u914d\u7684\u5185\u6838\u6808\u8bbe\u7f6e\u5230sp\u5bc4\u5b58\u5668\uff08\u7b2c35\u884c\uff09\uff0c\u8be5\u8fc7\u7a0b\u5b9e\u9645\u4e0a\u5b8c\u6210\u4e86\u6808\u7684\u5207\u6362\u3002\u5b8c\u6574\u7684\u5207\u6362\u8fc7\u7a0b\u4e3a\uff1a</p> <ul> <li>1\uff09\u5e94\u7528\u7a0b\u5e8f\u5728U\u6a21\u5f0f\u5373\u5e94\u7528\u6001\u6267\u884c\uff0c\u8fd9\u4e2a\u65f6\u5019\u662f\u4f7f\u7528\u7684\u64cd\u4f5c\u7cfb\u7edf\u4e3a\u5176\u5206\u914d\u7684\u6808\uff08\u79f0\u4e3a\u7528\u6237\u6808\uff09\uff0c\u8fd9\u4e00\u90e8\u5206\u53c2\u89c1<code>kernel/kernel.c</code>\u6587\u4ef6\u4e2d<code>load_user_program</code>\u7684\u5b9e\u73b0\uff1b</li> <li>2\uff09\u5e94\u7528\u7a0b\u5e8f\u8c03\u7528ecall\uff0c\u540e\u9677\u5165\u5185\u6838\uff0c\u5f00\u59cb\u6267\u884c<code>smode_trap_vector</code>\u51fd\u6570\uff0c\u6b64\u65f6\u4f7f\u7528\u7684\u662f\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u7684\u6808\u3002\u53c2\u89c1<code>kernel/machine/mentry.S</code>\u6587\u4ef6\u4e2d\u7684PKE\u5165\u53e3<code>_mentry</code>\uff1b</li> <li>3\uff09\u4e2d\u65ad\u5904\u7406\u4f8b\u7a0b<code>smode_trap_vector</code>\u51fd\u6570\u6267\u884c\u5230\u7b2c35\u884c\u65f6\uff0c\u5c06\u6808\u5207\u6362\u5230\u7528\u6237\u8fdb\u7a0b\u201c\u81ea\u5e26\u201d\u7684\u201c\u7528\u6237\u5185\u6838\u6808\u201c\uff0c\u4e5f\u5c31\u662f<code>kernel/process.c</code>\u6587\u4ef6\u4e2d<code>switch_to</code>\u51fd\u6570\u7684\u7b2c39\u884c\u6240\u5f15\u7528\u7684<code>proc-&gt;kstack</code>\uff0c\u800c\u4e0d\u4f7f\u7528PKE\u5185\u6838\u81ea\u5df1\u7684\u6808\uff0c\u8fd9\u91cc\u8bf7\u8bfb\u8005\u601d\u8003\u4e3a\u4f55\u8981\u8fd9\u6837\u5b89\u6392\uff1f</li> </ul> <p>\u540e\u7eed\u7684\u6267\u884c\u5c06\u4f7f\u7528\u5e94\u7528\u8fdb\u7a0b\u6240\u9644\u5e26\u7684\u5185\u6838\u6808\u6765\u4fdd\u5b58\u6267\u884c\u7684\u4e0a\u4e0b\u6587\uff0c\u5982\u51fd\u6570\u8c03\u7528\u3001\u4e34\u65f6\u53d8\u91cf\u8fd9\u4e9b\uff1b\u6700\u540e\uff0c\u5c06\u5e94\u7528\u8fdb\u7a0b\u4e2d\u7684p-&gt;trapframe-&gt;kernel_trap\u5199\u5165t0\u5bc4\u5b58\u5668\uff08\u7b2c38\u884c\uff09\uff0c\u5e76\u6700\u540e\uff08\u7b2c41\u884c\uff09\u8c03\u7528p-&gt;trapframe-&gt;kernel_trap\u6240\u6307\u5411\u7684smode_trap_handler()\u51fd\u6570\u3002</p> <p>smode_trap_handler()\u51fd\u6570\u7684\u5b9a\u4e49\u5728kernel/strap.c\u6587\u4ef6\u4e2d\uff0c\u91c7\u7528C\u8bed\u8a00\u7f16\u5199\uff1a</p> <pre><code> 33 void smode_trap_handler(void) {\n34   // make sure we are in User mode before entering the trap handling.\n35   // we will consider other previous case in lab1_3 (interrupt).\n36   if ((read_csr(sstatus) &amp; SSTATUS_SPP) != 0) panic(\"usertrap: not from user mode\");\n37\n38   assert(current);\n39   // save user process counter.\n40   current-&gt;trapframe-&gt;epc = read_csr(sepc);\n41\n42   // if the cause of trap is syscall from user application.\n43   // read_csr() and CAUSE_USER_ECALL are macros defined in kernel/riscv.h\n44   if (read_csr(scause) == CAUSE_USER_ECALL) {\n45     handle_syscall(current-&gt;trapframe);\n46   } else {\n47     sprint(\"smode_trap_handler(): unexpected scause %p\\n\", read_csr(scause));\n48     sprint(\"            sepc=%p stval=%p\\n\", read_csr(sepc), read_csr(stval));\n49     panic( \"unexpected exception happened.\\n\" );\n50   }\n51\n52   // continue (come back to) the execution of current process.\n53   switch_to(current);\n54 }\n</code></pre> <p>\u8be5\u51fd\u6570\u9996\u5148\u5728\u7b2c36\u884c\uff0c\u5bf9\u8fdb\u5165\u5f53\u524d\u7279\u6743\u7ea7\u6a21\u5f0f\uff08S\u6a21\u5f0f\uff09\u4e4b\u524d\u7684\u6a21\u5f0f\u8fdb\u884c\u5224\u65ad\uff0c\u786e\u4fdd\u8fdb\u5165\u524d\u662f\u7528\u6237\u6a21\u5f0f\uff08U\u6a21\u5f0f\uff09\uff1b\u63a5\u4e0b\u6765\u5728\u7b2c40\u884c\uff0c\u4fdd\u5b58\u53d1\u751f\u7cfb\u7edf\u8c03\u7528\u7684\u6307\u4ee4\u5730\u5740\uff1b\u8fdb\u4e00\u6b65\u5224\u65ad\uff08\u7b2c44--50\u884c\u7684if...else...\u8bed\u53e5\uff09\u5bfc\u81f4\u8fdb\u5165\u5f53\u524d\u6a21\u5f0f\u7684\u539f\u56e0\uff0c\u5982\u679c\u662f\u7cfb\u7edf\u8c03\u7528\u7684\u8bdd\uff08read_csr(scause) == CAUSE_USER_ECALL\uff09\u5c31\u6267\u884chandle_syscall()\u51fd\u6570\uff0c\u4f46\u5982\u679c\u662f\u5176\u4ed6\u539f\u56e0\uff08\u5bf9\u4e8e\u5176\u4ed6\u539f\u56e0\u7684\u5904\u7406\uff0c\u6211\u4eec\u5c06\u5728\u540e\u7eed\u5b9e\u9a8c\u4e2d\u8fdb\u4e00\u6b65\u5b8c\u5584\uff09\u7684\u8bdd\uff0c\u5c31\u6253\u5370\u51fa\u9519\u4fe1\u606f\u5e76\u63a8\u51fa\uff1b\u6700\u540e\uff0c\u5728\u7b2c53\u884c\u8c03\u7528switch_to()\u51fd\u6570\u8fd4\u56de\u5f53\u524d\u8fdb\u7a0b\u3002</p> <p>handle_syscall()\u51fd\u6570\u7684\u5b9a\u4e49\u4e5f\u5728kernel/strap.c\u6587\u4ef6\u4e2d\uff1a</p> <pre><code> 15 static void handle_syscall(trapframe *tf) {\n16   // tf-&gt;epc points to the address that our computer will jump to after the trap handling.\n17   // for a syscall, we should return to the NEXT instruction after its handling.\n18   // in RV64G, each instruction occupies exactly 32 bits (i.e., 4 Bytes)\n19   tf-&gt;epc += 4;\n20\n21   // TODO (lab1_1): remove the panic call below, and call do_syscall (defined in\n22   // kernel/syscall.c) to conduct real operations of the kernel side for a syscall.\n23   // IMPORTANT: return value should be returned to user app, or else, you will encounter\n24   // problems in later experiments!\n25   panic( \"call do_syscall to accomplish the syscall and lab1_1 here.\\n\" );\n26\n27 }\n</code></pre> <p>\u770b\u5230\u7b2c25\u884c\uff0c\u6211\u4eec\u5c31\u5e94\u8be5\u660e\u767d\u4e3a\u4ec0\u4e48\u5728make\u540e\u7684\u76f4\u63a5\u8fd0\u884c\u7ed3\u679c\u4e2d\u51fa\u73b0<code>call do_syscall to accomplish the syscall and lab1_1 here.</code>\u8fd9\u884c\u7684\u8f93\u51fa\u4e86\uff0c\u90a3\u662fpanic\u7684\u8f93\u51fa\u7ed3\u679c\u3002\u6240\u4ee5\u4e3a\u4e86\u5b8c\u6210lab1_1\uff0c\u5c31\u5e94\u8be5\u628apanic\u8bed\u53e5\u5220\u6389\uff0c\u6362\u6210\u5bf9do_syscall()\u51fd\u6570\u7684\u8c03\u7528\uff01\u5176\u5b9e\u5b8c\u6210\u8fd9\u4e2a\u5b9e\u9a8c\u975e\u5e38\u7b80\u5355\uff0c\u4f46\u9700\u8981\u8bfb\u8005\u5b8c\u6210\u4ee5\u4e0a\u6240\u8ff0\u7684\u4ee3\u7801\u8ddf\u8e2a\uff0c\u4e86\u89e3PKE\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u5904\u7406\u7cfb\u7edf\u8c03\u7528\u7684\u6d41\u7a0b\u3002</p> <p>\u90a3\u4e48do_syscall()\u51fd\u6570\u662f\u5728\u54ea\u91cc\u5b9a\u4e49\u7684\u5462\uff1f\u5b9e\u9645\u4e0a\u8fd9\u4e2a\u51fd\u6570\u5728kernel/syscall.c\u6587\u4ef6\u4e2d\uff0c\u5df2\u7ecf\u5e2e\u5927\u5bb6\u5199\u597d\u4e86\uff1a</p> <pre><code> 38 long do_syscall(long a0, long a1, long a2, long a3, long a4, long a5, long a6, long a7) {\n39   switch (a0) {\n40     case SYS_user_print:\n41       return sys_user_print((const char*)a1, a2);\n42     case SYS_user_exit:\n43       return sys_user_exit(a1);\n44     default:\n45       panic(\"Unknown syscall %ld \\n\", a0);\n46   }\n47 }\n</code></pre> <p>\u4f46\u662f\uff0c\u505a\u5b9e\u9a8c\u7684\u65f6\u5019\uff0c\u9700\u8981\u8bfb\u8005\u601d\u8003\u5728handle_syscall()\u51fd\u6570\u4e2d\u8c03\u7528do_syscall()\u51fd\u6570\uff0c\u540e\u8005\u7684\u53c2\u6570\u600e\u4e48\u529e\uff1f\u6bd5\u7adf\u67098\u4e2along\u7c7b\u578b\uff08\u56e0\u4e3a\u6211\u4eec\u7684\u673a\u5668\u662fRV64G\uff0clong\u7c7b\u578b\u5360\u636e8\u4e2a\u5b57\u8282\uff09\u7684\u53c2\u6570\uff0c\u53e6\u5916\uff0cdo_syscall()\u51fd\u6570\u7684\u8fd4\u56de\u503c\u600e\u4e48\u5904\u7406\uff1f\u6bd5\u7adfdo_syscall()\u51fd\u6570\u6709\u4e00\u4e2along\u7c7b\u578b\u7684\u8fd4\u56de\u503c\uff0c\u800c\u8fd9\u4e2a\u8fd4\u56de\u503c\u662f\u8981\u901a\u77e5\u5e94\u7528\u7a0b\u5e8f\u5b83\u53d1\u51fa\u7684\u7cfb\u7edf\u8c03\u7528\u662f\u5426\u6210\u529f\u7684\u3002</p> <p>\u9664\u4e86\u5b9e\u9a8c\u5185\u5bb9\u4e4b\u5916\uff0c\u5728handle_syscall()\u51fd\u6570\u7684\u7b2c19\u884c\uff0c\u6709\u4e00\u4e2a<code>tf-&gt;epc += 4;</code>\u8bed\u53e5\uff0c\u8fd9\u91cc\u8bf7\u8bfb\u8005\u601d\u8003\u4e3a\u4ec0\u4e48\u8981\u5c06tf-&gt;epc\u7684\u503c\u8fdb\u884c\u52a04\u5904\u7406\uff1f\u8fd9\u4e2a\u95ee\u9898\u8bf7\u7ed3\u5408\u4f60\u5bf9RISC-V\u6307\u4ee4\u96c6\u67b6\u6784\u7684\u7406\u89e3\uff0c\u4ee5\u53ca\u7cfb\u7edf\u8c03\u7528\u7684\u539f\u7406\u56de\u7b54\u3002\u53e6\u5916\uff0c\u6211\u4eec\u7684PKE\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u662f\u5982\u4f55\u5f97\u5230\u5e94\u7528\u7a0b\u5e8f\u4e2d\u201chello world!\u201d\u5b57\u7b26\u4e32\u7684\u5730\u5740\u7684\u5462\uff1f</p> <p>\u5b8c\u6210\u4ee5\u4e0a\u5b9e\u9a8c\u540e\uff0c\u5c31\u80fd\u591f\u83b7\u5f97\u4ee5\u4e0b\u7ed3\u679c\u8f93\u51fa\u4e86\uff1a</p> <pre><code>$ spike ./obj/riscv-pke ./obj/app_helloworld\nIn m_start, hartid:0\nHTIF is available!\n(Emulated) memory size: 2048 MB\nEnter supervisor mode...\nApplication: ./obj/app_helloworld\nApplication program entry point (virtual address): 0x0000000081000000\nSwitching to user mode...\nHello world!\nUser exit with code:0.\nSystem is shutting down with exit code 0.\n</code></pre> <p>\u5b9e\u9a8c\u5b8c\u6bd5\u540e\uff0c\u8bb0\u5f97\u63d0\u4ea4\u4fee\u6539\uff08\u547d\u4ee4\u884c\u4e2d-m\u540e\u7684\u5b57\u7b26\u4e32\u53ef\u81ea\u884c\u786e\u5b9a\uff09\uff0c\u4ee5\u4fbf\u5728\u540e\u7eed\u5b9e\u9a8c\u4e2d\u7ee7\u627flab1_1\u4e2d\u6240\u505a\u7684\u5de5\u4f5c\uff1a</p> <pre><code>$ git commit -a -m \"my work on lab1_1 is done.\"\n</code></pre> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter3_traps/#33-lab1_2","title":"3.3 lab1_2 \u5f02\u5e38\u5904\u7406","text":""},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter3_traps/#_5","title":"\u7ed9\u5b9a\u5e94\u7528","text":"<ul> <li>user/app_illegal_instruction.c</li> </ul> <pre><code>  1 /*\n  2  * Below is the given application for lab1_2.\n  3  * This app attempts to issue M-mode instruction in U-mode, and consequently raises an exception.\n  4  */\n5\n6 #include \"user_lib.h\"\n7 #include \"util/types.h\"\n8\n9 int main(void) {\n10   printu(\"Going to hack the system by running privilege instructions.\\n\");\n11   // we are now in U(user)-mode, but the \"csrw\" instruction requires M-mode privilege.\n12   // Attempting to execute such instruction will raise illegal instruction exception.\n13   asm volatile(\"csrw sscratch, 0\");\n14   exit(0);\n15 }\n</code></pre> <p>\uff08\u5728\u7528\u6237U\u6a21\u5f0f\u4e0b\u6267\u884c\u7684\uff09\u5e94\u7528\u4f01\u56fe\u6267\u884cRISC-V\u7684\u7279\u6743\u6307\u4ee4csrw sscratch, 0\u3002\u8be5\u6307\u4ee4\u4f1a\u4fee\u6539S\u6a21\u5f0f\u7684\u6808\u6307\u9488\uff0c\u5982\u679c\u5141\u8bb8\u8be5\u6307\u4ee4\u7684\u6267\u884c\uff0c\u6267\u884c\u7684\u7ed3\u679c\u53ef\u80fd\u4f1a\u5bfc\u81f4\u7cfb\u7edf\u5d29\u6e83\u3002</p> <ul> <li>\uff08\u5148\u63d0\u4ea4lab1_1\u7684\u7b54\u6848\uff0c\u7136\u540e\uff09\u5207\u6362\u5230lab1_2\u3001\u7ee7\u627flab1_1\u4e2d\u6240\u505a\u4fee\u6539\uff0c\u5e76make\u540e\u7684\u76f4\u63a5\u8fd0\u884c\u7ed3\u679c\uff1a</li> </ul> <pre><code>//\u5207\u6362\u5230lab1_2\n$ git checkout lab1_2_exception\n\n//\u7ee7\u627flab1_1\u7684\u7b54\u6848\n$ git merge lab1_1_syscall -m \"continue to work on lab1_2\"\n//\u91cd\u65b0\u6784\u9020\n$ make clean; make\n\n//\u8fd0\u884c\u6784\u9020\u7ed3\u679c\n$ spike ./obj/riscv-pke ./obj/app_illegal_instruction\nIn m_start, hartid:0\nHTIF is available!\n(Emulated) memory size: 2048 MB\nEnter supervisor mode...\nApplication: ./obj/app_illegal_instruction\nelf_load: ctx-&gt;ehdr.phoff = 64, ctx-&gt;ehdr.phnum =1, sizeof(ph_addr)=56.\nelf_load: ph_addr.memsz = 800, ph_addr.off =4096.\nApplication program entry point (virtual address): 0x0000000081000000\nSwitching to user mode...\nGoing to hack the system by running privilege instructions.\ncall handle_illegal_instruction to accomplish illegal instruction interception of lab1_2.\n\nSystem is shutting down with exit code -1.\n</code></pre> <p>\u4ee5\u4e0a\u8f93\u51fa\u4e2d\uff0c\u7531\u4e8e\u7bc7\u5e45\u7684\u5173\u7cfb\uff0c\u6211\u4eec\u9690\u85cf\u4e86\u524d\u4e09\u4e2a\u547d\u4ee4\u7684\u8f93\u51fa\u7ed3\u679c\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter3_traps/#_6","title":"\u5b9e\u9a8c\u5185\u5bb9","text":"<p>\u5982\u8f93\u51fa\u6240\u63d0\u793a\u7684\u90a3\u6837\uff0c\u901a\u8fc7\u8c03\u7528handle_illegal_instruction\u51fd\u6570\u5b8c\u6210\u5f02\u5e38\u6307\u4ee4\u5904\u7406\uff0c\u963b\u6b62app_illegal_instruction\u7684\u6267\u884c\u3002</p> <pre><code>$ spike ./obj/riscv-pke ./obj/app_illegal_instruction\nIn m_start, hartid:0\nHTIF is available!\n(Emulated) memory size: 2048 MB\nEnter supervisor mode...\nApplication: ./obj/app_illegal_instruction\nApplication program entry point (virtual address): 0x0000000081000000\nSwitching to user mode...\nGoing to hack the system by running privilege instructions.\nIllegal instruction!\nSystem is shutting down with exit code -1.\n</code></pre> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter3_traps/#_7","title":"\u5b9e\u9a8c\u6307\u5bfc","text":"<p>lab1_2\u5b9e\u9a8c\u9700\u8981\u8bfb\u8005\u4e86\u89e3\u548c\u638c\u63e1\u64cd\u4f5c\u7cfb\u7edf\u4e2d\u5f02\u5e38\uff08exception\uff09\u7684\u4ea7\u751f\u539f\u7406\u4ee5\u53ca\u5904\u7406\u7684\u539f\u5219\u3002\u4ece\u5e94\u7528\u51fa\u53d1\uff0c\u6211\u4eec\u53d1\u73b0user/app_illegal_instruction.c\u6587\u4ef6\u4e2d\uff0c\u6211\u4eec\u7684\u5e94\u7528\u7a0b\u5e8f\u201c\u4f01\u56fe\u201d\u6267\u884c\u4e0d\u80fd\u5728\u7528\u6237\u6a21\u5f0f\uff08U\u6a21\u5f0f\uff09\u8fd0\u884c\u7684\u7279\u6743\u7ea7\u6307\u4ee4\uff1a<code>csrw sscratch, 0</code></p> <p>\u663e\u7136\uff0c\u8fd9\u79cd\u4f01\u56fe\u7834\u574f\u4e86RISC-V\u673a\u5668\u4ee5\u53ca\u64cd\u4f5c\u7cfb\u7edf\u7684\u8bbe\u8ba1\u539f\u5219\uff0c\u5bf9\u4e8e\u673a\u5668\u800c\u8a00\u8be5\u4e8b\u4ef6\u5e76\u4e0d\u662f\u5b83\u671f\u671b\uff08\u5b83\u671f\u671b\u5728\u7528\u6237\u6a21\u5f0f\u4e0b\u6267\u884c\u7684\u90fd\u662f\u7528\u6237\u6a21\u5f0f\u7684\u6307\u4ee4\uff09\u53d1\u751f\u7684\u201c\u5f02\u5e38\u4e8b\u4ef6\u201d\uff0c\u9700\u8981\u4ecb\u5165\u548c\u7834\u574f\u8be5\u5e94\u7528\u7a0b\u5e8f\u7684\u6267\u884c\u3002\u67e5\u627eRISC-V\u4f53\u7cfb\u7ed3\u6784\u7684\u76f8\u5173\u6587\u6863\uff0c\u6211\u4eec\u77e5\u9053\uff0c\u8fd9\u7c7b\u5f02\u5e38\u5c5e\u4e8e\u975e\u6cd5\u6307\u4ee4\u5f02\u5e38\uff0c\u5373CAUSE_ILLEGAL_INSTRUCTION\uff0c\u5b83\u5bf9\u5e94\u7684\u5f02\u5e38\u7801\u662f02\uff08\u89c1kernel/riscv.h\u4e2d\u7684\u5b9a\u4e49\uff09\u3002\u90a3\u4e48\uff0c\u5f53RISC-V\u673a\u5668\u622a\u83b7\u4e86\u8fd9\u7c7b\u5f02\u5e38\u540e\uff0c\u8be5\u5c06\u5b83\u4ea4\u4ed8\u7ed9\u8c01\u6765\u5904\u7406\u5462\uff1f</p> <p>\u901a\u8fc73.1.5\u8282\u7684\u9605\u8bfb\uff0c\u6211\u4eec\u77e5\u9053PKE\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u5728\u542f\u52a8\u65f6\u4f1a\u5c06\u90e8\u5206\u5f02\u5e38\u548c\u4e2d\u65ad\u201c\u4ee3\u7406\u201d\u7ed9S\u6a21\u5f0f\u5904\u7406\uff0c\u4f46\u662f\u5b83\u662f\u5426\u5c06CAUSE_ILLEGAL_INSTRUCTION\u8fd9\u7c7b\u5f02\u5e38\u4e5f\u8fdb\u884c\u4e86\u4ee3\u7406\u5462\uff1f\u8fd9\u5c31\u8981\u7814\u7a76m_start()\u51fd\u6570\u5728\u6267\u884cdelegate_traps()\u51fd\u6570\u65f6\u8bbe\u7f6e\u7684\u4ee3\u7406\u89c4\u5219\u4e86\uff0c\u6211\u4eec\u5148\u67e5\u770bdelegate_traps()\u51fd\u6570\u7684\u4ee3\u7801\uff0c\u5728kernel/machine/minit.c\u6587\u4ef6\u4e2d\u627e\u5230\u5b83\u5bf9\u5e94\u7684\u4ee3\u7801\uff1a</p> <pre><code> 55 static void delegate_traps() {\n56   // supports_extension macro is defined in kernel/riscv.h\n57   if (!supports_extension('S')) {\n58     // confirm that our processor supports supervisor mode. abort if it does not.\n59     sprint(\"S mode is not supported.\\n\");\n60     return;\n61   }\n62\n63   // macros used in following two statements are defined in kernel/riscv.h\n64   uintptr_t interrupts = MIP_SSIP | MIP_STIP | MIP_SEIP;\n65   uintptr_t exceptions = (1U &lt;&lt; CAUSE_MISALIGNED_FETCH) | (1U &lt;&lt; CAUSE_FETCH_PAGE_FAULT) |\n66                          (1U &lt;&lt; CAUSE_BREAKPOINT) | (1U &lt;&lt; CAUSE_LOAD_PAGE_FAULT) |\n67                          (1U &lt;&lt; CAUSE_STORE_PAGE_FAULT) | (1U &lt;&lt; CAUSE_USER_ECALL);\n68\n69   // writes 64-bit values (interrupts and exceptions) to 'mideleg' and 'medeleg' (two\n70   // priviledged registers of RV64G machine) respectively.\n71   //\n72   // write_csr and read_csr are macros defined in kernel/riscv.h\n73   write_csr(mideleg, interrupts);\n74   write_csr(medeleg, exceptions);\n75   assert(read_csr(mideleg) == interrupts);\n76   assert(read_csr(medeleg) == exceptions);\n77 }\n</code></pre> <p>\u5728\u7b2c64--67\u884c\u7684\u4ee3\u7801\u4e2d\uff0cdelegate_traps()\u51fd\u6570\u786e\u5b9e\u5c06\u90e8\u5206\u5f02\u5e38\u4ee3\u7406\u7ed9\u4e86S\u6a21\u5f0f\u5904\u7406\uff0c\u4f46\u662f\u91cc\u9762\u5e76\u6ca1\u6709\u6211\u4eec\u5173\u5fc3\u7684CAUSE_ILLEGAL_INSTRUCTION\u5f02\u5e38\uff0c\u8fd9\u8bf4\u660e\u8be5\u5f02\u5e38\u7684\u5904\u7406\u8fd8\u662f\u4ea4\u7ed9M\u6a21\u5f0f\u6765\u5904\u7406\uff08\u5b9e\u9645\u4e0a\uff0c\u5bf9\u4e8espike\u6a21\u62df\u7684RISC-V\u5e73\u53f0\u800c\u8a00\uff0cCAUSE_ILLEGAL_INSTRUCTION\u5f02\u5e38\u5fc5\u987b\u5728M\u6001\u5904\u7406\uff09\uff01\u6240\u4ee5\uff0c\u6211\u4eec\u9700\u8981\u4e86\u89e3M\u6a21\u5f0f\u7684trap\u5904\u7406\u5165\u53e3\uff0c\u4ee5\u4fbf\u7ee7\u7eed\u8ddf\u8e2a\u5176\u540e\u7684\u5904\u7406\u8fc7\u7a0b\u3002M\u6a21\u5f0f\u7684trap\u5904\u7406\u5165\u53e3\u5728kernel/machine/mtrap_vector.S\u6587\u4ef6\u4e2d\uff08PKE\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u5728\u542f\u52a8\u65f6\uff08kernel/machine/minit.c\u6587\u4ef6\u7684\u7b2c104\u884c<code>write_csr(mtvec, (uint64)mtrapvec);</code>\uff09\u5df2\u7ecf\u5c06M\u6a21\u5f0f\u7684\u4e2d\u65ad\u5904\u7406\u5165\u53e3\u6307\u5411\u4e86\u8be5\u51fd\u6570\uff09\uff1a</p> <pre><code>  8 mtrapvec:\n  9     # mscratch -&gt; g_itrframe (cf. kernel/machine/minit.c line 94)\n 10     # swap a0 and mscratch, so that a0 points to interrupt frame,\n 11     # i.e., [a0] = &amp;g_itrframe\n 12     csrrw a0, mscratch, a0\n 13\n 14     # save the registers in g_itrframe\n 15     addi t6, a0, 0\n 16     store_all_registers\n 17     # save the original content of a0 in g_itrframe\n 18     csrr t0, mscratch\n 19     sd t0, 72(a0)\n 20\n 21     # switch stack (to use stack0) for the rest of machine mode\n 22     # trap handling.\n 23     la sp, stack0\n 24     li a3, 4096\n 25     csrr a4, mhartid\n 26     addi a4, a4, 1\n 27     mul a3, a3, a4\n 28     add sp, sp, a3\n 29\n 30     # pointing mscratch back to g_itrframe\n 31     csrw mscratch, a0\n 32\n 33     # call machine mode trap handling function\n 34     call handle_mtrap\n 35\n 36     # restore all registers, come back to the status before entering\n 37     # machine mode handling.\n 38     csrr t6, mscratch\n 39     restore_all_registers\n 40\n 41     mret\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0cmtrapvec\u6c47\u7f16\u51fd\u6570\u9996\u5148\u4f1a\u5c06a0\u548cmscratch\u4ea4\u6362\uff0c\u800cmscratch\u4e4b\u524d\u4fdd\u62a4\u7684\u662fg_itrframe\u7684\u5730\u5740\uff08g_itrframe\u7684\u5b9a\u4e49\u5728kernel/machine/minit.c\u7684\u7b2c31\u884c<code>riscv_regs g_itrframe;</code>\uff0c\u4e5f\u5c31\u662f\u8bf4g_itrframe\u662f\u4e00\u4e2a\u5305\u542b\u6240\u6709RISC-V\u901a\u7528\u5bc4\u5b58\u5668\u7684\u6808\u5e27\uff09\u3002\u63a5\u4e0b\u6765\uff0c\u5c06t6\u8d4b\u503c\u4e3aa0\u7684\u503c\uff08\u7b2c15\u884c\uff09\uff0c\u5e76\u5c06\u6240\u6709\u901a\u7528\u5bc4\u5b58\u5668\u4fdd\u5b58\u5230t6\u5bc4\u5b58\u5668\u6240\u6307\u5b9a\u9996\u5730\u5740\u7684\u5185\u5b58\u533a\u57df\uff08\u8be5\u52a8\u4f5c\u7531\u7b2c16\u884c\u7684store_all_registers\u5b8c\u6210\uff09\u3002\u8fd9\u91cc\u56e0\u4e3at0=a0=mstratch\uff0c\u6240\u4ee5\u901a\u7528\u5bc4\u5b58\u5668\u6700\u7ec8\u662f\u4fdd\u5b58\u5230\u4e86mstratch\u6240\u6307\u5411\u7684\u5185\u5b58\u533a\u57df\uff0c\u4e5f\u5c31\u662fg_itrframe\u4e2d\u3002\u7b2c18-19\u884c\u662f\u4fdd\u62a4\u8fdb\u5165\u4e2d\u65ad\u5904\u7406\u524da0\u5bc4\u5b58\u5668\u7684\u503c\u5230g_itrframe\u3002</p> <p>\u63a5\u4e0b\u6765\uff0cmtrapvec\u6c47\u7f16\u51fd\u6570\u5728\u7b2c23--28\u884c\u5207\u6362\u6808\u5230stack0\uff08\u5373PKE\u5185\u6838\u542f\u52a8\u65f6\u7528\u8fc7\u7684\u6808\uff09\uff0c\u5e76\u572834\u884c\u8c03\u7528handle_mtrap()\u51fd\u6570\u3002handle_mtrap()\u51fd\u6570\u5728kernel/machine/mtrap.c\u6587\u4ef6\u4e2d\u5b9a\u4e49\uff1a</p> <pre><code> 20 void handle_mtrap() {\n21   uint64 mcause = read_csr(mcause);\n22   switch (mcause) {\n23     case CAUSE_FETCH_ACCESS:\n24       handle_instruction_access_fault();\n25       break;\n26     case CAUSE_LOAD_ACCESS:\n27       handle_load_access_fault();\n28     case CAUSE_STORE_ACCESS:\n29       handle_store_access_fault();\n30       break;\n31     case CAUSE_ILLEGAL_INSTRUCTION:\n32       // TODO (lab1_2): call handle_illegal_instruction to implement illegal instruction\n33       // interception, and finish lab1_2.\n34       panic( \"call handle_illegal_instruction to accomplish illegal instruction interception for lab1_2.\\n\" );\n35\n36       break;\n37     case CAUSE_MISALIGNED_LOAD:\n38       handle_misaligned_load();\n39       break;\n40     case CAUSE_MISALIGNED_STORE:\n41       handle_misaligned_store();\n42       break;\n43\n44     default:\n45       sprint(\"machine trap(): unexpected mscause %p\\n\", mcause);\n46       sprint(\"            mepc=%p mtval=%p\\n\", read_csr(mepc), read_csr(mtval));\n47       panic( \"unexpected exception happened in M-mode.\\n\" );\n48       break;\n49   }\n50 }\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0chandle_mtrap()\u51fd\u6570\u5bf9\u5728M\u6001\u5904\u7406\u7684\u591a\u9879\u5f02\u5e38\u90fd\u8fdb\u884c\u4e86\u5904\u7406\uff0c\u5904\u7406\u7684\u65b9\u5f0f\u51e0\u4e4e\u5168\u90e8\u662f\u8c03\u7528panic\u51fd\u6570\uff0c\u8ba9\uff08\u6a21\u62df\uff09\u673a\u5668\u505c\u673a\u3002\u5bf9\u4e8eCAUSE_ILLEGAL_INSTRUCTION\u5c1a\u672a\u5904\u7406\uff0c\u6240\u4ee5\u8fd9\u91cc\u4f60\u53ef\u4ee5\u5c06\u7b2c34\u884c\u7684panic\u51fd\u6570\u66ff\u6362\u6210\u5bf9handle_illegal_instruction()\u51fd\u6570\u7684\u8c03\u7528\uff0c\u5df2\u5b8c\u6210lab1_2\u3002</p> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u56e0\u4e3a\u5bf9\u4e8ePKE\u800c\u8a00\uff0c\u5b83\u53ea\u9700\u8981\u4e00\u6b21\u6267\u884c\u4e00\u4e2a\u5e94\u7528\u7a0b\u5e8f\u5373\u53ef\uff0c\u6240\u4ee5\u6211\u4eec\u53ef\u4ee5\u8c03\u7528panic\u8ba9\uff08\u6a21\u62df\uff09RISC-V\u673a\u5668\u505c\u673a\uff0c\u4f46\u662f\u5982\u679c\u662f\u5b9e\u9645\u7684\u786c\u4ef6\u673a\u5668\u573a\u666f\uff0c\u5c31\u8981\u60f3\u529e\u6cd5\u5c06\u53d1\u751f\u88abhandle_mtrap()\u51fd\u6570\u6240\u5904\u7406\u5f02\u5e38\u7684\u5e94\u7528\u8fdb\u7a0b\u9500\u6bc1\u6389\u3002</p> <p>\u5b9e\u9a8c\u5b8c\u6bd5\u540e\uff0c\u8bb0\u5f97\u63d0\u4ea4\u4fee\u6539\uff08\u547d\u4ee4\u884c\u4e2d-m\u540e\u7684\u5b57\u7b26\u4e32\u53ef\u81ea\u884c\u786e\u5b9a\uff09\uff0c\u4ee5\u4fbf\u5728\u540e\u7eed\u5b9e\u9a8c\u4e2d\u7ee7\u627flab1_2\u4e2d\u6240\u505a\u7684\u5de5\u4f5c\uff1a</p> <pre><code>$ git commit -a -m \"my work on lab1_2 is done.\"\n</code></pre> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter3_traps/#34-lab1_3","title":"3.4 lab1_3 \uff08\u5916\u90e8\uff09\u4e2d\u65ad","text":""},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter3_traps/#_8","title":"\u7ed9\u5b9a\u5e94\u7528","text":"<ul> <li>user/app_long_loop.c</li> </ul> <pre><code>  1 /*\n  2  * Below is the given application for lab1_3.\n  3  * This app performs a long loop, during which, timers are\n  4  * generated and pop messages to our screen.\n  5  */\n6\n7 #include \"user_lib.h\"\n8 #include \"util/types.h\"\n9\n10 int main(void) {\n11   printu(\"Hello world!\\n\");\n12   int i;\n13   for (i = 0; i &lt; 100000000; ++i) {\n14     if (i % 5000000 == 0) printu(\"wait %d\\n\", i);\n15   }\n16\n17   exit(0);\n18\n19   return 0;\n20 }\n</code></pre> <p>\u5e94\u7528\u7684\u7a0b\u5e8f\u903b\u8f91\u5305\u542b\u4e00\u4e2a\u957f\u5ea6\u4e3a100000000\u6b21\u7684\u5faa\u73af\uff0c\u5faa\u73af\u6bcf\u6b21\u5c06\u6574\u578b\u53d8\u91cfi\u52a0\u4e00\uff0c\u5f53i\u7684\u503c\u662f5000000\u7684\u6574\u6570\u500d\u65f6\uff0c\u8f93\u51fa\"wait i\u7684\u503c\\n\"\u3002\u8fd9\u4e2a\u5faa\u73af\u7a0b\u5e8f\u5728\u6211\u4eec\u7684\uff08\u6a21\u62df\uff09RISC-V\u5e73\u53f0\u4e0a\u8fd0\u884c\uff0c\u663e\u7136\u5c06\u6d88\u8017\u4e00\u5b9a\u65f6\u95f4\uff08\u5b9e\u9645\u4e0a\uff0c\u4f60\u4e5f\u53ef\u4ee5\u628a\u8fd9\u4e2a\u7a0b\u5e8f\u6539\u6210\u6b7b\u5faa\u73af\uff0c\u4f46\u5e76\u4e0d\u4f1a\u6b7b\u673a\uff01\u8bf7\u8bfb\u8005\u505a\u5b8clab1_3\u7684\u5b9e\u9a8c\u540e\u601d\u8003\u4e3a\u4ec0\u4e48\u6b7b\u5faa\u73af\u5e76\u4e0d\u4f1a\u5bfc\u81f4\u6b7b\u673a\u3002\uff09\u3002</p> <ul> <li>\uff08\u5148\u63d0\u4ea4lab1_2\u7684\u7b54\u6848\uff0c\u7136\u540e\uff09\u5207\u6362\u5230lab1_3\u3001\u7ee7\u627flab1_2\u4e2d\u6240\u505a\u4fee\u6539\uff0c\u5e76make\u540e\u7684\u76f4\u63a5\u8fd0\u884c\u7ed3\u679c\uff1a</li> </ul> <pre><code>//\u5207\u6362\u5230lab1_3\n$ git checkout lab1_3_irq\n\n//\u7ee7\u627flab1_2\u4ee5\u53ca\u4e4b\u524d\u7684\u7b54\u6848\n$ git merge lab1_2_exception -m \"continue to work on lab1_3\"\n//\u91cd\u65b0\u6784\u9020\n$ make clean; make\n\n//\u8fd0\u884c\u6784\u9020\u7ed3\u679c\n$ spike ./obj/riscv-pke ./obj/app_long_loop\nIn m_start, hartid:0\nHTIF is available!\n(Emulated) memory size: 2048 MB\nEnter supervisor mode...\nApplication: ./obj/app_long_loop\nApplication program entry point (virtual address): 0x000000008100007e\nSwitching to user mode...\nHello world!\nwait 0\nwait 5000000\nwait 10000000\nTicks 0\nlab1_3: increase g_ticks by one, and clear SIP field in sip register.\n\nSystem is shutting down with exit code -1.\n</code></pre> <p>\u4ee5\u4e0a\u8f93\u51fa\u4e2d\uff0c\u7531\u4e8e\u7bc7\u5e45\u7684\u5173\u7cfb\uff0c\u6211\u4eec\u9690\u85cf\u4e86\u524d\u4e09\u4e2a\u547d\u4ee4\u7684\u8f93\u51fa\u7ed3\u679c\u3002</p> <p>\u4ece\u4ee5\u4e0a\u7a0b\u5e8f\u7684\u8fd0\u884c\u7ed3\u679c\u6765\u770b\uff0c\u7ed9\u5b9a\u7684\u7a0b\u5e8f\u5e76\u4e0d\u662f\u201c\u4e0d\u53d7\u5e72\u6270\u201d\u5730\u4ece\u5f00\u59cb\u8fd0\u884c\u5230\u6700\u7ec8\u7ed3\u675f\u7684\uff0c\u800c\u662f\u5728\u8fd0\u884c\u8fc7\u7a0b\u4e2d\u53d7\u5230\u4e86\u7cfb\u7edf\u7684\u5916\u90e8\u65f6\u949f\u4e2d\u65ad\uff08timer irq\uff09\u7684\u201c\u5e72\u6270\u201d\uff01\u800c\u6211\u4eec\u5728\u8fd9\u4e2a\u5b9e\u9a8c\u4e2d\u7ed9\u51fa\u7684PKE\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\uff0c\u5728\u65f6\u949f\u4e2d\u65ad\u90e8\u5206\u5e76\u672a\u5b8c\u5168\u505a\u597d\uff0c\u5bfc\u81f4\uff08\u6a21\u62df\uff09RISC-V\u673a\u5668\u78b0\u5230\u7b2c\u4e00\u4e2a\u65f6\u949f\u4e2d\u65ad\u540e\u5c31\u4f1a\u51fa\u73b0\u5d29\u6e83\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter3_traps/#_9","title":"\u5b9e\u9a8c\u5185\u5bb9","text":"<p>\u5b8c\u6210PKE\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u672a\u5b8c\u6210\u7684\u65f6\u949f\u4e2d\u65ad\u5904\u7406\u8fc7\u7a0b\uff0c\u4f7f\u5f97\u5b83\u80fd\u591f\u5b8c\u6574\u5730\u5904\u7406\u65f6\u949f\u4e2d\u65ad\u3002</p> <p>\u5b9e\u9a8c\u5b8c\u6210\u540e\u7684\u8fd0\u884c\u7ed3\u679c\uff1a</p> <pre><code>$ spike ./obj/riscv-pke ./obj/app_long_loop\nIn m_start, hartid:0\nHTIF is available!\n(Emulated) memory size: 2048 MB\nEnter supervisor mode...\nApplication: obj/app_long_loop\nApplication program entry point (virtual address): 0x000000008100007e\nSwitching to user mode...\nHello world!\nwait 0\nwait 5000000\nwait 10000000\nTicks 0\nwait 15000000\nwait 20000000\nTicks 1\nwait 25000000\nwait 30000000\nwait 35000000\nTicks 2\nwait 40000000\nwait 45000000\nTicks 3\nwait 50000000\nwait 55000000\nwait 60000000\nTicks 4\nwait 65000000\nwait 70000000\nTicks 5\nwait 75000000\nwait 80000000\nwait 85000000\nTicks 6\nwait 90000000\nwait 95000000\nTicks 7\nUser exit with code:0.\nSystem is shutting down with exit code 0.\n</code></pre> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter3_traps/#_10","title":"\u5b9e\u9a8c\u6307\u5bfc","text":"<p>\u5728\u4e0a\u4e00\u4e2a\u5b9e\u9a8c\u4e2d\uff0c\u6211\u4eec\u5df2\u7ecf\u63a5\u89e6\u4e86\u673a\u5668\u6a21\u5f0f\uff08M-mode\uff09\u4e0b\u7684\u4e2d\u65ad\u5904\u7406\u3002\u5728\u672c\u5b9e\u9a8c\u4e2d\uff0c\u6211\u4eec\u63a5\u89e6\u7684\u65f6\u949f\u4e2d\u65ad\u4e5f\u662f\u5728\u673a\u5668\u6a21\u5f0f\u4e0b\u89e6\u53d1\u7684\u3002\u4e3a\u4e86\u5904\u7406\u65f6\u949f\u4e2d\u65ad\uff0c\u6211\u4eec\u7684PKE\u4ee3\u7801\u5728lab1_2\u7684\u57fa\u7840\u4e0a\uff0c\u65b0\u589e\u4e86\u4ee5\u4e0b\u5185\u5bb9\uff1a</p> <ul> <li>\u5728m_start\u51fd\u6570\uff08\u4e5f\u5c31\u662f\u673a\u5668\u6a21\u5f0f\u7684\u521d\u59cb\u5316\u51fd\u6570\uff09\u4e2d\u65b0\u589e\u4e86timerinit()\u51fd\u6570\uff0c\u540e\u8005\u7684\u51fd\u6570\u5b9a\u4e49\u5728kernel/machine/minit.c\u6587\u4ef6\uff1a</li> </ul> <pre><code> 82 void timerinit(uintptr_t hartid) {\n83   // fire timer irq after TIMER_INTERVAL from now.\n84   *(uint64*)CLINT_MTIMECMP(hartid) = *(uint64*)CLINT_MTIME + TIMER_INTERVAL;\n85\n86   // enable machine-mode timer irq in MIE (Machine Interrupt Enable) csr.\n87   write_csr(mie, read_csr(mie) | MIE_MTIE);\n88 }\n</code></pre> <p>\u8be5\u51fd\u6570\u9996\u5148\u572884\u884c\u8bbe\u7f6e\u4e86\u4e0b\u4e00\u6b21timer\u89e6\u53d1\u7684\u65f6\u95f4\uff0c\u5373\u5f53\u524d\u65f6\u95f4\u7684TIMER_INTERVAL\uff08\u53731000000\u5468\u671f\u540e\uff0c\u89c1kernel/config.h\u4e2d\u7684\u5b9a\u4e49\uff09\u4e4b\u540e\u3002\u53e6\u5916\uff0c\u572887\u884c\u8bbe\u7f6e\u4e86MIE\uff08Machine Interrupt Enable\uff0c\u89c1\u672c\u4e66\u7684\u7b2c\u4e00\u7ae0\u76841.3\u8282\u548c1.4\u8282\uff09\u5bc4\u5b58\u5668\u4e2d\u7684MIE_MTIE\u4f4d\uff0c\u5373\u5141\u8bb8\u6211\u4eec\u7684\uff08\u6a21\u62df\uff09RISC-V\u673a\u5668\u5728M\u6a21\u5f0f\u5904\u7406timer\u4e2d\u65ad\u3002</p> <p>\u65f6\u949f\u4e2d\u65ad\u89e6\u53d1\u540e\uff0ckernel/machine/mtrap_vector.S\u6587\u4ef6\u4e2d\u7684mtrapvec\u51fd\u6570\u5c06\u88ab\u8c03\u7528\uff1a</p> <pre><code>  8 mtrapvec:\n  9     # mscratch -&gt; g_itrframe (cf. kernel/machine/minit.c line 94)\n 10     # swap a0 and mscratch, so that a0 points to interrupt frame,\n 11     # i.e., [a0] = &amp;g_itrframe\n 12     csrrw a0, mscratch, a0\n 13\n 14     # save the registers in g_itrframe\n 15     addi t6, a0, 0\n 16     store_all_registers\n 17     # save the original content of a0 in g_itrframe\n 18     csrr t0, mscratch\n 19     sd t0, 72(a0)\n 20\n 21     # switch stack (to use stack0) for the rest of machine mode\n 22     # trap handling.\n 23     la sp, stack0\n 24     li a3, 4096\n 25     csrr a4, mhartid\n 26     addi a4, a4, 1\n 27     mul a3, a3, a4\n 28     add sp, sp, a3\n 29\n 30     # pointing mscratch back to g_itrframe\n 31     csrw mscratch, a0\n 32\n 33     # call machine mode trap handling function\n 34     call handle_mtrap\n 35\n 36     # restore all registers, come back to the status before entering\n 37     # machine mode handling.\n 38     csrr t6, mscratch\n 39     restore_all_registers\n 40\n 41     mret\n</code></pre> <p>\u548clab1_2\u4e00\u6837\uff0c\u6700\u7ec8\u5c06\u8fdb\u5165handle_mtrap\u51fd\u6570\u7ee7\u7eed\u5904\u7406\u3002handle_mtrap\u51fd\u6570\u5c06\u901a\u8fc7\u5bf9mcause\u5bc4\u5b58\u5668\u7684\u503c\u8fdb\u884c\u5224\u65ad\uff0c\u786e\u8ba4\u662f\u65f6\u949f\u4e2d\u65ad\uff08CAUSE_MTIMER\uff09\u540e\uff0c\u5c06\u8c03\u7528handle_timer()\u51fd\u6570\u8fdb\u884c\u8fdb\u4e00\u6b65\u5904\u7406\uff1a</p> <pre><code> 18 static void handle_timer() {\n19   int cpuid = 0;\n20   // setup the timer fired at next time (TIMER_INTERVAL from now)\n21   *(uint64*)CLINT_MTIMECMP(cpuid) = *(uint64*)CLINT_MTIMECMP(cpuid) + TIMER_INTERVAL;\n22\n23   // setup a soft interrupt in sip (S-mode Interrupt Pending) to be handled in S-mode\n24   write_csr(sip, SIP_SSIP);\n25 }\n26\n27 //\n28 // handle_mtrap calls a handling function according to the type of a machine mode interrupt (    trap).\n29 //\n30 void handle_mtrap() {\n31   uint64 mcause = read_csr(mcause);\n32   switch (mcause) {\n33     case CAUSE_MTIMER:\n34       handle_timer();\n35       break;\n36     case CAUSE_FETCH_ACCESS:\n37       handle_instruction_access_fault();\n38       break;\n39     case CAUSE_LOAD_ACCESS:\n40       handle_load_access_fault();\n41     case CAUSE_STORE_ACCESS:\n42       handle_store_access_fault();\n43       break;\n44     case CAUSE_ILLEGAL_INSTRUCTION:\n45       // TODO (lab1_2): call handle_illegal_instruction to implement illegal instruction\n46       // interception, and finish lab1_2.\n47       panic( \"call handle_illegal_instruction to accomplish illegal instruction interception     for lab1_2.\\n\" );\n48\n49       break;\n50     case CAUSE_MISALIGNED_LOAD:\n51       handle_misaligned_load();\n52       break;\n53     case CAUSE_MISALIGNED_STORE:\n54       handle_misaligned_store();\n55       break;\n56\n57     default:\n58       sprint(\"machine trap(): unexpected mscause %p\\n\", mcause);\n59       sprint(\"            mepc=%p mtval=%p\\n\", read_csr(mepc), read_csr(mtval));\n60       panic( \"unexpected exception happened in M-mode.\\n\" );\n61       break;\n62   }\n63 }\n</code></pre> <p>\u800chandle_timer()\u51fd\u6570\u4f1a\uff08\u5728\u7b2c21\u884c\uff09\u5148\u8bbe\u7f6e\u4e0b\u4e00\u6b21timer\uff08\u518d\u6b21\uff09\u89e6\u53d1\u7684\u65f6\u95f4\u4e3a\u5f53\u524d\u65f6\u95f4+TIMER_INTERVAL\uff0c\u5e76\u572824\u884c\u5bf9SIP\uff08Supervisor Interrupt Pending\uff0c\u5373S\u6a21\u5f0f\u7684\u4e2d\u65ad\u7b49\u5f85\u5bc4\u5b58\u5668\uff09\u5bc4\u5b58\u5668\u8fdb\u884c\u8bbe\u7f6e\uff0c\u5c06\u5176\u4e2d\u7684SIP_SSIP\u4f4d\u8fdb\u884c\u8bbe\u7f6e\uff0c\u5b8c\u6210\u540e\u8fd4\u56de\u3002\u81f3\u6b64\uff0c\u65f6\u949f\u4e2d\u65ad\u5728M\u6001\u7684\u5904\u7406\u5c31\u7ed3\u675f\u4e86\uff0c\u5269\u4e0b\u7684\u52a8\u4f5c\u4ea4\u7ed9S\u6001\u7ee7\u7eed\u5904\u7406\u3002\u800chandle_timer()\u5728\u7b2c23\u884c\u7684\u52a8\u4f5c\uff0c\u4f1a\u5bfc\u81f4PKE\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u5728S\u6a21\u5f0f\u6536\u5230\u4e00\u4e2a\u6765\u81eaM\u6001\u7684\u65f6\u949f\u4e2d\u65ad\u8bf7\u6c42\uff08CAUSE_MTIMER_S_TRAP\uff09\u3002</p> <p>\u90a3\u4e48\u4e3a\u4ec0\u4e48\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u4e0d\u5728M\u6001\u5c31\u5b8c\u6210\u5bf9\u65f6\u949f\u4e2d\u65ad\u7684\u5904\u7406\uff0c\u800c\u4e00\u5b9a\u8981\u5c06\u5b83\u201c\u63a5\u529b\u201d\u7ed9S\u6001\u5462\uff1f\u8fd9\u662f\u56e0\u4e3a\uff0c\u5bf9\u4e8e\u4e00\u4e2a\u64cd\u4f5c\u7cfb\u7edf\u6765\u8bf4\uff0ctimer\u4e8b\u4ef6\u5bf9\u5b83\u7684\u610f\u4e49\u5728\u4e8e\uff0c\u5b83\u662f\u6807\u8bb0\u65f6\u95f4\u7247\u7684\u91cd\u8981\uff08\u751a\u81f3\u662f\u552f\u4e00\uff09\u624b\u6bb5\uff0c\u800c\u5c06CPU\u4e8b\u4ef6\u5206\u6210\u82e5\u5e72\u65f6\u95f4\u7247\u7684\u4f5c\u7528\u5f88\u5927\u7a0b\u5ea6\u4e0a\u662f\u4e3a\u4e86\u505a\u8fdb\u7a0b\u7684\u8c03\u5ea6\uff08\u6211\u4eec\u5c06\u5728lab2_3\u4e2d\u63a5\u89e6\uff09\uff0c\u540c\u65f6\uff0c\u64cd\u4f5c\u7cfb\u7edf\u7684\u529f\u80fd\u5927\u591a\u6570\u662f\u5728S\u6001\u5b8c\u6210\u7684\u3002\u5982\u679c\u5728M\u6001\u5904\u7406\u65f6\u949f\u4e2d\u65ad\uff0c\u867d\u7136\u8bf4\u7279\u6743\u7ea7\u4e0a\u5141\u8bb8\u8fd9\u6837\u7684\u64cd\u4f5c\uff0c\u4f46\u662f\u5904\u4e8eM\u6001\u7684\u7a0b\u5e8f\u53ef\u80fd\u5e76\u4e0d\u662f\u975e\u5e38\u6e05\u695aS\u6001\u7684\u64cd\u4f5c\u7cfb\u7edf\u7684\u72b6\u6001\u3002\u5982\u679c\u8d38\u7136\u91c7\u53d6\u52a8\u4f5c\uff0c\u53ef\u80fd\u4f1a\u7834\u574f\u64cd\u4f5c\u7cfb\u7edf\u672c\u8eab\u7684\u8bbe\u8ba1\u3002</p> <p>\u63a5\u4e0b\u6765\uff0c\u6211\u4eec\u7ee7\u7eed\u8ba8\u8bba\u65f6\u949f\u4e2d\u65ad\u5728S\u6001\u7684\u5904\u7406\u3002\u6211\u4eec\u76f4\u63a5\u6765\u5230S\u6001\u7684C\u5904\u7406\u51fd\u6570\uff0c\u5373\u4f4d\u4e8ekernel/strap.c\u4e2d\u7684 smode_trap_handler\u51fd\u6570\uff1a</p> <pre><code> 48 void smode_trap_handler(void) {\n49   // make sure we are in User mode before entering the trap handling.\n50   // we will consider other previous case in lab1_3 (interrupt).\n51   if ((read_csr(sstatus) &amp; SSTATUS_SPP) != 0) panic(\"usertrap: not from user mode\");\n52\n53   assert(current);\n54   // save user process counter.\n55   current-&gt;trapframe-&gt;epc = read_csr(sepc);\n56\n57   // if the cause of trap is syscall from user application.\n58   // read_csr() and CAUSE_USER_ECALL are macros defined in kernel/riscv.h\n59   uint64 cause = read_csr(scause);\n60\n61   // we need to handle the timer trap @lab1_3.\n62   if (cause == CAUSE_USER_ECALL) {\n63     handle_syscall(current-&gt;trapframe);\n64   } else if (cause == CAUSE_MTIMER_S_TRAP) {  //soft trap generated by timer interrupt in M m    ode\n65     handle_mtimer_trap();\n66   } else {\n67     sprint(\"smode_trap_handler(): unexpected scause %p\\n\", read_csr(scause));\n68     sprint(\"            sepc=%p stval=%p\\n\", read_csr(sepc), read_csr(stval));\n69     panic( \"unexpected exception happened.\\n\" );\n70   }\n71\n72   // continue (come back to) the execution of current process.\n73   switch_to(current);\n74 }\n</code></pre> <p>\u6211\u4eec\u770b\u5230\uff0c\u8be5\u51fd\u6570\u9996\u5148\u8bfb\u53d6scause\u5bc4\u5b58\u5668\u7684\u5185\u5bb9\uff0c\u5982\u679c\u5185\u5bb9\u7b49\u4e8eCAUSE_MTIMER_S_TRAP\u7684\u8bdd\uff0c\u8bf4\u660e\u662fM\u6001\u4f20\u9012\u4e0a\u6765\u7684\u65f6\u949f\u4e2d\u65ad\u52a8\u4f5c\uff0c\u5c31\u8c03\u7528handle_mtimer_trap()\u51fd\u6570\u8fdb\u884c\u5904\u7406\uff0c\u800chandle_mtimer_trap()\u51fd\u6570\u7684\u5b9a\u4e49\u4e3a:</p> <pre><code> 31 static uint64 g_ticks = 0;\n32 //\n33 // added @lab1_3\n34 //\n35 void handle_mtimer_trap() {\n36   sprint(\"Ticks %d\\n\", g_ticks);\n37   // TODO (lab1_3): increase g_ticks to record this \"tick\", and then clear the \"SIP\"\n38   // field in sip register.\n39   // hint: use write_csr to disable the SIP_SSIP bit in sip.\n40   panic( \"lab1_3: increase g_ticks by one, and clear SIP field in sip register.\\n\" );\n41\n42 }\n</code></pre> <p>\u81f3\u6b64\uff0c\u6211\u4eec\u5c31\u77e5\u9053\u4e3a\u4ec0\u4e48\u4f1a\u5728\u4e4b\u524d\u770b\u5230<code>lab1_3: increase g_ticks by one, and clear SIP field in sip register.</code>\u8fd9\u6837\u7684\u8f93\u51fa\u4e86\uff0c\u663e\u7136\u8fd9\u662f\u56e0\u4e3ahandle_mtimer_trap()\u5e76\u672a\u5b8c\u6210\u3002</p> <p>\u90a3\u4e48handle_mtimer_trap()\u9700\u8981\u5b8c\u6210\u54ea\u4e9b\u201c\u540e\u7eed\u52a8\u4f5c\u201d\u5462\uff1f\u9996\u5148\uff0c\u6211\u4eec\u770b\u5230\u5728\u8be5\u51fd\u6570\u4e0a\u9762\u5b9a\u4e49\u4e86\u4e00\u4e2a\u5168\u5c40\u53d8\u91cfg_ticks\uff0c\u7528\u5b83\u6765\u5bf9\u65f6\u949f\u4e2d\u65ad\u7684\u6b21\u6570\u8fdb\u884c\u8ba1\u6570\uff0c\u800c\u7b2c36\u884c\u4f1a\u8f93\u51fa\u8be5\u8ba1\u6570\u3002\u4e3a\u4e86\u786e\u4fdd\u6211\u4eec\u7684\u7cfb\u7edf\u6301\u7eed\u6b63\u5e38\u8fd0\u884c\uff0c\u8be5\u8ba1\u6570\u5e94\u6bcf\u6b21\u90fd\u4f1a\u5b8c\u6210\u52a0\u4e00\u64cd\u4f5c\u3002\u6240\u4ee5\uff0chandle_mtimer_trap()\u9996\u5148\u9700\u8981\u5bf9g_ticks\u8fdb\u884c\u52a0\u4e00\uff1b\u5176\u6b21\uff0c\u7531\u4e8e\u5904\u7406\u5b8c\u4e2d\u65ad\u540e\uff0cSIP\uff08Supervisor Interrupt Pending\uff0c\u5373S\u6a21\u5f0f\u7684\u4e2d\u65ad\u7b49\u5f85\u5bc4\u5b58\u5668\uff09\u5bc4\u5b58\u5668\u4e2d\u7684SIP_SSIP\u4f4d\u4ecd\u7136\u4e3a1\uff08\u7531M\u6001\u7684\u4e2d\u65ad\u5904\u7406\u51fd\u6570\u8bbe\u7f6e\uff09\uff0c\u5982\u679c\u8be5\u4f4d\u6301\u7eed\u4e3a1\u7684\u8bdd\u4f1a\u5bfc\u81f4\u6211\u4eec\u7684\u6a21\u62dfRISC-V\u673a\u5668\u59cb\u7ec8\u5904\u4e8e\u4e2d\u65ad\u72b6\u6001\u3002\u6240\u4ee5\uff0chandle_mtimer_trap()\u8fd8\u9700\u8981\u5bf9SIP\u7684SIP_SSIP\u4f4d\u6e05\u96f6\uff0c\u4ee5\u4fdd\u8bc1\u4e0b\u6b21\u518d\u53d1\u751f\u65f6\u949f\u4e2d\u65ad\u65f6\uff0cM\u6001\u7684\u51fd\u6570\u5c06\u8be5\u4f4d\u7f6e\u4e00\u4f1a\u5bfc\u81f4S\u6a21\u5f0f\u7684\u4e0b\u4e00\u6b21\u4e2d\u65ad\u3002</p> <p>\u5b9e\u9a8c\u5b8c\u6bd5\u540e\uff0c\u8bb0\u5f97\u63d0\u4ea4\u4fee\u6539\uff08\u547d\u4ee4\u884c\u4e2d-m\u540e\u7684\u5b57\u7b26\u4e32\u53ef\u81ea\u884c\u786e\u5b9a\uff09\uff0c\u4ee5\u4fbf\u5728\u540e\u7eed\u5b9e\u9a8c\u4e2d\u7ee7\u627flab1_3\u4e2d\u6240\u505a\u7684\u5de5\u4f5c\uff1a</p> <pre><code>$ git commit -a -m \"my work on lab1_3 is done.\"\n</code></pre> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter3_traps/#35-lab1_challenge1","title":"3.5 lab1_challenge1 \u6253\u5370\u7528\u6237\u7a0b\u5e8f\u8c03\u7528\u6808\uff08\u96be\u5ea6\uff1a\u2605\u2605\u2605\u2606\u2606\uff09","text":""},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter3_traps/#_11","title":"\u7ed9\u5b9a\u5e94\u7528","text":"<ul> <li>user/app_print_backtrace.c</li> </ul> <pre><code>  1 /*\n  2  * Below is the given application for lab1_challenge1_backtrace.\n  3  * This app prints all functions before calling print_backtrace().\n  4  */\n5\n6 #include \"user_lib.h\"\n7 #include \"util/types.h\"\n8\n9 void f8() { print_backtrace(7); }\n10 void f7() { f8(); }\n11 void f6() { f7(); }\n12 void f5() { f6(); }\n13 void f4() { f5(); }\n14 void f3() { f4(); }\n15 void f2() { f3(); }\n16 void f1() { f2(); }\n17\n18 int main(void) {\n19   printu(\"back trace the user app in the following:\\n\");\n20   f1();\n21   exit(0);\n22   return 0;\n23 }\n</code></pre> <p>\u4ee5\u4e0a\u7a0b\u5e8f\u5728\u771f\u6b63\u8c03\u7528\u7cfb\u7edf\u8c03\u7528print_backtrace(7)\u4e4b\u524d\u7684\u51fd\u6570\u8c03\u7528\u5173\u7cfb\u6bd4\u590d\u6742\uff0c\u56fe\u793a\u8d77\u6765\u6709\u4ee5\u4e0b\u5173\u7cfb\uff1a</p> <p>main -&gt; f1 -&gt; f2 -&gt; f3 -&gt; f4 -&gt; f5 -&gt; f6 -&gt; f7 -&gt; f8</p> <p>print_backtrace(7)\u7684\u4f5c\u7528\u662f\u5c06\u4ee5\u4e0a\u7528\u6237\u7a0b\u5e8f\u7684\u51fd\u6570\u8c03\u7528\u5173\u7cfb\uff0c\u4ece\u6700\u540e\u7684f8\u5411\u4e0a\u6253\u53707\u5c42\uff0c\u9884\u671f\u7684\u8f93\u51fa\u4e3a\uff1a</p> <pre><code>In m_start, hartid:0\nHTIF is available!\n(Emulated) memory size: 2048 MB\nEnter supervisor mode...\nApplication: obj/app_print_backtrace\nApplication program entry point (virtual address): 0x0000000081000072\nSwitching to user mode...\nback trace the user app in the following:\nf8\nf7\nf6\nf5\nf4\nf3\nf2\nUser exit with code:0.\nSystem is shutting down with exit code 0.\n</code></pre> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter3_traps/#_12","title":"\u5b9e\u9a8c\u5185\u5bb9","text":"<p>\u672c\u5b9e\u9a8c\u4e3a\u6311\u6218\u5b9e\u9a8c\uff0c\u57fa\u7840\u4ee3\u7801\u5c06\u7ee7\u627f\u548c\u4f7f\u7528lab1_3\u5b8c\u6210\u540e\u7684\u4ee3\u7801\uff1a</p> <ul> <li>\uff08\u5148\u63d0\u4ea4lab1_3\u7684\u7b54\u6848\uff0c\u7136\u540e\uff09\u5207\u6362\u5230lab1_challenge1_backtrace\u3001\u7ee7\u627flab1_3\u4e2d\u6240\u505a\u4fee\u6539\uff1a</li> </ul> <pre><code>//\u5207\u6362\u5230lab1_challenge1_backtrace\n$ git checkout lab1_challenge1_backtrace //\u7ee7\u627flab1_3\u4ee5\u53ca\u4e4b\u524d\u7684\u7b54\u6848\n$ git merge lab1_3_irq -m \"continue to work on lab1_challenge1\"\n</code></pre> <p>\u6ce8\u610f\uff1a\u4e0d\u540c\u4e8e\u57fa\u7840\u5b9e\u9a8c\uff0c\u6311\u6218\u5b9e\u9a8c\u7684\u57fa\u7840\u4ee3\u7801\u5177\u6709\u66f4\u5927\u7684\u4e0d\u5b8c\u6574\u6027\uff0c\u53ef\u80fd\u65e0\u6cd5\u76f4\u63a5\u901a\u8fc7\u6784\u9020\u8fc7\u7a0b\u3002\u4f8b\u5982\uff0c\u7531\u4e8e\u4ee5\u4e0a\u7684\u7528\u6237\u4ee3\u7801\u4e2dprint_backtrace()\u7cfb\u7edf\u8c03\u7528\u5e76\u672a\u5b9e\u73b0\uff0c\u6240\u4ee5\u6784\u9020\u65f6\u5c31\u4f1a\u62a5\u9519\u3002\u540c\u6837\uff0c\u4e0d\u540c\u4e8e\u57fa\u7840\u5b9e\u9a8c\uff0c\u6211\u4eec\u5728\u4ee3\u7801\u4e2d\u4e5f\u5e76\u672a\u4e13\u95e8\u5730\u54ea\u4e9b\u5730\u65b9\u7684\u4ee3\u7801\u9700\u8981\u586b\u5199\uff0c\u54ea\u4e9b\u5730\u65b9\u7684\u4ee3\u7801\u65e0\u987b\u586b\u5199\u3002\u8fd9\u6837\uff0c\u6211\u4eec\u7559\u7ed9\u8bfb\u8005\u66f4\u5927\u7684\u201c\u60f3\u8c61\u7a7a\u95f4\u201d\u3002</p> <ul> <li>\u672c\u5b9e\u9a8c\u7684\u5177\u4f53\u8981\u6c42\u4e3a\uff1a</li> </ul> <p>\u901a\u8fc7\u4fee\u6539PKE\u5185\u6838\uff0c\u6765\u5b9e\u73b0\u4ece\u7ed9\u5b9a\u5e94\u7528\uff08user/app_print_backtrace.c\uff09\u5230\u9884\u671f\u8f93\u51fa\u7684\u8f6c\u6362\u3002</p> <p>\u5bf9\u4e8eprint_backtrace()\u51fd\u6570\u7684\u5b9e\u73b0\u8981\u6c42\uff1a</p> <p>\u5e94\u7528\u7a0b\u5e8f\u8c03\u7528print_backtrace()\u65f6\uff0c\u5e94\u80fd\u591f\u901a\u8fc7\u63a7\u5236\u8f93\u5165\u7684\u53c2\u6570\uff08\u5982\u4f8b\u5b50user/app_print_backtrace.c\u4e2d\u76847\uff09\u63a7\u5236\u56de\u6eaf\u7684\u5c42\u6570\u3002\u4f8b\u5982\uff0c\u5982\u679c\u8c03\u7528print_backtrace(5)\u5219\u53ea\u8f93\u51fa5\u5c42\u56de\u6eaf\uff1b\u5982\u679c\u8c03\u7528print_backtrace(100)\uff0c\u5219\u5e94\u53ea\u56de\u6eaf\u5230main\u51fd\u6570\u5c31\u505c\u6b62\u56de\u6eaf\uff08\u56e0\u4e3a\u8c03\u7528\u7684\u6df1\u5ea6\u5c0f\u4e8e100\uff09\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter3_traps/#_13","title":"\u5b9e\u9a8c\u6307\u5bfc","text":"<p>\u4e3a\u5b8c\u6210\u8be5\u6311\u6218\uff0cPKE\u5185\u6838\u7684\u5b8c\u5584\u5e94\u5305\u542b\u4ee5\u4e0b\u5185\u5bb9\uff1a</p> <ul> <li>\u7cfb\u7edf\u8c03\u7528\u8def\u5f84\u4e0a\u7684\u5b8c\u5584\uff0c\u53ef\u53c2\u89c13.2\u4e2d\u7684\u77e5\u8bc6\uff1b</li> <li>\u5728\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u4e2d\u83b7\u53d6\u7528\u6237\u7a0b\u5e8f\u7684\u6808\u3002\u8fd9\u91cc\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0cPKE\u7cfb\u7edf\u4e2d\u5f53\u7528\u6237\u7a0b\u5e8f\u901a\u8fc7\u7cfb\u7edf\u8c03\u7528\u9677\u5165\u5230\u5185\u6838\u65f6\uff0c\u4f1a\u5207\u6362\u5230S\u6a21\u5f0f\u7684\u201c\u7528\u6237\u5185\u6838\u201d\u6808\uff0c\u800c\u4e0d\u662f\u5728\u7528\u6237\u6808\u4e0a\u7ee7\u7eed\u64cd\u4f5c\u3002\u6211\u4eec\u7684print_backtrace()\u51fd\u6570\u7684\u8bbe\u8ba1\u76ee\u6807\u662f\u56de\u6eaf\u5e76\u6253\u5370\u7528\u6237\u8fdb\u7a0b\u7684\u51fd\u6570\u8c03\u7528\u60c5\u51b5\uff0c\u6240\u4ee5\uff0c\u8fdb\u5165\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u540e\uff0c\u9700\u8981\u627e\u5230\u7528\u6237\u8fdb\u7a0b\u7684\u7528\u6237\u6001\u6808\u6765\u5f00\u59cb\u56de\u6eaf\uff1b</li> <li>\u627e\u5230\u7528\u6237\u6001\u6808\u540e\uff0c\u6211\u4eec\u9700\u8981\u4e86\u89e3\u7528\u6237\u6001\u6808\u7684\u7ed3\u6784\u3002\u5b9e\u9645\u4e0a\uff0c\u8fd9\u4e00\u70b9\u5728\u6211\u4eec\u7684\u7b2c\u4e00\u7ae0\u5c31\u6709\u4e3e\u4f8b\u6765\u8bf4\u660e\uff0c\u8bfb\u8005\u53ef\u4ee5\u56de\u987e\u4e00\u4e0b\u7b2c\u4e00\u7ae0\u7684\u4f8b\u5b50\uff1b</li> <li>\u901a\u8fc7\u7528\u6237\u6808\u627e\u5230\u51fd\u6570\u7684\u8fd4\u56de\u5730\u5740\u540e\uff0c\u9700\u8981\u5c06\u865a\u62df\u5730\u5740\u8f6c\u6362\u4e3a\u6e90\u7a0b\u5e8f\u4e2d\u7684\u7b26\u53f7\u3002\u8fd9\u4e00\u70b9\uff0c\u8bfb\u8005\u9700\u8981\u4e86\u89e3ELF\u6587\u4ef6\u4e2d\u7684\u7b26\u53f7\u8282\uff08.symtab section\uff09\uff0c\u4ee5\u53ca\u5b57\u7b26\u4e32\u8282\uff08.strtab section\uff09\u7684\u76f8\u5173\u77e5\u8bc6\uff0c\u4e86\u89e3\u8fd9\u4e24\u4e2a\u8282\uff08section\uff09\u91cc\u5b58\u50a8\u7684\u5185\u5bb9\u4ee5\u53ca\u5b58\u50a8\u7684\u683c\u5f0f\u7b49\u5185\u5bb9\u3002\u5bf9ELF\u7684\u8fd9\u4e24\u4e2a\u8282\uff0c\u7f51\u4e0a\u6709\u5927\u91cf\u7684\u4ecb\u7ecd\uff0c\u4f8b\u5982\u8fd9\u91cc\uff0c\u6216\u9605\u8bfbLinux Man Page\u3002</li> </ul> <p>\u63d0\u793a\uff1a</p> <p>\u7406\u8bba\u4e0a\uff0c\u6211\u4eec\u5e0c\u671b\u4f60\u4e86\u89e3\u51fd\u6570\u8c03\u7528\u65f6\u6808\u5e27\u7684\u7ed3\u6784\uff0c\u901a\u8fc7fp\u5bc4\u5b58\u5668(s0)\u5bfb\u627e\u5404\u4e2a\u6808\u5e27\uff1b\u7136\u800c\uff0c\u7f16\u8bd1\u5668\u4e00\u822c\u4f1a\u4f18\u5316\u6389fp\uff0c\u4f7f\u5f97\u5b83\u7684\u503c\u59cb\u7ec8\u4e3a0\uff0c\u5728\u53d1\u751f\u51fd\u6570\u8c03\u7528\u65f6\u4e5f\u4e0d\u4fdd\u5b58\u8fd9\u4e2a\u5bc4\u5b58\u5668\uff0c\u5b9e\u9a8c\u7684Makefile\u5df2\u7ecf\u4f7f\u7528<code>-fno-omit-frame-pointer</code>\u7981\u6b62\u4e86\u6b64\u9879\u4f18\u5316\u3002</p> <p>\u7b2c\u4e00\u7ae0\u4e2d\u7684 \u4e3e\u4f8b \u7a0b\u5e8f\u4e2d\uff0c\u51fd\u6570\u8c03\u7528\u7684\u6808\u5e27\uff08\u6b64\u65f6 bar \u51fd\u6570\u4f5c\u4e3a\u53f6\u5b50\u8c03\u7528\u51fd\u6570\uff09\u7c7b\u4f3c\u4e0b\u56fe\uff1a</p> <p></p> <p>\u6ce8\u610f\uff0c\u51fd\u6570\u8c03\u7528\u7684\u53f6\u5b50\u7ed3\u70b9\u4e00\u822c\u4e0d\u4f1a\u5c06ra\u4fdd\u5b58\u5230\u6808\u4e2d\uff1b</p> <p>\u5982\u679c\u4f60\u53d1\u73b0\u4f7f\u7528fp\u8ffd\u8e2a\u6808\u5e95\u96be\u5ea6\u592a\u5927\uff0c\u53ef\u4ee5\u5047\u8bbe\u7528\u6237\u7a0b\u5e8f\u7684\u51fd\u6570\u8c03\u7528\u4ea7\u751f\u7684\u6808\u5e27\u603b\u662f\u5b9a\u957f\u7684\uff1b\u4e3a\u4e86\u83b7\u5f97\u8fd9\u4e2a\u957f\u5ea6\uff0c\u4f60\u53ef\u4ee5\uff1a</p> <pre><code>$ riscv64-unknown-elf-objdump -d obj/app_print_backtrace\n</code></pre> <p>\u89c2\u5bdf<code>f1</code>~ <code>f8</code>\u5f00\u59cb\u65f6\u7684\u6c47\u7f16\u4ee3\u7801\uff0c\u7279\u522b\u6ce8\u610f\u7528\u6237\u6001\u51fd\u6570<code>do_user_call</code>\uff0c\u5b83\u7684\u6808\u5e27\u4e0e<code>f1</code> \u7b49\u7565\u6709\u4e0d\u540c\u3002</p> <p>\u4f7f\u7528\u8fd9\u79cd\u65b9\u6cd5\u867d\u7136\u5728\u5c40\u90e8\u53d8\u91cf\u592a\u591a\uff0c\u6216\u8005\u51fd\u6570\u53c2\u6570\u8f83\u591a\u65f6\u65e0\u6cd5\u6b63\u786e\u5b9e\u73b0 backtrace \u529f\u80fd\uff0c\u4e5f\u4e0d\u662f\u6211\u4eec\u9884\u671f\u7684\u505a\u6cd5\uff0c\u4f46\u6211\u4eec\u8fdb\u884c\u6d4b\u8bd5\u65f6\u786e\u5b9e\u4f1a\u4f7f\u7528\u7b80\u5355\u7684\u6d4b\u8bd5\u7528\u4f8b\uff08\u6ca1\u6709\u53c2\u6570\uff0c\u5c40\u90e8\u53d8\u91cf\uff09\uff0c\u56e0\u6b64\u53ef\u4ee5\u901a\u8fc7 :)</p> <p>\u7406\u8bba\u4e0a\uff0c\u5b8c\u6210\u8be5\u5b9e\u9a8c\u9700\u8981\u540c\u5b66\u4eec\u638c\u63e1\u5bf9\u4e8eELF\u6587\u4ef6\u7684\u7ed3\u6784\uff0c\u5176\u4e3b\u4f53\u7ed3\u6784\u5982\u56fe\u6240\u793a:</p> <p></p> <p>\u7531\u56fe\u5f97\u77e5\uff0c\u4e00\u4e2a ELF \u5934\u5728\u6587\u4ef6\u7684\u5f00\u59cb\uff0c\u4fdd\u5b58\u4e86\u8def\u7ebf\u56fe(road map)\uff0c\u63cf\u8ff0\u4e86\u8be5\u6587\u4ef6\u7684\u7ec4\u7ec7\u60c5\u51b5\u3002\u53ef\u4ee5\u8bf4\uff0c ELF \u5934\u662f\u6574\u4e2aELF\u6587\u4ef6\u7684\u201c\u7075\u9b42\u201d\u6240\u5728\u3002\u6240\u4ee5\u8bf4\u6211\u4eec\u8981\u5bf9ELF\u5934\u8fdb\u884c\u7814\u7a76\u3002</p> <p>\u5728<code>elf.h</code>\u4e2d\u6211\u4eec\u770b\u5230\u4e86ELF\u5934\u5b58\u50a8\u7684\u5185\u5bb9:\u672c\u6587\u6863\u53ea\u63d0\u793a\u4e0e\u5b9e\u9a8c\u5185\u5bb9\u606f\u606f\u76f8\u5173\u7684\u6210\u5458:<code>shoff</code>\u8bb0\u5f55\u4e86\u7b2c\u4e00\u4e2aSection Header\u7684\u4f4d\u7f6e\uff0c<code>shentsize</code>\u4ee3\u8868\u4e86\u4e00\u4e2aSection Header\u7684\u5927\u5c0f\uff0c<code>shnum</code>\u4ee3\u8868\u4e00\u5171\u6709\u591a\u5c11\u4e2aSection Header\uff0c<code>shstrndx</code>\u4ee3\u8868\u4e86String Table\u7684\u7d22\u5f15\u503c\uff0c\u540c\u5b66\u4eec\u53ef\u4ee5\u8bd5\u7740\u6253\u5370\u4e00\u4e0b<code>shstrndx</code>\u7684\u503c\u662f\u591a\u5c11\u3002</p> <pre><code>9  // elf header structure\n10 typedef struct elf_header_t {\n11   uint32 magic;\n12   uint8 elf[12];\n13   uint16 type;      /* Object file type */\n14   uint16 machine;   /* Architecture */\n15   uint32 version;   /* Object file version */\n16   uint64 entry;     /* Entry point virtual address */\n17   uint64 phoff;     /* Program header table file offset */\n18   uint64 shoff;     /* Section header table file offset */\n19   uint32 flags;     /* Processor-specific flags */\n20   uint16 ehsize;    /* ELF header size in bytes */\n21   uint16 phentsize; /* Program header table entry size */\n22   uint16 phnum;     /* Program header table entry count */\n23   uint16 shentsize; /* Section header table entry size */\n24   uint16 shnum;     /* Section header table entry count */\n25   uint16 shstrndx;  /* Section header string table index */\n26 } elf_header;\n</code></pre> <p>\u5728<code>elf_init</code>\u51fd\u6570\u4e2d\u5b8c\u6210\u4e86<code>elf header</code>\u7684\u52a0\u8f7d:</p> <pre><code>41  // load the elf header\n42  if (elf_fpread(ctx, &amp;ctx-&gt;ehdr, sizeof(ctx-&gt;ehdr), 0) != sizeof(ctx-&gt;ehdr)) return EL_EIO;\n</code></pre> <p>Section Header Table\u53ef\u4ee5\u8ba4\u4e3a\u662f\u4e00\u4e2a\u7ebf\u6027\u7ed3\u6784\uff0c\u4e5f\u5c31\u662f\u8bf4\u5bf9\u4e8e\u6bcf\u4e00\u4e2aSection Header\uff0c\u5730\u5740\u7684\u5bfb\u627e\u662f\u7ebf\u6027\u7684\uff0c\u6362\u53e5\u8bdd\u8bf4\uff0c\u6bcf\u4e2aSection Header\u90fd\u662f\u90fd\u662f\u7d27\u5bc6\u76f8\u8fde\u7684\u3002</p> <p>\u4e0b\u4e00\u6b65\u540c\u5b66\u4eec\u9700\u8981\u5728\u7f51\u4e0a\u627e\u5230Section Header\u7684\u7ed3\u6784\uff0c\u540c\u5b66\u4eec\u5982\u679c\u6709\u67e5\u8be2\uff0c\u4f60\u4f1a\u53d1\u73b0\u5176\u4e2d\u7684<code>name</code>\u662f\u4e00\u4e2a<code>uint32</code>\u7c7b\u578b\u7684\u53d8\u91cf\uff0c\u800c\u5e76\u4e0d\u662f\u4e00\u4e2a<code>char*</code>\u7c7b\u578b\u7684\u53d8\u91cf\u3002\u8fd9\u662f\u56e0\u4e3a<code>name</code>\u672c\u8d28\u4e0a\u6765\u8bf4\u662f\u76f8\u5bf9\u4e8e\u67d0\u4e00\u4e2a\u5730\u5740\u7684\u504f\u79fb\uff0c\u67e5\u8be2\u4e00\u4e0bString Table\u7684\u7ed3\u6784\uff0c\u8bfb\u53d6String Table\u7684\u5185\u5bb9\uff0c\u4f60\u5c31\u4f1a\u627e\u5230\u7b54\u6848\u3002</p> <p>\u901a\u8fc7String Table\u53ef\u4ee5\u8bfb\u53d6\u51fa\u6bcf\u4e2aSection Header\u5bf9\u5e94\u7684Section\u7684\u540d\u5b57\uff0c\u901a\u8fc7C\u8bed\u8a00\u7684\u5b57\u7b26\u4e32\u6bd4\u8f83\u51fd\u6570\uff0c\u53ef\u4ee5\u8bfb\u53d6\u6211\u4eec\u60f3\u8981\u7684Section\u7684\u5185\u5bb9\u3002</p> <p>\u5bf9\u4e8e<code>.symtab</code>\u548c<code>.strtab</code>\uff0c\u5927\u5bb6\u9700\u8981\u67e5\u8be2<code>.symtab</code>\u8868\u4e2d\u6bcf\u4e00\u4e2asymbols\u7684\u7ed3\u6784\u5b9a\u4e49\uff0c\u4f60\u7a81\u7136\u53d1\u73b0\u5176\u4e2d\u7684<code>name</code>\u7adf\u7136\u53c8\u662f\u4e00\u4e2a<code>uint32</code>\u7c7b\u578b\u7684\u53d8\u91cf\uff0c\u4f46\u662f\u7ecf\u5386\u4e86\u90a3\u4e48\u591a\u7684\u4f60\u4e00\u5b9a\u660e\u767d<code>name</code>\u7684\u542b\u4e49\uff0c\u8bd5\u8bd5\u770b\u5982\u4f55\u7ed3\u5408<code>.strtab</code>\u627e\u5230\u8fd9\u4e2a\u7b26\u53f7\u5bf9\u5e94\u7684\u540d\u5b57\u3002</p> <p>\u8bfb\u53d6\u51fa<code>.symtab</code>\u548c<code>.strtab</code>\u7684\u4fe1\u606f\u4e4b\u540e\u5c31\u53ef\u4ee5\u5f00\u59cb\u6253\u5370\u4e86\uff0c\u5728\u8fdb\u5165\u4e2d\u65ad\u4e4b\u524d\u5176\u5b9e\u6240\u6709\u7684\u4fe1\u606f\u5df2\u7ecf\u8fdb\u5165\u5230\u4e86trapframe\u91cc\u9762\uff0c\u6240\u4ee5\u8bf4\u53ef\u4ee5\u8bfb\u53d6trapframe\u91cc\u9762\u7684\u4fe1\u606f\u8bfb\u53d6\u67d0\u4e2a\u5bc4\u5b58\u5668\u5728\u8fdb\u5165S\u6001\u4e4b\u524d\u7684\u503c\u3002</p> <p>\u7406\u8bba\u4e0a\uff0c\u5927\u5bb6\u8fd8\u9700\u8981\u4e86\u89e3\u4e00\u4e2a\u51fd\u6570\u7684\u4f7f\u7528\u65b9\u6cd5\u3002</p> <pre><code>uint64 elf_fpread(elf_ctx *ctx, void *dest, uint64 nb, uint64 offset)\n</code></pre> <p>\u8fd9\u4e2a\u51fd\u6570\u4eceoffset\u8fd9\u4e2a\u5730\u5740\u4e2d\u53d6\u51fanb\u5b57\u8282\u7684\u6570\u636e\u653e\u5165\u5230dest\u5bf9\u5e94\u7684\u5730\u5740\u4e2d\u3002</p> <p>\u6ce8\u610f\uff1a\u5b8c\u6210\u5b9e\u9a8c\u5185\u5bb9\u540e\uff0c\u8bf7\u8bfb\u8005\u53e6\u5916\u7f16\u5199\u5e94\u7528\uff0c\u901a\u8fc7\u8c03\u7528print_backtrace()\u51fd\u6570\uff0c\u5e76\u5e26\u5165\u4e0d\u540c\u7684\u6df1\u5ea6\u53c2\u6570\uff0c\u5bf9\u81ea\u5df1\u7684\u5b9e\u73b0\u8fdb\u884c\u68c0\u6d4b\u3002</p> <p>\u53e6\u5916\uff0c\u540e\u7eed\u7684\u57fa\u7840\u5b9e\u9a8c\u4ee3\u7801\u5e76\u4e0d\u4f9d\u8d56\u6311\u6218\u5b9e\u9a8c\uff0c\u6240\u4ee5\u8bfb\u8005\u53ef\u81ea\u884c\u51b3\u5b9a\u662f\u5426\u5c06\u81ea\u5df1\u7684\u5de5\u4f5c\u63d0\u4ea4\u5230\u672c\u5730\u4ee3\u7801\u4ed3\u5e93\u4e2d\uff08\u5f53\u7136\uff0c\u63d0\u4ea4\u5230\u672c\u5730\u4ed3\u5e93\u662f\u4e2a\u597d\u4e60\u60ef\uff0c\u81f3\u5c11\u80fd\u4fdd\u5b58\u81ea\u5df1\u7684\u201c\u4f5c\u54c1\u201d\uff09\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter3_traps/#36-lab1_challenge2","title":"3.6 lab1_challenge2 \u6253\u5370\u5f02\u5e38\u4ee3\u7801\u884c\uff08\u96be\u5ea6\uff1a\u2605\u2605\u2605\u2606\u2606\uff09","text":""},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter3_traps/#_14","title":"\u7ed9\u5b9a\u5e94\u7528","text":"<ul> <li>user/app_errorline.c\uff08\u548clab1_2\u7684\u5e94\u7528\u4e00\u81f4\uff09</li> </ul> <pre><code>  1 /*                                                                             \n  2  * Below is the given application for lab1_challenge2 (same as lab1_2).\n  3  * This app attempts to issue M-mode instruction in U-mode, and consequently raises an exception.\n  4  */\n5 6 #include \"user_lib.h\"\n7 #include \"util/types.h\"\n8 9 int main(void) {\n10   printu(\"Going to hack the system by running privilege instructions.\\n\");\n11   // we are now in U(user)-mode, but the \"csrw\" instruction requires M-mode privilege.\n12   // Attempting to execute such instruction will raise illegal instruction exception.\n13   asm volatile(\"csrw sscratch, 0\");\n14   exit(0);\n15 }\n16 </code></pre> <p>\u4ee5\u4e0a\u7a0b\u5e8f\u8bd5\u56fe\u5728\u7528\u6237\u6001\u8bfb\u53d6\u5728\u5185\u6838\u6001\u624d\u80fd\u8bfb\u53d6\u7684\u5bc4\u5b58\u5668sscratch\uff0c\u56e0\u6b64\u6b64\u5904\u4f1a\u89e6\u53d1illegal instruction\u5f02\u5e38\uff0c\u4f60\u7684\u4efb\u52a1\u662f\u4fee\u6539\u5185\u6838\uff08\u5305\u62ecmachine\u6587\u4ef6\u5939\u4e0b\uff09\u7684\u4ee3\u7801\uff0c\u4f7f\u5f97\u7528\u6237\u7a0b\u5e8f\u5728\u53d1\u751f\u5f02\u5e38\u65f6\uff0c\u5185\u6838\u80fd\u591f\u8f93\u51fa\u89e6\u53d1\u5f02\u5e38\u7684\u7528\u6237\u7a0b\u5e8f\u7684\u6e90\u6587\u4ef6\u540d\u548c\u5bf9\u5e94\u4ee3\u7801\u884c\uff0c\u5982\u4e0a\u9762\u7684\u5e94\u7528\u9884\u671f\u8f93\u51fa\u5982\u4e0b\uff1a</p> <pre><code>In m_start, hartid:0\nHTIF is available!\n(Emulated) memory size: 2048 MB\nEnter supervisor mode...\nApplication: obj/app_errorline\nApplication program entry point (virtual address): 0x0000000081000000\nSwitch to user mode...\nGoing to hack the system by running privilege instructions.\nRuntime error at user/app_errorline.c:13\n  asm volatile(\"csrw sscratch, 0\");\nIllegal instruction!\nSystem is shutting down with exit code -1.\n</code></pre> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter3_traps/#_15","title":"\u5b9e\u9a8c\u5185\u5bb9","text":"<p>\u672c\u5b9e\u9a8c\u4e3a\u6311\u6218\u5b9e\u9a8c\uff0c\u57fa\u7840\u4ee3\u7801\u5c06\u7ee7\u627f\u548c\u4f7f\u7528lab1_3\u5b8c\u6210\u540e\u7684\u4ee3\u7801\uff1a</p> <ul> <li>\uff08\u5148\u63d0\u4ea4lab1_3\u7684\u7b54\u6848\uff0c\u7136\u540e\uff09\u5207\u6362\u5230lab1_challenge2_errorline\u3001\u7ee7\u627flab1_3\uff08\u6ce8\u610f\uff0c\u4e0d\u662f\u7ee7\u627flab1_challenge1_backtrace\uff01PKE\u7684\u6311\u6218\u5b9e\u9a8c\u4e4b\u95f4\u65e0\u7ee7\u627f\u5173\u8054\uff09\u4e2d\u6240\u505a\u4fee\u6539\uff1a</li> </ul> <pre><code>//\u5207\u6362\u5230lab1_challenge2_errorline\n$ git checkout lab1_challenge2_errorline\n\n//\u7ee7\u627flab1_3\u4ee5\u53ca\u4e4b\u524d\u7684\u7b54\u6848\n$ git merge lab1_3_irq -m \"continue to work on lab1_challenge1\"\n</code></pre> <p>\u6ce8\u610f\uff1a\u4e0d\u540c\u4e8e\u57fa\u7840\u5b9e\u9a8c\uff0c\u6311\u6218\u5b9e\u9a8c\u7684\u57fa\u7840\u4ee3\u7801\u5177\u6709\u66f4\u5927\u7684\u4e0d\u5b8c\u6574\u6027\uff0c\u53ef\u80fd\u65e0\u6cd5\u76f4\u63a5\u901a\u8fc7\u6784\u9020\u8fc7\u7a0b\u3002\u540c\u6837\uff0c\u4e0d\u540c\u4e8e\u57fa\u7840\u5b9e\u9a8c\uff0c\u6211\u4eec\u5728\u4ee3\u7801\u4e2d\u4e5f\u5e76\u672a\u4e13\u95e8\u5730\u54ea\u4e9b\u5730\u65b9\u7684\u4ee3\u7801\u9700\u8981\u586b\u5199\uff0c\u54ea\u4e9b\u5730\u65b9\u7684\u4ee3\u7801\u65e0\u987b\u586b\u5199\u3002\u8fd9\u6837\uff0c\u6211\u4eec\u7559\u7ed9\u8bfb\u8005\u66f4\u5927\u7684\u201c\u60f3\u8c61\u7a7a\u95f4\u201d\u3002</p> <ul> <li>\u672c\u5b9e\u9a8c\u7684\u5177\u4f53\u8981\u6c42\u4e3a\uff1a\u901a\u8fc7\u4fee\u6539PKE\u5185\u6838\uff08\u5305\u62ecmachine\u6587\u4ef6\u5939\u4e0b\u7684\u4ee3\u7801\uff09\uff0c\u4f7f\u5f97\u7528\u6237\u7a0b\u5e8f\u5728\u53d1\u751f\u5f02\u5e38\u65f6\uff0c\u5185\u6838\u80fd\u591f\u8f93\u51fa\u89e6\u53d1\u5f02\u5e38\u7684\u7528\u6237\u7a0b\u5e8f\u7684\u6e90\u6587\u4ef6\u540d\u548c\u5bf9\u5e94\u4ee3\u7801\u884c\u3002</li> <li>\u6ce8\u610f\uff1a\u867d\u7136\u5728\u793a\u4f8b\u7684app_errorline.c\u4e2d\u53ea\u89e6\u53d1\u4e86\u975e\u6cd5\u6307\u4ee4\u5f02\u5e38\uff0c\u4f46\u6700\u7ec8\u6d4b\u8bd5\u65f6\u4f60\u7684\u5185\u6838\u4e5f\u5e94\u80fd\u591f\u5bf9\u5176\u4ed6\u4f1a\u5bfc\u81f4panic\u7684\u5f02\u5e38\u548c\u5176\u4ed6\u6e90\u6587\u4ef6\u8f93\u51fa\u6b63\u786e\u7684\u7ed3\u679c\u3002</li> <li>\u6587\u4ef6\u540d\u89c4\u8303\uff1a\u9700\u8981\u5305\u542b\u8def\u5f84\uff0c\u5982\u679c\u662f\u7528\u6237\u6e90\u7a0b\u5e8f\u53d1\u751f\u7684\u9519\u8bef\uff0c\u8def\u5f84\u4e3a\u76f8\u5bf9\u8def\u5f84\uff0c\u5982\u679c\u662f\u8c03\u7528\u7684\u6807\u51c6\u5e93\u5185\u53d1\u751f\u7684\u9519\u8bef\uff0c\u8def\u5f84\u4e3a\u7edd\u5bf9\u8def\u5f84\u3002</li> <li>\u4e3a\u4e86\u964d\u4f4e\u6311\u6218\u7684\u96be\u5ea6\uff0c\u672c\u5b9e\u9a8c\u5728elf.c\u4e2d\u7ed9\u51fa\u4e86debug_line\u6bb5\u7684\u89e3\u6790\u51fd\u6570make_addr_line\u3002\u8fd9\u4e2a\u51fd\u6570\u63a5\u53d7\u4e09\u4e2a\u53c2\u6570\uff0cctx\u4e3aelf\u6587\u4ef6\u7684\u4e0a\u4e0b\u6587\u6307\u9488\uff0c\u8fd9\u4e2a\u53ef\u4ee5\u53c2\u8003\u6587\u4ef6\u4e2d\u7684\u5176\u4ed6\u51fd\u6570\uff1bdebug_line\u4e3a\u6307\u5411.debug_line\u6bb5\u6570\u636e\u7684\u6307\u9488\uff0c\u4f60\u9700\u8981\u8bfb\u53d6elf\u6587\u4ef6\u4e2d\u540d\u4e3a.debug_line\u7684\u6bb5\u4fdd\u5b58\u5230\u7f13\u51b2\u533a\u4e2d\uff0c\u7136\u540e\u5c06\u7f13\u51b2\u533a\u6307\u9488\u4f20\u5165\u8fd9\u4e2a\u53c2\u6570\uff1blength\u4e3a.debug_line\u6bb5\u6570\u636e\u7684\u957f\u5ea6\u3002</li> <li>\u51fd\u6570\u8c03\u7528\u7ed3\u675f\u540e\uff0cprocess\u7ed3\u6784\u4f53\u7684dir\u3001file\u3001line\u4e09\u4e2a\u6307\u9488\u4f1a\u5404\u6307\u5411\u4e00\u4e2a\u6570\u7ec4\uff0cdir\u6570\u7ec4\u5b58\u50a8\u6240\u6709\u4ee3\u7801\u6587\u4ef6\u7684\u6587\u4ef6\u5939\u8def\u5f84\u5b57\u7b26\u4e32\u6307\u9488\uff0c\u5982/home/abc/bcd\u7684\u6587\u4ef6\u5939\u8def\u5f84\u4e3a/home/abc\uff0c\u672c\u9879\u76eeuser\u6587\u4ef6\u5939\u4e0b\u7684app_errorline.c\u6587\u4ef6\u5939\u8def\u5f84\u4e3auser\uff1bfile\u6570\u7ec4\u5b58\u50a8\u6240\u6709\u4ee3\u7801\u6587\u4ef6\u7684\u6587\u4ef6\u540d\u5b57\u7b26\u4e32\u6307\u9488\u4ee5\u53ca\u5176\u6587\u4ef6\u5939\u8def\u5f84\u5728dir\u6570\u7ec4\u4e2d\u7684\u7d22\u5f15\uff1bline\u6570\u7ec4\u5b58\u50a8\u6240\u6709\u6307\u4ee4\u5730\u5740\uff0c\u4ee3\u7801\u884c\u53f7\uff0c\u6587\u4ef6\u540d\u5728file\u6570\u7ec4\u4e2d\u7684\u7d22\u5f15\u4e09\u8005\u7684\u6620\u5c04\u5173\u7cfb\u3002\u5982\u67d0\u6587\u4ef6\u7b2c3\u884c\u4e3aa = 0\uff0c\u88ab\u7f16\u8bd1\u6210\u5730\u5740\u4e3a0x1234\u5904\u7684\u6c47\u7f16\u4ee3\u7801li ax, 0\u548c0x1238\u5904\u7684\u6c47\u7f16\u4ee3\u7801sd 0(s0), ax\u3002\u90a3\u4e48file\u6570\u7ec4\u4e2d\u5c31\u5305\u542b\u4e24\u9879\uff0caddr\u5c5e\u6027\u5206\u522b\u4e3a0x1234\u548c0x1238\uff0cline\u5c5e\u6027\u4e3a3\uff0cfile\u5c5e\u6027\u4e3a\u201c\u67d0\u6587\u4ef6\u201d\u7684\u6587\u4ef6\u540d\u5728file\u6570\u7ec4\u4e2d\u7684\u7d22\u5f15\u3002</li> <li>\u6ce8\u610f\uff1adir\u3001file\u3001line\u4e09\u4e2a\u6570\u7ec4\u4f1a\u4f9d\u6b21\u5b58\u50a8\u5728debug_line\u6570\u636e\u7f13\u51b2\u533a\u4e4b\u540e\uff0cdir\u6570\u7ec4\u548cfile\u6570\u7ec4\u7684\u5927\u5c0f\u4e3a64\u3002\u6240\u4ee5\u5982\u679c\u4f60\u7528\u9759\u6001\u6570\u7ec4\u6765\u5b58\u50a8debug_line\u6bb5\u6570\u636e\uff0c\u90a3\u4e48\u8fd9\u4e2a\u6570\u7ec4\u5fc5\u987b\u8db3\u591f\u5927\uff1b\u6216\u8005\u4f60\u4e5f\u53ef\u4ee5\u628adebug_line\u76f4\u63a5\u653e\u5728\u7a0b\u5e8f\u6240\u6709\u9700\u6620\u5c04\u7684\u6bb5\u6570\u636e\u4e4b\u540e\uff0c\u8fd9\u6837\u53ef\u4ee5\u4fdd\u8bc1\u6709\u8db3\u591f\u5927\u7684\u52a8\u6001\u7a7a\u95f4\u3002</li> </ul> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter3_traps/#_16","title":"\u5b9e\u9a8c\u6307\u5bfc","text":"<ul> <li>\u4e3a\u5b8c\u6210\u8be5\u6311\u6218\uff0c\u9700\u8981\u5229\u7528\u7528\u6237\u7a0b\u5e8f\u7f16\u8bd1\u65f6\u4ea7\u751f\u7684\u8c03\u8bd5\u4fe1\u606f\uff0c\u76ee\u524d\u6700\u5e7f\u6cdb\u4f7f\u7528\u7684\u8c03\u8bd5\u4fe1\u606f\u683c\u5f0f\u662fDWARF\uff0c\u53ef\u4ee5\u53c2\u8003\u8fd9\u91cc\u4e86\u89e3\u5176\u683c\u5f0f\uff0c\u8be5\u7f51\u7ad9\u7684\u53c2\u8003\u6587\u732e\u4e2d\u4e5f\u7ed9\u51fa\u4e86DWARF\u7684\u5b8c\u6574\u6587\u6863\u5730\u5740\uff0c\u5fc5\u8981\u65f6\u53ef\u53c2\u8003\u3002</li> <li>\u4f60\u5bf9\u5185\u6838\u4ee3\u7801\u7684\u4fee\u6539\u53ef\u80fd\u5305\u542b\u4ee5\u4e0b\u5185\u5bb9\uff1a</li> <li>\u4fee\u6539\u8bfb\u53d6elf\u6587\u4ef6\u7684\u4ee3\u7801\uff0c\u627e\u5230\u5305\u542b\u8c03\u8bd5\u4fe1\u606f\u7684\u6bb5\uff0c\u5c06\u5176\u5185\u5bb9\u4fdd\u5b58\u8d77\u6765\uff08\u53ef\u4ee5\u4fdd\u5b58\u5728\u7528\u6237\u7a0b\u5e8f\u7684\u5730\u5740\u7a7a\u95f4\u4e2d\uff09</li> <li>\u5728\u9002\u5f53\u7684\u4f4d\u7f6e\u8c03\u7528debug_line\u6bb5\u89e3\u6790\u51fd\u6570\uff0c\u5bf9\u8c03\u8bd5\u4fe1\u606f\u8fdb\u884c\u89e3\u6790\uff0c\u6784\u9020\u6307\u4ee4\u5730\u5740-\u6e90\u4ee3\u7801\u884c\u53f7-\u6e90\u4ee3\u7801\u6587\u4ef6\u540d\u7684\u5bf9\u5e94\u8868\uff0c\u6ce8\u610f\uff0c\u8fde\u7eed\u884c\u53f7\u5bf9\u5e94\u7684\u4e0d\u4e00\u5b9a\u662f\u8fde\u7eed\u7684\u5730\u5740\uff0c\u56e0\u4e3a\u4e00\u6761\u6e90\u4ee3\u7801\u53ef\u4ee5\u5bf9\u5e94\u591a\u6761\u6307\u4ee4\u3002</li> <li>\u5728\u5f02\u5e38\u4e2d\u65ad\u5904\u7406\u51fd\u6570\u4e2d\uff0c\u901a\u8fc7\u76f8\u5e94\u5bc4\u5b58\u5668\u627e\u5230\u89e6\u53d1\u5f02\u5e38\u7684\u6307\u4ee4\u5730\u5740\uff0c\u7136\u540e\u5728\u4e0a\u8ff0\u8868\u4e2d\u67e5\u627e\u5730\u5740\u5bf9\u5e94\u7684\u6e90\u4ee3\u7801\u884c\u53f7\u548c\u6587\u4ef6\u540d\u8f93\u51fa</li> </ul> <p>\u53e6\u5916\uff0c\u540e\u7eed\u7684\u57fa\u7840\u5b9e\u9a8c\u4ee3\u7801\u5e76\u4e0d\u4f9d\u8d56\u6311\u6218\u5b9e\u9a8c\uff0c\u6240\u4ee5\u8bfb\u8005\u53ef\u81ea\u884c\u51b3\u5b9a\u662f\u5426\u5c06\u81ea\u5df1\u7684\u5de5\u4f5c\u63d0\u4ea4\u5230\u672c\u5730\u4ee3\u7801\u4ed3\u5e93\u4e2d\uff08\u5f53\u7136\uff0c\u63d0\u4ea4\u5230\u672c\u5730\u4ed3\u5e93\u662f\u4e2a\u597d\u4e60\u60ef\uff0c\u81f3\u5c11\u80fd\u4fdd\u5b58\u81ea\u5df1\u7684\u201c\u4f5c\u54c1\u201d\uff09\u3002</p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter4_memory/","title":"Chapter4 memory","text":""},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter4_memory/#2","title":"\u7b2c\u56db\u7ae0\uff0e\u5b9e\u9a8c2\uff1a\u5185\u5b58\u7ba1\u7406","text":""},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter4_memory/#_1","title":"\u76ee\u5f55","text":"<ul> <li>4.1 \u5b9e\u9a8c2\u7684\u57fa\u7840\u77e5\u8bc6 </li> <li>4.1.1 Sv39\u865a\u5730\u5740\u7ba1\u7406\u65b9\u6848\u56de\u987e</li> <li>4.1.2 \u7269\u7406\u5185\u5b58\u5e03\u5c40\u4e0e\u89c4\u5212</li> <li>4.1.3 PKE\u64cd\u4f5c\u7cfb\u7edf\u548c\u5e94\u7528\u8fdb\u7a0b\u7684\u903b\u8f91\u5730\u5740\u7a7a\u95f4\u7ed3\u6784</li> <li>4.1.4 \u4e0e\u9875\u8868\u64cd\u4f5c\u76f8\u5173\u7684\u91cd\u8981\u51fd\u6570</li> <li>4.2 lab2_1 \u865a\u5b9e\u5730\u5740\u8f6c\u6362</li> <li>\u7ed9\u5b9a\u5e94\u7528</li> <li>\u5b9e\u9a8c\u5185\u5bb9</li> <li>\u5b9e\u9a8c\u6307\u5bfc</li> <li>4.3 lab2_2 \u7b80\u5355\u5185\u5b58\u5206\u914d\u548c\u56de\u6536 </li> <li>\u7ed9\u5b9a\u5e94\u7528</li> <li>\u5b9e\u9a8c\u5185\u5bb9</li> <li>\u5b9e\u9a8c\u6307\u5bfc</li> <li>4.4 lab2_3 \u7f3a\u9875\u5f02\u5e38 </li> <li>\u7ed9\u5b9a\u5e94\u7528</li> <li>\u5b9e\u9a8c\u5185\u5bb9</li> <li>\u5b9e\u9a8c\u6307\u5bfc</li> <li>4.5 lab2_challenge1 \u590d\u6742\u7f3a\u9875\u5f02\u5e38\uff08\u96be\u5ea6\uff1a\u2605\u2606\u2606\u2606\u2606\uff09</li> <li>\u7ed9\u5b9a\u5e94\u7528</li> <li>\u5b9e\u9a8c\u5185\u5bb9</li> <li> <p>\u5b9e\u9a8c\u6307\u5bfc</p> </li> <li> <p>4.6 lab2_challenge2 \u5806\u7a7a\u95f4\u7ba1\u7406\uff08\u96be\u5ea6\uff1a\u2605\u2605\u2605\u2605\u2606\uff09</p> </li> <li>\u7ed9\u5b9a\u5e94\u7528</li> <li>\u5b9e\u9a8c\u5185\u5bb9</li> <li>\u5b9e\u9a8c\u6307\u5bfc</li> </ul> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter4_memory/#41-2","title":"4.1 \u5b9e\u9a8c2\u7684\u57fa\u7840\u77e5\u8bc6","text":"<p>\u5728\u8fc7\u53bb\u7684\u7b2c\u4e00\u7ec4\u5b9e\u9a8c(lab1)\u4e2d\uff0c\u4e3a\u4e86\u7b80\u5316\u8bbe\u8ba1\uff0c\u6211\u4eec\u91c7\u7528\u4e86Bare\u6a21\u5f0f\u6765\u5b8c\u6210\u865a\u62df\u5730\u5740\u5230\u7269\u7406\u5730\u5740\u7684\u8f6c\u6362\uff08\u5b9e\u9645\u4e0a\uff0c\u5c31\u662f\u4e0d\u8f6c\u6362\uff0c\u8ba4\u4e3a\uff1a\u865a\u62df\u5730\u5740=\u7269\u7406\u5730\u5740\uff09\uff0c\u4e5f\u672a\u5f00\u542f\uff08\u6a21\u62df\uff09RISC-V\u673a\u5668\u7684\u5206\u9875\u529f\u80fd\u3002\u5728\u672c\u7ec4\u5b9e\u9a8c\uff08\u5b9e\u9a8c2\uff09\u4e2d\uff0c\u6211\u4eec\u5c06\u5f00\u542f\u548c\u4f7f\u7528Sv39\u9875\u5f0f\u865a\u62df\u5185\u5b58\u7ba1\u7406\uff0c\u65e0\u8bba\u662f\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u8fd8\u662f\u5e94\u7528\uff0c\u90fd\u901a\u8fc7\u9875\u8868\u6765\u5b9e\u73b0\u903b\u8f91\u5730\u5740\u5230\u7269\u7406\u5730\u5740\u7684\u8f6c\u6362\u3002</p> <p>\u5b9e\u9645\u4e0a\uff0c\u6211\u4eec\u5728\u672c\u4e66\u7684\u7b2c\u4e00\u7ae0\u76841.5\u8282\u66fe\u4ecb\u7ecd\u8fc7RISC-V\u7684Sv39\u9875\u5f0f\u865a\u62df\u5185\u5b58\u7684\u7ba1\u7406\u65b9\u5f0f\uff0c\u5728\u672c\u7ae0\uff0c\u6211\u4eec\u5c06\u5c3d\u91cf\u7ed3\u5408PKE\u7684\u5b9e\u9a8c\u4ee3\u7801\u8bb2\u89e3RISC-V\u7684Sv39\u865a\u62df\u5185\u5b58\u7ba1\u7406\u673a\u5236\uff0c\u5e76\u901a\u8fc73\u4e2a\u57fa\u7840\u5b9e\u9a8c\u52a0\u6df1\u8bfb\u8005\u5bf9\u8be5\u7ba1\u7406\u673a\u5236\u7684\u7406\u89e3\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter4_memory/#411-sv39","title":"4.1.1 Sv39\u865a\u5730\u5740\u7ba1\u7406\u65b9\u6848\u56de\u987e","text":"<p>\u6211\u4eec\u5148\u56de\u987e\u4e00\u4e0bRISC-V\u7684sv39\u865a\u5730\u5740\u7ba1\u7406\u65b9\u6848\uff0c\u5728\u8be5\u65b9\u6848\u4e2d\uff0c\u903b\u8f91\u5730\u5740\uff08\u5c31\u662f\u6211\u4eec\u7684\u7a0b\u5e8f\u4e2d\u5404\u4e2a\u7b26\u53f7\uff0c\u5728\u94fe\u63a5\u65f6\u88ab\u8d4b\u4e88\u7684\u5730\u5740\uff09\u901a\u8fc7\u9875\u8868\u8f6c\u6362\u4e3a\u5176\u5bf9\u5e94\u7684\u7269\u7406\u5730\u5740\u3002\u7531\u4e8e\u6211\u4eec\u8003\u8651\u7684\u673a\u5668\u91c7\u7528\u4e86RV64G\u6307\u4ee4\u96c6\uff0c\u610f\u5473\u7740\u903b\u8f91\u5730\u5740\u548c\u7269\u7406\u5730\u5740\u7406\u8bba\u4e0a\u90fd\u662f64\u4f4d\u7684\u3002\u7136\u800c\uff0c\u5bf9\u4e8e\u903b\u8f91\u5730\u5740\uff0c\u5b9e\u9645\u4e0a\u6211\u4eec\u7684\u5e94\u7528\u89c4\u6a21\u8fd8\u7528\u4e0d\u5230\u5168\u90e864\u4f4d\u7684\u5bfb\u627e\u7a7a\u95f4\uff0c\u6240\u4ee5Sv39\u65b9\u6848\u4e2d\u53ea\u4f7f\u7528\u4e8664\u4f4d\u865a\u5730\u5740\u4e2d\u7684\u4f4e39\u4f4d\uff08Sv48\u65b9\u6848\u4f7f\u7528\u4e86\u4f4e48\u4f4d\uff09\uff0c\u610f\u5473\u7740\u6211\u4eec\u7684\u5e94\u7528\u7a0b\u5e8f\u7684\u5730\u5740\u7a7a\u95f4\u53ef\u4ee5\u5230512GB\uff1b\u5bf9\u4e8e\u7269\u7406\u5730\u5740\uff0c\u76ee\u524d\u7684RISC-V\u8bbe\u8ba1\u53ea\u7528\u5230\u4e86\u5176\u4e2d\u7684\u4f4e56\u4f4d\u3002</p> <p>Sv39\u5c0639\u4f4d\u865a\u62df\u5730\u5740\u201c\u5212\u5206\u201d\u4e3a4\u4e2a\u6bb5\uff08\u5982\u4e0b\u56fe\u6240\u793a\uff09\uff1a</p> <ul> <li>[38,30]\uff1a\u51719\u4f4d\uff0c\u56fe\u4e2d\u7684VPN[2]\uff0c\u7528\u4e8e\u5728512\uff082^9\uff09\u4e2a\u9875\u76ee\u5f55\uff08page directory\uff09\u9879\u4e2d\u68c0\u7d22\u9875\u76ee\u5f55\u9879\uff08page directory entry, PDE\uff09\uff1b</li> <li>[29,21]\uff1a\u51719\u4f4d\uff0c\u56fe\u4e2d\u7684VPN[1]\uff0c\u7528\u4e8e\u5728512\uff082^9\uff09\u4e2a\u9875\u4e2d\u95f4\u76ee\u5f55\uff08page medium directory\uff09\u4e2d\u68c0\u7d22PDE\uff1b</li> <li>[20,12]\uff1a\u51719\u4f4d\uff0c\u56fe\u4e2d\u7684VPN[0]\uff0c\u7528\u4e8e\u5728512\uff082^9\uff09\u4e2a\u9875\u8868\uff08page medium directory\uff09\u4e2d\u68c0\u7d22PTE\uff1b</li> <li>[11,0]\uff1a\u517112\u4f4d\uff0c\u56fe\u4e2d\u7684offset\uff0c\u5145\u5f534KB\u9875\u7684\u9875\u5185\u4f4d\u79fb\u3002</li> </ul> <p></p> <p>\u56fe4.1 Sv39\u4e2d\u865a\u62df\u5730\u5740\u5230\u7269\u7406\u5730\u5740\u7684\u8f6c\u6362\u8fc7\u7a0b</p> <p>\u7531\u4e8e\u6bcf\u4e2a\u7269\u7406\u9875\u7684\u5927\u5c0f\u4e3a4KB\uff0c\u540c\u65f6\uff0c\u6bcf\u4e2a\u76ee\u5f55\u9879\uff08PDE\uff09\u6216\u9875\u8868\u9879\uff08PTE\uff09\u5360\u636e8\u4e2a\u5b57\u8282\uff0c\u6240\u4ee5\u4e00\u4e2a\u7269\u7406\u9875\u80fd\u591f\u5bb9\u7eb3\u7684PDE\u6216PTE\u7684\u6570\u91cf\u4e3a4KB/8B=512\uff0c\u8fd9\u4e5f\u662f\u4e3a\u4ec0\u4e48VPN[2]=VPN[1]=VPN[0]=512\u7684\u539f\u56e0\u3002</p> <p>8\u5b57\u8282\u7684PDE\u6216\u8005PTE\u7684\u683c\u5f0f\u5982\u4e0b\uff1a</p> <p></p> <p>\u56fe4.2 Sv39\u4e2dPDE/PTE\u683c\u5f0f</p> <p>\u5176\u4e2d\u7684\u5404\u4e2a\u4f4d\u7684\u542b\u610f\u4e3a\uff1a</p> <p>\u25cf V\uff08Valid\uff09\u4f4d\u51b3\u5b9a\u4e86\u8be5PDE/PTE\u662f\u5426\u6709\u6548\uff08V=1\u65f6\u6709\u6548\uff09\uff0c\u5373\u662f\u5426\u6709\u5bf9\u5e94\u7684\u5b9e\u9875\u3002</p> <p>\u25cf R\uff08Read\uff09\u3001W\uff08Write\uff09\u548cX\uff08eXecutable\uff09\u4f4d\u5206\u522b\u8868\u793a\u6b64\u9875\u5bf9\u5e94\u7684\u5b9e\u9875\u662f\u5426\u53ef\u8bfb\u3001\u53ef\u5199\u548c\u53ef\u6267\u884c\u3002\u8fd93\u4e2a\u4f4d\u53ea\u5bf9PTE\u6709\u610f\u4e49\uff0c\u5bf9\u4e8ePDE\u800c\u8a00\u8fd93\u4e2a\u4f4d\u90fd\u4e3a0\u3002</p> <p>\u25cf U\uff08User\uff09\u4f4d\u8868\u793a\u8be5\u9875\u662f\u4e0d\u662f\u4e00\u4e2a\u7528\u6237\u6a21\u5f0f\u9875\u3002\u5982\u679cU=1\uff0c\u8868\u793a\u7528\u6237\u6a21\u5f0f\u4e0b\u7684\u4ee3\u7801\u53ef\u4ee5\u8bbf\u95ee\u8be5\u9875\uff0c\u5426\u5219\u5c31\u8868\u793a\u4e0d\u80fd\u8bbf\u95ee\u3002S\u6a21\u5f0f\u4e0b\u7684\u4ee3\u7801\u5bf9U=1\u9875\u9762\u7684\u8bbf\u95ee\u53d6\u51b3\u4e8esstatus\u5bc4\u5b58\u5668\u4e2d\u7684SUM\u5b57\u6bb5\u53d6\u503c\u3002</p> <p>\u25cf G\uff08Global\uff09\u4f4d\u8868\u793a\u8be5PDE/PTE\u662f\u4e0d\u662f\u5168\u5c40\u7684\u3002\u6211\u4eec\u53ef\u4ee5\u628a\u64cd\u4f5c\u7cfb\u7edf\u4e2d\u8fd0\u884c\u7684\u4e00\u4e2a\u8fdb\u7a0b\uff0c\u8ba4\u4e3a\u662f\u4e00\u4e2a\u72ec\u7acb\u7684\u5730\u5740\u7a7a\u95f4\uff0c\u6709\u65f6\u4f1a\u5e0c\u671b\u67d0\u4e2a\u865a\u5730\u5740\u7a7a\u95f4\u8f6c\u6362\u53ef\u4ee5\u5728\u4e00\u7ec4\u8fdb\u7a0b\u4e2d\u5171\u4eab\uff0c\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u5c31\u53ef\u4ee5\u5c06\u67d0\u4e2aPDE\u7684G\u4f4d\u8bbe\u7f6e\u4e3a1\uff0c\u8fbe\u5230\u8fd9\u79cd\u5171\u4eab\u7684\u6548\u679c\u3002</p> <p>\u25cf A\uff08Access\uff09\u4f4d\u8868\u793a\u8be5\u9875\u662f\u5426\u88ab\u8bbf\u95ee\u8fc7\u3002</p> <p>\u25cf D\uff08Dirty\uff09\u4f4d\u8868\u793a\u8be5\u9875\u7684\u5185\u5bb9\u662f\u5426\u88ab\u4fee\u6539\u3002</p> <p>\u25cf RSW\u4f4d\uff082\u4f4d\uff09\u662f\u4fdd\u7559\u4f4d\uff0c\u4e00\u822c\u7531\u8fd0\u884c\u5728S\u6a21\u5f0f\u7684\u4ee3\u7801\uff08\u5982\u64cd\u4f5c\u7cfb\u7edf\uff09\u6765\u4f7f\u7528\u3002</p> <p>\u25cf PPN\uff0844\u4f4d\uff09\u662f\u7269\u7406\u9875\u53f7\uff08Physical Page Number\uff0c\u7b80\u5199\u4e3aPPN\uff09\u3002</p> <p>\u5176\u4e2dPPN\u4e3a44\u4f4d\u7684\u539f\u56e0\u662f\uff1a\u5bf9\u4e8e\u7269\u7406\u5730\u5740\uff0c\u73b0\u6709\u7684RISC-V\u89c4\u8303\u53ea\u7528\u4e86\u5176\u4e2d\u768456\u4f4d\uff0c\u540c\u65f6\uff0c\u8fd956\u4f4d\u4e2d\u7684\u4f4e12\u4f4d\u4e3a\u9875\u5185\u4f4d\u79fb\u3002\u6240\u4ee5\uff0cPPN\u7684\u957f\u5ea6=56-12=44\uff08\u4f4d\uff09\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter4_memory/#412","title":"4.1.2 \u7269\u7406\u5185\u5b58\u5e03\u5c40\u4e0e\u89c4\u5212","text":"<p>PKE\u5b9e\u9a8c\u7528\u5230\u7684RISC-V\u673a\u5668\uff0c\u5b9e\u9645\u4e0a\u662fspike\u6a21\u62df\u51fa\u6765\u7684\uff0c\u4f8b\u5982\uff0c\u91c7\u7528\u4ee5\u4e0b\u547d\u4ee4\uff1a</p> <pre><code>$ spike ./obj/riscv-pke ./obj/app_helloworld\n</code></pre> <p>spike\u5c06\u521b\u5efa\u4e00\u4e2a\u6a21\u62df\u7684RISC-V\u673a\u5668\uff0c\u8be5\u673a\u5668\u62e5\u6709\u4e00\u4e2a\u652f\u6301RV64G\u6307\u4ee4\u96c6\u7684\u5904\u7406\u5668\uff0c2GB\u7684\uff08\u6a21\u62df\uff09\u7269\u7406\u5185\u5b58\u3002\u5b9e\u9645\u4e0a\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u5728spike\u547d\u4ee4\u884c\u4e2d\u4f7f\u7528<code>-m</code>\u5f00\u5173\u6307\u5b9a\u6a21\u62df\u673a\u5668\u7684\u7269\u7406\u5185\u5b58\u5927\u5c0f\uff0c\u5982\u4f7f\u7528<code>-m512</code>\u5373\u53ef\u83b7\u5f97\u62e5\u6709512MB\u7269\u7406\u5185\u5b58\u7684\u6a21\u62df\u673a\u5668\u3002\u9ed8\u8ba4\u7684\uff082GB\u7269\u7406\u5185\u5b58\uff09\u914d\u7f6e\u7b49\u6548\u4e8e<code>-m2048</code>\uff0c\u5728\u4e4b\u540e\u5bf9\u6a21\u62dfRISC-V\u673a\u5668\u7269\u7406\u5185\u5b58\u5e03\u5c40\u7684\u8ba8\u8bba\u4e2d\uff0c\u6211\u4eec\u5c06\u53ea\u8003\u8651\u9ed8\u8ba4\u914d\u7f6e\u4ee5\u7b80\u5316\u8bba\u8ff0\u3002\u53e6\u5916\uff0c\u4e5f\u53ef\u4ee5\u5728spike\u547d\u4ee4\u884c\u4e2d\u4f7f\u7528<code>-p</code>\u5f00\u5173\u6307\u5b9a\u6a21\u62df\u673a\u5668\u4e2d\u5904\u7406\u5668\u7684\u4e2a\u6570\uff0c\u8fd9\u6837\u5c31\u53ef\u4ee5\u6a21\u62df\u51fa\u4e00\u4e2a\u591a\u6838\u7684RISC-V\u5e73\u53f0\u4e86\u3002</p> <p>\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u5bf9\u4e8e\u6211\u4eec\u7684\u6a21\u62dfRISC-V\u673a\u5668\u800c\u8a00\uff0c2GB\u7684\u7269\u7406\u5185\u5b58\u5e76\u4e0d\u662f\u4ece0\u5730\u5740\u5f00\u59cb\u7f16\u5740\uff0c\u800c\u662f\u4ece0x80000000\uff08\u89c1kernel/memlayout.h\u6587\u4ef6\u4e2d\u7684DRAM_BASE\u5b8f\u5b9a\u4e49\uff09\u5f00\u59cb\u7f16\u5740\u7684\u3002\u8fd9\u6837\u505a\u7684\u7406\u7531\u662f\uff0c\u90e8\u5206\u4f4e\u7269\u7406\u5730\u5740[0x0, 0x80000000]\u5e76\u65e0\u7269\u7406\u5185\u5b58\u4e0e\u4e4b\u5bf9\u5e94\uff0c\u8be5\u7a7a\u95f4\u7559\u4f5c\u4e86MMIO\u7684\u7528\u9014\u3002\u4f8b\u5982\uff0c\u6211\u4eec\u5728lab1_3\u4e2d\u9047\u5230\u7684CLINT\uff08Core Local Interrupter\uff0ctimer\u4e2d\u65ad\u7684\u4ea7\u751f\u5c31\u662f\u901a\u8fc7\u5f80\u8fd9\u4e2a\u5730\u5740\u5199\u6570\u636e\u63a7\u5236\u7684\uff09\uff0c\u89c1kernel/riscv.h\u6587\u4ef6\u4e2d\u7684CLINT\u5b9a\u4e49\uff0c\u7684\u5730\u5740\u662f0x2000000\uff0c\u5c31\u4f4d\u4e8e\u8fd9\u4e00\u7a7a\u95f4\u3002\u4ece0x80000000\u5f00\u59cb\u5bf9\u7269\u7406\u5185\u5b58\u8fdb\u884c\u7f16\u5740\u7684\u597d\u5904\u662f\uff0c\u907f\u514d\u7c7b\u4f3cx86\u5e73\u53f0\u90a3\u6837\u4ea7\u751f\u5185\u5b58\u7a7a\u6d1e\uff08memory hole\uff0c\u5982640KB~1MB\u7684BIOS\u7a7a\u95f4\uff09\uff0c\u4ece\u800c\u5bfc\u81f4\u5185\u5b58\u7684\u6d6a\u8d39\u548c\u7ba1\u7406\u4e0a\u7684\u590d\u6742\u6027\u3002</p> <p>\u6211\u4eec\u7684\u4ee3\u7406\u5185\u6838\uff08\u6784\u9020\u51fa\u6765\u7684./obj/riscv-pke\u6587\u4ef6\uff09\u7684\u903b\u8f91\u5730\u5740\u4e5f\u662f\u4ece0x80000000\u5f00\u59cb\u7684\uff0c\u89c1kernel/kernel.lds\u6587\u4ef6\u4e2d\u7684\u5185\u5bb9\uff0cspike\u5c06\u4ee3\u7406\u5185\u6838\u8f7d\u5165\uff08\u6a21\u62df\uff09\u7269\u7406\u5185\u5b58\u65f6\uff0c\u4e5f\u662f\u5c06\u8be5\u4ee3\u7406\u5185\u6838\u7684\u4ee3\u7801\u6bb5\u3001\u6570\u636e\u6bb5\u8f7d\u5165\u52300x80000000\u5f00\u59cb\u7684\u5185\u5b58\u7a7a\u95f4\uff0c\u5982\u56fe4.3\u6240\u793a\u3002</p> <p></p> <p>\u56fe4.3 \u521d\u59cb\u5185\u5b58\u5e03\u5c40\u548c\u8f7d\u5165\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u540e\u7684\u5185\u5b58\u5e03\u5c40</p> <p>\u8fd9\u6837\uff0c\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u7684\u903b\u8f91\u5730\u5740\u548c\u7269\u7406\u5730\u5740\u5c31\u6709\u4e86\u4e00\u4e00\u5bf9\u5e94\u7684\u5173\u7cfb\uff0c\u8fd9\u4e5f\u662f\u6211\u4eec\u5728lab1\u4e2d\u91c7\u7528\u76f4\u6a21\u5f0f\uff08Bare mode\uff09\u865a\u62df\u5730\u5740\u7ffb\u8bd1\u673a\u5236\u4e5f\u4e0d\u4f1a\u51fa\u9519\u7684\u539f\u56e0\u3002\u8fd9\u91cc\uff0c\u9700\u8981\u89e3\u91ca\u7684\u662f\u5bf9\u5185\u6838\u7684\u673a\u5668\u6a21\u5f0f\u6808\u7684\u5904\u7406\u3002\u901a\u8fc7\u5b9e\u9a8c\u4e00\uff0c\u6211\u4eec\u77e5\u9053\u673a\u5668\u6a21\u5f0f\u6808\u662f\u4e00\u4e2a4KB\u7684\u7a7a\u95f4\uff0c\u5b83\u4f4d\u4e8e\u5185\u6838\u6570\u636e\u6bb5\uff0c\u800c\u4e0d\u662f\u4e13\u95e8\u5206\u914d\u4e00\u4e2a\u989d\u5916\u7684\u9875\u9762\u3002\u8fd9\u6837\uff08\u7b80\u5355\uff09\u5904\u7406\u7684\u539f\u56e0\u662fPKE\u4e0a\u8fd0\u884c\u7684\u5e94\u7528\u5f80\u5f80\u53ea\u6709\u4e00\u4e2a\uff0c\u7b97\u662f\u975e\u5e38\u7b80\u5355\u7684\u591a\u4efb\u52a1\u73af\u5883\uff0c\u4e14\u64cd\u4f5c\u7cfb\u7edf\u5229\u7528\u673a\u5668\u6a21\u5f0f\u6808\u7684\u65f6\u673a\u53ea\u6709\u7279\u6b8a\u7684\u5f02\u5e38\uff08\u5982lab1_2\u4e2d\u7684\u975e\u6cd5\u6307\u4ee4\u5f02\u5e38\uff09\u4ee5\u53ca\u4e00\u4e9b\u5916\u90e8\u4e2d\u65ad\uff08\u5982lab1_3\u4e2d\u7684\u65f6\u949f\u4e2d\u65ad\uff09\u3002</p> <p>\u5982\u56fe4.3(b)\u6240\u793a\uff0c\u5728spike\u5c06\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u88c5\u5165\u7269\u7406\u5185\u5b58\u540e\uff0c\u5269\u4f59\u7684\u5185\u5b58\u7a7a\u95f4\u5e94\u8be5\u662f\u4ece\u5185\u6838\u6570\u636e\u6bb5\u7684\u7ed3\u675f\uff08_end\u7b26\u53f7\uff09\u52300xffffffff\uff08\u53734GB-1\u7684\u5730\u5740\uff09\u3002\u4f46\u662f\u7531\u4e8ePKE\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u7684\u7279\u6b8a\u6027\uff08\u5b83\u53ea\u9700\u8981\u652f\u6301\u7ed9\u5b9a\u5e94\u7528\u7684\u8fd0\u884c\uff09\uff0clab2\u7684\u4ee3\u7801\u5c06\u64cd\u4f5c\u7cfb\u7edf\u7ba1\u7406\u7684\u7a7a\u95f4\u8fdb\u4e00\u6b65\u7f29\u51cf\uff0c\u5b9a\u4e49\u4e86\u4e00\u4e2a\u64cd\u4f5c\u7cfb\u7edf\u9700\u8981\u7ba1\u7406\u7684\u6700\u5927\u5185\u5b58\u7a7a\u95f4\uff08kernel/config.h\u6587\u4ef6\uff09\uff0c\u4ece\u800c\u63d0\u5347\u5b9e\u9a8c\u4ee3\u7801\u7684\u6267\u884c\u901f\u5ea6\uff1a</p> <pre><code> 10 // the maximum memory space that PKE is allowed to manage. added @lab2_1\n11 #define PKE_MAX_ALLOWABLE_RAM 128 * 1024 * 1024\n12\n13 // the ending physical address that PKE observes. added @lab2_1\n14 #define PHYS_TOP (DRAM_BASE + PKE_MAX_ALLOWABLE_RAM)\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u5b9e\u9a8c\u4ee3\u7801\u201c\u4eba\u4e3a\u201d\u5730\u5c06PKE\u64cd\u4f5c\u7cfb\u7edf\u6240\u80fd\u7ba1\u7406\u7684\u5185\u5b58\u7a7a\u95f4\u9650\u5236\u5230\u4e86128MB\uff08\u5373PKE_MAX_ALLOWABLE_RAM\u7684\u5b9a\u4e49\uff09\uff0c\u540c\u65f6\uff0c\u5b9a\u4e49\u4e86PHYS_TOP\u4e3a\u65b0\u7684\u5185\u5b58\u7269\u7406\u5730\u5740\u4e0a\u9650\u3002\u5b9e\u9645\u4e0a\uff0ckernel/pmm.c\u6587\u4ef6\u6240\u5b9a\u4e49\u7684pmm_init()\u51fd\u6570\u5305\u542b\u4e86PKE\u5bf9\u7269\u7406\u5185\u5b58\u8fdb\u884c\u7ba1\u7406\u7684\u903b\u8f91\uff1a</p> <pre><code> 63 void pmm_init() {\n64   // start of kernel program segment\n65   uint64 g_kernel_start = KERN_BASE;\n66   uint64 g_kernel_end = (uint64)&amp;_end;\n67\n68   uint64 pke_kernel_size = g_kernel_end - g_kernel_start;\n69   sprint(\"PKE kernel start 0x%lx, PKE kernel end: 0x%lx, PKE kernel size: 0x%lx .\\n\",\n70     g_kernel_start, g_kernel_end, pke_kernel_size);\n71\n72   // free memory starts from the end of PKE kernel and must be page-aligined\n73   free_mem_start_addr = ROUNDUP(g_kernel_end , PGSIZE);\n74\n75   // recompute g_mem_size to limit the physical memory space that our riscv-pke kernel\n76   // needs to manage\n77   g_mem_size = MIN(PKE_MAX_ALLOWABLE_RAM, g_mem_size);\n78   if( g_mem_size &lt; pke_kernel_size )\n79     panic( \"Error when recomputing physical memory size (g_mem_size).\\n\" );\n80\n81   free_mem_end_addr = g_mem_size + DRAM_BASE;\n82   sprint(\"free physical memory address: [0x%lx, 0x%lx] \\n\", free_mem_start_addr,\n83     free_mem_end_addr - 1);\n84\n85   sprint(\"kernel memory manager is initializing ...\\n\");\n86   // create the list of free pages\n87   create_freepage_list(free_mem_start_addr, free_mem_end_addr);\n88 }\n</code></pre> <p>\u572876\u884c\uff0cpmm_init()\u51fd\u6570\u4f1a\u8ba1\u7b97g_mem_size\uff0c\u5176\u503c\u5728PKE_MAX_ALLOWABLE_RAM\u548cspike\u6240\u6a21\u62df\u7684\u7269\u7406\u5185\u5b58\u5927\u5c0f\u4e2d\u53d6\u6700\u5c0f\u503c\uff0c\u4e5f\u5c31\u662f\u8bf4\u9664\u975espike\u547d\u4ee4\u884c\u53c2\u6570\u4e2d-m\u53c2\u6570\u540e\u9762\u6240\u5e26\u7684\u6570\u5b57\u5c0f\u4e8e128\uff08\u5373128M\uff09\uff0cg_mem_size\u7684\u5927\u5c0f\u5c06\u4e3a128MB\u3002</p> <p>\u53e6\u5916\uff0c\u4e3a\u4e86\u5bf9\u7a7a\u95f2\u7269\u7406\u5185\u5b58\uff08\u5730\u5740\u8303\u56f4\u4e3a[_end\uff0cg_mem_size+DRAM_BASE(\u5373PHYS_TOP)]\uff09\u8fdb\u884c\u6709\u6548\u7ba1\u7406\uff0cpmm_init()\u51fd\u6570\u572886\u884c\u901a\u8fc7\u8c03\u7528create_freepage_list()\u51fd\u6570\u5b9a\u4e49\u4e86\u4e00\u4e2a\u94fe\u8868\uff0c\u7528\u4e8e\u5bf9\u7a7a\u95f2\u7269\u7406\u5185\u5b58\u7684\u5206\u914d\u548c\u56de\u6536\u3002kernel/pmm.c\u6587\u4ef6\u4e2d\u5305\u542b\u4e86\u6240\u6709\u5bf9\u7269\u7406\u5185\u5b58\u7684\u521d\u59cb\u5316\u3001\u5206\u914d\u548c\u56de\u6536\u7684\u4f8b\u7a0b\uff0c\u5b83\u4eec\u7684\u5b9e\u73b0\u975e\u5e38\u7684\u7b80\u5355\uff0c\u611f\u5174\u8da3\u7684\u8bfb\u8005\u8bf7\u5bf9\u91cc\u9762\u7684\u51fd\u6570\u8fdb\u884c\u9605\u8bfb\u7406\u89e3\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter4_memory/#413-pke","title":"4.1.3 PKE\u64cd\u4f5c\u7cfb\u7edf\u548c\u5e94\u7528\u8fdb\u7a0b\u7684\u903b\u8f91\u5730\u5740\u7a7a\u95f4\u7ed3\u6784","text":"<p>\u901a\u8fc74.1.2\u7684\u8ba8\u8bba\uff0c\u6211\u4eec\u77e5\u9053\u5bf9\u4e8ePKE\u5185\u6838\u6765\u8bf4\uff0c\u6709\u903b\u8f91\u5730\u5740=\u7269\u7406\u5730\u5740\u7684\u5173\u7cfb\u6210\u7acb\uff0c\u8fd9\u4e5f\u662f\u5728\u5b9e\u9a8c\u4e00\u4e2d\u6211\u4eec\u53ef\u4ee5\u91c7\u7528Bare\u6a21\u5f0f\u8fdb\u884c\u5730\u5740\u6620\u5c04\u7684\u539f\u56e0\u3002\u91c7\u7528Bare\u6a21\u5f0f\u7684\u5730\u5740\u6620\u5c04\uff0c\u5728\u8fdb\u884c\u5185\u5b58\u8bbf\u95ee\u65f6\uff0c\u65e0\u9700\u7ecf\u8fc7\u9875\u8868\u548c\u786c\u4ef6\u8fdb\u884c\u903b\u8f91\u5730\u5740\u5230\u7269\u7406\u5730\u5740\u7684\u8f6c\u6362\u3002\u7136\u800c\uff0c\u5728\u5b9e\u9a8c\u4e8c\u4e2d\u6211\u4eec\u5c06\u91c7\u7528Sv39\u865a\u62df\u5730\u5740\u7ba1\u7406\u65b9\u6848\uff0c\u901a\u8fc7\u9875\u8868\u548c\u786c\u4ef6\uff08spike\u6a21\u62df\u7684MMU\uff09\u8fdb\u884c\u8bbf\u5b58\u5730\u5740\u7684\u8f6c\u6362\u3002\u4e3a\u5b9e\u73b0\u8fd9\u79cd\u8f6c\u6362\uff0c\u9996\u5148\u9700\u8981\u786e\u5b9a\u7684\u5c31\u662f\u5c06\u8981\u88ab\u8f6c\u6362\u7684\u903b\u8f91\u5730\u5740\u7a7a\u95f4\uff0c\u5373\u9700\u8981\u5bf9\u54ea\u90e8\u5206\u903b\u8f91\u5730\u5740\u7a7a\u95f4\u8fdb\u884c\u8f6c\u6362\u7684\u95ee\u9898\u3002\u5728PKE\u7684\u5b9e\u9a8c\u4e8c\u4e2d\uff0c\u5b58\u5728\u4e24\u4e2a\u9700\u8981\u88ab\u8f6c\u6362\u7684\u5b9e\u4f53\uff0c\u4e00\u4e2a\u662f\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\uff0c\u53e6\u4e00\u4e2a\u662f\u6211\u4eec\u7684\u5b9e\u9a8c\u7ed9\u5b9a\u7684\u5e94\u7528\u7a0b\u5e8f\u6240\u5bf9\u5e94\u7684\u8fdb\u7a0b\u3002\u4e0b\u9762\u6211\u4eec\u5bf9\u5b83\u4eec\u5206\u522b\u8ba8\u8bba\uff1a</p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter4_memory/#_2","title":"\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838","text":"<p>\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u7684\u903b\u8f91\u5730\u5740\u4e0e\u7269\u7406\u5730\u5740\u5b58\u5728\u4e00\u4e00\u5bf9\u5e94\u7684\u5173\u7cfb\uff0c\u4f46\u662f\u5728\u5f00\u542f\u4e86Sv39\u865a\u62df\u5185\u5b58\u7ba1\u7406\u65b9\u6848\u540e\uff0c\u6240\u6709\u7684\u903b\u8f91\u5730\u5740\u5230\u7269\u7406\u5730\u5740\u7684\u7ffb\u8bd1\u90fd\u5fc5\u987b\u901a\u8fc7\u9875\u8868\u548cMMU\u786c\u4ef6\u8fdb\u884c\uff0c\u6240\u4ee5\uff0c\u4e3a\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u5efa\u7acb\u9875\u8868\u662f\u5fc5\u4e0d\u53ef\u5c11\u7684\u5de5\u4f5c\u3002\u64cd\u4f5c\u7cfb\u7edf\u7684\u903b\u8f91\u5730\u5740\u7a7a\u95f4\u53ef\u4ee5\u7b80\u5355\u7684\u8ba4\u4e3a\u662f\u4ece\u5185\u6838\u4ee3\u7801\u6bb5\u7684\u8d77\u59cb\uff08\u5373KERN_BASE=0x80000000\uff09\u5230\u7269\u7406\u5730\u5740\u7684\u9876\u7aef\uff08\u4e5f\u5c31\u662fPHYS_TOP\uff09\uff0c\u56e0\u4e3a\u64cd\u4f5c\u7cfb\u7edf\u662f\u7cfb\u7edf\u4e2d\u62e5\u6709\u6700\u9ad8\u6743\u9650\u7684\u8f6f\u4ef6\uff0c\u9700\u8981\u5b9e\u73b0\u5bf9\u6240\u6709\u7269\u7406\u5185\u5b58\u7a7a\u95f4\u7684\u76f4\u63a5\u7ba1\u7406\u3002\u8fd9\u6bb5\u903b\u8f91\u5730\u5740\u7a7a\u95f4\uff0c\u5373[KERN_BASE\uff0cPHYS_TOP]\uff0c\u6240\u6620\u5c04\u7684\u7269\u7406\u5730\u5740\u7a7a\u95f4\u4e5f\u662f[KERN_BASE\uff0cPHYS_TOP]\u3002\u4e5f\u5c31\u662f\u8bf4\u5bf9\u4e8e\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\uff0c\u6211\u4eec\u5728\u5b9e\u9a8c\u4e8c\u4e2d\u901a\u8fc7Sv39\u7684\u9875\u8868\uff0c\u4ecd\u7136\u4fdd\u6301\u548c\u5b9e\u9a8c\u4e00\u4e00\u6837\u7684\u903b\u8f91\u5730\u5740\u5230\u7269\u7406\u5730\u5740\u7684\u4e00\u4e00\u5bf9\u5e94\u5173\u7cfb\u3002\u5728\u6743\u9650\u65b9\u9762\uff0c\u5bf9\u4e8e\u5185\u6838\u4ee3\u7801\u6bb5\u6240\u5bf9\u5e94\u7684\u9875\u9762\u6765\u8bf4\u662f\u53ef\u8bfb\u53ef\u6267\u884c\uff0c\u5bf9\u4e8e\u6570\u636e\u6bb5\u4ee5\u53ca\u7a7a\u95f2\u5185\u5b58\u7a7a\u95f4\uff0c\u5176\u6743\u9650\u4e3a\u53ef\u8bfb\u53ef\u5199\u3002</p> <p></p> <p>\u56fe4.4 PKE\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u7684\u903b\u8f91\u5730\u5740\u7a7a\u95f4\u548c\u5b83\u5230\u7269\u7406\u5730\u5740\u7a7a\u95f4\u7684\u6620\u5c04</p> <p>\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u5efa\u7acb\u9875\u8868\u7684\u8fc7\u7a0b\u53ef\u4ee5\u53c2\u8003kernel/vmm.c\u6587\u4ef6\u4e2d\u7684kern_vm_init()\u51fd\u6570\u7684\u5b9e\u73b0\uff0c\u9700\u8981\u8bf4\u660e\u7684\u662fkern_vm_init()\u51fd\u6570\u5728PKE\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u7684S\u6001\u521d\u59cb\u5316\u8fc7\u7a0b\uff08s_start\u51fd\u6570\uff09\u4e2d\u88ab\u8c03\u7528\uff1a</p> <pre><code>120 void kern_vm_init(void) {\n121   // pagetable_t is defined in kernel/riscv.h. it's actually uint64*\n122   pagetable_t t_page_dir;\n123\n124   // allocate a page (t_page_dir) to be the page directory for kernel. alloc_page is defined in kernel/pmm.c\n125   t_page_dir = (pagetable_t)alloc_page();\n126   // memset is defined in util/string.c\n127   memset(t_page_dir, 0, PGSIZE);\n128\n129   // map virtual address [KERN_BASE, _etext] to physical address [DRAM_BASE, DRAM_BASE+(_etext - KERN_BASE)],\n130   // to maintain (direct) text section kernel address mapping.\n131   kern_vm_map(t_page_dir, KERN_BASE, DRAM_BASE, (uint64)_etext - KERN_BASE,\n132          prot_to_type(PROT_READ | PROT_EXEC, 0));\n133\n134   sprint(\"KERN_BASE 0x%lx\\n\", lookup_pa(t_page_dir, KERN_BASE));\n135\n136   // also (direct) map remaining address space, to make them accessable from kernel.\n137   // this is important when kernel needs to access the memory content of user's app\n138   // without copying pages between kernel and user spaces.\n139   kern_vm_map(t_page_dir, (uint64)_etext, (uint64)_etext, PHYS_TOP - (uint64)_etext,\n140          prot_to_type(PROT_READ | PROT_WRITE, 0));\n141\n142   sprint(\"physical address of _etext is: 0x%lx\\n\", lookup_pa(t_page_dir, (uint64)_etext));\n143\n144   g_kernel_pagetable = t_page_dir;\n145 }\n</code></pre> <p>\u6211\u4eec\u770b\u5230\uff0ckern_vm_init()\u51fd\u6570\u4f1a\u9996\u5148\uff08125\u884c\uff09\u4ece\u7a7a\u95f2\u7269\u7406\u5185\u5b58\u4e2d\u83b7\u53d6\uff08\u5206\u914d\uff09\u4e00\u4e2at_page_dir\u6307\u9488\u6240\u6307\u5411\u7684\u7269\u7406\u9875\uff0c\u8be5\u9875\u5c06\u4f5c\u4e3a\u5185\u6838\u9875\u8868\u7684\u6839\u76ee\u5f55\uff08page directory\uff0c\u5bf9\u5e94\u56fe4.1\u4e2d\u7684VPN[2]\uff09\u3002\u63a5\u4e0b\u6765\uff0c\u5c06\u8be5\u9875\u7684\u5185\u5bb9\u6e05\u96f6\uff08127\u884c\uff09\u3001\u6620\u5c04\u4ee3\u7801\u6bb5\u5230\u5b83\u5bf9\u5e94\u7684\u7269\u7406\u5730\u5740\uff08131--132\u884c\uff09\u3001\u6620\u5c04\u6570\u636e\u6bb5\u7684\u8d77\u59cb\u5230PHYS_TOP\u5230\u5b83\u5bf9\u5e94\u7684\u7269\u7406\u5730\u5740\u7a7a\u95f4\uff08139--140\u884c\uff09\uff0c\u6700\u540e\u8bb0\u5f55\u5185\u6838\u9875\u8868\u7684\u6839\u76ee\u5f55\u9875\uff08144\u884c\uff09\u3002</p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter4_memory/#_3","title":"\u5e94\u7528\u8fdb\u7a0b","text":"<p>\u5bf9\u4e8e\u5b9e\u9a8c\u4e00\u7684\u6240\u6709\u5e94\u7528\uff0c\u6211\u4eec\u901a\u8fc7\u6307\u5b9a\u5e94\u7528\u7a0b\u5e8f\u4e2d\u6240\u6709\u7684\u7b26\u53f7\u5730\u5740\u5bf9\u5e94\u7684\u903b\u8f91\u5730\u5740\u7684\u65b9\u6cd5\uff08\u53c2\u89c1\u7b2c\u4e09\u7ae0\u76843.1.3\u8282\uff09\uff0c\u5c06\u5e94\u7528\u7a0b\u5e8f\u4e2d\u7684\u903b\u8f91\u5730\u5740\u201c\u5f3a\u884c\u201d\u5bf9\u5e94\u5230\u56fe4.3\u4e2d\u7684\u201c\u5b9e\u9645\u7a7a\u95f2\u5185\u5b58\u201d\u7a7a\u95f4\uff0c\u5e76\u5728ELF\u52a0\u8f7d\u65f6\u5c06\u7a0b\u5e8f\u6bb5\u52a0\u8f7d\u5230\u4e86\u8fd9\u5757\u5185\u5b58\u7a7a\u95f4\u4e2d\u7684\u5bf9\u5e94\u4f4d\u7f6e\uff0c\u4ece\u800c\u4f7f\u5f97\u5e94\u7528\u7a0b\u5e8f\uff08\u6240\u5bf9\u5e94\u7684\u8fdb\u7a0b\uff09\u4e5f\u53ef\u4ee5\u91c7\u7528\u7c7b\u4f3c\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u90a3\u6837\u7684\u76f4\u6620\u5c04\uff08Bare\u6a21\u5f0f\uff09\u65b9\u5f0f\u3002\u7136\u800c\uff0c\u8fd9\u6837\u505a\u662f\u56e0\u4e3a\u5b9e\u9a8c\u4e00\u4e2d\u7684\u5e94\u7528\u90fd\u662f\u5355\u7ebf\u7a0b\u5e94\u7528\uff0c\u5b83\u4eec\u7684\u6267\u884c\u5e76\u4e0d\u4f1a\u4ea7\u751f\u65b0\u7684\u6267\u884c\u4f53\uff08\u5982\u5b50\u8fdb\u7a0b\uff09\uff0c\u6240\u4ee5\u53ef\u4ee5\u91c7\u7528\u6307\u5b9a\u903b\u8f91\u5730\u5740\u7684\u529e\u6cd5\u8fdb\u884c\u7b80\u5316\u3002\u4f46\u662f\u5b9e\u9645\u60c5\u51b5\u662f\uff0c\u6211\u4eec\u5728\u4ee3\u7406\u5185\u6838\u4e0a\u662f\u6709\u53ef\u80fd\u6267\u884c\u591a\u8fdb\u7a0b\u5e94\u7528\u7684\uff0c\u7279\u522b\u662f\u5728\u5f00\u53d1\u677f\u4e0a\u9a8c\u8bc1\u591a\u6838RISC-V\u5904\u7406\u5668\u7684\u573a\u666f\uff08\u6211\u4eec\u5728\u5b9e\u9a8c\u4e09\u4e2d\uff0c\u4e5f\u5c06\u5f00\u59cb\u8ba8\u8bba\u5728PKE\u5b9e\u9a8c\u4e2d\u5b9e\u73b0\u548c\u5b8c\u5584\u8fdb\u7a0b\u7684\u7ba1\u7406\uff09\u3002\u5728\u8fd9\u79cd\u573a\u666f\u4e0b\uff0c\u7531\u4e8e\u65e0\u6cd5\u4fdd\u8bc1\u5e94\u7528\u6240\u8981\u6c42\u7684\u903b\u8f91\u5730\u5740\u7a7a\u95f4\u201c\u6070\u597d\u201d\u80fd\u627e\u5230\u5bf9\u5e94\u7684\u7269\u7406\u5730\u5740\u7a7a\u95f4\uff0c\u4e14\u540e\u8005\u8fd8\u672a\u88ab\u5360\u636e\u3002</p> <p>\u8fd9\u91cc\uff0c\u6211\u4eec\u53ef\u4ee5\u89c2\u5bdf\u4e00\u4e0b\u5728\u672a\u6307\u5b9a\u903b\u8f91\u5730\u5740\u7684\u60c5\u51b5\u4e0b\u7684\u5e94\u7528\u5bf9\u5e94\u7684\u903b\u8f91\u5730\u5740\u3002\u9996\u5148\u5207\u6362\u5230lab2_1_pagetable\uff0c\u7136\u540e\u6784\u9020\u5185\u6838\u548c\u5e94\u7528\uff1a</p> <pre><code>// \u5207\u6362\u5230lab2_1_pagetable\u5206\u652f\n$ git checkout lab2_1_pagetable\n// \u6784\u9020\u5185\u6838\u548c\u5e94\u7528\n$ make\n// \u663e\u793a\u5e94\u7528\u7a0b\u5e8f\u4e2d\u5c06\u88ab\u52a0\u8f7d\u7684\u7a0b\u5e8f\u6bb5\n$ riscv64-unknown-elf-readelf -l ./obj/app_helloworld_no_lds\n\nElf file type is EXEC (Executable file)\nEntry point 0x100f6\nThere is 1 program header, starting at offset 64\nProgram Headers:\n  Type           Offset             VirtAddr           PhysAddr\n                 FileSiz            MemSiz              Flags  Align\n  LOAD           0x0000000000000000 0x0000000000010000 0x0000000000010000\n                 0x0000000000000360 0x0000000000000360  R E    0x1000\n\nSection to Segment mapping:\n  Segment Sections...\n   00     .text .rodata\n</code></pre> <p>\u901a\u8fc7\u4ee5\u4e0a\u7ed3\u679c\uff0c\u6211\u4eec\u770b\u5230\uff0clab2_1\u7684\u5e94\u7528app_helloworld_no_lds\uff08\u5b9e\u9645\u4e0a\u5c31\u662flab1_1\u4e2d\u7684app_helloworld\uff0c\u4e0d\u540c\u7684\u5730\u65b9\u5728\u4e8e\u6ca1\u6709\u7528\u5230lab1_1\u4e2d\u7684user/user.lds\u6765\u7ea6\u675f\u903b\u8f91\u5730\u5740\uff09\u53ea\u5305\u542b\u4e00\u4e2a\u4ee3\u7801\u6bb5\uff0c\u5b83\u7684\u8d77\u59cb\u5730\u5740\u4e3a0x0000000000010000\uff08\u53730x10000\uff09\u3002</p> <p>\u5bf9\u6bd44.1.2\u8282\u4e2d\u8ba8\u8bba\u7684\u7269\u7406\u5185\u5b58\u5e03\u5c40\uff0c\u6211\u4eec\u77e5\u9053spike\u6a21\u62df\u7684RISC-V\u673a\u5668\u5e76\u65e0\u5904\u4e8e0x10000\u7684\u7269\u7406\u5730\u5740\u7a7a\u95f4\u4e0e\u5176\u5bf9\u5e94\u3002\u8fd9\u6837\uff0c\u6211\u4eec\u5c31\u9700\u8981\u901a\u8fc7Sv39\u865a\u5730\u5740\u7ba1\u7406\u65b9\u6848\u5c060x10000\u5f00\u59cb\u7684\u4ee3\u7801\u6bb5\uff0c\u6620\u5c04\u5230app_helloworld_no_lds\u4e2d\u4ee3\u7801\u6bb5\u5b9e\u9645\u88ab\u52a0\u8f7d\u5230\u7684\u7269\u7406\u5185\u5b58\uff08\u663e\u7136\u4f4d\u4e8e\u56fe4.3\u4e2d\u7684\u201c\u5b9e\u9645\u5185\u5b58\u7a7a\u95f4\u201d\u6240\u6807\u8bc6\u7684\u533a\u57df\uff09\u533a\u57df\u3002</p> <p>PKE\u5b9e\u9a8c\u4e8c\u4e2d\u7684\u5e94\u7528\u52a0\u8f7d\u662f\u901a\u8fc7kernel/kernel.c\u6587\u4ef6\u4e2d\u7684load_user_program\u51fd\u6570\u6765\u5b8c\u6210\u7684\uff1a</p> <pre><code> 38 void load_user_program(process *proc) {\n39   sprint(\"User application is loading.\\n\");\n40   // allocate a page to store the trapframe. alloc_page is defined in kernel/pmm.c. added @la    b2_1\n41   proc-&gt;trapframe = (trapframe *)alloc_page();\n42   memset(proc-&gt;trapframe, 0, sizeof(trapframe));\n43\n44   // allocate a page to store page directory. added @lab2_1\n45   proc-&gt;pagetable = (pagetable_t)alloc_page();\n46   memset((void *)proc-&gt;pagetable, 0, PGSIZE);\n47\n48   // allocate pages to both user-kernel stack and user app itself. added @lab2_1\n49   proc-&gt;kstack = (uint64)alloc_page() + PGSIZE;   //user kernel stack top\n50   uint64 user_stack = (uint64)alloc_page();       //phisical address of user stack bottom\n51\n52   // USER_STACK_TOP = 0x7ffff000, defined in kernel/memlayout.h\n53   proc-&gt;trapframe-&gt;regs.sp = USER_STACK_TOP;  //virtual address of user stack top\n54\n55   sprint(\"user frame 0x%lx, user stack 0x%lx, user kstack 0x%lx \\n\", proc-&gt;trapframe,\n56          proc-&gt;trapframe-&gt;regs.sp, proc-&gt;kstack);\n57\n58   // load_bincode_from_host_elf() is defined in kernel/elf.c\n59   load_bincode_from_host_elf(proc);\n60\n61   // populate the page table of user application. added @lab2_1\n62   // map user stack in userspace, user_vm_map is defined in kernel/vmm.c\n63   user_vm_map((pagetable_t)proc-&gt;pagetable, USER_STACK_TOP - PGSIZE, PGSIZE, user_stack,\n64          prot_to_type(PROT_WRITE | PROT_READ, 1));\n65\n66   // map trapframe in user space (direct mapping as in kernel space).\n67   user_vm_map((pagetable_t)proc-&gt;pagetable, (uint64)proc-&gt;trapframe, PGSIZE, (uint64)proc-&gt;trapframe,\n68          prot_to_type(PROT_WRITE | PROT_READ, 0));\n69\n70   // map S-mode trap vector section in user space (direct mapping as in kernel space)\n71   // here, we assume that the size of usertrap.S is smaller than a page.\n72   user_vm_map((pagetable_t)proc-&gt;pagetable, (uint64)trap_sec_start, PGSIZE, (uint64)trap_sec_start,\n73          prot_to_type(PROT_READ | PROT_EXEC, 0));\n74 }\n</code></pre> <p>load_user_program()\u51fd\u6570\u5bf9\u4e8e\u5e94\u7528\u8fdb\u7a0b\u903b\u8f91\u7a7a\u95f4\u7684\u64cd\u4f5c\u53ef\u4ee5\u5206\u6210\u4ee5\u4e0b\u51e0\u4e2a\u90e8\u5206\uff1a</p> <ul> <li> <p>\uff0841--42\u884c\uff09\u5206\u914d\u4e00\u4e2a\u7269\u7406\u9875\u9762\uff0c\u5c06\u5176\u4f5c\u4e3a\u6808\u5e27\uff08trapframe\uff09\uff0c\u5373\u53d1\u751f\u4e2d\u65ad\u65f6\u4fdd\u5b58\u7528\u6237\u8fdb\u7a0b\u6267\u884c\u4e0a\u4e0b\u6587\u7684\u5185\u5b58\u7a7a\u95f4\u3002\u7531\u4e8e\u7269\u7406\u9875\u9762\u90fd\u662f\u4ece\u4f4d\u4e8e\u7269\u7406\u5730\u5740\u8303\u56f4[_end\uff0cPHYS_TOP]\u7684\u7a7a\u95f4\u4e2d\u5206\u914d\u7684\uff0c\u5b83\u7684\u9996\u5730\u5740\u4e5f\u5c06\u4f4d\u4e8e\u8be5\u533a\u95f4\u3002\u6240\u4ee5\u7b2c67--68\u884c\u7684\u6620\u5c04\uff0c\u4e5f\u662f\u505a\u4e00\u4e2aproc-&gt;trapframe\u5230\u6240\u5206\u914d\u9875\u9762\u7684\u76f4\u6620\u5c04\uff08\u903b\u8f91\u5730\u5740=\u7269\u7406\u5730\u5740\uff09\u3002</p> </li> <li> <p>\uff0845--46\u884c\uff09\u5206\u914d\u4e00\u4e2a\u7269\u7406\u9875\u9762\u4f5c\u4e3a\u5b58\u653e\u8fdb\u7a0b\u9875\u8868\u6839\u76ee\u5f55\uff08page directory\uff0c\u5bf9\u5e94\u56fe4.1\u4e2d\u7684VPN[2]\uff09\u7684\u7a7a\u95f4\u3002</p> </li> <li> <p>\uff0849\u884c\uff09\u5206\u914d\u4e86\u4e00\u4e2a\u7269\u7406\u9875\u9762\uff0c\u4f5c\u4e3a\u7528\u6237\u8fdb\u7a0b\u7684\u5185\u6838\u6001\u6808\uff0c\u8be5\u6808\u5c06\u5728\u7528\u6237\u8fdb\u7a0b\u8fdb\u5165\u4e2d\u65ad\u5904\u7406\u65f6\u7528\u4f5cS\u6a21\u5f0f\u5185\u6838\u5904\u7406\u51fd\u6570\u4f7f\u7528\u7684\u6808\u3002\u7136\u800c\uff0c\u8fd9\u4e2a\u6808\u5e76\u672a\u6620\u5c04\u5230\u7528\u6237\u8fdb\u7a0b\u7684\u903b\u8f91\u5730\u5740\u7a7a\u95f4\uff0c\u800c\u662f\u5c06\u5176\u9996\u5730\u5740\u4fdd\u5b58\u5728proc-&gt;kstack\u4e2d\u3002</p> </li> <li> <p>\uff0850--53\u884c\uff09\u518d\u6b21\u5206\u914d\u4e00\u4e2a\u7269\u7406\u9875\u9762\uff0c\u4f5c\u4e3a\u7528\u6237\u8fdb\u7a0b\u7684\u7528\u6237\u6001\u6808\uff0c\u8be5\u6808\u4f9b\u5e94\u7528\u5728\u7528\u6237\u6a21\u5f0f\u4e0b\u4f7f\u7528\uff0c\u5e76\u5728\u7b2c63--64\u884c\u6620\u5c04\u5230\u7528\u6237\u8fdb\u7a0b\u7684\u903b\u8f91\u5730\u5740USER_STACK_TOP\u3002</p> </li> <li>\uff0859\u884c\uff09\u8c03\u7528load_bincode_from_host_elf()\u51fd\u6570\uff0c\u8be5\u51fd\u6570\u5c06\u8bfb\u53d6\u5e94\u7528\u6240\u5bf9\u5e94\u7684ELF\u6587\u4ef6\uff0c\u5e76\u5c06\u5176\u4e2d\u7684\u4ee3\u7801\u6bb5\u8bfb\u53d6\u5230\u65b0\u5206\u914d\u7684\u5185\u5b58\u7a7a\u95f4\uff08\u7269\u7406\u5730\u5740\u4f4d\u4e8e[_end\uff0cPHYS_TOP]\u533a\u95f4\uff09\u3002</li> <li>\uff0872--73\u884c\uff09\u5c06\u5185\u6838\u4e2d\u7684S\u6001trap\u5165\u53e3\u51fd\u6570\u6240\u5728\u7684\u7269\u7406\u9875\u4e00\u4e00\u6620\u5c04\u5230\u7528\u6237\u8fdb\u7a0b\u7684\u903b\u8f91\u5730\u5740\u7a7a\u95f4\u3002</li> </ul> <p>\u901a\u8fc7\u4ee5\u4e0aload_user_program()\u51fd\u6570\uff0c\u6211\u4eec\u53ef\u4ee5\u5927\u81f4\u753b\u51fa\u7528\u6237\u8fdb\u7a0b\u7684\u903b\u8f91\u5730\u5740\u7a7a\u95f4\uff0c\u4ee5\u53ca\u8be5\u5730\u5740\u7a7a\u95f4\u5230\u7269\u7406\u5730\u5740\u7a7a\u95f4\u7684\u6620\u5c04\u3002</p> <p></p> <p></p> <p>\u56fe4.5 \u7528\u6237\u8fdb\u7a0b\u7684\u903b\u8f91\u5730\u5740\u7a7a\u95f4\u548c\u5230\u7269\u7406\u5730\u5740\u7a7a\u95f4\u7684\u6620\u5c04</p> <p>\u6211\u4eec\u770b\u5230\uff0c\u7528\u6237\u8fdb\u7a0b\u5728\u88c5\u5165\u540e\uff0c\u5176\u903b\u8f91\u5730\u5740\u7a7a\u95f4\u67094\u4e2a\u533a\u95f4\u5efa\u7acb\u4e86\u548c\u7269\u7406\u5730\u5740\u7a7a\u95f4\u7684\u6620\u5c04\u3002\u4ece\u4e0a\u5f80\u4e0b\u89c2\u5bdf\uff0c\u201c\u7528\u6237\u8fdb\u7a0btrapframe\u201d\u548c\u201ctrap\u5165\u53e3\u9875\u9762\u201d\u7684\u903b\u8f91\u5730\u5740\u5927\u4e8e0x80000000\uff0c\u4e14\u4e0e\u627f\u8f7d\u5b83\u4eec\u7684\u7269\u7406\u7a7a\u95f4\u5efa\u7acb\u4e86\u4e00\u5bf9\u4e00\u7684\u6620\u5c04\u5173\u7cfb\u3002\u53e6\u5916\u4e24\u4e2a\u533a\u95f4\uff0c\u5373\u201c\u7528\u6237\u6001\u6808\u201d\u548c\u201c\u7528\u6237\u4ee3\u7801\u6bb5\u201d\u7684\u903b\u8f91\u5730\u5740\u90fd\u4f4e\u4e8e0x80000000\uff0c\u5b83\u4eec\u6240\u5bf9\u5e94\u7684\u7269\u7406\u7a7a\u95f4\u5219\u90fd\u4f4d\u4e8e\u5b9e\u9645\u7a7a\u95f2\u5185\u5b58\u533a\u57df\uff0c\u540c\u65f6\uff0c\u8fd9\u79cd\u6620\u5c04\u7684\u903b\u8f91\u5730\u5740\u663e\u7136\u4e0d\u7b49\u4e8e\u7269\u7406\u5730\u5740\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter4_memory/#414","title":"4.1.4 \u4e0e\u9875\u8868\u64cd\u4f5c\u76f8\u5173\u7684\u91cd\u8981\u51fd\u6570","text":"<p>\u5b9e\u9a8c\u4e8c\u4e0e\u9875\u8868\u64cd\u4f5c\u76f8\u5173\u7684\u51fd\u6570\u90fd\u653e\u5728kernel/vmm.c\u6587\u4ef6\u4e2d\uff0c\u5176\u4e2d\u6bd4\u8f83\u91cd\u8981\u7684\u51fd\u6570\u6709\uff1a</p> <ul> <li>int map_pages(pagetable_t page_dir, uint64 va, uint64 size, uint64 pa, int perm);</li> </ul> <p>\u8be5\u51fd\u6570\u7684\u7b2c\u4e00\u4e2a\u8f93\u5165\u53c2\u6570page_dir\u4e3a\u6839\u76ee\u5f55\u6240\u5728\u7269\u7406\u9875\u9762\u7684\u9996\u5730\u5740\uff0c\u7b2c\u4e8c\u4e2a\u53c2\u6570va\u5219\u662f\u5c06\u8981\u88ab\u6620\u5c04\u7684\u903b\u8f91\u5730\u5740\uff0c\u7b2c\u4e09\u4e2a\u53c2\u6570size\u4e3a\u6240\u8981\u5efa\u7acb\u6620\u5c04\u7684\u533a\u95f4\u7684\u957f\u5ea6\uff0c\u7b2c\u56db\u4e2a\u53c2\u6570pa\u4e3a\u903b\u8f91\u5730\u5740va\u6240\u8981\u88ab\u6620\u5c04\u5230\u7684\u7269\u7406\u5730\u5740\u9996\u5730\u5740\uff0c\u6700\u540e\uff08\u7b2c\u4e94\u4e2a\uff09\u7684\u53c2\u6570perm\u4e3a\u6620\u5c04\u5efa\u7acb\u540e\u9875\u9762\u8bbf\u95ee\u7684\u6743\u9650\u3002</p> <p>\u603b\u7684\u6765\u8bf4\uff0c\u8be5\u51fd\u6570\u5c06\u5728\u7ed9\u5b9a\u7684page_dir\u6240\u6307\u5411\u7684\u6839\u76ee\u5f55\u4e2d\uff0c\u5efa\u7acb[va\uff0cva+size]\u5230[pa\uff0cpa+size]\u7684\u6620\u5c04\u3002</p> <ul> <li>pte_t *page_walk(pagetable_t page_dir, uint64 va, int alloc);</li> </ul> <p>\u8be5\u51fd\u6570\u7684\u7b2c\u4e00\u4e2a\u8f93\u5165\u53c2\u6570page_dir\u4e3a\u6839\u76ee\u5f55\u6240\u5728\u7269\u7406\u9875\u9762\u7684\u9996\u5730\u5740\uff0c\u7b2c\u4e8c\u4e2a\u53c2\u6570va\u4e3a\u6240\u8981\u67e5\u627e\uff08walk\uff09\u7684\u903b\u8f91\u5730\u5740\uff0c\u7b2c\u4e09\u4e2a\u53c2\u6570\u5b9e\u9645\u4e0a\u662f\u4e00\u4e2abool\u7c7b\u578b\uff1a\u5f53\u5b83\u4e3a1\u65f6\uff0c\u5982\u679c\u5b83\u6240\u8981\u67e5\u627e\u7684\u903b\u8f91\u5730\u5740\u5e76\u672a\u5efa\u7acb\u4e0e\u7269\u7406\u5730\u5740\u7684\u6620\u5c04\uff08\u56fe4.1\u4e2d\u7684Page Medium Directory\uff09\u4e0d\u5b58\u5728\uff0c\u5219\u901a\u8fc7\u5206\u914d\u5185\u5b58\u7a7a\u95f4\u5efa\u7acb\u4ece\u6839\u76ee\u5f55\u5230\u9875\u8868\u7684\u5b8c\u6574\u6620\u5c04\uff0c\u5e76\u6700\u7ec8\u8fd4\u56deva\u6240\u5bf9\u5e94\u7684\u9875\u8868\u9879\uff1b\u5f53\u5b83\u4e3a0\u65f6\uff0c\u5982\u679c\u5b83\u6240\u8981\u67e5\u627e\u7684\u903b\u8f91\u5730\u5740\u5e76\u672a\u5efa\u7acb\u4e0e\u7269\u7406\u5730\u5740\u7684\u6620\u5c04\uff0c\u5219\u8fd4\u56deNULL\uff0c\u5426\u5219\u8fd4\u56deva\u6240\u5bf9\u5e94\u7684\u9875\u8868\u9879\u3002</p> <ul> <li>uint64 lookup_pa(pagetable_t pagetable, uint64 va);</li> </ul> <p>\u67e5\u627e\u903b\u8f91\u5730\u5740va\u6240\u5728\u865a\u62df\u9875\u9762\u5730\u5740\uff08\u5373va\u5c06\u4f4e12\u4f4d\u7f6e\u96f6\uff09\u5bf9\u5e94\u7684\u7269\u7406\u9875\u9762\u5730\u5740\u3002\u5982\u679c\u6ca1\u6709\u4e0eva\u5bf9\u5e94\u7684\u7269\u7406\u9875\u9762\uff0c\u5219\u8fd4\u56deNULL\uff1b\u5426\u5219\uff0c\u8fd4\u56deva\u5bf9\u5e94\u7684\u7269\u7406\u9875\u9762\u5730\u5740\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter4_memory/#42-lab2_1","title":"4.2 lab2_1 \u865a\u5b9e\u5730\u5740\u8f6c\u6362","text":""},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter4_memory/#_4","title":"\u7ed9\u5b9a\u5e94\u7528","text":"<ul> <li>user/app_helloworld_no_lds.c</li> </ul> <pre><code>  1 /*\n  2  * Below is the given application for lab2_1.\n  3  * This app runs in its own address space, in contrast with in direct mapping.\n  4  */\n5\n6 #include \"user_lib.h\"\n7 #include \"util/types.h\"\n8\n9 int main(void) {\n10   printu(\"Hello world!\\n\");\n11   exit(0);\n12 }\n</code></pre> <p>\u8be5\u5e94\u7528\u7684\u4ee3\u7801\u8ddflab1_1\u662f\u4e00\u6837\u7684\u3002\u4f46\u662f\uff0c\u4e0d\u540c\u7684\u5730\u65b9\u5728\u4e8e\uff0c\u5b83\u7684\u7f16\u8bd1\u548c\u94fe\u63a5\u5e76\u672a\u6307\u5b9a\u7a0b\u5e8f\u4e2d\u7b26\u53f7\u7684\u903b\u8f91\u5730\u5740\u3002</p> <ul> <li>\uff08\u5148\u63d0\u4ea4lab1_3\u7684\u7b54\u6848\uff0c\u7136\u540e\uff09\u5207\u6362\u5230lab2_1\uff0c\u7ee7\u627flab1_3\u4e2d\u6240\u505a\u7684\u4fee\u6539\uff0c\u5e76make\u540e\u7684\u76f4\u63a5\u8fd0\u884c\u7ed3\u679c\uff1a</li> </ul> <pre><code>//\u5207\u6362\u5230lab2_1\n$ git checkout lab2_1_pagetable\n\n//\u7ee7\u627flab1_3\u4ee5\u53ca\u4e4b\u524d\u7684\u7b54\u6848\n$ git merge lab1_3_irq -m \"continue to work on lab2_1\"\n//\u91cd\u65b0\u6784\u9020\n$ make clean; make\n\n//\u8fd0\u884c\u6784\u9020\u7ed3\u679c\n$ spike ./obj/riscv-pke ./obj/app_helloworld_no_lds\nIn m_start, hartid:0\nHTIF is available!\n(Emulated) memory size: 2048 MB\nEnter supervisor mode...\nPKE kernel start 0x0000000080000000, PKE kernel end: 0x000000008000e000, PKE kernel size: 0x000000000000e000 .\nfree physical memory address: [0x000000008000e000, 0x0000000087ffffff]\nkernel memory manager is initializing ...\nKERN_BASE 0x0000000080000000\nphysical address of _etext is: 0x0000000080004000\nkernel page table is on\nUser application is loading.\nuser frame 0x0000000087fbc000, user stack 0x000000007ffff000, user kstack 0x0000000087fbb000\nApplication: ./obj/app_helloworld_no_lds\nApplication program entry point (virtual address): 0x00000000000100f6\nSwitching to user mode...\nYou have to implement user_va_to_pa (convert user va to pa) to print messages in lab2_1.\n\nSystem is shutting down with exit code -1.\n</code></pre> <p>\u4ece\u4ee5\u4e0a\u8fd0\u884c\u7ed3\u679c\u6765\u770b\uff0c\u6211\u4eec\u7684\u5e94\u7528app_helloworld_no_lds\u5e76\u672a\u5982\u613f\u5730\u6253\u5370\u51fa\u201cHello world!\\n\u201d\uff0c\u8fd9\u662f\u56e0\u4e3auser/app_helloworld_no_lds.c\u7684\u7b2c10\u884c<code>printu(\"Hello world!\\n\");</code>\u4e2d\u7684\u201cHello world!\\n\u201d\u5b57\u7b26\u4e32\u672c\u8d28\u4e0a\u662f\u5b58\u50a8\u5728.rodata\u6bb5\uff0c\u5b83\u88ab\u548c\u4ee3\u7801\u6bb5\uff08.text\uff09\u4e00\u8d77\u88ab\u88c5\u5165\u5185\u5b58\u3002\u4ece\u903b\u8f91\u5730\u5740\u7ed3\u6784\u6765\u770b\uff0c\u5b83\u7684\u903b\u8f91\u5730\u5740\u5c31\u5e94\u8be5\u4f4d\u4e8e\u56fe4.5\u4e2d\u7684\u201c\u7528\u6237\u4ee3\u7801\u6bb5\u201d\uff0c\u663e\u7136\u4f4e\u4e8e0x80000000\u3002</p> <p>\u800cprintu\u662f\u4e00\u4e2a\u5178\u578b\u7684\u7cfb\u7edf\u8c03\u7528\uff08\u53c2\u8003lab1_1\u7684\u5185\u5bb9\uff09\uff0c\u5b83\u7684\u6267\u884c\u903b\u8f91\u662f\u901a\u8fc7ecall\u6307\u4ee4\uff0c\u9677\u5165\u5230\u5185\u6838\uff08S\u6a21\u5f0f\uff09\u5b8c\u6210\u5230\u5c4f\u5e55\u7684\u8f93\u51fa\u3002\u7136\u800c\uff0c\u5bf9\u4e8e\u5185\u6838\u800c\u8a00\uff0c\u663e\u7136\u4e0d\u80fd\u7ee7\u7eed\u4f7f\u7528\u201cHello world!\\n\u201d\u7684\u903b\u8f91\u5730\u5740\u5bf9\u5b83\u8fdb\u884c\u8bbf\u95ee\uff0c\u800c\u5fc5\u987b\u5c06\u5176\u8f6c\u6362\u6210\u7269\u7406\u5730\u5740\uff08\u56e0\u4e3a\u5982\u56fe4.4\u6240\u793a\uff0c\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u5df2\u5efa\u7acb\u4e86\u5230\u201c\u5b9e\u9645\u7a7a\u95f2\u5185\u5b58\u201d\u7684\u76f4\u6620\u5c04\uff09\u3002\u800clab2_1\u7684\u4ee3\u7801\uff0c\u663e\u7136\u672a\u5b9e\u73b0\u8fd9\u79cd\u8f6c\u6362\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter4_memory/#_5","title":"\u5b9e\u9a8c\u5185\u5bb9","text":"<p>\u5b9e\u73b0user_va_to_pa()\u51fd\u6570\uff0c\u5b8c\u6210\u7ed9\u5b9a\u903b\u8f91\u5730\u5740\u5230\u7269\u7406\u5730\u5740\u7684\u8f6c\u6362\uff0c\u5e76\u83b7\u5f97\u4ee5\u4e0b\u9884\u671f\u7ed3\u679c\uff1a</p> <pre><code>$ spike ./obj/riscv-pke ./obj/app_helloworld_no_lds\nIn m_start, hartid:0\nHTIF is available!\n(Emulated) memory size: 2048 MB\nEnter supervisor mode...\nPKE kernel start 0x0000000080000000, PKE kernel end: 0x000000008000e000, PKE kernel size: 0x000000000000e000 .\nfree physical memory address: [0x000000008000e000, 0x0000000087ffffff]\nkernel memory manager is initializing ...\nKERN_BASE 0x0000000080000000\nphysical address of _etext is: 0x0000000080004000\nkernel page table is on\nUser application is loading.\nuser frame 0x0000000087fbc000, user stack 0x000000007ffff000, user kstack 0x0000000087fbb000\nApplication: ./obj/app_helloworld_no_lds\nApplication program entry point (virtual address): 0x00000000000100f6\nSwitching to user mode...\nHello world!\nUser exit with code:0.\nSystem is shutting down with exit code 0.\n</code></pre> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter4_memory/#_6","title":"\u5b9e\u9a8c\u6307\u5bfc","text":"<p>\u8bfb\u8005\u53ef\u4ee5\u53c2\u8003lab1_1\u7684\u5185\u5bb9\uff0c\u91cd\u8d70\u4ece\u5e94\u7528\u7684printu\u5230S\u6001\u7684\u7cfb\u7edf\u8c03\u7528\u7684\u5b8c\u6574\u8def\u5f84\uff0c\u6700\u7ec8\u6765\u5230kernel/syscall.c\u6587\u4ef6\u7684sys_user_print()\u51fd\u6570\uff1a</p> <pre><code> 21 ssize_t sys_user_print(const char* buf, size_t n) {\n22   //buf is an address in user space on user stack,\n23   //so we have to transfer it into phisical address (kernel is running in direct mapping).\n24   assert( current );\n25   char* pa = (char*)user_va_to_pa((pagetable_t)(current-&gt;pagetable), (void*)buf);\n26   sprint(pa);\n27   return 0;\n28 }\n</code></pre> <p>\u8be5\u51fd\u6570\u6700\u7ec8\u5728\u7b2c26\u884c\u901a\u8fc7\u8c03\u7528sprint\u5c06\u7ed3\u679c\u8f93\u51fa\uff0c\u4f46\u662f\u5728\u8f93\u51fa\u524d\uff0c\u9700\u8981\u5c06buf\u5730\u5740\u8f6c\u6362\u4e3a\u7269\u7406\u5730\u5740\u4f20\u9012\u7ed9sprint\uff0c\u8fd9\u4e00\u8f6c\u6362\u662f\u901a\u8fc7user_va_to_pa()\u51fd\u6570\u5b8c\u6210\u7684\u3002\u800cuser_va_to_pa()\u51fd\u6570\u7684\u5b9a\u4e49\u5728kernel/vmm.c\u6587\u4ef6\u4e2d\u5b9a\u4e49\uff1a</p> <pre><code>150 void *user_va_to_pa(pagetable_t page_dir, void *va) {\n151   // TODO (lab2_1): implement user_va_to_pa to convert a given user virtual address \"va\"\n152   // to its corresponding physical address, i.e., \"pa\". To do it, we need to walk\n153   // through the page table, starting from its directory \"page_dir\", to locate the PTE\n154   // that maps \"va\". If found, returns the \"pa\" by using:\n155   // pa = PYHS_ADDR(PTE) + (va - va &amp; (1&lt;&lt;PGSHIFT -1))\n156   // Here, PYHS_ADDR() means retrieving the starting address (4KB aligned), and\n157   // (va - va &amp; (1&lt;&lt;PGSHIFT -1)) means computing the offset of \"va\" in its page.\n158   // Also, it is possible that \"va\" is not mapped at all. in such case, we can find\n159   // invalid PTE, and should return NULL.\n160   panic( \"You have to implement user_va_to_pa (convert user va to pa) to print messages in lab2_1.\\n\" );\n161\n162 }\n</code></pre> <p>\u5982\u6ce8\u91ca\u4e2d\u7684\u63d0\u793a\uff0c\u4e3a\u4e86\u5728page_dir\u6240\u6307\u5411\u7684\u9875\u8868\u4e2d\u67e5\u627e\u903b\u8f91\u5730\u5740va\uff0c\u5c31\u5fc5\u987b\u901a\u8fc7\u8c03\u7528\u9875\u8868\u64cd\u4f5c\u76f8\u5173\u51fd\u6570\u627e\u5230\u5305\u542bva\u7684\u9875\u8868\u9879\uff08PTE\uff09\uff0c\u901a\u8fc7\u8be5PTE\u7684\u5185\u5bb9\u5f97\u77e5va\u6240\u5728\u7684\u7269\u7406\u9875\u9762\u7684\u9996\u5730\u5740\uff0c\u6700\u540e\u518d\u901a\u8fc7\u8ba1\u7b97va\u5728\u9875\u5185\u7684\u4f4d\u79fb\u5f97\u5230va\u6700\u7ec8\u5bf9\u5e94\u7684\u7269\u7406\u5730\u5740\u3002</p> <p>\u5b9e\u9a8c\u5b8c\u6bd5\u540e\uff0c\u8bb0\u5f97\u63d0\u4ea4\u4fee\u6539\uff08\u547d\u4ee4\u884c\u4e2d-m\u540e\u7684\u5b57\u7b26\u4e32\u53ef\u81ea\u884c\u786e\u5b9a\uff09\uff0c\u4ee5\u4fbf\u5728\u540e\u7eed\u5b9e\u9a8c\u4e2d\u7ee7\u627flab2_1\u4e2d\u6240\u505a\u7684\u5de5\u4f5c\uff1a</p> <pre><code>$ git commit -a -m \"my work on lab2_1 is done.\"\n</code></pre> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter4_memory/#43-lab2_2","title":"4.3 lab2_2 \u7b80\u5355\u5185\u5b58\u5206\u914d\u548c\u56de\u6536","text":""},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter4_memory/#_7","title":"\u7ed9\u5b9a\u5e94\u7528","text":"<ul> <li>user/app_naive_malloc.c</li> </ul> <pre><code>  1 /*\n  2  * Below is the given application for lab2_2.\n  3  */\n4\n5 #include \"user_lib.h\"\n6 #include \"util/types.h\"\n7\n8 struct my_structure {\n9   char c;\n10   int n;\n11 };\n12\n13 int main(void) {\n14   struct my_structure* s = (struct my_structure*)naive_malloc();\n15   s-&gt;c = 'a';\n16   s-&gt;n = 1;\n17\n18   printu(\"s: %lx, {%c %d}\\n\", s, s-&gt;c, s-&gt;n);\n19\n20   naive_free(s);\n21\n22   exit(0);\n23 }\n</code></pre> <p>\u8be5\u5e94\u7528\u7684\u903b\u8f91\u975e\u5e38\u7b80\u5355\uff1a\u9996\u5148\u5206\u914d\u4e00\u4e2a\u7a7a\u95f4\uff08\u5185\u5b58\u9875\u9762\uff09\u6765\u5b58\u653emy_structure\u7ed3\u6784\uff0c\u5f80my_structure\u7ed3\u6784\u7684\u5b9e\u4f8b\u4e2d\u5b58\u50a8\u4fe1\u606f\uff0c\u6253\u5370\u4fe1\u606f\uff0c\u5e76\u6700\u7ec8\u5c06\u4e4b\u524d\u6240\u5206\u914d\u7684\u7a7a\u95f4\u91ca\u653e\u6389\u3002\u8fd9\u91cc\uff0c\u65b0\u5b9a\u4e49\u4e86\u4e24\u4e2a\u7528\u6237\u6001\u51fd\u6570naive_malloc()\u548cnaive_free()\uff0c\u5b83\u4eec\u6700\u7ec8\u4f1a\u8f6c\u6362\u6210\u7cfb\u7edf\u8c03\u7528\uff0c\u5b8c\u6210\u5185\u5b58\u7684\u5206\u914d\u548c\u56de\u6536\u64cd\u4f5c\u3002</p> <ul> <li>\uff08\u5148\u63d0\u4ea4lab2_1\u7684\u7b54\u6848\uff0c\u7136\u540e\uff09\u5207\u6362\u5230lab2_2\uff0c\u7ee7\u627flab2_1\u4ee5\u53ca\u4e4b\u524d\u5b9e\u9a8c\u6240\u505a\u7684\u4fee\u6539\uff0c\u5e76make\u540e\u7684\u76f4\u63a5\u8fd0\u884c\u7ed3\u679c\uff1a</li> </ul> <pre><code>//\u5207\u6362\u5230lab2_2\n$ git checkout lab2_2_allocatepage\n\n//\u7ee7\u627flab2_1\u4ee5\u53ca\u4e4b\u524d\u7684\u7b54\u6848\n$ git merge lab2_1_pagetable -m \"continue to work on lab2_2\"\n//\u91cd\u65b0\u6784\u9020\n$ make clean; make\n\n//\u8fd0\u884c\u6784\u9020\u7ed3\u679c\n$ spike ./obj/riscv-pke ./obj/app_naive_malloc\nIn m_start, hartid:0\nHTIF is available!\n(Emulated) memory size: 2048 MB\nEnter supervisor mode...\nPKE kernel start 0x0000000080000000, PKE kernel end: 0x000000008000e000, PKE kernel size: 0x000000000000e000 .\nfree physical memory address: [0x000000008000e000, 0x0000000087ffffff]\nkernel memory manager is initializing ...\nKERN_BASE 0x0000000080000000\nphysical address of _etext is: 0x0000000080004000\nkernel page table is on\nUser application is loading.\nuser frame 0x0000000087fbc000, user stack 0x000000007ffff000, user kstack 0x0000000087fbb000\nApplication: ./obj/app_naive_malloc\nApplication program entry point (virtual address): 0x0000000000010078\nSwitching to user mode...\ns: 0000000000400000, {a 1}\nYou have to implement user_vm_unmap to free pages using naive_free in lab2_2.\n\nSystem is shutting down with exit code -1.\n</code></pre> <p>\u4ece\u8f93\u51fa\u7ed3\u679c\u6765\u770b\uff0c<code>s: 0000000000400000, {a 1}</code>\u7684\u8f93\u51fa\u8bf4\u660e\u5206\u914d\u5185\u5b58\u5df2\u7ecf\u505a\u597d\uff08\u4e5f\u5c31\u662f\u8bf4naive_malloc\u51fd\u6570\u53ca\u5176\u5185\u6838\u529f\u80fd\u7684\u5b9e\u73b0\u5df2\u5b8c\u6210\uff09\uff0c\u4e14\u6253\u5370\u51fa\u4e86\u6211\u4eec\u9884\u671f\u7684\u7ed3\u679c\u3002\u4f46\u662f\uff0cnaive_free\u5bf9\u5e94\u7684\u529f\u80fd\u5e76\u672a\u5b8c\u5168\u505a\u597d\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter4_memory/#_8","title":"\u5b9e\u9a8c\u5185\u5bb9","text":"<p>\u5982\u8f93\u51fa\u63d0\u793a\u6240\u8868\u660e\u7684\u90a3\u6837\uff0c\u9700\u8981\u5b8c\u6210naive_free\u5bf9\u5e94\u7684\u529f\u80fd\uff0c\u5e76\u83b7\u5f97\u4ee5\u4e0b\u9884\u671f\u7684\u7ed3\u679c\u8f93\u51fa\uff1a</p> <pre><code>$ spike ./obj/riscv-pke ./obj/app_naive_malloc\nIn m_start, hartid:0\nHTIF is available!\n(Emulated) memory size: 2048 MB\nEnter supervisor mode...\nPKE kernel start 0x0000000080000000, PKE kernel end: 0x000000008000e000, PKE kernel size: 0x000000000000e000 .\nfree physical memory address: [0x000000008000e000, 0x0000000087ffffff]\nkernel memory manager is initializing ...\nKERN_BASE 0x0000000080000000\nphysical address of _etext is: 0x0000000080004000\nkernel page table is on\nUser application is loading.\nuser frame 0x0000000087fbc000, user stack 0x000000007ffff000, user kstack 0x0000000087fbb000\nApplication: ./obj/app_naive_malloc\nApplication program entry point (virtual address): 0x0000000000010078\nSwitching to user mode...\ns: 0000000000400000, {a 1}\nUser exit with code:0.\nSystem is shutting down with exit code 0.\n</code></pre> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter4_memory/#_9","title":"\u5b9e\u9a8c\u6307\u5bfc","text":"<p>\u4e00\u822c\u6765\u8bf4\uff0c\u5e94\u7528\u7a0b\u5e8f\u6267\u884c\u8fc7\u7a0b\u4e2d\u7684\u52a8\u6001\u5185\u5b58\u5206\u914d\u548c\u56de\u6536\uff0c\u662f\u64cd\u4f5c\u7cfb\u7edf\u4e2d\u7684\u5806\uff08Heap\uff09\u7ba1\u7406\u7684\u5185\u5bb9\u3002\u5728\u672c\u5b9e\u9a8c\u4e2d\uff0c\u6211\u4eec\u5b9e\u9645\u4e0a\u662f\u4e3aPKE\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u5b9e\u73b0\u4e00\u4e2a\u7b80\u5355\u5230\u4e0d\u80fd\u518d\u7b80\u5355\u7684\u201c\u5806\u201d\u3002\u4e3a\u5b9e\u73b0naive_free()\u7684\u5185\u5b58\u56de\u6536\u8fc7\u7a0b\uff0c\u6211\u4eec\u9700\u8981\u4e86\u89e3\u5176\u5bf9\u5076\u8fc7\u7a0b\uff0c\u5373\u5185\u5b58\u662f\u5982\u4f55\u201c\u5206\u914d\u201d\u7ed9\u5e94\u7528\u7a0b\u5e8f\uff0c\u5e76\u4f9b\u540e\u8005\u4f7f\u7528\u7684\u3002\u4e3a\u6b64\uff0c\u6211\u4eec\u5148\u9605\u8bfbkernel/syscall.c\u6587\u4ef6\u4e2d\u7684naive_malloc()\u51fd\u6570\u7684\u5e95\u5c42\u5b9e\u73b0\uff0csys_user_allocate_page()\uff1a</p> <pre><code> 42 uint64 sys_user_allocate_page() {\n43   void* pa = alloc_page();\n44   uint64 va = g_ufree_page;\n45   g_ufree_page += PGSIZE;\n46   user_vm_map((pagetable_t)current-&gt;pagetable, va, PGSIZE, (uint64)pa,\n47          prot_to_type(PROT_WRITE | PROT_READ, 1));\n48\n49   return va;\n50 }\n</code></pre> <p>\u8fd9\u4e2a\u51fd\u6570\u572843\u884c\u5206\u914d\u4e86\u4e00\u4e2a\u9996\u5730\u5740\u4e3apa\u7684\u7269\u7406\u9875\u9762\uff0c\u8fd9\u4e2a\u7269\u7406\u9875\u9762\u8981\u4ee5\u4f55\u79cd\u65b9\u5f0f\u6620\u5c04\u7ed9\u5e94\u7528\u8fdb\u7a0b\u4f7f\u7528\u5462\uff1f\u7b2c44\u884c\u7ed9\u51fa\u4e86pa\u5bf9\u5e94\u7684\u903b\u8f91\u5730\u5740va = g_ufree_page\uff0c\u5e76\u572845\u884c\u5bf9g_ufree_page\u8fdb\u884c\u4e86\u9012\u589e\u64cd\u4f5c\u3002\u6700\u540e\u572846--47\u884c\uff0c\u5c06pa\u6620\u5c04\u7ed9\u4e86va\u5730\u5740\u3002\u8fd9\u4e2a\u8fc7\u7a0b\u4e2d\uff0cg_ufree_page\u662f\u5982\u4f55\u5b9a\u4e49\u7684\u5462\uff1f\u6211\u4eec\u53ef\u4ee5\u627e\u5230\u5b83\u5728kernel/process.c\u6587\u4ef6\u4e2d\u7684\u5b9a\u4e49\uff1a</p> <pre><code> 27 // points to the first free page in our simple heap. added @lab2_2\n28 uint64 g_ufree_page = USER_FREE_ADDRESS_START;\n</code></pre> <p>\u800cUSER_FREE_ADDRESS_START\u7684\u5b9a\u4e49\u5728kernel/memlayout.h\u6587\u4ef6\uff1a</p> <pre><code> 17 // start virtual address (4MB) of our simple heap. added @lab2_2\n18 #define USER_FREE_ADDRESS_START 0x00000000 + PGSIZE * 1024\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u5728\u6211\u4eec\u7684PKE\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u4e2d\uff0c\u5e94\u7528\u7a0b\u5e8f\u6267\u884c\u8fc7\u7a0b\u4e2d\u6240\u52a8\u6001\u5206\u914d\uff08\u7c7b\u4f3cmalloc\uff09\u7684\u5185\u5b58\u662f\u88ab\u6620\u5c04\u5230USER_FREE_ADDRESS_START\uff084MB\uff09\u5f00\u59cb\u7684\u5730\u5740\u7684\u3002\u90a3\u4e48\uff0c\u8fd9\u91cc\u7684USER_FREE_ADDRESS_START\u5bf9\u5e94\u56fe4.5\u4e2d\u7684\u7528\u6237\u8fdb\u7a0b\u7684\u903b\u8f91\u5730\u5740\u7a7a\u95f4\u7684\u54ea\u4e2a\u90e8\u5206\u5462\uff1f\u8fd9\u4e00\u70b9\u8bf7\u8bfb\u8005\u81ea\u884c\u5224\u65ad\uff0c\u5e76\u5206\u6790\u4e3a\u4ec0\u4e48\u662f4MB\uff0c\u4ee5\u53ca\u80fd\u4e0d\u80fd\u7528\u5176\u4ed6\u7684\u903b\u8f91\u5730\u5740\uff1f</p> <p>\u4ee5\u4e0a\u4e86\u89e3\u4e86\u5185\u5b58\u7684\u5206\u914d\u8fc7\u7a0b\u540e\uff0c\u6211\u4eec\u5c31\u80fd\u591f\u5927\u6982\u4e86\u89e3\u5176\u53cd\u8fc7\u7a0b\u7684\u56de\u6536\u5e94\u8be5\u600e\u4e48\u505a\u4e86\uff0c\u5927\u6982\u5206\u4e3a\u4ee5\u4e0b\u6b65\u9aa4\uff1a</p> <ul> <li>\u627e\u5230\u4e00\u4e2a\u7ed9\u5b9ava\u6240\u5bf9\u5e94\u7684\u9875\u8868\u9879PTE\uff08\u67e5\u627e4.1.4\u8282\uff0c\u770b\u54ea\u4e2a\u51fd\u6570\u80fd\u6ee1\u8db3\u6b64\u9700\u6c42\uff09\uff1b</li> <li>\u5982\u679c\u627e\u5230\uff08\u8fc7\u6ee4\u627e\u4e0d\u5230\u7684\u60c5\u5f62\uff09\uff0c\u901a\u8fc7\u8be5PTE\u7684\u5185\u5bb9\u5f97\u77e5va\u6240\u5bf9\u5e94\u7269\u7406\u9875\u7684\u9996\u5730\u5740pa\uff1b</li> <li>\u56de\u6536pa\u5bf9\u5e94\u7684\u7269\u7406\u9875\uff0c\u5e76\u5c06PTE\u4e2d\u7684Valid\u4f4d\u7f6e\u4e3a0\u3002</li> </ul> <p>\u672c\u5b9e\u9a8c\u82e5\u51fa\u73b0M\u6a21\u5f0f\u7684\u975e\u6cd5\u5f02\u5e38<code>unexpected exception happened in M-mode.</code>\uff0c\u8bf4\u660e<code>naive_malloc</code>\u5bf9\u5e94\u7684\u7cfb\u7edf\u8c03\u7528\u672a\u8fd4\u56de\u6b63\u786e\u7684\u903b\u8f91\u5730\u5740\u3002\u89e3\u51b3\u95ee\u9898\u7684\u65b9\u6cd5\u662f\uff0c\u56de\u5934\u68c0\u67e5\u4f60\u5728lab1_1\u4e2d\u6240\u505a\u7684\u7b54\u6848\uff01\uff1a</p> <p>\u5b9e\u9a8c\u5b8c\u6bd5\u540e\uff0c\u8bb0\u5f97\u63d0\u4ea4\u4fee\u6539\uff08\u547d\u4ee4\u884c\u4e2d-m\u540e\u7684\u5b57\u7b26\u4e32\u53ef\u81ea\u884c\u786e\u5b9a\uff09\uff0c\u4ee5\u4fbf\u5728\u540e\u7eed\u5b9e\u9a8c\u4e2d\u7ee7\u627flab2_2\u4e2d\u6240\u505a\u7684\u5de5\u4f5c\uff1a</p> <pre><code>$ git commit -a -m \"my work on lab2_2 is done.\"\n</code></pre> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter4_memory/#44-lab2_3","title":"4.4 lab2_3 \u7f3a\u9875\u5f02\u5e38","text":""},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter4_memory/#_10","title":"\u7ed9\u5b9a\u5e94\u7528","text":"<ul> <li>user/app_sum_sequence.c</li> </ul> <pre><code>  1 /*\n  2  * The application of lab2_3.\n  3  */\n4\n5 #include \"user_lib.h\"\n6 #include \"util/types.h\"\n7\n8 //\n9 // compute the summation of an arithmetic sequence. for a given \"n\", compute\n10 // result = n + (n-1) + (n-2) + ... + 0\n11 // sum_sequence() calls itself recursively till 0. The recursive call, however,\n12 // may consume more memory (from stack) than a physical 4KB page, leading to a page fault.\n13 // PKE kernel needs to improved to handle such page fault by expanding the stack.\n14 //\n15 uint64 sum_sequence(uint64 n) {\n16   if (n == 0)\n17     return 0;\n18   else\n19     return sum_sequence( n-1 ) + n;\n20 }\n21\n22 int main(void) {\n23   // we need a large enough \"n\" to trigger pagefaults in the user stack\n24   uint64 n = 1000;\n25\n26   printu(\"Summation of an arithmetic sequence from 0 to %ld is: %ld \\n\", n, sum_sequence(1000) );\n27   exit(0);\n28 }\n</code></pre> <p>\u7ed9\u5b9a\u4e00\u4e2a\u9012\u589e\u7684\u7b49\u5dee\u6570\u5217\uff1a<code>0, 1, 2, ..., n</code>\uff0c\u5982\u4f55\u6c42\u8be5\u6570\u5217\u7684\u548c\uff1f\u4ee5\u4e0a\u7684\u5e94\u7528\u7ed9\u51fa\u4e86\u5b83\u7684\u9012\u5f52\uff08recursive\uff09\u89e3\u6cd5\u3002\u901a\u8fc7\u5b9a\u4e49\u4e00\u4e2a\u51fd\u6570sum_sequence(n)\uff0c\u5c06\u6c42\u548c\u95ee\u9898\u8f6c\u6362\u4e3asum_sequence(n-1) + n\u7684\u95ee\u9898\u3002\u95ee\u9898\u4e2dn\u4f9d\u6b21\u9012\u51cf\uff0c\u76f4\u81f3\u4e3a0\u65f6\u4ee4sum_sequence(0)=0\u3002</p> <ul> <li>\uff08\u5148\u63d0\u4ea4lab2_2\u7684\u7b54\u6848\uff0c\u7136\u540e\uff09\u5207\u6362\u5230lab2_3\u3001\u7ee7\u627flab2_2\u53ca\u4ee5\u524d\u6240\u505a\u4fee\u6539\uff0c\u5e76make\u540e\u7684\u76f4\u63a5\u8fd0\u884c\u7ed3\u679c\uff1a</li> </ul> <pre><code>//\u5207\u6362\u5230lab2_3\n$ git checkout lab2_3_pagefault\n\n//\u7ee7\u627flab2_2\u4ee5\u53ca\u4e4b\u524d\u7684\u7b54\u6848\n$ git merge lab2_2_allocatepage -m \"continue to work on lab2_3\"\n//\u91cd\u65b0\u6784\u9020\n$ make clean; make\n\n//\u8fd0\u884c\u6784\u9020\u7ed3\u679c\n$ spike ./obj/riscv-pke ./obj/app_sum_sequence\nIn m_start, hartid:0\nHTIF is available!\n(Emulated) memory size: 2048 MB\nEnter supervisor mode...\nPKE kernel start 0x0000000080000000, PKE kernel end: 0x000000008000e000, PKE kernel size: 0x000000000000e000 .\nfree physical memory address: [0x000000008000e000, 0x0000000087ffffff]\nkernel memory manager is initializing ...\nKERN_BASE 0x0000000080000000\nphysical address of _etext is: 0x0000000080004000\nkernel page table is on\nUser application is loading.\nuser frame 0x0000000087fbc000, user stack 0x000000007ffff000, user kstack 0x0000000087fbb000\nApplication: ./obj/app_sum_sequence\nApplication program entry point (virtual address): 0x0000000000010096\nSwitching to user mode...\nhandle_page_fault: 000000007fffdff8\nYou need to implement the operations that actually handle the page fault in lab2_3.\n\nSystem is shutting down with exit code -1.\n</code></pre> <p>\u4ee5\u4e0a\u6267\u884c\u7ed3\u679c\uff0c\u4e3a\u4ec0\u4e48\u4f1a\u51fa\u73b0handle_page_fault\u5462\uff1f\u8fd9\u5c31\u8ddf\u6211\u4eec\u7ed9\u51fa\u7684\u5e94\u7528\u7a0b\u5e8f\uff08\u9012\u5f52\u6c42\u89e3\u7b49\u5dee\u6570\u5217\u7684\u548c\uff09\u6709\u5173\u4e86\u3002</p> <p>\u9012\u5f52\u89e3\u6cd5\u7684\u7279\u70b9\u662f\uff0c\u51fd\u6570\u8c03\u7528\u7684\u8def\u5f84\u4f1a\u88ab\u5b8c\u6574\u5730\u4fdd\u5b58\u5728\u6808\uff08stack\uff09\u4e2d\uff0c\u4e5f\u5c31\u662f\u8bf4\u51fd\u6570\u7684\u4e0b\u4e00\u6b21\u8c03\u7528\u4f1a\u5c06\u4e0a\u6b21\u4e00\u8c03\u7528\u7684\u73b0\u573a\uff08\u5305\u62ec\u53c2\u6570\uff09\u538b\u6808\uff0c\u76f4\u5230n=0\u65f6\u4f9d\u6b21\u8fd4\u56de\u5230\u6700\u5f00\u59cb\u7ed9\u5b9a\u7684n\u503c\uff0c\u4ece\u800c\u5f97\u5230\u6700\u7ec8\u7684\u8ba1\u7b97\u7ed3\u679c\u3002\u663e\u7136\uff0c\u5728\u4ee5\u4e0a\u8ba1\u7b97\u7b49\u5dee\u6570\u5217\u7684\u548c\u7684\u7a0b\u5e8f\u4e2d\uff0cn\u503c\u7ed9\u5f97\u8d8a\u5927\uff0c\u5c31\u4f1a\u5bfc\u81f4\u8d8a\u6df1\u7684\u6808\uff0c\u800c\u6808\u8d8a\u6df1\u9700\u8981\u7684\u5185\u5b58\u7a7a\u95f4\u4e5f\u5c31\u8d8a\u591a\u3002</p> <p>\u901a\u8fc74.1.3\u8282\u4e2d\u5bf9\u7528\u6237\u8fdb\u7a0b\u903b\u8f91\u5730\u5740\u7a7a\u95f4\u7684\u8ba8\u8bba\uff0c\u4ee5\u53ca\u56fe4.5\u7684\u56fe\u793a\uff0c\u6211\u4eec\u77e5\u9053\u5e94\u7528\u7a0b\u5e8f\u6700\u5f00\u59cb\u88ab\u8f7d\u5165\uff08\u5e76\u88c5\u914d\u4e3a\u7528\u6237\u8fdb\u7a0b\uff09\u65f6\uff0c\u5b83\u7684\u7528\u6237\u6001\u6808\u7a7a\u95f4\uff08\u6808\u5e95\u57280x7ffff000\uff0c\u5373USER_STACK_TOP\uff09\u4ec5\u67091\u4e2a4KB\u7684\u9875\u9762\u3002\u663e\u7136\uff0c\u53ea\u8981\u4ee5\u4e0a\u7684\u7a0b\u5e8f\u7ed9\u51fa\u7684n\u503c\u201c\u8db3\u591f\u201d\u5927\uff0c\u5c31\u4e00\u5b9a\u4f1a\u201c\u538b\u7206\u201d\u7528\u6237\u6001\u6808\u3002\u800c\u4ee5\u4e0a\u8fd0\u884c\u7ed3\u679c\u4e2d\uff0c\u51fa\u95ee\u9898\u7684\u5730\u65b9\uff08\u5373handle_page_fault\u540e\u51fa\u73b0\u7684\u5730\u5740\uff0c0x7fffdff8\uff09\u4e5f\u6070\u6070\u5728\u7528\u6237\u6001\u6808\u6240\u5bf9\u5e94\u7684\u7a7a\u95f4\u3002</p> <p>\u4ee5\u4e0a\u5206\u6790\u8868\u660e\uff0c\u4e4b\u6240\u4ee5\u8fd0\u884c./obj/app_sum_sequence\u4f1a\u51fa\u73b0\u9519\u8bef\uff08handle_page_fault\uff09\uff0c\u662f\u56e0\u4e3a\u7ed9sum_sequence()\u51fd\u6570\u7684n\u503c\u592a\u5927\uff0c\u628a\u7528\u6237\u6001\u6808\u201c\u538b\u7206\u201d\u4e86\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter4_memory/#_11","title":"\u5b9e\u9a8c\u5185\u5bb9","text":"<p>\u5728PKE\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u4e2d\u5b8c\u5584\u7528\u6237\u6001\u6808\u7a7a\u95f4\u7684\u7ba1\u7406\uff0c\u4f7f\u5f97\u5b83\u80fd\u591f\u6b63\u786e\u5904\u7406\u7528\u6237\u8fdb\u7a0b\u7684\u201c\u538b\u6808\u201d\u8bf7\u6c42\u3002</p> <p>\u5b9e\u9a8c\u5b8c\u6210\u540e\u7684\u8fd0\u884c\u7ed3\u679c\uff1a</p> <pre><code>$ spike ./obj/riscv-pke ./obj/app_sum_sequence\nIn m_start, hartid:0\nHTIF is available!\n(Emulated) memory size: 2048 MB\nEnter supervisor mode...\nPKE kernel start 0x0000000080000000, PKE kernel end: 0x000000008000e000, PKE kernel size: 0x000000000000e000 .\nfree physical memory address: [0x000000008000e000, 0x0000000087ffffff]\nkernel memory manager is initializing ...\nKERN_BASE 0x0000000080000000\nphysical address of _etext is: 0x0000000080004000\nkernel page table is on\nUser application is loading.\nuser frame 0x0000000087fbc000, user stack 0x000000007ffff000, user kstack 0x0000000087fbb000\nApplication: ./obj/app_sum_sequence\nApplication program entry point (virtual address): 0x0000000000010096\nSwitching to user mode...\nhandle_page_fault: 000000007fffdff8\nhandle_page_fault: 000000007fffcff8\nhandle_page_fault: 000000007fffbff8\nSummation of an arithmetic sequence from 0 to 1000 is: 500500\nUser exit with code:0.\nSystem is shutting down with exit code 0.\n</code></pre> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter4_memory/#_12","title":"\u5b9e\u9a8c\u6307\u5bfc","text":"<p>\u672c\u5b9e\u9a8c\u9700\u8981\u7ed3\u5408lab1_2\u4e2d\u7684\u5f02\u5e38\u5904\u7406\u77e5\u8bc6\uff0c\u4f46\u8981\u6ce8\u610f\u7684\u662f\uff0clab1_2\u4e2d\u6211\u4eec\u5904\u7406\u7684\u662f\u975e\u6cd5\u6307\u4ee4\u5f02\u5e38\uff0c\u5bf9\u8be5\u5f02\u5e38\u7684\u5904\u7406\u8db3\u591f\u64cd\u4f5c\u7cfb\u7edf\u5c06\u5e94\u7528\u8fdb\u7a0b\u201c\u6740\u6b7b\u201d\u3002\u672c\u5b9e\u9a8c\u4e2d\uff0c\u6211\u4eec\u5904\u7406\u7684\u662f\u7f3a\u9875\u5f02\u5e38\uff08app_sum_sequence.c\u6267\u884c\u7684\u663e\u7136\u662f\u201c\u5408\u6cd5\u201d\u64cd\u4f5c\uff09\uff0c\u4e0d\u80fd\u4e5f\u4e0d\u5e94\u8be5\u5c06\u5e94\u7528\u8fdb\u7a0b\u6740\u6b7b\u3002\u6b63\u786e\u7684\u505a\u6cd5\u662f\uff1a\u9996\u5148\uff0c\u901a\u8fc7\u5f02\u5e38\u7684\u7c7b\u578b\uff0c\u5224\u65ad\u6211\u4eec\u5904\u7406\u7684\u786e\u5b9e\u662f\u7f3a\u9875\u5f02\u5e38\uff1b\u63a5\u4e0b\u6765\uff0c\u5224\u65ad\u53d1\u751f\u7f3a\u9875\u7684\u662f\u4e0d\u662f\u7528\u6237\u6808\u7a7a\u95f4\uff0c\u5982\u679c\u662f\u5219\u5206\u914d\u4e00\u4e2a\u7269\u7406\u9875\u7a7a\u95f4\uff0c\u6700\u540e\u5c06\u8be5\u7a7a\u95f4\u901a\u8fc7vm_map\u201c\u7c98\u201d\u5230\u7528\u6237\u6808\u4e0a\u4ee5\u6269\u5145\u7528\u6237\u6808\u7a7a\u95f4\u3002</p> <p>\u53e6\u5916\uff0clab1_2\u4e2d\u5904\u7406\u7684\u975e\u6cd5\u6307\u4ee4\u5f02\u5e38\u662f\u5728M\u6a21\u5f0f\u4e0b\u5904\u7406\u7684\uff0c\u539f\u56e0\u662f\u6211\u4eec\u6839\u672c\u6ca1\u6709\u5c06\u8be5\u5f02\u5e38\u4ee3\u7406\u7ed9S\u6a21\u5f0f\u3002\u4f46\u662f\uff0c\u5bf9\u4e8e\u672c\u5b9e\u9a8c\u4e2d\u7684\u7f3a\u9875\u5f02\u5e38\u662f\u4e0d\u662f\u4e5f\u662f\u9700\u8981\u5728M\u6a21\u5f0f\u5904\u7406\u5462\uff1f\u6211\u4eec\u5148\u56de\u987e\u4ee5\u4e0bkernel/machine/minit.c\u6587\u4ef6\u4e2d\u7684delegate_traps()\u51fd\u6570\uff1a</p> <pre><code> 55 static void delegate_traps() {\n56   // supports_extension macro is defined in kernel/riscv.h\n57   if (!supports_extension('S')) {\n58     // confirm that our processor supports supervisor mode. abort if it does not.\n59     sprint(\"S mode is not supported.\\n\");\n60     return;\n61   }\n62\n63   // macros used in following two statements are defined in kernel/riscv.h\n64   uintptr_t interrupts = MIP_SSIP | MIP_STIP | MIP_SEIP;\n65   uintptr_t exceptions = (1U &lt;&lt; CAUSE_MISALIGNED_FETCH) | (1U &lt;&lt; CAUSE_FETCH_PAGE_FAULT) |\n66                          (1U &lt;&lt; CAUSE_BREAKPOINT) | (1U &lt;&lt; CAUSE_LOAD_PAGE_FAULT) |\n67                          (1U &lt;&lt; CAUSE_STORE_PAGE_FAULT) | (1U &lt;&lt; CAUSE_USER_ECALL);\n68\n69   // writes 64-bit values (interrupts and exceptions) to 'mideleg' and 'medeleg' (two\n70   // priviledged registers of RV64G machine) respectively.\n71   //\n72   // write_csr and read_csr are macros defined in kernel/riscv.h\n73   write_csr(mideleg, interrupts);\n74   write_csr(medeleg, exceptions);\n75   assert(read_csr(mideleg) == interrupts);\n76   assert(read_csr(medeleg) == exceptions);\n77 }\n</code></pre> <p>\u800c\u5728\u672c\u5b9e\u9a8c\u7684\u5e94\u7528\u4e2d\uff0c\u4ea7\u751f\u7f3a\u9875\u5f02\u5e38\u7684\u672c\u8d28\u8fd8\u662f\u5e94\u7528\u5f80\u672a\u88ab\u6620\u5c04\u7684\u5185\u5b58\u7a7a\u95f4\u201c\u5199\u201d\uff08\u4ee5\u53ca\u540e\u7eed\u7684\u8bbf\u95ee\uff09\u6240\u5bfc\u81f4\u7684\uff0c\u6240\u4ee5CAUSE_STORE_PAGE_FAULT\u662f\u6211\u4eec\u5e94\u8be5\u5173\u6ce8\u7684\u5f02\u5e38\u3002\u901a\u8fc7\u9605\u8bfbdelegate_traps()\u51fd\u6570\uff0c\u6211\u4eec\u770b\u5230\u8be5\u51fd\u6570\u663e\u7136\u5df2\u5c06\u7f3a\u9875\u5f02\u5e38\uff08CAUSE_STORE_PAGE_FAULT\uff09\u4ee3\u7406\u7ed9\u4e86S\u6a21\u5f0f\uff0c\u6240\u4ee5\uff0c\u63a5\u4e0b\u6765\u6211\u4eec\u5c31\u5e94\u9605\u8bfbkernel/strap.c\u6587\u4ef6\u4e2d\u5bf9\u4e8e\u8fd9\u7c7b\u5f02\u5e38\u7684\u5904\u7406\uff1a</p> <pre><code> 52 void handle_user_page_fault(uint64 mcause, uint64 sepc, uint64 stval) {\n53   sprint(\"handle_page_fault: %lx\\n\", stval);\n54   switch (mcause) {\n55     case CAUSE_STORE_PAGE_FAULT:\n56       // TODO (lab2_3): implement the operations that solve the page fault to\n57       // dynamically increase application stack.\n58       // hint: first allocate a new physical page, and then, maps the new page to the\n59       // virtual address that causes the page fault.\n60       panic( \"You need to implement the operations that actually handle the page fault in lab 2_3.\\n\" );\n61\n62       break;\n63     default:\n64       sprint(\"unknown page fault.\\n\");\n65       break;\n66   }\n67 }\n</code></pre> <p>\u8fd9\u91cc\uff0c\u6211\u4eec\u627e\u5230\u4e86\u4e4b\u524d\u8fd0\u884c./obj/app_sum_sequence\u51fa\u9519\u7684\u5730\u65b9\uff0c\u6211\u4eec\u53ea\u9700\u8981\u6539\u6b63\u8fd9\u4e00\u9519\u8bef\u5b9e\u73b0\u7f3a\u9875\u5904\u7406\uff0c\u4f7f\u5f97\u7a0b\u5e8f\u83b7\u5f97\u6b63\u786e\u7684\u8f93\u51fa\u5c31\u597d\u3002\u5b9e\u73b0\u7f3a\u9875\u5904\u7406\u7684\u601d\u8def\u5982\u4e0b\uff1a</p> <ul> <li>\u901a\u8fc7\u8f93\u5165\u7684\u53c2\u6570stval\uff08\u5b58\u653e\u7684\u662f\u53d1\u751f\u7f3a\u9875\u5f02\u5e38\u65f6\uff0c\u7a0b\u5e8f\u60f3\u8981\u8bbf\u95ee\u7684\u903b\u8f91\u5730\u5740\uff09\u5224\u65ad\u7f3a\u9875\u7684\u903b\u8f91\u5730\u5740\u5728\u7528\u6237\u8fdb\u7a0b\u903b\u8f91\u5730\u5740\u7a7a\u95f4\u4e2d\u7684\u4f4d\u7f6e\uff0c\u770b\u662f\u4e0d\u662f\u6bd4USER_STACK_TOP\u5c0f\uff0c\u4e14\u6bd4\u6211\u4eec\u9884\u8bbe\u7684\u53ef\u80fd\u7684\u7528\u6237\u6808\u7684\u6700\u5c0f\u6808\u5e95\u6307\u9488\u8981\u5927\uff08\u8fd9\u91cc\uff0c\u6211\u4eec\u53ef\u4ee5\u7ed9\u7528\u6237\u6808\u7a7a\u95f4\u4e00\u4e2a\u4e0a\u9650\uff0c\u4f8b\u598220\u4e2a4KB\u7684\u9875\u9762\uff09\uff0c\u82e5\u6ee1\u8db3\uff0c\u5219\u4e3a\u5408\u6cd5\u7684\u903b\u8f91\u5730\u5740\uff08\u672c\u4f8b\u4e2d\u4e0d\u5fc5\u5b9e\u73b0\u6b64\u5224\u65ad\uff0c\u9ed8\u8ba4\u903b\u8f91\u5730\u5740\u5408\u6cd5\uff09\u3002</li> <li>\u5206\u914d\u4e00\u4e2a\u7269\u7406\u9875\uff0c\u5c06\u6240\u5206\u914d\u7684\u7269\u7406\u9875\u9762\u6620\u5c04\u5230stval\u6240\u5bf9\u5e94\u7684\u865a\u62df\u5730\u5740\u4e0a\u3002</li> </ul> <p>\u5b9e\u9a8c\u5b8c\u6bd5\u540e\uff0c\u8bb0\u5f97\u63d0\u4ea4\u4fee\u6539\uff08\u547d\u4ee4\u884c\u4e2d-m\u540e\u7684\u5b57\u7b26\u4e32\u53ef\u81ea\u884c\u786e\u5b9a\uff09\uff0c\u4ee5\u4fbf\u5728\u540e\u7eed\u5b9e\u9a8c\u4e2d\u7ee7\u627flab2_3\u4e2d\u6240\u505a\u7684\u5de5\u4f5c\uff1a</p> <pre><code>$ git commit -a -m \"my work on lab2_3 is done.\"\n</code></pre> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter4_memory/#45-lab2_challenge1","title":"4.5 lab2_challenge1 \u590d\u6742\u7f3a\u9875\u5f02\u5e38\uff08\u96be\u5ea6\uff1a\u2605\u2606\u2606\u2606\u2606\uff09","text":""},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter4_memory/#_13","title":"\u7ed9\u5b9a\u5e94\u7528","text":"<ul> <li>user/app_sum_sequence.c</li> </ul> <pre><code> 1    /*\n2  * The application of lab2_4.\n3  * Based on application of lab2_3.\n4  */\n5 6 #include \"user_lib.h\"\n7 #include \"util/types.h\"\n8 9 //\n10    // compute the summation of an arithmetic sequence. for a given \"n\", compute\n11    // result = n + (n-1) + (n-2) + ... + 0\n12    // sum_sequence() calls itself recursively till 0. The recursive call, however,\n13    // may consume more memory (from stack) than a physical 4KB page, leading to a page fault.\n14    // PKE kernel needs to improved to handle such page fault by expanding the stack.\n15    //\n16    uint64 sum_sequence(uint64 n, int *p) {\n17      if (n == 0)\n18        return 0;\n19      else\n20        return *p=sum_sequence( n-1, p+1 ) + n;\n21    }\n22    23    int main(void) {\n24      // FIRST, we need a large enough \"n\" to trigger pagefaults in the user stack\n25      uint64 n = 1024;\n26    27      // alloc a page size array(int) to store the result of every step\n28      // the max limit of the number is 4kB/4 = 1024\n29    30      // SECOND, we use array out of bound to trigger pagefaults in an invalid address\n31      int *ans = (int *)naive_malloc();\n32    33      printu(\"Summation of an arithmetic sequence from 0 to %ld is: %ld \\n\", n, sum_sequence(n+1, ans) );\n34    35      exit(0);\n36    }\n</code></pre> <p>\u7a0b\u5e8f\u601d\u8def\u57fa\u672c\u540clab2_3\u4e00\u81f4\uff0c\u5bf9\u7ed9\u5b9an\u8ba1\u7b970\u5230n\u7684\u548c\uff0c\u4f46\u8981\u6c42\u5c06\u6bcf\u4e00\u6b65\u9012\u5f52\u7684\u7ed3\u679c\u4fdd\u5b58\u5728\u6570\u7ec4ans\u4e2d\u3002\u521b\u5efa\u6570\u7ec4\u65f6\uff0c\u6211\u4eec\u4f7f\u7528\u4e86\u5f53\u524d\u7684malloc\u51fd\u6570\u7533\u8bf7\u4e86\u4e00\u4e2a\u9875\u9762\uff084KB\uff09\u7684\u5927\u5c0f\uff0c\u5bf9\u5e94\u53ef\u4ee5\u5b58\u50a8\u7684\u4e2a\u6570\u4e0a\u9650\u4e3a1024\u3002\u5728\u51fd\u6570\u8c03\u7528\u65f6\uff0c\u6211\u4eec\u8bd5\u56fe\u8ba1\u7b971025\u6c42\u548c\uff0c\u9996\u5148\u7531\u4e8en\u8db3\u591f\u5927\uff0c\u6240\u4ee5\u5728\u51fd\u6570\u9012\u5f52\u6267\u884c\u65f6\u4f1a\u89e6\u53d1\u7528\u6237\u6808\u7684\u7f3a\u9875\uff0c\u4f60\u9700\u8981\u5bf9\u5176\u8fdb\u884c\u6b63\u786e\u5904\u7406\uff0c\u786e\u4fdd\u7a0b\u5e8f\u6b63\u786e\u8fd0\u884c\uff1b\u5176\u6b21\uff0c1025\u5728\u6700\u540e\u4e00\u6b21\u8ba1\u7b97\u65f6\u4f1a\u8bbf\u95ee\u6570\u7ec4\u8d8a\u754c\u5730\u5740\uff0c\u7531\u4e8e\u8be5\u5904\u865a\u62df\u5730\u5740\u5c1a\u672a\u6709\u5bf9\u5e94\u7684\u7269\u7406\u5730\u5740\u6620\u5c04\uff0c\u56e0\u6b64\u5c5e\u4e8e\u975e\u6cd5\u5730\u5740\u7684\u8bbf\u95ee\uff0c\u8fd9\u662f\u4e0d\u88ab\u5141\u8bb8\u7684\uff0c\u5bf9\u4e8e\u8fd9\u79cd\u7f3a\u9875\u5f02\u5e38\uff0c\u5e94\u8be5\u63d0\u793a\u7528\u6237\u5e76\u9000\u51fa\u7a0b\u5e8f\u6267\u884c\u3002\u5982\u4e0a\u7684\u5e94\u7528\u9884\u671f\u8f93\u51fa\u5982\u4e0b\uff1a</p> <pre><code>In m_start, hartid:0\nHTIF is available!\n(Emulated) memory size: 2048 MB\nEnter supervisor mode...\nPKE kernel start 0x0000000080000000, PKE kernel end: 0x000000008000e000, PKE kernel size: 0x000000000000e000 .\nfree physical memory address: [0x000000008000e000, 0x0000000087ffffff] kernel memory manager is initializing ...\nKERN_BASE 0x0000000080000000\nphysical address of _etext is: 0x0000000080004000\nkernel page table is on User application is loading.\nuser frame 0x0000000087fbc000, user stack 0x000000007ffff000, user kstack 0x0000000087fbb000 Application: ./obj/app_sum_sequence\nApplication program entry point (virtual address): 0x00000000000100da\nSwitching to user mode...\nhandle_page_fault: 000000007fffdff8\nhandle_page_fault: 000000007fffcff8\nhandle_page_fault: 000000007fffbff8\nhandle_page_fault: 000000007fffaff8\nhandle_page_fault: 000000007fff9ff8\nhandle_page_fault: 000000007fff8ff8\nhandle_page_fault: 000000007fff7ff8\nhandle_page_fault: 000000007fff6ff8\nhandle_page_fault: 0000000000401000\nthis address is not available!\nSystem is shutting down with exit code -1.\n</code></pre> <p>\u6839\u636e\u7ed3\u679c\u53ef\u4ee5\u770b\u51fa\uff1a\u524d\u516b\u4e2a\u7f3a\u9875\u662f\u7531\u4e8e\u51fd\u6570\u9012\u5f52\u8c03\u7528\u5f15\u8d77\u7684\uff0c\u800c\u6700\u540e\u4e00\u4e2a\u7f3a\u9875\u662f\u5bf9\u52a8\u6001\u7533\u8bf7\u7684\u6570\u7ec4\u8fdb\u884c\u8d8a\u754c\u8bbf\u95ee\u9020\u6210\u7684\uff0c\u8bbf\u95ee\u975e\u6cd5\u5730\u5740\uff0c\u7a0b\u5e8f\u62a5\u9519\u5e76\u9000\u51fa\u3002</p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter4_memory/#_14","title":"\u5b9e\u9a8c\u5185\u5bb9","text":"<p>\u672c\u5b9e\u9a8c\u4e3a\u6311\u6218\u5b9e\u9a8c\uff0c\u57fa\u7840\u4ee3\u7801\u5c06\u7ee7\u627f\u548c\u4f7f\u7528lab2_3\u5b8c\u6210\u540e\u7684\u4ee3\u7801\uff1a</p> <ul> <li>\uff08\u5148\u63d0\u4ea4lab2_3\u7684\u7b54\u6848\uff0c\u7136\u540e\uff09\u5207\u6362\u5230lab2_challenge1_pagefaults\u3001\u7ee7\u627flab2_3\u4e2d\u6240\u505a\u4fee\u6539\uff1a</li> </ul> <pre><code>//\u5207\u6362\u5230lab2_challenge1_pagefault\n$ git checkout lab2_challenge1_pagefaults\n\n//\u7ee7\u627flab2_3\u4ee5\u53ca\u4e4b\u524d\u7684\u7b54\u6848\n$ git merge lab2_3_pagefault -m \"continue to work on lab2_challenge1\"\n</code></pre> <p>\u6ce8\u610f\uff1a\u4e0d\u540c\u4e8e\u57fa\u7840\u5b9e\u9a8c\uff0c\u6311\u6218\u5b9e\u9a8c\u7684\u57fa\u7840\u4ee3\u7801\u5177\u6709\u66f4\u5927\u7684\u4e0d\u5b8c\u6574\u6027\uff0c\u53ef\u80fd\u65e0\u6cd5\u76f4\u63a5\u901a\u8fc7\u6784\u9020\u8fc7\u7a0b\u3002\u540c\u6837\uff0c\u4e0d\u540c\u4e8e\u57fa\u7840\u5b9e\u9a8c\uff0c\u6211\u4eec\u5728\u4ee3\u7801\u4e2d\u4e5f\u5e76\u672a\u4e13\u95e8\u5730\u54ea\u4e9b\u5730\u65b9\u7684\u4ee3\u7801\u9700\u8981\u586b\u5199\uff0c\u54ea\u4e9b\u5730\u65b9\u7684\u4ee3\u7801\u65e0\u987b\u586b\u5199\u3002\u8fd9\u6837\uff0c\u6211\u4eec\u7559\u7ed9\u8bfb\u8005\u66f4\u5927\u7684\u201c\u60f3\u8c61\u7a7a\u95f4\u201d\u3002</p> <ul> <li>\u672c\u5b9e\u9a8c\u7684\u5177\u4f53\u8981\u6c42\u4e3a\uff1a\u901a\u8fc7\u4fee\u6539PKE\u5185\u6838\uff08\u5305\u62ecmachine\u6587\u4ef6\u5939\u4e0b\u7684\u4ee3\u7801\uff09\uff0c\u4f7f\u5f97\u5bf9\u4e8e\u4e0d\u540c\u60c5\u51b5\u7684\u7f3a\u9875\u5f02\u5e38\u8fdb\u884c\u4e0d\u540c\u7684\u5904\u7406\u3002</li> <li>\u6587\u4ef6\u540d\u89c4\u8303\uff1a\u9700\u8981\u5305\u542b\u8def\u5f84\uff0c\u5982\u679c\u662f\u7528\u6237\u6e90\u7a0b\u5e8f\u53d1\u751f\u7684\u9519\u8bef\uff0c\u8def\u5f84\u4e3a\u76f8\u5bf9\u8def\u5f84\uff0c\u5982\u679c\u662f\u8c03\u7528\u7684\u6807\u51c6\u5e93\u5185\u53d1\u751f\u7684\u9519\u8bef\uff0c\u8def\u5f84\u4e3a\u7edd\u5bf9\u8def\u5f84\u3002</li> </ul> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter4_memory/#_15","title":"\u5b9e\u9a8c\u6307\u5bfc","text":"<ul> <li>\u4f60\u5bf9\u5185\u6838\u4ee3\u7801\u7684\u4fee\u6539\u53ef\u80fd\u5305\u542b\u4ee5\u4e0b\u5185\u5bb9\uff1a</li> <li>\u4fee\u6539\u8fdb\u7a0b\u7684\u6570\u636e\u7ed3\u6784\u4ee5\u5bf9\u865a\u62df\u5730\u5740\u7a7a\u95f4\u8fdb\u884c\u76d1\u63a7\u3002</li> <li>\u4fee\u6539kernel/strap.c\u4e2d\u7684\u5f02\u5e38\u5904\u7406\u51fd\u6570\u3002\u5bf9\u4e8e\u5408\u7406\u7684\u7f3a\u9875\u5f02\u5e38\uff0c\u6269\u5927\u5185\u6838\u6808\u5927\u5c0f\u5e76\u4e3a\u5176\u6620\u5c04\u7269\u7406\u5757\uff1b\u5bf9\u4e8e\u975e\u6cd5\u5730\u5740\u7f3a\u9875\uff0c\u62a5\u9519\u5e76\u9000\u51fa\u7a0b\u5e8f\u3002</li> </ul> <p>\u6ce8\u610f\uff1a\u5b8c\u6210\u6311\u6218\u4efb\u52a1\u5bf9\u4e24\u79cd\u7f3a\u9875\u8fdb\u884c\u5b9e\u73b0\u540e\uff0c\u8bfb\u8005\u53ef\u5bf9\u4efb\u610fn\u9a8c\u8bc1\uff0c\u7531\u4e8e\u76ee\u524d\u7684malloc\u51fd\u6570\u662f\u7533\u8bf7\u4e00\u4e2a\u9875\u9762\u5927\u5c0f\uff0c\u6240\u4ee5\u5bf9\u4e8en&lt;=1024\uff0c\u53ea\u4f1a\u4ea7\u751f\u7b2c\u4e00\u79cd\u7f3a\u9875\u5e76\u6253\u5370\u6b63\u786e\u7684\u8ba1\u7b97\u7ed3\u679c\uff1b\u5bf9\u4e8en&gt;=1025\uff0c\u5219\u4f1a\u56e0\u4e3a\u8bbf\u95ee\u975e\u6cd5\u5730\u5740\u9000\u51fa\uff0c\u8bf7\u8bfb\u8005\u9a8c\u8bc1\u81ea\u5df1\u7684\u5b9e\u73b0\u3002</p> <p>\u53e6\u5916\uff0c\u540e\u7eed\u7684\u57fa\u7840\u5b9e\u9a8c\u4ee3\u7801\u5e76\u4e0d\u4f9d\u8d56\u6311\u6218\u5b9e\u9a8c\uff0c\u6240\u4ee5\u8bfb\u8005\u53ef\u81ea\u884c\u51b3\u5b9a\u662f\u5426\u5c06\u81ea\u5df1\u7684\u5de5\u4f5c\u63d0\u4ea4\u5230\u672c\u5730\u4ee3\u7801\u4ed3\u5e93\u4e2d\uff08\u5f53\u7136\uff0c\u63d0\u4ea4\u5230\u672c\u5730\u4ed3\u5e93\u662f\u4e2a\u597d\u4e60\u60ef\uff0c\u81f3\u5c11\u80fd\u4fdd\u5b58\u81ea\u5df1\u7684\u201c\u4f5c\u54c1\u201d\uff09\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter4_memory/#46-lab2_challenge2","title":"4.6 lab2_challenge2 \u5806\u7a7a\u95f4\u7ba1\u7406 \uff08\u96be\u5ea6\uff1a\u2605\u2605\u2605\u2605\u2606\uff09","text":""},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter4_memory/#_16","title":"\u7ed9\u5b9a\u5e94\u7528","text":"<ul> <li>user/app_singlepageheap.c</li> </ul> <pre><code>  1 /*\n  2  * Below is the given application for lab2_challenge2_singlepageheap.\n  3  * This app performs malloc memory.\n  4  */\n5\n6 #include \"user_lib.h\"\n7 //#include \"util/string.h\"\n8\n9 typedef unsigned long long uint64;\n10\n11 char* strcpy(char* dest, const char* src) {\n12   char* d = dest;\n13   while ((*d++ = *src++))\n14     ;\n15   return dest;\n16 }\n17 int main(void) {\n18\n19   char str[20] = \"hello, world!!!\";\n20   char *m = (char *)better_malloc(100);\n21   char *p = (char *)better_malloc(50);\n22   if((uint64)p - (uint64)m &gt; 512 ){\n23     printu(\"you need to manage the vm space precisely!\");\n24     exit(-1);\n25   }\n26   better_free((void *)m);\n27\n28   strcpy(p,str);\n29   printu(\"%s\\n\",p);\n30   char *n = (char *)better_malloc(50);\n31\n32   if(m != n)\n33   {\n34     printu(\"your malloc is not complete.\\n\");\n35     exit(-1);\n36   }\n37 //  else{\n38 //    printu(\"0x%lx 0x%lx\\n\", m, n);\n39 //  }\n40   exit(0);\n41   return 0;\n42 }\n</code></pre> <p>\u4ee5\u4e0a\u7a0b\u5e8f\u5148\u5229\u7528better_malloc\u5206\u522b\u7533\u8bf7100\u548c50\u4e2a\u5b57\u8282\u7684\u4e00\u4e2a\u7269\u7406\u9875\u7684\u5185\u5b58\uff0c\u7136\u540e\u4f7f\u7528better_free\u91ca\u653e\u6389100\u4e2a\u5b57\u8282\uff0c\u541150\u4e2a\u5b57\u8282\u4e2d\u590d\u5236\u4e00\u4e32\u5b57\u7b26\u4e32\uff0c\u8fdb\u884c\u8f93\u51fa\u3002\u539f\u672c\u7684pke\u4e2dmalloc\u7684\u5b9e\u73b0\u662f\u975e\u5e38\u7b80\u5316\u7684\uff08\u4e00\u6b21\u76f4\u63a5\u5206\u914d\u4e00\u4e2a\u9875\u9762\uff09\uff0c\u4f60\u7684\u6311\u6218\u4efb\u52a1\u662f\u4fee\u6539\u5185\u6838(\u5305\u62ecmachine\u6587\u4ef6\u5939\u4e0b)\u7684\u4ee3\u7801\uff0c\u4f7f\u5f97\u5e94\u7528\u7a0b\u5e8f\u7684malloc\u80fd\u591f\u5728\u4e00\u4e2a\u7269\u7406\u9875\u4e2d\u5206\u914d\uff0c\u5e76\u5bf9\u5404\u7533\u8bf7\u5757\u8fdb\u884c\u5408\u7406\u7684\u7ba1\u7406\uff0c\u5982\u4e0a\u9762\u7684\u5e94\u7528\u9884\u671f\u8f93\u51fa\u5982\u4e0b\uff1a</p> <pre><code>In m_start, hartid:0\nHTIF is available!\n(Emulated) memory size: 2048 MB\nEnter supervisor mode...\nPKE kernel start 0x0000000080000000, PKE kernel end: 0x0000000080008000, PKE kernel size: 0x0000000000008000 .\nfree physical memory address: [0x0000000080008000, 0x0000000087ffffff]\nkernel memory manager is initializing ...\nKERN_BASE 0x0000000080000000\nphysical address of _etext is: 0x0000000080005000\nkernel page table is on\nUser application is loading.\nuser frame 0x0000000087fbc000, user stack 0x000000007ffff000, user kstack 0x0000000087fbb000\nApplication: obj/app_singlepageheap\nApplication program entry point (virtual address): 0x000000000001008a\nSwitch to user mode...\nhello, world!!!\nUser exit with code:0.\nSystem is shutting down with exit code 0.\n</code></pre> <p>\u901a\u8fc7\u5e94\u7528\u7a0b\u5e8f\u548c\u5bf9\u5e94\u7684\u9884\u671f\u7ed3\u679c\u53ef\u4ee5\u770b\u51fa\uff1a\u4e24\u6b21\u7533\u8bf7\u7684\u7a7a\u95f4\u5728\u540c\u4e00\u9875\u9762\uff0c\u5e76\u4e14\u91ca\u653e\u7b2c\u4e00\u5757\u65f6\uff0c\u4e0d\u4f1a\u91ca\u653e\u6574\u4e2a\u9875\u9762\uff0c\u6240\u4ee5\u9700\u8981\u4f60\u8bbe\u8ba1\u5408\u9002\u7684\u6570\u636e\u7ed3\u6784\u5bf9\u5404\u5757\u8fdb\u884c\u7ba1\u7406\uff0c\u4f7f\u5f97better_malloc\u7533\u8bf7\u7684\u7a7a\u95f4\u66f4\u52a0\u201c\u7d27\u51d1\u201d\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter4_memory/#_17","title":"\u5b9e\u9a8c\u5185\u5bb9","text":"<p>\u672c\u5b9e\u9a8c\u4e3a\u6311\u6218\u5b9e\u9a8c\uff0c\u57fa\u7840\u4ee3\u7801\u5c06\u7ee7\u627f\u548c\u4f7f\u7528lab2_challenge1\u5b8c\u6210\u540e\u7684\u4ee3\u7801\uff1a</p> <ul> <li>\uff08\u5148\u63d0\u4ea4lab2_3\u7684\u7b54\u6848\uff0c\u7136\u540e\uff09\u5207\u6362\u5230lab2_challenge2\u3001\u7ee7\u627flab2_3\u4e2d\u6240\u505a\u4fee\u6539\uff1a</li> </ul> <pre><code>//\u5207\u6362\u5230lab2_challenge2_singlepageheap\n$ git checkout lab2_challenge2_singlepageheap\n\n//\u7ee7\u627flab2_challenge1\u4ee5\u53ca\u4e4b\u524d\u7684\u7b54\u6848\n$ git merge lab2_3_pagefault -m \"continue to work on lab2_challenge2\"\n</code></pre> <p>\u6ce8\u610f\uff1a\u4e0d\u540c\u4e8e\u57fa\u7840\u5b9e\u9a8c\uff0c\u6311\u6218\u5b9e\u9a8c\u7684\u57fa\u7840\u4ee3\u7801\u5177\u6709\u66f4\u5927\u7684\u4e0d\u5b8c\u6574\u6027\uff0c\u53ef\u80fd\u65e0\u6cd5\u76f4\u63a5\u901a\u8fc7\u6784\u9020\u8fc7\u7a0b\u3002\u540c\u6837\uff0c\u4e0d\u540c\u4e8e\u57fa\u7840\u5b9e\u9a8c\uff0c\u6211\u4eec\u5728\u4ee3\u7801\u4e2d\u4e5f\u5e76\u672a\u4e13\u95e8\u5730\u54ea\u4e9b\u5730\u65b9\u7684\u4ee3\u7801\u9700\u8981\u586b\u5199\uff0c\u54ea\u4e9b\u5730\u65b9\u7684\u4ee3\u7801\u65e0\u987b\u586b\u5199\u3002\u8fd9\u6837\uff0c\u6211\u4eec\u7559\u7ed9\u8bfb\u8005\u66f4\u5927\u7684\u201c\u60f3\u8c61\u7a7a\u95f4\u201d\u3002</p> <ul> <li>\u672c\u5b9e\u9a8c\u7684\u5177\u4f53\u8981\u6c42\u4e3a\uff1a\u901a\u8fc7\u4fee\u6539PKE\u5185\u6838\uff08\u5305\u62ecmachine\u6587\u4ef6\u4e0b\u7684\u4ee3\u7801\uff09\uff0c\u5b9e\u73b0\u4f18\u5316\u540e\u7684malloc\u51fd\u6570\uff0c\u4f7f\u5f97\u5e94\u7528\u7a0b\u5e8f\u4e24\u6b21\u7533\u8bf7\u5757\u5728\u540c\u4e00\u9875\u9762\uff0c\u5e76\u4e14\u80fd\u591f\u6b63\u5e38\u8f93\u51fa\u5b58\u5165\u7b2c\u4e8c\u5757\u4e2d\u7684\u5b57\u7b26\u4e32\"hello world\"\u3002</li> <li>\u6587\u4ef6\u540d\u89c4\u8303\uff1a\u9700\u8981\u5305\u542b\u8def\u5f84\uff0c\u5982\u679c\u662f\u7528\u6237\u6e90\u7a0b\u5e8f\u53d1\u751f\u7684\u9519\u8bef\uff0c\u8def\u5f84\u4e3a\u76f8\u5bf9\u8def\u5f84\uff0c\u5982\u679c\u662f\u8c03\u7528\u7684\u6807\u51c6\u5e93\u5185\u53d1\u751f\u7684\u9519\u8bef\uff0c\u8def\u5f84\u4e3a\u7edd\u5bf9\u8def\u5f84\u3002</li> </ul> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter4_memory/#_18","title":"\u5b9e\u9a8c\u6307\u5bfc","text":"<ul> <li> <p>\u4e3a\u5b8c\u6210\u8be5\u6311\u6218\uff0c\u4f60\u9700\u8981\u5bf9\u8fdb\u7a0b\u7684\u865a\u62df\u5730\u5740\u7a7a\u95f4\u8fdb\u884c\u7ba1\u7406\uff0c\u5efa\u8bae\u53c2\u8003Linux\u7684\u5185\u5b58\u5206\u914d\u7b56\u7565\u4ece\u800c\u5b9e\u73b0malloc\u3002</p> </li> <li> <p>\u4f60\u5bf9\u5185\u6838\u4ee3\u7801\u7684\u4fee\u6539\u53ef\u80fd\u5305\u542b\u4ee5\u4e0b\u5185\u5bb9\uff1a</p> </li> <li> <p>\u589e\u52a0\u5185\u5b58\u63a7\u5236\u5757\u6570\u636e\u7ed3\u6784\u5bf9\u5206\u914d\u7684\u5185\u5b58\u5757\u8fdb\u884c\u7ba1\u7406\u3002</p> </li> <li> <p>\u4fee\u6539process\u7684\u6570\u636e\u7ed3\u6784\u4ee5\u6269\u5c55\u5bf9\u865a\u62df\u5730\u5740\u7a7a\u95f4\u7684\u7ba1\u7406\uff0c\u540e\u7eed\u5bf9\u4e8eheap\u7684\u6269\u5c55\uff0c\u9700\u8981\u5bf9\u65b0\u589e\u7684\u865a\u62df\u5730\u5740\u6dfb\u52a0\u5bf9\u5e94\u7684\u7269\u7406\u5730\u5740\u6620\u5c04\u3002</p> </li> <li> <p>\u8bbe\u8ba1\u51fd\u6570\u5bf9\u8fdb\u7a0b\u7684\u865a\u62df\u5730\u5740\u7a7a\u95f4\u8fdb\u884c\u7ba1\u7406\uff0c\u501f\u52a9\u4ee5\u4e0a\u5185\u5bb9\u5177\u4f53\u5b9e\u73b0heap\u6269\u5c55\u3002</p> </li> <li> <p>\u8bbe\u8ba1malloc\u51fd\u6570\u548cfree\u51fd\u6570\u5bf9\u5185\u5b58\u5757\u8fdb\u884c\u7ba1\u7406\u3002</p> </li> </ul> <p>\u6ce8\u610f\uff1a\u672c\u6311\u6218\u7684\u521b\u65b0\u601d\u8def\u53ca\u96be\u70b9\u5c31\u5728\u4e8e\u5206\u914d\u548c\u56de\u6536\u7b56\u7565\u7684\u8bbe\u8ba1\uff08\u5bf9\u5e94malloc\u548cfree\uff09\uff0c\u8bfb\u8005\u5e94\u540c\u65f6\u601d\u8003\u4e24\u4e2a\u51fd\u6570\u5982\u4f55\u5b9e\u73b0\uff0c\u57fa\u4e8e\u7d27\u51d1\u6027\u548c\u9ad8\u6548\u7387\u7684\u8bbe\u8ba1\u76ee\u6807\uff0c\u8bbe\u8ba1\u81ea\u5df1\u8ba4\u4e3a\u9ad8\u6548\u7684\u5206\u914d\u7b56\u7565\u3002\u5b8c\u6210\u8bbe\u8ba1\u540e\uff0c\u8bf7\u8bfb\u8005\u53e6\u5916\u7f16\u5199\u5e94\u7528\uff0c\u8bbe\u8ba1\u4e0d\u540c\u573a\u666f\u4f7f\u7528better_malloc\u548cbetter_free\u51fd\u6570\uff0c\u9a8c\u8bc1\u6311\u6218\u76ee\u6807\u4ee5\u53ca\u5bf9\u81ea\u5df1\u5b9e\u73b0\u8fdb\u884c\u68c0\u6d4b\u3002</p> <p>\u53e6\u5916\uff0c\u540e\u7eed\u7684\u57fa\u7840\u5b9e\u9a8c\u4ee3\u7801\u5e76\u4e0d\u4f9d\u8d56\u6311\u6218\u5b9e\u9a8c\uff0c\u6240\u4ee5\u8bfb\u8005\u53ef\u81ea\u884c\u51b3\u5b9a\u662f\u5426\u5c06\u81ea\u5df1\u7684\u5de5\u4f5c\u63d0\u4ea4\u5230\u672c\u5730\u4ee3\u7801\u4ed3\u5e93\u4e2d\uff08\u5f53\u7136\uff0c\u63d0\u4ea4\u5230\u672c\u5730\u4ed3\u5e93\u662f\u4e2a\u597d\u4e60\u60ef\uff0c\u81f3\u5c11\u80fd\u4fdd\u5b58\u81ea\u5df1\u7684\u201c\u4f5c\u54c1\u201d\uff09\u3002</p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter5_process/","title":"Chapter5 process","text":""},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter5_process/#3","title":"\u7b2c\u4e94\u7ae0\uff0e\u5b9e\u9a8c3\uff1a\u8fdb\u7a0b\u7ba1\u7406","text":""},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter5_process/#_1","title":"\u76ee\u5f55","text":"<ul> <li>5.1 \u5b9e\u9a8c3\u7684\u57fa\u7840\u77e5\u8bc6 </li> <li>5.1.1 \u591a\u4efb\u52a1\u73af\u5883\u4e0b\u8fdb\u7a0b\u7684\u5c01\u88c5</li> <li>5.1.2 \u8fdb\u7a0b\u7684\u6362\u5165\u4e0e\u6362\u51fa</li> <li>5.1.3 \u5c31\u7eea\u8fdb\u7a0b\u7684\u7ba1\u7406\u4e0e\u8c03\u5ea6</li> <li>5.2 lab3_1 \u8fdb\u7a0b\u521b\u5efa\uff08fork\uff09</li> <li>\u7ed9\u5b9a\u5e94\u7528</li> <li>\u5b9e\u9a8c\u5185\u5bb9</li> <li>\u5b9e\u9a8c\u6307\u5bfc</li> <li>5.3 lab3_2 \u8fdb\u7a0byield </li> <li>\u7ed9\u5b9a\u5e94\u7528</li> <li>\u5b9e\u9a8c\u5185\u5bb9</li> <li>\u5b9e\u9a8c\u6307\u5bfc</li> <li>5.4 lab3_3 \u5faa\u73af\u8f6e\u8f6c\u8c03\u5ea6 </li> <li>\u7ed9\u5b9a\u5e94\u7528</li> <li>\u5b9e\u9a8c\u5185\u5bb9</li> <li>\u5b9e\u9a8c\u6307\u5bfc</li> <li>5.5 lab3_challenge1 \u8fdb\u7a0b\u7b49\u5f85\u548c\u6570\u636e\u6bb5\u590d\u5236\uff08\u96be\u5ea6\uff1a\u2605\u2605\u2606\u2606\u2606\uff09 </li> <li>\u7ed9\u5b9a\u5e94\u7528</li> <li>\u5b9e\u9a8c\u5185\u5bb9</li> <li>\u5b9e\u9a8c\u6307\u5bfc</li> <li>5.6 lab3_challenge2 \u5b9e\u73b0\u4fe1\u53f7\u91cf\uff08\u96be\u5ea6\uff1a\u2605\u2605\u2605\u2606\u2606\uff09 </li> <li>\u7ed9\u5b9a\u5e94\u7528</li> <li>\u5b9e\u9a8c\u5185\u5bb9</li> <li>\u5b9e\u9a8c\u6307\u5bfc</li> </ul>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter5_process/#51-3","title":"5.1 \u5b9e\u9a8c3\u7684\u57fa\u7840\u77e5\u8bc6","text":"<p>\u5b8c\u6210\u4e86\u5b9e\u9a8c1\u548c\u5b9e\u9a8c2\u7684\u8bfb\u8005\uff0c\u5e94\u8be5\u5bf9PKE\u5b9e\u9a8c\u4e2d\u7684\u201c\u8fdb\u7a0b\u201d\u4e0d\u4f1a\u592a\u964c\u751f\u3002\u56e0\u4e3a\u5b9e\u9645\u4e0a\uff0c\u6211\u4eec\u4ece\u6700\u5f00\u59cb\u7684lab1_1\u5f00\u59cb\u5c31\u6709\u4e86\u8fdb\u7a0b\u7ed3\u6784\uff08struct process\uff09\uff0c\u53ea\u662f\u5728\u4e4b\u524d\u7684\u5b9e\u9a8c\u4e2d\uff0c\u8fdb\u7a0b\u7ed3\u6784\u4e2d\u6700\u91cd\u8981\u7684\u6210\u5458\u662ftrapframe\u548ckstack\uff0c\u5b83\u4eec\u5206\u522b\u7528\u6765\u8bb0\u5f55\u7cfb\u7edf\u8fdb\u5165S\u6a21\u5f0f\u524d\u7684\u8fdb\u7a0b\u4e0a\u4e0b\u6587\u4ee5\u53ca\u4f5c\u4e3a\u8fdb\u5165S\u6a21\u5f0f\u540e\u7684\u64cd\u4f5c\u7cfb\u7edf\u6808\u3002\u5728\u5b9e\u9a8c3\uff0c\u6211\u4eec\u5c06\u8fdb\u5165\u591a\u4efb\u52a1\u73af\u5883\uff0c\u5b8c\u6210PKE\u5b9e\u9a8c\u73af\u5883\u4e0b\u7684\u8fdb\u7a0b\u521b\u5efa\u3001\u6362\u5165\u6362\u51fa\uff0c\u4ee5\u53ca\u8fdb\u7a0b\u8c03\u5ea6\u76f8\u5173\u5b9e\u9a8c\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter5_process/#511","title":"5.1.1 \u591a\u4efb\u52a1\u73af\u5883\u4e0b\u8fdb\u7a0b\u7684\u5c01\u88c5","text":"<p>\u5b9e\u9a8c3\u8ddf\u4e4b\u524d\u7684\u4e24\u4e2a\u5b9e\u9a8c\u6700\u5927\u7684\u4e0d\u540c\uff0c\u5728\u4e8e\u5728\u5b9e\u9a8c3\u76843\u4e2a\u57fa\u672c\u5b9e\u9a8c\u4e2d\uff0cPKE\u64cd\u4f5c\u7cfb\u7edf\u5c06\u9700\u8981\u652f\u6301\u591a\u4e2a\u8fdb\u7a0b\u7684\u6267\u884c\u3002\u4e3a\u4e86\u5bf9\u591a\u4efb\u52a1\u73af\u5883\u8fdb\u884c\u652f\u6491\uff0cPKE\u64cd\u4f5c\u7cfb\u7edf\u5b9a\u4e49\u4e86\u4e00\u4e2a\u201c\u8fdb\u7a0b\u6c60\u201d\uff08\u89c1kernel/process.c\u6587\u4ef6\uff09\uff1a</p> <pre><code> 29 // process pool. added @lab3_1\n30 process procs[NPROC];\n</code></pre> <p>\u5b9e\u9645\u4e0a\uff0c\u8fd9\u4e2a\u8fdb\u7a0b\u6c60\u5c31\u662f\u4e00\u4e2a\u5305\u542bNPROC\uff08=32\uff0c\u89c1kernel/process.h\u6587\u4ef6\uff09\u4e2aprocess\u7ed3\u6784\u7684\u6570\u7ec4\u3002</p> <p>\u63a5\u4e0b\u6765\uff0cPKE\u64cd\u4f5c\u7cfb\u7edf\u5bf9\u8fdb\u7a0b\u7684\u7ed3\u6784\u8fdb\u884c\u4e86\u6269\u5145\uff08\u89c1kernel/process.h\u6587\u4ef6\uff09\uff1a</p> <pre><code> 58   // points to a page that contains mapped_regions. below are added @lab3_1\n59   mapped_region *mapped_info;\n60   // next free mapped region in mapped_info\n61   int total_mapped_region;\n62\n63   // process id\n64   uint64 pid;\n65   // process status\n66   int status;\n67   // parent process\n68   struct process_t *parent;\n69   // next queue element\n70   struct process_t *queue_next;\n</code></pre> <ul> <li>\u524d\u4e24\u9879mapped_info\u548ctotal_mapped_region\u7528\u4e8e\u5bf9\u8fdb\u7a0b\u7684\u865a\u62df\u5730\u5740\u7a7a\u95f4\uff08\u4e2d\u7684\u4ee3\u7801\u6bb5\u3001\u5806\u6808\u6bb5\u7b49\uff09\u8fdb\u884c\u8ddf\u8e2a\uff0c\u8fd9\u4e9b\u865a\u62df\u5730\u5740\u7a7a\u95f4\u5728\u8fdb\u7a0b\u521b\u5efa\uff08fork\uff09\u65f6\uff0c\u5c06\u53d1\u6325\u91cd\u8981\u4f5c\u7528\u3002\u540c\u65f6\uff0c\u8fd9\u4e5f\u662flab3_1\u7684\u5185\u5bb9\u3002PKE\u5c06\u8fdb\u7a0b\u53ef\u80fd\u62e5\u6709\u7684\u6bb5\u5206\u4e3a\u4ee5\u4e0b\u51e0\u4e2a\u7c7b\u578b\uff1a</li> </ul> <pre><code> 34 enum segment_type {\n35   CODE_SEGMENT,    // ELF segment\n36   DATA_SEGMENT,    // ELF segment\n37   STACK_SEGMENT,   // runtime segment\n38   CONTEXT_SEGMENT, // trapframe segment\n39   SYSTEM_SEGMENT,  // system segment\n40 };\n</code></pre> <p>\u5176\u4e2dCODE_SEGMENT\u8868\u793a\u8be5\u6bb5\u662f\u4ece\u53ef\u6267\u884cELF\u6587\u4ef6\u4e2d\u52a0\u8f7d\u7684\u4ee3\u7801\u6bb5\uff0cDATA_SEGMENT\u4e3a\u4eceELF\u6587\u4ef6\u4e2d\u52a0\u8f7d\u7684\u6570\u636e\u6bb5\uff0cSTACK_SEGMENT\u4e3a\u8fdb\u7a0b\u81ea\u8eab\u7684\u6808\u6bb5\uff0cCONTEXT_SEGMENT\u4e3a\u4fdd\u5b58\u8fdb\u7a0b\u4e0a\u4e0b\u6587\u7684trapframe\u6240\u5bf9\u5e94\u7684\u6bb5\uff0cSYSTEM_SEGMENT\u4e3a\u8fdb\u7a0b\u7684\u7cfb\u7edf\u6bb5\uff0c\u5982\u6240\u6620\u5c04\u7684\u5f02\u5e38\u5904\u7406\u6bb5\u3002</p> <ul> <li>pid\u662f\u8fdb\u7a0b\u7684ID\u53f7\uff0c\u5177\u6709\u552f\u4e00\u6027\uff1b</li> <li>status\u8bb0\u5f55\u4e86\u8fdb\u7a0b\u7684\u72b6\u6001\uff0cPKE\u64cd\u4f5c\u7cfb\u7edf\u5728\u5b9e\u9a8c3\u7ed9\u8fdb\u7a0b\u89c4\u5b9a\u4e86\u4ee5\u4e0b\u51e0\u79cd\u72b6\u6001\uff1a</li> </ul> <pre><code> 25 enum proc_status {\n26   FREE,            // unused state\n27   READY,           // ready state\n28   RUNNING,         // currently running\n29   BLOCKED,         // waiting for something\n30   ZOMBIE,          // terminated but not reclaimed yet\n31 };\n</code></pre> <p>\u5176\u4e2d\uff0cFREE\u4e3a\u81ea\u7531\u6001\uff0c\u8868\u793a\u8fdb\u7a0b\u7ed3\u6784\u53ef\u7528\uff1bREADY\u4e3a\u5c31\u7eea\u6001\uff0c\u5373\u8fdb\u7a0b\u6240\u9700\u7684\u8d44\u6e90\u90fd\u5df2\u51c6\u5907\u597d\uff0c\u53ef\u4ee5\u88ab\u8c03\u5ea6\u6267\u884c\uff1bRUNNING\u8868\u793a\u8be5\u8fdb\u7a0b\u5904\u4e8e\u6b63\u5728\u8fd0\u884c\u7684\u72b6\u6001\uff1bBLOCKED\u8868\u793a\u8fdb\u7a0b\u5904\u4e8e\u963b\u585e\u72b6\u6001\uff1bZOMBIE\u8868\u793a\u8fdb\u7a0b\u5904\u4e8e\u201c\u50f5\u5c38\u201d\u72b6\u6001\uff0c\u8fdb\u7a0b\u7684\u8d44\u6e90\u53ef\u4ee5\u88ab\u91ca\u653e\u548c\u56de\u6536\u3002</p> <ul> <li>parent\u7528\u4e8e\u8bb0\u5f55\u8fdb\u7a0b\u7684\u7236\u8fdb\u7a0b\uff1b</li> <li>queue_next\u7528\u4e8e\u5c06\u8fdb\u7a0b\u94fe\u63a5\u8fdb\u5404\u7c7b\u961f\u5217\uff08\u6bd4\u5982\u5c31\u7eea\u961f\u5217\uff09\uff1b</li> <li>tick_count\u7528\u4e8e\u5bf9\u8fdb\u7a0b\u8fdb\u884c\u8bb0\u8d26\uff0c\u5373\u8bb0\u5f55\u5b83\u7684\u6267\u884c\u7ecf\u5386\u4e86\u591a\u5c11\u6b21\u7684timer\u4e8b\u4ef6\uff0c\u5c06\u5728lab3_3\u4e2d\u5b9e\u73b0\u5faa\u73af\u8f6e\u8f6c\u8c03\u5ea6\u65f6\u4f7f\u7528\u3002</li> </ul> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter5_process/#512","title":"5.1.2 \u8fdb\u7a0b\u7684\u542f\u52a8\u4e0e\u7ec8\u6b62","text":"<p>PKE\u5b9e\u9a8c\u4e2d\uff0c\u521b\u5efa\u4e00\u4e2a\u8fdb\u7a0b\u9700\u8981\u5148\u8c03\u7528kernel/process.c\u6587\u4ef6\u4e2d\u7684alloc_process()\u51fd\u6570\uff1a</p> <pre><code> 92 process* alloc_process() {\n93   // locate the first usable process structure\n94   int i;\n95\n96   for( i=0; i&lt;NPROC; i++ )\n97     if( procs[i].status == FREE ) break;\n98\n99   if( i&gt;=NPROC ){\n100     panic( \"cannot find any free process structure.\\n\" );\n101     return 0;\n102   }\n103\n104   // init proc[i]'s vm space\n105   procs[i].trapframe = (trapframe *)alloc_page();  //trapframe, used to save context\n106   memset(procs[i].trapframe, 0, sizeof(trapframe));\n107\n108   // page directory\n109   procs[i].pagetable = (pagetable_t)alloc_page();\n110   memset((void *)procs[i].pagetable, 0, PGSIZE);\n111\n112   procs[i].kstack = (uint64)alloc_page() + PGSIZE;   //user kernel stack top\n113   uint64 user_stack = (uint64)alloc_page();       //phisical address of user stack bottom\n114   procs[i].trapframe-&gt;regs.sp = USER_STACK_TOP;  //virtual address of user stack top\n115\n116   // allocates a page to record memory regions (segments)\n117   procs[i].mapped_info = (mapped_region*)alloc_page();\n118   memset( procs[i].mapped_info, 0, PGSIZE );\n119\n120   // map user stack in userspace\n121   user_vm_map((pagetable_t)procs[i].pagetable, USER_STACK_TOP - PGSIZE, PGSIZE,\n122     user_stack, prot_to_type(PROT_WRITE | PROT_READ, 1));\n123   procs[i].mapped_info[0].va = USER_STACK_TOP - PGSIZE;\n124   procs[i].mapped_info[0].npages = 1;\n125   procs[i].mapped_info[0].seg_type = STACK_SEGMENT;\n126\n127   // map trapframe in user space (direct mapping as in kernel space).\n128   user_vm_map((pagetable_t)procs[i].pagetable, (uint64)procs[i].trapframe, PGSIZE,\n129     (uint64)procs[i].trapframe, prot_to_type(PROT_WRITE | PROT_READ, 0));\n130   procs[i].mapped_info[1].va = (uint64)procs[i].trapframe;\n131   procs[i].mapped_info[1].npages = 1;\n132   procs[i].mapped_info[1].seg_type = CONTEXT_SEGMENT;\n133\n134   // map S-mode trap vector section in user space (direct mapping as in kernel space)\n135   // we assume that the size of usertrap.S is smaller than a page.\n136   user_vm_map((pagetable_t)procs[i].pagetable, (uint64)trap_sec_start, PGSIZE,\n137     (uint64)trap_sec_start, prot_to_type(PROT_READ | PROT_EXEC, 0));\n138   procs[i].mapped_info[2].va = (uint64)trap_sec_start;\n139   procs[i].mapped_info[2].npages = 1;\n140   procs[i].mapped_info[2].seg_type = SYSTEM_SEGMENT;\n141\n142   sprint(\"in alloc_proc. user frame 0x%lx, user stack 0x%lx, user kstack 0x%lx \\n\",\n143     procs[i].trapframe, procs[i].trapframe-&gt;regs.sp, procs[i].kstack);\n144\n145   procs[i].total_mapped_region = 3;\n146   // return after initialization.\n147   return &amp;procs[i];\n148 }\n</code></pre> <p>\u901a\u8fc7\u4ee5\u4e0a\u4ee3\u7801\uff0c\u53ef\u4ee5\u53d1\u73b0alloc_process()\u51fd\u6570\u9664\u4e86\u627e\u5230\u4e00\u4e2a\u7a7a\u7684\u8fdb\u7a0b\u7ed3\u6784\u5916\uff0c\u8fd8\u4e3a\u65b0\u521b\u5efa\u7684\u8fdb\u7a0b\u5efa\u7acb\u4e86KERN_BASE\u4ee5\u4e0a\u903b\u8f91\u5730\u5740\u7684\u6620\u5c04\uff08\u8fd9\u6bb5\u4ee3\u7801\u5728\u5b9e\u9a8c3\u4e4b\u524d\u4f4d\u4e8ekernel/kernel.c\u6587\u4ef6\u7684load_user_program()\u51fd\u6570\u4e2d\uff09\uff0c\u5e76\u5c06\u6620\u5c04\u4fe1\u606f\u4fdd\u5b58\u5230\u4e86\u8fdb\u7a0b\u7ed3\u6784\u4e2d\u3002</p> <p>\u5bf9\u4e8e\u7ed9\u5b9a\u5e94\u7528\uff0cPKE\u5c06\u901a\u8fc7\u8c03\u7528load_bincode_from_host_elf()\u51fd\u6570\u8f7d\u5165\u7ed9\u5b9a\u5e94\u7528\u5bf9\u5e94\u7684ELF\u6587\u4ef6\u7684\u5404\u4e2a\u6bb5\u3002\u4e4b\u540e\u88ab\u8c03\u7528\u7684elf_load()\u51fd\u6570\u5728\u8f7d\u5165\u6bb5\u540e\uff0c\u5c06\u5bf9\u88ab\u8f7d\u5165\u7684\u6bb5\u8fdb\u884c\u5224\u65ad\uff0c\u4ee5\u8bb0\u5f55\u5b83\u4eec\u7684\u865a\u5730\u5740\u6620\u5c04\uff1a</p> <pre><code> 65 elf_status elf_load(elf_ctx *ctx) {\n66   // elf_prog_header structure is defined in kernel/elf.h\n67   elf_prog_header ph_addr;\n68   int i, off;\n69\n70   // traverse the elf program segment headers\n71   for (i = 0, off = ctx-&gt;ehdr.phoff; i &lt; ctx-&gt;ehdr.phnum; i++, off += sizeof(ph_addr)) {\n72     // read segment headers\n73     if (elf_fpread(ctx, (void *)&amp;ph_addr, sizeof(ph_addr), off) != sizeof(ph_addr)) return EL    _EIO;\n74\n75     if (ph_addr.type != ELF_PROG_LOAD) continue;\n76     if (ph_addr.memsz &lt; ph_addr.filesz) return EL_ERR;\n77     if (ph_addr.vaddr + ph_addr.memsz &lt; ph_addr.vaddr) return EL_ERR;\n78\n79     // allocate memory block before elf loading\n80     void *dest = elf_alloc_mb(ctx, ph_addr.vaddr, ph_addr.vaddr, ph_addr.memsz);\n81\n82     // actual loading\n83     if (elf_fpread(ctx, dest, ph_addr.memsz, ph_addr.off) != ph_addr.memsz)\n84       return EL_EIO;\n85\n86     // record the vm region in proc-&gt;mapped_info. added @lab3_1\n87     int j;\n88     for( j=0; j&lt;PGSIZE/sizeof(mapped_region); j++ ) //seek the last mapped region\n89       if( (process*)(((elf_info*)(ctx-&gt;info))-&gt;p)-&gt;mapped_info[j].va == 0x0 ) break;\n90\n91     ((process*)(((elf_info*)(ctx-&gt;info))-&gt;p))-&gt;mapped_info[j].va = ph_addr.vaddr;\n92     ((process*)(((elf_info*)(ctx-&gt;info))-&gt;p))-&gt;mapped_info[j].npages = 1;\n93\n94     // SEGMENT_READABLE, SEGMENT_EXECUTABLE, SEGMENT_WRITABLE are defined in kernel/elf.h\n95     if( ph_addr.flags == (SEGMENT_READABLE|SEGMENT_EXECUTABLE) ){\n96       ((process*)(((elf_info*)(ctx-&gt;info))-&gt;p))-&gt;mapped_info[j].seg_type = CODE_SEGMENT;\n97       sprint( \"CODE_SEGMENT added at mapped info offset:%d\\n\", j );\n98     }else if ( ph_addr.flags == (SEGMENT_READABLE|SEGMENT_WRITABLE) ){\n99       ((process*)(((elf_info*)(ctx-&gt;info))-&gt;p))-&gt;mapped_info[j].seg_type = DATA_SEGMENT;\n100       sprint( \"DATA_SEGMENT added at mapped info offset:%d\\n\", j );\n101     }else\n102       panic( \"unknown program segment encountered, segment flag:%d.\\n\", ph_addr.flags );\n103\n104     ((process*)(((elf_info*)(ctx-&gt;info))-&gt;p))-&gt;total_mapped_region ++;\n105   }\n106\n107   return EL_OK;\n108 }\n</code></pre> <p>\u4ee5\u4e0a\u4ee3\u7801\u6bb5\u4e2d\uff0c\u7b2c95--102\u884c\u5c06\u5bf9\u88ab\u8f7d\u5165\u7684\u6bb5\u7684\u7c7b\u578b\uff08ph_addr.flags\uff09\u8fdb\u884c\u5224\u65ad\u4ee5\u786e\u5b9a\u5b83\u662f\u4ee3\u7801\u6bb5\u8fd8\u662f\u6570\u636e\u6bb5\u3002\u5b8c\u6210\u4ee5\u4e0a\u7684\u865a\u5730\u5740\u7a7a\u95f4\u5230\u7269\u7406\u5730\u5740\u7a7a\u95f4\u7684\u6620\u5c04\u540e\uff0c\u5c06\u5f62\u6210\u7528\u6237\u8fdb\u7a0b\u7684\u865a\u5730\u5740\u7a7a\u95f4\u7ed3\u6784\uff08\u5982\u56fe4.5\u6240\u793a\uff09\u3002</p> <p>\u63a5\u4e0b\u6765\uff0c\u5c06\u901a\u8fc7switch_to()\u51fd\u6570\u5c06\u6240\u6784\u9020\u7684\u8fdb\u7a0b\u6295\u5165\u6267\u884c\uff1a</p> <pre><code> 41 void switch_to(process* proc) {\n42   assert(proc);\n43   current = proc;\n44\n45   // write the smode_trap_vector (64-bit func. address) defined in kernel/strap_vector.S\n46   // to the stvec privilege register, such that trap handler pointed by smode_trap_vector\n47   // will be triggered when an interrupt occurs in S mode.\n48   write_csr(stvec, (uint64)smode_trap_vector);\n49\n50   // set up trapframe values (in process structure) that smode_trap_vector will need when\n51   // the process next re-enters the kernel.\n52   proc-&gt;trapframe-&gt;kernel_sp = proc-&gt;kstack;      // process's kernel stack\n53   proc-&gt;trapframe-&gt;kernel_satp = read_csr(satp);  // kernel page table\n54   proc-&gt;trapframe-&gt;kernel_trap = (uint64)smode_trap_handler;\n55\n56   // SSTATUS_SPP and SSTATUS_SPIE are defined in kernel/riscv.h\n57   // set S Previous Privilege mode (the SSTATUS_SPP bit in sstatus register) to User mode.\n58   unsigned long x = read_csr(sstatus);\n59   x &amp;= ~SSTATUS_SPP;  // clear SPP to 0 for user mode\n60   x |= SSTATUS_SPIE;  // enable interrupts in user mode\n61\n62   // write x back to 'sstatus' register to enable interrupts, and sret destination mode.\n63   write_csr(sstatus, x);\n64\n65   // set S Exception Program Counter (sepc register) to the elf entry pc.\n66   write_csr(sepc, proc-&gt;trapframe-&gt;epc);\n67\n68   // make user page table. macro MAKE_SATP is defined in kernel/riscv.h. added @lab2_1\n69   uint64 user_satp = MAKE_SATP(proc-&gt;pagetable);\n70\n71   // return_to_user() is defined in kernel/strap_vector.S. switch to user mode with sret.\n72   // note, return_to_user takes two parameters @ and after lab2_1.\n73   return_to_user(proc-&gt;trapframe, user_satp);\n74 }\n</code></pre> <p>\u5b9e\u9645\u4e0a\uff0c\u4ee5\u4e0a\u51fd\u6570\u5728\u5b9e\u9a8c1\u5c31\u6709\u6240\u6d89\u53ca\uff0c\u5b83\u7684\u4f5c\u7528\u662f\u5c06\u8fdb\u7a0b\u7ed3\u6784\u4e2d\u7684trapframe\u4f5c\u4e3a\u8fdb\u7a0b\u4e0a\u4e0b\u6587\u6062\u590d\u5230RISC-V\u673a\u5668\u7684\u901a\u7528\u5bc4\u5b58\u5668\u4e2d\uff0c\u5e76\u6700\u540e\u8c03\u7528sret\u6307\u4ee4\uff08\u901a\u8fc7return_to_user()\u51fd\u6570\uff09\u5c06\u8fdb\u7a0b\u6295\u5165\u6267\u884c\u3002</p> <p>\u4e0d\u540c\u4e8e\u5b9e\u9a8c1\u548c\u5b9e\u9a8c2\uff0c\u5b9e\u9a8c3\u7684exit\u7cfb\u7edf\u8c03\u7528\u4e0d\u80fd\u591f\u76f4\u63a5\u5c06\u7cfb\u7edfshutdown\uff0c\u56e0\u4e3a\u4e00\u4e2a\u8fdb\u7a0b\u7684\u7ed3\u675f\u5e76\u4e0d\u4e00\u5b9a\u610f\u5473\u7740\u7cfb\u7edf\u4e2d\u6240\u6709\u8fdb\u7a0b\u7684\u5b8c\u6210\u3002\u4ee5\u4e0b\u662f\u5b9e\u9a8c3\u4e2dexit\u7cfb\u7edf\u8c03\u7528\u7684\u5b9e\u73b0\uff1a</p> <pre><code> 34 ssize_t sys_user_exit(uint64 code) {\n35   sprint(\"User exit with code:%d.\\n\", code);\n36   // reclaim the current process, and reschedule. added @lab3_1\n37   free_process( current );\n38   schedule();\n39   return 0;\n40 }\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0c\u5982\u679c\u67d0\u8fdb\u7a0b\u8c03\u7528\u4e86exit()\u7cfb\u7edf\u8c03\u7528\uff0c\u64cd\u4f5c\u7cfb\u7edf\u7684\u5904\u7406\u65b9\u6cd5\u662f\u8c03\u7528free_process()\u51fd\u6570\uff0c\u5c06\u5f53\u524d\u8fdb\u7a0b\uff08\u4e5f\u5c31\u662f\u8c03\u7528\u8005\uff09\u8fdb\u884c\u201c\u91ca\u653e\u201d\uff0c\u7136\u540e\u8f6c\u8fdb\u7a0b\u8c03\u5ea6\u3002\u5176\u4e2dfree_process()\u51fd\u6570\uff08kernel/process.c\u6587\u4ef6\uff09\u7684\u5b9e\u73b0\u975e\u5e38\u7b80\u5355\uff1a</p> <pre><code>153 int free_process( process* proc ) {\n154   // we set the status to ZOMBIE, but cannot destruct its vm space immediately.\n155   // since proc can be current process, and its user kernel stack is currently in use!\n156   // but for proxy kernel, it (memory leaking) may NOT be a really serious issue,\n157   // as it is different from regular OS, which needs to run 7x24.\n158   proc-&gt;status = ZOMBIE;\n159\n160   return 0;\n161 }\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0cfree_process()\u51fd\u6570\u4ec5\u662f\u5c06\u8fdb\u7a0b\u8bbe\u4e3aZOMBIE\u72b6\u6001\uff0c\u800c\u4e0d\u4f1a\u5c06\u8fdb\u7a0b\u6240\u5360\u7528\u7684\u8d44\u6e90\u5168\u90e8\u91ca\u653e\uff01\u8fd9\u662f\u56e0\u4e3afree_process()\u51fd\u6570\u7684\u8c03\u7528\uff0c\u8bf4\u660e\u64cd\u4f5c\u7cfb\u7edf\u5f53\u524d\u662f\u5728S\u6a21\u5f0f\u4e0b\u8fd0\u884c\uff0c\u800c\u6309\u7167PKE\u7684\u8bbe\u8ba1\u601d\u60f3\uff0cS\u6001\u7684\u8fd0\u884c\u5c06\u4f7f\u7528\u5f53\u524d\u8fdb\u7a0b\u7684\u7528\u6237\u7cfb\u7edf\u6808\uff08user kernel stack\uff09\u3002\u6b64\u65f6\uff0c\u5982\u679c\u5c06\u5f53\u524d\u8fdb\u7a0b\u7684\u5185\u5b58\u7a7a\u95f4\u8fdb\u884c\u91ca\u653e\uff0c\u5c06\u5bfc\u81f4\u64cd\u4f5c\u7cfb\u7edf\u672c\u8eab\u7684\u5d29\u6e83\u3002\u6240\u4ee5\u91ca\u653e\u8fdb\u7a0b\u65f6\uff0cPKE\u91c7\u7528\u7684\u662f\u6298\u8877\u7684\u529e\u6cd5\uff0c\u5373\u53ea\u5c06\u5176\u8bbe\u7f6e\u4e3a\u50f5\u5c38\uff08ZOMBIE\uff09\u72b6\u6001\uff0c\u800c\u4e0d\u662f\u7acb\u5373\u5c06\u5b83\u6240\u5360\u7528\u7684\u8d44\u6e90\u8fdb\u884c\u91ca\u653e\u3002\u6700\u540e\uff0cschedule()\u51fd\u6570\u7684\u8c03\u7528\uff0c\u5c06\u9009\u62e9\u7cfb\u7edf\u4e2d\u53ef\u80fd\u5b58\u5728\u7684\u5176\u4ed6\u5904\u4e8e\u5c31\u7eea\u72b6\u6001\u7684\u8fdb\u7a0b\u6295\u5165\u8fd0\u884c\uff0c\u5b83\u7684\u5904\u7406\u903b\u8f91\u6211\u4eec\u5c06\u5728\u4e0b\u4e00\u8282\u8ba8\u8bba\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter5_process/#513","title":"5.1.3 \u5c31\u7eea\u8fdb\u7a0b\u7684\u7ba1\u7406\u4e0e\u8c03\u5ea6","text":"<p>PKE\u7684\u64cd\u4f5c\u7cfb\u7edf\u8bbe\u8ba1\u4e86\u4e00\u4e2a\u975e\u5e38\u7b80\u5355\u7684\u5c31\u7eea\u961f\u5217\u7ba1\u7406\uff08\u56e0\u4e3a\u5b9e\u9a8c3\u7684\u57fa\u7840\u5b9e\u9a8c\u5e76\u672a\u6d89\u53ca\u8fdb\u7a0b\u7684\u963b\u585e\uff0c\u6240\u4ee5\u672a\u8bbe\u8ba1\u963b\u585e\u961f\u5217\uff09\uff0c\u961f\u5217\u5934\u5728kernel/sched.c\u6587\u4ef6\u4e2d\u5b9a\u4e49\uff1a</p> <pre><code>8 process* ready_queue_head = NULL;\n</code></pre> <p>\u5c06\u4e00\u4e2a\u8fdb\u7a0b\u52a0\u5165\u5c31\u7eea\u961f\u5217\uff0c\u53ef\u4ee5\u8c03\u7528insert_to_ready_queue()\u51fd\u6570\uff1a</p> <pre><code> 13 void insert_to_ready_queue( process* proc ) {\n14   sprint( \"going to insert process %d to ready queue.\\n\", proc-&gt;pid );\n15   // if the queue is empty in the beginning\n16   if( ready_queue_head == NULL ){\n17     proc-&gt;status = READY;\n18     proc-&gt;queue_next = NULL;\n19     ready_queue_head = proc;\n20     return;\n21   }\n22\n23   // ready queue is not empty\n24   process *p;\n25   // browse the ready queue to see if proc is already in-queue\n26   for( p=ready_queue_head; p-&gt;queue_next!=NULL; p=p-&gt;queue_next )\n27     if( p == proc ) return;  //already in queue\n28\n29   // p points to the last element of the ready queue\n30   if( p==proc ) return;\n31   p-&gt;queue_next = proc;\n32   proc-&gt;status = READY;\n33   proc-&gt;queue_next = NULL;\n34\n35   return;\n36 }\n</code></pre> <p>\u8be5\u51fd\u6570\u9996\u5148\uff08\u7b2c16--21\u884c\uff09\u5904\u7406ready_queue_head\u4e3a\u7a7a\uff08\u521d\u59cb\u72b6\u6001\uff09\u7684\u60c5\u51b5\uff0c\u5982\u679c\u5c31\u7eea\u961f\u5217\u4e0d\u4e3a\u7a7a\uff0c\u5219\u5c06\u8fdb\u7a0b\u52a0\u5165\u5230\u961f\u5c3e\uff08\u7b2c26--33\u884c\uff09\u3002</p> <p>PKE\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u901a\u8fc7\u8c03\u7528schedule()\u51fd\u6570\u6765\u5b8c\u6210\u8fdb\u7a0b\u7684\u9009\u62e9\u548c\u6362\u5165\uff1a</p> <pre><code> 45 void schedule() {\n46   if ( !ready_queue_head ){\n47     // by default, if there are no ready process, and all processes are in the status of\n48     // FREE and ZOMBIE, we should shutdown the emulated RISC-V machine.\n49     int should_shutdown = 1;\n50\n51     for( int i=0; i&lt;NPROC; i++ )\n52       if( (procs[i].status != FREE) &amp;&amp; (procs[i].status != ZOMBIE) ){\n53         should_shutdown = 0;\n54         sprint( \"ready queue empty, but process %d is not in free/zombie state:%d\\n\",\n55           i, procs[i].status );\n56       }\n57\n58     if( should_shutdown ){\n59       sprint( \"no more ready processes, system shutdown now.\\n\" );\n60       shutdown( 0 );\n61     }else{\n62       panic( \"Not handled: we should let system wait for unfinished processes.\\n\" );\n63     }\n64   }\n65\n66   current = ready_queue_head;\n67   assert( current-&gt;status == READY );\n68   ready_queue_head = ready_queue_head-&gt;queue_next;\n69\n70   current-&gt;status == RUNNING;\n71   sprint( \"going to schedule process %d to run.\\n\", current-&gt;pid );\n72   switch_to( current );\n73 }\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0cschedule()\u51fd\u6570\u9996\u5148\u5224\u65ad\u5c31\u7eea\u961f\u5217ready_queue_head\u662f\u5426\u4e3a\u7a7a\uff0c\u5bf9\u4e8e\u4e3a\u7a7a\u7684\u60c5\u51b5\uff08\u7b2c46--64\u884c\uff09\uff0cschedule()\u51fd\u6570\u5c06\u5224\u65ad\u7cfb\u7edf\u4e2d\u6240\u6709\u7684\u8fdb\u7a0b\u662f\u5426\u5168\u90e8\u90fd\u5904\u4e8e\u88ab\u91ca\u653e\uff08FREE\uff09\u72b6\u6001\uff0c\u6216\u8005\u50f5\u5c38\uff08ZOMBIE\uff09\u72b6\u6001\u3002\u5982\u679c\u662f\uff0c\u5219\u542f\u52a8\u5173\uff08\u6a21\u62dfRISC-V\uff09\u673a\u7a0b\u5e8f\uff0c\u5426\u5219\u5e94\u8fdb\u5165\u7b49\u5f85\u7cfb\u7edf\u4e2d\u8fdb\u7a0b\u7ed3\u675f\u7684\u72b6\u6001\u3002\u4f46\u662f\uff0c\u7531\u4e8e\u5b9e\u9a8c3\u7684\u57fa\u7840\u5b9e\u9a8c\u5e76\u65e0\u53ef\u80fd\u8fdb\u5165\u8fd9\u6837\u7684\u72b6\u6001\uff0c\u6240\u4ee5\u6211\u4eec\u5728\u8fd9\u91cc\u8c03\u7528\u4e86panic\uff0c\u7b49\u540e\u7eed\u5b9e\u9a8c\u6709\u53ef\u80fd\u8fdb\u5165\u8fd9\u79cd\u72b6\u6001\u540e\u518d\u8fdb\u4e00\u6b65\u5904\u7406\u3002</p> <p>\u5bf9\u4e8e\u5c31\u7eea\u961f\u5217\u975e\u7a7a\u7684\u60c5\u51b5\uff08\u7b2c66--72\u884c\uff09\uff0c\u5904\u7406\u5c31\u7b80\u5355\u5f97\u591a\uff1a\u53ea\u9700\u8981\u5c06\u5c31\u7eea\u961f\u5217\u961f\u9996\u7684\u8fdb\u7a0b\u6362\u5165\u6267\u884c\u5373\u53ef\u3002\u5bf9\u4e8e\u6362\u5165\u7684\u8fc7\u7a0b\uff0c\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u8981\u5c06\u88ab\u9009\u4e2d\u7684\u8fdb\u7a0b\u4ece\u5c31\u7eea\u961f\u5217\u4e2d\u6458\u6389\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter5_process/#52-lab3_1-fork","title":"5.2 lab3_1 \u8fdb\u7a0b\u521b\u5efa\uff08fork\uff09","text":""},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter5_process/#_2","title":"\u7ed9\u5b9a\u5e94\u7528","text":"<ul> <li>user/app_naive_fork.c</li> </ul> <pre><code>  1 /*\n  2  * The application of lab3_1.\n  3  * it simply forks a child process.\n  4  */\n5\n6 #include \"user/user_lib.h\"\n7 #include \"util/types.h\"\n8\n9 int main(void) {\n10   uint64 pid = fork();\n11   if (pid == 0) {\n12     printu(\"Child: Hello world!\\n\");\n13   } else {\n14     printu(\"Parent: Hello world! child id %ld\\n\", pid);\n15   }\n16\n17   exit(0);\n18 }\n</code></pre> <p>\u4ee5\u4e0a\u7a0b\u5e8f\u7684\u884c\u4e3a\u975e\u5e38\u7b80\u5355\uff1a\u4e3b\u8fdb\u7a0b\u8c03\u7528fork()\u51fd\u6570\uff0c\u540e\u8005\u4ea7\u751f\u4e00\u4e2a\u7cfb\u7edf\u8c03\u7528\uff0c\u57fa\u4e8e\u4e3b\u8fdb\u7a0b\u8fd9\u4e2a\u6a21\u677f\u521b\u5efa\u5b83\u7684\u5b50\u8fdb\u7a0b\u3002</p> <ul> <li>\uff08\u5148\u63d0\u4ea4lab2_3\u7684\u7b54\u6848\uff0c\u7136\u540e\uff09\u5207\u6362\u5230lab3_1\uff0c\u7ee7\u627flab2_3\u53ca\u4e4b\u524d\u5b9e\u9a8c\u6240\u505a\u7684\u4fee\u6539\uff0c\u5e76make\u540e\u7684\u76f4\u63a5\u8fd0\u884c\u7ed3\u679c\uff1a</li> </ul> <pre><code>//\u5207\u6362\u5230lab3_1\n$ git checkout lab3_1_fork\n\n//\u7ee7\u627flab2_3\u4ee5\u53ca\u4e4b\u524d\u7684\u7b54\u6848\n$ git merge lab2_3_pagefault -m \"continue to work on lab3_1\"\n//\u91cd\u65b0\u6784\u9020\n$ make clean; make\n\n//\u8fd0\u884c\u6784\u9020\u7ed3\u679c\n$ spike ./obj/riscv-pke ./obj/app_naive_fork\nIn m_start, hartid:0\nHTIF is available!\n(Emulated) memory size: 2048 MB\nEnter supervisor mode...\nPKE kernel start 0x0000000080000000, PKE kernel end: 0x0000000080010000, PKE kernel size: 0x0000000000010000 .\nfree physical memory address: [0x0000000080010000, 0x0000000087ffffff]\nkernel memory manager is initializing ...\nKERN_BASE 0x0000000080000000\nphysical address of _etext is: 0x0000000080005000\nkernel page table is on\nSwitching to user mode...\nin alloc_proc. user frame 0x0000000087fbc000, user stack 0x000000007ffff000, user kstack 0x0000000087fbb000\nUser application is loading.\nApplication: ./obj/app_naive_fork\nCODE_SEGMENT added at mapped info offset:3\nApplication program entry point (virtual address): 0x0000000000010078\ngoing to insert process 0 to ready queue.\ngoing to schedule process 0 to run.\nUser call fork.\nwill fork a child from parent 0.\nin alloc_proc. user frame 0x0000000087faf000, user stack 0x000000007ffff000, user kstack 0x0000000087fae000\nYou need to implement the code segment mapping of child in lab3_1.\n\nSystem is shutting down with exit code -1.\n</code></pre> <p>\u4ece\u4ee5\u4e0a\u8fd0\u884c\u7ed3\u679c\u6765\u770b\uff0c\u5e94\u7528\u7a0b\u5e8f\u7684fork\u52a8\u4f5c\u5e76\u672a\u5c06\u5b50\u8fdb\u7a0b\u7ed9\u521b\u5efa\u51fa\u6765\u5e76\u6295\u5165\u8fd0\u884c\u3002\u6309\u7167\u63d0\u793a\uff0c\u6211\u4eec\u9700\u8981\u5728PKE\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838\u4e2d\u5b9e\u73b0\u5b50\u8fdb\u7a0b\u5230\u7236\u8fdb\u7a0b\u4ee3\u7801\u6bb5\u7684\u6620\u5c04\uff0c\u4ee5\u6700\u7ec8\u5b8c\u6210fork\u52a8\u4f5c\u3002</p> <p>\u8fd9\u91cc\uff0c\u65e2\u7136\u6d89\u53ca\u5230\u4e86\u7236\u8fdb\u7a0b\u7684\u4ee3\u7801\u6bb5\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u5148\u7528readelf\u547d\u4ee4\u67e5\u770b\u4e00\u4e0b\u7ed9\u5b9a\u5e94\u7528\u7a0b\u5e8f\u7684\u53ef\u6267\u884c\u4ee3\u7801\u5bf9\u5e94\u7684ELF\u6587\u4ef6\u7ed3\u6784\uff1a</p> <pre><code>$ riscv64-unknown-elf-readelf -l ./obj/app_naive_fork\n\nElf file type is EXEC (Executable file)\nEntry point 0x10078\nThere is 1 program header, starting at offset 64\nProgram Headers:\n  Type           Offset             VirtAddr           PhysAddr\n                 FileSiz            MemSiz              Flags  Align\n  LOAD           0x0000000000000000 0x0000000000010000 0x0000000000010000\n                 0x000000000000040c 0x000000000000040c  R E    0x1000\n\nSection to Segment mapping:\n  Segment Sections...\n   00     .text .rodata\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\uff0capp_naive_fork\u53ef\u6267\u884c\u6587\u4ef6\u53ea\u5305\u542b\u4e00\u4e2a\u4ee3\u7801\u6bb5\uff08\u7f16\u53f7\u4e3a00\uff09\uff0c\u5e94\u8be5\u6765\u8bb2\u662f\u6700\u7b80\u5355\u7684\u53ef\u6267\u884c\u6587\u4ef6\u7ed3\u6784\u4e86\uff08\u65e0\u987b\u8003\u8651\u6570\u636e\u6bb5\u7684\u95ee\u9898\uff09\u3002\u5982\u679c\u8981\u4f9d\u636e\u8fd9\u6837\u7684\u7236\u8fdb\u7a0b\u6a21\u677f\u521b\u5efa\u5b50\u8fdb\u7a0b\uff0c\u53ea\u9700\u8981\u5c06\u5b83\u7684\u4ee3\u7801\u6bb5\u6620\u5c04\uff08\u800c\u975e\u62f7\u8d1d\uff09\u5230\u5b50\u8fdb\u7a0b\u7684\u5bf9\u5e94\u865a\u5730\u5740\u5373\u53ef\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter5_process/#_3","title":"\u5b9e\u9a8c\u5185\u5bb9","text":"<p>\u5b8c\u5584\u64cd\u4f5c\u7cfb\u7edf\u5185\u6838kernel/process.c\u6587\u4ef6\u4e2d\u7684do_fork()\u51fd\u6570\uff0c\u5e76\u6700\u7ec8\u83b7\u5f97\u4ee5\u4e0b\u9884\u671f\u7ed3\u679c\uff1a</p> <pre><code>$ spike ./obj/riscv-pke ./obj/app_naive_fork\nIn m_start, hartid:0\nHTIF is available!\n(Emulated) memory size: 2048 MB\nEnter supervisor mode...\nPKE kernel start 0x0000000080000000, PKE kernel end: 0x0000000080010000, PKE kernel size: 0x0000000000010000 .\nfree physical memory address: [0x0000000080010000, 0x0000000087ffffff]\nkernel memory manager is initializing ...\nKERN_BASE 0x0000000080000000\nphysical address of _etext is: 0x0000000080005000\nkernel page table is on\nSwitching to user mode...\nin alloc_proc. user frame 0x0000000087fbc000, user stack 0x000000007ffff000, user kstack 0x0000000087fbb000\nUser application is loading.\nApplication: ./obj/app_naive_fork\nCODE_SEGMENT added at mapped info offset:3\nApplication program entry point (virtual address): 0x0000000000010078\ngoing to insert process 0 to ready queue.\ngoing to schedule process 0 to run.\nUser call fork.\nwill fork a child from parent 0.\nin alloc_proc. user frame 0x0000000087faf000, user stack 0x000000007ffff000, user kstack 0x0000000087fae000\ndo_fork map code segment at pa:0000000087fb2000 of parent to child at va:0000000000010000.\ngoing to insert process 1 to ready queue.\nParent: Hello world! child id 1\nUser exit with code:0.\ngoing to schedule process 1 to run.\nChild: Hello world!\nUser exit with code:0.\nno more ready processes, system shutdown now.\nSystem is shutting down with exit code 0.\n</code></pre> <p>\u4ece\u4ee5\u4e0a\u8fd0\u884c\u7ed3\u679c\u6765\u770b\uff0c\u5b50\u8fdb\u7a0b\u5df2\u7ecf\u88ab\u521b\u5efa\uff0c\u4e14\u5728\u5176\u540e\u88ab\u6295\u5165\u8fd0\u884c\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter5_process/#_4","title":"\u5b9e\u9a8c\u6307\u5bfc","text":"<p>\u8bfb\u8005\u53ef\u4ee5\u56de\u987elab1_1\u4e2d\u6240\u5b66\u4e60\u5230\u7684\u7cfb\u7edf\u8c03\u7528\u7684\u77e5\u8bc6\uff0c\u4ece\u5e94\u7528\u7a0b\u5e8f\uff08user/app_naive_fork.c\uff09\u5f00\u59cb\uff0c\u8ddf\u8e2afork()\u51fd\u6570\u7684\u5b9e\u73b0\uff1a</p> <p>user/app_naive_fork.c --&gt; user/user_lib.c --&gt; kernel/strap_vector.S --&gt; kernel/strap.c --&gt; kernel/syscall.c</p> <p>\u76f4\u81f3\u8ddf\u8e2a\u5230kernel/process.c\u6587\u4ef6\u4e2d\u7684do_fork()\u51fd\u6570\uff1a</p> <pre><code>170 int do_fork( process* parent)\n171 {\n172   sprint( \"will fork a child from parent %d.\\n\", parent-&gt;pid );\n173   process* child = alloc_process();\n174\n175   for( int i=0; i&lt;parent-&gt;total_mapped_region; i++ ){\n176     // browse parent's vm space, and copy its trapframe and data segments,\n177     // map its code segment.\n178     switch( parent-&gt;mapped_info[i].seg_type ){\n179       case CONTEXT_SEGMENT:\n180         *child-&gt;trapframe = *parent-&gt;trapframe;\n181         break;\n182       case STACK_SEGMENT:\n183         memcpy( (void*)lookup_pa(child-&gt;pagetable, child-&gt;mapped_info[0].va),\n184           (void*)lookup_pa(parent-&gt;pagetable, parent-&gt;mapped_info[i].va), PGSIZE );\n185         break;\n186       case CODE_SEGMENT:\n187         // TODO (lab3_1): implment the mapping of child code segment to parent's\n188         // code segment.\n189         // hint: the virtual address mapping of code segment is tracked in mapped_info\n190         // page of parent's process structure. use the information in mapped_info to\n191         // retrieve the virtual to physical mapping of code segment.\n192         // after having the mapping information, just map the corresponding virtual\n193         // address region of child to the physical pages that actually store the code\n194         // segment of parent process.\n195         // DO NOT COPY THE PHYSICAL PAGES, JUST MAP THEM.\n196         panic( \"You need to implement the code segment mapping of child in lab3_1.\\n\" );\n197\n198         // after mapping, register the vm region (do not delete codes below!)\n199         child-&gt;mapped_info[child-&gt;total_mapped_region].va = parent-&gt;mapped_info[i].va;\n200         child-&gt;mapped_info[child-&gt;total_mapped_region].npages =\n201           parent-&gt;mapped_info[i].npages;\n202         child-&gt;mapped_info[child-&gt;total_mapped_region].seg_type = CODE_SEGMENT;\n203         child-&gt;total_mapped_region++;\n204         break;\n205     }\n206   }\n</code></pre> <p>\u8be5\u51fd\u6570\u4f7f\u7528\u7b2c175--205\u884c\u7684\u5faa\u73af\u6765\u62f7\u8d1d\u7236\u8fdb\u7a0b\u7684\u903b\u8f91\u5730\u5740\u7a7a\u95f4\u5230\u5176\u5b50\u8fdb\u7a0b\u3002\u6211\u4eec\u770b\u5230\uff0c\u5bf9\u4e8etrapframe\u6bb5\uff08case CONTEXT_SEGMENT\uff09\u4ee5\u53ca\u5806\u6808\u6bb5\uff08case CODE_SEGMENT\uff09\uff0cdo_fork()\u51fd\u6570\u91c7\u7528\u4e86\u7b80\u5355\u590d\u5236\u7684\u529e\u6cd5\u6765\u62f7\u8d1d\u7236\u8fdb\u7a0b\u7684\u8fd9\u4e24\u4e2a\u6bb5\u5230\u5b50\u8fdb\u7a0b\u4e2d\uff0c\u8fd9\u6837\u505a\u7684\u76ee\u7684\u662f\u5c06\u7236\u8fdb\u7a0b\u7684\u6267\u884c\u73b0\u573a\u4f20\u9012\u7ed9\u5b50\u8fdb\u7a0b\u3002</p> <p>\u7136\u800c\uff0c\u5bf9\u4e8e\u7236\u8fdb\u7a0b\u7684\u4ee3\u7801\u6bb5\uff0c\u5b50\u8fdb\u7a0b\u5e94\u8be5\u5982\u4f55\u201c\u7ee7\u627f\u201d\u5462\uff1f\u901a\u8fc7\u7b2c187--195\u884c\u7684\u6ce8\u91ca\uff0c\u6211\u4eec\u77e5\u9053\u5bf9\u4e8e\u4ee3\u7801\u6bb5\uff0c\u6211\u4eec\u4e0d\u5e94\u76f4\u63a5\u590d\u5236\uff08\u51cf\u5c11\u7cfb\u7edf\u5f00\u9500\uff09\uff0c\u800c\u5e94\u901a\u8fc7\u6620\u5c04\u7684\u529e\u6cd5\uff0c\u5c06\u5b50\u8fdb\u7a0b\u4e2d\u5bf9\u5e94\u7684\u903b\u8f91\u5730\u5740\u7a7a\u95f4\u6620\u5c04\u5230\u5176\u7236\u8fdb\u7a0b\u4e2d\u88c5\u8f7d\u4ee3\u7801\u6bb5\u7684\u7269\u7406\u9875\u9762\u3002\u8fd9\u91cc\uff0c\u5c31\u8981\u56de\u5230\u5b9e\u9a8c2\u5185\u5b58\u7ba1\u7406\u90e8\u5206\uff0c\u5bfb\u627e\u5408\u9002\u7684\u51fd\u6570\u6765\u5b9e\u73b0\u4e86\u3002\u6ce8\u610f\u5bf9\u9875\u9762\u7684\u6743\u9650\u8bbe\u7f6e\uff08\u53ef\u8bfb\u53ef\u6267\u884c\uff09\u3002</p> <p>\u5b9e\u9a8c\u5b8c\u6bd5\u540e\uff0c\u8bb0\u5f97\u63d0\u4ea4\u4fee\u6539\uff08\u547d\u4ee4\u884c\u4e2d-m\u540e\u7684\u5b57\u7b26\u4e32\u53ef\u81ea\u884c\u786e\u5b9a\uff09\uff0c\u4ee5\u4fbf\u5728\u540e\u7eed\u5b9e\u9a8c\u4e2d\u7ee7\u627flab3_1\u4e2d\u6240\u505a\u7684\u5de5\u4f5c\uff1a</p> <pre><code>$ git commit -a -m \"my work on lab3_1 is done.\"\n</code></pre> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter5_process/#53-lab3_2-yield","title":"5.3 lab3_2 \u8fdb\u7a0byield","text":""},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter5_process/#_5","title":"\u7ed9\u5b9a\u5e94\u7528","text":"<ul> <li>user/app_yield.c</li> </ul> <pre><code>  1 /*\n  2  * The application of lab3_2.\n  3  * parent and child processes intermittently give up their processors.\n  4  */\n5\n6 #include \"user/user_lib.h\"\n7 #include \"util/types.h\"\n8\n9 int main(void) {\n10   uint64 pid = fork();\n11   uint64 rounds = 0xffff;\n12   if (pid == 0) {\n13     printu(\"Child: Hello world! \\n\");\n14     for (uint64 i = 0; i &lt; rounds; ++i) {\n15       if (i % 10000 == 0) {\n16         printu(\"Child running %ld \\n\", i);\n17         yield();\n18       }\n19     }\n20   } else {\n21     printu(\"Parent: Hello world! \\n\");\n22     for (uint64 i = 0; i &lt; rounds; ++i) {\n23       if (i % 10000 == 0) {\n24         printu(\"Parent running %ld \\n\", i);\n25         yield();\n26       }\n27     }\n28   }\n29\n30   exit(0);\n31   return 0;\n32 }\n</code></pre> <p>\u548clab3_1\u4e00\u6837\uff0c\u4ee5\u4e0a\u7684\u5e94\u7528\u7a0b\u5e8f\u901a\u8fc7fork\u7cfb\u7edf\u8c03\u7528\u521b\u5efa\u4e86\u4e00\u4e2a\u5b50\u8fdb\u7a0b\uff0c\u63a5\u4e0b\u6765\uff0c\u7236\u8fdb\u7a0b\u548c\u5b50\u8fdb\u7a0b\u90fd\u8fdb\u5165\u4e86\u4e00\u4e2a\u5f88\u957f\u7684\u5faa\u73af\u3002\u5728\u5faa\u73af\u4e2d\uff0c\u65e0\u8bba\u662f\u7236\u8fdb\u7a0b\u8fd8\u662f\u5b50\u8fdb\u7a0b\uff0c\u5728\u5faa\u73af\u7684\u6b21\u6570\u662f10000\u7684\u6574\u6570\u500d\u65f6\uff0c\u9664\u4e86\u6253\u5370\u4fe1\u606f\u5916\u90fd\u8c03\u7528\u4e86yield()\u51fd\u6570\uff0c\u6765\u91ca\u653e\u81ea\u5df1\u7684\u6267\u884c\u6743\uff08\u5373CPU\uff09\u3002</p> <ul> <li>\uff08\u5148\u63d0\u4ea4lab3_1\u7684\u7b54\u6848\uff0c\u7136\u540e\uff09\u5207\u6362\u5230lab3_2\uff0c\u7ee7\u627flab3_1\u53ca\u4e4b\u524d\u5b9e\u9a8c\u6240\u505a\u7684\u4fee\u6539\uff0c\u5e76make\u540e\u7684\u76f4\u63a5\u8fd0\u884c\u7ed3\u679c\uff1a</li> </ul> <pre><code>//\u5207\u6362\u5230lab3_2\n$ git checkout lab3_2_yield\n\n//\u7ee7\u627flab3_1\u4ee5\u53ca\u4e4b\u524d\u7684\u7b54\u6848\n$ git merge lab3_1_fork -m \"continue to work on lab3_2\"\n//\u91cd\u65b0\u6784\u9020\n$ make clean; make\n\n//\u8fd0\u884c\u6784\u9020\u7ed3\u679c\n$ spike ./obj/riscv-pke ./obj/app_yield\nIn m_start, hartid:0\nHTIF is available!\n(Emulated) memory size: 2048 MB\nEnter supervisor mode...\nPKE kernel start 0x0000000080000000, PKE kernel end: 0x0000000080010000, PKE kernel size: 0x0000000000010000 .\nfree physical memory address: [0x0000000080010000, 0x0000000087ffffff]\nkernel memory manager is initializing ...\nKERN_BASE 0x0000000080000000\nphysical address of _etext is: 0x0000000080005000\nkernel page table is on\nSwitching to user mode...\nin alloc_proc. user frame 0x0000000087fbc000, user stack 0x000000007ffff000, user kstack 0x0000000087fbb000\nUser application is loading.\nApplication: ./obj/app_yield\nCODE_SEGMENT added at mapped info offset:3\nApplication program entry point (virtual address): 0x000000000001017c\ngoing to insert process 0 to ready queue.\ngoing to schedule process 0 to run.\nUser call fork.\nwill fork a child from parent 0.\nin alloc_proc. user frame 0x0000000087faf000, user stack 0x000000007ffff000, user kstack 0x0000000087fae000\ndo_fork map code segment at pa:0000000087fb2000 of parent to child at va:0000000000010000.\ngoing to insert process 1 to ready queue.\nParent: Hello world!\nParent running 0\nYou need to implement the yield syscall in lab3_2.\n\nSystem is shutting down with exit code -1.\n</code></pre> <p>\u4ece\u4ee5\u4e0a\u8f93\u51fa\u6765\u770b\uff0c\u8fd8\u662f\u56e0\u4e3aPKE\u64cd\u4f5c\u7cfb\u7edf\u4e2d\u7684yield()\u529f\u80fd\u672a\u5b8c\u5584\uff0c\u5bfc\u81f4\u5e94\u7528\u65e0\u6cd5\u6b63\u5e38\u6267\u884c\u4e0b\u53bb\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter5_process/#_6","title":"\u5b9e\u9a8c\u5185\u5bb9","text":"<p>\u5b8c\u5584yield\u7cfb\u7edf\u8c03\u7528\uff0c\u5b9e\u73b0\u8fdb\u7a0b\u6267\u884c\u8fc7\u7a0b\u4e2d\u7684\u4e3b\u52a8\u91ca\u653eCPU\u7684\u52a8\u4f5c\u3002\u5b9e\u9a8c\u5b8c\u6210\u540e\uff0c\u83b7\u5f97\u4ee5\u4e0b\u9884\u671f\u7ed3\u679c\uff1a</p> <pre><code>$ spike ./obj/riscv-pke ./obj/app_yield\nIn m_start, hartid:0\nHTIF is available!\n(Emulated) memory size: 2048 MB\nEnter supervisor mode...\nPKE kernel start 0x0000000080000000, PKE kernel end: 0x0000000080010000, PKE kernel size: 0x0000000000010000 .\nfree physical memory address: [0x0000000080010000, 0x0000000087ffffff]\nkernel memory manager is initializing ...\nKERN_BASE 0x0000000080000000\nphysical address of _etext is: 0x0000000080005000\nkernel page table is on\nSwitching to user mode...\nin alloc_proc. user frame 0x0000000087fbc000, user stack 0x000000007ffff000, user kstack 0x0000000087fbb000\nUser application is loading.\nApplication: ./obj/app_yield\nCODE_SEGMENT added at mapped info offset:3\nApplication program entry point (virtual address): 0x000000000001017c\ngoing to insert process 0 to ready queue.\ngoing to schedule process 0 to run.\nUser call fork.\nwill fork a child from parent 0.\nin alloc_proc. user frame 0x0000000087faf000, user stack 0x000000007ffff000, user kstack 0x0000000087fae000\ndo_fork map code segment at pa:0000000087fb2000 of parent to child at va:0000000000010000.\ngoing to insert process 1 to ready queue.\nParent: Hello world!\nParent running 0\ngoing to insert process 0 to ready queue.\ngoing to schedule process 1 to run.\nChild: Hello world!\nChild running 0\ngoing to insert process 1 to ready queue.\ngoing to schedule process 0 to run.\nParent running 10000\ngoing to insert process 0 to ready queue.\ngoing to schedule process 1 to run.\nChild running 10000\ngoing to insert process 1 to ready queue.\ngoing to schedule process 0 to run.\nParent running 20000\ngoing to insert process 0 to ready queue.\ngoing to schedule process 1 to run.\nChild running 20000\ngoing to insert process 1 to ready queue.\ngoing to schedule process 0 to run.\nParent running 30000\ngoing to insert process 0 to ready queue.\ngoing to schedule process 1 to run.\nChild running 30000\ngoing to insert process 1 to ready queue.\ngoing to schedule process 0 to run.\nParent running 40000\ngoing to insert process 0 to ready queue.\ngoing to schedule process 1 to run.\nChild running 40000\ngoing to insert process 1 to ready queue.\ngoing to schedule process 0 to run.\nParent running 50000\ngoing to insert process 0 to ready queue.\ngoing to schedule process 1 to run.\nChild running 50000\ngoing to insert process 1 to ready queue.\ngoing to schedule process 0 to run.\nParent running 60000\ngoing to insert process 0 to ready queue.\ngoing to schedule process 1 to run.\nChild running 60000\ngoing to insert process 1 to ready queue.\ngoing to schedule process 0 to run.\nUser exit with code:0.\ngoing to schedule process 1 to run.\nUser exit with code:0.\nno more ready processes, system shutdown now.\nSystem is shutting down with exit code 0.\n</code></pre> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter5_process/#_7","title":"\u5b9e\u9a8c\u6307\u5bfc","text":"<p>\u8fdb\u7a0b\u91ca\u653eCPU\u7684\u52a8\u4f5c\u5e94\u8be5\u662f\uff1a</p> <ul> <li>\u5c06\u5f53\u524d\u8fdb\u7a0b\u7f6e\u4e3a\u5c31\u7eea\u72b6\u6001\uff08READY\uff09\uff1b</li> <li>\u5c06\u5f53\u524d\u8fdb\u7a0b\u52a0\u5165\u5230\u5c31\u7eea\u961f\u5217\u7684\u961f\u5c3e\uff1b</li> <li>\u8f6c\u8fdb\u7a0b\u8c03\u5ea6\u3002</li> </ul> <p>\u5b9e\u9a8c\u5b8c\u6bd5\u540e\uff0c\u8bb0\u5f97\u63d0\u4ea4\u4fee\u6539\uff08\u547d\u4ee4\u884c\u4e2d-m\u540e\u7684\u5b57\u7b26\u4e32\u53ef\u81ea\u884c\u786e\u5b9a\uff09\uff0c\u4ee5\u4fbf\u5728\u540e\u7eed\u5b9e\u9a8c\u4e2d\u7ee7\u627flab3_2\u4e2d\u6240\u505a\u7684\u5de5\u4f5c\uff1a</p> <pre><code>$ git commit -a -m \"my work on lab3_2 is done.\"\n</code></pre> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter5_process/#54-lab3_3","title":"5.4 lab3_3 \u5faa\u73af\u8f6e\u8f6c\u8c03\u5ea6","text":""},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter5_process/#_8","title":"\u7ed9\u5b9a\u5e94\u7528","text":"<pre><code>  1 /*\n  2  * The application of lab3_3.\n  3  * parent and child processes never give up their processor during execution.\n  4  */\n5\n6 #include \"user/user_lib.h\"\n7 #include \"util/types.h\"\n8\n9 int main(void) {\n10   uint64 pid = fork();\n11   uint64 rounds = 100000000;\n12   uint64 interval = 10000000;\n13   uint64 a = 0;\n14   if (pid == 0) {\n15     printu(\"Child: Hello world! \\n\");\n16     for (uint64 i = 0; i &lt; rounds; ++i) {\n17       if (i % interval == 0) printu(\"Child running %ld \\n\", i);\n18     }\n19   } else {\n20     printu(\"Parent: Hello world! \\n\");\n21     for (uint64 i = 0; i &lt; rounds; ++i) {\n22       if (i % interval == 0) printu(\"Parent running %ld \\n\", i);\n23     }\n24   }\n25\n26   exit(0);\n27   return 0;\n28 }\n</code></pre> <p>\u548clab3_2\u7c7b\u4f3c\uff0clab3_3\u7ed9\u51fa\u7684\u5e94\u7528\u4ecd\u7136\u662f\u7236\u5b50\u4e24\u4e2a\u8fdb\u7a0b\uff0c\u4ed6\u4eec\u7684\u6267\u884c\u4f53\u90fd\u662f\u4e24\u4e2a\u5927\u5faa\u73af\u3002\u4f46\u4e0elab3_2\u4e0d\u540c\u7684\u662f\uff0c\u8fd9\u4e24\u4e2a\u8fdb\u7a0b\u5728\u6267\u884c\u5404\u81ea\u5faa\u73af\u4f53\u65f6\uff0c\u90fd\u6ca1\u6709\u4e3b\u52a8\u91ca\u653eCPU\u7684\u52a8\u4f5c\u3002\u663e\u7136\uff0c\u8fd9\u6837\u7684\u8bbe\u8ba1\u4f1a\u5bfc\u81f4\u67d0\u4e2a\u8fdb\u7a0b\u957f\u671f\u5360\u636eCPU\uff0c\u800c\u53e6\u4e00\u4e2a\u8fdb\u7a0b\u65e0\u6cd5\u5f97\u5230\u6267\u884c\u3002</p> <ul> <li>\uff08\u5148\u63d0\u4ea4lab3_2\u7684\u7b54\u6848\uff0c\u7136\u540e\uff09\u5207\u6362\u5230lab3_3\uff0c\u7ee7\u627flab3_2\u53ca\u4e4b\u524d\u5b9e\u9a8c\u6240\u505a\u7684\u4fee\u6539\uff0c\u5e76make\u540e\u7684\u76f4\u63a5\u8fd0\u884c\u7ed3\u679c\uff1a</li> </ul> <pre><code>//\u5207\u6362\u5230lab3_3\n$ git checkout lab3_3_rrsched\n\n//\u7ee7\u627flab3_2\u4ee5\u53ca\u4e4b\u524d\u7684\u7b54\u6848\n$ git merge lab3_2_yield -m \"continue to work on lab3_3\"\n//\u91cd\u65b0\u6784\u9020\n$ make clean; make\n\n//\u8fd0\u884c\u6784\u9020\u7ed3\u679c\n$ spike ./obj/riscv-pke ./obj/app_two_long_loops\nIn m_start, hartid:0\nHTIF is available!\n(Emulated) memory size: 2048 MB\nEnter supervisor mode...\nPKE kernel start 0x0000000080000000, PKE kernel end: 0x0000000080010000, PKE kernel size: 0x0000000000010000 .\nfree physical memory address: [0x0000000080010000, 0x0000000087ffffff]\nkernel memory manager is initializing ...\nKERN_BASE 0x0000000080000000\nphysical address of _etext is: 0x0000000080005000\nkernel page table is on\nSwitching to user mode...\nin alloc_proc. user frame 0x0000000087fbc000, user stack 0x000000007ffff000, user kstack 0x0000000087fbb000\nUser application is loading.\nApplication: ./obj/app_two_long_loops\nCODE_SEGMENT added at mapped info offset:3\nApplication program entry point (virtual address): 0x000000000001017c\ngoing to insert process 0 to ready queue.\ngoing to schedule process 0 to run.\nUser call fork.\nwill fork a child from parent 0.\nin alloc_proc. user frame 0x0000000087faf000, user stack 0x000000007ffff000, user kstack 0x0000000087fae000\ndo_fork map code segment at pa:0000000087fb2000 of parent to child at va:0000000000010000.\ngoing to insert process 1 to ready queue.\nParent: Hello world!\nParent running 0\nParent running 10000000\nTicks 0\nYou need to further implement the timer handling in lab3_3.\n\nSystem is shutting down with exit code -1.\n</code></pre> <p>\u56de\u987e\u5b9e\u9a8c1\u7684lab1_3\uff0c\u6211\u4eec\u770b\u5230\u7531\u4e8e\u8fdb\u7a0b\u7684\u6267\u884c\u4f53\u5f88\u957f\uff0c\u6267\u884c\u8fc7\u7a0b\u4e2d\u65f6\u949f\u4e2d\u65ad\u88ab\u89e6\u53d1\uff08\u8f93\u51fa\u4e2d\u7684\u201cTicks 0\u201d\uff09\u3002\u663e\u7136\uff0c\u6211\u4eec\u53ef\u4ee5\u901a\u8fc7\u5229\u7528\u65f6\u949f\u4e2d\u65ad\u6765\u5b9e\u73b0\u8fdb\u7a0b\u7684\u5faa\u73af\u8f6e\u8f6c\u8c03\u5ea6\uff0c\u907f\u514d\u7531\u4e8e\u4e00\u4e2a\u8fdb\u7a0b\u7684\u6267\u884c\u4f53\u8fc7\u957f\uff0c\u5bfc\u81f4\u7cfb\u7edf\u4e2d\u5176\u4ed6\u8fdb\u7a0b\u65e0\u6cd5\u5f97\u5230\u8c03\u5ea6\u7684\u95ee\u9898\uff01</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter5_process/#_9","title":"\u5b9e\u9a8c\u5185\u5bb9","text":"<p>\u5b9e\u73b0kernel/strap.c\u6587\u4ef6\u4e2d\u7684rrsched()\u51fd\u6570\uff0c\u83b7\u5f97\u4ee5\u4e0b\u9884\u671f\u7ed3\u679c\uff1a</p> <pre><code>$ spike ./obj/riscv-pke ./obj/app_two_long_loops\nIn m_start, hartid:0\nHTIF is available!\n(Emulated) memory size: 2048 MB\nEnter supervisor mode...\nPKE kernel start 0x0000000080000000, PKE kernel end: 0x0000000080010000, PKE kernel size: 0x0000000000010000 .\nfree physical memory address: [0x0000000080010000, 0x0000000087ffffff]\nkernel memory manager is initializing ...\nKERN_BASE 0x0000000080000000\nphysical address of _etext is: 0x0000000080005000\nkernel page table is on\nSwitching to user mode...\nin alloc_proc. user frame 0x0000000087fbc000, user stack 0x000000007ffff000, user kstack 0x0000000087fbb000\nUser application is loading.\nApplication: ./obj/app_two_long_loops\nCODE_SEGMENT added at mapped info offset:3\nApplication program entry point (virtual address): 0x000000000001017c\ngoing to insert process 0 to ready queue.\ngoing to schedule process 0 to run.\nUser call fork.\nwill fork a child from parent 0.\nin alloc_proc. user frame 0x0000000087faf000, user stack 0x000000007ffff000, user kstack 0x0000000087fae000\ndo_fork map code segment at pa:0000000087fb2000 of parent to child at va:0000000000010000.\ngoing to insert process 1 to ready queue.\nParent: Hello world!\nParent running 0\nParent running 10000000\nTicks 0\nParent running 20000000\nTicks 1\ngoing to insert process 0 to ready queue.\ngoing to schedule process 1 to run.\nChild: Hello world!\nChild running 0\nChild running 10000000\nTicks 2\nChild running 20000000\nTicks 3\ngoing to insert process 1 to ready queue.\ngoing to schedule process 0 to run.\nParent running 30000000\nTicks 4\nParent running 40000000\nTicks 5\ngoing to insert process 0 to ready queue.\ngoing to schedule process 1 to run.\nChild running 30000000\nTicks 6\nChild running 40000000\nTicks 7\ngoing to insert process 1 to ready queue.\ngoing to schedule process 0 to run.\nParent running 50000000\nParent running 60000000\nTicks 8\nParent running 70000000\nTicks 9\ngoing to insert process 0 to ready queue.\ngoing to schedule process 1 to run.\nChild running 50000000\nChild running 60000000\nTicks 10\nChild running 70000000\nTicks 11\ngoing to insert process 1 to ready queue.\ngoing to schedule process 0 to run.\nParent running 80000000\nTicks 12\nParent running 90000000\nTicks 13\ngoing to insert process 0 to ready queue.\ngoing to schedule process 1 to run.\nChild running 80000000\nTicks 14\nChild running 90000000\nTicks 15\ngoing to insert process 1 to ready queue.\ngoing to schedule process 0 to run.\nUser exit with code:0.\ngoing to schedule process 1 to run.\nUser exit with code:0.\nno more ready processes, system shutdown now.\nSystem is shutting down with exit code 0.\n</code></pre> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter5_process/#_10","title":"\u5b9e\u9a8c\u6307\u5bfc","text":"<p>\u5b9e\u9645\u4e0a\uff0c\u5982\u679c\u5355\u7eaf\u4e3a\u4e86\u5b9e\u73b0\u8fdb\u7a0b\u7684\u8f6e\u8f6c\uff0c\u907f\u514d\u5355\u4e2a\u8fdb\u7a0b\u957f\u671f\u9738\u5360CPU\u7684\u60c5\u51b5\uff0c\u53ea\u9700\u8981\u7b80\u5355\u5730\u5728\u65f6\u949f\u4e2d\u65ad\u88ab\u89e6\u53d1\u65f6\u505a\u91cd\u65b0\u8c03\u5ea6\u5373\u53ef\u3002\u7136\u800c\uff0c\u4e3a\u4e86\u5b9e\u73b0\u65f6\u95f4\u7247\u7684\u6982\u5ff5\uff0c\u4ee5\u53ca\u63a7\u5236\u8fdb\u7a0b\u5728\u5355\u65f6\u95f4\u7247\u5185\u83b7\u5f97\u7684\u6267\u884c\u957f\u5ea6\uff0c\u6211\u4eec\u5728kernel/sched.h\u6587\u4ef6\u4e2d\u5b9a\u4e49\u4e86\u201c\u65f6\u95f4\u7247\u201d\u7684\u957f\u5ea6\uff1a</p> <pre><code>  6 //length of a time slice, in number of ticks\n7 #define TIME_SLICE_LEN  2\n</code></pre> <p>\u53ef\u4ee5\u770b\u5230\u65f6\u95f4\u7247\u7684\u957f\u5ea6\uff08TIME_SLICE_LEN\uff09\u4e3a2\u4e2aticks\uff0c\u8fd9\u5c31\u610f\u5473\u7740\u6211\u4eec\u8981\u6bcf\u9694\u4e24\u4e2aticks\u89e6\u53d1\u4e00\u6b21\u8fdb\u7a0b\u91cd\u65b0\u8c03\u5ea6\u52a8\u4f5c\u3002</p> <p>\u4e3a\u914d\u5408\u8c03\u5ea6\u7684\u5b9e\u73b0\uff0c\u6211\u4eec\u5728\u8fdb\u7a0b\u7ed3\u6784\u4e2d\u5b9a\u4e49\u4e86\u6574\u578b\u6210\u5458\uff08\u53c2\u89c15.1.1\uff09tick_count\uff0c\u5b8c\u5584kernel/strap.c\u6587\u4ef6\u4e2d\u7684rrsched()\u51fd\u6570\uff0c\u4ee5\u5b9e\u73b0\u5faa\u73af\u8f6e\u8f6c\u8c03\u5ea6\u65f6\uff0c\u5e94\u91c7\u53d6\u7684\u903b\u8f91\u4e3a\uff1a</p> <ul> <li>\u5224\u65ad\u5f53\u524d\u8fdb\u7a0b\u7684tick_count\u52a01\u540e\u662f\u5426\u5927\u4e8e\u7b49\u4e8eTIME_SLICE_LEN\uff1f</li> <li>\u82e5\u7b54\u6848\u4e3ayes\uff0c\u5219\u5e94\u5c06\u5f53\u524d\u8fdb\u7a0b\u7684tick_count\u6e05\u96f6\uff0c\u5e76\u5c06\u5f53\u524d\u8fdb\u7a0b\u52a0\u5165\u5c31\u7eea\u961f\u5217\uff0c\u8f6c\u8fdb\u7a0b\u8c03\u5ea6\uff1b</li> <li>\u82e5\u7b54\u6848\u4e3ano\uff0c\u5219\u5e94\u5c06\u5f53\u524d\u8fdb\u7a0b\u7684tick_count\u52a01\uff0c\u5e76\u8fd4\u56de\u3002</li> </ul> <p>\u5b9e\u9a8c\u5b8c\u6bd5\u540e\uff0c\u8bb0\u5f97\u63d0\u4ea4\u4fee\u6539\uff08\u547d\u4ee4\u884c\u4e2d-m\u540e\u7684\u5b57\u7b26\u4e32\u53ef\u81ea\u884c\u786e\u5b9a\uff09\uff0c\u4ee5\u4fbf\u5728\u540e\u7eed\u5b9e\u9a8c\u4e2d\u7ee7\u627flab3_3\u4e2d\u6240\u505a\u7684\u5de5\u4f5c\uff1a</p> <pre><code>$ git commit -a -m \"my work on lab3_3 is done.\"\n</code></pre> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter5_process/#55-lab3_challenge1","title":"5.5 lab3_challenge1 \u8fdb\u7a0b\u7b49\u5f85\u548c\u6570\u636e\u6bb5\u590d\u5236\uff08\u96be\u5ea6\uff1a\u2605\u2605\u2606\u2606\u2606\uff09","text":""},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter5_process/#_11","title":"\u7ed9\u5b9a\u5e94\u7528","text":"<ul> <li>user/app_wait.c</li> </ul> <pre><code>  1 /*                                                                             \n  2  * This app fork a child process, and the child process fork a grandchild process.\n  3  * every process waits for its own child exit then prints.                     \n  4  * Three processes also write their own global variables \"flag\"\n  5  * to different values.\n  6  */\n7 8 #include \"user/user_lib.h\"\n9 #include \"util/types.h\"\n10 11 int flag;\n12 int main(void) {\n13     flag = 0;\n14     int pid = fork();\n15     if (pid == 0) {\n16         flag = 1;\n17         pid = fork();\n18         if (pid == 0) {\n19             flag = 2;\n20             printu(\"Grandchild process end, flag = %d.\\n\", flag);\n21         } else {\n22             wait(pid);\n23             printu(\"Child process end, flag = %d.\\n\", flag);\n24         }\n25     } else {\n26         wait(-1);\n27         printu(\"Parent process end, flag = %d.\\n\", flag);\n28     }\n29     exit(0);\n30     return 0;\n31 }\n</code></pre> <p>wait\u7cfb\u7edf\u8c03\u7528\u662f\u8fdb\u7a0b\u7ba1\u7406\u4e2d\u4e00\u4e2a\u975e\u5e38\u91cd\u8981\u7684\u7cfb\u7edf\u8c03\u7528\uff0c\u5b83\u4e3b\u8981\u6709\u4e24\u5927\u529f\u80fd\uff1a</p> <ul> <li>\u5f53\u4e00\u4e2a\u8fdb\u7a0b\u9000\u51fa\u4e4b\u540e\uff0c\u5b83\u6240\u5360\u7528\u7684\u8d44\u6e90\u5e76\u4e0d\u4e00\u5b9a\u80fd\u591f\u7acb\u5373\u56de\u6536\uff0c\u6bd4\u5982\u8be5\u8fdb\u7a0b\u7684\u5185\u6838\u6808\u76ee\u524d\u5c31\u6b63\u7528\u6765\u8fdb\u884c\u7cfb\u7edf\u8c03\u7528\u5904\u7406\u3002\u5bf9\u4e8e\u8fd9\u79cd\u95ee\u9898\uff0c\u4e00\u79cd\u5178\u578b\u7684\u505a\u6cd5\u662f\u5f53\u8fdb\u7a0b\u9000\u51fa\u7684\u65f6\u5019\u5185\u6838\u7acb\u5373\u56de\u6536\u4e00\u90e8\u5206\u8d44\u6e90\u5e76\u5c06\u8be5\u8fdb\u7a0b\u6807\u8bb0\u4e3a\u50f5\u5c38\u8fdb\u7a0b\u3002\u7531\u7236\u8fdb\u7a0b\u8c03\u7528wait\u51fd\u6570\u7684\u65f6\u5019\u518d\u56de\u6536\u8be5\u8fdb\u7a0b\u7684\u5176\u4ed6\u8d44\u6e90\u3002</li> <li>\u7236\u8fdb\u7a0b\u7684\u6709\u4e9b\u64cd\u4f5c\u9700\u8981\u5b50\u8fdb\u7a0b\u8fd0\u884c\u7ed3\u675f\u540e\u83b7\u5f97\u7ed3\u679c\u624d\u80fd\u7ee7\u7eed\u6267\u884c\uff0c\u8fd9\u65f6wait\u51fd\u6570\u8d77\u5230\u8fdb\u7a0b\u540c\u6b65\u7684\u4f5c\u7528\u3002</li> </ul> <p>\u5728\u4ee5\u4e0a\u7a0b\u5e8f\u4e2d\uff0c\u7236\u8fdb\u7a0b\u628aflag\u53d8\u91cf\u8d4b\u503c\u4e3a0\uff0c\u7136\u540efork\u751f\u6210\u4e00\u4e2a\u5b50\u8fdb\u7a0b\uff0c\u63a5\u7740\u901a\u8fc7wait\u51fd\u6570\u7b49\u5f85\u5b50\u8fdb\u7a0b\u7684\u9000\u51fa\u3002\u5b50\u8fdb\u7a0b\u628a\u81ea\u5df1\u7684\u53d8\u91cfflag\u8d4b\u503c\u4e3a1\uff0c\u7136\u540efork\u751f\u6210\u5b59\u5b50\u8fdb\u7a0b\uff0c\u63a5\u7740\u901a\u8fc7wait\u51fd\u6570\u7b49\u5f85\u5b59\u5b50\u8fdb\u7a0b\u7684\u9000\u51fa\u3002\u5b59\u5b50\u8fdb\u7a0b\u7ed9\u81ea\u5df1\u7684\u53d8\u91cfflag\u8d4b\u503c\u4e3a2\u5e76\u5728\u9000\u51fa\u65f6\u8f93\u51fa\u4fe1\u606f\uff0c\u7136\u540e\u5b50\u8fdb\u7a0b\u9000\u51fa\u65f6\u8f93\u51fa\u4fe1\u606f\uff0c\u6700\u540e\u7236\u8fdb\u7a0b\u9000\u51fa\u65f6\u8f93\u51fa\u4fe1\u606f\u3002\u7531\u4e8efork\u4e4b\u540e\u7236\u5b50\u8fdb\u7a0b\u7684\u6570\u636e\u6bb5\u76f8\u4e92\u72ec\u7acb\uff08\u540c\u4e00\u865a\u62df\u5730\u5740\u5bf9\u5e94\u4e0d\u540c\u7684\u7269\u7406\u5730\u5740\uff09\uff0c\u5b50\u8fdb\u7a0b\u5bf9\u5168\u5c40\u53d8\u91cf\u7684\u8d4b\u503c\u4e0d\u5f71\u54cd\u7236\u8fdb\u7a0b\u5168\u5c40\u53d8\u91cf\u7684\u503c\uff0c\u56e0\u6b64\u7ed3\u679c\u5982\u4e0b\uff1a</p> <pre><code>In m_start, hartid:0\nHTIF is available!\n(Emulated) memory size: 2048 MB\nEnter supervisor mode...\nPKE kernel start 0x0000000080000000, PKE kernel end: 0x0000000080009000, PKE kernel size: 0x0000000000009000 .\nfree physical memory address: [0x0000000080009000, 0x0000000087ffffff] kernel memory manager is initializing ...\nKERN_BASE 0x0000000080000000\nphysical address of _etext is: 0x0000000080005000\nkernel page table is on Switch to user mode...\nin alloc_proc. user frame 0x0000000087fbc000, user stack 0x000000007ffff000, user kstack 0x0000000087fbb000 User application is loading.\nApplication: obj/app_wait\nCODE_SEGMENT added at mapped info offset:3\nDATA_SEGMENT added at mapped info offset:4\nApplication program entry point (virtual address): 0x00000000000100b0\ngoing to insert process 0 to ready queue.\ngoing to schedule process 0 to run.\nUser call fork.\nwill fork a child from parent 0.\nin alloc_proc. user frame 0x0000000087fae000, user stack 0x000000007ffff000, user kstack 0x0000000087fad000 do_fork map code segment at pa:0000000087fb2000 of parent to child at va:0000000000010000.\ngoing to insert process 1 to ready queue.\ngoing to schedule process 1 to run.\nUser call fork.\nwill fork a child from parent 1.\nin alloc_proc. user frame 0x0000000087fa1000, user stack 0x000000007ffff000, user kstack 0x0000000087fa0000 do_fork map code segment at pa:0000000087fb2000 of parent to child at va:0000000000010000.\ngoing to insert process 2 to ready queue.\ngoing to schedule process 2 to run.\nGrandchild process end, flag = 2.\nUser exit with code:0.\ngoing to insert process 1 to ready queue.\ngoing to schedule process 1 to run.\nChild process end, flag = 1.\nUser exit with code:0.\ngoing to insert process 0 to ready queue.\ngoing to schedule process 0 to run.\nParent process end, flag = 0.\nUser exit with code:0.\nno more ready processes, system shutdown now.\nSystem is shutting down with exit code 0.\n</code></pre> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter5_process/#_12","title":"\u5b9e\u9a8c\u5185\u5bb9","text":"<p>\u672c\u5b9e\u9a8c\u4e3a\u6311\u6218\u5b9e\u9a8c\uff0c\u57fa\u7840\u4ee3\u7801\u5c06\u7ee7\u627f\u548c\u4f7f\u7528lab3_3\u5b8c\u6210\u540e\u7684\u4ee3\u7801\uff1a</p> <ul> <li>\uff08\u5148\u63d0\u4ea4lab3_3\u7684\u7b54\u6848\uff0c\u7136\u540e\uff09\u5207\u6362\u5230lab3_challenge1_wait\u3001\u7ee7\u627flab3_3\u4e2d\u6240\u505a\u4fee\u6539\uff1a</li> </ul> <pre><code>//\u5207\u6362\u5230lab3_challenge1_wait\n$ git checkout lab3_challenge1_wait\n\n//\u7ee7\u627flab3_3\u4ee5\u53ca\u4e4b\u524d\u7684\u7b54\u6848\n$ git merge lab3_3_rrsched -m \"continue to work on lab3_challenge1\"\n</code></pre> <p>\u6ce8\u610f\uff1a\u4e0d\u540c\u4e8e\u57fa\u7840\u5b9e\u9a8c\uff0c\u6311\u6218\u5b9e\u9a8c\u7684\u57fa\u7840\u4ee3\u7801\u5177\u6709\u66f4\u5927\u7684\u4e0d\u5b8c\u6574\u6027\uff0c\u53ef\u80fd\u65e0\u6cd5\u76f4\u63a5\u901a\u8fc7\u6784\u9020\u8fc7\u7a0b\u3002 \u540c\u6837\uff0c\u4e0d\u540c\u4e8e\u57fa\u7840\u5b9e\u9a8c\uff0c\u6211\u4eec\u5728\u4ee3\u7801\u4e2d\u4e5f\u5e76\u672a\u4e13\u95e8\u5730\u54ea\u4e9b\u5730\u65b9\u7684\u4ee3\u7801\u9700\u8981\u586b\u5199\uff0c\u54ea\u4e9b\u5730\u65b9\u7684\u4ee3\u7801\u65e0\u987b\u586b\u5199\u3002\u8fd9\u6837\uff0c\u6211\u4eec\u7559\u7ed9\u8bfb\u8005\u66f4\u5927\u7684\u201c\u60f3\u8c61\u7a7a\u95f4\u201d\u3002</p> <ul> <li>\u672c\u5b9e\u9a8c\u7684\u5177\u4f53\u8981\u6c42\u4e3a\uff1a</li> <li>\u901a\u8fc7\u4fee\u6539PKE\u5185\u6838\u548c\u7cfb\u7edf\u8c03\u7528\uff0c\u4e3a\u7528\u6237\u7a0b\u5e8f\u63d0\u4f9bwait\u51fd\u6570\u7684\u529f\u80fd\uff0cwait\u51fd\u6570\u63a5\u53d7\u4e00\u4e2a\u53c2\u6570pid\uff1a<ul> <li>\u5f53pid\u4e3a-1\u65f6\uff0c\u7236\u8fdb\u7a0b\u7b49\u5f85\u4efb\u610f\u4e00\u4e2a\u5b50\u8fdb\u7a0b\u9000\u51fa\u5373\u8fd4\u56de\u5b50\u8fdb\u7a0b\u7684pid\uff1b</li> <li>\u5f53pid\u5927\u4e8e0\u65f6\uff0c\u7236\u8fdb\u7a0b\u7b49\u5f85\u8fdb\u7a0b\u53f7\u4e3apid\u7684\u5b50\u8fdb\u7a0b\u9000\u51fa\u5373\u8fd4\u56de\u5b50\u8fdb\u7a0b\u7684pid\uff1b</li> <li>\u5982\u679cpid\u4e0d\u5408\u6cd5\u6216pid\u5927\u4e8e0\u4e14pid\u5bf9\u5e94\u7684\u8fdb\u7a0b\u4e0d\u662f\u5f53\u524d\u8fdb\u7a0b\u7684\u5b50\u8fdb\u7a0b\uff0c\u8fd4\u56de-1\u3002</li> </ul> </li> <li>\u8865\u5145do_fork\u51fd\u6570\uff0c\u5b9e\u9a8c3_1\u5b9e\u73b0\u4e86\u4ee3\u7801\u6bb5\u7684\u590d\u5236\uff0c\u4f60\u9700\u8981\u7ee7\u7eed\u5b9e\u73b0\u6570\u636e\u6bb5\u7684\u590d\u5236\u5e76\u4fdd\u8bc1fork\u540e\u7236\u5b50\u8fdb\u7a0b\u7684\u6570\u636e\u6bb5\u76f8\u4e92\u72ec\u7acb\u3002</li> <li>\u6ce8\u610f\uff1a\u6700\u7ec8\u6d4b\u8bd5\u7a0b\u5e8f\u53ef\u80fd\u548c\u7ed9\u51fa\u7684\u7528\u6237\u7a0b\u5e8f\u4e0d\u540c\uff0c\u4f46\u90fd\u53ea\u6d89\u53cawait\u51fd\u6570\u3001fork\u51fd\u6570\u548c\u5168\u5c40\u53d8\u91cf\u8bfb\u5199\u7684\u76f8\u5173\u64cd\u4f5c\u3002</li> </ul> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter5_process/#_13","title":"\u5b9e\u9a8c\u6307\u5bfc","text":"<ul> <li>\u4f60\u5bf9\u5185\u6838\u4ee3\u7801\u7684\u4fee\u6539\u53ef\u80fd\u5305\u542b\u6dfb\u52a0\u7cfb\u7edf\u8c03\u7528\u3001\u5728\u5185\u6838\u4e2d\u5b9e\u73b0wait\u51fd\u6570\u7684\u529f\u80fd\u4ee5\u53ca\u5bf9do_fork\u51fd\u6570\u7684\u5b8c\u5584\u3002</li> </ul> <p>\u6ce8\u610f\uff1a\u5b8c\u6210\u5b9e\u9a8c\u5185\u5bb9\u540e\uff0c\u8bf7\u8bfb\u8005\u53e6\u5916\u7f16\u5199\u5e94\u7528\uff0c\u5bf9\u81ea\u5df1\u7684\u5b9e\u73b0\u8fdb\u884c\u68c0\u6d4b\u3002</p> <p>\u53e6\u5916\uff0c\u540e\u7eed\u7684\u57fa\u7840\u5b9e\u9a8c\u4ee3\u7801\u5e76\u4e0d\u4f9d\u8d56\u6311\u6218\u5b9e\u9a8c\uff0c\u6240\u4ee5\u8bfb\u8005\u53ef\u81ea\u884c\u51b3\u5b9a\u662f\u5426\u5c06\u81ea\u5df1\u7684\u5de5\u4f5c\u63d0\u4ea4\u5230\u672c\u5730\u4ee3\u7801\u4ed3\u5e93\u4e2d\uff08\u5f53\u7136\uff0c\u63d0\u4ea4\u5230\u672c\u5730\u4ed3\u5e93\u662f\u4e2a\u597d\u4e60\u60ef\uff0c\u81f3\u5c11\u80fd\u4fdd\u5b58\u81ea\u5df1\u7684\u201c\u4f5c\u54c1\u201d\uff09\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter5_process/#56-lab3_challenge2","title":"5.6 lab3_challenge2 \u5b9e\u73b0\u4fe1\u53f7\u91cf\uff08\u96be\u5ea6\uff1a\u2605\u2605\u2605\u2606\u2606\uff09","text":""},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter5_process/#_14","title":"\u7ed9\u5b9a\u5e94\u7528","text":"<ul> <li>user/app_semaphore.c</li> </ul> <pre><code>  1 /*                                                                                                         2 * This app create two child process.\n  3 * Use semaphores to control the order of\n  4 * the main process and two child processes print info. \n  5 */\n6 #include \"user/user_lib.h\"\n7 #include \"util/types.h\"\n8 9 int main(void) {\n10     int main_sem, child_sem[2];\n11     main_sem = sem_new(1);\n12     for (int i = 0; i &lt; 2; i++) child_sem[i] = sem_new(0);\n13     int pid = fork();\n14     if (pid == 0) {\n15         pid = fork();\n16         for (int i = 0; i &lt; 10; i++) {\n17             sem_P(child_sem[pid == 0]);\n18             printu(\"Child%d print %d\\n\", pid == 0, i);\n19             if (pid != 0) sem_V(child_sem[1]); else sem_V(main_sem);\n20         }\n21     } else {\n22         for (int i = 0; i &lt; 10; i++) {\n23             sem_P(main_sem);\n24             printu(\"Parent print %d\\n\", i);\n25             sem_V(child_sem[0]);\n26         }\n27     }\n28     exit(0);\n29     return 0;\n30 }\n</code></pre> <p>\u4ee5\u4e0a\u7a0b\u5e8f\u901a\u8fc7\u4fe1\u53f7\u91cf\u7684\u589e\u51cf\uff0c\u63a7\u5236\u4e3b\u8fdb\u7a0b\u548c\u4e24\u4e2a\u5b50\u8fdb\u7a0b\u7684\u8f93\u51fa\u6309\u4e3b\u8fdb\u7a0b\uff0c\u7b2c\u4e00\u4e2a\u5b50\u8fdb\u7a0b\uff0c\u7b2c\u4e8c\u4e2a\u5b50\u8fdb\u7a0b\uff0c\u4e3b\u8fdb\u7a0b\uff0c\u7b2c\u4e00\u4e2a\u5b50\u8fdb\u7a0b\uff0c\u7b2c\u4e8c\u4e2a\u5b50\u8fdb\u7a0b\u2026\u2026\u8fd9\u6837\u7684\u987a\u5e8f\u8f6e\u6d41\u8f93\u51fa\uff0c\u5982\u4e0a\u9762\u7684\u5e94\u7528\u9884\u671f\u8f93\u51fa\u5982\u4e0b\uff1a</p> <pre><code>In m_start, hartid:0\nHTIF is available!\n(Emulated) memory size: 2048 MB\nEnter supervisor mode...\nPKE kernel start 0x0000000080000000, PKE kernel end: 0x0000000080009000, PKE kernel size: 0x0000000000009000 .\nfree physical memory address: [0x0000000080009000, 0x0000000087ffffff] kernel memory manager is initializing ...\nKERN_BASE 0x0000000080000000\nphysical address of _etext is: 0x0000000080005000\nkernel page table is on Switch to user mode...\nin alloc_proc. user frame 0x0000000087fbc000, user stack 0x000000007ffff000, user kstack 0x0000000087fbb000 User application is loading.\nApplication: obj/app_semaphore\nCODE_SEGMENT added at mapped info offset:3\nDATA_SEGMENT added at mapped info offset:4\nApplication program entry point (virtual address): 0x00000000000100b0\ngoing to insert process 0 to ready queue.\ngoing to schedule process 0 to run.\nUser call fork.\nwill fork a child from parent 0.\nin alloc_proc. user frame 0x0000000087fae000, user stack 0x000000007ffff000, user kstack 0x0000000087fad000 do_fork map code segment at pa:0000000087fb2000 of parent to child at va:0000000000010000.\ngoing to insert process 1 to ready queue.\nParent print 0\ngoing to schedule process 1 to run.\nUser call fork.\nwill fork a child from parent 1.\nin alloc_proc. user frame 0x0000000087fa2000, user stack 0x000000007ffff000, user kstack 0x0000000087fa1000 do_fork map code segment at pa:0000000087fb2000 of parent to child at va:0000000000010000.\ngoing to insert process 2 to ready queue.\nChild0 print 0\ngoing to schedule process 2 to run.\nChild1 print 0\ngoing to insert process 0 to ready queue.\ngoing to schedule process 0 to run.\nParent print 1\ngoing to insert process 1 to ready queue.\ngoing to schedule process 1 to run.\nChild0 print 1\ngoing to insert process 2 to ready queue.\ngoing to schedule process 2 to run.\nChild1 print 1\ngoing to insert process 0 to ready queue.\ngoing to schedule process 0 to run.\nParent print 2\ngoing to insert process 1 to ready queue.\ngoing to schedule process 1 to run.\nChild0 print 2\ngoing to insert process 2 to ready queue.\ngoing to schedule process 2 to run.\nChild1 print 2\ngoing to insert process 0 to ready queue.\ngoing to schedule process 0 to run.\nParent print 3\ngoing to insert process 1 to ready queue.\ngoing to schedule process 1 to run.\nChild0 print 3\ngoing to insert process 2 to ready queue.\ngoing to schedule process 2 to run.\nChild1 print 3\ngoing to insert process 0 to ready queue.\ngoing to schedule process 0 to run.\nParent print 4\ngoing to insert process 1 to ready queue.\ngoing to schedule process 1 to run.\nChild0 print 4\ngoing to insert process 2 to ready queue.\ngoing to schedule process 2 to run.\nChild1 print 4\ngoing to insert process 0 to ready queue.\ngoing to schedule process 0 to run.\nParent print 5\ngoing to insert process 1 to ready queue.\ngoing to schedule process 1 to run.\nChild0 print 5\ngoing to insert process 2 to ready queue.\ngoing to schedule process 2 to run.\nChild1 print 5\ngoing to insert process 0 to ready queue.\ngoing to schedule process 0 to run.\nParent print 6\ngoing to insert process 1 to ready queue.\ngoing to schedule process 1 to run.\nChild0 print 6\ngoing to insert process 2 to ready queue.\ngoing to schedule process 2 to run.\nChild1 print 6\ngoing to insert process 0 to ready queue.\ngoing to schedule process 0 to run.\nParent print 7\ngoing to insert process 1 to ready queue.\ngoing to schedule process 1 to run.\nChild0 print 7\ngoing to insert process 2 to ready queue.\ngoing to schedule process 2 to run.\nChild1 print 7\ngoing to insert process 0 to ready queue.\ngoing to schedule process 0 to run.\nParent print 8\ngoing to insert process 1 to ready queue.\ngoing to schedule process 1 to run.\nChild0 print 8\ngoing to insert process 2 to ready queue.\ngoing to schedule process 2 to run.\nChild1 print 8\ngoing to insert process 0 to ready queue.\ngoing to schedule process 0 to run.\nParent print 9\ngoing to insert process 1 to ready queue.\nUser exit with code:0.\ngoing to schedule process 1 to run.\nChild0 print 9\ngoing to insert process 2 to ready queue.\nUser exit with code:0.\ngoing to schedule process 2 to run.\nChild1 print 9\nUser exit with code:0.\nno more ready processes, system shutdown now.\nSystem is shutting down with exit code 0.\n</code></pre> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter5_process/#_15","title":"\u5b9e\u9a8c\u5185\u5bb9","text":"<p>\u672c\u5b9e\u9a8c\u4e3a\u6311\u6218\u5b9e\u9a8c\uff0c\u57fa\u7840\u4ee3\u7801\u5c06\u7ee7\u627f\u548c\u4f7f\u7528lab3_3\u5b8c\u6210\u540e\u7684\u4ee3\u7801\uff1a</p> <ul> <li>\uff08\u5148\u63d0\u4ea4lab3_3\u7684\u7b54\u6848\uff0c\u7136\u540e\uff09\u5207\u6362\u5230lab3_challenge2_semaphore\u3001\u7ee7\u627flab3_3\u4e2d\u6240\u505a\u4fee\u6539\uff1a</li> </ul> <pre><code>//\u5207\u6362\u5230lab3_challenge2_semaphore\n$ git checkout lab3_challenge2_semaphore\n\n//\u7ee7\u627flab3_3\u4ee5\u53ca\u4e4b\u524d\u7684\u7b54\u6848\n$ git merge lab3_3_rrsched -m \"continue to work on lab3_challenge1\"\n</code></pre> <p>\u6ce8\u610f\uff1a\u4e0d\u540c\u4e8e\u57fa\u7840\u5b9e\u9a8c\uff0c\u6311\u6218\u5b9e\u9a8c\u7684\u57fa\u7840\u4ee3\u7801\u5177\u6709\u66f4\u5927\u7684\u4e0d\u5b8c\u6574\u6027\uff0c\u53ef\u80fd\u65e0\u6cd5\u76f4\u63a5\u901a\u8fc7\u6784\u9020\u8fc7\u7a0b\u3002 \u540c\u6837\uff0c\u4e0d\u540c\u4e8e\u57fa\u7840\u5b9e\u9a8c\uff0c\u6211\u4eec\u5728\u4ee3\u7801\u4e2d\u4e5f\u5e76\u672a\u4e13\u95e8\u5730\u54ea\u4e9b\u5730\u65b9\u7684\u4ee3\u7801\u9700\u8981\u586b\u5199\uff0c\u54ea\u4e9b\u5730\u65b9\u7684\u4ee3\u7801\u65e0\u987b\u586b\u5199\u3002\u8fd9\u6837\uff0c\u6211\u4eec\u7559\u7ed9\u8bfb\u8005\u66f4\u5927\u7684\u201c\u60f3\u8c61\u7a7a\u95f4\u201d\u3002</p> <ul> <li>\u672c\u5b9e\u9a8c\u7684\u5177\u4f53\u8981\u6c42\u4e3a\uff1a\u901a\u8fc7\u4fee\u6539PKE\u5185\u6838\u548c\u7cfb\u7edf\u8c03\u7528\uff0c\u4e3a\u7528\u6237\u7a0b\u5e8f\u63d0\u4f9b\u4fe1\u53f7\u91cf\u529f\u80fd\u3002</li> <li>\u6ce8\u610f\uff1a\u6700\u7ec8\u6d4b\u8bd5\u7a0b\u5e8f\u53ef\u80fd\u548c\u7ed9\u51fa\u7684\u7528\u6237\u7a0b\u5e8f\u4e0d\u540c\uff0c\u4f46\u90fd\u53ea\u6d89\u53ca\u4fe1\u53f7\u91cf\u7684\u76f8\u5173\u64cd\u4f5c\u3002</li> <li>\u63d0\u793a\uff1a\u4fe1\u53f7\u706f\u7684\u7ed3\u6784\u4e0d\u80fd\u5f00\u592a\u5927\uff0c\u5426\u5219\u4f1a\u5bfc\u81f4kernel_size\u51fa\u73b0\u95ee\u9898</li> </ul> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter5_process/#_16","title":"\u5b9e\u9a8c\u6307\u5bfc","text":"<ul> <li>\u4f60\u5bf9\u5185\u6838\u4ee3\u7801\u7684\u4fee\u6539\u53ef\u80fd\u5305\u542b\u4ee5\u4e0b\u5185\u5bb9\uff1a</li> <li>\u6dfb\u52a0\u7cfb\u7edf\u8c03\u7528\uff0c\u4f7f\u5f97\u7528\u6237\u5bf9\u4fe1\u53f7\u91cf\u7684\u64cd\u4f5c\u53ef\u4ee5\u5728\u5185\u6838\u6001\u5904\u7406</li> <li>\u5728\u5185\u6838\u4e2d\u5b9e\u73b0\u4fe1\u53f7\u91cf\u7684\u5206\u914d\u3001\u91ca\u653e\u548cPV\u64cd\u4f5c\uff0c\u5f53P\u64cd\u4f5c\u5904\u4e8e\u7b49\u5f85\u72b6\u6001\u65f6\u80fd\u591f\u89e6\u53d1\u8fdb\u7a0b\u8c03\u5ea6</li> </ul> <p>\u6ce8\u610f\uff1a\u5b8c\u6210\u5b9e\u9a8c\u5185\u5bb9\u540e\uff0c\u8bf7\u8bfb\u8005\u53e6\u5916\u7f16\u5199\u5e94\u7528\uff0c\u5bf9\u81ea\u5df1\u7684\u5b9e\u73b0\u8fdb\u884c\u68c0\u6d4b\u3002</p> <p>\u53e6\u5916\uff0c\u540e\u7eed\u7684\u57fa\u7840\u5b9e\u9a8c\u4ee3\u7801\u5e76\u4e0d\u4f9d\u8d56\u6311\u6218\u5b9e\u9a8c\uff0c\u6240\u4ee5\u8bfb\u8005\u53ef\u81ea\u884c\u51b3\u5b9a\u662f\u5426\u5c06\u81ea\u5df1\u7684\u5de5\u4f5c\u63d0\u4ea4\u5230\u672c\u5730\u4ee3\u7801\u4ed3\u5e93\u4e2d\uff08\u5f53\u7136\uff0c\u63d0\u4ea4\u5230\u672c\u5730\u4ed3\u5e93\u662f\u4e2a\u597d\u4e60\u60ef\uff0c\u81f3\u5c11\u80fd\u4fdd\u5b58\u81ea\u5df1\u7684\u201c\u4f5c\u54c1\u201d\uff09\u3002</p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter6_device_remove/","title":"Chapter6 device remove","text":""},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter6_device_remove/#4riscv-on-pynq","title":"\u7b2c\u516d\u7ae0\uff0e\u5b9e\u9a8c4\uff1a\u8bbe\u5907\u7ba1\u7406\uff08\u57fa\u4e8eRISCV-on-PYNQ\uff09","text":""},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter6_device_remove/#_1","title":"\u76ee\u5f55","text":"<ul> <li>6.1 \u5b9e\u9a8c4\u7684\u57fa\u7840\u77e5\u8bc6 </li> <li>6.1.1  pynq\u5f00\u53d1\u677f\u4ecb\u7ecd</li> <li>6.1.2  \u8bbe\u5907\u6811 </li> <li>6.1.3  \u5185\u5b58\u6620\u5c04I/O(MMIO) </li> <li>6.1.4  riscv-fesvr\u539f\u7406</li> <li>6.1.5  \u8f6e\u8be2I/O\u63a7\u5236\u65b9\u5f0f</li> <li>6.1.6 \u4e2d\u65ad\u9a71\u52a8I/O\u63a7\u5236\u65b9\u5f0f </li> <li>6.1.7 \u8bbe\u5907\u6587\u4ef6</li> <li>6.2 lab4_1 POLL </li> <li>\u7ed9\u5b9a\u5e94\u7528</li> <li>\u5b9e\u9a8c\u5185\u5bb9</li> <li>\u5b9e\u9a8c\u6307\u5bfc</li> <li>6.3 lab4_2_PLIC </li> <li>\u7ed9\u5b9a\u5e94\u7528</li> <li>\u5b9e\u9a8c\u5185\u5bb9</li> <li>\u5b9e\u9a8c\u6307\u5bfc</li> <li>6.4 lab4_3_hostdevice </li> <li>\u7ed9\u5b9a\u5e94\u7528</li> <li>\u5b9e\u9a8c\u5185\u5bb9</li> <li>\u5b9e\u9a8c\u6307\u5bfc</li> </ul>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter6_device_remove/#61-4","title":"6.1 \u5b9e\u9a8c4\u7684\u57fa\u7840\u77e5\u8bc6","text":"<p>\u5b8c\u6210\u524d\u9762\u6240\u6709\u5b9e\u9a8c\u540e\uff0cPKE\u5185\u6838\u7684\u6574\u4f53\u529f\u80fd\u5df2\u7ecf\u5f97\u5230\u5b8c\u5584\u3002\u5728\u5b9e\u9a8c\u56db\u7684\u8bbe\u5907\u5b9e\u9a8c\u4e2d\uff0c\u6211\u4eec\u5c06\u7ed3\u5408fpga-pynq\u677f\uff0c\u5728rocket chip\u4e0a\u589e\u52a0uart\u6a21\u5757\u548c\u84dd\u7259\u6a21\u5757\uff0c\u5e76\u642d\u8f7dPKE\u5185\u6838\uff0c\u5b9e\u73b0\u84dd\u7259\u901a\u4fe1\u63a7\u5236\u667a\u80fd\u5c0f\u8f66\uff0c\u8bbe\u8ba1\u8bbe\u5907\u7ba1\u7406\u7684\u76f8\u5173\u5b9e\u9a8c\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter6_device_remove/#611-pynq","title":"6.1.1 pynq\u5f00\u53d1\u677f\u4ecb\u7ecd","text":"<p>\u672c\u5b9e\u9a8c\u4e2d\uff0c\u6211\u4eec\u6240\u4f7f\u7528\u7684pynq-z2\u5f00\u53d1\u677f\u4e0a\u642d\u8f7d\u4e24\u5757\u82af\u7247\uff0c\u4e00\u5757\u4e3aArm\u67b6\u678432\u4f4d\u82af\u7247\uff0c\u79f0\u4e3aPS\u7aef\uff0c\u6211\u4eec\u80fd\u5728\u4e0a\u9762\u8fd0\u884cUbuntu\uff1b\u53e6\u4e00\u5757\u4e3aFPGA\u53ef\u7f16\u7a0b\u82af\u7247\uff0c\u79f0\u4e3aPL\u7aef\uff0c\u901a\u8fc7\u70e7\u5f55Rocket chip\u7535\u8def\uff0c\u4f7f\u5b83\u80fd\u591f\u8fd0\u884cRiscv\u67b6\u6784\u7684\u64cd\u4f5c\u7cfb\u7edf\uff0c\u5373riscv-pke\u3002</p> <p></p> <p>\u5982\u4e0a\u56fe\uff0c\u5728\u5f00\u53d1\u677f\u4e0a\u8fd0\u884c\u7684\u65f6\u5019\uff0cPKE\u5728PL\u7aef\u8fd0\u884c\uff0c\u4e00\u65b9\u9762\u5b83\u53ef\u4ee5\u901a\u8fc7Rocket Chip\u7535\u8def\u7684\u8fde\u7ebf\u8bbf\u95eePL\u7aef\u7684\u8bbe\u5907\uff08device\uff09\uff0c\u5982\u84dd\u7259\u3001\u5c0f\u8f66\u7535\u673a\u7b49\uff1b\u53e6\u4e00\u65b9\u9762\uff0c\u5728PS\u7aef\u8fd0\u884c\u7684riscv-fesvr\u7a0b\u5e8f\u53ef\u4ee5\u548cPKE\u901a\u8fc7HTIF\u534f\u8bae\u901a\u4fe1\uff0c\u4f7f\u5f97PKE\u53ef\u4ee5\u8bfb\u5199PS\u7aefLinux\u64cd\u4f5c\u7cfb\u7edf\u4e0b\u7684\u8bbe\u5907\u6587\u4ef6\uff08host device\uff09\uff0c\u6bd4\u5982\u6444\u50cf\u5934\u3001\u58f0\u5361\u7b49\u3002\u4e5f\u5c31\u662f\u8bf4\uff0cPKE\u9664\u4e86\u53ef\u4ee5\u8bbf\u95ee\u672c\u8eab\u7684\u8bbe\u5907\uff0c\u8fd8\u53ef\u4ee5\u5229\u7528PS\u7aef\u64cd\u4f5c\u7cfb\u7edf\u7684\u529f\u80fd\u8bbf\u95ee\u66f4\u590d\u6742\u7684\u8bbe\u5907\uff0c\u8fd9\u5c31\u662f\u4ee3\u7406\u5185\u6838\u7684\u7279\u70b9\u3002</p> <p>\u5b9e\u9a8c\u56db\u548c\u524d\u4e09\u4e2a\u5b9e\u9a8c\u7684\u5173\u7cfb\u5982\u4e0b\uff1a</p> <p></p> <p>\u53ef\u89c1\u9664\u4e86\u90e8\u5206\u786c\u4ef6\u76f8\u5173\u7684\u64cd\u4f5c\u5916\uff0cPKE\u5728Spike\u548c\u5f00\u53d1\u677f\u4e0a\u7684\u8fd0\u884c\u662f\u5b8c\u5168\u7b49\u4ef7\u7684\uff0c\u4ee3\u7406\u5185\u6838\u4e00\u65b9\u9762\u8ba9\u6211\u4eec\u53ef\u4ee5\u7528\u6700\u7b80\u5355\u7684\u65b9\u6cd5\u8bbf\u95ee\u4e24\u7aef\u7684\u8bbe\u5907\uff0c\u53e6\u4e00\u65b9\u9762\u5728\u4e0d\u540c\u5730\u65b9\u8fd0\u884c\u57fa\u672c\u4e0d\u7528\u6539\u592a\u591a\u4ee3\u7801\uff0c\u975e\u5e38\u4f18\u8d8a\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter6_device_remove/#612","title":"6.1.2 \u8bbe\u5907\u6811","text":"<p>\u8bbe\u5907\u6811\uff08Device Tree\uff09\u662f\u63cf\u8ff0\u8ba1\u7b97\u673a\u7684\u7279\u5b9a\u786c\u4ef6\u8bbe\u5907\u4fe1\u606f\u7684\u6570\u636e\u7ed3\u6784\uff0c\u4ee5\u4fbf\u4e8e\u64cd\u4f5c\u7cfb\u7edf\u7684\u5185\u6838\u53ef\u4ee5\u7ba1\u7406\u548c\u4f7f\u7528\u8fd9\u4e9b\u786c\u4ef6\uff0c\u5305\u62ecCPU\uff0c\u5185\u5b58\uff0c\u603b\u7ebf\u548c\u5176\u4ed6\u4e00\u4e9b\u5916\u8bbe\u3002</p> <p>\u786c\u4ef6\u7684\u76f8\u5e94\u4fe1\u606f\u90fd\u4f1a\u5199\u5728<code>.dts</code>\u4e3a\u540e\u7f00\u7684\u6587\u4ef6\u4e2d\uff0c\u8be5\u6587\u4ef6\u7ecf\u8fc7<code>dtc</code>\u7a0b\u5e8f\u7f16\u8bd1\u4e4b\u540e\u4f1a\u5f97\u5230<code>dtb</code>\u6587\u4ef6\uff0c\u5728\u4f20\u7edf\u5185\u6838\u4e2d<code>dtb</code>\u901a\u8fc7<code>Bootloader</code>\u5f15\u5bfc\u7a0b\u5e8f\u52a0\u8f7d\u5230\u5185\u6838\uff0c\u6240\u4ee5<code>Bootloader</code>\u548c\u5185\u6838\u90fd\u9700\u8981\u652f\u6301\u8bbe\u5907\u6811\u624d\u884c\u3002</p> <p></p> <p>\u5728\u672c\u7ae0\u8282\u4e2d\uff0cdtb\u6587\u4ef6\u4f1a\u548crocketchip\u4e00\u8d77\u7f16\u8bd1\u8fdb\u7535\u8def\uff0c\u5b58\u653e\u5728\u56fa\u5b9a\u5185\u5b58\u533a\u57df\u4e2d\u3002PKE\u53ef\u4ee5\u8bbf\u95ee\u8fd9\u4e2a\u5185\u5b58\u533a\u57df\u628a\u8be5\u6587\u4ef6\u89e3\u6790\u4e3a\u8bbe\u5907\u6811\u7ed3\u6784\uff0c\u8bbe\u5907\u5373\u901a\u8fc7\u8bbe\u5907\u6811\u7684\u65b9\u5f0f\u63d0\u4f9b\u7ed9PKE\u4f7f\u7528\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter6_device_remove/#613-iommio","title":"6.1.3 \u5185\u5b58\u6620\u5c04I/O(MMIO)","text":"<p>\u5185\u5b58\u6620\u5c04(Memory-Mapping I/O)\u662f\u4e00\u79cd\u7528\u4e8e\u8bbe\u5907\u9a71\u52a8\u7a0b\u5e8f\u548c\u8bbe\u5907\u901a\u4fe1\u7684\u65b9\u5f0f\uff0c\u5b83\u533a\u522b\u4e8e\u57fa\u4e8eI/O\u7aef\u53e3\u63a7\u5236\u7684Port I/O\u65b9\u5f0f\u3002RICSV\u6307\u4ee4\u7cfb\u7edf\u7684CPU\u901a\u5e38\u53ea\u5b9e\u73b0\u4e00\u4e2a\u7269\u7406\u5730\u5740\u7a7a\u95f4\uff0c\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u5916\u8bbeI/O\u7aef\u53e3\u7684\u7269\u7406\u5730\u5740\u5c31\u88ab\u6620\u5c04\u5230CPU\u4e2d\u5355\u4e00\u7684\u7269\u7406\u5730\u5740\u7a7a\u95f4\uff0c\u6210\u4e3a\u5185\u5b58\u7684\u4e00\u90e8\u5206\uff0cCPU\u53ef\u4ee5\u50cf\u8bbf\u95ee\u4e00\u4e2a\u5185\u5b58\u5355\u5143\u90a3\u6837\u8bbf\u95ee\u5916\u8bbeI/O\u7aef\u53e3\uff0c\u800c\u4e0d\u9700\u8981\u8bbe\u7acb\u4e13\u95e8\u7684\u5916\u8bbeI/O\u6307\u4ee4\u3002</p> <p>\u5728MMIO\u4e2d\uff0c\u5185\u5b58\u548cI/O\u8bbe\u5907\u5171\u4eab\u540c\u4e00\u4e2a\u5730\u5740\u7a7a\u95f4\u3002MMIO\u662f\u5e94\u7528\u5f97\u6700\u4e3a\u5e7f\u6cdb\u7684\u4e00\u79cdIO\u65b9\u6cd5\uff0c\u5b83\u4f7f\u7528\u76f8\u540c\u7684\u5730\u5740\u603b\u7ebf\u6765\u5904\u7406\u5185\u5b58\u548cI/O\u8bbe\u5907\uff0cI/O\u8bbe\u5907\u7684\u5185\u5b58\u548c\u5bc4\u5b58\u5668\u88ab\u6620\u5c04\u5230\u4e0e\u4e4b\u76f8\u5173\u8054\u7684\u5730\u5740\u3002\u5f53CPU\u8bbf\u95ee\u67d0\u4e2a\u5185\u5b58\u5730\u5740\u65f6\uff0c\u5b83\u53ef\u80fd\u662f\u7269\u7406\u5185\u5b58\uff0c\u4e5f\u53ef\u4ee5\u662f\u67d0\u4e2aI/O\u8bbe\u5907\u7684\u5185\u5b58\u3002\u6b64\u65f6\uff0c\u7528\u4e8e\u8bbf\u95ee\u5185\u5b58\u7684CPU\u6307\u4ee4\u5c31\u53ef\u4ee5\u7528\u6765\u8bbf\u95eeI/O\u8bbe\u5907\u3002\u6bcf\u4e2aI/O\u8bbe\u5907\u76d1\u89c6CPU\u7684\u5730\u5740\u603b\u7ebf\uff0c\u4e00\u65e6CPU\u8bbf\u95ee\u5206\u914d\u7ed9\u5b83\u7684\u5730\u5740\uff0c\u5b83\u5c31\u505a\u51fa\u54cd\u5e94\uff0c\u5c06\u6570\u636e\u603b\u7ebf\u8fde\u63a5\u5230\u9700\u8981\u8bbf\u95ee\u7684\u8bbe\u5907\u786c\u4ef6\u5bc4\u5b58\u5668\u3002\u4e3a\u4e86\u5bb9\u7eb3I/O\u8bbe\u5907\uff0cCPU\u5fc5\u987b\u9884\u7559\u7ed9I/O\u4e00\u4e2a\u5730\u5740\u6620\u5c04\u533a\u57df\u3002</p> <p>\u5728\u672c\u7ae0\u8282\u4e2d\uff0c\u4fee\u6539\u540e\u7684RocketChip\u5c06\u84dd\u7259\u63a7\u5236\u5bc4\u5b58\u5668\u548c\u5c0f\u8f66\u7535\u673a\u7aef\u63a5\u5230\u56fa\u5b9a\u7684\u5185\u5b58\u5730\u5740\uff0c\u56e0\u6b64\u53ef\u4ee5\u901a\u8fc7\u5bf9\u8fd9\u4e9b\u5730\u5740\u8fdb\u884c\u8bfb\u5199\u63a7\u5236\u84dd\u7259\u548c\u5c0f\u8f66\u7535\u673a\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter6_device_remove/#614-riscv-fesvr","title":"6.1.4 riscv-fesvr\u539f\u7406","text":"<p>riscv-fesvr\u662fPKE\u5728PYNQ\u5f00\u53d1\u677f\u4e0a\u4f7f\u7528\u7684\u91cd\u8981\u5de5\u5177\uff0c\u5b83\u662fARM\u7aef\u7cfb\u7edf\u4e0a\u8fd0\u884c\u7684\u7a0b\u5e8f\uff0c\u63a7\u5236PKE\u7684\u542f\u52a8\u3002\u9664\u4e86\u542f\u52a8\u529f\u80fd\uff0criscv-fesvr\u7a0b\u5e8f\u4e3b\u8981\u5206\u4e3a\u4e24\u4e2a\u6a21\u5757\uff0c\u7cfb\u7edf\u8c03\u7528\u6a21\u5757\u5757\u8d1f\u8d23\u63a5\u53d7PKE\u5bf9ARM\u7aef\u7684\u7cfb\u7edf\u8c03\u7528\u8bf7\u6c42\uff0c\u5728ARM\u7aef\u6267\u884c\u8fd9\u4e9b\u51fd\u6570\uff1b\u5185\u5b58\u6a21\u5757\u8d1f\u8d23\u8bfb\u5199RISCV\u7aef\u7684\u5185\u5b58\uff0c\u548cPKE\u4ea4\u6362\u6570\u636e\u3002</p> <p>PKE\u8c03\u7528\u5bbf\u4e3b\u673a/\u5f00\u53d1\u677fARM\u7aef\u7684\u7cfb\u7edf\u8c03\u7528\u51fd\u6570\u4f7f\u7528\u7684\u662fHTIF\u534f\u8bae\u3002\u534f\u8bae\u8981\u6c42\u5185\u6838\u4fdd\u7559\u4e24\u4e2a\u5730\u5740\uff0c\u4f5c\u4e3a\u548criscv-fesvr\u5171\u4eab\u6570\u636e\u7684\u5730\u65b9\u3002PKE\u8981\u4f7f\u7528\u7cfb\u7edf\u8c03\u7528\u51fd\u6570\uff0c\u5c31\u9700\u8981\u5c06\u7cfb\u7edf\u8c03\u7528\u51fd\u6570\u7684\u7f16\u53f7\u548c\u53c2\u6570\u901a\u8fc7\u8fd9\u4e2a\u5730\u5740\u53d1\u9001\u7ed9riscv-fesvr\uff0c\u65b9\u6cd5\u662f\u5b9a\u4e49\u4e00\u4e2a\u6570\u7ec4magic_mem\uff0c\u8be5\u6570\u7ec4\u5b58\u50a8\u4e86\u8c03\u7528\u53f7\u548c\u53c2\u6570\uff0c\u518d\u5c06\u6570\u7ec4\u7684\u8d77\u59cb\u5730\u5740\u6309\u4e00\u5b9a\u7684\u683c\u5f0f\u586b\u5165\u8fd9\u4e2a\u5730\u5740\u4e2d\uff0c\u5982\u4e0b\u56fe\u3002</p> <p></p> <p>\u6253\u4e2a\u6bd4\u65b9\uff0c\u6211\u901a\u8fc7HTIF\u534f\u8bae\u8c03\u7528ARM\u7aef\u7684write\u51fd\u6570\uff0c\u90a3\u4e48\u6211\u5148\u5b9a\u4e49\u4e00\u4e2a\u6570\u7ec4magic_mem\uff0cmagic_mem[0]\u4e3awrite\u7684\u7cfb\u7edf\u8c03\u7528\u53f7\uff0cmagic_mem[1]\u4e3a\u6587\u4ef6\u63cf\u8ff0\u7b26\uff0cmagic_mem[2]\u4e3a\u7f13\u51b2\u533a\u5730\u5740\uff0cmagic_mem[3]\u4e3a\u5199\u5165\u957f\u5ea6\u3002\u7136\u540e\u628a\u4e00\u4e2a\u6570\u5199\u5165\u5171\u4eab\u5730\u5740\uff0c\u8fd9\u4e2a\u6570\u9ad88\u4f4d\u548c\u4e2d\u95f48\u4f4d\u90fd\u662f0\uff0c\u4f4e48\u4f4d\u4e3amagic_mem\u7684\u5730\u5740\u3002riscv-fesvr\u4f1a\u9996\u5148\u8bfb\u51famagic_mem\u91cc\u7684\u6570\u636e\uff0c\u7136\u540e\u6839\u636emagic_mem[0]\u51b3\u5b9a\u8981\u8c03\u7528write\u51fd\u6570\uff0c\u8fd9\u65f6\u9700\u8981\u6ce8\u610fmagic_mem[2]\u91cc\u7684\u7f13\u51b2\u533a\u5730\u5740\u662fRISCV\u7aef\u5185\u5b58\u7684\u5730\u5740\uff0c\u6240\u4ee5\u5148\u628aRISCV\u7aef\u5185\u5b58\u91cc\u7684\u8fd9\u6bb5\u6570\u636e\u8bfb\u5230\u5916\u9762\u5185\u5b58\uff0c\u518d\u4ee5\u5916\u9762\u5185\u5b58\u5730\u5740\u4e3a\u53c2\u6570\u8c03\u7528write\u51fd\u6570\u3002</p> <p>riscv-fesvr\u7684\u5185\u5b58\u6a21\u5757\u7528\u6765\u8bfb\u5199RISCV\u7aef\u7684\u5185\u5b58\uff0c\u4ece\u800c\u53ef\u4ee5\u8bfb\u53d6\u7cfb\u7edf\u8c03\u7528\u53c2\u6570\u4ee5\u53ca\u8bfb\u5199PKE\u7684\u7f13\u51b2\u533a\u3002Pynq\u5f00\u53d1\u677f\u628aRISCV\u7aef\u7684\u5185\u5b58\u62bd\u8c61\u6210\u8bbe\u5907\u6587\u4ef6/dev/mem\uff0c\u6240\u4ee5\u5185\u5b58\u6a21\u5757\u53ef\u4ee5\u901a\u8fc7\u5728\u56fa\u5b9a\u504f\u79fb\u91cf\u8bfb\u5199\u8be5\u6587\u4ef6\uff0c\u4ece\u800c\u5b9e\u73b0\u8bfb\u5199\u5185\u5b58\u3002</p> <p>\u53e6\u5916\uff0c\u63a7\u5236\u6444\u50cf\u5934\u9700\u8981\u7528\u5230\u7684ioctl\u3001mmap\u3001munmap\u4e09\u4e2a\u7cfb\u7edf\u8c03\u7528\u51fd\u6570\u662f\u539f\u7248\u7684riscv-fesvr\u4e0d\u652f\u6301\u7684\uff0c\u6240\u4ee5\u6211\u4eec\u5bf9riscv-fesvr\u7684\u7cfb\u7edf\u8c03\u7528\u6a21\u5757\u8fdb\u884c\u4e86\u4fee\u6539\uff1a</p> <ul> <li>ioctl\u51fd\u6570\u6bd4\u8f83\u7b80\u5355\uff0c\u53ef\u4ee5\u76f4\u63a5\u7528PKE\u4f20\u8fc7\u6765\u7684\u53c2\u6570\u8c03\u7528\u7cfb\u7edf\u8c03\u7528\u51fd\u6570</li> <li>mmap\u51fd\u6570\u6bd4\u8f83\u9ebb\u70e6\uff0c\u56e0\u4e3aARM\u7aef\u901a\u8fc7mmap\u6620\u5c04\u7684\u662fARM\u7aef\u7684\u5185\u5b58\uff0cRISCV\u7aef\u65e0\u6cd5\u8bbf\u95ee\u3002\u6240\u4ee5\u518d\u6dfb\u52a0readmmap\u51fd\u6570\uff0cPKE\u53ef\u4ee5\u901a\u8fc7HTIF\u8c03\u7528\u6b64\u51fd\u6570\u8bfb\u53d6ARM\u7aef\u88ab\u6620\u5c04\u7684\u5185\u5b58\u3002\u5c06ARM\u7aef\u7528mmap\u6620\u5c04\u7684\u6240\u6709\u5185\u5b58\u7528\u6570\u7ec4\u5b58\u50a8\u6620\u5c04\u5730\u5740\uff0c\u8fd4\u56de\u7ed9PKE\u6570\u7ec4\u7d22\u5f15\uff1bPKE\u5411readmmap\u4f20\u5165\u7d22\u5f15\uff0criscv-fesvr\u6839\u636e\u7d22\u5f15\u627e\u5230\u5730\u5740\uff0c\u8bfb\u53d6ARM\u7aef\u7684\u5185\u5b58\u6570\u636e\u8fd4\u56de\u7ed9PKE\u3002</li> </ul> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter6_device_remove/#615-io","title":"6.1.5  \u8f6e\u8be2I/O\u63a7\u5236\u65b9\u5f0f","text":"<p>\u5728\u5b9e\u9a8c\u56db\u4e2d\uff0c\u6211\u4eec\u8bbe\u5907\u7ba1\u7406\u7684\u4e3b\u8981\u4efb\u52a1\u662f\u63a7\u5236\u8bbe\u5907\u4e0e\u5185\u5b58\u7684\u6570\u636e\u4f20\u9012\uff0c\u5177\u4f53\u4e3a\u4ece\u84dd\u7259\u8bbe\u5907\u8bfb\u53d6\u5230\u7528\u6237\u8f93\u5165\u7684\u6307\u4ee4\u5b57\u7b26\uff08\u6216\u4f20\u9012\u6570\u636e\u7ed9\u84dd\u7259\u5728\u624b\u673a\u7aef\u8fdb\u884c\u6253\u5370\uff09\uff0c\u89e3\u6790\u4e3a\u5c0f\u8f66\u524d\u3001\u540e\u3001\u5de6\u3001\u53f3\u3001\u505c\u6b62\u7b49\u52a8\u4f5c\u6765\u4f20\u8f93\u6570\u636e\u7ed9\u7535\u673a\u5b9e\u73b0\u5bf9\u5c0f\u8f66\u7684\u63a7\u5236\u3002\u5728\u524d\u4e24\u4e2a\u5b9e\u9a8c\u4e2d\uff0c\u6211\u4eec\u5206\u522b\u9700\u8981\u5bf9\u8f6e\u8be2\u63a7\u5236\u65b9\u5f0f\u548c\u4e2d\u65ad\u63a7\u5236\u65b9\u5f0f\u8fdb\u884c\u5b9e\u73b0\u3002</p> <p>\u9996\u5148\uff0c\u7a0b\u5e8f\u76f4\u63a5\u63a7\u5236\u65b9\u5f0f\uff08\u53c8\u79f0\u5faa\u73af\u6d4b\u8bd5\u65b9\u5f0f\uff09\uff0c\u6bcf\u6b21\u4ece\u5916\u90e8\u8bbe\u5907\u8bfb\u53d6\u4e00\u4e2a\u5b57\u7684\u6570\u636e\u5230\u5b58\u50a8\u5668\uff0c\u5bf9\u4e8e\u8bfb\u5165\u7684\u6bcf\u4e2a\u5b57\uff0cCPU\u9700\u8981\u5bf9\u5916\u8bbe\u72b6\u6001\u8fdb\u884c\u5faa\u73af\u68c0\u67e5\uff0c\u76f4\u5230\u786e\u5b9a\u8be5\u6570\u636e\u5df2\u7ecf\u4f20\u5165I/O\u6570\u636e\u5bc4\u5b58\u5668\u4e2d\u3002</p> <p>\u8f6e\u8be2I/O\u63a7\u5236\u65b9\u5f0f\u6d41\u7a0b\u5982\u56fe\uff1a</p> <p></p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter6_device_remove/#616-io","title":"6.1.6  \u4e2d\u65ad\u9a71\u52a8I/O\u63a7\u5236\u65b9\u5f0f","text":"<p>\u5728\u524d\u4e00\u79cd\u8f6e\u8be2\u7684\u63a7\u5236\u65b9\u5f0f\u4e2d\uff0c\u7531\u4e8eCPU\u7684\u9ad8\u901f\u6027\u548cI/O\u8bbe\u5907\u7684\u4f4e\u901f\u6027\uff0c\u5bfc\u81f4CPU\u6d6a\u8d39\u7edd\u5927\u591a\u6570\u65f6\u95f4\u5904\u4e8e\u7b49\u5f85I/O\u8bbe\u5907\u5b8c\u6210\u6570\u636e\u4f20\u8f93\u7684\u5faa\u73af\u6d4b\u8bd5\u4e2d\uff0c\u4f1a\u9020\u6210\u5927\u91cf\u8d44\u6e90\u6d6a\u8d39\u3002\u4e2d\u65ad\u9a71\u52a8\u7684\u65b9\u5f0f\u662f\uff0c\u5141\u8bb8\u8bf7\u6c42I/O\u7684\u8fdb\u7a0b\u5728\u8bbe\u5907\u5de5\u4f5c\u65f6\u8fdb\u5165\u4f11\u7720\u72b6\u6001\uff0c\u4f7fCPU\u80fd\u591f\u8fd0\u884c\u522b\u7684\u8fdb\u7a0b\u3002\u76f4\u5230\u8bbe\u5907\u5de5\u4f5c\u5b8c\u6210\u65f6\uff0c\u518d\u7531\u8bbe\u5907\u53d1\u51fa\u4e2d\u65ad\uff0c\u4e2d\u65ad\u5904\u7406\u7a0b\u5e8f\u5524\u9192\u4e4b\u524d\u4f11\u7720\u7684\u8fdb\u7a0b\uff0c\u4f7f\u5176\u80fd\u591f\u63a5\u53d7\u8bbe\u5907\u8fd4\u56de\u7684\u6570\u636e\u7ee7\u7eed\u6267\u884c\u3002\u91c7\u7528\u4e2d\u65ad\u9a71\u52a8\u7684\u63a7\u5236\u65b9\u5f0f\uff0c\u5728I/O\u64cd\u4f5c\u8fc7\u7a0b\u4e2d\uff0cCPU\u53ef\u4ee5\u6267\u884c\u5176\u4ed6\u7684\u8fdb\u7a0b\uff0cCPU\u4e0e\u8bbe\u5907\u4e4b\u95f4\u8fbe\u5230\u4e86\u90e8\u5206\u5e76\u884c\u7684\u5de5\u4f5c\u72b6\u6001\uff0c\u4ece\u800c\u63d0\u5347\u4e86\u8d44\u6e90\u5229\u7528\u7387\u3002</p> <p>Riscv\u5305\u542b\u4e09\u7c7b\u4e2d\u65ad\uff1a\u8f6f\u4e2d\u65ad\u3001\u65f6\u949f\u4e2d\u65ad\u548c\u5916\u90e8\u4e2d\u65ad\u3002\u8f6f\u4e2d\u65ad\u548c\u65f6\u949f\u4e2d\u65ad\u6211\u4eec\u5728\u5b9e\u9a8c\u4e00\u5df2\u7ecf\u63a5\u89e6\u8fc7\uff0c\u800c\u8bbe\u5907\u89e6\u53d1\u7684\u4e2d\u65ad\u5c5e\u4e8e\u5916\u90e8\u4e2d\u65ad\u3002\u5728\u5b9e\u9a8c\u4e00\u4e2d\uff0c\u6211\u4eec\u5728\u673a\u5668\u6001\u6355\u83b7\u4e86\u65f6\u949f\u4e2d\u65ad\uff0c\u7136\u540e\u5c06\u5176\u8f6c\u53d1\u6210\u5185\u6838\u6001\u7684\u8f6f\u4e2d\u65ad\u4ea4\u7531\u4e2d\u65ad\u5904\u7406\u7a0b\u5e8f\u5904\u7406\uff1b\u672c\u7ae0\u5219\u76f4\u63a5\u901a\u8fc7\u8bbe\u7f6eMIDELEG\u5bc4\u5b58\u5668\uff0c\u5229\u7528RISCV\u7684\u4e2d\u65ad\u59d4\u6258\u673a\u5236\u76f4\u63a5\u5c06\u5916\u90e8\u4e2d\u65ad\u4ea4\u7531\u5185\u6838\u6001\u7684\u4e2d\u65ad\u5904\u7406\u7a0b\u5e8f\u5904\u7406\uff0c\u4e0d\u7528\u7ecf\u8fc7\u673a\u5668\u6001\u7684\u6355\u83b7\u3002\u53e6\u5916\uff0cRISCV\u67b6\u6784\u8fd8\u6307\u5b9a\u4e86PLIC\uff08Priority Level Interrupt Controller\uff09\u6a21\u5757\u7ba1\u7406\u5404\u7ea7\u4e2d\u65ad\uff0c\u8be5\u8bbe\u5907\u4f7f\u7528MMIO\u63a7\u5236\uff0cPKE\u5728\u5904\u7406\u4e2d\u65ad\u4e4b\u540e\u901a\u8fc7\u8bfb\u5199\u6307\u5b9a\u7684\u5185\u5b58\u5730\u5740\uff0c\u6765\u83b7\u53d6\u89e6\u53d1\u4e2d\u65ad\u7684\u8bbe\u5907\u7684\u7f16\u53f7\u4ee5\u53ca\u901a\u77e5PLIC\u672c\u6b21\u4e2d\u65ad\u662f\u5426\u5904\u7406\u6210\u529f\u3002</p> <p>\u4e2d\u65ad\u9a71\u52a8I/O\u65b9\u5f0f\u6d41\u7a0b\u5982\u56fe\uff1a</p> <p></p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter6_device_remove/#617","title":"6.1.7 \u8bbe\u5907\u6587\u4ef6","text":"<p>\u7528\u6237\u7a0b\u5e8f\u8bbf\u95ee\u5916\u90e8\u8bbe\u5907\u901a\u5e38\u6709\u4e24\u79cd\u65b9\u5f0f\uff1a\u901a\u8fc7\u7279\u5b9a\u7cfb\u7edf\u8c03\u7528\u8bbf\u95ee\u548c\u901a\u8fc7\u8bbe\u5907\u6587\u4ef6\u8bbf\u95ee\u3002\u524d\u8005\u5373\u64cd\u4f5c\u7cfb\u7edf\u63d0\u4f9b\u4e13\u95e8\u7684\u51fd\u6570\u63a7\u5236\u8bbe\u5907\uff0c\u540e\u8005\u662f\u64cd\u4f5c\u7cfb\u7edf\u628a\u8bbe\u5907\u6307\u5b9a\u6210\u4e00\u4e2a\u6587\u4ef6\uff0c\u901a\u8fc7\u901a\u7528\u7684\u6587\u4ef6\u7684\u8bfb\u5199\u51fd\u6570\u63a7\u5236\u8bbe\u5907\u3002\u8bbe\u5907\u6587\u4ef6\u5e38\u7528\u7684\u51fd\u6570\u9664\u4e86open\u3001read\u3001write\u3001close\uff0c\u8fd8\u6709\u4ee5\u4e0b\u51e0\u79cd\uff1a</p> <ul> <li>ioctl\uff1a<code>int ioctl(int fd, unsigned long request, void *data);</code>\u7528\u6765\u8bbe\u7f6e\u8bbe\u5907\u53c2\u6570\u3002fd\u662f\u6587\u4ef6\u63cf\u8ff0\u7b26\uff1brequest\u662f\u4e00\u4e2a\u5e38\u6570\uff0c\u8868\u793a\u53c2\u6570\u7c7b\u578b\uff0c\u4e0d\u540c\u7684\u7c7b\u578b\u5bf9\u5e94\u4e0d\u540c\u7684\u5e38\u6570\uff1bdata\u901a\u5e38\u662f\u4e00\u4e2a\u6307\u5411\u8981\u8bbe\u7f6e\u7684\u53c2\u6570\u7684\u503c\u7684\u6307\u9488\uff0c\u53c2\u6570\u7684\u503c\u53ef\u4ee5\u662f\u6574\u6570\uff0c\u4e5f\u53ef\u4ee5\u662f\u7ed3\u6784\u4f53\u7b49\uff1b\u8fd4\u56de\u503c\u4e3a\u8be5\u51fd\u6570\u662f\u5426\u6267\u884c\u6210\u529f\u3002\u5982\u6444\u50cf\u5934\u8bbe\u5907\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7\u8be5\u51fd\u6570\u8bbe\u7f6e\u6444\u50cf\u5934\u7684\u62cd\u6444\u5206\u8fa8\u7387\u3001\u989c\u8272\u683c\u5f0f\u7b49\uff1b\u97f3\u9891\u8bbe\u5907\u6211\u4eec\u53ef\u4ee5\u8bbe\u7f6e\u91c7\u6837\u7387\u3001\u6570\u636e\u683c\u5f0f\u7b49\u3002</li> <li>mmap\uff1a<code>void *mmap(void *addr, size_t length, int prot, int flags, int fd, off_t offset);</code>\u8be5\u51fd\u6570\u539f\u672c\u7684\u4f5c\u7528\u662f\u5c06\u865a\u62df\u5730\u5740\u548c\u6587\u4ef6\u8fdb\u884c\u6620\u5c04\uff0c\u4f7f\u5f97\u8bfb\u5199\u6587\u4ef6\u53ef\u4ee5\u50cf\u8bfb\u5199\u5185\u5b58\u4e00\u6837\u65b9\u4fbf\uff0c\u540c\u65f6\u4e5f\u80fd\u8282\u7701\u7269\u7406\u5185\u5b58\uff1b\u4f46\u5bf9\u4e8e\u6709\u4e9b\u4e0d\u652f\u6301read/write\u8bfb\u5199\u7684\u8bbe\u5907\uff0c\u5c31\u5fc5\u987b\u4f7f\u7528mmap\u51fd\u6570\u5c06\u865a\u62df\u5730\u5740\u548c\u8bbe\u5907\u6587\u4ef6\u6620\u5c04\uff0c\u624d\u80fd\u8bfb\u5199\u8bbe\u5907\u7684\u6570\u636e\u3002addr\u53c2\u6570\u8868\u793a\u6620\u5c04\u7684\u8d77\u59cb\u865a\u62df\u5730\u5740\uff0c\u901a\u5e38\u586bNULL\u8868\u793a\u7531\u64cd\u4f5c\u7cfb\u7edf\u81ea\u5df1\u6307\u5b9a\uff1blength\uff0cprot\u3001flags\u5206\u522b\u8868\u793a\u6620\u5c04\u5730\u5740\u7a7a\u95f4\u7684\u957f\u5ea6\u3001\u6743\u9650\u548c\u5176\u4ed6\u53c2\u6570\uff1bfd\u4e3a\u6587\u4ef6\u63cf\u8ff0\u7b26\uff1boffset\u4e3a\u6587\u4ef6\u504f\u79fb\u91cf\uff0c\u8fd4\u56de\u503c\u4e3a\u6620\u5c04\u7684\u8d77\u59cb\u865a\u62df\u5730\u5740\u3002</li> </ul> <p>\u5728\u672c\u7ae0\u8282\u4e2d\uff0c\u5c06\u4f7f\u7528PKE\u901a\u8fc7HTIF\u534f\u8bae\u548cPS\u7aef\u7684riscv-fesvr\u8fdb\u884c\u901a\u4fe1\uff0c\u4ee5\u8bfb\u5199PS\u7aef\u7684\u6444\u50cf\u5934\u8bbe\u5907\u6587\u4ef6\uff0c\u8fdb\u800c\u63a7\u5236\u6444\u50cf\u5934\u8bbe\u5907\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter6_device_remove/#62-lab4_1-poll","title":"6.2 lab4_1 poll","text":""},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter6_device_remove/#_2","title":"\u7ed9\u5b9a\u5e94\u7528","text":"<ul> <li>user/app_poll.c</li> </ul> <pre><code>1   /*\n2    * Below is the given application for lab4_1.\n3    * The goal of this app is to control the car via Bluetooth. \n4    */\n5   6   #include \"user_lib.h\"\n7   #include \"util/types.h\"\n8   9   int main(void) {\n10    printu(\"please input the instruction through bluetooth!\\n\");\n11    while(1)\n12    {\n13      char temp = (char)uartgetchar();\n14      uartputchar(temp);\n15      switch (temp)\n16      {\n17        case '1' : gpio_reg_write(0x2e); break; //\u524d\u8fdb\n18        case '2' : gpio_reg_write(0xd1); break; //\u540e\u9000\n19        case '3' : gpio_reg_write(0x63); break; //\u5de6\u8f6c\n20        case '4' : gpio_reg_write(0x9c); break; //\u53f3\u8f6c\n21        case 'q' : exit(0);              break;\n22        default : gpio_reg_write(0x00); break;  //\u505c\u6b62\n23      }\n24    }\n25    exit(0);\n26    return 0;\n27  }\n</code></pre> <p>\u5e94\u7528\u901a\u8fc7\u8f6e\u8be2\u7684\u65b9\u5f0f\u4ece\u84dd\u7259\u7aef\u83b7\u53d6\u6307\u4ee4\uff0c\u5b9e\u73b0\u5bf9\u5c0f\u8f66\u7684\u63a7\u5236\u529f\u80fd\u3002</p> <p>\u4ece\u76f4\u63a5\u7f16\u8bd1\u8fd0\u884c\u7ed3\u679c\u4e0a\u6765\u770b\uff0c\u84dd\u7259\u7aef\u7aef\u53e3\u83b7\u53d6\u7528\u6237\u8f93\u5165\u6307\u4ee4\u7684uartgetchar\u7cfb\u7edf\u8c03\u7528\u672a\u5b8c\u5584\uff0c\u6240\u4ee5\u65e0\u6cd5\u8fdb\u884c\u63a7\u5236\u5c0f\u8f66\u7684\u540e\u7eed\u64cd\u4f5c\u3002\u6309\u7167\u63d0\u793a\uff0c\u6211\u4eec\u9700\u8981\u5b9e\u73b0\u84dd\u7259uart\u7aef\u53e3\u7684\u83b7\u53d6\u548c\u6253\u5370\u5b57\u7b26\u7cfb\u7edf\u8c03\u7528\uff0c\u4ee5\u53ca\u4f20\u9001\u9a71\u52a8\u6570\u636e\u7ed9\u5c0f\u8f66\u7535\u673a\u7684\u7cfb\u7edf\u8c03\u7528\uff0c\u5b9e\u73b0\u5bf9\u5c0f\u8f66\u7684\u63a7\u5236\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter6_device_remove/#_3","title":"\u5b9e\u9a8c\u5185\u5bb9","text":"<p>\u5982\u8f93\u51fa\u63d0\u793a\u6240\u8868\u793a\u7684\u90a3\u6837\uff0c\u9700\u8981\u627e\u5230\u5e76\u5b8c\u6210\u5bf9uart_getchar\u7684\u8c03\u7528\uff0c\u7531\u4e8e\u672c\u5b9e\u9a8c\u7ed9\u51fa\u7684\u57fa\u7840\u4ee3\u7801\u4fee\u6539\u4e86\u786c\u4ef6\u76f8\u5173\u7684\u90e8\u5206\u4ee3\u7801\uff0c\u6240\u4ee5\u65e0\u6cd5\u5728Spike\u4e0a\u8fd0\u884c\uff0c\u9700\u5728PYNQ\u5f00\u53d1\u677f\u4e0a\u8fdb\u884c\u9a8c\u8bc1\uff0c\u8fd0\u884c\u6b65\u9aa4\u5982\u4e0b\uff1a</p> <ol> <li>\u4f9d\u7167\u4ed3\u5e93https://gitee.com/hustos/fpga-pynq\u4e0busb-device-pynq\u5206\u652f\u7684\u8bf4\u660e\uff0c\u5728\u677f\u4e0a\u5b89\u88c5ARM\u7aef\u64cd\u4f5c\u7cfb\u7edf\u548c\u4e0b\u8f7d\u5fc5\u8981\u7684\u6587\u4ef6</li> <li>\u4f9d\u7167\u4ed3\u5e93https://gitee.com/hustos/myriscv-fesvr\u7684\u8bf4\u660e\uff0c\u81ea\u884c\u7f16\u8bd1\u6216\u76f4\u63a5\u4e0b\u8f7d\u4fee\u6539\u540e\u7684riscv-fesvr</li> <li>\u8fde\u63a5\u5916\u8bbe\uff1a\u9996\u5148\u5c06\u84dd\u7259\u6a21\u5757\u63a5\u5165pynq\u677f\u7684PMODA\u63a5\u53e3\u7ec4\uff0c\u63a5\u53e3\u5bf9\u5e94\u5173\u7cfb\u4e3a\uff1a</li> </ol> pynq\u63a5\u53e3 \u84dd\u7259\u63a5\u53e3 VCC VCC GND GND JA4 RXD JA3 TXD <p>\u63a5\u5165\u65f6\u6ce8\u610f\u5bf9\u5e94\u63a5\u53e3\u9519\u4f4d\u6b63\u786e\u63d2\u5165\uff0c\u4e14\u63d2\u5165\u7684\u6240\u6709\u63a5\u53e3\u5747\u5728\u4e0a\u9762\u7684\u4e00\u6392\u3002\u7136\u540e\u5c06\u5c0f\u8f66\u7684\u7535\u673a\u63a5\u53e3\u63a5\u5165PMODB\u63a5\u53e3\u7ec4\uff0c\u4e3a\u4e86\u9632\u6b62\u5c0f\u8f66\u884c\u8d70\u8fc7\u7a0b\u4e2d\u63a5\u53e3\u677e\u5f00\uff0c\u53ef\u81ea\u884c\u4f7f\u7528\u80f6\u5e03\u7c98\u8d34\u3002</p> <p></p> <ol> <li> <p>\u5728\u624b\u673a\u7aef\u4e0b\u8f7d\u4efb\u610f\u4e00\u79cd\u84dd\u7259\u4e32\u53e3\u901a\u4fe1APP\uff0c\u5339\u914d\u5e76\u8fde\u63a5\u84dd\u7259\u6a21\u5757\u3002\u84dd\u7259\u7684\u540d\u79f0\u901a\u5e38\u662f\u201cHC-\u4e24\u4f4d\u6570\u5b57\u201d\u3002\u4f7f\u7528\u7f51\u7ebf\u8fde\u63a5\u5f00\u53d1\u677f\u548c\u7535\u8111\uff0c\u540c\u65f6\u4f7f\u7528USB\u7ebf\u8fde\u63a5\u5f00\u53d1\u677f\u548c\u7535\u8111\u6216\u8005\u5145\u7535\u5b9d\uff0c\u6253\u5f00\u5f00\u53d1\u677f\u7535\u6e90\u3002</p> </li> <li> <p>\u6267\u884c\u5f00\u673a\u4e4b\u540e\u5fc5\u8981\u7684\u64cd\u4f5c\u540e\uff08\u70e7\u5f55\u7535\u8def\u7b49\uff0c\u89c1\u6b65\u9aa41\u91cc\u7684\u4ed3\u5e93\uff09\uff0c\u8fd0\u884c\uff1a</p> </li> </ol> <pre><code>sudo ./riscv-fesvr riscv-pke app_poll\n</code></pre> <p>\u4e4b\u540e\u5373\u53ef\u5728\u624b\u673a\u4e0a\u8f93\u5165\u63a7\u5236\u6307\u4ee4\uff0c\u5c0f\u8f66\u5e94\u80fd\u6839\u636e\u6307\u4ee4\u53cd\u5e94\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter6_device_remove/#_4","title":"\u5b9e\u9a8c\u6307\u5bfc","text":"<p>\u57fa\u4e8e\u5b9e\u9a8clab1_1\uff0c\u4f60\u5df2\u7ecf\u4e86\u89e3\u548c\u638c\u63e1\u64cd\u4f5c\u7cfb\u7edf\u4e2d\u7cfb\u7edf\u8c03\u7528\u673a\u5236\u7684\u5b9e\u73b0\u539f\u7406\u3002\u5bf9\u4e8e\u672c\u5b9e\u9a8c\u7684\u5e94\u7528\uff0c\u6211\u4eec\u53d1\u73b0user/app_poll.c\u6587\u4ef6\u4e2d\u6709\u4e09\u4e2a\u51fd\u6570\u8c03\u7528\uff1auart_getchar\uff0cuart_putchar\u548cgpio_reg_write\u3002UART\u548cGPIO\u5206\u522b\u662f\u4e24\u79cd\u63a7\u5236\u8bbe\u5907\u7684\u7aef\u53e3\u534f\u8bae\uff0c\u4f46\u5728\u672c\u5b9e\u9a8c\u4e2d\u5b83\u4eec\u90fd\u53ef\u4ee5\u901a\u8fc7MMIO\u8fdb\u884c\u63a7\u5236\u3002\u5bf9\u4ee3\u7801\u8fdb\u884c\u8ddf\u8e2a\uff0c\u6211\u4eec\u53d1\u73b0\u8fd9\u4e09\u4e2a\u51fd\u6570\u90fd\u5728user/user_lib.c\u4e2d\u8fdb\u884c\u4e86\u5b9e\u73b0\uff0c\u5bf9\u5e94\u4e8elab1_1\u7684\u6d41\u7a0b\uff0c\u6211\u4eec\u53ef\u4ee5\u5728kernel/syscall.h\u4e2d\u67e5\u770b\u65b0\u589e\u7684\u7cfb\u7edf\u8c03\u7528\u4ee5\u53ca\u7f16\u53f7\uff1a</p> <pre><code>16  #define SYS_user_uart_putchar (SYS_user_base + 6)\n17  #define SYS_user_uart_getchar (SYS_user_base + 7)\n18  #define SYS_user_gpio_reg_write (SYS_user_base + 8)\n</code></pre> <p>\u7ee7\u7eed\u8ffd\u8e2a\uff0c\u6211\u4eec\u53d1\u73b0\u5728kernel/syscall.c\u7684do_syscall\u51fd\u6570\u4e2d\u65b0\u589e\u4e86\u5bf9\u5e94\u7cfb\u7edf\u8c03\u7528\u7f16\u53f7\u7684\u5b9e\u73b0\u51fd\u6570\uff0c\u5bf9\u4e8e\u65b0\u589e\u7cfb\u7edf\u8c03\u7528\uff0c\u5206\u522b\u6709\u5982\u4e0b\u51fd\u6570\u8fdb\u884c\u5904\u7406\uff1a</p> <pre><code>133     case SYS_user_uart_putchar:\n134       sys_user_uart_putchar(a1);return 1;\n135     case SYS_user_uart_getchar:\n136       return sys_user_uart_getchar();\n137     case SYS_user_gpio_reg_write:\n138       return sys_user_gpio_reg_write(a1);\n</code></pre> <p>\u8bfb\u8005\u7684\u4efb\u52a1\u5373\u4e3a\u5728kernel/syscall.c\u4e2d\u8ffd\u8e2a\u5e76\u5b8c\u5584sys_user_uart_getchar\u3002\u5bf9\u4e8euart\u76f8\u5173\u7684\u51fd\u6570\uff0c\u6211\u4eec\u7ed9\u51fauart\u7aef\u53e3\u7684\u5730\u5740\u6620\u5c04\u5982\u56fe\uff1a</p> <p></p> <p>\u6211\u4eec\u53ef\u4ee5\u770b\u5230\u914d\u7f6euart\u7aef\u53e3\u7684\u504f\u79fb\u5730\u5740\u4e3a0x60000000\uff0c\u5bf9\u5e94\u5199\u5730\u5740\u4e3a0x60000000\uff0c\u8bfb\u5730\u5740\u4e3a0x60000004\uff0c\u540c\u65f6\u5bf90x60000008\u7684\u72b6\u6001\u4f4d\u8fdb\u884c\u8f6e\u8be2\uff0c\u68c0\u6d4b\u5230\u4fe1\u53f7\u65f6\u8fdb\u884c\u8bfb\u5199\u64cd\u4f5c\u3002</p> <p>\u5728kernel/syscall.c\u4e2d\u627e\u5230\u51fd\u6570\u5b9e\u73b0\u7a7a\u7f3a\uff0c\u5e76\u6839\u636e\u6ce8\u91ca\u5b8c\u6210sys_user_uart_getchar\u7cfb\u7edf\u8c03\u7528\uff08\u7531\u4e8elab4_2\u9700\u8981\u5bf9lab4_1\u5b8c\u6210\u7684\u4ee3\u7801\u8fdb\u884c\u4fee\u6539\uff0c\u6240\u4ee5\u8fd9\u91cc\u4e00\u5e76\u7ed9\u51fa\u4e86lab4_2\u7684\u63d0\u793a\uff09\uff1a</p> <pre><code> 95 ssize_t sys_user_uart_getchar() {\n96   // TODO (lab4_1 and lab4_2): implment the syscall of sys_user_uart_getchar and modify it in lab4_2.\n97   // hint (lab4_1): The functionality of sys_user_uart_getchar is to get data from UART address.\n98   // Therefore we should check the data from the address of bluetooth status repeatedly, until the data is ready. \n99   // Then read the data from the address of bluetooth reading and return.\n100   // hint (lab4_2): the functionality of sys_user_uart_getchar is let process sleep and wait for value. therefore,\n101   // we should call do_sleep to let process 0 sleep. \n102   // then we should get uartvalue and return.\n103     panic( \"You have to implement sys_user_uart_getchar to get data from UART using uartgetchar in lab4_1 and modify it in lab4_2.\\n\" );\n104 105 }\n</code></pre> <p>\u6ce8\u610f\uff1a\u7f16\u5199\u81ea\u5df1\u7684\u4ee3\u7801\u65f6\u5343\u4e07\u4e0d\u8981\u4fee\u6539\u6216\u5220\u53bblab4_2\u7684\u63d0\u793a\uff08\u5373100\u884c\u5230102\u884c\uff09\uff0c\u9632\u6b62\u540e\u9762\u5b9e\u9a8c\u7684\u5408\u5e76\u9519\u8bef\uff01</p> <p>\u5b9e\u9a8c\u5b8c\u6bd5\u540e\uff0c\u8bb0\u5f97\u63d0\u4ea4\u4fee\u6539\uff08\u547d\u4ee4\u884c\u4e2d-m\u540e\u7684\u5b57\u7b26\u4e32\u53ef\u81ea\u884c\u786e\u5b9a\uff09\uff0c\u4ee5\u4fbf\u5728\u540e\u7eed\u5b9e\u9a8c\u4e2d\u7ee7\u627flab4_1\u4e2d\u6240\u505a\u7684\u5de5\u4f5c\uff1a</p> <pre><code>$ git commit -a -m \"my work on lab4_1 is done.\"\n</code></pre> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter6_device_remove/#63-lab4_2_plic","title":"6.3 lab4_2_PLIC","text":""},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter6_device_remove/#_5","title":"\u7ed9\u5b9a\u5e94\u7528","text":"<ul> <li>user/app_PLIC.c</li> </ul> <pre><code>1   /*\n2    * Below is the given application for lab4_2.\n3    * The goal of this app is to control the car via Bluetooth. \n4    */\n5   6   #include \"user_lib.h\"\n7   #include \"util/types.h\"\n8   void delay(unsigned int time){\n9     unsigned int a = 0xfffff ,b = time;\n10    volatile unsigned int i,j;\n11    for(i = 0; i &lt; a; ++i){\n12      for(j = 0; j &lt; b; ++j){\n13        ;\n14      }\n15    }\n16  }\n17  int main(void) {\n18    printu(\"Hello world!\\n\");\n19    int i;\n20    int pid = fork();\n21    if(pid == 0)\n22    {\n23      while (1)\n24      {\n25        delay(3);\n26        printu(\"waiting for you!\\n\");\n27      }\n28      29    }\n30    else\n31    {\n32      for (;;) {\n33        char temp = (char)uartgetchar();\n34        printu(\"%c\\n\", temp);\n35        switch (temp)\n36        {\n37          case '1' : gpio_reg_write(0x2e); break; //\u524d\u8fdb\n38          case '2' : gpio_reg_write(0xd1); break; //\u540e\u9000\n39          case '3' : gpio_reg_write(0x63); break; //\u5de6\u8f6c\n40          case '4' : gpio_reg_write(0x9c); break; //\u53f3\u8f6c\n41          case 'q' : exit(0);              break;\n42          default : gpio_reg_write(0x00); break;  //\u505c\u6b62\n43        }\n44      }\n45    }\n46    47  48    exit(0);\n49  50    return 0;\n51  }\n</code></pre> <p>\u5e94\u7528\u901a\u8fc7\u4e2d\u65ad\u7684\u65b9\u5f0f\u4ece\u84dd\u7259\u7aef\u83b7\u53d6\u6307\u4ee4\uff0c\u5b9e\u73b0\u5bf9\u5c0f\u8f66\u7684\u63a7\u5236\u529f\u80fd\u3002\u5728\u7b49\u5f85\u84dd\u7259\u7684\u8fdb\u7a0b\u4f11\u7720\u7684\u65f6\u5019\uff0c\u4f1a\u6267\u884cdelay\u8fdb\u7a0b\uff0c\u53ef\u4ee5\u770b\u5230waiting for you\u63d0\u793a\u4fe1\u606f\u3002</p> <p>\u5207\u6362\u5230lab4_2\uff0c\u7ee7\u627flab4_1\u53ca\u4e4b\u524d\u5b9e\u9a8c\u6240\u505a\u7684\u4fee\u6539\uff0c\u76f4\u63a5\u7f16\u8bd1\u6267\u884c\u7ed3\u679c\u548c\u5b8c\u6210\u540e\u7684lab4_1\u4e00\u81f4\uff0c\u4e00\u76f4\u963b\u585e\u5728\u8fd9\u91cc\u7b49\u5f85\u84dd\u7259\u6570\u636e\u3002\u9700\u8981\u4fee\u6539lab4_1\u6240\u5199\u7684\u4ee3\u7801\u5e76\u6dfb\u52a0\u4e2d\u65ad\u5904\u7406\uff0c\u4f7f\u5f97\u7b49\u5f85\u84dd\u7259\u7684\u8fdb\u7a0b\u80fd\u591f\u81ea\u52a8\u4f11\u7720\uff0c\u6267\u884cdelay\u8fdb\u7a0b\uff0c\u76f4\u5230\u53d1\u751f\u5916\u90e8\u4e2d\u65ad\u540e\u624d\u7ee7\u7eed\u6267\u884c\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter6_device_remove/#_6","title":"\u5b9e\u9a8c\u5185\u5bb9","text":"<p>\u5982\u8f93\u51fa\u63d0\u793a\u6240\u8868\u793a\u7684\u90a3\u6837\uff0c\u9700\u8981\u4fee\u6539lab4_1\u6240\u5199\u7684\u4ee3\u7801\u5e76\u6dfb\u52a0\u4e2d\u65ad\u5904\u7406\u3002\u5b8c\u6210\u540e\u6309lab4_1\u7684\u65b9\u6cd5\u6267\u884c\uff0c\u7a0b\u5e8f\u5728\u7b49\u5f85\u84dd\u7259\u7684\u65f6\u5019\u4f1a\u4e0d\u65ad\u8f93\u51fawaiting for you\u63d0\u793a\u4fe1\u606f\uff0c\u5728\u624b\u673a\u4e0a\u8f93\u5165\u63a7\u5236\u6307\u4ee4\u540e\uff0c\u5c0f\u8f66\u5e94\u80fd\u6839\u636e\u6307\u4ee4\u53cd\u5e94\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter6_device_remove/#_7","title":"\u5b9e\u9a8c\u6307\u5bfc","text":"<p>\u5728kernel/syscall.c\u4e2d\u627e\u5230lab4_1\u5199\u7684\u4ee3\u7801\uff0c\u5e76\u6839\u636e\u6ce8\u91ca\u8fdb\u884c\u4fee\u6539\uff1a</p> <pre><code> 95 ssize_t sys_user_uart_getchar() {\n96   // TODO (lab4_1 and lab4_2): implment the syscall of sys_user_uart_getchar and modify it in lab4_2.\n97   // hint (lab4_1): The functionality of sys_user_uart_getchar is to get data from UART address.\n98   // Therefore we should check the data from the address of bluetooth status repeatedly, until the data is ready. \n99   // Then read the data from the address of bluetooth reading and return.\n100   // hint (lab4_2): the functionality of sys_user_uart_getchar is let process sleep and wait for value. therefore,\n101   // we should call do_sleep to let process 0 sleep. \n102   // then we should get uartvalue and return.\n103     panic( \"You have to implement sys_user_uart_getchar to get data from UART using uartgetchar in lab4_1 and modify it in lab4_2.\\n\" ); // \u8be5\u884c\u5df2\u88ab\u4f60\u4e4b\u524d\u5199\u7684\u4ee3\u7801\u66ff\u6362\n104 105 }\n</code></pre> <p>\u5f53\u84dd\u7259\u6709\u6570\u636e\u53d1\u9001\u65f6\uff0cpke\u4f1a\u6536\u5230\u5916\u90e8\u4e2d\u65ad\uff0c\u4f60\u9700\u8981\u5b8c\u6210\u63a5\u6536\u5230\u5916\u90e8\u4e2d\u65ad\u540e\u7684\u5904\u7406\u3002</p> <p>\u5728kernel/strap.c\u4e2d\u627e\u5230\u51fd\u6570\u7a7a\u7f3a\uff0c\u5e76\u6839\u636e\u6ce8\u91ca\u5b8c\u6210\u4e2d\u65ad\u5904\u7406\u51fd\u6570\uff1a</p> <pre><code>103     case CAUSE_MEXTERNEL_S_TRAP:\n104       {\n105         //reset the PLIC so that we can get the next external interrupt.\n106         volatile int irq = *(uint32 *)0xc201004L;\n107         *(uint32 *)0xc201004L = irq;\n108         volatile int *ctrl_reg = (void *)(uintptr_t)0x6000000c;\n109         *ctrl_reg = *ctrl_reg | (1 &lt;&lt; 4);\n110         // TODO (lab4_2): implment the case of CAUSE_MEXTERNEL_S_TRAP.\n111         // hint: the case of CAUSE_MEXTERNEL_S_TRAP is to get data from UART address and wake the process. therefore,\n112         // and you need to store the data in struct process.value. \n113         panic( \"You have to implement CAUSE_MEXTERNEL_S_TRAP to get data from UART and wake the process 0 in lab4_2.\\n\" );\n114         115         break;\n116       }\n</code></pre> <p>\u5b9e\u9a8c\u5b8c\u6bd5\u540e\uff0c\u8bb0\u5f97\u63d0\u4ea4\u4fee\u6539\uff08\u547d\u4ee4\u884c\u4e2d-m\u540e\u7684\u5b57\u7b26\u4e32\u53ef\u81ea\u884c\u786e\u5b9a\uff09\uff0c\u4ee5\u4fbf\u5728\u540e\u7eed\u5b9e\u9a8c\u4e2d\u7ee7\u627flab4_2\u4e2d\u6240\u505a\u7684\u5de5\u4f5c\uff1a</p> <pre><code>$ git commit -a -m \"my work on lab4_2 is done.\"\n</code></pre> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter6_device_remove/#64-lab4_3_hostdevice","title":"6.4 lab4_3_hostdevice","text":""},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter6_device_remove/#_8","title":"\u7ed9\u5b9a\u5e94\u7528","text":"<ul> <li>user/app_host_device.c</li> </ul> <pre><code>  1 #pragma pack(4) // \u8bbe\u7f6e\u7ed3\u6784\u4f53\u63094\u5b57\u8282\u5bf9\u9f50\uff0c\u56e0\u4e3aPS\u7aef\u662f32\u4f4d\uff0c\u800criscv\u7f16\u8bd1\u5668\u9ed8\u8ba4\u4f1a\u630964\u4f4d\u76848\u5b57\u8282\u5bf9\u9f50\n2 #define _SYS__TIMEVAL_H_ // \u91cd\u8f7dtimeval\u7ed3\u6784\u4f53\uff0c\u56e0\u4e3ariscv\u7f16\u8bd1\u5668\u91cc\u7684timeval\u4e24\u4e2a\u5c5e\u6027\u90fd\u662f8\u5b57\u8282\u548cPS\u7aef32\u4f4d\u7cfb\u7edf\u4e0d\u540c                           \n3 struct timeval {\n4     unsigned int tv_sec;\n5     unsigned int tv_usec;\n6 };\n7 8 #include \"user_lib.h\"\n9 #include \"videodev2.h\"\n10 #define DARK 64\n11 #define RATIO 7 / 10\n12 13 int main() {\n14     char *info = allocate_share_page(); // \u5206\u914d\u4e00\u4e2a\u5171\u4eab\u9875\uff0c\u65b9\u4fbf\u7236\u5b50\u8fdb\u7a0b\u4e4b\u95f4\u4f20\u9012\u4fe1\u606f\uff08\u5c0f\u8f66\u7684\u72b6\u6001\uff09\n15     int pid = do_fork();\n16     if (pid == 0) { // \u5b50\u8fdb\u7a0b\n17         int f = do_open(\"/dev/video0\", O_RDWR), r; // \u6253\u5f00\u8bbe\u5907\u6587\u4ef6\n18 19         struct v4l2_format fmt;\n20         fmt.type = V4L2_BUF_TYPE_VIDEO_CAPTURE;\n21         fmt.fmt.pix.pixelformat = V4L2_PIX_FMT_YUYV;\n22         fmt.fmt.pix.width = 320;\n23         fmt.fmt.pix.height = 180;\n24         fmt.fmt.pix.field = V4L2_FIELD_NONE;\n25         r = do_ioctl(f, VIDIOC_S_FMT, &amp;fmt); // \u8bbe\u7f6e\u6444\u50cf\u5934\uff1a\u56fe\u7247\u5927\u5c0f\u4e3a320*180\uff0c\u683c\u5f0f\u4e3aYUYV\n26         printu(\"Pass format: %d\\n\", r);\n27 28         struct v4l2_requestbuffers req;\n29         req.type = V4L2_BUF_TYPE_VIDEO_CAPTURE;\n30         req.count = 1; req.memory = V4L2_MEMORY_MMAP;\n31         r = do_ioctl(f, VIDIOC_REQBUFS, &amp;req); // \u8bbe\u7f6e\u6444\u50cf\u5934\uff1a\u4f7f\u7528mmap\u65b9\u5f0f\u8bfb\u53d6\u6570\u636e\uff0c\u7f13\u51b2\u533a\u6570\u91cf\u4e3a1\n32         printu(\"Pass request: %d\\n\", r);\n33 34         struct v4l2_buffer buf;\n35         buf.type = V4L2_BUF_TYPE_VIDEO_CAPTURE;\n36         buf.memory = V4L2_MEMORY_MMAP; buf.index = 0;\n37         r = do_ioctl(f, VIDIOC_QUERYBUF, &amp;buf); // \u8bbe\u7f6ebuf\u7ed3\u6784\u4f53\u5bf9\u5e94\u7684\u7f13\u51b2\u533a\u7d22\u5f15\n38         printu(\"Pass buffer: %d\\n\", r);\n39 40         int length = buf.length;\n41         char *img = do_mmap(NULL, length, PROT_READ | PROT_WRITE, MAP_SHARED, f, buf.m.offset); // mmap\u6620\u5c04\u5185\u5b58\n42         unsigned int type = V4L2_BUF_TYPE_VIDEO_CAPTURE;\n43         r = do_ioctl(f, VIDIOC_STREAMON, &amp;type); // \u5f00\u542f\u6444\u50cf\u5934\n44         printu(\"Open stream: %d\\n\", r);\n45 46         char *img_data = allocate_page(); // \u5206\u914d\u5185\u5b58\uff0c\u7528\u6765\u4fdd\u5b58\u56fe\u7247\n47         for (int i = 0; i &lt; (length + 4095) / 4096 - 1; i++)\n48             allocate_page(); // \u56fe\u7247\u8f83\u5927\uff0c\u9700\u5206\u914d\u66f4\u591a\u7684\u9875\n49         yield(); // \u521d\u59cb\u5316\u5b8c\u8bbe\u5907\u4e86\uff0c\u8ba9\u4e3b\u8fdb\u7a0b\u5f00\u59cb\u76d1\u542c\u84dd\u7259\n50 51         for (;;) {\n52             if (*info == '1') { // \u5c0f\u8f66\u5904\u4e8e\u524d\u8fdb\u72b6\u6001\n53                 r = do_ioctl(f, VIDIOC_QBUF, &amp;buf); // \u7f13\u51b2\u5165\u961f\n54                 printu(\"Buffer enqueue: %d\\n\", r);\n55                 r = do_ioctl(f, VIDIOC_DQBUF, &amp;buf); // \u7f13\u51b2\u51fa\u961f\uff0c\u8fd9\u65f6\u62cd\u6444\u5b8c\u4e00\u5f20\u7167\u7247\n56                 printu(\"Buffer dequeue: %d\\n\", r);\n57                 r = read_mmap(img_data, img, length); // \u628a\u7167\u7247\u4ecePS\u7aef\u7684\u6620\u5c04\u5185\u5b58\u8bfb\u51fa\u6765\n58                 int num = 0;\n59                 for (int i = 0; i &lt; length; i += 2)\n60                     if (img_data[i] &lt; DARK) num++; // \u7edf\u8ba1\u7070\u5ea6\u5c0f\u4e8eDARK\u7684\u50cf\u7d20\u6570\u91cf\n61                 printu(\"Dark num: %d &gt; %d\\n\", num, length / 2 * RATIO);\n62                 if (num &gt; length / 2 * RATIO) { // \u5982\u679c\u7070\u5ea6\u5c0f\u4e8eDARK\u7684\u50cf\u7d20\u6570\u91cf\u5927\u4e8e\u50cf\u7d20\u603b\u6570\u7684RATIO\u6bd4\u4f8b\uff08\u6ce8\u610flength\u662fyuyv\u56fe\u7247\u6570\u636e\u7684\u603b\u5927\u5c0f\uff0c\u50cf\u7d20\u603b\u6570\u662f\u8be5\u5927\u5c0f\u7684\u4e00\u534a\uff09\n63                     *info = '0'; gpio_reg_write(0x00); // \u5239\u8f66\n64                 }\n65             } else if (*info == 'q') break;\n66         }\n67 68         for (char *i = img_data; i - img_data &lt; length; i += 4096)\n69             free_page(i); // \u91ca\u653e\u5185\u5b58\n70         r = do_ioctl(f, VIDIOC_STREAMOFF, &amp;type); // \u5173\u95ed\u6444\u50cf\u5934\n71         printu(\"Close stream: %d\\n\", r);\n72         do_munmap(img, length); do_close(f); exit(0); // \u5173\u95ed\u6587\u4ef6\u548c\u89e3\u6620\u5c04  \n73     } else { // \u4e3b\u8fdb\u7a0b\n74         yield(); // \u5148\u8ba9\u5b50\u8fdb\u7a0b\u521d\u59cb\u5316\u5b8c\u6444\u50cf\u5934\n75         for (;;) {\n76             char temp = (char)uartgetchar(); // \u63a5\u53d7\u84dd\u7259\u4fe1\u53f7\n77             printu(\"From bluetooth: %c\\n\", temp);\n78             *info = temp;\n79             switch (temp) {\n80                 case '1': gpio_reg_write(0x2e); break; //\u524d\u8fdb\n81                 case '2': gpio_reg_write(0xd1); break; //\u540e\u9000\n82                 case '3': gpio_reg_write(0x63); break; //\u5de6\u8f6c\n83                 case '4': gpio_reg_write(0x9c); break; //\u53f3\u8f6c\n84                 case 'q': exit(0); break;\n85                 default: gpio_reg_write(0x00); break;  //\u505c\u6b62\n86             }\n87         }\n88     }\n89     return 0;\n90 }         </code></pre> <p>\u8be5\u7528\u6237\u7a0b\u5e8f\u5305\u542b\u4e24\u4e2a\u8fdb\u7a0b\uff0c\u5176\u4e2d\u4e3b\u8fdb\u7a0b\u548c\u5b9e\u9a8c4_2\u7c7b\u4f3c\uff0c\u8d1f\u8d23\u63a5\u6536\u84dd\u7259\u53d1\u9001\u8fc7\u6765\u7684\u6570\u636e\uff0c\u6839\u636e\u6570\u636e\u63a7\u5236\u5c0f\u8f66\u884c\u52a8\uff08\u524d\u8fdb\u3001\u540e\u9000\u3001\u5de6\u8f6c\u3001\u53f3\u8f6c\u3001\u505c\u6b62\uff09\uff1b\u5b50\u8fdb\u7a0b\u5219\u8d1f\u8d23\u62cd\u6444\u548c\u5206\u6790\uff0c\u9996\u5148\u521d\u59cb\u5316\u6444\u50cf\u5934\u8bbe\u5907\uff0c\u7136\u540e\u662f\u4e2a\u6b7b\u5faa\u73af\u5224\u65ad\u6444\u50cf\u5934\u62cd\u6444\u7684\u56fe\u50cf\u6570\u636e\uff1a\u5982\u679c\u5f53\u524d\u5c0f\u8f66\u5904\u4e8e\u524d\u8fdb\u72b6\u6001\uff0c\u5219\u62cd\u6444\uff0c\u7136\u540e\u68c0\u67e5\u6570\u636e\uff0c\u5982\u679c\u5224\u65ad\u524d\u9762\u6709\u969c\u788d\u7269\u5219\u63a7\u5236\u8f66\u8f6e\u505c\u8f6c\uff08\u5239\u8f66\uff09\uff0c\u5426\u5219\u5982\u679c\u4e3b\u8fdb\u7a0b\u9000\u51fa\u4e86\uff0c\u5219\u81ea\u5df1\u8fdb\u884c\u91ca\u653e\u6587\u4ef6\u3001\u5185\u5b58\u3001\u5173\u95ed\u8bbe\u5907\u7b49\u64cd\u4f5c\uff0c\u518d\u9000\u51fa\u3002\u5728\u7528\u6237\u7a0b\u5e8f\u64cd\u63a7\u6444\u50cf\u5934\u7684\u8fc7\u7a0b\u4e2d\uff0c\u4f7f\u7528\u4e86ioctl\u3001mmap\u3001munmap\u7b49\u7cfb\u7edf\u8c03\u7528\uff0c\u4f60\u9700\u5b8c\u5584\u5176\u4e2d\u7684open\u548cioctl\u4e24\u4e2a\u7cfb\u7edf\u8c03\u7528\uff0c\u5bf9\u5176\u8fdb\u884c\u5b8c\u5584\u4ece\u800c\u5b9e\u73b0\u5c0f\u8f66\u7684\u969c\u788d\u8bc6\u522b\u548c\u505c\u6b62\u529f\u80fd\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter6_device_remove/#_9","title":"\u5b9e\u9a8c\u5185\u5bb9","text":"<p>\u5982\u5e94\u7528\u63d0\u793a\u6240\u8868\u793a\u7684\u90a3\u6837\uff0c\u8bfb\u8005\u9700\u8981\u627e\u5230\u5e76\u5b8c\u6210\u5bf9open\u548cioctl\u7684\u8c03\u7528\uff0c\u4f7f\u5f97\u7528\u6237\u80fd\u591f\u8bbe\u7f6e\u8bbe\u5907\u53c2\u6570\uff0c\u4ece\u800c\u63a7\u5236\u6444\u50cf\u5934\u5b9e\u73b0\u62cd\u7167\u7b49\u529f\u80fd\uff1b\u83b7\u53d6\u56fe\u7247\u540e\uff0c\u68c0\u67e5\u6570\u636e\uff0c\u4ece\u800c\u5224\u65ad\u524d\u65b9\u662f\u5426\u51fa\u73b0\u969c\u788d\u7269\u3002</p> <p>\u8ddf\u8e2a\u76f8\u5173\u7cfb\u7edf\u8c03\u7528\uff0c\u5728kernel/file.c\u91cc\u53ef\u4ee5\u770b\u5230\u9700\u8981\u8865\u5145\u7684\u51fd\u6570\uff1a</p> <pre><code> 25 int do_open(char *pathname, int flags) {\n26     // TODO (lab4_3): call host open through spike_file_open and then bind fd to spike_file\n27     // hint: spike_file_dup function can bind spike_file_t to an int fd.\n28     panic( \"You need to finish open function in lab4_3.\\n\" );\n29 }\n30 int do_write(int fd, char *buf, uint64 count) {\n31     spike_file_t *f = spike_file_get(fd);\n32     return spike_file_write(f, buf, count);\n33 }\n34 int do_close(int fd) {\n35     spike_file_t *f = spike_file_get(fd);\n36     return spike_file_close(f);\n37 }\n38 39 int do_ioctl(int fd, uint64 request, char *data) {\n40     // TODO (lab4_3): call host ioctl through frontend_sycall\n41     // hint: fronted_syscall ioctl argument:\n42     // 1.call number\n43     // 2.fd\n44     // 3.the order to device\n45     // 4.data address\n46     panic( \"You need to call host's ioctl by frontend_syscall in lab4_3.\\n\" );\n47 }\n</code></pre> <p>\u5b9e\u9a8c\u9884\u671f\u7ed3\u679c\uff1a\u5c0f\u8f66\u5728\u524d\u8fdb\u8fc7\u7a0b\u4e2d\u80fd\u591f\u6b63\u5e38\u8bc6\u522b\u969c\u788d\u7269\u540e\u5e76\u81ea\u52a8\u505c\u8f66\u3002\u6d4b\u8bd5\u65f6\u522b\u5fd8\u8bb0\u628a\u6444\u50cf\u5934\u63a5\u5230USB\u63a5\u53e3\uff0c\u5426\u5219\u7cfb\u7edf\u4f1a\u627e\u4e0d\u5230\u8bbe\u5907\u6587\u4ef6\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter6_device_remove/#_10","title":"\u5b9e\u9a8c\u6307\u5bfc","text":""},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter6_device_remove/#_11","title":"\u6444\u50cf\u5934\u63a7\u5236","text":"<p>USB\u6444\u50cf\u5934\u6700\u57fa\u7840\u7684\u63a7\u5236\u65b9\u6cd5\u662f\u4f7f\u7528\u8bfb\u5199\u8bbe\u5907\u6587\u4ef6\u7684\u65b9\u5f0f\u3002\u62cd\u6444\u4e00\u5f20\u7167\u7247\u5305\u542b\u4ee5\u4e0b\u8fc7\u7a0b\uff1a</p> <ul> <li>\u6253\u5f00\u8bbe\u5907\u6587\u4ef6\uff0c\u4f7f\u7528open\u51fd\u6570</li> <li>\u8bbe\u7f6e\u8bbe\u5907\u53c2\u6570\uff0c\u4f7f\u7528ioctl\u51fd\u6570\uff0c\u5305\u62ec\u8bbe\u7f6e\u6444\u50cf\u5934\u7684\u56fe\u50cf\u5206\u8fa8\u7387\u548c\u683c\u5f0f\u3001\u8bfb\u53d6\u65b9\u5f0f\u3001\u7f13\u51b2\u6570\u91cf\u548c\u7d22\u5f15\u7b49</li> <li>\u6620\u5c04\u5185\u5b58\uff0c\u7531\u4e8eUSB\u6444\u50cf\u5934\u5bf9\u5e94\u7684\u8bbe\u5907\u6587\u4ef6\u4e0d\u652f\u6301\u76f4\u63a5\u7528read\u51fd\u6570\u8fdb\u884c\u8bfb\u5199\uff0c\u6240\u4ee5\u9700\u8981\u7528mmap\u51fd\u6570\u5c06\u6587\u4ef6\u6620\u5c04\u5230\u4e00\u6bb5\u865a\u62df\u5730\u5740\uff0c\u901a\u8fc7\u865a\u62df\u5730\u5740\u8fdb\u884c\u8bfb\u5199</li> <li>\u62cd\u6444\uff0c\u4f7f\u7528ioctl\u51fd\u6570\u63a7\u5236\uff0c\u8bbe\u7f6e\u7f13\u51b2\u533a\u7684\u5165\u961f\u548c\u51fa\u961f\u4e3a\u4e00\u4e2a\u62cd\u6444\u8fc7\u7a0b</li> <li>\u7ed3\u675f\u548c\u6e05\u7406\uff0c\u5305\u542b\u4f7f\u7528ioctl\u51fd\u6570\u5173\u95ed\u8bbe\u5907\uff0c\u4f7f\u7528munmap\u51fd\u6570\u89e3\u6620\u5c04\uff0c\u4f7f\u7528close\u51fd\u6570\u5173\u95ed\u8bbe\u5907\u6587\u4ef6</li> </ul>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter6_device_remove/#_12","title":"\u56fe\u7247\u89e3\u6790","text":"<p>\u5728\u672c\u5b9e\u9a8c\u7684\u7528\u6237\u7a0b\u5e8f\u4e2d\uff0c\u6211\u4eec\u5b9e\u73b0\u4e86\u4e00\u4e2a\u975e\u5e38\u7b80\u5355\u7684\u969c\u788d\u7269\u5224\u65ad\u7b97\u6cd5\uff1a\u8ba1\u7b97\u7070\u5ea6\u5c0f\u4e8e64\u7684\u50cf\u7d20\u70b9\u4e2a\u6570\uff0c\u5982\u679c\u4e2a\u6570\u5927\u4e8e\u50cf\u7d20\u70b9\u603b\u6570\u76847/10\uff0c\u5373\u8ba4\u4e3a\u524d\u65b9\u662f\u969c\u788d\u7269\u3002</p> <p>\u5e94\u7528\u7b2c21\u884c\u53ef\u4ee5\u770b\u5230\uff0c\u6211\u4eec\u4ece\u6444\u50cf\u5934\u83b7\u53d6\u7684\u6570\u636e\u662fYUYV\u683c\u5f0f\uff0c\u8bfb\u8005\u53ef\u8fdb\u884c\u67e5\u9605\uff0c\u5b83\u7528\u7070\u5ea6\u3001\u84dd\u8272\u8272\u5ea6\u3001\u7ea2\u8272\u8272\u5ea6\u4e09\u4e2a\u5c5e\u6027\u8868\u793a\u989c\u8272\uff0c\u6bcf\u4e2a\u50cf\u7d20\u70b9\u90fd\u6709\u7070\u5ea6\u5c5e\u6027\u3002\u7531\u4e8e\u6211\u4eec\u5206\u6790\u969c\u788d\u7269\u53ea\u9700\u8981\u7070\u5ea6\u56fe\uff0c\u6240\u4ee5\u53d6\u6bcf\u4e2a\u50cf\u7d20\u70b9\u7684\u7070\u5ea6\u5c5e\u6027\u5373\u53ef\u3002\u56e0\u6b64\u5bf9\u4e8e\u83b7\u53d6\u8fc7\u6765\u7684\u6570\u636e\u5220\u53bb\u5947\u6570\u7d22\u5f15\u7684\u6570\u636e\uff0c\u5c31\u53ef\u4ee5\u5f97\u5230\u7070\u5ea6\u56fe\u3002</p> <p>\u6ce8\u610f\uff1a\u5bf9\u4e8e\u7070\u5ea6\u9608\u503c\u7684\u8bbe\u5b9a\u53ef\u6839\u636e\u73af\u5883\u4eae\u5ea6\u8fdb\u884c\u4e00\u5b9a\u7684\u8c03\u6574\uff0c\u53ef\u4ee5\u5148\u6839\u636e\u6444\u50cf\u5934\u8fd4\u56de\u7684\u56fe\u50cf\u8fdb\u884c\u5206\u6790\uff0c\u8ba1\u7b97\u51fa\u5bf9\u5e94\u969c\u788d\u7269\u7684\u7070\u5ea6\u503c\uff1b\u7070\u5ea6\u9608\u503c\u8d8a\u7cbe\u786e\uff0c\u5c0f\u8f66\u5bf9\u4e8e\u969c\u788d\u7269\u7684\u8bc6\u522b\u5c06\u8d8a\u7075\u654f\uff0c\u5e76\u80fd\u5728\u5408\u7406\u7684\u8ddd\u79bb\u5185\u8bc6\u522b\u5230\u969c\u788d\u7269\u5e76\u505c\u8f66\u3002 \u867d\u7136\u5982\u6b64\uff0c\u8be5\u7b97\u6cd5\u4ecd\u4e0d\u662f\u975e\u5e38\u7cbe\u786e\u3002\u6240\u4ee5\uff0c\u8fd9\u91cc\u7ed9\u51fa\u7684\u969c\u788d\u7269\u5224\u65ad\u7b97\u6cd5\u4ec5\u4f9b\u53c2\u8003\uff0c\u6211\u4eec\u9f13\u52b1\u5927\u5bb6\u7f16\u5199\u66f4\u9ad8\u7ea7\u7684\u7b97\u6cd5\uff0c\u5b9e\u73b0\u66f4\u5f3a\u5927\u7684\u529f\u80fd\u3002</p> <p>\u5b9e\u9a8c\u5b8c\u6bd5\u540e\uff0c\u8bb0\u5f97\u63d0\u4ea4\u4fee\u6539\uff08\u547d\u4ee4\u884c\u4e2d-m\u540e\u7684\u5b57\u7b26\u4e32\u53ef\u81ea\u884c\u786e\u5b9a\uff09\uff0c\u4ee5\u4fbf\u5728\u540e\u7eed\u5b9e\u9a8c\u4e2d\u7ee7\u627flab4_3\u4e2d\u6240\u505a\u7684\u5de5\u4f5c\uff1a</p> <pre><code>$ git commit -a -m \"my work on lab4_3 is done.\"\n</code></pre>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter6_riscv_on_pynq/","title":"Chapter6 riscv on pynq","text":""},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter6_riscv_on_pynq/#riscvpynq","title":"\u7b2c\u516d\u7ae0. RISCV\u5904\u7406\u5668\u5728PYNQ\u4e0a\u7684\u90e8\u7f72\u548c\u63a5\u53e3\u5b9e\u9a8c","text":""},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter6_riscv_on_pynq/#_1","title":"\u76ee\u5f55","text":"<ul> <li>6.1 \u7cfb\u7edf\u80fd\u529b\u57f9\u517b\u90e8\u5206\u5b9e\u9a8c\u73af\u5883\u5b89\u88c5 </li> <li>6.1.1 Vivado\u5f00\u53d1\u73af\u5883</li> <li>6.1.2 fpga-pynq\u5de5\u7a0b\u6e90\u7801\u83b7\u53d6</li> <li>6.1.3 \u5de5\u7a0b\u7f16\u8bd1\u73af\u5883\u914d\u7f6e</li> <li>6.1.4 \u84dd\u7259\u5c0f\u8f66\u786c\u4ef6\u7ec4\u88c5</li> <li>6.1.5 \u64cd\u4f5c\u7cfb\u7edf\u7684\u66ff\u6362\u4fee\u6539</li> <li>6.2 fpga\u5b9e\u9a8c1\uff1a\u5728Rocket Chip\u4e0a\u6dfb\u52a0uart\u63a5\u53e3</li> <li>\u5b9e\u9a8c\u76ee\u7684</li> <li>\u5b9e\u9a8c\u5185\u5bb9</li> <li>\u5b9e\u9a8c\u7ed3\u679c</li> <li>6.3 fpga\u5b9e\u9a8c2\uff1a\u4ee5\u4e2d\u65ad\u65b9\u5f0f\u5b9e\u73b0uart\u901a\u4fe1</li> <li>\u5b9e\u9a8c\u76ee\u7684</li> <li>\u5b9e\u9a8c\u5185\u5bb9</li> <li>\u5b9e\u9a8c\u7ed3\u679c</li> <li> <p>6.4 fpga\u5b9e\u9a8c3\uff1a\u914d\u7f6e\u8fde\u63a5\u5230PS\u7aef\u7684USB\u8bbe\u5907</p> </li> <li> <p>\u5b9e\u9a8c\u76ee\u7684</p> </li> <li>\u5b9e\u9a8c\u5185\u5bb9</li> <li>\u5b9e\u9a8c\u7ed3\u679c</li> </ul> <p>\u5728\u672c\u7ae0\u4e2d\uff0c\u6211\u4eec\u5c06\u7ed3\u5408fpga-pynq\u5f00\u53d1\u677f\uff0c\u5728PYNQ\u4e0a\u90e8\u7f72RISCV\u5904\u7406\u5668\u3002\u5e76\u5e26\u9886\u8bfb\u8005\u5bf9rocket chip\u8fdb\u884c\u4e00\u4e9b\u4fee\u6539\uff0c\u9010\u6b65\u4e3a\u5176\u6dfb\u52a0uart\u5916\u8bbe\u652f\u6301\u548c\u4e2d\u65ad\u652f\u6301\uff0c\u5e76\u642d\u8f7dPKE\u5185\u6838\uff0c\u8fd0\u884c\u5c0f\u8f66\u63a7\u5236\u7a0b\u5e8f\uff0c\u5b9e\u73b0\u4e00\u4e2a\u53ef\u4ee5\u901a\u8fc7\u84dd\u7259\u63a7\u5236\u7684\u667a\u80fd\u5c0f\u8f66\u3002\u8bfb\u8005\u5728\u5b8c\u62106.1\u8282\u548c6.2\u8282\u4e2d\u7684\u5b9e\u9a8c\u73af\u5883\u642d\u5efa\u540e\uff0c\u4fbf\u53ef\u8fdb\u884c6.3\u8282\u30016.4\u8282\u548c6.5\u8282\u4e2d\u7684\u76f8\u5173\u5b9e\u9a8c\u3002</p> <p>\u9700\u8981\u7279\u522b\u6ce8\u610f\u7684\u662f\uff0c\u672c\u7ae0\u4e2d\u7684\u4e09\u4e2afpga\u5b9e\u9a8c\u5e76\u4e0d\u662f\u72ec\u7acb\u8bbe\u8ba1\u7684\uff0c\u800c\u662f\u4e0e\u7b2c\u4e03\u7ae0\u4e2d\u7684\u5b9e\u9a8c4_1\u30014_2\u548c4_3\u4f9d\u6b21\u5bf9\u5e94\u3002\u6bcf\u4e00\u4e2afpga\u5b9e\u9a8c\u4e3a\u5bf9\u5e94\u7684\u8f6f\u4ef6\u5b9e\u73b0\u63d0\u4f9b\u786c\u4ef6\u652f\u6301\u3002\u56e0\u6b64\uff0c\u8bfb\u8005\u5e94\u8be5\u6309\u7167\u5982\u4e0b\u987a\u5e8f\u6765\u5b8c\u6210\u7b2c\u516d\u7ae0\u548c\u7b2c\u4e03\u7ae0\u7684\u5b9e\u9a8c\uff1a\u5728\u5b8c\u6210\u201c6.3 fpga\u5b9e\u9a8c1\u201d\u540e\uff0c\u524d\u5f80\u7b2c\u4e03\u7ae0\uff0c\u5b8c\u6210\u5bf9\u5e94\u7684PKE\u8f6f\u4ef6\u5b9e\u9a8c\u2014\u2014\u201c7.2 lab4_1_POLL\u201d\uff1b\u5728\u5b8c\u6210\"6.4 fpga\u5b9e\u9a8c2\"\u540e\uff0c\u524d\u5f80\u7b2c\u4e03\u7ae0\uff0c\u5b8c\u6210\u5bf9\u5e94\u7684PKE\u8f6f\u4ef6\u5b9e\u9a8c\u2014\u2014\u201c7.3 lab4_2_PLIC\u201d\uff1b\u5728\u5b8c\u6210\"6.5 fpga\u5b9e\u9a8c3\"\u540e\uff0c\u524d\u5f80\u7b2c\u4e03\u7ae0\uff0c\u5b8c\u6210\u5bf9\u5e94\u7684PKE\u8f6f\u4ef6\u5b9e\u9a8c\u2014\u2014\u201c7.4 lab4_3_hostdevice\u201d\u3002 </p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter6_riscv_on_pynq/#61","title":"6.1 \u7cfb\u7edf\u80fd\u529b\u57f9\u517b\u90e8\u5206\u5b9e\u9a8c\u73af\u5883\u5b89\u88c5","text":""},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter6_riscv_on_pynq/#611-vivado","title":"6.1.1 Vivado\u5f00\u53d1\u73af\u5883","text":"<p>Vivado\u8bbe\u8ba1\u5957\u4ef6\uff0c\u662fFPGA\u5382\u5546\u8d5b\u7075\u601d\u516c\u53f82012\u5e74\u53d1\u5e03\u7684\u96c6\u6210\u8bbe\u8ba1\u73af\u5883\u3002\u672c\u5b9e\u9a8c\u9700\u8981\u4f7f\u7528Vivado\u5bf9FPGA\u7535\u8def\u8fdb\u884c\u4fee\u6539\u3002Vivado\u8bbe\u8ba1\u5957\u4ef6\u5728Windows\u5e73\u53f0\u4e0eLinux\u5e73\u53f0\u90fd\u53ef\u5b89\u88c5\u4f7f\u7528\uff0c\u4e14\u5b89\u88c5\u4e0e\u4f7f\u7528\u8fc7\u7a0b\u57fa\u672c\u76f8\u540c\uff0c\u8bfb\u8005\u53ef\u6839\u636e\u81ea\u8eab\u60c5\u51b5\u9009\u62e9\u3002\u4e0b\u9762\u8be6\u7ec6\u4ecb\u7ecd\u8fd9\u4e24\u79cd\u642d\u5efa\u65b9\u6848\uff1a</p> <p>\u65b9\u6848\u4e00\uff1aWindows\u5e73\u53f0</p> <p>Vivado\u5f00\u53d1\u73af\u5883\u63d0\u4f9bWindows\u5e73\u53f0\u652f\u6301\uff0c\u8be5\u65b9\u6848\u7684\u5b89\u88c5\u8fc7\u7a0b\u7b80\u5355\uff0c\u63a8\u8350\u8bfb\u8005\u4f18\u5148\u9009\u62e9\u6b64\u65b9\u6848\u8fdb\u884cVivado\u5f00\u53d1\u73af\u5883\u642d\u5efa\u3002\u5177\u4f53\u6b65\u9aa4\u5982\u4e0b\uff1a</p> <ol> <li>\u4e0b\u8f7d\u5b89\u88c5\u7a0b\u5e8f\u3002\u5efa\u8bae\u5b89\u88c52016.2\u7248\u672c\u7684Vivado\uff0c\u8fdb\u5165\u4e0b\u8f7d\u9875\u9762\u4e0b\u62c9\u627e\u52302016.2\u7248\u672c\uff0c\u4e0b\u8f7dWindows Web Installer\uff0c\u5728\u5f39\u51fa\u7684Xilinx\u8d26\u53f7\u767b\u5f55\u9875\u9762\u6ce8\u518c\u8d26\u53f7\u5e76\u767b\u5f55\u540e\u4e0b\u8f7d\u4f1a\u81ea\u52a8\u5f00\u59cb\u3002</li> </ol> <p></p> <ol> <li>\u542f\u52a8\u5b89\u88c5\u7a0b\u5e8f\u3002\u6ce8\u610f\uff1a\u5b89\u88c5\u8fc7\u7a0b\u9700\u8981\u4fdd\u8bc1\u7f51\u7edc\u7545\u901a\u3002\u4ee5\u53ca30G\u4ee5\u4e0a\u7684\u78c1\u76d8\u5269\u4f59\u7a7a\u95f4\u3002</li> </ol> <p>\u53cc\u51fb\u6240\u4e0b\u8f7d\u7684\u5b89\u88c5\u5305\uff0c\u76f4\u63a5\u8fd0\u884c\u5373\u53ef\u3002\u5982\u4e0b\u56fe\u7a97\u53e3\u5f39\u51fa\u65f6\uff0c\u70b9\u51fbContinue\u3002</p> <p></p> <ol> <li>\u8fdb\u5165\u6b22\u8fce\u9875\u9762\uff0c\u70b9\u51fbnext\u3002</li> </ol> <p></p> <ol> <li>\u8f93\u5165Xilinx\u8d26\u53f7\u5bc6\u7801\uff0c\u5e76\u9009\u4e2dDownload and Install Now\u540e\uff0c\u70b9\u51fbnext\u3002\u4e0b\u8f7dVivado\u5b89\u88c5\u5305\u65f6\u6ce8\u518c\u7684\u8d26\u53f7\u53ef\u4ee5\u5728\u6b64\u5904\u4f7f\u7528\uff0c\u82e5\u65e0\u8d26\u53f7\u5219\u53ef\u4ee5\u70b9\u51fb\u4e0a\u65b9\u201cplease create one\u201d\u8fdb\u884c\u6ce8\u518c\u3002</li> </ol> <p></p> <ol> <li>\u52fe\u9009\u540c\u610f\u7528\u6237\u534f\u8bae\u540e\uff0c\u70b9\u51fbnext\u3002</li> </ol> <p></p> <ol> <li>\u52fe\u9009Vivado HL System Edition\u540e\uff0c\u70b9\u51fbnext\u3002</li> </ol> <p></p> <ol> <li>\u6839\u636e\u9700\u8981\u52fe\u9009\u5b89\u88c5\u9879\uff0c\u70b9\u51fbnext\u3002</li> </ol> <p></p> <ol> <li>\u9009\u62e9\u5b89\u88c5\u4f4d\u7f6e\u3002\u70b9\u51fb\u5de6\u4e0a\u89d2\u7684\u5b89\u88c5\u4f4d\u7f6e\u9009\u62e9\u5668\u53f3\u4fa7\u4e09\u70b9\uff0c\u5f39\u51fa\u76ee\u5f55\u9009\u62e9\u7a97\u53e3\uff0c\u8bfb\u8005\u5e94\u5728\u6b64\u5904\u9009\u62e9\u6070\u5f53\u7684\u5b89\u88c5\u4f4d\u7f6e\uff0cVivado\u7a0b\u5e8f\u5c06\u4f1a\u88ab\u5b89\u88c5\u5728\u6240\u9009\u76ee\u5f55\u4e0b\u3002</li> </ol> <p>\u8fd9\u91cc\u9009\u62e9\u5b89\u88c5\u76ee\u5f55\u65f6\uff0c\u9700\u8981\u6ce8\u610f\u4ee5\u4e0b\u4e24\u70b9\uff1a</p> <ul> <li> <p>\u5f53\u524d\u7528\u6237\u9700\u8981\u6709\u5b89\u88c5\u76ee\u5f55\u7684\u5199\u5165\u6743\u9650\u3002</p> </li> <li> <p>\u6240\u9009\u5b89\u88c5\u4f4d\u7f6e\u5269\u4f59\u7a7a\u95f4\u5fc5\u987b\u8db3\u591f\uff08\u8bfb\u8005\u53ef\u4ee5\u67e5\u770b\u5de6\u4e0b\u89d2\u7684Disk Space Required\u680f\uff0c\u6b64\u5904\u4f1a\u663e\u793a\u5b89\u88c5\u6240\u9700\u7a7a\u95f4\uff0c\u4ee5\u53ca\u78c1\u76d8\u5269\u4f59\u7a7a\u95f4\uff09\u3002</p> </li> </ul> <p>\u5f53\u8fd9\u4e24\u4e2a\u6761\u4ef6\u4e0d\u6ee1\u8db3\u65f6\uff0c\u9875\u9762\u4e2d\u4f1a\u6709\u7ea2\u5b57\u63d0\u9192\uff08\u5982\u4e0b\u56fe\u6240\u793a\uff09\uff0c\u8bfb\u8005\u5e94\u7559\u610f\u67e5\u770b\uff1a</p> <p></p> <p>\u6839\u636e\u63d0\u793a\u66f4\u6362\u9002\u5f53\u7684\u5b89\u88c5\u76ee\u5f55\uff08\u4e0b\u56fe\u662f\u9009\u62e9\u5b89\u88c5\u76ee\u5f55\u9002\u5f53\u65f6\u7684\u663e\u793a\uff09\uff1a</p> <p></p> <p>\u786e\u8ba4\u65e0\u8bef\u540e\u70b9\u51fbnext\uff0c\u7ee7\u7eed\u4e0b\u4e00\u6b65\u5b89\u88c5\u3002</p> <ol> <li>\u68c0\u67e5\u5b89\u88c5\u4fe1\u606f\u65e0\u8bef\u540e\uff0c\u70b9\u51fbinstall\u3002</li> </ol> <p></p> <ol> <li>\u7b49\u5f85\u4e0b\u8f7d\u5b89\u88c5\u5b8c\u6210\uff08\u8017\u65f6\u8f83\u957f\uff0c\u52a1\u5fc5\u4fdd\u8bc1\u4e0b\u8f7d\u65f6\u7f51\u7edc\u7545\u901a\uff09\u3002</li> </ol> <p></p> <p>\u5b89\u88c5\u8fc7\u7a0b\u4e2d\u5f39\u51fa\u76f8\u5173\u7ec4\u4ef6\u7684\u5b89\u88c5\u7a97\u53e3\u65f6\uff0c\u6309\u7167\u5f39\u7a97\u63d0\u793a\u70b9\u51fb\u5b89\u88c5\uff08\u6839\u636e\u6240\u9009\u7ec4\u4ef6\u4e0d\u540c\uff0c\u786e\u8ba4\u5b89\u88c5\u5f39\u7a97\u4e2d\u7684\u8f6f\u4ef6\u540d\u79f0\u53ef\u80fd\u6709\u53d8\uff0c\u4e00\u5f8b\u70b9\u51fb\u5b89\u88c5\u5373\u53ef\uff09\u3002</p> <p></p> <ol> <li>\u6dfb\u52a0Vivado\u8bc1\u4e66\u3002\u8bfb\u8005\u5e94\u81ea\u884c\u7533\u8bf7Vivado\u8bc1\u4e66\u540e\u5bfc\u5165\u3002</li> </ol> <p></p> <ol> <li>\u51fa\u73b0\u5982\u4e0b\u7684MATLAB\u9009\u62e9\u7a97\u53e3\u65f6\uff0c\u76f4\u63a5\u70b9\u51fb\u53f3\u4e0a\u89d2\u53c9\u53f7\u5173\u95ed\u5373\u53ef\uff0c\u672c\u5b9e\u9a8c\u4e2d\u4e0d\u4f1a\u7528\u5230\u76f8\u5173\u529f\u80fd\u3002</li> </ol> <p></p> <ol> <li>\u5b89\u88c5\u5b8c\u6210\u5e76\u5bfc\u5165\u8bc1\u4e66\u540e\uff0c\u4f1a\u5f39\u51fa\u5982\u4e0b\u7a97\u53e3\uff0c\u8868\u660e\u5b89\u88c5\u6210\u529f\u3002\u70b9\u51fb\u786e\u8ba4\u540e\u5b89\u88c5\u8fc7\u7a0b\u7ed3\u675f\u3002</li> </ol> <p></p> <p>\u65b9\u6848\u4e8c\uff1aLinux\u5e73\u53f0\uff08Ubuntu\u684c\u9762\u73af\u5883\uff09</p> <p>\u6ce8\u610f\uff1a\u672c\u65b9\u6848\u53ea\u5728\u5177\u6709\u56fe\u5f62\u754c\u9762\u652f\u6301\u7684Linux\u684c\u9762\u73af\u5883\u4e2d\u9002\u7528\uff08Ubuntu\u684c\u9762\u73af\u5883\u6216\u865a\u62df\u673a\u7b49\uff09\u3002\u82e5\u8bfb\u8005\u5728\u524d\u6587\u4e2d\u9009\u62e9\u5728WSL\u4e2d\u5b89\u88c5\u76f8\u5173\u5b9e\u9a8c\u73af\u5883\uff0c\u5219\u5f3a\u70c8\u5efa\u8bae\u76f4\u63a5\u53c2\u8003\u524d\u6587\u7684\u65b9\u6848\u4e00\uff0c\u5728Windows\u7cfb\u7edf\u4e2d\u5b89\u88c5Windows\u7248\u672c\u7684Vivado\uff0c\u4e0d\u8981\u6309\u7167\u672c\u65b9\u6848\u8fdb\u884c\u5b89\u88c5\u3002</p> <ol> <li>\u4e0b\u8f7d\u5b89\u88c5\u7a0b\u5e8f\u3002\u5efa\u8bae\u5b89\u88c52016.2\u7248\u672c\u7684Vivado\uff0c\u8fdb\u5165\u4e0b\u8f7d\u9875\u9762\u4e0b\u62c9\u627e\u52302016.2\u7248\u672c\uff0c\u4e0b\u8f7dLinux Web Installer\uff0c\u5728\u5f39\u51fa\u7684Xilinx\u8d26\u53f7\u767b\u5f55\u9875\u9762\u6ce8\u518c\u8d26\u53f7\u5e76\u767b\u5f55\u540e\u4e0b\u8f7d\u4f1a\u81ea\u52a8\u5f00\u59cb\u3002</li> </ol> <p></p> <ol> <li>\u542f\u52a8\u5b89\u88c5\u7a0b\u5e8f\u3002\u6ce8\u610f\uff1a\u5b89\u88c5\u8fc7\u7a0b\u9700\u8981\u4fdd\u8bc1\u7f51\u7edc\u7545\u901a\u3002\u4ee5\u53ca30G\u4ee5\u4e0a\u7684\u78c1\u76d8\u5269\u4f59\u7a7a\u95f4\u3002</li> </ol> <p>\u9996\u5148\u6253\u5f00\u547d\u4ee4\u884c\uff0c\u8fd0\u884c\u5982\u4e0b\u547d\u4ee4\u5207\u6362\u5230\u5b89\u88c5\u5305\u6240\u5728\u76ee\u5f55\uff1a</p> <p><code>$ cd [your.vivado.download.path]</code></p> <p>\u4ee5\u4e0a\u547d\u4ee4\u4e2d\uff0c[your.vivado.download.path]\u6307\u7684\u662fVivado\u5b89\u88c5\u5305\u7684\u6240\u5728\u76ee\u5f55\u3002\u63a5\u4e0b\u6765\u8981\u4e3a\u5b89\u88c5\u5305\u6dfb\u52a0\u53ef\u6267\u884c\u6743    \u9650\uff0c\u7ee7\u7eed\u5728\u547d\u4ee4\u884c\u4e2d\u6267\u884c\u5982\u4e0b\u547d\u4ee4\uff1a</p> <p><code>$ chmod +x Xilinx_Vivado_SDK_2016.2_0605_1_Lin64.bin</code></p> <p>\u4e0a\u8ff0\u547d\u4ee4\u6267\u884c\u5b8c\u6bd5\u540e\uff0c\u5b89\u88c5\u7a0b\u5e8f\u4fbf\u5177\u6709\u4e86\u53ef\u6267\u884c\u6743\u9650\uff0c\u53ef\u4ee5\u76f4\u63a5\u542f\u52a8\u8fd0\u884c\u3002\u6267\u884c\u5982\u4e0b\u547d\u4ee4\uff1a</p> <p><code>$ ./Xilinx_Vivado_SDK_2016.2_0605_1_Lin64.bin</code></p> <p>\u542f\u52a8\u5b89\u88c5\u7a0b\u5e8f\u3002</p> <p>3\\~9\u6b65\u4e0e\u4e0a\u6587\u65b9\u6848\u4e00\u4e2dWindows\u5e73\u53f0\u5b89\u88c5\u76843\\~9\u6b65\u76f8\u540c\u3002</p> <ol> <li>\u7b49\u5f85\u4e0b\u8f7d\u5b89\u88c5\u5b8c\u6210\uff08\u8017\u65f6\u8f83\u957f\uff0c\u52a1\u5fc5\u4fdd\u8bc1\u4e0b\u8f7d\u65f6\u7f51\u7edc\u7545\u901a\uff09\u3002\u6ce8\u610f\uff0c\u82e5\u5b89\u88c5\u65f6\u957f\u65f6\u95f4\u5361\u5728\u201cgenerating installed device list\u201d\uff0c\u5982\u4e0b\u56fe\uff1a</li> </ol> <p></p> <p>\u53ef\u4ee5\u5148\u9000\u51fa\u5b89\u88c5\u7a0b\u5e8f\uff0c\u9000\u51fa\u65f6\u4ed4\u7ec6\u9605\u8bfb\u5f39\u7a97\u5185\u5bb9\uff08\u4e0d\u8981\u5220\u9664\u5df2\u7ecf\u4e0b\u8f7d\u7684\u6587\u4ef6\u7f13\u5b58\uff0c\u4e0b\u6b21\u8fd0\u884c\u5b89\u88c5\u7a0b\u5e8f\u65f6\u4f1a\u81ea\u52a8\u8df3\u8fc7\u4e0b\u8f7d\uff0c\u8282\u7ea6\u8bfb\u8005\u5b89\u88c5\u65f6\u95f4\uff09\u3002\u4e4b\u540e\u6253\u5f00\u547d\u4ee4\u884c\uff0c\u6267\u884c\uff1a</p> <p><code>$ sudo apt install libncurses5</code></p> <p>\u4e0a\u8ff0\u547d\u4ee4\u4f1a\u5b89\u88c5\u7f3a\u5931\u7684ncurses\u5e93\u3002ncurses\u5e93\u5b89\u88c5\u5b8c\u6210\u540e\uff0c\u9700\u518d\u6b21\u6267\u884cVivado\u5b89\u88c5\u7a0b\u5e8f\uff0c\u91cd\u505a1~9\u6b65\u3002</p> <p>\u63a5\u4e0b\u6765\u768411\\~13\u6b65\u4e0e\u4e0a\u6587\u65b9\u6848\u4e00\u4e2dWindows\u5e73\u53f0\u5b89\u88c5\u768411\\~13\u6b65\u76f8\u540c\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter6_riscv_on_pynq/#612-fpga-pynq","title":"6.1.2 fpga-pynq\u5de5\u7a0b\u6e90\u7801\u83b7\u53d6","text":"<p>\u4e3a\u4e86\u65b9\u4fbf\u5927\u5bb6\u5feb\u901f\u83b7\u53d6\u6e90\u7801\uff0c\u5df2\u5c06\u5168\u90e8\u6e90\u7801\uff08\u5305\u62ec\u5b50\u6a21\u5757\uff09\u6253\u5305\u4e0a\u4f20\u5230\u767e\u5ea6\u7f51\u76d8\uff0c\u53ef\u4ee5\u76f4\u63a5\u4e0b\u8f7d\u3002</p> <pre><code>\u94fe\u63a5\uff1ahttps://pan.baidu.com/s/1mTCcKG0EiFdxq4C5HTey3w \n\u63d0\u53d6\u7801\uff1a1234 \n</code></pre> <p>\u4e0b\u8f7d\u5b8c\u6210\u540e\uff0c\u5728\u547d\u4ee4\u884c\u4e2d\u6267\u884c\u5982\u4e0b\u547d\u4ee4\uff0c\u5c06\u6e90\u7801\u8fdb\u884c\u89e3\u538b\u3002</p> <pre><code>$ cd \u4f60\u7684\u6e90\u7801\u4e0b\u8f7d\u76ee\u5f55\n$ cat fpga-pynq.0* &gt; fpga-pynq.tar.gz     #\u7ec4\u88c5\u6587\u4ef6\n$ md5sum  fpga-pynq.tar.gz &gt; md5   #\u8ba1\u7b97MD5\u6821\u9a8c\u7801\n$ cmp md5 md5sum    #\u6bd4\u5bf9\u6821\u9a8c\u7801\uff0c\u5982\u679c\u6b64\u5904\u6ca1\u6709\u4efb\u4f55\u8f93\u51fa\uff0c\u5219\u4e3a\u6b63\u786e\n$ tar -zxvf fpga-pynq.tar.gz    #\u89e3\u538b\u6587\u4ef6\n</code></pre> <p>\u6216\u8005\u4ecegithub\u83b7\u53d6\u6e90\u7801\uff1a</p> <pre><code>$ git clone https://github.com/huozf123/fpga-pynq.git\n$ cd fpga-pynq\n$ git submodule update --init --recursive\n</code></pre> <p>Windows\u7528\u6237\u6ce8\u610f\uff1a\u9009\u62e9\u5728WSL\u4e2d\u5b8c\u6210\u5b9e\u9a8c\u7684\u8bfb\u8005\u5728\u5b8c\u6210\u4e0a\u8ff0\u6b65\u9aa4\u540e\uff0c\u8fd8\u9700\u8981\u989d\u5916\u6ce8\u91ca\u6389Makefrag\u6587\u4ef6\u7684\u7b2c108\u884c\uff0c\u5728\u7ec8\u7aef\u4e2d\u7ee7\u7eed\u8f93\u5165\u4ee5\u4e0b\u547d\u4ee4\uff1a</p> <pre><code>$ cd fpga-pynq\n$ sed -i \"108s/^/#/\" common/Makefrag\n</code></pre> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter6_riscv_on_pynq/#613","title":"6.1.3 \u5de5\u7a0b\u7f16\u8bd1\u73af\u5883\u914d\u7f6e","text":"<p>\u6ce8\u610f\uff0c\u8be5\u6b65\u9aa4\u4e2dLinux\uff08ubuntu\u684c\u9762\u73af\u5883\uff09\u4e0eWindows\uff08WSL\u73af\u5883\uff09\u4e0b\u7684\u64cd\u4f5c\u5b58\u5728\u4e00\u4e9b\u5dee\u5f02\uff0c\u8bfb\u8005\u5e94\u6309\u7167\u81ea\u5df1\u6240\u7528\u5e73\u53f0\u9009\u62e9\u6b63\u786e\u7684\u6b65\u9aa4\u6267\u884c\u3002</p> <p>Linux\uff08ubuntu\u684c\u9762\u73af\u5883\uff09\uff1a</p> <ol> <li>\u5b89\u88c5java jdk\uff0c\u9996\u5148\u68c0\u67e5\u7535\u8111\u4e2d\u662f\u5426\u5df2\u5b89\u88c5java\uff0c\u5728\u4e2d\u7aef\u8f93\u5165\u4ee5\u4e0b\u547d\u4ee4\uff1a</li> </ol> <pre><code>java -version\n</code></pre> <ol> <li>\u82e5\u80fd\u663e\u793ajava\u7248\u672c\u53f7\u5219\u8868\u660e\u5df2\u5b89\u88c5java\uff0c\u53ef\u4ee5\u8df3\u8fc7java\u7684\u5b89\u88c5\u3002\u5426\u5219\uff0c\u7ee7\u7eed\u5728\u7ec8\u7aef\u6267\u884c\u5982\u4e0b\u547d\u4ee4\u5b89\u88c5java 1.8\uff1a</li> </ol> <pre><code>sudo apt install openjdk-8-jre-headless\n</code></pre> <ol> <li>\u6dfb\u52a0Vivado\u76f8\u5173\u7684\u73af\u5883\u53d8\u91cf\uff0c\u5728\u547d\u4ee4\u884c\u4e2d\u6267\u884c\uff08\u66ff\u6362\u6389\u201c\u4f60\u7684vivado\u5b89\u88c5\u76ee\u5f55\u201d\uff09\uff1a</li> </ol> <pre><code>$ source \u4f60\u7684vivado\u5b89\u88c5\u76ee\u5f55/Vivado/2016.2/settings64.sh\n$ source \u4f60\u7684vivado\u5b89\u88c5\u76ee\u5f55/SDK/2016.2/settings64.sh \n</code></pre> <p>\u5efa\u8bae\u76f4\u63a5\u5c06\u4e0a\u8ff0\u4e24\u884c\u547d\u4ee4\u6dfb\u52a0\u5230~/.bashrc\u6587\u4ef6\u7684\u672b\u7aef\uff0c\u907f\u514d\u6bcf\u6b21\u91cd\u65b0\u6253\u5f00\u7ec8\u7aef\u90fd\u9700\u8981\u91cd\u65b0\u6267\u884c\u3002</p> <ol> <li>\u56e0\u4e3aVivado\u3001SDK\u5b58\u5728bug\uff0c\u6240\u4ee5\u9700\u8981\u7ee7\u7eed\u5728\u547d\u4ee4\u884c\u4e2d\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\uff08\u66ff\u6362\u201c\u4f60\u7684vivado\u5b89\u88c5\u76ee\u5f55\u201d\uff09\uff1a</li> </ol> <pre><code>$ sudo apt-get install libgoogle-perftools-dev\n$ export SWT_GTK3=0\n$ sudo sed -i \"11,15s/^/#/\" \u4f60\u7684vivado\u5b89\u88c5\u76ee\u5f55/Vivado/2016.2/.settings64-Vivado.sh    #\u6ce8\u91ca\u8be5\u6587\u4ef6\u7b2c11-15\u884c\n</code></pre> <ol> <li>\u6700\u540e\u521d\u59cb\u5316\u5b50\u6a21\u5757\uff08\u82e5\u4ece\u7f51\u76d8\u4e2d\u4e0b\u8f7d\u6e90\u7801\uff0c\u5219\u6b64\u6b65\u65e0\u9700\u6267\u884c\uff09\uff0c\u6267\u884c\uff1a <pre><code>    $ cd $REPO/pynq-z2/\n    $ make init-submodules\n</code></pre></li> </ol> <p>Windows\uff08WSL\u73af\u5883\uff09\uff1a</p> <p>\u6309\u7167\u4e0a\u6587\u4e2d\u7b2c1\u30012\u6b65\u8bf4\u660e\u5728WSL\u4e2d\u5b89\u88c5java 1.8\uff0c\u7b2c3\u30014\u6b65\u5728Windows\u4e2d\u65e0\u9700\u6267\u884c\u3002\u6700\u540e\u5728WSL\u4e2d\u6309\u7b2c5\u6b65\u521d\u59cb\u5316\u5b50\u6a21\u5757\uff08\u82e5\u4ece\u7f51\u76d8\u4e2d\u4e0b\u8f7d\u6e90\u7801\u540c\u6837\u65e0\u9700\u6267\u884c\uff09\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter6_riscv_on_pynq/#614","title":"6.1.4 \u84dd\u7259\u5c0f\u8f66\u786c\u4ef6\u7ec4\u88c5","text":"<p>\u7ec4\u88c5\u84dd\u7259\u5c0f\u8f66\u9700\u8981\u7684\u6750\u6599\u6e05\u5355\uff1a</p> <p>pynq-z1\u5f00\u53d1\u677f\u3001sd\u5361\u3001\u84dd\u7259\u6a21\u5757\u3001\u5c0f\u8f66\u76f8\u5173\u786c\u4ef6\uff08\u7535\u673a\u3001\u7535\u673a\u9a71\u52a8\u677f\u3001\u5e95\u76d8\u3001\u914d\u5957\u603b\u7ebf\uff09\u3001ttl\u8f6c\u603b\u7ebf\u6a21\u5757\u3001\u4ee5\u592a\u7f51\u7f51\u7ebf\u30017.4v\u7535\u6c60\u3001\u7535\u6c60\u914d\u5957\u7535\u6e90\u7ebf\u3001\u79fb\u52a8\u7535\u6e90\u3001usb\u4f9b\u7535\u7ebf\u3002</p> <p>\u84dd\u7259\u5c0f\u8f66\u7ec4\u88c5\u6b65\u9aa4\uff1a</p> <p>1\uff09\u7ec4\u88c5\u5c0f\u8f66</p> <p>\u9996\u5148\u5b8c\u6210\u5c0f\u8f66\u5e95\u76d8\u7ec4\u88c5\uff08\u82e5\u91c7\u7528\u5df2\u9884\u5148\u7ec4\u88c5\u5e76\u8fde\u7ebf\u7684\u5c0f\u8f66\u8fdb\u884c\u5b9e\u9a8c\uff0c\u5219\u5728\u8be5\u6b65\u9aa4\u4e2d\u53ea\u9700\u5c06\u5269\u4e0b\u7684\u56db\u4e2a\u8f66\u8f6e\u88c5\u4e0a\u540e\uff0c\u5373\u53ef\u8fdb\u884c\u7b2c\u4e8c\u6b65\uff09\u3002\u5148\u5c06\u5c0f\u8f66\u4e24\u4e2a\u524d\u8f6e\u4e0a\u7684\u7535\u673a\u9a71\u52a8\u677f\u7528\u4e00\u6839\u603b\u7ebf\u8fde\u63a5\uff08\u6bcf\u4e2a\u7535\u673a\u9a71\u52a8\u677f\u4e0a\u6709\u4e24\u4e2a\u603b\u7ebf\u63a5\u53e3\uff0c\u529f\u80fd\u5b8c\u5168\u76f8\u540c\uff0c\u4e24\u4e2a\u7535\u673a\u5404\u81ea\u4efb\u9009\u4e00\u4e2a\u603b\u7ebf\u63a5\u53e3\u7528\u5bfc\u7ebf\u8fde\u63a5\u5373\u53ef\uff09\uff0c\u53e6\u5916\u518d\u51c6\u5907\u4e00\u6839\u603b\u7ebf\uff0c\u4e00\u7aef\u63d2\u5165\u4e24\u4e2a\u7535\u673a\u4e2d\u4efb\u4e00\u4e2a\u7684\u4f59\u4e0b\u603b\u7ebf\u63a5\u53e3\uff0c\u53e6\u4e00\u7aef\u4ece\u5c0f\u8f66\u5e95\u76d8\u4e0a\u65b9\u5f15\u51fa\u5907\u7528\u3002\u518d\u5c06\u4e24\u4e2a\u540e\u8f6e\u4e5f\u6309\u76f8\u540c\u65b9\u5f0f\u8fde\u63a5\uff0c\u5f15\u51fa\u53e6\u4e00\u6839\u603b\u7ebf\u3002\u5c0f\u8f66\u5e95\u76d8\u5168\u90e8\u7ec4\u88c5\u5b8c\u6210\u540e\uff0c\u4e0a\u65b9\u5e94\u8be5\u6709\u4e24\u6839\u5f15\u51fa\u7684\u603b\u7ebf\u5f85\u8fde\u63a5\uff08\u4e00\u6839\u8fde\u63a5\u4e24\u4e2a\u524d\u8f6e\uff0c\u53e6\u4e00\u6839\u8fde\u63a5\u4e24\u4e2a\u540e\u8f6e\uff09\u3002\u5982\u4e0b\u56fe\u6240\u793a\uff1a</p> <p></p> <p>2\uff09\u5c06\u84dd\u7259\u6a21\u5757\u8fde\u63a5\u5230PMODA\u63a5\u53e3</p> <p>\u5c06\u84dd\u7259\u6a21\u5757\u7684VCC\u3001GND\u3001TXD\u548cRXD\u7ba1\u811a\u8fde\u63a5\u5230pynq-z1\u7684PMODA\u63a5\u53e3\uff0c\u5206\u522b\u5bf9\u5e94PMODA\u4e0a\u9762\u4e00\u6392\u4ece\u5de6\u5f80\u53f3\u7b2c1\u30012\u30013\u548c4\u4e2a\u7ba1\u811a\u3002\u5982\u4e0b\u56fe\u6240\u793a\uff1a</p> <p></p> <p>3\uff09ttl\u8f6c\u603b\u7ebf\u6a21\u5757\u8fde\u63a5</p> <p>\u5c06\u4ece\u5c0f\u8f66\u5e95\u76d8\u4e0a\u5f15\u51fa\u7684\u4e24\u6839\u603b\u7ebf\u63d2\u5165\u5230ttl\u8f6c\u603b\u7ebf\u6a21\u5757\u4e0a\u7684\u4e24\u4e2a\u603b\u7ebf\u63a5\u53e3\uff08\u4e24\u4e2a\u63a5\u53e3\u4e0d\u5fc5\u8fdb\u884c\u533a\u5206\uff09\u3002\u7136\u540e\u7528\u8df3\u7ebf\u5e3d\u5c06\u8be5\u6a21\u5757\u4e0a\u7684ttl-zx\u9488\u811a\u8fdb\u884c\u77ed\u63a5\uff0c\u4ee5\u4fbf\u8ba9\u6a21\u5757\u5de5\u4f5c\u5728ttl\u8f6c\u603b\u7ebf\u6a21\u5f0f\u3002\u4e4b\u540e\u53d6\u51fa\u4e0e\u7535\u6c60\u914d\u5957\u7684\u7535\u6e90\u7ebf\uff0c\u63a5\u5230ttl\u8f6c\u603b\u7ebf\u6a21\u5757\u7684\u7535\u6e90\u8f93\u5165\u4e0a\uff08\u6ce8\u610f\u67e5\u770b\u7535\u8def\u677f\u80cc\u9762\u7684\u6b63\u8d1f\u6781\u6807\u5fd7\uff0c\u7ea2\u8272\u5bfc\u7ebf\u63a5\u6b63\u6781\uff0c\u9ed1\u8272\u5bfc\u7ebf\u63a5\u8d1f\u6781\uff09\u3002\u518d\u5c06\u7535\u6e90\u7ebf\u4e0a\u7684\u7535\u6c60\u63d2\u5934\u4e0e\u7535\u6c60\u8fde\u63a5\u3002</p> <p>\u53d6\u4e09\u6839\u516c\u5bf9\u6bcd\u675c\u90a6\u7ebf\uff08\u4e0b\u9762\u4e3a\u4e86\u53d9\u8ff0\u65b9\u4fbf\uff0c\u5c06\u8fd9\u4e09\u6839\u675c\u90a6\u7ebf\u5206\u522b\u547d\u540d\u4e3a\u7ebf1\u3001\u7ebf2\u548c\u7ebf3\uff0c\u8bfb\u8005\u53ef\u901a\u8fc7\u675c\u90a6\u7ebf\u989c\u8272\u8fdb\u884c\u533a\u5206\uff09\uff0c\u5c06\u7ebf1\u3001\u7ebf2\u548c\u7ebf3\u7684\u6bcd\u5934\u5206\u522b\u8fde\u63a5\u5230ttl\u8f6c\u603b\u7ebf\u6a21\u5757\u4e0a\u7684RXD\u3001TXD\u4e0eGND\uff08\u6ce8\u610f\uff0cttl\u8f6c\u603b\u7ebf\u6a21\u5757\u4e0a\u6709\u4e24\u6392\u9ec4\u8272\u7684ttl\u63a5\u53e3\uff0c\u4e00\u6392\u4e3a\u516c\u5934\uff0c\u4e00\u6392\u4e3a\u6bcd\u5934\uff0c\u8fd9\u91cc\u8bf4\u7684\u8fd9\u4e09\u4e2a\u63a5\u53e3\u662f\u6307\u4e0b\u9762\u4e00\u6392\u7684\u516c\u5934\uff09\u3002ttl\u8f6c\u603b\u7ebf\u6a21\u5757\u8fde\u63a5\u597d\u540e\u7684\u90e8\u5206\u8fde\u63a5\u5982\u4e0b\u56fe\u6240\u793a\uff1a</p> <p></p> <p>\u518d\u5c06\u7ebf1\u3001\u7ebf2\u548c\u7ebf3\u7684\u516c\u5934\u8fde\u63a5\u5230pynq-z1\u7684PMODB\u63a5\u53e3\uff0c\u5206\u522b\u5bf9\u5e94PMODB\u4e0a\u9762\u4e00\u6392\u4ece\u53f3\u5f80\u5de6\u7b2c3\u30014\u30015\u4e2a\u7ba1\u811a\u3002</p> <p></p> <p>\u6ce8\u610f\uff0c\u5728\u8fde\u7ebf\u8fc7\u7a0b\u4e2d\uff0c\u4e09\u6839\u675c\u90a6\u7ebf\u6ca1\u6709\u53d1\u751f\u4ea4\u53c9\uff0c\u59cb\u7ec8\u662f\u6309\u7167\u7ebf123\u6216\u7ebf321\u7684\u987a\u5e8f\u63d2\u5165\u5230\u63a5\u53e3\u4e2d\u7684\u3002\u56e0\u6b64\uff0c\u5728\u8fde\u63a5\u5b8c\u6210\u540e\u8bfb\u8005\u53ef\u4ee5\u901a\u8fc7\u68c0\u67e5\u7ebf3\u7684\u4e24\u7aef\u662f\u5426\u8fde\u63a5\u7684\u90fd\u662fGND\uff08\u4e00\u7aef\u4e3attl\u8f6c\u603b\u7ebf\u4e0a\u7684GND\uff0c\u53e6\u4e00\u7aef\u4e3apynq-z1\u4e0a\u7684GND\uff09\u6765\u5224\u65ad\u63a5\u7ebf\u662f\u5426\u6b63\u786e\u3002\u8fde\u63a5\u5b8c\u6210\u540e\u5982\u4e0b\u56fe\uff1a</p> <p></p> <p>4\uff09\u4e3apynq-z1\u4f9b\u7535</p> <p>\u9996\u5148\u5e94\u786e\u4fddpynq-z1\u5f00\u53d1\u677f\u5904\u4e8e\u4eceUSB\u4f9b\u7535\u7684\u72b6\u6001\uff0c\u8fd9\u9700\u8981\u8bfb\u8005\u4f7f\u7528\u8df3\u7ebf\u5e3d\u5c06\u7535\u8def\u677f\u5de6\u4e0b\u89d2\u5370\u6709USB\u6807\u5fd7\u7684\u4e24\u4e2a\u9488\u811a\u77ed\u63a5\u3002\u7136\u540e\u5c06USB\u4f9b\u7535\u7ebf\u4e00\u7aef\u63a5\u5165\u5f00\u53d1\u677f\u5de6\u4fa7\u7684micro USB\u63a5\u53e3\uff0c\u53e6\u4e00\u7aef\u63a5\u5165\u79fb\u52a8\u7535\u6e90\uff085V 1A\uff09\u3002\u5982\u4e0b\u56fe\u6240\u793a\uff1a</p> <p></p> <p>5\uff09\u5c06pynq-z1\u5f00\u53d1\u677f\u3001ttl\u8f6c\u603b\u7ebf\u6a21\u5757\u3001\u7535\u673a\u7535\u6c60\u4ee5\u53ca\u5f00\u53d1\u677f\u4f9b\u7535\u7535\u6e90\u56fa\u5b9a\u5728\u5c0f\u8f66\u5e95\u76d8\u4e0a</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter6_riscv_on_pynq/#615","title":"6.1.5 \u64cd\u4f5c\u7cfb\u7edf\u7684\u66ff\u6362\u4fee\u6539","text":"<p>\u6ce8\u610f\uff0c\u4e0b\u6587\u4e2d\u6d89\u53ca\u5230\u7684\u6307\u4ee4\u8f83\u591a\uff0c\u4e14\u9700\u8981\u5728\u4e0d\u540c\u7684\u5730\u65b9\u8fdb\u884c\u8f93\u5165\u3002\u603b\u7684\u6765\u8bf4\uff0c\u9700\u8981\u8f93\u5165\u547d\u4ee4\u7684\u5730\u65b9\u5927\u81f4\u6709\u4e09\u5904\uff1a\u672c\u5730\u7ec8\u7aef\u3001ssh\u4f1a\u8bdd\u3001sftp\u4f1a\u8bdd\u3002\u8bfb\u8005\u5728\u64cd\u4f5c\u8fc7\u7a0b\u4e2d\uff0c\u52a1\u5fc5\u8981\u7559\u610f\u6587\u4e2d\u7c7b\u4f3c\u4e8e\uff1a \u201c\u5728\u7ec8\u7aef\u8f93\u5165\u201d\uff08\u6307\u672c\u5730\u8ba1\u7b97\u673a\u7684\u7ec8\u7aef\uff09\u3001\u201c\u5728ssh\u4f1a\u8bdd\u4e2d\u8f93\u5165\u201d\u3001\u5728\u201csftp\u4f1a\u8bdd\u4e2d\u8f93\u5165\u201d\u8fd9\u6837\u7684\u63d0\u793a\u3002\u53e6\u5916\uff0c\u9700\u8981\u5728\u8fd9\u4e09\u5904\u8f93\u5165\u7684\u547d\u4ee4\u53ef\u80fd\u65e0\u6cd5\u907f\u514d\u7684\u4ea4\u66ff\u51fa\u73b0\uff0c\u56e0\u6b64\u5efa\u8bae\u8bfb\u8005\u5404\u6253\u5f00\u4e00\u4e2a\u7a97\u53e3\uff0c\u5206\u522b\u7528\u6765\u521b\u5efassh\u8fde\u63a5\u4e0esftp\u8fde\u63a5\uff08\u521b\u5efa\u65b9\u5f0f\u5728\u4e0b\u6587\u9700\u8981\u7528\u5230\u7684ssh\u4e0esftp\u7684\u5730\u65b9\u6709\u8bf4\u660e\uff0c\u8bfb\u8005\u53ef\u4ee5\u5728\u9047\u5230\u540e\u518d\u8fdb\u884c\u521b\u5efa\uff09\uff0c\u5e76\u5728\u5b9e\u9a8c\u5b8c\u6210\u524d\u4e0d\u8981\u5173\u95ed\uff0c\u8fd9\u6837\u53ef\u4ee5\u907f\u514d\u53cd\u590d\u7684\u8fdb\u884cssh\u3001sftp\u8fde\u63a5\u3002\u82e5\u7531\u4e8e\u91cd\u542f\u5f00\u53d1\u677f\u6216\u8005\u5176\u4ed6\u539f\u56e0\u5bfc\u81f4\u8fde\u63a5\u65ad\u5f00\uff0c\u5219\u6309\u7167\u76f8\u5173\u521b\u5efa\u6b65\u9aa4\u7684\u8bf4\u660e\u91cd\u65b0\u521b\u5efa\u8fde\u63a5\u5373\u53ef\u3002</p> <p>1\uff09\u4e0b\u8f7dPYNQ v2.6\u542f\u52a8\u955c\u50cf\uff08Boot Image\uff09\uff0c\u7136\u540e\u89e3\u538b\u5f97\u5230.img\u955c\u50cf\u6587\u4ef6\u3002</p> <p>2\uff09\u628a\u542f\u52a8\u955c\u50cf\u5199\u5230sd\u5361\u4e2d\uff08\u6b64\u6b65Linux\uff08ubuntu\u684c\u9762\u73af\u5883\uff09\u4e0eWindows\uff08WSL\u73af\u5883\uff09\u4e0b\u64cd\u4f5c\u4e0d\u540c\uff09</p> <p>Linux\uff08ubuntu\u684c\u9762\u73af\u5883\uff09\uff1a</p> <ul> <li> <p>\u5c06sd\u5361\u63d2\u5165\u8bfb\u5361\u5668\uff0c\u8fde\u4e0a\u7535\u8111\u3002</p> </li> <li> <p>\u6253\u5f00\u7ec8\u7aef\uff0c\u8f93\u5165lsblk\u547d\u4ee4\uff0c\u627e\u5230\u521a\u521a\u63d2\u5165\u7684sd\u5361\u8bbe\u5907\uff08\u53ef\u901a\u8fc7\u8f93\u51fa\u7684\u8bbe\u5907\u6240\u5bf9\u5e94\u7684\u5bb9\u91cf\u5224\u65ad\uff09\uff0c\u8bb0\u4e0b\u8be5\u8bbe\u5907\u7684\u540d\u79f0\uff08\u901a\u5e38\u4e3asd*\uff09\u3002</p> </li> </ul> <p></p> <ul> <li>\u7ee7\u7eed\u5728\u7ec8\u7aef\u4e2d\u8f93\u5165\u5982\u4e0b\u547d\u4ee4\u8fdb\u884c\u5199\u5165\uff0c\u5c06\u955c\u50cf\u6587\u4ef6\u8def\u5f84\u66ff\u6362\u4e3a\u7b2c1\uff09\u6b65\u4e2d\u89e3\u538b\u5f97\u5230\u7684.img\u955c\u50cf\u6587\u4ef6\u6240\u5728\u8def\u5f84\uff0c\u5c06\u8bbe\u5907\u540d\u79f0\u66ff\u6362\u4e3a\u4e0a\u4e00\u6b65\u4e2d\u8bb0\u5f55\u4e0b\u7684\u8bbe\u5907\u540d\u79f0\uff08\u8be5\u547d\u4ee4\u5177\u6709\u4e00\u5b9a\u98ce\u9669\uff0c\u4f1a\u6e05\u7a7a\u6307\u5b9a\u8bbe\u5907\u4e0a\u539f\u6709\u7684\u6240\u6709\u6587\u4ef6\uff08\u4e0d\u53ef\u9006\uff09\uff0c\u8f93\u5165\u8be5\u547d\u4ee4\u65f6\u52a1\u5fc5\u4ed4\u7ec6\u68c0\u67e5\uff0c\u6b63\u786e\u7684\u540d\u79f0\u4e00\u822c\u4e3asdb\u6216sdc\u7b49\uff0c\u540e\u9762\u4e0d\u5e26\u6570\u5b57\uff0c\u4e14\u5bb9\u91cf\u4e0e\u63d2\u5165\u7684sd\u5361\u8bbe\u5907\u76f8\u540c\uff09\uff1a</li> </ul> <pre><code>sudo dd bs=4M if=\u955c\u50cf\u6587\u4ef6\u8def\u5f84 of=/dev/\u8bbe\u5907\u540d\u79f0\n</code></pre> <p>\u200b       \u8be5\u547d\u4ee4\u6267\u884c\u8017\u65f6\u8f83\u957f\uff0c\u4e14\u5728\u6267\u884c\u5b8c\u6210\u524d\u4e0d\u4f1a\u6709\u4efb\u4f55\u8f93\u51fa\uff0c\u8bf7\u8bfb\u8005\u8010\u5fc3\u7b49\u5f85\u3002</p> <ul> <li>\u62d4\u51fasd\u5361\u3002</li> </ul> <p>Windows\uff08WSL\u73af\u5883\uff09\uff1a</p> <ul> <li> <p>\u5728\u8fd9\u91cc\u4e0b\u8f7dWin32 Disk Imager\u8f6f\u4ef6\u5e76\u5b89\u88c5\u3002</p> </li> <li> <p>\u5c06sd\u5361\u63d2\u5165\u8bfb\u5361\u5668\uff0c\u8fde\u4e0a\u7535\u8111\u3002</p> </li> <li> <p>\u6253\u5f00Win32 Disk Imager\uff0c\u5728\u6620\u50cf\u6587\u4ef6\u5904\u9009\u62e9\u89e3\u538b\u5f97\u5230\u7684img\u6587\u4ef6\uff0c\u7136\u540e\u5728\u8bbe\u5907\u9009\u62e9\u5904\u9009\u62e9\u63d2\u5165\u7684sd\u5361\uff0c\u6700\u540e\u70b9\u51fb\u5199\u5165\u6309\u94ae\u3002</p> </li> </ul> <p></p> <ul> <li>\u62d4\u51fasd\u5361\u3002</li> </ul> <p>3\uff09\u5c06sd\u5361\u63d2\u5165\u5230pynq-z1\u5f00\u53d1\u677f\u4e2d\uff0c\u68c0\u67e5pynq-z1\u5de6\u4e0a\u89d2\u7684\u8df3\u7ebf\u5e3d\u662f\u5426\u77ed\u63a5\u4e86\u9760\u4e0a\u9762\u7684\u4e24\u4e2a\u9488\u811a\uff0c\u8fd9\u6837\u505a\u662f\u4e3a\u4e86\u786e\u4fddpynq-z1\u5904\u4e8e\u4ecesd\u5361\u542f\u52a8\u7684\u72b6\u6001\u3002\u5982\u4e0b\u56fe\u6240\u793a\uff1a</p> <p></p> <p>\u6253\u5f00\u7535\u6e90\uff08\u5de6\u4e0b\u65b9\u7684\u5f00\u5173\uff09\uff0c\u7b49\u5f85\u7cfb\u7edf\u542f\u52a8\u3002\u7cfb\u7edf\u542f\u52a8\u8017\u65f6\u8f83\u957f\uff0c\u542f\u52a8\u5b8c\u6210\u540e\uff0c\u5f00\u53d1\u677f\u4e0b\u65b9\u7684\u56db\u4e2a\u84dd\u8272led\u706f\u4f1a\u5728\u6570\u6b21\u95ea\u70c1\u540e\u4fdd\u6301\u957f\u4eae\uff0c\u6b64\u65f6\u8868\u660e\u7cfb\u7edf\u5df2\u7ecf\u542f\u52a8\u5b8c\u6210\u3002\u7528\u7f51\u7ebf\u8fde\u63a5\u7535\u8111\u548c\u5f00\u53d1\u677f\uff08\u5f00\u53d1\u677f\u4e0a\u7684\u7f51\u53e3\u5728\u5de6\u4fa7\uff09\u3002</p> <p>\u6ce8\u610f\uff1a\u82e5\u9047\u5230\u4ee5\u4e0b\u60c5\u51b5\uff1a\u5f00\u53d1\u677f\u7535\u6e90\u5f00\u5173\u65c1\u8fb9\u7684\u7ea2\u706f\u95ea\u70c1\u6216\u7184\u706d\uff1b\u5f00\u53d1\u677f\u65e0\u6cd5\u6b63\u5e38\u542f\u52a8\uff1b\u5f00\u53d1\u677f\u542f\u52a8\u540e\u968f\u673a\u53d1\u751f\u81ea\u52a8\u91cd\u542f\uff08\u8868\u73b0\u4e3assh\u4f1a\u8bdd\u65ad\u5f00\u6216\u5361\u6b7b\uff09\uff0c\u5219\u5e94\u8be5\u68c0\u67e5\uff1a</p> <ul> <li> <p>USB\u7535\u6e90\u8f93\u5165\u662f\u5426\u6b63\u5e38</p> </li> <li> <p>\u7535\u6e90\u5f00\u5173\u65c1\u7684\u8df3\u7ebf\u5e3d\u662f\u5426\u8fde\u63a5\u4e86USB\u6807\u5fd7\u5bf9\u5e94\u7684\u4e24\u4e2a\u9488\u811a</p> </li> <li> <p>\u7535\u6e90\u5f00\u5173\u65c1\u7684\u8df3\u7ebf\u5e3d\u662f\u5426\u677e\u52a8</p> </li> </ul> <p>4\uff09\u4fee\u6539\u7f51\u5361IP\u5730\u5740\uff08\u6b64\u6b65Linux\uff08ubuntu\u684c\u9762\u73af\u5883\uff09\u4e0eWindows\uff08WSL\u73af\u5883\uff09\u4e0b\u64cd\u4f5c\u4e0d\u540c\uff09</p> <p>Linux\uff08ubuntu\u684c\u9762\u73af\u5883\uff09\uff1a</p> <p>\u6253\u5f00\u7535\u8111\u7ec8\u7aef\uff0c\u6267\u884c\u5982\u4e0b\u547d\u4ee4\uff0c\u9700\u8981\u5c06\u6709\u7ebf\u7f51\u5361\u540d\u79f0\u66ff\u6362\u4e3a\u7535\u8111\u4e0a\u5b9e\u9645\u7684\u6709\u7ebf\u7f51\u5361\u540d\u79f0\uff0c\u53ef\u4ee5\u901a\u8fc7\u6267\u884cifconfig\u547d\u4ee4\u67e5\u770b\uff08\u901a\u5e38\u4e3aeth0\u3001enp7s0\u7b49\uff09\u3002\u8be5\u547d\u4ee4\u5c06\u7535\u8111\u6709\u7ebf\u7f51\u5361ip\u5730\u5740\u8bbe\u7f6e\u4e3a192.168.2.13\u3002\u6ce8\u610f\uff1a\u82e5\u5728\u6240\u4f7f\u7528\u7535\u8111\u7684\u6709\u7ebf\u7f51\u5361\u4e2d\u914d\u7f6e\u4e86\u81ea\u52a8\u8fde\u63a5\u7684PPPOE\u534f\u8bae\u7b49\uff0c\u624b\u52a8\u6307\u5b9a\u7684ip\u5730\u5740\u53ef\u80fd\u4f1a\u5728\u4e00\u6bb5\u65f6\u95f4\u540e\u5c31\u88ab\u81ea\u52a8\u8986\u76d6\u5bfc\u81f4\u5b9e\u9a8c\u5931\u8d25\uff0c\u8bfb\u8005\u5e94\u6839\u636e\u81ea\u5df1\u7535\u8111\u7684\u5177\u4f53\u60c5\u51b5\uff0c\u6682\u65f6\u5173\u95ed\u76f8\u5173\u8bbe\u7f6e\u3002</p> <pre><code>sudo ifconfig \u6709\u7ebf\u7f51\u5361\u540d\u79f0 192.168.2.13\n</code></pre> <p>Windows\uff08WSL\u73af\u5883\uff09\uff1a</p> <p>\u70b9\u51fb\u5de6\u4e0b\u89d2Windows\u56fe\u6807\uff0c\u8f93\u5165\u201c\u63a7\u5236\u9762\u677f\u201d\uff0c\u8fd9\u65f6\u4f1a\u770b\u5230\u63a7\u5236\u9762\u677f\uff0c\u70b9\u51fb\u6253\u5f00\u63a7\u5236\u9762\u677f\u3002\u7136\u540e\u4f9d\u6b21\u70b9\u51fb\uff1a\u7f51\u7edc\u548cInternet\u3001\u7f51\u7edc\u548c\u5171\u4eab\u4e2d\u5fc3\u3001\u66f4\u6539\u9002\u914d\u5668\u8bbe\u7f6e\uff08\u5728\u7a97\u53e3\u5de6\u4fa7\uff09\uff0c\u627e\u5230\u4ee5\u592a\u7f51\uff0c\u53f3\u952e\u5355\u51fb\uff0c\u70b9\u51fb\u201c\u5c5e\u6027\u201d\uff0c\u6253\u5f00\u4ee5\u592a\u7f51\u5c5e\u6027\u8bbe\u7f6e\u7a97\u53e3\u3002</p> <p></p> <p>\u627e\u5230Internet\u534f\u8bae\u7248\u672c4\uff08TCP/IPv4\uff09\uff0c\u53cc\u51fb\u6253\u5f00\u3002\u9009\u62e9\u201c\u4f7f\u7528\u4e0b\u9762\u7684IP\u5730\u5740\u201d\uff0c\u5e76\u5c06IP\u5730\u5740\u6539\u4e3a192.168.2.13\uff0c\u5b50\u7f51\u63a9\u7801\u6539\u4e3a255.255.255.0\uff0c\u6700\u540e\u70b9\u51fb\u786e\u5b9a\u4fdd\u5b58\u3002</p> <p></p> <p>5\uff09\u4e0b\u8f7dlibfesvr.so\uff08frontend server\u8fd0\u884c\u9700\u8981\u7684\u52a8\u6001\u94fe\u63a5\u5e93\uff09\u3001riscv-fesvr\uff08frontend server\uff09\u3002</p> <p>6\uff09\u521b\u5efa\u4e00\u4e2a\u70e7\u5199bitstream\u7684shell\u811a\u672c</p> <p>\u7531\u4e8e\u70e7\u5199bitstream\u7684\u64cd\u4f5c\u5728\u4e4b\u540e\u7684\u5b9e\u9a8c\u4e2d\u4f1a\u591a\u6b21\u8fdb\u884c\uff0c\u8bfb\u8005\u6bcf\u6b21\u5728\u5bf9\u786c\u4ef6\u8fdb\u884c\u4fee\u6539\u540e\u90fd\u9700\u8981\u91cd\u65b0\u70e7\u5199bitstream\u5230pynq-z1\u5f00\u53d1\u677f\u4e2d\u624d\u80fd\u751f\u6548\uff0c\u56e0\u6b64\u53ef\u4ee5\u5c06\u70e7\u5199bitstream\u7684\u547d\u4ee4\u4fdd\u5b58\u5728\u4e00\u4e2a\u811a\u672c\u4e2d\uff0c\u4fbf\u4e8e\u540e\u7eed\u4f7f\u7528\u3002\u7528\u6587\u672c\u7f16\u8f91\u5668\u521b\u5efa\u4e00\u4e2a\u6587\u672c\u6587\u4ef6\uff0c\u547d\u540d\u4e3aprogram.sh\uff0c \u8f93\u5165\u5982\u4e0b\u5185\u5bb9\u540e\u4fdd\u5b58\uff1a</p> <p>\u6ce8\u610f\uff0c\u82e5\u8bfb\u8005\u5728Windows\u5e73\u53f0\u8fdb\u884c\u5b9e\u9a8c\uff0c\u5343\u4e07\u4e0d\u8981\u7528\u7cfb\u7edf\u81ea\u5e26\u7684\u8bb0\u4e8b\u672c\u521b\u5efa\u6b64\u6587\u4ef6\uff01\u56e0\u4e3a\u8bb0\u4e8b\u672c\u4f1a\u9ed8\u8ba4\u5c06\u6587\u4ef6\u4fdd\u5b58\u6210dos\u683c\u5f0f\uff0c\u4f1a\u5bfc\u81f4\u5c06\u811a\u672c\u4f20\u8f93\u5230Linux\u7cfb\u7edf\u4e2d\u6267\u884c\u65f6\u62a5\u9519\u3002Windows\u7528\u6237\u53ef\u4ee5\u9009\u62e9\uff1a1. \u5728WSL\u4e2d\u521b\u5efa\u8be5\u6587\u4ef6\uff1b2. \u4e0d\u8981\u5728Windows\u4e2d\u521b\u5efa\u8be5\u6587\u4ef6\uff0c\u6682\u65f6\u8df3\u8fc7\u8fd9\u4e00\u6b65\uff0c\u5f53\u540e\u6587\u5229\u7528ssh\u534f\u8bae\u8fde\u63a5\u5230\u5f00\u53d1\u677f\u540e\uff0c\u76f4\u63a5\u5728ssh\u4f1a\u8bdd\u4e2d\u542f\u52a8vim\u521b\u5efa\u8be5\u6587\u4ef6\uff1b3. \u82e5\u6267\u610f\u5728Windows\u56fe\u5f62\u754c\u9762\u4e2d\u521b\u5efa\u8be5\u6587\u4ef6\uff0c\u8bf7\u4e0b\u8f7dsublime\u6587\u672c\u7f16\u8f91\u5668\u8fdb\u884c\u521b\u5efa\u3002</p> <p>```</p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter6_riscv_on_pynq/#binsh","title":"! /bin/sh","text":"<p>cp rocketchip_wrapper.bit.bin /lib/firmware/ echo 0 &gt; /sys/class/fpga_manager/fpga0/flags echo rocketchip_wrapper.bit.bin &gt; /sys/class/fpga_manager/fpga0/firmware    ```</p> <p>7\uff09\u5c06\u8fd9\u4e09\u4e2a\u6587\u4ef6\u901a\u8fc7SFTP\u4f20\u8f93\u5230\u5f00\u53d1\u677f\u7684/home/xilinx\u76ee\u5f55\u4e0b\uff0c\u9700\u8981\u5148\u5c06[libfesvr.so\u6240\u5728\u8def\u5f84]\u3001[riscv-fesvr\u6240\u5728\u8def\u5f84]\u4e0e[program.sh\u6240\u5728\u8def\u5f84]\u5206\u522b\u66ff\u6362\u6210\u524d\u4e24\u6b65\u4e2dlibfesvr.so\u3001riscv-fesvr\u4e0eprogram.sh\u6587\u4ef6\u6240\u5728\u7684\u8def\u5f84\u3002\uff08\u6b64\u6b65Linux\uff08ubuntu\u684c\u9762\u73af\u5883\uff09\u4e0eWindows\uff08WSL\u73af\u5883\uff09\u4e0b\u64cd\u4f5c\u4e0d\u540c\uff09</p> <p>Linux\uff08ubuntu\u684c\u9762\u73af\u5883\uff09\uff1a</p> <p>\u521b\u5efasftp\u8fde\u63a5\uff1a</p> <pre><code>sftp xilinx@192.168.2.99\n\uff08\u5bc6\u7801\u8f93\u5165\uff1axilinx\uff09\n</code></pre> <p>\u5728sftp\u4f1a\u8bdd\u4e2d\u8f93\u5165\uff1a</p> <pre><code>put [libfesvr.so\u6240\u5728\u8def\u5f84] /home/xilinx\nput [riscv-fesvr\u6240\u5728\u8def\u5f84] /home/xilinx\nput [program.sh\u6240\u5728\u8def\u5f84] /home/xilinx\n</code></pre> <p>Windows\uff08WSL\u73af\u5883\uff09\uff1a</p> <p>\u5728Windows\u4e0b\u8fdb\u884cfpga\u5b9e\u9a8c\u7684\u8bfb\u8005\uff0c\u65e2\u53ef\u4ee5\u9009\u62e9\u5728WSL\u4e2d\u6267\u884c\u4e0a\u8ff0Linux\u73af\u5883\u4e0b\u7684sftp\u8fde\u63a5\u547d\u4ee4\uff0c\u4ece\u800c\u76f4\u63a5\u5728WSL\u4e2d\u5b8c\u6210\u6587\u4ef6\u7684\u4f20\u8f93\u64cd\u4f5c\uff0c\u4e5f\u53ef\u4ee5\u9009\u62e9\u66f4\u52a0\u65b9\u4fbf\u7684\u5e26\u56fe\u5f62\u754c\u9762\u7684sftp\u5ba2\u6237\u7aef\u7a0b\u5e8f\uff0c\u6765\u5b8c\u6210\u6587\u4ef6\u7684\u4f20\u8f93\u64cd\u4f5c\u3002\u4e0b\u9762\u4ecb\u7ecd\u5982\u4f55\u4f7f\u7528MobaXterm\u8f6f\u4ef6\u6765\u5b8c\u6210\u6587\u4ef6\u4f20\u8f93\u3002\uff08\u6ce8\u610f\uff0c\u540e\u6587\u4e2d\u7684\u5176\u4ed6\u6b65\u9aa4\u4ecd\u7136\u4f1a\u7528\u5230sftp\u8fde\u63a5\uff0c\u4e3a\u907f\u514d\u6587\u7ae0\u7bc7\u5e45\u8fc7\u957f\uff0cWindows\u73af\u5883\u4e0b\u56fe\u5f62\u754c\u9762\u7684\u6587\u4ef6\u4f20\u8f93\u64cd\u4f5c\u53ea\u4f1a\u5728\u6b64\u5904\u4ecb\u7ecd\u4e00\u6b21\uff0c\u8bfb\u8005\u5728\u540e\u7eed\u6b65\u9aa4\u4e2d\u78b0\u5230\u9700\u8981\u4f7f\u7528sftp\u4f20\u8f93\u6587\u4ef6\u7684\u64cd\u4f5c\u65f6\uff0c\u53ef\u4ee5\u53c2\u8003\u6b64\u5904\u7684\u64cd\u4f5c\u65b9\u5f0f\uff09</p> <p>\u4ee5\u4f20\u8f93\u6587\u4ef6libfesvr.so\u4e3a\u4f8b\uff0c\u4e0b\u9762\u662f\u5177\u4f53\u6b65\u9aa4\uff1a</p> <p>\u6253\u5f00MobaXterm\uff0c\u70b9\u51fb\u5de6\u4e0a\u89d2\u7684\u201cSession\u201d\u3002</p> <p></p> <p>\u5728\u5f39\u51fa\u7684\u7a97\u53e3\u4e2d\u9009\u62e9\u201cSFTP\u201c\uff0c\u7136\u540e\u5728Remote host\u540e\u586b\u5165192.168.2.99\uff0c\u5728Username\u540e\u586b\u5165xilinx\uff0c\u6700\u540e\u70b9\u51fbOK\u3002</p> <p></p> <p>\u8f93\u5165\u5bc6\u7801xilinx\u540e\u70b9\u51fbOK\u3002</p> <p></p> <p>\u5728\u56fe\u4e2d\u201c1\u201d\u5904\u5b9a\u4f4d\u5230libfesvr.so\u6240\u5728\u6587\u4ef6\u5939\uff0c\u7136\u540e\u5728\u56fe\u4e2d\u201c2\u201d\u5904\u627e\u5230\u6587\u4ef6\uff1alibfesvr.so\uff0c\u5c06\u8be5\u6587\u4ef6\u7528\u9f20\u6807\u62d6\u52a8\u5230\u56fe\u4e2d\u201c3\u201d\u5904\uff0c\u7b49\u5f85\u6587\u4ef6\u4f20\u8f93\u5b8c\u6210\u5373\u53ef\u3002</p> <p></p> <p>\u4ee5\u540c\u6837\u7684\u65b9\u5f0f\u518d\u5c06riscv-fesvr\u6587\u4ef6\u4e0eprogram.sh\u6587\u4ef6\u4f20\u8f93\u5230pynq-z1\u5f00\u53d1\u677f\u4e2d\u3002</p> <p>8\uff09\u7528ssh\u8fdc\u7a0b\u767b\u5f55192.168.2.99\uff08\u5f00\u53d1\u677f\u7684ip\u5730\u5740\uff09\uff0c\u7528\u6237\u540d\u5bc6\u7801\u90fd\u4e3axilinx\u3002\uff08\u6b64\u6b65Linux\uff08ubuntu\u684c\u9762\u73af\u5883\uff09\u4e0eWindows\uff08WSL\u73af\u5883\uff09\u4e0b\u64cd\u4f5c\u4e0d\u540c\uff09</p> <p>Linux\uff08ubuntu\u684c\u9762\u73af\u5883\uff09\uff1a</p> <p>\u5728\u7ec8\u7aef\u4e2d\u8f93\u5165\u5982\u4e0b\u547d\u4ee4\u6765\u5efa\u7acbssh\u8fde\u63a5\uff1a</p> <pre><code>ssh xilinx@192.168.2.99\n\uff08\u7b2c\u4e00\u6b21\u8fd0\u884c\u65f6\uff0c\u4f1a\u63d0\u793a\u786e\u8ba4\u8fde\u63a5\u4fe1\u606f\uff0c\u8f93\u5165yes\u540e\u56de\u8f66\uff09\n\uff08\u5bc6\u7801\u8f93\u5165\uff1axilinx\uff09\n</code></pre> <p>Windows\uff08WSL\u73af\u5883\uff09\uff1a</p> <p>Windows\u7528\u6237\u65e2\u53ef\u4ee5\u9009\u62e9\u5728WSL\u4e2d\uff0c\u7528\u4e0e\u4e0a\u8ff0Linux\u4e0b\u76f8\u540c\u7684\u65b9\u5f0f\u5728\u7ec8\u7aef\u4e2d\u5efa\u7acbssh\u8fde\u63a5\uff0c\u4e5f\u53ef\u4ee5\u9009\u62e9\u7528\u5e26\u56fe\u5f62\u754c\u9762\u7684ssh\u5ba2\u6237\u7aef\u6765\u5efa\u7acbssh\u8fde\u63a5\u3002\u4e0b\u9762\u4ecb\u7ecd\u5982\u4f55\u5728Windows\u73af\u5883\u4e2d\u4f7f\u7528MobaXterm\u8f6f\u4ef6\u5efa\u7acbssh\u8fde\u63a5\u7684\u6b65\u9aa4\u3002\uff08\u6ce8\u610f\uff0c\u540e\u6587\u4e2d\u7684\u5176\u4ed6\u6b65\u9aa4\u4ecd\u7136\u4f1a\u7528\u5230ssh\u8fde\u63a5\uff0c\u4e3a\u907f\u514d\u6587\u7ae0\u7bc7\u5e45\u8fc7\u957f\uff0cWindows\u73af\u5883\u4e0b\u56fe\u5f62\u754c\u9762\u7684ssh\u8fde\u63a5\u5efa\u7acb\u8fc7\u7a0b\u53ea\u4f1a\u5728\u6b64\u5904\u4ecb\u7ecd\u4e00\u6b21\uff0c\u8bfb\u8005\u5728\u540e\u7eed\u6b65\u9aa4\u4e2d\u78b0\u5230\u9700\u8981\u4f7f\u7528ssh\u4e0epynq-z1\u5efa\u7acb\u8fde\u63a5\u7684\u64cd\u4f5c\u65f6\uff0c\u53ef\u4ee5\u53c2\u8003\u6b64\u5904\u7684\u64cd\u4f5c\u65b9\u5f0f\uff09</p> <p>\u6253\u5f00MobaXterm\uff0c\u70b9\u51fb\u5de6\u4e0a\u89d2\u7684\u201cSession\u201d\u3002</p> <p></p> <p>\u5728\u5f39\u51fa\u7684\u7a97\u53e3\u4e2d\u9009\u62e9\u201cSSH\u201c\uff0c\u7136\u540e\u5728Remote host\u540e\u586b\u5165192.168.2.99\uff0c\u52fe\u9009Specify username\uff0c\u5e76\u5728\u5176\u540e\u586b\u5165xilinx\uff0c\u6700\u540e\u70b9\u51fbOK\u3002</p> <p></p> <p>\u8f93\u5165\u5bc6\u7801xilinx\u540e\u56de\u8f66\u3002</p> <p>9\uff09\u5728ssh\u4f1a\u8bdd\u4e2d\uff0c\u4f9d\u6b21\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a</p> <pre><code>$ sudo mv libfesvr.so /usr/local/lib/ #\u5bc6\u7801\u8f93\u5165xilinx\n$ sudo mkdir -p /lib/firmware\n$ chmod +x program.sh\n$ chmod +x riscv-fesvr\n</code></pre> <p>10\uff09\u4fee\u6539\u5b8c\u6210\uff0c\u65ad\u5f00ssh\u3001sftp\u8fde\u63a5\u3002</p> <p>\u200b   \u82e5\u662f\u5728\u56fe\u5f62\u7a97\u53e3\u4e2d\u521b\u5efa\u7684\u8fde\u63a5\uff0c\u5219\u76f4\u63a5\u5173\u95ed\u7a97\u53e3\u5373\u53ef\uff1b\u82e5\u662f\u5728Linux\u7ec8\u7aef\u6216WSL\u4e2d\u521b\u5efa\u7684\u8fde\u63a5\uff0c\u5219\u8f93\u5165\u201cexit\u201d\u540e\u56de\u8f66\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter6_riscv_on_pynq/#62-fpga1rocket-chipuart","title":"6.2 fpga\u5b9e\u9a8c1\uff1a\u5728Rocket Chip\u4e0a\u6dfb\u52a0uart\u63a5\u53e3","text":""},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter6_riscv_on_pynq/#_2","title":"\u5b9e\u9a8c\u76ee\u7684","text":"<p>\u5bf9\u4e8e\u524d\u6587\u4e2d\u63d0\u5230\u7684\u84dd\u7259\u667a\u80fd\u5c0f\u8f66\uff0c\u5728\u5176\u4ece\u84dd\u7259\u8bbe\u5907\u83b7\u53d6\u7528\u6237\u6307\u4ee4\uff0c\u4ee5\u53ca\u5411\u7535\u673a\u9a71\u52a8\u677f\u53d1\u9001\u7535\u673a\u9a71\u52a8\u547d\u4ee4\u7684\u8fc7\u7a0b\uff0c\u90fd\u9700\u8981\u7528\u5230uart\u63a5\u53e3\u4e0e\u5916\u8bbe\u8fdb\u884c\u901a\u4fe1\u3002\u56e0\u6b64\uff0c\u5728\u672c\u5b9e\u9a8c\u4e2d\uff0c\u9996\u5148\u5e26\u9886\u8bfb\u8005\u4e3aRocket Chip\u6dfb\u52a0uart\u5916\u8bbe\u7684\u652f\u6301\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter6_riscv_on_pynq/#_3","title":"\u5b9e\u9a8c\u5185\u5bb9","text":"<p>\u4e3aRocket Chip\u6dfb\u52a0uart\u652f\u6301</p> <p>Rocket Chip\u76f8\u5173\u7684verilog\u6587\u4ef6\u4e3b\u8981\u662f\u7531Chisel\u81ea\u52a8\u751f\u6210\u7684\uff0c\u8fd9\u4e9bverilog\u6587\u4ef6\u96be\u4ee5\u76f4\u63a5\u8fdb\u884c\u4fee\u6539\u7f16\u8f91\u3002\u4e3a\u4e86\u6539\u53d8Rocket Chip\u7684\u884c\u4e3a\uff0c\u6b63\u786e\u7684\u4fee\u6539\u65b9\u5f0f\u662f\u5bf9common/src/main/scala\u4e0b\u7684\u6587\u4ef6\u8fdb\u884c\u4fee\u6539\uff0c\u5e76\u8fd0\u884crocket chip\u751f\u6210\u5668\u751f\u6210\u76f8\u5173\u7684verilog\u6587\u4ef6\uff0c\u518d\u5c06\u751f\u6210\u7684verilog\u6587\u4ef6\u590d\u5236\u5230src/verilog\u5de5\u7a0b\u76ee\u5f55\u4e0b\u3002\u5176\u4e2d\u8fd0\u884crocket chip\u751f\u6210\u5668\u4ee5\u53ca\u590d\u5236\u6587\u4ef6\u7684\u76f8\u5173\u64cd\u4f5c\u90fd\u5df2\u7ecf\u4e3a\u8bfb\u8005\u5199\u5165\u4e86make file\u4e2d\uff0c\u5e76\u4e0d\u9700\u8981\u624b\u52a8\u6267\u884c\uff0c\u8bfb\u8005\u53ea\u9700\u6309\u7167\u4ee5\u4e0b\u6b65\u9aa4\u4fee\u6539\u76f8\u5173\u914d\u7f6e\u6587\u4ef6\uff0c\u5e76\u6309\u7167\u8bf4\u660e\u6267\u884c\u7f16\u8bd1\u547d\u4ee4\u5373\u53ef\u3002</p> <p>\u4e0b\u9762\u662f\u5177\u4f53\u7684\u64cd\u4f5c\u6b65\u9aa4\uff1a</p> <p>\u4e3a\u4e86\u80fd\u591f\u5728PKE\u4e2d\u50cf\u8bbf\u95ee\u666e\u901a\u5185\u5b58\u4e00\u6837\u5bf9\u65b0\u589e\u7684uart\u5916\u8bbe\u8fdb\u884c\u8bbf\u95ee\uff0c\u6211\u4eec\u9700\u8981\u5bf9Rocket Chip\u8fdb\u884c\u4fee\u6539\uff0c\u4e3a\u5176\u6dfb\u52a0MMIO\u7684\u652f\u6301\u3002\u7136\u540e\u9700\u8981\u5728\u9876\u5c42verilog\u6587\u4ef6\u4e2d\u589e\u52a0MMIO\u63a5\u53e3\u548cuart\u63a5\u53e3\uff0c\u5176\u4e2d\u7684MMIO\u63a5\u53e3\u7528\u6765\u5c06Rocket Chip\u4e2d\u7684MMIO\u63a5\u53e3\u4e0eblock design\u4e2d\u6dfb\u52a0\u7684MMIO_s_axi\u63a5\u53e3\u8fdb\u884c\u8fde\u63a5\uff0cuart\u63a5\u53e3\u5219\u7528\u6765\u5c06\u5728block design\u4e2d\u6dfb\u52a0\u7684uart\u63a5\u53e3\u66b4\u9732\u51fa\u53bb\u3002\u5728\u5b8c\u6210\u9876\u5c42verilog\u6587\u4ef6\u4e2d\u63a5\u53e3\u7684\u6dfb\u52a0\u540e\uff0c\u8fd8\u9700\u4fee\u6539xdc\u7ea6\u675f\u6587\u4ef6\u5c06uart\u63a5\u53e3\u4e0efpga\u5f00\u53d1\u677f\u4e0a\u7684\u7269\u7406\u63a5\u53e3\u8fdb\u884c\u7ed1\u5b9a\uff0c\u4fbf\u4e8e\u540e\u7eed\u5916\u8bbe\u7684\u8fde\u63a5\u3002</p> <ol> <li>\u4fee\u6539Rocket Chip\uff0c\u4ee5\u589e\u52a0\u5176\u5bf9MMIO\uff08Memory-mapped I/O\uff09\u7684\u652f\u6301</li> </ol> <p>\u4fee\u6539\u6587\u4ef6<code>$REPO/common/src/main/scala/Top.scala</code>\u3002\u4fee\u6539\u540e\u7684\u6587\u4ef6\u4e3aTop.scala\uff0c\u4fee\u6539\u8fc7\u7684\u5730\u65b9\u5747\u6709modified\u6807\u8bc6\u3002</p> <ol> <li>\u4fee\u6539\u5de5\u7a0b\u9876\u5c42verilog\u6587\u4ef6\uff0c\u589e\u52a0MMIO\u63a5\u53e3\u548cuart\u63a5\u53e3\u7684\u8fde\u63a5</li> </ol> <p>\u4fee\u6539\u6587\u4ef6<code>$REPO/common/rocketchip_wrapper.v</code>\u3002\u4fee\u6539\u540e\u7684\u6587\u4ef6\u4e3arocketchip_wrapper.v\uff0c\u4fee\u6539\u8fc7\u7684\u5730\u65b9\u5747\u6709modified\u6807\u8bc6\u3002</p> <ol> <li>\u4fee\u6539xdc\u7ea6\u675f\u6587\u4ef6</li> </ol> <p>\u4fee\u6539\u6587\u4ef6<code>$REPO/pynq-z2/src/constrs/base.xdc</code>\u3002\u4e3a\u4e86\u5c06<code>$REPO/common/rocketchip_wrapper.v</code>\u4e2d\u5b9a\u4e49\u7684uart\u63a5\u53e3\u4e0efpga\u5f00\u53d1\u677f\u4e0a\u7684IO\u7ba1\u811a\u5efa\u7acb\u94fe\u63a5\uff0c\u5e76\u5b9a\u4e49IO\u7ba1\u811a\u7684\u7535\u5e73\u6807\u51c6\uff0c\u6211\u4eec\u9700\u8981\u5728xdc\u7ea6\u675f\u6587\u4ef6\u672b\u5c3e\u52a0\u5165\u5982\u4e0b\u56db\u884c\u4ee3\u7801\u6620\u5c04uart\u63a5\u53e3\u3002\u8fd9\u56db\u884c\u4ee3\u7801\u5c06uart_out\u3001uart_in\u3001uart2_out\u548cuart2_in\u7aef\u53e3\u4f9d\u6b21\u7ed1\u5b9a\u5230FPGA\u5f00\u53d1\u677f\u7684Y16\u3001Y17\u3001T11\u548cT10\u7ba1\u811a\uff0c\u5176\u4e2dY16\u4e0eY17\u7ba1\u811a\u5206\u522b\u5bf9\u5e94\u4e8e\uff1apynq-z1\u5f00\u53d1\u677f\u4e0aPMODA\u63a5\u53e3\u4e2d\u4e0a\u9762\u4e00\u6392\u7684\u4ece\u5de6\u5f80\u53f3\u7b2c\u4e09\u3001\u7b2c\u56db\u4e2a\u63a5\u53e3\uff0c\u8fd9\u4e24\u4e2a\u63a5\u53e3\u5728\u540e\u9762\u4f1a\u7528\u6765\u8fde\u63a5\u84dd\u7259\u6a21\u5757\u7684\u6570\u636e\u6536\u53d1\u7ba1\u811a\uff0c\u5177\u4f53\u7684\u5b89\u88c5\u65b9\u5f0f\u5728\u672c\u5b9e\u9a8c\u672b\u5c3e\u4f1a\u8fdb\u884c\u4ecb\u7ecd\u3002\u7c7b\u4f3c\u7684\uff0cT11\u548cT10\u4e24\u4e2a\u63a5\u53e3\u5206\u522b\u5bf9\u5e94PMODB\u63a5\u53e3\u4e2d\u4e0a\u9762\u4e00\u6392\u7684\u4ece\u5de6\u5f80\u53f3\u7b2c\u4e09\u3001\u7b2c\u56db\u4e2a\u63a5\u53e3\uff0c\u7528\u6765\u8fde\u63a5\u7535\u673a\u9a71\u52a8\u677f\u7684\u6570\u636e\u6536\u53d1\u7ba1\u811a\u3002</p> <pre><code>set_property -dict { PACKAGE_PIN Y16   IOSTANDARD LVCMOS33 }    [get_ports { uart_out }]; #IO_L7P_T1_34 Sch=ja_p[2]\nset_property -dict { PACKAGE_PIN Y17   IOSTANDARD LVCMOS33 } [get_ports { uart_in }]; #IO_L7N_T1_34 Sch=ja_n[2]\n\nset_property -dict { PACKAGE_PIN T11   IOSTANDARD LVCMOS33 } [get_ports { uart2_out }]; #IO_L1P_T0_34 Sch=jb_p[2]\n set_property -dict { PACKAGE_PIN T10   IOSTANDARD LVCMOS33 }    [get_ports { uart2_in }]; #IO_L1N_T0_34 Sch=jb_n[2]\n</code></pre> <p>\u4fee\u6539\u540e\u7684\u6587\u4ef6\u4e3abase.xdc</p> <p>\u5728\u5b8c\u6210\u4e0a\u8ff0\u4e09\u5904\u6587\u4ef6\u4fee\u6539\u540e\uff0c\u7f16\u8bd1\u751f\u6210vivado\u5de5\u7a0b\u3002</p> <ol> <li>\u751f\u6210vivado\u5de5\u7a0b</li> </ol> <p>\u6ce8\u610f\uff0c\u8be5\u6b65\u9aa4\u4e2dLinux\uff08ubuntu\u684c\u9762\u73af\u5883\uff09\u4e0eWindows\uff08WSL\u73af\u5883\uff09\u4e0b\u7684\u64cd\u4f5c\u5b58\u5728\u4e00\u4e9b\u5dee\u5f02\uff0c\u8bfb\u8005\u5e94\u6309\u7167\u81ea\u5df1\u6240\u7528\u5e73\u53f0\u9009\u62e9\u6b63\u786e\u7684\u6b65\u9aa4\u6267\u884c\u3002</p> <p>Linux\uff08ubuntu\u684c\u9762\u73af\u5883\uff09\uff1a</p> <p>\u5728\u547d\u4ee4\u884c\u4e2d\u6267\u884c\u5982\u4e0b\u547d\u4ee4\u751f\u6210\u5e76\u6253\u5f00vivado\u5de5\u7a0b\u3002</p> <pre><code>$ cd $REPO/pynq-z2/\n$ make project\n$ make vivado\n</code></pre> <p>Windows\uff08WSL\u73af\u5883\uff09\uff1a</p> <p>\u5728WSL\u547d\u4ee4\u884c\u4e2d\u6267\u884c\u5982\u4e0b\u547d\u4ee4\uff1a</p> <pre><code>$ cd $REPO/pynq-z2/\n$ make project\n</code></pre> <p>\u5728Windows\u4e2d\u7b2c\u4e00\u6b21\u751f\u6210\u5de5\u7a0b\u65f6\u8fd8\u9700\u8981\u8fdb\u884c\u4ee5\u4e0b\u64cd\u4f5c\uff1a\uff08\u540e\u7eed\u5728\u4fee\u6539Rocket Chip\u540e\u91cd\u65b0\u751f\u6210\u65f6\uff0c\u53ea\u9700\u8981\u6267\u884c\u4e0a\u8ff0\u4e24\u6761\u547d\u4ee4\u5373\u53ef\uff09</p> <p>\u6309\u5feb\u6377\u952ewin+r\u6253\u5f00\u8fd0\u884c\u7a97\u53e3\uff0c\u8f93\u5165cmd\u540e\u6309\u56de\u8f66\u952e\uff0c\u6253\u5f00\u547d\u4ee4\u63d0\u793a\u7b26\u7a97\u53e3\u3002\u5728\u547d\u4ee4\u63d0\u793a\u7b26\u7a97\u53e3\u4e2d\u6267\u884c\u5982\u4e0b\u547d\u4ee4\u8bbe\u7f6evivado\u73af\u5883\u53d8\u91cf\uff08\u66ff\u6362\u6389\u201c\u4f60\u7684vivado\u5b89\u88c5\u76ee\u5f55\u201d\uff09\uff1a</p> <pre><code>&gt; \u4f60\u7684vivado\u5b89\u88c5\u8def\u5f84\\Vivado\\2016.2\\settings64.bat\n</code></pre> <p>\u7136\u540e\u5207\u6362\u76d8\u7b26\u5230\u6e90\u7801\u6240\u5728\u76d8\uff0c\u6bd4\u5982\u82e5\u6e90\u7801\u4fdd\u5b58\u5728d\u76d8\uff0c\u5219\u5728\u547d\u4ee4\u63d0\u793a\u7b26\u7a97\u53e3\u4e2d\u8f93\u5165<code>d:</code>\uff0c\u5207\u6362\u5b8c\u6210\u540e\u7ee7\u7eed\u5728\u547d\u4ee4\u63d0\u793a\u7b26\u7a97\u53e3\u4e2d\u8f93\u5165\u4ee5\u4e0b\u547d\u4ee4\uff08\u66ff\u6362\u6389\u201c\u4f60\u7684\u6e90\u7801\u6240\u5728\u76ee\u5f55\u201d\uff09\uff1a</p> <pre><code>&gt; cd \u4f60\u7684\u6e90\u7801\u6240\u5728\u76ee\u5f55\\fpga-zynq\\pynq-z2\\\n&gt; vivado -mode tcl -source src/tcl/pynq_rocketchip_ZynqFPGAConfig.tcl\n</code></pre> <p>\u53cc\u51fb\u684c\u9762\u56fe\u6807\u6253\u5f00Windows\u4e2d\u5b89\u88c5\u597d\u7684vivado\uff0c\u70b9\u51fbOpen Project\uff0c\u627e\u5230<code>\u4f60\u7684\u6e90\u7801\u6240\u5728\u76ee\u5f55\\fpga-zynq\\pynq-z2\\pynq_rocketchip_ZynqFPGAConfig\\pynq_rocketchip_ZynqFPGAConfig.xpr</code>\u53cc\u51fb\u6253\u5f00\u3002</p> <p>\u7136\u540e\u6211\u4eec\u9700\u8981\u5728block design\u4e2d\u6dfb\u52a0uart\u76f8\u5173\u7684\u63a5\u53e3\u548cIP\u6838\uff0c\u5e76\u5b8c\u6210\u5730\u5740\u5206\u914d\u3002</p> <ol> <li>\u4fee\u6539block design</li> </ol> <p>1\uff09\u6253\u5f00vivado\u5de5\u7a0b\u540e\uff0c\u5728Sourses\u9762\u677f\u70b9\u51fbrocketchip_wrapper\u5de6\u8fb9\u7684\u52a0\u53f7\uff0c\u7136\u540e\u518d\u53cc\u51fbsystem_i\u6253\u5f00block design\u9762\u677f\u3002\u5728\u6700\u5de6\u8fb9\u627e\u5230S_AXI\u7aef\u53e3\uff0c\u70b9\u51fb\u9009\u4e2d\uff0c\u7136\u540e\u518d\u6309ctrl+c\u3001ctrl+v\uff0c\u8fd9\u6837\u5c31\u590d\u5236\u51fa\u4e00\u4e2a\u540c\u6837\u7684\u7aef\u53e3S_AXI1\uff0c\u70b9\u51fb\u9009\u4e2d\u8fd9\u4e2aS_AXI1\uff0c\u627e\u5230\u5de6\u8fb9External Interface Properties\u9762\u677f\uff0c\u628aName\u6539\u4e3aMMIO_S_AXI\uff0cClock Port\u9009\u62e9ext_clk_in\uff1b\u9009\u4e2d\u6700\u5de6\u4fa7\u7684ext_clk_in\u7aef\u53e3\uff0c\u627e\u5230\u5de6\u8fb9External Port Properties\u9762\u677f\uff0c\u5c06Frequency\uff08Mhz\uff09\u4fee\u6539\u4e3a50\u3002</p> <p></p> <p>2\uff09\u5728\u53f3\u4fa7\u7535\u8def\u56fe\u9762\u677f\u7a7a\u767d\u5904\u70b9\u51fb\u53f3\u952e\uff0c\u518d\u70b9\u51fbAdd IP...\uff0c\u7136\u540e\u8f93\u5165axi interconnect\uff0c\u7136\u540e\u53cc\u51fb\u51fa\u73b0\u7684\u641c\u7d22\u7ed3\u679c\u628aaxi interconnect\u653e\u5165\u7535\u8def\u56fe\u4e2d\uff0c\u7136\u540e\u53cc\u51fb\u65b0\u51fa\u73b0\u7684axi_interconnect_2\uff0c\u5c06Number of Master Interface\u6539\u4e3a2\uff0c\u7136\u540e\u70b9\u51fbOK\u3002</p> <p>3\uff09\u5728\u53f3\u4fa7\u7535\u8def\u56fe\u9762\u677f\u7a7a\u767d\u5904\u70b9\u51fb\u53f3\u952e\uff0c\u518d\u70b9\u51fbAdd IP...\uff0c\u7136\u540e\u8f93\u5165axi uartlite\uff0c\u7136\u540e\u53cc\u51fb\u51fa\u73b0\u7684\u641c\u7d22\u7ed3\u679c\u628aaxi uartlite\u653e\u5165\u7535\u8def\u56fe\u4e2d\uff0c\u7136\u540e\u53cc\u51fb\u65b0\u51fa\u73b0\u7684axi_uartlite_0\uff0c\u5c06Baud Rate\u6539\u4e3a115200\uff0c\u7136\u540e\u70b9\u51fbOK\u3002axi_uartlite_0\u7528\u6765\u4e0e\u84dd\u7259\u6a21\u5757\u8fdb\u884c\u4e32\u53e3\u901a\u4fe1\uff0c\u5176\u6ce2\u7279\u7387\u9700\u8981\u4e0e\u84dd\u7259\u6a21\u5757\u7684\u6ce2\u7279\u7387\u76f8\u540c\uff0c\u82e5\u8bfb\u8005\u4f7f\u7528\u7684\u84dd\u7259\u6a21\u5757\u4e3a\u5176\u4ed6\u7684\u6ce2\u7279\u7387\uff0c\u5219\u5e94\u8be5\u5c06Baud Rate\u6539\u4e3a\u84dd\u7259\u6a21\u5757\u7684\u5b9e\u9645\u6ce2\u7279\u7387\uff08\u6216\u901a\u8fc7\u4e32\u53e3\u8c03\u8bd5\u8f6f\u4ef6\u6539\u53d8\u84dd\u7259\u6a21\u5757\u7684\u6ce2\u7279\u7387\uff09\u3002</p> <p>4\uff09\u91cd\u590d\u6b65\u9aa43\uff0c\u518d\u6dfb\u52a0\u4e00\u4e2aaxi uartlite\uff0c\u8be5IP\u6838\u4f1a\u88ab\u81ea\u52a8\u547d\u540d\u4e3aaxi_uartlite_1\uff0c\u53cc\u51fbaxi_uartlite_1\uff0c\u540c\u6837\u5c06\u5176Baud Rate\u6539\u4e3a115200\uff0c\u7136\u540e\u70b9\u51fbOK\u3002axi_uartlite_1\u7528\u6765\u4e0e\u7535\u673a\u9a71\u52a8\u677f\u8fdb\u884c\u4e32\u53e3\u901a\u4fe1\uff0c\u5176\u6ce2\u7279\u7387\u9700\u8981\u4e0e\u7535\u673a\u9a71\u52a8\u677f\uff08\u4ee5\u4e32\u53e3\u65b9\u5f0f\u8fdb\u884c\u63a7\u5236\uff09\u7684\u6ce2\u7279\u7387\u76f8\u540c\uff0c\u5728\u672c\u5b9e\u9a8c\u7528\u5230\u7684\u5c0f\u8f66\u4e2d\uff0c\u7535\u673a\u9a71\u52a8\u677f\u7684\u6ce2\u7279\u7387\u4e3a115200\u3002</p> <p>5\uff09\u5728\u53f3\u4fa7\u7535\u8def\u56fe\u9762\u677f\u7a7a\u767d\u5904\u70b9\u51fb\u53f3\u952e\uff0c\u518d\u70b9\u51fbCreate Port...\uff0cPort name\u4e3auart_in\uff0cDirection\u4e3aInput\uff0cType\u4e3aOther\uff0c\u70b9\u51fbOK\u3002</p> <p>6\uff09\u5728\u53f3\u4fa7\u7535\u8def\u56fe\u9762\u677f\u7a7a\u767d\u5904\u70b9\u51fb\u53f3\u952e\uff0c\u518d\u70b9\u51fbCreate Port...\uff0cPort name\u4e3auart2_in\uff0cDirection\u4e3aInput\uff0cType\u4e3aOther\uff0c\u70b9\u51fbOK\u3002</p> <p>7\uff09\u5728\u53f3\u4fa7\u7535\u8def\u56fe\u9762\u677f\u7a7a\u767d\u5904\u70b9\u51fb\u53f3\u952e\uff0c\u518d\u70b9\u51fbCreate Port...\uff0cPort name\u4e3auart_out\uff0cDirection\u4e3aOutput\uff0cType\u4e3aOther\uff0c\u70b9\u51fbOK\u3002</p> <p>8\uff09\u5728\u53f3\u4fa7\u7535\u8def\u56fe\u9762\u677f\u7a7a\u767d\u5904\u70b9\u51fb\u53f3\u952e\uff0c\u518d\u70b9\u51fbCreate Port...\uff0cPort name\u4e3auart2_out\uff0cDirection\u4e3aOutput\uff0cType\u4e3aOther\uff0c\u70b9\u51fbOK\u3002</p> <p>7\uff09\u6309\u7167\u5982\u56fe\u65b9\u5f0f\u63a5\u597d\u7535\u8def\u56fe(\u6ce8\u610f\uff1auart_lite_0\u53f3\u4fa7\u7684UART\u7aef\u53e3\u53f3\u8fb9\u6709\u4e2a\u52a0\u53f7\uff0c\u9700\u8981\u70b9\u4e00\u4e0b\u52a0\u53f7\u5c55\u5f00\u518d\u8fdb\u884c\u8fde\u7ebf)\u3002</p> <p></p> <p>8\uff09\u70b9\u51fb\u4e0a\u9762\u7684Address Editor\uff0c\u7136\u540e\u5728\u672a\u6620\u5c04\u7684\u5355\u5143\u4e0a\u53f3\u952e\u5355\u51fb\uff0c \u5e76\u5728\u5f39\u51fa\u7684\u83dc\u5355\u4e2d\u70b9\u51fbassign address\u3002</p> <p></p> <p>\u6309\u7167\u5982\u56fe\u6240\u793a\u914d\u7f6e\u5730\u5740\uff08\u5efa\u8bae\u5148\u4fee\u6539Range\u5c5e\u6027\uff0c\u518d\u4fee\u6539Offset Address\u5c5e\u6027\uff0c\u5426\u5219Offset Address\u53ef\u80fd\u4fee\u6539\u4e0d\u6210\u529f\uff09\uff0c\u8be5\u64cd\u4f5c\u5c06\u84dd\u7259\u6a21\u5757\u7684\u5730\u5740\u6620\u5c04\u5230\u4e860x6000_0000\uff0c\u5c06\u7535\u673a\u9a71\u52a8\u7684\u5730\u5740\u6620\u5c04\u5230\u4e860x6000_1000\u3002</p> <p></p> <ol> <li>\u4fdd\u5b58\u6240\u6709\u4fee\u6539\u540e\u7684\u6587\u4ef6\uff08\u4e5f\u53ef\u4ee5\u9009\u62e9\u76f4\u63a5\u70b9\u51fb\u4e0b\u4e00\u6b65\u4e2d\u7684Generate Bitstream\uff0cvivado\u4f1a\u5bf9\u672a\u4fdd\u5b58\u5185\u5bb9\u5f39\u7a97\uff0c\u63d0\u9192\u7528\u6237\u4fdd\u5b58\uff0c\u8bfb\u8005\u5e94\u7559\u610f\u76f8\u5173\u5f39\u7a97\u5185\u5bb9\uff09</li> </ol> <p>\u4e0a\u8ff0\u4fee\u6539\u5168\u90e8\u5b8c\u6210\u540e\uff0c\u4fbf\u53ef\u4ee5\u8fdb\u884cbitstream\u6587\u4ef6\u7684\u751f\u6210\u4ee5\u53ca\u6253\u5305\u7684\u5de5\u4f5c\u3002\u6253\u5305\u5f97\u5230\u7684rocketchip_wrapper.bit.bin\u6587\u4ef6\u6700\u7ec8\u662f\u9700\u8981\u70e7\u5f55\u5230pynq-z1\u5f00\u53d1\u677f\u4e2d\u6765\u5b9e\u73b0\u76f8\u5173\u786c\u4ef6\u529f\u80fd\u7684\u3002</p> <ol> <li>\u751f\u6210bitstream\u6587\u4ef6</li> </ol> <p>\u6700\u540e\uff0c\u70b9\u51fb\u5de6\u4e0b\u89d2\u7684Generate Bitstream\u751f\u6210\u6bd4\u7279\u6d41\u6587\u4ef6\u3002\uff08\u8be5\u6b65\u9aa4\u8017\u65f6\u8f83\u957f\uff09</p> <p>\u5f53\u5f39\u51fa\u5982\u4e0b\u5bf9\u8bdd\u6846\u65f6\u70b9\u51fbyes\uff1a</p> <p></p> <p>\u5f53\u5f39\u51fa\u5982\u4e0b\u5bf9\u8bdd\u6846\u65f6\u8868\u660ebitstream\u751f\u6210\u5b8c\u6210\uff0c\u70b9\u51fbcancel\uff1a</p> <p></p> <ol> <li>\u6253\u5305bitstream\u6587\u4ef6\u4e3abin\u6587\u4ef6</li> </ol> <p>\u6ce8\u610f\uff0c\u8be5\u6b65\u9aa4\u4e2dLinux\uff08ubuntu\u684c\u9762\u73af\u5883\uff09\u4e0eWindows\uff08WSL\u73af\u5883\uff09\u4e0b\u7684\u64cd\u4f5c\u5b58\u5728\u4e00\u4e9b\u5dee\u5f02\uff0c\u8bfb\u8005\u5e94\u6309\u7167\u81ea\u5df1\u6240\u7528\u5e73\u53f0\u9009\u62e9\u6b63\u786e\u7684\u6b65\u9aa4\u6267\u884c\u3002</p> <p>Linux\uff08ubuntu\u684c\u9762\u73af\u5883\uff09\uff1a</p> <p>1\uff09\u521b\u5efaFull_Bitstream.bif\u6587\u4ef6</p> <p>\u8be5\u6587\u4ef6\u4e3a\u7eaf\u6587\u672c\u6587\u4ef6\uff0c\u53ef\u4ee5\u76f4\u63a5\u7528\u8bb0\u4e8b\u672c\u521b\u5efa\uff0c\u5e76\u8f93\u5165\u5982\u4e0b\u5185\u5bb9\u540e\u4fdd\u5b58\uff1a</p> <pre><code>all:\n{\n    rocketchip_wrapper.bit /* Bitstream file name */\n}\n</code></pre> <p>\u5c06\u8be5\u6587\u4ef6\u91cd\u547d\u540d\u4e3aFull_Bitstream.bif\uff0c\u7136\u540e\u5c06\u5176\u590d\u5236\u5230<code>$REPO/pynq-z2/pynq_rocketchip_ZynqFPGAConfig/pynq_rocketchip_ZynqFPGAConfig.runs/impl_1</code>\u76ee\u5f55\u4e0b\u3002</p> <p>2\uff09\u751f\u6210\u6bd4\u7279\u6d41bin\u6587\u4ef6</p> <p>\u5728\u7ec8\u7aef\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\u751f\u6210bin\u6587\u4ef6\uff1a</p> <pre><code>$ cd $REPO/pynq-z2/pynq_rocketchip_ZynqFPGAConfig/pynq_rocketchip_ZynqFPGAConfig.runs/impl_1\n$ bootgen -image Full_Bitstream.bif -arch zynq -process_bitstream bin -w on\n</code></pre> <p>Windows\uff08WSL\u73af\u5883\uff09\uff1a</p> <p>1\uff09\u521b\u5efaFull_Bitstream.bif\u6587\u4ef6</p> <p>\u521b\u5efa\u6b65\u9aa4\u4e0e\u4e0a\u6587Linux\u684c\u9762\u73af\u5883\u4e0b\u57fa\u672c\u76f8\u540c\uff0c\u8bfb\u8005\u6839\u636e\u81ea\u5df1\u7684\u4e60\u60ef\u5728WSL\u6216\u8005Windows\u56fe\u5f62\u754c\u9762\u4e2d\u521b\u5efa\u8be5\u6587\u4ef6\u7686\u53ef\uff0c\u521b\u5efa\u5b8c\u6210\u540e\u5c06\u5176\u590d\u5236\u5230<code>$REPO/pynq-z2/pynq_rocketchip_ZynqFPGAConfig/pynq_rocketchip_ZynqFPGAConfig.runs/impl_1</code>\u76ee\u5f55\u4e0b\u3002</p> <p>2\uff09\u751f\u6210\u6bd4\u7279\u6d41bin\u6587\u4ef6</p> <p>\u6309\u5feb\u6377\u952ewin+r\u6253\u5f00\u8fd0\u884c\u7a97\u53e3\uff0c\u8f93\u5165cmd\u540e\u6309\u56de\u8f66\u952e\uff0c\u6253\u5f00\u547d\u4ee4\u63d0\u793a\u7b26\u7a97\u53e3\u3002\u5728\u547d\u4ee4\u63d0\u793a\u7b26\u7a97\u53e3\u4e2d\u6267\u884c\u5982\u4e0b\u547d\u4ee4\u8bbe\u7f6evivado\u73af\u5883\u53d8\u91cf\uff08\u66ff\u6362\u6389\u201c\u4f60\u7684vivado\u5b89\u88c5\u76ee\u5f55\u201d\uff09\uff1a</p> <pre><code>&gt; \u4f60\u7684vivado\u5b89\u88c5\u8def\u5f84\\Vivado\\2016.2\\settings64.bat\n</code></pre> <p>\u63a5\u7740\u6309\u7167\u524d\u6587\u4e2d\u6240\u8ff0\u65b9\u5f0f\u5207\u6362\u76d8\u7b26\u5230\u6e90\u7801\u6240\u5728\u76d8\uff0c\u63a5\u7740\u5728\u547d\u4ee4\u63d0\u793a\u7b26\u7a97\u53e3\u4e2d\u6267\u884c\u5982\u4e0b\u547d\u4ee4\uff08\u66ff\u6362\u6389\u201c\u4f60\u7684\u6e90\u7801\u6240\u5728\u76ee\u5f55\u201d\uff09\uff1a</p> <pre><code>&gt; cd \u4f60\u7684\u6e90\u7801\u6240\u5728\u76ee\u5f55\\pynq-z2\\pynq_rocketchip_ZynqFPGAConfig\\pynq_rocketchip_ZynqFPGAConfig.runs\\impl_1\n&gt; bootgen -image Full_Bitstream.bif -arch zynq -process_bitstream bin -w on\n</code></pre> <ol> <li>\u786c\u4ef6\u7ec4\u88c5</li> </ol> <p>\u6309\u7167\u524d\u65876.1.4\u8282\u7684\u8bf4\u660e\u5b8c\u6210\u84dd\u7259\u5c0f\u8f66\u7684\u7ec4\u88c5\u3002</p> <ol> <li> <p>\u64cd\u4f5c\u7cfb\u7edf\u7684\u66ff\u6362\u4fee\u6539</p> <p>\u6309\u7167\u524d\u65876.1.5\u8282\u7684\u8bf4\u660e\u5b8c\u6210\u64cd\u4f5c\u7cfb\u7edf\u7684\u66ff\u6362\u4fee\u6539\u3002</p> </li> <li> <p>\u70e7\u5199bitstream</p> </li> </ol> <p>\u5c06<code>$REPO/pynq-z2/pynq_rocketchip_ZynqFPGAConfig/pynq_rocketchip_ZynqFPGAConfig.runs/impl_1</code>\u4e0b\u7684rocketchip_wrapper.bit.bin\u6587\u4ef6\u4f20\u8f93\u5230pynq-z1\u5f00\u53d1\u677f\u4e2d\u540e\uff0c\u6267\u884c\u70e7\u5f55\u811a\u672c\u5373\u53ef\uff0c\u5177\u4f53\u65b9\u6cd5\u5982\u4e0b\uff1a</p> <p>1\uff09\u5c06rocketchip_wrapper.bit.bin\u4f20\u8f93\u5230pynq-z1\u4e2d</p> <p>\u82e5\u4f7f\u7528sftp\u534f\u8bae\u5728\u547d\u4ee4\u884c\u4e2d\u4f20\u8f93\uff0c\u5219\u5728sftp\u4f1a\u8bdd\u4e2d\u8f93\u5165\u5982\u4e0b\u547d\u4ee4\uff1a</p> <pre><code>put [rocketchip_wrapper.bit.bin\u6240\u5728\u8def\u5f84] /home/xilinx\n</code></pre> <p>Windows\u56fe\u5f62\u754c\u9762\u4e0b\u7684\u4f20\u8f93\u65b9\u6cd5\u4e0d\u518d\u8d58\u8ff0\u3002</p> <p>\u200b   2\uff09 \u5728ssh\u4f1a\u8bdd\u4e2d\uff0c\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\uff1a</p> <pre><code>$ sudo ./program.sh  #\u5bc6\u7801\u8f93\u5165xilinx\n</code></pre> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter6_riscv_on_pynq/#_4","title":"\u5b9e\u9a8c\u7ed3\u679c","text":"<p>\u5728\u5b8c\u6210\u672c\u5b9e\u9a8c\u540e\uff0c\u4e00\u4e2a\u57fa\u7840\u7684\u84dd\u7259\u5c0f\u8f66\u6240\u9700\u8981\u7684\u786c\u4ef6\u73af\u5883\u5c31\u642d\u5efa\u5b8c\u6210\u4e86\u3002\u63a5\u4e0b\u6765\uff0c\u8bfb\u8005\u5e94\u8be5\u524d\u5f80\u7b2c\u4e03\u7ae0\u5b8c\u6210lab4_1_POLL\u5b9e\u9a8c\uff0c\u5728\u5b8c\u6210lab4_1_POLL\u5e76\u5c06riscv_pke\u4e0e\u5c0f\u8f66\u63a7\u5236\u7a0b\u5e8f\u53d1\u9001\u5230pynq-z1\u4e0a\u6267\u884c\u540e\uff0c\u5c0f\u8f66\u4fbf\u53ef\u4ee5\u901a\u8fc7\u84dd\u7259app\u8fdb\u884c\u63a7\u5236\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter6_riscv_on_pynq/#63-fpga2uart","title":"6.3 fpga\u5b9e\u9a8c2\uff1a\u4ee5\u4e2d\u65ad\u65b9\u5f0f\u5b9e\u73b0uart\u901a\u4fe1","text":"<p>\u8be5\u5b9e\u9a8c\u4ee5fpga\u5b9e\u9a8c1\u7684\u4fee\u6539\u4e3a\u57fa\u7840\uff0c\u8bfb\u8005\u53ef\u4ee5\u5148\u5c06fpga\u5b9e\u9a8c1\u4e2d\u6700\u540e\u751f\u6210\u7684<code>rocketchip_wrapper.bit.bin</code>\u6587\u4ef6\u590d\u5236\u5230\u5176\u4ed6\u76ee\u5f55\u4fdd\u5b58\uff0c\u7136\u540e\u76f4\u63a5\u5728\u540c\u4e00\u4e2a\u9879\u76ee\u6587\u4ef6\u5939\u4e0b\u7ee7\u7eed\u672c\u5b9e\u9a8c\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter6_riscv_on_pynq/#_5","title":"\u5b9e\u9a8c\u76ee\u7684","text":"<p>\u5728\u4e0a\u4e00\u4e2afpga\u5b9e\u9a8c\u4e2d\uff0c\u8bfb\u8005\u5df2\u7ecf\u4e3aRocket Chip\u6dfb\u52a0\u4e86uart\u901a\u4fe1\u529f\u80fd\uff0c\u4f46\u662f\u76ee\u524d\u5728PKE\u4e2d\u9700\u8981\u4ee5\u8f6e\u8be2\u7684\u65b9\u5f0f\u5b9e\u73b0uart\u901a\u4fe1\uff08\u8fd9\u4e00\u70b9\u8bfb\u8005\u5728\u5b8c\u6210lab4_1\u65f6\u5e94\u8be5\u6709\u6240\u4f53\u4f1a\uff0c\u7a0b\u5e8f\u9700\u8981\u4e0d\u65ad\u8bfb\u53d6\u84dd\u7259\u6a21\u5757\u7684\u72b6\u6001\u5bc4\u5b58\u5668\uff0c\u6765\u5224\u65adIO\u8bbe\u5907\u662f\u5426\u51c6\u5907\u597d\u53d1\u9001\u6216\u63a5\u6536\u6570\u636e\uff09\u3002\u672c\u5b9e\u9a8c\u5c06\u4f1a\u4e3auart\u6dfb\u52a0\u4e2d\u65ad\u673a\u5236\uff0c\u4ee5\u4e2d\u65ad\u65b9\u5f0f\u5b9e\u73b0uart\u901a\u4fe1\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter6_riscv_on_pynq/#_6","title":"\u5b9e\u9a8c\u5185\u5bb9","text":"<p>\u4ee5\u4e2d\u65ad\u65b9\u5f0f\u5b9e\u73b0uart\u901a\u4fe1</p> <p>\u8981\u60f3\u5728Rocket Chip\u4e0a\u5b9e\u73b0\u5bf9uart\u5916\u8bbe\u7684\u4e2d\u65ad\u901a\u4fe1\u652f\u6301\uff0c\u4e00\u65b9\u9762\uff0c\u9700\u8981\u901a\u8fc7\u4fee\u6539Rocket Chip\u7684\u7ed3\u6784\u6765\u4e3aRocket Chip\u6dfb\u52a0\u4e2d\u65ad\u5f15\u811a\uff0c\u53e6\u4e00\u65b9\u9762\uff0c\u9700\u8981\u4fee\u6539block design\uff0c\u5c06uart\u4ea7\u751f\u7684\u4e2d\u65ad\u4fe1\u53f7\u7ebf\u8fde\u63a5\u5230Rocket Chip\u7684\u4e2d\u65ad\u5f15\u811a\u3002</p> <p>\u4e0b\u9762\u662f\u5177\u4f53\u7684\u64cd\u4f5c\u6b65\u9aa4\uff1a</p> <p>\u9996\u5148\uff0c\u6211\u4eec\u9700\u8981\u4fee\u6539Rocket Chip\u7ed3\u6784\uff0c\u4e3a\u5176\u6dfb\u52a0\u5916\u90e8\u4e2d\u65ad\u63a5\u53e3\u3002</p> <ol> <li>\u4fee\u6539Rocket Chip\u7ed3\u6784\uff0c\u66b4\u9732\u5916\u90e8\u4e2d\u65ad\u63a5\u53e3</li> </ol> <p>\u4fee\u6539<code>$REPO/common/src/main/scala/Top.scala</code>\u6587\u4ef6\uff1a</p> <p>\u7b2c16\u884c\u52a0\u5165\uff1a</p> <pre><code>val interrupt_in = Input(UInt(2.W)) //\u7ed9rocket-chip\u589e\u52a0\u4e00\u4e2a\u4f4d\u5bbd\u4e3a2\u7684\u8f93\u5165\u7aef\u53e3\n</code></pre> <p>\u7b2c32\u884c\u52a0\u5165\uff1a</p> <pre><code>io.interrupt_in &lt;&gt; target.interrupts //\u5c06rocket-chip\u5185\u90e8\u7684\u4e2d\u65ad\u5f15\u811a\u548c\u521a\u521a\u589e\u52a0\u7684\u7aef\u53e3\u8fde\u63a5\u8d77\u6765\n</code></pre> <p>\u6ce8\u91ca\u6389\u7b2c40\u884c\uff0c\u8be5\u8bed\u53e5\u539f\u672c\u7684\u4f5c\u7528\u662f\u76f4\u63a5\u628a\u4e2d\u65ad\u5f15\u811a\u7f6e\u4e3a\u4f4e\u7535\u5e73\u4ee5\u9632\u6b62\u4e2d\u65ad\u5f15\u811a\u60ac\u7a7a\uff1a</p> <pre><code>//target.tieOffInterrupts()\n</code></pre> <p>\u8fd9\u662f\u4fee\u6539\u597d\u7684rocket-chip\u9876\u5c42\u6587\u4ef6\u3002</p> <ol> <li>\u4fee\u6539<code>$REPO/common/rocketchip_wrapper.v</code>\u6587\u4ef6</li> </ol> <p>\u6b64\u5904\u4e3b\u8981\u7684\u6539\u52a8\u662f\u5c06block design\u5f15\u51fa\u7684uart\u4e2d\u65ad\u5f15\u811a\u8fde\u63a5\u5230rocket chip\u5bf9\u5e94\u7aef\u53e3\u3002</p> <p>\u8fd9\u662f\u4fee\u6539\u597d\u7684rocketchip_wrapper.v\u6587\u4ef6\u3002</p> <p>\u4e0a\u8ff0\u6587\u4ef6\u4fee\u6539\u5b8c\u6210\u540e\uff0c\u9700\u8981\u5220\u9664\u4e4b\u524d\u7f16\u8bd1\u5de5\u7a0b\u65f6\u4ea7\u751f\u7684\u4e34\u65f6\u6587\u4ef6\uff0c\u5e76\u91cd\u65b0\u7f16\u8bd1vivado\u5de5\u7a0b\u3002\u53ea\u6709\u6267\u884c\u8be5\u6b65\u64cd\u4f5c\uff0c\u624d\u80fd\u5c06\u4e0a\u8ff0\u4fee\u6539\u5f15\u5165\u5230vivado\u5de5\u7a0b\u4e2d\u53bb\u3002</p> <ol> <li>\u91cd\u65b0\u751f\u6210vivado\u5de5\u7a0b</li> </ol> <p>\u5728Linux\u7ec8\u7aef\uff08\u6216WSL\uff09\u4e2d\u6267\u884c\u5982\u4e0b\u547d\u4ee4\uff0c\u91cd\u65b0\u751f\u6210vivado\u5de5\u7a0b\u3002\u547d\u4ee4\u6267\u884c\u5b8c\u6210\u540e\u4f1a\u81ea\u52a8\u5728vivado\u4e2d\u6253\u5f00\u9879\u76ee\u3002</p> <pre><code>$ cd $REPO/pynq-z2\n$ rm -f src/verilog/Top.ZynqFPGAConfig.v\n$ rm -f ../common/build/*\n$ make project\n</code></pre> <p>\u7136\u540e\u8981\u5c06block design\u4e2d\u7684\u4e24\u4e2aaxi uartlite IP\u6838\u7684\u4e2d\u65ad\u4fe1\u53f7\u5f15\u51fa\u3002</p> <ol> <li>\u4fee\u6539block design\uff1a</li> </ol> <p>1\uff09\u6253\u5f00vivado\u5de5\u7a0b\u540e\uff0c\u5728Sourses\u9762\u677f\u70b9\u51fbrocketchip_wrapper\u5de6\u8fb9\u7684\u52a0\u53f7\uff0c\u7136\u540e\u518d\u53cc\u51fbsystem_i\u6253\u5f00block design\u9762\u677f\u3002\u5728\u53f3\u4fa7\u7535\u8def\u56fe\u9762\u677f\u7a7a\u767d\u5904\u70b9\u51fb\u53f3\u952e\uff0c\u518d\u70b9\u51fbAdd IP...\uff0c\u7136\u540e\u8f93\u5165concat\uff0c\u7136\u540e\u53cc\u51fb\u51fa\u73b0\u7684\u641c\u7d22\u7ed3\u679c\u628aconcat\u653e\u5165\u7535\u8def\u56fe\u4e2d\uff0c\u7136\u540e\u53cc\u51fb\u65b0\u51fa\u73b0\u7684xlconcat_0\u6a21\u5757\uff0c\u5c06Number of Ports\u8bbe\u7f6e\u4e3a2\uff0cIn0 Width\u8bbe\u7f6e\u4e3a1\uff0cIn1 Width\u8bbe\u7f6e\u4e3a1\uff0c\u7136\u540e\u70b9\u51fbOK\u3002\u8be5concat IP\u6838\u7684\u4f5c\u7528\u662f\uff0c\u5c06axi_uartlite_0\u4e0eaxi_uartlite_1\u4e24\u4e2a\u6a21\u5757\u4ea7\u751f\u7684\u4e00\u4f4d\u4e2d\u65ad\u4fe1\u53f7\u8fdb\u884c\u62fc\u63a5\uff0c\u5408\u5e76\u6210\u4e00\u8def\u4f4d\u5bbd\u4e3a2\u7684\u4e2d\u65ad\u4fe1\u53f7\uff0c\u8be5\u4fe1\u53f7\u4f1a\u88ab\u8fde\u63a5\u5230\u4e0a\u6587\u4e2d\u4e3aRocket Chip\u6dfb\u52a0\u7684\u4f4d\u5bbd\u4e3a2\u7684\u4e2d\u65ad\u8f93\u5165\u7aef\u53e3\u3002</p> <p>2\uff09\u53f3\u952e\u70b9\u51fb\u7a7a\u767d\u5904\uff0c\u70b9\u51fbcreate port\uff0cport\u540d\u79f0\u586b\u5199interrupts\uff0cdirection\u9009\u62e9output\uff0ctype\u9009\u62e9interrupt\uff0c\u52fe\u9009create vector\uff0c\u586b\u5199from 1 to 0\u3002</p> <p>3\uff09\u6309\u5982\u56fe\u65b9\u5f0f\u8fde\u7ebf\uff1a</p> <p></p> <ol> <li>\u4fdd\u5b58\u6240\u6709\u4fee\u6539\u540e\u7684\u6587\u4ef6\uff08\u4e5f\u53ef\u4ee5\u9009\u62e9\u76f4\u63a5\u70b9\u51fb\u4e0b\u4e00\u6b65\u4e2d\u7684Generate Bitstream\uff0cvivado\u4f1a\u5bf9\u672a\u4fdd\u5b58\u5185\u5bb9\u5f39\u7a97\uff0c\u63d0\u9192\u7528\u6237\u4fdd\u5b58\uff0c\u8bfb\u8005\u5e94\u7559\u610f\u76f8\u5173\u5f39\u7a97\u5185\u5bb9\uff09</li> </ol> <p>\u5b8c\u6210\u6240\u6709\u7684\u4fee\u6539\u540e\uff0c\u9700\u8981\u91cd\u65b0\u8fdb\u884cbitstream\u6587\u4ef6\u7684\u751f\u6210\u4ee5\u53ca\u6253\u5305\u7684\u5de5\u4f5c\uff0c\u7136\u540e\u5c06\u65b0\u751f\u6210\u7684rocketchip_wrapper.bit.bin\u70e7\u5f55\u5230pynq-z1\u5f00\u53d1\u677f\u4e2d\u3002</p> <ol> <li>\u751f\u6210bitstream\u6587\u4ef6</li> </ol> <p>\u6700\u540e\uff0c\u70b9\u51fb\u5de6\u4e0b\u89d2\u7684Generate Bitstream\u751f\u6210\u6bd4\u7279\u6d41\u6587\u4ef6\u3002\uff08\u8be5\u6b65\u9aa4\u8017\u65f6\u8f83\u957f\uff09</p> <ol> <li> <p>\u6253\u5305bitstream\u6587\u4ef6\u4e3abin\u6587\u4ef6</p> <p>\u89c1\u4e0a\u6587fpga\u5b9e\u9a8c1 \u6b65\u9aa48\u3002\u82e5\u8bfb\u8005\u9009\u62e9\u5728\u4e0efpga\u5b9e\u9a8c1\u76f8\u540c\u7684\u9879\u76ee\u6587\u4ef6\u5939\u4e0b\u7ee7\u7eed\u5b8c\u6210\u672c\u6b21\u5b9e\u9a8c\uff0c\u5219Full_Bitstream.bif\u6587\u4ef6\u5e94\u8be5\u5df2\u7ecf\u5b58\u5728\uff0c\u90a3\u4e48\u53ef\u4ee5\u8df3\u8fc7fpga\u5b9e\u9a8c1 \u6b65\u9aa48\u4e2d\u521b\u5efaFull_Bitstream.bif\u6587\u4ef6\u7684\u6b65\u9aa4\u3002</p> </li> <li> <p>\u786c\u4ef6\u8fde\u63a5</p> </li> </ol> <p>\u672c\u6b21\u5b9e\u9a8c\u7684\u786c\u4ef6\u8fde\u63a5\u4e0efpga\u5b9e\u9a8c1\u5b8c\u5168\u76f8\u540c\uff0c\u8bfb\u8005\u540c\u6837\u9700\u8981\u6309\u71676.1.4\u8282\u7684\u8bf4\u660e\u5b8c\u6210\u84dd\u7259\u5c0f\u8f66\u7684\u786c\u4ef6\u7ec4\u88c5\u3002</p> <ol> <li>\u64cd\u4f5c\u7cfb\u7edf\u7684\u66ff\u6362\u4fee\u6539</li> </ol> <p>\u82e5\u5728\u8fdb\u884c\u672c\u6b21\u5b9e\u9a8c\u65f6\uff0cpynq-z1\u5f00\u53d1\u677f\u4e2d\u63d2\u5165\u7684sd\u5361\u4e0efpga\u5b9e\u9a8c1\u4e2d\u76f8\u540c\uff0c\u4e14\u6ca1\u6709\u5220\u9664\u8fc7fpga\u5b9e\u9a8c1\u4e2d\u521b\u5efa\u7684\u76f8\u5173\u6587\u4ef6\uff0c\u5219\u8be5\u6b65\u9aa4\u53ef\u4ee5\u76f4\u63a5\u8df3\u8fc7\u3002\u5426\u5219\uff0c\u8bfb\u8005\u5e94\u53c2\u80036.1.5\u8282\u4e2d\u7684\u8bf4\u660e\u91cd\u65b0\u4e3asd\u5361\u5199\u5165\u64cd\u4f5c\u7cfb\u7edf\uff0c\u5e76\u5b8c\u6210\u76f8\u5173\u6587\u4ef6\u7684\u66ff\u6362\u548c\u4fee\u6539\u3002</p> <ol> <li>\u70e7\u5199bitstream</li> </ol> <p>\u89c1\u4e0a\u6587fpga\u5b9e\u9a8c1 \u6b65\u9aa411\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter6_riscv_on_pynq/#_7","title":"\u5b9e\u9a8c\u7ed3\u679c","text":"<p>\u5728\u5b8c\u6210\u672c\u5b9e\u9a8c\u540e\uff0c\u5f53\u84dd\u7259\u6a21\u5757\u5728\u6536\u5230\u84dd\u7259\u4e32\u53e3app\u53d1\u9001\u7684\u6307\u4ee4\u65f6\uff0c\u4f1a\u4ea7\u751f\u4e00\u4e2a\u5916\u90e8\u4e2d\u65ad\uff0c\u8be5\u4e2d\u65ad\u80fd\u591f\u5728\u540e\u7eed\u7684PKE\u5b9e\u9a8c\u4e2d\u88ab\u64cd\u4f5c\u7cfb\u7edf\u6240\u6355\u83b7\uff0c\u5e76\u505a\u51fa\u76f8\u5e94\u7684\u53cd\u5e94\uff08\u5982\u5524\u9192\u4e00\u4e2a\u5904\u4e8e\u963b\u585e\u72b6\u6001\u7684\u8fdb\u7a0b\uff09\u3002\u8bfb\u8005\u5728\u5b8c\u6210\u672c\u6b21fpga\u5b9e\u9a8c\u540e\uff0c\u5e94\u8be5\u524d\u5f80\u7b2c\u4e03\u7ae0\u5b8c\u6210PKE\u5b9e\u9a8clab4_2_PLIC\uff0c\u8be5\u5b9e\u9a8c\u4f1a\u901a\u8fc7\u4e2d\u65ad\u7684\u65b9\u5f0f\u6765\u901a\u8fc7\u5916\u8bbe\u5411\u84dd\u7259\u5c0f\u8f66\u53d1\u9001\u63a7\u5236\u6307\u4ee4\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter6_riscv_on_pynq/#64-fpga3psusb","title":"6.4 fpga\u5b9e\u9a8c3\uff1a\u914d\u7f6e\u8fde\u63a5\u5230PS\u7aef\u7684USB\u8bbe\u5907","text":"<p>\u8be5\u5b9e\u9a8c\u4ee5fpga\u5b9e\u9a8c2\u7684\u4fee\u6539\u4e3a\u57fa\u7840\uff0c\u8bfb\u8005\u53ef\u4ee5\u5148\u5c06fpga\u5b9e\u9a8c2\u4e2d\u6700\u540e\u751f\u6210\u7684<code>rocketchip_wrapper.bit.bin</code>\u6587\u4ef6\u590d\u5236\u5230\u5176\u4ed6\u76ee\u5f55\u4fdd\u5b58\uff0c\u7136\u540e\u76f4\u63a5\u5728\u540c\u4e00\u4e2a\u9879\u76ee\u6587\u4ef6\u5939\u4e0b\u5f00\u59cb\u672c\u5b9e\u9a8c\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter6_riscv_on_pynq/#_8","title":"\u5b9e\u9a8c\u76ee\u7684","text":"<p>\u8bfb\u8005\u5728\u5b8c\u6210fpga\u5b9e\u9a8c1\u4e0efpga\u5b9e\u9a8c2\uff0c\u4ee5\u53ca\u7b2c\u4e03\u7ae0\u4e2d\u5bf9\u5e94\u7684PKE\u5b9e\u9a8clab4_1 POLL\u548clab4_2_PLIC\u540e\uff0c\u4fbf\u80fd\u5f97\u5230\u4e00\u4e2a\u53ef\u4ee5\u901a\u8fc7\u84dd\u7259\u4e32\u53e3\u52a9\u624b\u8fdb\u884c\u63a7\u5236\u7684\u84dd\u7259\u5c0f\u8f66\u3002\u8be5\u84dd\u7259\u5c0f\u8f66\u901a\u8fc7uart\u63a5\u53e3\u83b7\u53d6\u6765\u81ea\u624b\u673a\u6216\u5176\u4ed6\u84dd\u7259\u8bbe\u5907\u7684\u63a7\u5236\u6307\u4ee4\uff0c\u5e76\u6839\u636e\u6536\u5230\u7684\u4e0d\u540c\u6307\u4ee4\uff0c\u9009\u62e9\u505a\u51fa\u524d\u8fdb\u3001\u540e\u9000\u3001\u5de6\u8f6c\u548c\u53f3\u8f6c\u52a8\u4e4b\u4e00\u3002\u5728\u8fd9\u4e2a\u63a7\u5236\u8fc7\u7a0b\u4e2d\uff0c\u63a5\u6536\u63a7\u5236\u4fe1\u53f7\u7684\u84dd\u7259\u6a21\u5757\u548c\u53d1\u51fa\u63a7\u5236\u6307\u4ee4\u7684\u7535\u673a\u9a71\u52a8\u6a21\u5757\u90fd\u662f\u8fde\u63a5\u5728PL\u7aef\u7684\u8bbe\u5907\uff08\u6240\u8c13PL\u7aef\uff0c\u5373\u4e3apynq\u5f00\u53d1\u677f\u4e0a\u642d\u8f7d\u7684\u4e00\u5757FPGA\u53ef\u7f16\u7a0b\u82af\u7247\uff0c\u5728fpga\u5b9e\u9a8c\u4e2d\u751f\u6210\u7684\u6bd4\u7279\u6d41\u6587\u4ef6\u90fd\u9700\u8981\u70e7\u5f55\u5230PL\u7aef\uff0c\u4f7f\u5176\u80fd\u591f\u652f\u6301riscv-pke\u7684\u8fd0\u884c\uff0c\u5728\u7b2c7\u7ae0\u4f1a\u6709\u5173\u4e8ePL\u7aef\u4e0ePS\u7aef\u66f4\u8be6\u7ec6\u7684\u4ecb\u7ecd\uff09\u3002\u8fde\u63a5\u5728PL\u7aef\u7684\u8bbe\u5907\u901a\u5e38\u529f\u80fd\u6bd4\u8f83\u7b80\u5355\uff0c\u53ef\u4ee5\u7531PKE\u76f4\u63a5\u8fdb\u884c\u8bbf\u95ee\u63a7\u5236\u3002\u800c\u5176\u4ed6\u4e00\u4e9b\u529f\u80fd\u66f4\u52a0\u590d\u6742\u7684\u5916\u8bbe\uff0c\u4f8b\u5982USB\u6444\u50cf\u5934\uff0c\u5219\u88ab\u8fde\u63a5\u5230PS\u7aef\u3002\u8fd0\u884c\u5728PL\u7aef\u7684PKE\u5728\u8bbf\u95eePS\u7aef\u7684USB\u8bbe\u5907\u65f6\uff0c\u9700\u8981\u901a\u8fc7HTIF\u534f\u8bae\u6765\u8c03\u7528ARM\u7aef\u7684\u7cfb\u7edf\u8c03\u7528\u51fd\u6570\uff0c\u5229\u7528\u529f\u80fd\u66f4\u52a0\u5b8c\u6574\u7684PS\u7aef\u64cd\u4f5c\u7cfb\u7edf\u5bf9\u5176\u8fdb\u884c\u8bbf\u95ee\u63a7\u5236\u3002</p> <p>\u672c\u5b9e\u9a8c\u7684\u76ee\u7684\u662f\u5bf9\u8fde\u63a5\u5230PS\u7aef\u7684USB\u8bbe\u5907\u8fdb\u884c\u4e00\u4e9b\u914d\u7f6e\uff0c\u4fbf\u4e8eUSB\u6444\u50cf\u5934\u7684\u8fde\u63a5\u3002\u5728\u5bf9\u5e94\u7684\u7b2c\u4e03\u7ae0lab4_3_hostdevice\u4e2d\uff0c\u6211\u4eec\u8981\u4e3a\u84dd\u7259\u5c0f\u8f66\u8fde\u63a5\u4e00\u4e2aUSB\u6444\u50cf\u5934\uff0c\u8ba9\u5c0f\u8f66\u6839\u636e\u6444\u50cf\u5934\u62cd\u6444\u7684\u753b\u9762\u8bc6\u522b\u524d\u65b9\u51fa\u73b0\u7684\u969c\u788d\u7269\uff0c\u5e76\u505a\u51fa\u81ea\u52a8\u907f\u969c\u52a8\u4f5c\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter6_riscv_on_pynq/#_9","title":"\u5b9e\u9a8c\u5185\u5bb9","text":"<p>\u914d\u7f6e\u8fde\u63a5\u5230PS\u7aef\u7684USB\u8bbe\u5907</p> <p>zynq\u7684PS\u7aef\u5916\u8bbe\u90fd\u88ab\u5c01\u88c5\u6210\u4e86\u4e00\u4e2aZYNQ7 Processing System IP\u6838\uff0c\u56e0\u6b64\uff0c\u4fee\u6539PS\u7aef\u7684USB\u5916\u8bbe\u8fde\u63a5\u9700\u8981\u901a\u8fc7\u914d\u7f6e\u8be5IP\u6838\u8fdb\u884c\u3002</p> <p>\u4e0b\u9762\u662f\u5177\u4f53\u7684\u64cd\u4f5c\u6b65\u9aa4\uff1a</p> <p>\u8be5\u5b9e\u9a8c\u7684\u64cd\u4f5c\u6b65\u9aa4\u6bd4\u8f83\u7b80\u5355\uff0c\u53ea\u9700\u8981\u5728vivado\u7684\u56fe\u5f62\u754c\u9762\u4e2d\u5bf9PS\u7aef\u7684USB\u5916\u8bbe\u8fdb\u884c\u4e00\u4e9b\u914d\u7f6e\u540e\uff0c\u91cd\u65b0\u751f\u6210bitstream\u6587\u4ef6\u5373\u53ef\u3002</p> <ol> <li>\u4fee\u6539block design\uff1a</li> </ol> <p>\u6253\u5f00vivado\u5de5\u7a0b\u540e\uff0c\u5728Sourses\u9762\u677f\u70b9\u51fbrocketchip_wrapper\u5de6\u8fb9\u7684\u52a0\u53f7\uff0c\u7136\u540e\u518d\u53cc\u51fbsystem_i\u6253\u5f00block design\u9762\u677f\u3002\u53cc\u51fbprocessing_system7_0\u8fdb\u5165PS\u7aefARM\u6838\u7684\u914d\u7f6e\u754c\u9762\uff0c\u5982\u4e0b\u56fe\u3002</p> <p></p> <p></p> <p>\u70b9\u51fb\u8be5\u7a97\u53e3\u5de6\u4fa7\u7684MIO Configuration\uff0c\u4e4b\u540e\u6211\u4eec\u53ef\u4ee5\u5728\u53f3\u4fa7\u7684\u754c\u9762\u4e2d\u5c06\u9700\u8981\u4f7f\u7528\u7684PS\u7aef\u5916\u8bbe\u4e0e\u590d\u7528IO\u76f8\u8fde\uff0c\u5e76\u914d\u7f6eMIO\u7684\u7535\u5e73\u6807\u51c6\u3002</p> <p>\u6309\u5982\u4e0b\u56fe\u793a\u70b9\u51fb\uff0c\u9996\u5148\u786e\u4fddUSB 0\u524d\u7684\u590d\u9009\u6846\u5904\u4e8e\u52fe\u9009\u72b6\u6001\uff0c\u7136\u540e\u5c06USB\u768412\u4e2a\u7ba1\u811a\u7684speed\u5c5e\u6027\u7531slow\u6539\u4e3afast\uff0c\u4fee\u6539\u5b8c\u6210\u540e\u70b9\u51fbOK\u4fdd\u5b58\u5e76\u5173\u95ed\u7a97\u53e3\u3002</p> <p></p> <ol> <li>\u751f\u6210bitstream\u6587\u4ef6</li> </ol> <p>\u6700\u540e\uff0c\u70b9\u51fb\u5de6\u4e0b\u89d2\u7684Generate Bitstream\u751f\u6210\u6bd4\u7279\u6d41\u6587\u4ef6\u3002\uff08\u8be5\u6b65\u9aa4\u8017\u65f6\u8f83\u957f\uff09</p> <ol> <li>\u6253\u5305bitstream\u6587\u4ef6\u4e3abin\u6587\u4ef6</li> </ol> <p>\u89c1\u4e0a\u6587fpga\u5b9e\u9a8c1 \u6b65\u9aa48\u3002</p> <ol> <li>\u786c\u4ef6\u8fde\u63a5</li> </ol> <p>\u5728\u5b8c\u62106.1.4\u8282\u4e2d\u786c\u4ef6\u8fde\u63a5\u7684\u57fa\u7840\u4e4b\u4e0a\uff0c\u8fd8\u9700\u8981\u5c06USB\u6444\u50cf\u5934\u8fde\u63a5\u5230pynq-z1\u5f00\u53d1\u677f\u5de6\u4e0a\u89d2\u7684USB\u63a5\u53e3\uff0c\u5e76\u5c06USB\u6444\u50cf\u5934\u56fa\u5b9a\u5728\u5c0f\u8f66\u524d\u65b9\uff08\u6307\u524d\u8fdb\u65b9\u5411\uff09\uff0c\u56fa\u5b9a\u65f6\u5efa\u8bae\u5c06\u6444\u50cf\u5934\u7565\u5fae\u5411\u4e0a\u503e\u659c\u3002\u53e6\u5916\u9700\u8981\u6ce8\u610f\u7684\u662f\uff0c\u4e3a\u4e86\u4e0e\u7b2c\u4e03\u7ae0\u4e2dlab4_3_hostdevice\u7684\u4ee3\u7801\u76f8\u5339\u914d\uff0c\u8fd9\u91cc\u8fde\u63a5\u7684\u6444\u50cf\u5934\u5fc5\u987b\u652f\u6301YUYV\u683c\u5f0f\u7684\u753b\u9762\u8f93\u51fa\u3002</p> <ol> <li>\u64cd\u4f5c\u7cfb\u7edf\u7684\u66ff\u6362\u4fee\u6539</li> </ol> <p>\u82e5\u5728\u8fdb\u884c\u672c\u6b21\u5b9e\u9a8c\u65f6\uff0cpynq-z1\u5f00\u53d1\u677f\u4e2d\u63d2\u5165\u7684sd\u5361\u4e0efpga\u5b9e\u9a8c1\u4e2d\u76f8\u540c\uff0c\u4e14\u6ca1\u6709\u5220\u9664\u8fc7fpga\u5b9e\u9a8c1\u4e2d\u521b\u5efa\u7684\u76f8\u5173\u6587\u4ef6\uff0c\u5219\u8be5\u6b65\u9aa4\u53ef\u4ee5\u76f4\u63a5\u8df3\u8fc7\u3002\u5426\u5219\uff0c\u8bfb\u8005\u5e94\u53c2\u80036.1.5\u8282\u4e2d\u7684\u8bf4\u660e\u91cd\u65b0\u4e3asd\u5361\u5199\u5165\u64cd\u4f5c\u7cfb\u7edf\u5e76\u5b8c\u6210\u76f8\u5173\u6587\u4ef6\u7684\u66ff\u6362\u548c\u4fee\u6539\u3002</p> <ol> <li>\u70e7\u5199bitstream</li> </ol> <p>\u89c1\u4e0a\u6587fpga\u5b9e\u9a8c1 \u6b65\u9aa411\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter6_riscv_on_pynq/#_10","title":"\u5b9e\u9a8c\u7ed3\u679c","text":"<p>\u5728\u5b8c\u6210\u672c\u6b21\u5b9e\u9a8c\u540e\uff0cUSB\u6444\u50cf\u5934\u4fbf\u53ef\u4ee5\u6b63\u786e\u7684\u8fde\u63a5\u5230\u5f00\u53d1\u677f\u7684PS\u7aef\u3002\u8bfb\u8005\u63a5\u4e0b\u6765\u5e94\u8be5\u524d\u5f80\u7b2c\u4e03\u7ae0\u7ee7\u7eed\u5b8c\u6210lab4_3_hostdevice\uff0c\u5728\u5b8c\u6210lab4_3_hostdevice\u4e2dPKE\u76f8\u5173\u4ee3\u7801\u7684\u4fee\u6539\u540e\uff0c\u8fde\u63a5\u5230PS\u7aef\u7684USB\u5916\u8bbe\u4fbf\u53ef\u4ee5\u88ab\u8fd0\u884c\u5728PL\u7aef\u7684PKE\u8c03\u7528\uff0c\u4ece\u800c\u5728\u6b64\u57fa\u7840\u4e0a\u8fdb\u4e00\u6b65\u4e3a\u84dd\u7259\u5c0f\u8f66\u589e\u6dfb\u81ea\u52a8\u907f\u969c\u7684\u529f\u80fd\u3002</p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter7_device/","title":"Chapter7 device","text":""},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter7_device/#4riscv-on-pynq","title":"\u7b2c\u4e03\u7ae0\uff0e\u5b9e\u9a8c4\uff1a\u8bbe\u5907\u7ba1\u7406\uff08\u57fa\u4e8eRISCV-on-PYNQ\uff09","text":""},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter7_device/#_1","title":"\u76ee\u5f55","text":"<ul> <li>7.1 \u5b9e\u9a8c4\u7684\u57fa\u7840\u77e5\u8bc6 </li> <li>7.1.1  pynq\u5f00\u53d1\u677f\u4ecb\u7ecd</li> <li>7.1.2  \u5185\u5b58\u6620\u5c04I/O(MMIO) </li> <li>7.1.3  riscv-fesvr\u539f\u7406</li> <li>7.1.4  \u8f6e\u8be2I/O\u63a7\u5236\u65b9\u5f0f</li> <li>7.1.5 \u4e2d\u65ad\u9a71\u52a8I/O\u63a7\u5236\u65b9\u5f0f </li> <li>7.1.6 \u8bbe\u5907\u6587\u4ef6</li> <li>7.2 lab4_1 POLL </li> <li>\u7ed9\u5b9a\u5e94\u7528</li> <li>\u5b9e\u9a8c\u5185\u5bb9</li> <li>\u5b9e\u9a8c\u6307\u5bfc</li> <li>7.3 lab4_2_PLIC </li> <li>\u7ed9\u5b9a\u5e94\u7528</li> <li>\u5b9e\u9a8c\u5185\u5bb9</li> <li>\u5b9e\u9a8c\u6307\u5bfc</li> <li>7.4 lab4_3_hostdevice </li> <li>\u7ed9\u5b9a\u5e94\u7528</li> <li>\u5b9e\u9a8c\u5185\u5bb9</li> <li>\u5b9e\u9a8c\u6307\u5bfc</li> </ul>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter7_device/#71-4","title":"7.1 \u5b9e\u9a8c4\u7684\u57fa\u7840\u77e5\u8bc6","text":"<p>\u5b8c\u6210\u524d\u9762\u6240\u6709\u5b9e\u9a8c\u540e\uff0cPKE\u5185\u6838\u7684\u6574\u4f53\u529f\u80fd\u5df2\u7ecf\u5f97\u5230\u5b8c\u5584\u3002\u5728\u5b9e\u9a8c\u56db\u7684\u8bbe\u5907\u5b9e\u9a8c\u4e2d\uff0c\u6211\u4eec\u5c06\u7ed3\u5408fpga-pynq\u677f\uff0c\u5728rocket chip\u4e0a\u589e\u52a0uart\u6a21\u5757\u548c\u84dd\u7259\u6a21\u5757\uff0c\u5e76\u642d\u8f7dPKE\u5185\u6838\uff0c\u5b9e\u73b0\u84dd\u7259\u901a\u4fe1\u63a7\u5236\u667a\u80fd\u5c0f\u8f66\uff0c\u8bbe\u8ba1\u8bbe\u5907\u7ba1\u7406\u7684\u76f8\u5173\u5b9e\u9a8c\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter7_device/#711-pynq","title":"7.1.1 pynq\u5f00\u53d1\u677f\u4ecb\u7ecd","text":"<p>\u672c\u5b9e\u9a8c\u4e2d\uff0c\u6211\u4eec\u6240\u4f7f\u7528\u7684pynq-z2\u5f00\u53d1\u677f\u4e0a\u642d\u8f7d\u4e24\u5757\u82af\u7247\uff0c\u4e00\u5757\u4e3aArm\u67b6\u678432\u4f4d\u82af\u7247\uff0c\u79f0\u4e3aPS\u7aef\uff0c\u6211\u4eec\u80fd\u5728\u4e0a\u9762\u8fd0\u884cUbuntu\uff1b\u53e6\u4e00\u5757\u4e3aFPGA\u53ef\u7f16\u7a0b\u82af\u7247\uff0c\u79f0\u4e3aPL\u7aef\uff0c\u901a\u8fc7\u70e7\u5f55Rocket chip\u7535\u8def\uff0c\u4f7f\u5b83\u80fd\u591f\u8fd0\u884cRiscv\u67b6\u6784\u7684\u64cd\u4f5c\u7cfb\u7edf\uff0c\u5373riscv-pke\u3002</p> <p></p> <p>\u5982\u4e0a\u56fe\uff0c\u5728\u5f00\u53d1\u677f\u4e0a\u8fd0\u884c\u7684\u65f6\u5019\uff0cPKE\u5728PL\u7aef\u8fd0\u884c\uff0c\u4e00\u65b9\u9762\u5b83\u53ef\u4ee5\u901a\u8fc7Rocket Chip\u7535\u8def\u7684\u8fde\u7ebf\u8bbf\u95eePL\u7aef\u7684\u8bbe\u5907\uff08device\uff09\uff0c\u5982\u84dd\u7259\u3001\u5c0f\u8f66\u7535\u673a\u7b49\uff1b\u53e6\u4e00\u65b9\u9762\uff0c\u5728PS\u7aef\u8fd0\u884c\u7684riscv-fesvr\u7a0b\u5e8f\u53ef\u4ee5\u548cPKE\u901a\u8fc7HTIF\u534f\u8bae\u901a\u4fe1\uff0c\u4f7f\u5f97PKE\u53ef\u4ee5\u8bfb\u5199PS\u7aefLinux\u64cd\u4f5c\u7cfb\u7edf\u4e0b\u7684\u8bbe\u5907\u6587\u4ef6\uff08host device\uff09\uff0c\u6bd4\u5982\u6444\u50cf\u5934\u3001\u58f0\u5361\u7b49\u3002\u4e5f\u5c31\u662f\u8bf4\uff0cPKE\u9664\u4e86\u53ef\u4ee5\u8bbf\u95ee\u672c\u8eab\u7684\u8bbe\u5907\uff0c\u8fd8\u53ef\u4ee5\u5229\u7528PS\u7aef\u64cd\u4f5c\u7cfb\u7edf\u7684\u529f\u80fd\u8bbf\u95ee\u66f4\u590d\u6742\u7684\u8bbe\u5907\uff0c\u8fd9\u5c31\u662f\u4ee3\u7406\u5185\u6838\u7684\u7279\u70b9\u3002</p> <p>\u5b9e\u9a8c\u56db\u548c\u524d\u4e09\u4e2a\u5b9e\u9a8c\u7684\u5173\u7cfb\u5982\u4e0b\uff1a</p> <p></p> <p>\u53ef\u89c1\u9664\u4e86\u90e8\u5206\u786c\u4ef6\u76f8\u5173\u7684\u64cd\u4f5c\u5916\uff0cPKE\u5728Spike\u548c\u5f00\u53d1\u677f\u4e0a\u7684\u8fd0\u884c\u662f\u5b8c\u5168\u7b49\u4ef7\u7684\uff0c\u4ee3\u7406\u5185\u6838\u4e00\u65b9\u9762\u8ba9\u6211\u4eec\u53ef\u4ee5\u7528\u6700\u7b80\u5355\u7684\u65b9\u6cd5\u8bbf\u95ee\u4e24\u7aef\u7684\u8bbe\u5907\uff0c\u53e6\u4e00\u65b9\u9762\u5728\u4e0d\u540c\u5730\u65b9\u8fd0\u884c\u57fa\u672c\u4e0d\u7528\u6539\u592a\u591a\u4ee3\u7801\uff0c\u975e\u5e38\u4f18\u8d8a\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter7_device/#712-iommio","title":"7.1.2 \u5185\u5b58\u6620\u5c04I/O(MMIO)","text":"<p>\u5185\u5b58\u6620\u5c04(Memory-Mapping I/O)\u662f\u4e00\u79cd\u7528\u4e8e\u8bbe\u5907\u9a71\u52a8\u7a0b\u5e8f\u548c\u8bbe\u5907\u901a\u4fe1\u7684\u65b9\u5f0f\uff0c\u5b83\u533a\u522b\u4e8e\u57fa\u4e8eI/O\u7aef\u53e3\u63a7\u5236\u7684Port I/O\u65b9\u5f0f\u3002RICSV\u6307\u4ee4\u7cfb\u7edf\u7684CPU\u901a\u5e38\u53ea\u5b9e\u73b0\u4e00\u4e2a\u7269\u7406\u5730\u5740\u7a7a\u95f4\uff0c\u8fd9\u79cd\u60c5\u51b5\u4e0b\uff0c\u5916\u8bbeI/O\u7aef\u53e3\u7684\u7269\u7406\u5730\u5740\u5c31\u88ab\u6620\u5c04\u5230CPU\u4e2d\u5355\u4e00\u7684\u7269\u7406\u5730\u5740\u7a7a\u95f4\uff0c\u6210\u4e3a\u5185\u5b58\u7684\u4e00\u90e8\u5206\uff0cCPU\u53ef\u4ee5\u50cf\u8bbf\u95ee\u4e00\u4e2a\u5185\u5b58\u5355\u5143\u90a3\u6837\u8bbf\u95ee\u5916\u8bbeI/O\u7aef\u53e3\uff0c\u800c\u4e0d\u9700\u8981\u8bbe\u7acb\u4e13\u95e8\u7684\u5916\u8bbeI/O\u6307\u4ee4\u3002</p> <p>\u5728MMIO\u4e2d\uff0c\u5185\u5b58\u548cI/O\u8bbe\u5907\u5171\u4eab\u540c\u4e00\u4e2a\u5730\u5740\u7a7a\u95f4\u3002MMIO\u662f\u5e94\u7528\u5f97\u6700\u4e3a\u5e7f\u6cdb\u7684\u4e00\u79cdIO\u65b9\u6cd5\uff0c\u5b83\u4f7f\u7528\u76f8\u540c\u7684\u5730\u5740\u603b\u7ebf\u6765\u5904\u7406\u5185\u5b58\u548cI/O\u8bbe\u5907\uff0cI/O\u8bbe\u5907\u7684\u5185\u5b58\u548c\u5bc4\u5b58\u5668\u88ab\u6620\u5c04\u5230\u4e0e\u4e4b\u76f8\u5173\u8054\u7684\u5730\u5740\u3002\u5f53CPU\u8bbf\u95ee\u67d0\u4e2a\u5185\u5b58\u5730\u5740\u65f6\uff0c\u5b83\u53ef\u80fd\u662f\u7269\u7406\u5185\u5b58\uff0c\u4e5f\u53ef\u4ee5\u662f\u67d0\u4e2aI/O\u8bbe\u5907\u7684\u5185\u5b58\u3002\u6b64\u65f6\uff0c\u7528\u4e8e\u8bbf\u95ee\u5185\u5b58\u7684CPU\u6307\u4ee4\u5c31\u53ef\u4ee5\u7528\u6765\u8bbf\u95eeI/O\u8bbe\u5907\u3002\u6bcf\u4e2aI/O\u8bbe\u5907\u76d1\u89c6CPU\u7684\u5730\u5740\u603b\u7ebf\uff0c\u4e00\u65e6CPU\u8bbf\u95ee\u5206\u914d\u7ed9\u5b83\u7684\u5730\u5740\uff0c\u5b83\u5c31\u505a\u51fa\u54cd\u5e94\uff0c\u5c06\u6570\u636e\u603b\u7ebf\u8fde\u63a5\u5230\u9700\u8981\u8bbf\u95ee\u7684\u8bbe\u5907\u786c\u4ef6\u5bc4\u5b58\u5668\u3002\u4e3a\u4e86\u5bb9\u7eb3I/O\u8bbe\u5907\uff0cCPU\u5fc5\u987b\u9884\u7559\u7ed9I/O\u4e00\u4e2a\u5730\u5740\u6620\u5c04\u533a\u57df\u3002</p> <p>\u5728\u672c\u7ae0\u8282\u4e2d\uff0c\u4fee\u6539\u540e\u7684RocketChip\u5c06\u84dd\u7259\u63a7\u5236\u5bc4\u5b58\u5668\u548c\u5c0f\u8f66\u7535\u673a\u7aef\u63a5\u5230\u56fa\u5b9a\u7684\u5185\u5b58\u5730\u5740\uff0c\u56e0\u6b64\u53ef\u4ee5\u901a\u8fc7\u5bf9\u8fd9\u4e9b\u5730\u5740\u8fdb\u884c\u8bfb\u5199\u63a7\u5236\u84dd\u7259\u548c\u5c0f\u8f66\u7535\u673a\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter7_device/#713-riscv-fesvr","title":"7.1.3 riscv-fesvr\u539f\u7406","text":"<p>riscv-fesvr\u662fPKE\u5728PYNQ\u5f00\u53d1\u677f\u4e0a\u4f7f\u7528\u7684\u91cd\u8981\u5de5\u5177\uff0c\u5b83\u662fARM\u7aef\u7cfb\u7edf\u4e0a\u8fd0\u884c\u7684\u7a0b\u5e8f\uff0c\u63a7\u5236PKE\u7684\u542f\u52a8\u3002\u9664\u4e86\u542f\u52a8\u529f\u80fd\uff0criscv-fesvr\u7a0b\u5e8f\u4e3b\u8981\u5206\u4e3a\u4e24\u4e2a\u6a21\u5757\uff0c\u7cfb\u7edf\u8c03\u7528\u6a21\u5757\u5757\u8d1f\u8d23\u63a5\u53d7PKE\u5bf9ARM\u7aef\u7684\u7cfb\u7edf\u8c03\u7528\u8bf7\u6c42\uff0c\u5728ARM\u7aef\u6267\u884c\u8fd9\u4e9b\u51fd\u6570\uff1b\u5185\u5b58\u6a21\u5757\u8d1f\u8d23\u8bfb\u5199RISCV\u7aef\u7684\u5185\u5b58\uff0c\u548cPKE\u4ea4\u6362\u6570\u636e\u3002</p> <p>PKE\u8c03\u7528\u5bbf\u4e3b\u673a/\u5f00\u53d1\u677fARM\u7aef\u7684\u7cfb\u7edf\u8c03\u7528\u51fd\u6570\u4f7f\u7528\u7684\u662fHTIF\u534f\u8bae\u3002\u534f\u8bae\u8981\u6c42\u5185\u6838\u4fdd\u7559\u4e24\u4e2a\u5730\u5740\uff0c\u4f5c\u4e3a\u548criscv-fesvr\u5171\u4eab\u6570\u636e\u7684\u5730\u65b9\u3002PKE\u8981\u4f7f\u7528\u7cfb\u7edf\u8c03\u7528\u51fd\u6570\uff0c\u5c31\u9700\u8981\u5c06\u7cfb\u7edf\u8c03\u7528\u51fd\u6570\u7684\u7f16\u53f7\u548c\u53c2\u6570\u901a\u8fc7\u8fd9\u4e2a\u5730\u5740\u53d1\u9001\u7ed9riscv-fesvr\uff0c\u65b9\u6cd5\u662f\u5b9a\u4e49\u4e00\u4e2a\u6570\u7ec4magic_mem\uff0c\u8be5\u6570\u7ec4\u5b58\u50a8\u4e86\u8c03\u7528\u53f7\u548c\u53c2\u6570\uff0c\u518d\u5c06\u6570\u7ec4\u7684\u8d77\u59cb\u5730\u5740\u6309\u4e00\u5b9a\u7684\u683c\u5f0f\u586b\u5165\u8fd9\u4e2a\u5730\u5740\u4e2d\uff0c\u5982\u4e0b\u56fe\u3002</p> <p></p> <p>\u6253\u4e2a\u6bd4\u65b9\uff0c\u6211\u901a\u8fc7HTIF\u534f\u8bae\u8c03\u7528ARM\u7aef\u7684write\u51fd\u6570\uff0c\u90a3\u4e48\u6211\u5148\u5b9a\u4e49\u4e00\u4e2a\u6570\u7ec4magic_mem\uff0cmagic_mem[0]\u4e3awrite\u7684\u7cfb\u7edf\u8c03\u7528\u53f7\uff0cmagic_mem[1]\u4e3a\u6587\u4ef6\u63cf\u8ff0\u7b26\uff0cmagic_mem[2]\u4e3a\u7f13\u51b2\u533a\u5730\u5740\uff0cmagic_mem[3]\u4e3a\u5199\u5165\u957f\u5ea6\u3002\u7136\u540e\u628a\u4e00\u4e2a\u6570\u5199\u5165\u5171\u4eab\u5730\u5740\uff0c\u8fd9\u4e2a\u6570\u9ad88\u4f4d\u548c\u4e2d\u95f48\u4f4d\u90fd\u662f0\uff0c\u4f4e48\u4f4d\u4e3amagic_mem\u7684\u5730\u5740\u3002riscv-fesvr\u4f1a\u9996\u5148\u8bfb\u51famagic_mem\u91cc\u7684\u6570\u636e\uff0c\u7136\u540e\u6839\u636emagic_mem[0]\u51b3\u5b9a\u8981\u8c03\u7528write\u51fd\u6570\uff0c\u8fd9\u65f6\u9700\u8981\u6ce8\u610fmagic_mem[2]\u91cc\u7684\u7f13\u51b2\u533a\u5730\u5740\u662fRISCV\u7aef\u5185\u5b58\u7684\u5730\u5740\uff0c\u6240\u4ee5\u5148\u628aRISCV\u7aef\u5185\u5b58\u91cc\u7684\u8fd9\u6bb5\u6570\u636e\u8bfb\u5230\u5916\u9762\u5185\u5b58\uff0c\u518d\u4ee5\u5916\u9762\u5185\u5b58\u5730\u5740\u4e3a\u53c2\u6570\u8c03\u7528write\u51fd\u6570\u3002</p> <p>riscv-fesvr\u7684\u5185\u5b58\u6a21\u5757\u7528\u6765\u8bfb\u5199RISCV\u7aef\u7684\u5185\u5b58\uff0c\u4ece\u800c\u53ef\u4ee5\u8bfb\u53d6\u7cfb\u7edf\u8c03\u7528\u53c2\u6570\u4ee5\u53ca\u8bfb\u5199PKE\u7684\u7f13\u51b2\u533a\u3002Pynq\u5f00\u53d1\u677f\u628aRISCV\u7aef\u7684\u5185\u5b58\u62bd\u8c61\u6210\u8bbe\u5907\u6587\u4ef6/dev/mem\uff0c\u6240\u4ee5\u5185\u5b58\u6a21\u5757\u53ef\u4ee5\u901a\u8fc7\u5728\u56fa\u5b9a\u504f\u79fb\u91cf\u8bfb\u5199\u8be5\u6587\u4ef6\uff0c\u4ece\u800c\u5b9e\u73b0\u8bfb\u5199\u5185\u5b58\u3002</p> <p>\u53e6\u5916\uff0c\u63a7\u5236\u6444\u50cf\u5934\u9700\u8981\u7528\u5230\u7684ioctl\u3001mmap\u3001munmap\u4e09\u4e2a\u7cfb\u7edf\u8c03\u7528\u51fd\u6570\u662f\u539f\u7248\u7684riscv-fesvr\u4e0d\u652f\u6301\u7684\uff0c\u6240\u4ee5\u6211\u4eec\u5bf9riscv-fesvr\u7684\u7cfb\u7edf\u8c03\u7528\u6a21\u5757\u8fdb\u884c\u4e86\u4fee\u6539\uff1a</p> <ul> <li>ioctl\u51fd\u6570\u6bd4\u8f83\u7b80\u5355\uff0c\u53ef\u4ee5\u76f4\u63a5\u7528PKE\u4f20\u8fc7\u6765\u7684\u53c2\u6570\u8c03\u7528\u7cfb\u7edf\u8c03\u7528\u51fd\u6570</li> <li>mmap\u51fd\u6570\u6bd4\u8f83\u9ebb\u70e6\uff0c\u56e0\u4e3aARM\u7aef\u901a\u8fc7mmap\u6620\u5c04\u7684\u662fARM\u7aef\u7684\u5185\u5b58\uff0cRISCV\u7aef\u65e0\u6cd5\u8bbf\u95ee\u3002\u6240\u4ee5\u518d\u6dfb\u52a0readmmap\u51fd\u6570\uff0cPKE\u53ef\u4ee5\u901a\u8fc7HTIF\u8c03\u7528\u6b64\u51fd\u6570\u8bfb\u53d6ARM\u7aef\u88ab\u6620\u5c04\u7684\u5185\u5b58\u3002\u5c06ARM\u7aef\u7528mmap\u6620\u5c04\u7684\u6240\u6709\u5185\u5b58\u7528\u6570\u7ec4\u5b58\u50a8\u6620\u5c04\u5730\u5740\uff0c\u8fd4\u56de\u7ed9PKE\u6570\u7ec4\u7d22\u5f15\uff1bPKE\u5411readmmap\u4f20\u5165\u7d22\u5f15\uff0criscv-fesvr\u6839\u636e\u7d22\u5f15\u627e\u5230\u5730\u5740\uff0c\u8bfb\u53d6ARM\u7aef\u7684\u5185\u5b58\u6570\u636e\u8fd4\u56de\u7ed9PKE\u3002</li> </ul> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter7_device/#714-io","title":"7.1.4  \u8f6e\u8be2I/O\u63a7\u5236\u65b9\u5f0f","text":"<p>\u5728\u5b9e\u9a8c\u56db\u4e2d\uff0c\u6211\u4eec\u8bbe\u5907\u7ba1\u7406\u7684\u4e3b\u8981\u4efb\u52a1\u662f\u63a7\u5236\u8bbe\u5907\u4e0e\u5185\u5b58\u7684\u6570\u636e\u4f20\u9012\uff0c\u5177\u4f53\u4e3a\u4ece\u84dd\u7259\u8bbe\u5907\u8bfb\u53d6\u5230\u7528\u6237\u8f93\u5165\u7684\u6307\u4ee4\u5b57\u7b26\uff08\u6216\u4f20\u9012\u6570\u636e\u7ed9\u84dd\u7259\u5728\u624b\u673a\u7aef\u8fdb\u884c\u6253\u5370\uff09\uff0c\u89e3\u6790\u4e3a\u5c0f\u8f66\u524d\u3001\u540e\u3001\u5de6\u3001\u53f3\u3001\u505c\u6b62\u7b49\u52a8\u4f5c\u6765\u4f20\u8f93\u6570\u636e\u7ed9\u7535\u673a\u5b9e\u73b0\u5bf9\u5c0f\u8f66\u7684\u63a7\u5236\u3002\u5728\u524d\u4e24\u4e2a\u5b9e\u9a8c\u4e2d\uff0c\u6211\u4eec\u5206\u522b\u9700\u8981\u5bf9\u8f6e\u8be2\u63a7\u5236\u65b9\u5f0f\u548c\u4e2d\u65ad\u63a7\u5236\u65b9\u5f0f\u8fdb\u884c\u5b9e\u73b0\u3002</p> <p>\u9996\u5148\uff0c\u7a0b\u5e8f\u76f4\u63a5\u63a7\u5236\u65b9\u5f0f\uff08\u53c8\u79f0\u5faa\u73af\u6d4b\u8bd5\u65b9\u5f0f\uff09\uff0c\u6bcf\u6b21\u4ece\u5916\u90e8\u8bbe\u5907\u8bfb\u53d6\u4e00\u4e2a\u5b57\u7684\u6570\u636e\u5230\u5b58\u50a8\u5668\uff0c\u5bf9\u4e8e\u8bfb\u5165\u7684\u6bcf\u4e2a\u5b57\uff0cCPU\u9700\u8981\u5bf9\u5916\u8bbe\u72b6\u6001\u8fdb\u884c\u5faa\u73af\u68c0\u67e5\uff0c\u76f4\u5230\u786e\u5b9a\u8be5\u6570\u636e\u5df2\u7ecf\u4f20\u5165I/O\u6570\u636e\u5bc4\u5b58\u5668\u4e2d\u3002</p> <p>\u8f6e\u8be2I/O\u63a7\u5236\u65b9\u5f0f\u6d41\u7a0b\u5982\u56fe\uff1a</p> <p></p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter7_device/#715-io","title":"7.1.5  \u4e2d\u65ad\u9a71\u52a8I/O\u63a7\u5236\u65b9\u5f0f","text":"<p>\u5728\u524d\u4e00\u79cd\u8f6e\u8be2\u7684\u63a7\u5236\u65b9\u5f0f\u4e2d\uff0c\u7531\u4e8eCPU\u7684\u9ad8\u901f\u6027\u548cI/O\u8bbe\u5907\u7684\u4f4e\u901f\u6027\uff0c\u5bfc\u81f4CPU\u6d6a\u8d39\u7edd\u5927\u591a\u6570\u65f6\u95f4\u5904\u4e8e\u7b49\u5f85I/O\u8bbe\u5907\u5b8c\u6210\u6570\u636e\u4f20\u8f93\u7684\u5faa\u73af\u6d4b\u8bd5\u4e2d\uff0c\u4f1a\u9020\u6210\u5927\u91cf\u8d44\u6e90\u6d6a\u8d39\u3002\u4e2d\u65ad\u9a71\u52a8\u7684\u65b9\u5f0f\u662f\uff0c\u5141\u8bb8\u8bf7\u6c42I/O\u7684\u8fdb\u7a0b\u5728\u8bbe\u5907\u5de5\u4f5c\u65f6\u8fdb\u5165\u4f11\u7720\u72b6\u6001\uff0c\u4f7fCPU\u80fd\u591f\u8fd0\u884c\u522b\u7684\u8fdb\u7a0b\u3002\u76f4\u5230\u8bbe\u5907\u5de5\u4f5c\u5b8c\u6210\u65f6\uff0c\u518d\u7531\u8bbe\u5907\u53d1\u51fa\u4e2d\u65ad\uff0c\u4e2d\u65ad\u5904\u7406\u7a0b\u5e8f\u5524\u9192\u4e4b\u524d\u4f11\u7720\u7684\u8fdb\u7a0b\uff0c\u4f7f\u5176\u80fd\u591f\u63a5\u53d7\u8bbe\u5907\u8fd4\u56de\u7684\u6570\u636e\u7ee7\u7eed\u6267\u884c\u3002\u91c7\u7528\u4e2d\u65ad\u9a71\u52a8\u7684\u63a7\u5236\u65b9\u5f0f\uff0c\u5728I/O\u64cd\u4f5c\u8fc7\u7a0b\u4e2d\uff0cCPU\u53ef\u4ee5\u6267\u884c\u5176\u4ed6\u7684\u8fdb\u7a0b\uff0cCPU\u4e0e\u8bbe\u5907\u4e4b\u95f4\u8fbe\u5230\u4e86\u90e8\u5206\u5e76\u884c\u7684\u5de5\u4f5c\u72b6\u6001\uff0c\u4ece\u800c\u63d0\u5347\u4e86\u8d44\u6e90\u5229\u7528\u7387\u3002</p> <p>Riscv\u5305\u542b\u4e09\u7c7b\u4e2d\u65ad\uff1a\u8f6f\u4e2d\u65ad\u3001\u65f6\u949f\u4e2d\u65ad\u548c\u5916\u90e8\u4e2d\u65ad\u3002\u8f6f\u4e2d\u65ad\u548c\u65f6\u949f\u4e2d\u65ad\u6211\u4eec\u5728\u5b9e\u9a8c\u4e00\u5df2\u7ecf\u63a5\u89e6\u8fc7\uff0c\u800c\u8bbe\u5907\u89e6\u53d1\u7684\u4e2d\u65ad\u5c5e\u4e8e\u5916\u90e8\u4e2d\u65ad\u3002\u5728\u5b9e\u9a8c\u4e00\u4e2d\uff0c\u6211\u4eec\u5728\u673a\u5668\u6001\u6355\u83b7\u4e86\u65f6\u949f\u4e2d\u65ad\uff0c\u7136\u540e\u5c06\u5176\u8f6c\u53d1\u6210\u5185\u6838\u6001\u7684\u8f6f\u4e2d\u65ad\u4ea4\u7531\u4e2d\u65ad\u5904\u7406\u7a0b\u5e8f\u5904\u7406\uff1b\u672c\u7ae0\u5219\u76f4\u63a5\u901a\u8fc7\u8bbe\u7f6eMIDELEG\u5bc4\u5b58\u5668\uff0c\u5229\u7528RISCV\u7684\u4e2d\u65ad\u59d4\u6258\u673a\u5236\u76f4\u63a5\u5c06\u5916\u90e8\u4e2d\u65ad\u4ea4\u7531\u5185\u6838\u6001\u7684\u4e2d\u65ad\u5904\u7406\u7a0b\u5e8f\u5904\u7406\uff0c\u4e0d\u7528\u7ecf\u8fc7\u673a\u5668\u6001\u7684\u6355\u83b7\u3002\u53e6\u5916\uff0cRISCV\u67b6\u6784\u8fd8\u6307\u5b9a\u4e86PLIC\uff08Priority Level Interrupt Controller\uff09\u6a21\u5757\u7ba1\u7406\u5404\u7ea7\u4e2d\u65ad\uff0c\u8be5\u8bbe\u5907\u4f7f\u7528MMIO\u63a7\u5236\uff0cPKE\u5728\u5904\u7406\u4e2d\u65ad\u4e4b\u540e\u901a\u8fc7\u8bfb\u5199\u6307\u5b9a\u7684\u5185\u5b58\u5730\u5740\uff0c\u6765\u83b7\u53d6\u89e6\u53d1\u4e2d\u65ad\u7684\u8bbe\u5907\u7684\u7f16\u53f7\u4ee5\u53ca\u901a\u77e5PLIC\u672c\u6b21\u4e2d\u65ad\u662f\u5426\u5904\u7406\u6210\u529f\u3002</p> <p>\u4e2d\u65ad\u9a71\u52a8I/O\u65b9\u5f0f\u6d41\u7a0b\u5982\u56fe\uff1a</p> <p></p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter7_device/#716","title":"7.1.6 \u8bbe\u5907\u6587\u4ef6","text":"<p>\u7528\u6237\u7a0b\u5e8f\u8bbf\u95ee\u5916\u90e8\u8bbe\u5907\u901a\u5e38\u6709\u4e24\u79cd\u65b9\u5f0f\uff1a\u901a\u8fc7\u7279\u5b9a\u7cfb\u7edf\u8c03\u7528\u8bbf\u95ee\u548c\u901a\u8fc7\u8bbe\u5907\u6587\u4ef6\u8bbf\u95ee\u3002\u524d\u8005\u5373\u64cd\u4f5c\u7cfb\u7edf\u63d0\u4f9b\u4e13\u95e8\u7684\u51fd\u6570\u63a7\u5236\u8bbe\u5907\uff0c\u540e\u8005\u662f\u64cd\u4f5c\u7cfb\u7edf\u628a\u8bbe\u5907\u6307\u5b9a\u6210\u4e00\u4e2a\u6587\u4ef6\uff0c\u901a\u8fc7\u901a\u7528\u7684\u6587\u4ef6\u7684\u8bfb\u5199\u51fd\u6570\u63a7\u5236\u8bbe\u5907\u3002\u8bbe\u5907\u6587\u4ef6\u5e38\u7528\u7684\u51fd\u6570\u9664\u4e86open\u3001read\u3001write\u3001close\uff0c\u8fd8\u6709\u4ee5\u4e0b\u51e0\u79cd\uff1a</p> <ul> <li>ioctl\uff1a<code>int ioctl(int fd, unsigned long request, void *data);</code>\u7528\u6765\u8bbe\u7f6e\u8bbe\u5907\u53c2\u6570\u3002fd\u662f\u6587\u4ef6\u63cf\u8ff0\u7b26\uff1brequest\u662f\u4e00\u4e2a\u5e38\u6570\uff0c\u8868\u793a\u53c2\u6570\u7c7b\u578b\uff0c\u4e0d\u540c\u7684\u7c7b\u578b\u5bf9\u5e94\u4e0d\u540c\u7684\u5e38\u6570\uff1bdata\u901a\u5e38\u662f\u4e00\u4e2a\u6307\u5411\u8981\u8bbe\u7f6e\u7684\u53c2\u6570\u7684\u503c\u7684\u6307\u9488\uff0c\u53c2\u6570\u7684\u503c\u53ef\u4ee5\u662f\u6574\u6570\uff0c\u4e5f\u53ef\u4ee5\u662f\u7ed3\u6784\u4f53\u7b49\uff1b\u8fd4\u56de\u503c\u4e3a\u8be5\u51fd\u6570\u662f\u5426\u6267\u884c\u6210\u529f\u3002\u5982\u6444\u50cf\u5934\u8bbe\u5907\uff0c\u6211\u4eec\u5c31\u53ef\u4ee5\u901a\u8fc7\u8be5\u51fd\u6570\u8bbe\u7f6e\u6444\u50cf\u5934\u7684\u62cd\u6444\u5206\u8fa8\u7387\u3001\u989c\u8272\u683c\u5f0f\u7b49\uff1b\u97f3\u9891\u8bbe\u5907\u6211\u4eec\u53ef\u4ee5\u8bbe\u7f6e\u91c7\u6837\u7387\u3001\u6570\u636e\u683c\u5f0f\u7b49\u3002</li> <li>mmap\uff1a<code>void *mmap(void *addr, size_t length, int prot, int flags, int fd, off_t offset);</code>\u8be5\u51fd\u6570\u539f\u672c\u7684\u4f5c\u7528\u662f\u5c06\u865a\u62df\u5730\u5740\u548c\u6587\u4ef6\u8fdb\u884c\u6620\u5c04\uff0c\u4f7f\u5f97\u8bfb\u5199\u6587\u4ef6\u53ef\u4ee5\u50cf\u8bfb\u5199\u5185\u5b58\u4e00\u6837\u65b9\u4fbf\uff0c\u540c\u65f6\u4e5f\u80fd\u8282\u7701\u7269\u7406\u5185\u5b58\uff1b\u4f46\u5bf9\u4e8e\u6709\u4e9b\u4e0d\u652f\u6301read/write\u8bfb\u5199\u7684\u8bbe\u5907\uff0c\u5c31\u5fc5\u987b\u4f7f\u7528mmap\u51fd\u6570\u5c06\u865a\u62df\u5730\u5740\u548c\u8bbe\u5907\u6587\u4ef6\u6620\u5c04\uff0c\u624d\u80fd\u8bfb\u5199\u8bbe\u5907\u7684\u6570\u636e\u3002addr\u53c2\u6570\u8868\u793a\u6620\u5c04\u7684\u8d77\u59cb\u865a\u62df\u5730\u5740\uff0c\u901a\u5e38\u586bNULL\u8868\u793a\u7531\u64cd\u4f5c\u7cfb\u7edf\u81ea\u5df1\u6307\u5b9a\uff1blength\uff0cprot\u3001flags\u5206\u522b\u8868\u793a\u6620\u5c04\u5730\u5740\u7a7a\u95f4\u7684\u957f\u5ea6\u3001\u6743\u9650\u548c\u5176\u4ed6\u53c2\u6570\uff1bfd\u4e3a\u6587\u4ef6\u63cf\u8ff0\u7b26\uff1boffset\u4e3a\u6587\u4ef6\u504f\u79fb\u91cf\uff0c\u8fd4\u56de\u503c\u4e3a\u6620\u5c04\u7684\u8d77\u59cb\u865a\u62df\u5730\u5740\u3002</li> </ul> <p>\u5728\u672c\u7ae0\u8282\u4e2d\uff0c\u5c06\u4f7f\u7528PKE\u901a\u8fc7HTIF\u534f\u8bae\u548cPS\u7aef\u7684riscv-fesvr\u8fdb\u884c\u901a\u4fe1\uff0c\u4ee5\u8bfb\u5199PS\u7aef\u7684\u6444\u50cf\u5934\u8bbe\u5907\u6587\u4ef6\uff0c\u8fdb\u800c\u63a7\u5236\u6444\u50cf\u5934\u8bbe\u5907\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter7_device/#72-lab4_1-poll","title":"7.2 lab4_1 poll","text":""},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter7_device/#_2","title":"\u7ed9\u5b9a\u5e94\u7528","text":"<ul> <li>user/app_poll.c</li> </ul> <pre><code>  1 /*\n  2  * Below is the given application for lab4_1.\n  3  * The goal of this app is to control the car via Bluetooth. \n  4  */\n5 6 #include \"user_lib.h\"\n7 #include \"util/types.h\"\n8 9 int main(void) {\n10   printu(\"please input the instruction through bluetooth!\\n\");\n11   while(1)\n12   {\n13     char temp = (char)uartgetchar();\n14     if(temp == 'q')\n15       break;\n16     car_control(temp);\n17   }\n18   exit(0);\n19   return 0;\n20 }\n</code></pre> <p>\u5e94\u7528\u901a\u8fc7\u8f6e\u8be2\u7684\u65b9\u5f0f\u4ece\u84dd\u7259\u7aef\u83b7\u53d6\u6307\u4ee4\uff0c\u5b9e\u73b0\u5bf9\u5c0f\u8f66\u7684\u63a7\u5236\u529f\u80fd\u3002</p> <ul> <li>\uff08\u5148\u63d0\u4ea4lab3_3\u7684\u7b54\u6848\uff0c\u7136\u540e\uff09\u5207\u6362\u5230lab4_1\uff0c\u7ee7\u627flab3_3\u4e2d\u6240\u505a\u7684\u4fee\u6539\uff0c\u5e76make\uff1a</li> </ul> <pre><code>//\u5207\u6362\u5230lab4_1\n$ git checkout lab4_1_poll\n\n//\u7ee7\u627flab3_3\u4ee5\u53ca\u4e4b\u524d\u7684\u7b54\u6848\n$ git merge lab3_3_rrsched -m \"continue to work on lab4_1\"\n//\u91cd\u65b0\u6784\u9020\n$ make clean; make\n</code></pre> <p>\u7531\u4e8e\u672c\u5b9e\u9a8c\u7ed9\u51fa\u7684\u57fa\u7840\u4ee3\u7801\u4fee\u6539\u4e86\u786c\u4ef6\u76f8\u5173\u7684\u90e8\u5206\u4ee3\u7801\uff0c\u6240\u4ee5\u65e0\u6cd5\u5728Spike\u4e0a\u8fd0\u884c\uff0c\u9700\u5728PYNQ\u5f00\u53d1\u677f\u4e0a\u8fdb\u884c\u9a8c\u8bc1\u3002\u8bfb\u8005\u5728\u8fdb\u884c\u672c\u5b9e\u9a8c\u4e4b\u524d\uff0c\u5e94\u8be5\u5df2\u7ecf\u6309\u7167\u7b2c\u516d\u7ae0\u4e2d\u7684\u8bf4\u660e\u5b8c\u6210\u4e86fpga\u5b9e\u9a8c1\uff0c\u5e76\u5c06rocketchip_wrapper.bit.bin\u6587\u4ef6\u70e7\u5f55\u5230\u4e86\u5f00\u53d1\u677f\u4e2d\u3002</p> <p>make\u5b8c\u6210\u540e\uff0c\u9700\u8981\u5c06obj\u76ee\u5f55\u4e0b\u7f16\u8bd1\u751f\u6210\u7684\u53ef\u6267\u884c\u6587\u4ef6\u4f20\u8f93\u5230\u5f00\u53d1\u677f\u4e2d\uff0c\u7136\u540e\u5728\u5f00\u53d1\u677f\u4e0a\u8fd0\u884c\u7a0b\u5e8f\u3002\u5177\u4f53\u7684\u505a\u6cd5\u5982\u4e0b\uff1a</p> <ol> <li> <p>\u9996\u5148\uff0c\u5c06make\u547d\u4ee4\u7f16\u8bd1\u751f\u6210\u7684\u4e24\u4e2a\u53ef\u6267\u884c\u6587\u4ef6\uff1aobj/app_polling\u6587\u4ef6\u4e0eobj/riscv-pke\u6587\u4ef6\u901a\u8fc7sftp\u534f\u8bae\u4f20\u8f93\u5230\u5f00\u53d1\u677f\u7684/home/xilinx\u76ee\u5f55\u4e0b\u3002\u81f3\u4e8e\u5982\u4f55\u5411\u5f00\u53d1\u677f\u4e2d\u4f20\u9001\u6587\u4ef6\uff0c\u5728\u7b2c\u516d\u7ae0\u4e2d\u5df2\u6709\u8be6\u7ec6\u7684\u4ecb\u7ecd\uff0c\u8bfb\u8005\u53ef\u4ee5\u53c2\u8003\u4e4b\u524d\u7684\u63cf\u8ff0\u3002</p> </li> <li> <p>\u901a\u8fc7ssh\u534f\u8bae\u8fde\u63a5\u5230\u5f00\u53d1\u677f\uff08\u8fde\u63a5\u65b9\u6cd5\u5728\u7b2c\u516d\u7ae0\u4e2d\u540c\u6837\u6709\u8be6\u7ec6\u8bf4\u660e\uff09\uff0c\u5e76\u5728ssh\u5ba2\u6237\u7aef\u4e2d\u8f93\u5165\u5982\u4e0b\u547d\u4ee4\u6267\u884capp_polling\uff1a</p> </li> </ol> <pre><code>$ sudo ./program.sh # \u82e5\u91cd\u542f\u8fc7\u5f00\u53d1\u677f\uff0c\u5219\u5728\u6267\u884c\u7a0b\u5e8f\u524d\u8981\u5148\u6267\u884c\u6b64\u811a\u672c\u8fdb\u884c\u70e7\u5f55\n$ sudo ./riscv-fesvr riscv-pke app_poll\nIn m_start, hartid:0\n(Emulated) memory size: 256 MB\nEnter supervisor mode...\nPKE kernel start 0x0000000080000000, PKE kernel end: 0x0000000080009000, PKE kernel size: 0x0000000000009000 .\nfree physical memory address: [0x0000000080009000, 0x00000000800fffff] kernel memory manager is initializing ...\nKERN_BASE 0x0000000080000000\nphysical address of _etext is: 0x0000000080005000\nkernel page table is on Switch to user mode...\nin alloc_proc. user frame 0x00000000800f9000, user stack 0x000000007ffff000, user kstack 0x00000000800f8000 User application is loading.\nApplication: app_polling\nCODE_SEGMENT added at mapped info offset:3\nApplication program entry point (virtual address): 0x0000000000010078\ngoing to insert process 0 to ready queue.\ngoing to schedule process 0 to run.\nTicks 0\nplease input the instruction through bluetooth!\nYou have to implement sys_user_uart_getchar to get data from UART using uartgetchar in lab4_1 and modify it in lab4_2.\n\nSystem is shutting down with exit code -1.\n</code></pre> <p>\u4ece\u76f4\u63a5\u7f16\u8bd1\u8fd0\u884c\u7ed3\u679c\u4e0a\u6765\u770b\uff0c\u84dd\u7259\u7aef\u7aef\u53e3\u83b7\u53d6\u7528\u6237\u8f93\u5165\u6307\u4ee4\u7684uartgetchar\u7cfb\u7edf\u8c03\u7528\u672a\u5b8c\u5584\uff0c\u6240\u4ee5\u65e0\u6cd5\u8fdb\u884c\u63a7\u5236\u5c0f\u8f66\u7684\u540e\u7eed\u64cd\u4f5c\u3002\u6309\u7167\u63d0\u793a\uff0c\u6211\u4eec\u9700\u8981\u5b9e\u73b0\u84dd\u7259uart\u7aef\u53e3\u7684\u83b7\u53d6\u548c\u6253\u5370\u5b57\u7b26\u7cfb\u7edf\u8c03\u7528\uff0c\u4ee5\u53ca\u4f20\u9001\u9a71\u52a8\u6570\u636e\u7ed9\u5c0f\u8f66\u7535\u673a\u7684\u7cfb\u7edf\u8c03\u7528\uff0c\u5b9e\u73b0\u5bf9\u5c0f\u8f66\u7684\u63a7\u5236\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter7_device/#_3","title":"\u5b9e\u9a8c\u5185\u5bb9","text":"<p>\u5982\u8f93\u51fa\u63d0\u793a\u6240\u8868\u793a\u7684\u90a3\u6837\uff0c\u9700\u8981\u627e\u5230\u5e76\u5b8c\u6210\u5bf9uart_getchar\u7684\u8c03\u7528\uff0c\u91cd\u65b0\u7f16\u8bd1\u751f\u6210app_polling\u4e0eriscv-pke\u6587\u4ef6\uff0c\u5e76\u5c06\u8fd9\u4e24\u4e2a\u6587\u4ef6\u4f20\u8f93\u5230\u5f00\u53d1\u677f\u4e2d\uff0c\u5728ssh\u4f1a\u8bdd\u4e2d\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\uff0c\u5f97\u5230\u9884\u671f\u7ed3\u679c\uff1a</p> <pre><code>$ sudo ./program.sh # \u82e5\u91cd\u542f\u8fc7\u5f00\u53d1\u677f\uff0c\u5219\u5728\u6267\u884c\u7a0b\u5e8f\u524d\u8981\u5148\u6267\u884c\u6b64\u811a\u672c\u8fdb\u884c\u70e7\u5f55\n$ sudo ./riscv-fesvr riscv-pke app_poll\nIn m_start, hartid:0\n(Emulated) memory size: 256 MB\nEnter supervisor mode...\nPKE kernel start 0x0000000080000000, PKE kernel end: 0x0000000080009000, PKE kernel size: 0x0000000000009000 .\nfree physical memory address: [0x0000000080009000, 0x00000000800fffff] kernel memory manager is initializing ...\nKERN_BASE 0x0000000080000000\nphysical address of _etext is: 0x0000000080005000\nkernel page table is on Switch to user mode...\nin alloc_proc. user frame 0x00000000800f9000, user stack 0x000000007ffff000, user kstack 0x00000000800f8000 User application is loading.\nApplication: app_polling\nCODE_SEGMENT added at mapped info offset:3\nApplication program entry point (virtual address): 0x0000000000010078\ngoing to insert process 0 to ready queue.\ngoing to schedule process 0 to run.\nplease input the instruction through bluetooth!\n</code></pre> <p>\u5f53\u7a0b\u5e8f\u6b63\u786e\u6267\u884c\u65f6\uff0c\u4f1a\u5728\u663e\u793a\u201cplease input the instruction through bluetooth!\u201d\u540e\u7b49\u5f85\u7528\u6237\u4ece\u84dd\u7259\u8bbe\u5907\u53d1\u9001\u63a7\u5236\u6307\u4ee4\u3002\u4fdd\u6301\u7a0b\u5e8f\u8fd0\u884c\uff0c\u5e76\u6309\u7167\u4e0b\u9762\u7684\u6b65\u9aa4\u901a\u8fc7\u84dd\u7259\u5411\u5c0f\u8f66\u53d1\u9001\u6307\u4ee4\uff1a</p> <ol> <li> <p>\u5728\u624b\u673a\u7aef\u4e0b\u8f7d\u4efb\u610f\u4e00\u79cd\u84dd\u7259\u4e32\u53e3\u901a\u4fe1APP\uff08\u63d0\u4f9b\u4e00\u4e2a\u5728\u5b89\u535312\u4e0a\u6d4b\u8bd5\u65e0\u8bef\u7684\u8f6f\u4ef6\u4e0b\u8f7d\uff1a\u84dd\u7259\u4e32\u53e3\uff0c\u4e0b\u9762\u7684\u6b65\u9aa4\u90fd\u4ee5\u6b64APP\u4e3a\u4f8b\u8fdb\u884c\u8bf4\u660e\uff0c\u5176\u4ed6\u84dd\u7259\u4e32\u53e3\u901a\u4fe1APP\u7684\u4f7f\u7528\u65b9\u6cd5\u4e0e\u4e4b\u7c7b\u4f3c\uff09\u3002</p> </li> <li> <p>\u6253\u5f00\u624b\u673a\u84dd\u7259\u5f00\u5173\u3002</p> </li> <li> <p>\u70b9\u51fb\u84dd\u7259\u4e32\u53e3\u901a\u4fe1APP\u4e0b\u65b9\u7684\u84dd\u7259\u8bbe\u5907\u6309\u94ae\uff0c\u627e\u5230\u84dd\u7259\u6a21\u5757\uff0c\u5176\u540d\u79f0\u901a\u5e38\u662f\u201cBT04-A\u201d\uff0c\u70b9\u51fb\u8fdb\u884c\u914d\u5bf9\u3002\u82e5\u63d0\u793a\u8f93\u5165PIN\u7801\uff0c\u5219\u8f93\u5165\u201c1234\u201d\u3002</p> </li> <li> <p>\u70b9\u51fb\u84dd\u7259\u4e32\u53e3\u901a\u4fe1APP\u4e0b\u65b9\u7684\u6536\u53d1\u6570\u636e\u6309\u94ae\uff0c\u8fdb\u5165\u6536\u53d1\u6570\u636e\u754c\u9762\u3002\u5728\u4e0b\u65b9\u7684\u5bf9\u8bdd\u6846\u4e2d\u5373\u53ef\u8f93\u5165\u63a7\u5236\u6307\u4ee4\uff0c\u5177\u4f53\u547d\u4ee4\u5982\u4e0b\uff1a</p> </li> </ol> <p>\u6ce8\u610f\uff0c\u82e5\u8f6f\u786c\u4ef6\u90fd\u6b63\u786e\u65e0\u8bef\uff0c\u5728\u53d1\u9001\u4e0b\u65b9\u6307\u4ee4\u540e\u5c0f\u8f66\u4f1a\u7acb\u5373\u5f00\u59cb\u8fd0\u52a8\u3002\u8bf7\u52a1\u5fc5\u786e\u4fdd\u5c0f\u8f66\u7684\u8fd0\u52a8\u5728\u5b9e\u9a8c\u4eba\u5458\u7684\u63a7\u5236\u4e4b\u5185\uff01\u82e5\u5c0f\u8f66\u4e0a\u6709\u8fde\u63a5\u7528\u4e8e\u8c03\u8bd5\u7684\u7f51\u7ebf\u7b49\u8bbe\u5907\uff0c\u5efa\u8bae\u6682\u65f6\u4f7f\u5c0f\u8f66\u7684\u56db\u4e2a\u8f66\u8f6e\u5904\u4e8e\u60ac\u7a7a\u72b6\u6001\u3002\u5f53\u529f\u80fd\u5168\u90e8\u6d4b\u8bd5\u65e0\u8bef\u540e\uff0c\u53ef\u4ee5\u5728\u4fdd\u6301\u7a0b\u5e8f\u8fd0\u884c\u7684\u60c5\u51b5\u4e0b\u76f4\u63a5\u62d4\u6389\u7f51\u7ebf\uff0c\u5e76\u5c06\u5c0f\u8f66\u653e\u7f6e\u5728\u5730\u9762\u4e0a\u79fb\u52a8\u3002</p> \u547d\u4ee4 \u6548\u679c 1 \u5c0f\u8f66\u524d\u8fdb 2 \u5c0f\u8f66\u540e\u9000 3 \u5c0f\u8f66\u5de6\u8f6c 4 \u5c0f\u8f66\u53f3\u8f6c 0 \u5c0f\u8f66\u505c\u6b62 q \u7a0b\u5e8f\u505c\u6b62\uff08\u5728ssh\u4f1a\u8bdd\u4e2d\u8f93\u5165ctrl+c\u4e5f\u53ef\u4ee5\u505c\u6b62\u7a0b\u5e8f\uff09 <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter7_device/#_4","title":"\u5b9e\u9a8c\u6307\u5bfc","text":"<p>\u57fa\u4e8e\u5b9e\u9a8clab1_1\uff0c\u4f60\u5df2\u7ecf\u4e86\u89e3\u548c\u638c\u63e1\u64cd\u4f5c\u7cfb\u7edf\u4e2d\u7cfb\u7edf\u8c03\u7528\u673a\u5236\u7684\u5b9e\u73b0\u539f\u7406\u3002\u5bf9\u4e8e\u672c\u5b9e\u9a8c\u7684\u5e94\u7528\uff0c\u6211\u4eec\u53d1\u73b0user/app_poll.c\u6587\u4ef6\u4e2d\u6709\u4e09\u4e2a\u51fd\u6570\u8c03\u7528\uff1auart_getchar\uff0cuart_putchar\u548cuart2_putchar\u3002UART\u662f\u4e00\u79cd\u63a7\u5236\u8bbe\u5907\u7684\u7aef\u53e3\u534f\u8bae\uff0c\u4f46\u5728\u672c\u5b9e\u9a8c\u4e2d\u5b83\u53ef\u4ee5\u901a\u8fc7MMIO\u8fdb\u884c\u63a7\u5236\u3002\u5bf9\u4ee3\u7801\u8fdb\u884c\u8ddf\u8e2a\uff0c\u6211\u4eec\u53d1\u73b0\u8fd9\u4e09\u4e2a\u51fd\u6570\u90fd\u5728user/user_lib.c\u4e2d\u8fdb\u884c\u4e86\u5b9e\u73b0\uff0c\u5bf9\u5e94\u4e8elab1_1\u7684\u6d41\u7a0b\uff0c\u6211\u4eec\u53ef\u4ee5\u5728kernel/syscall.h\u4e2d\u67e5\u770b\u65b0\u589e\u7684\u7cfb\u7edf\u8c03\u7528\u4ee5\u53ca\u7f16\u53f7\uff1a</p> <pre><code>16  #define SYS_user_uart_putchar (SYS_user_base + 6)\n17  #define SYS_user_uart_getchar (SYS_user_base + 7)\n18  #define SYS_user_uart2_putchar (SYS_user_base + 8)\n</code></pre> <p>\u7ee7\u7eed\u8ffd\u8e2a\uff0c\u6211\u4eec\u53d1\u73b0\u5728kernel/syscall.c\u7684do_syscall\u51fd\u6570\u4e2d\u65b0\u589e\u4e86\u5bf9\u5e94\u7cfb\u7edf\u8c03\u7528\u7f16\u53f7\u7684\u5b9e\u73b0\u51fd\u6570\uff0c\u5bf9\u4e8e\u65b0\u589e\u7cfb\u7edf\u8c03\u7528\uff0c\u5206\u522b\u6709\u5982\u4e0b\u51fd\u6570\u8fdb\u884c\u5904\u7406\uff1a</p> <pre><code>133     case SYS_user_uart_putchar:\n134       sys_user_uart_putchar(a1);return 1;\n135     case SYS_user_uart_getchar:\n136       return sys_user_uart_getchar();\n137     case SYS_user_uart2_putchar:\n138       sys_user_uart2_putchar(a1);return 1;\n</code></pre> <p>\u8bfb\u8005\u7684\u4efb\u52a1\u5373\u4e3a\u5728kernel/syscall.c\u4e2d\u8ffd\u8e2a\u5e76\u5b8c\u5584sys_user_uart_getchar\u3002\u5bf9\u4e8euart\u76f8\u5173\u7684\u51fd\u6570\uff0c\u6211\u4eec\u7ed9\u51fauart\u7aef\u53e3\u7684\u5730\u5740\u6620\u5c04\u5982\u56fe\uff1a</p> <p></p> <p>\u56fe\u4e2d\u7684axi_uartlite_0\u5bf9\u5e94\u4e8e\u84dd\u7259\u8bbe\u5907\u7684uart\u7aef\u53e3\uff0caix_uartlite_1\u5219\u5bf9\u5e94\u4e8e\u5c0f\u8f66\u7535\u673a\u9a71\u52a8\u677f\u7684uart\u7aef\u53e3\u3002\u5176\u4e2d\u84dd\u7259\u8bbe\u5907\u7684uart\u7aef\u53e3\u7684\u504f\u79fb\u5730\u5740\u4e3a0x60000000\uff0c\u5bf9\u5e94\u5199\u5730\u5740\u4e3a0x60000004\uff0c\u8bfb\u5730\u5740\u4e3a0x60000000\uff0c\u540c\u65f6\u5bf90x60000008\u7684\u72b6\u6001\u4f4d\u8fdb\u884c\u8f6e\u8be2\uff0c\u68c0\u6d4b\u5230\u4fe1\u53f7\u65f6\u8fdb\u884c\u8bfb\u5199\u64cd\u4f5c\u3002</p> <p>\u5728kernel/syscall.c\u4e2d\u627e\u5230\u51fd\u6570\u5b9e\u73b0\u7a7a\u7f3a\uff0c\u5e76\u6839\u636e\u6ce8\u91ca\u5b8c\u6210sys_user_uart_getchar\u7cfb\u7edf\u8c03\u7528\uff08\u7531\u4e8elab4_2\u9700\u8981\u5bf9lab4_1\u5b8c\u6210\u7684\u4ee3\u7801\u8fdb\u884c\u4fee\u6539\uff0c\u6240\u4ee5\u8fd9\u91cc\u4e00\u5e76\u7ed9\u51fa\u4e86lab4_2\u7684\u63d0\u793a\uff09\uff1a</p> <pre><code> 95 ssize_t sys_user_uart_getchar() {\n96   // TODO (lab4_1 and lab4_2): implment the syscall of sys_user_uart_getchar and modify it in lab4_2.\n97   // hint (lab4_1): The functionality of sys_user_uart_getchar is to get data from UART address.\n98   // Therefore we should check the data from the address of bluetooth status repeatedly, until the data is ready. \n99   // Then read the data from the address of bluetooth reading and return.\n100   // hint (lab4_2): the functionality of sys_user_uart_getchar is let process sleep and wait for value. therefore,\n101   // we should call do_sleep to let process 0 sleep. \n102   // then we should get uartvalue and return.\n103     panic( \"You have to implement sys_user_uart_getchar to get data from UART using uartgetchar in lab4_1 and modify it in lab4_2.\\n\" );\n104 105 }\n</code></pre> <p>\u6ce8\u610f\uff1a\u7f16\u5199\u81ea\u5df1\u7684\u4ee3\u7801\u65f6\u5343\u4e07\u4e0d\u8981\u4fee\u6539\u6216\u5220\u53bblab4_2\u7684\u63d0\u793a\uff08\u5373100\u884c\u5230102\u884c\uff09\uff0c\u9632\u6b62\u540e\u9762\u5b9e\u9a8c\u7684\u5408\u5e76\u9519\u8bef\uff01</p> <p>\u5b9e\u9a8c\u5b8c\u6bd5\u540e\uff0c\u8bb0\u5f97\u63d0\u4ea4\u4fee\u6539\uff08\u547d\u4ee4\u884c\u4e2d-m\u540e\u7684\u5b57\u7b26\u4e32\u53ef\u81ea\u884c\u786e\u5b9a\uff09\uff0c\u4ee5\u4fbf\u5728\u540e\u7eed\u5b9e\u9a8c\u4e2d\u7ee7\u627flab4_1\u4e2d\u6240\u505a\u7684\u5de5\u4f5c\uff1a</p> <pre><code>$ git commit -a -m \"my work on lab4_1 is done.\"\n</code></pre> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter7_device/#73-lab4_2_plic","title":"7.3 lab4_2_PLIC","text":""},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter7_device/#_5","title":"\u7ed9\u5b9a\u5e94\u7528","text":"<ul> <li>user/app_PLIC.c</li> </ul> <pre><code>  1  /*\n  2  * Below is the given application for lab4_2.\n  3  * The goal of this app is to control the car via Bluetooth. \n  4  */\n5 6 #include \"user_lib.h\"\n7 #include \"util/types.h\"\n8 void delay(unsigned int time){\n9   unsigned int a = 0xfffff ,b = time;\n10   volatile unsigned int i,j;\n11   for(i = 0; i &lt; a; ++i){\n12     for(j = 0; j &lt; b; ++j){\n13       ;\n14     }\n15   }\n16 }\n17 int main(void) {\n18   printu(\"Hello world!\\n\");\n19   int i;\n20   int pid = fork();\n21   if(pid == 0)\n22   {\n23     while (1)\n24     {\n25       delay(3);\n26       printu(\"waiting for you!\\n\");\n27     }\n28 29   }\n30   else\n31   {\n32     while(1)\n33     {\n34       char temp = (char)uartgetchar();\n35       if(temp == 'q')\n36         break;\n37       car_control(temp);\n38     }\n39   }\n40 41 42   exit(0);\n43 44   return 0;\n45 }\n</code></pre> <p>\u5e94\u7528\u901a\u8fc7\u4e2d\u65ad\u7684\u65b9\u5f0f\u4ece\u84dd\u7259\u7aef\u83b7\u53d6\u6307\u4ee4\uff0c\u5b9e\u73b0\u5bf9\u5c0f\u8f66\u7684\u63a7\u5236\u529f\u80fd\u3002\u5728\u7b49\u5f85\u84dd\u7259\u7684\u8fdb\u7a0b\u4f11\u7720\u7684\u65f6\u5019\uff0c\u4f1a\u6267\u884cdelay\u8fdb\u7a0b\uff0c\u53ef\u4ee5\u770b\u5230waiting for you\u63d0\u793a\u4fe1\u606f\u3002</p> <ul> <li>\uff08\u5148\u63d0\u4ea4lab4_1\u7684\u7b54\u6848\uff0c\u7136\u540e\uff09\u5207\u6362\u5230lab4_2\uff0c\u7ee7\u627flab4_1\u4e2d\u6240\u505a\u7684\u4fee\u6539\uff0c\u5e76make\uff1a</li> </ul> <pre><code>//\u5207\u6362\u5230lab4_2\n$ git checkout lab4_2_PLIC\n\n//\u7ee7\u627flab4_1\u4ee5\u53ca\u4e4b\u524d\u7684\u7b54\u6848\n$ git merge lab4_1_poll -m \"continue to work on lab4_2\"\n//\u91cd\u65b0\u6784\u9020\n$ make clean; make\n</code></pre> <p>\u7f16\u8bd1\u5b8c\u6210\u540e\u540c\u6837\u9700\u8981\u5c06obj/riscv-pke\u4e0eobj/app_PLIC\u6587\u4ef6\u4f20\u8f93\u5230\u5f00\u53d1\u677f\u4e2d\uff0c\u7136\u540e\u518d\u901a\u8fc7ssh\u534f\u8bae\u8fde\u63a5\u5230\u5f00\u53d1\u677f\uff0c\u5728ssh\u4f1a\u8bdd\u4e2d\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\u70e7\u5f55\u5e76\u8fd0\u884c\u7a0b\u5e8f\uff1a</p> <pre><code>$ sudo ./program.sh # \u82e5\u91cd\u542f\u8fc7\u5f00\u53d1\u677f\uff0c\u5219\u5728\u6267\u884c\u7a0b\u5e8f\u524d\u8981\u5148\u6267\u884c\u6b64\u811a\u672c\u8fdb\u884c\u70e7\u5f55\n$ sudo ./riscv-fesvr riscv-pke app_PLIC\n</code></pre> <p>\u76f4\u63a5\u7f16\u8bd1\u6267\u884c\u7ed3\u679c\u548c\u5b8c\u6210\u540e\u7684lab4_1\u4e00\u81f4\uff0c\u4e00\u76f4\u963b\u585e\u5728\u8fd9\u91cc\u7b49\u5f85\u84dd\u7259\u6570\u636e\u3002\u9700\u8981\u4fee\u6539lab4_1\u6240\u5199\u7684\u4ee3\u7801\u5e76\u6dfb\u52a0\u4e2d\u65ad\u5904\u7406\uff0c\u4f7f\u5f97\u7b49\u5f85\u84dd\u7259\u7684\u8fdb\u7a0b\u80fd\u591f\u81ea\u52a8\u4f11\u7720\uff0c\u6267\u884cdelay\u8fdb\u7a0b\uff0c\u76f4\u5230\u53d1\u751f\u5916\u90e8\u4e2d\u65ad\u540e\u624d\u7ee7\u7eed\u6267\u884c\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter7_device/#_6","title":"\u5b9e\u9a8c\u5185\u5bb9","text":"<p>\u5982\u8f93\u51fa\u63d0\u793a\u6240\u8868\u793a\u7684\u90a3\u6837\uff0c\u9700\u8981\u4fee\u6539lab4_1\u6240\u5199\u7684\u4ee3\u7801\u5e76\u6dfb\u52a0\u4e2d\u65ad\u5904\u7406\u3002\u5b8c\u6210\u540e\u6309lab4_1\u7684\u65b9\u6cd5\u6267\u884c\uff0c\u7a0b\u5e8f\u5728\u7b49\u5f85\u84dd\u7259\u7684\u65f6\u5019\u4f1a\u4e0d\u65ad\u8f93\u51fawaiting for you\u63d0\u793a\u4fe1\u606f\uff0c\u5728\u624b\u673a\u4e0a\u8f93\u5165\u63a7\u5236\u6307\u4ee4\u540e\uff0c\u5c0f\u8f66\u5e94\u80fd\u6839\u636e\u6307\u4ee4\u53cd\u5e94\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter7_device/#_7","title":"\u5b9e\u9a8c\u6307\u5bfc","text":"<p>\u5728kernel/syscall.c\u4e2d\u627e\u5230lab4_1\u5199\u7684\u4ee3\u7801\uff0c\u5e76\u6839\u636e\u6ce8\u91ca\u8fdb\u884c\u4fee\u6539\uff1a</p> <pre><code> 95 ssize_t sys_user_uart_getchar() {\n96   // TODO (lab4_1 and lab4_2): implment the syscall of sys_user_uart_getchar and modify it in lab4_2.\n97   // hint (lab4_1): The functionality of sys_user_uart_getchar is to get data from UART address.\n98   // Therefore we should check the data from the address of bluetooth status repeatedly, until the data is ready. \n99   // Then read the data from the address of bluetooth reading and return.\n100   // hint (lab4_2): the functionality of sys_user_uart_getchar is let process sleep and wait for value. therefore,\n101   // we should call do_sleep to let process 0 sleep. \n102   // then we should get uartvalue and return.\n103     panic( \"You have to implement sys_user_uart_getchar to get data from UART using uartgetchar in lab4_1 and modify it in lab4_2.\\n\" ); // \u8be5\u884c\u5df2\u88ab\u4f60\u4e4b\u524d\u5199\u7684\u4ee3\u7801\u66ff\u6362\n104 105 }\n</code></pre> <p>\u5f53\u84dd\u7259\u6709\u6570\u636e\u53d1\u9001\u65f6\uff0cpke\u4f1a\u6536\u5230\u5916\u90e8\u4e2d\u65ad\uff0c\u4f60\u9700\u8981\u5b8c\u6210\u63a5\u6536\u5230\u5916\u90e8\u4e2d\u65ad\u540e\u7684\u5904\u7406\u3002</p> <p>\u5728kernel/strap.c\u4e2d\u627e\u5230\u51fd\u6570\u7a7a\u7f3a\uff0c\u5e76\u6839\u636e\u6ce8\u91ca\u5b8c\u6210\u4e2d\u65ad\u5904\u7406\u51fd\u6570\uff1a</p> <pre><code>103     case CAUSE_MEXTERNEL_S_TRAP:\n104       {\n105         //reset the PLIC so that we can get the next external interrupt.\n106         volatile int irq = *(uint32 *)0xc201004L;\n107         *(uint32 *)0xc201004L = irq;\n108         volatile int *ctrl_reg = (void *)(uintptr_t)0x6000000c;\n109         *ctrl_reg = *ctrl_reg | (1 &lt;&lt; 4);\n110         // TODO (lab4_2): implment the case of CAUSE_MEXTERNEL_S_TRAP.\n111         // hint: the case of CAUSE_MEXTERNEL_S_TRAP is to get data from UART address and wake the process. therefore,\n112         // and you need to store the data in struct process.value. \n113         panic( \"You have to implement CAUSE_MEXTERNEL_S_TRAP to get data from UART and wake the process 0 in lab4_2.\\n\" );\n114         115         break;\n116       }\n</code></pre> <p>\u5b9e\u9a8c\u5b8c\u6bd5\u540e\uff0c\u8bb0\u5f97\u63d0\u4ea4\u4fee\u6539\uff08\u547d\u4ee4\u884c\u4e2d-m\u540e\u7684\u5b57\u7b26\u4e32\u53ef\u81ea\u884c\u786e\u5b9a\uff09\uff0c\u4ee5\u4fbf\u5728\u540e\u7eed\u5b9e\u9a8c\u4e2d\u7ee7\u627flab4_2\u4e2d\u6240\u505a\u7684\u5de5\u4f5c\uff1a</p> <pre><code>$ git commit -a -m \"my work on lab4_2 is done.\"\n</code></pre> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter7_device/#74-lab4_3_hostdevice","title":"7.4 lab4_3_hostdevice","text":""},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter7_device/#_8","title":"\u7ed9\u5b9a\u5e94\u7528","text":"<ul> <li>user/app_host_device.c</li> </ul> <pre><code>  1 #pragma pack(4)\n2 #define _SYS__TIMEVAL_H_\n3 struct timeval {\n4     unsigned int tv_sec;\n5     unsigned int tv_usec;\n6 };\n7 8 #include \"user_lib.h\"\n9 #include \"videodev2.h\"\n10 #define DARK 64\n11 #define RATIO 7 / 10\n12 13 int main() {\n14     char *info = allocate_share_page();\n15     int pid = do_fork();\n16     if (pid == 0) {\n17         int f = do_open(\"/dev/video0\", O_RDWR), r;\n18 19         struct v4l2_format fmt;\n20         fmt.type = V4L2_BUF_TYPE_VIDEO_CAPTURE;\n21         fmt.fmt.pix.pixelformat = V4L2_PIX_FMT_YUYV;\n22         fmt.fmt.pix.width = 320;\n23         fmt.fmt.pix.height = 180;\n24         fmt.fmt.pix.field = V4L2_FIELD_NONE;\n25         r = do_ioctl(f, VIDIOC_S_FMT, &amp;fmt);\n26         printu(\"Pass format: %d\\n\", r);\n27 28         struct v4l2_requestbuffers req;\n29         req.type = V4L2_BUF_TYPE_VIDEO_CAPTURE;\n30         req.count = 1; req.memory = V4L2_MEMORY_MMAP;\n31         r = do_ioctl(f, VIDIOC_REQBUFS, &amp;req);\n32         printu(\"Pass request: %d\\n\", r);\n33 34         struct v4l2_buffer buf;\n35         buf.type = V4L2_BUF_TYPE_VIDEO_CAPTURE;\n36         buf.memory = V4L2_MEMORY_MMAP; buf.index = 0;\n37         r = do_ioctl(f, VIDIOC_QUERYBUF, &amp;buf);\n38         printu(\"Pass buffer: %d\\n\", r);\n39 40         int length = buf.length;\n41         char *img = do_mmap(NULL, length, PROT_READ | PROT_WRITE, MAP_SHARED, f, buf.m.offset);\n42         unsigned int type = V4L2_BUF_TYPE_VIDEO_CAPTURE;\n43         r = do_ioctl(f, VIDIOC_STREAMON, &amp;type);\n44         printu(\"Open stream: %d\\n\", r);\n45 46         char *img_data = allocate_page();\n47         for (int i = 0; i &lt; (length + 4095) / 4096 - 1; i++)\n48             allocate_page();\n49         yield();\n50 51         for (;;) {\n52             if (*info == '1') {\n53                 r = do_ioctl(f, VIDIOC_QBUF, &amp;buf);\n54                 printu(\"Buffer enqueue: %d\\n\", r);\n55                 r = do_ioctl(f, VIDIOC_DQBUF, &amp;buf);\n56                 printu(\"Buffer dequeue: %d\\n\", r);\n57                 r = read_mmap(img_data, img, length);\n58                 int num = 0;\n59                 for (int i = 0; i &lt; length; i += 2)\n60                     if (img_data[i] &lt; DARK) num++;\n61                 printu(\"Dark num: %d &gt; %d\\n\", num, length / 2 * RATIO);\n62                 if (num &gt; length / 2 * RATIO) {\n63                     *info = '0'; car_control('0');\n64                 }\n65             } else if (*info == 'q') break;\n66         }\n67 68         for (char *i = img_data; i - img_data &lt; length; i += 4096)\n69             free_page(i);\n70         r = do_ioctl(f, VIDIOC_STREAMOFF, &amp;type);\n71         printu(\"Close stream: %d\\n\", r);\n72         do_munmap(img, length); do_close(f); exit(0);\n73     } else {\n74         yield();\n75         while(1)\n76         {\n77             char temp = (char)uartgetchar();\n78             *info = temp;\n79             if(temp == 'q')\n80                 break;\n81             car_control(temp);\n82         }\n83     }\n84     return 0;\n85 }\n</code></pre> <p>\u8be5\u7528\u6237\u7a0b\u5e8f\u5305\u542b\u4e24\u4e2a\u8fdb\u7a0b\uff0c\u5176\u4e2d\u4e3b\u8fdb\u7a0b\u548c\u5b9e\u9a8c4_2\u7c7b\u4f3c\uff0c\u8d1f\u8d23\u63a5\u6536\u84dd\u7259\u53d1\u9001\u8fc7\u6765\u7684\u6570\u636e\uff0c\u6839\u636e\u6570\u636e\u63a7\u5236\u5c0f\u8f66\u884c\u52a8\uff08\u524d\u8fdb\u3001\u540e\u9000\u3001\u5de6\u8f6c\u3001\u53f3\u8f6c\u3001\u505c\u6b62\uff09\uff1b\u5b50\u8fdb\u7a0b\u5219\u8d1f\u8d23\u62cd\u6444\u548c\u5206\u6790\uff0c\u9996\u5148\u521d\u59cb\u5316\u6444\u50cf\u5934\u8bbe\u5907\uff0c\u7136\u540e\u662f\u4e2a\u6b7b\u5faa\u73af\u5224\u65ad\u6444\u50cf\u5934\u62cd\u6444\u7684\u56fe\u50cf\u6570\u636e\uff1a\u5982\u679c\u5f53\u524d\u5c0f\u8f66\u5904\u4e8e\u524d\u8fdb\u72b6\u6001\uff0c\u5219\u62cd\u6444\uff0c\u7136\u540e\u68c0\u67e5\u6570\u636e\uff0c\u5982\u679c\u5224\u65ad\u524d\u9762\u6709\u969c\u788d\u7269\u5219\u63a7\u5236\u8f66\u8f6e\u505c\u8f6c\uff08\u5239\u8f66\uff09\uff0c\u5426\u5219\u5982\u679c\u4e3b\u8fdb\u7a0b\u9000\u51fa\u4e86\uff0c\u5219\u81ea\u5df1\u8fdb\u884c\u91ca\u653e\u6587\u4ef6\u3001\u5185\u5b58\u3001\u5173\u95ed\u8bbe\u5907\u7b49\u64cd\u4f5c\uff0c\u518d\u9000\u51fa\u3002\u5728\u7528\u6237\u7a0b\u5e8f\u64cd\u63a7\u6444\u50cf\u5934\u7684\u8fc7\u7a0b\u4e2d\uff0c\u4f7f\u7528\u4e86ioctl\u3001mmap\u3001munmap\u7b49\u7cfb\u7edf\u8c03\u7528\uff0c\u4f60\u9700\u5b8c\u5584\u5176\u4e2d\u7684open\u548cioctl\u4e24\u4e2a\u7cfb\u7edf\u8c03\u7528\uff0c\u5bf9\u5176\u8fdb\u884c\u5b8c\u5584\u4ece\u800c\u5b9e\u73b0\u5c0f\u8f66\u7684\u969c\u788d\u8bc6\u522b\u548c\u505c\u6b62\u529f\u80fd\u3002</p> <ul> <li>\uff08\u5148\u63d0\u4ea4lab4_2\u7684\u7b54\u6848\uff0c\u7136\u540e\uff09\u5207\u6362\u5230lab4_3\uff0c\u7ee7\u627flab4_2\u4e2d\u6240\u505a\u7684\u4fee\u6539\uff0c\u5e76make\uff1a</li> </ul> <pre><code>//\u5207\u6362\u5230lab4_3\n$ git checkout lab4_3_hostdevice\n\n//\u7ee7\u627flab4_2\u4ee5\u53ca\u4e4b\u524d\u7684\u7b54\u6848\n$ git merge lab4_2_PLIC -m \"continue to work on lab4_3\"\n//\u91cd\u65b0\u6784\u9020\n$ make clean; make\n</code></pre> <p>\u7f16\u8bd1\u5b8c\u6210\u540e\u540c\u6837\u9700\u8981\u5c06obj/riscv-pke\u4e0eobj/app_host_device\u6587\u4ef6\u4f20\u8f93\u5230\u5f00\u53d1\u677f\u4e2d\uff0c\u7136\u540e\u518d\u901a\u8fc7ssh\u534f\u8bae\u8fde\u63a5\u5230\u5f00\u53d1\u677f\uff0c\u5728ssh\u4f1a\u8bdd\u4e2d\u6267\u884c\u4ee5\u4e0b\u547d\u4ee4\u70e7\u5f55\u5e76\u8fd0\u884c\u7a0b\u5e8f\uff1a</p> <pre><code>$ sudo ./program.sh # \u82e5\u91cd\u542f\u8fc7\u5f00\u53d1\u677f\uff0c\u5219\u5728\u6267\u884c\u7a0b\u5e8f\u524d\u8981\u5148\u6267\u884c\u6b64\u811a\u672c\u8fdb\u884c\u70e7\u5f55\n$ sudo ./riscv-fesvr riscv-pke app_host_device\n</code></pre> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter7_device/#_9","title":"\u5b9e\u9a8c\u5185\u5bb9","text":"<p>\u5982\u5e94\u7528\u63d0\u793a\u6240\u8868\u793a\u7684\u90a3\u6837\uff0c\u8bfb\u8005\u9700\u8981\u627e\u5230\u5e76\u5b8c\u6210\u5bf9open\u548cioctl\u7684\u8c03\u7528\uff0c\u4f7f\u5f97\u7528\u6237\u80fd\u591f\u8bbe\u7f6e\u8bbe\u5907\u53c2\u6570\uff0c\u4ece\u800c\u63a7\u5236\u6444\u50cf\u5934\u5b9e\u73b0\u62cd\u7167\u7b49\u529f\u80fd\uff1b\u83b7\u53d6\u56fe\u7247\u540e\uff0c\u68c0\u67e5\u6570\u636e\uff0c\u4ece\u800c\u5224\u65ad\u524d\u65b9\u662f\u5426\u51fa\u73b0\u969c\u788d\u7269\u3002</p> <p>\u8ddf\u8e2a\u76f8\u5173\u7cfb\u7edf\u8c03\u7528\uff0c\u5728kernel/file.c\u91cc\u53ef\u4ee5\u770b\u5230\u9700\u8981\u8865\u5145\u7684\u51fd\u6570\uff1a</p> <pre><code> 25 int do_open(char *pathname, int flags) {\n26     // TODO (lab4_3): call host open through spike_file_open and then bind fd to spike_file\n27     // hint: spike_file_dup function can bind spike_file_t to an int fd.\n28     panic( \"You need to finish open function in lab4_3.\\n\" );\n29 }\n30 int do_write(int fd, char *buf, uint64 count) {\n31     spike_file_t *f = spike_file_get(fd);\n32     return spike_file_write(f, buf, count);\n33 }\n34 int do_close(int fd) {\n35     spike_file_t *f = spike_file_get(fd);\n36     return spike_file_close(f);\n37 }\n38 39 int do_ioctl(int fd, uint64 request, char *data) {\n40     // TODO (lab4_3): call host ioctl through frontend_sycall\n41     // hint: fronted_syscall ioctl argument:\n42     // 1.call number\n43     // 2.fd\n44     // 3.the order to device\n45     // 4.data address\n46     panic( \"You need to call host's ioctl by frontend_syscall in lab4_3.\\n\" );\n47 }\n</code></pre> <p>\u5b9e\u9a8c\u9884\u671f\u7ed3\u679c\uff1a\u5c0f\u8f66\u5728\u524d\u8fdb\u8fc7\u7a0b\u4e2d\u80fd\u591f\u6b63\u5e38\u8bc6\u522b\u969c\u788d\u7269\u540e\u5e76\u81ea\u52a8\u505c\u8f66\u3002\u6d4b\u8bd5\u65f6\u522b\u5fd8\u8bb0\u628a\u6444\u50cf\u5934\u63a5\u5230USB\u63a5\u53e3\uff0c\u5426\u5219\u7cfb\u7edf\u4f1a\u627e\u4e0d\u5230\u8bbe\u5907\u6587\u4ef6\u3002</p> <p></p>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter7_device/#_10","title":"\u5b9e\u9a8c\u6307\u5bfc","text":""},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter7_device/#_11","title":"\u6444\u50cf\u5934\u63a7\u5236","text":"<p>USB\u6444\u50cf\u5934\u6700\u57fa\u7840\u7684\u63a7\u5236\u65b9\u6cd5\u662f\u4f7f\u7528\u8bfb\u5199\u8bbe\u5907\u6587\u4ef6\u7684\u65b9\u5f0f\u3002\u62cd\u6444\u4e00\u5f20\u7167\u7247\u5305\u542b\u4ee5\u4e0b\u8fc7\u7a0b\uff1a</p> <ul> <li>\u6253\u5f00\u8bbe\u5907\u6587\u4ef6\uff0c\u4f7f\u7528open\u51fd\u6570</li> <li>\u8bbe\u7f6e\u8bbe\u5907\u53c2\u6570\uff0c\u4f7f\u7528ioctl\u51fd\u6570\uff0c\u5305\u62ec\u8bbe\u7f6e\u6444\u50cf\u5934\u7684\u56fe\u50cf\u5206\u8fa8\u7387\u548c\u683c\u5f0f\u3001\u8bfb\u53d6\u65b9\u5f0f\u3001\u7f13\u51b2\u6570\u91cf\u548c\u7d22\u5f15\u7b49</li> <li>\u6620\u5c04\u5185\u5b58\uff0c\u7531\u4e8eUSB\u6444\u50cf\u5934\u5bf9\u5e94\u7684\u8bbe\u5907\u6587\u4ef6\u4e0d\u652f\u6301\u76f4\u63a5\u7528read\u51fd\u6570\u8fdb\u884c\u8bfb\u5199\uff0c\u6240\u4ee5\u9700\u8981\u7528mmap\u51fd\u6570\u5c06\u6587\u4ef6\u6620\u5c04\u5230\u4e00\u6bb5\u865a\u62df\u5730\u5740\uff0c\u901a\u8fc7\u865a\u62df\u5730\u5740\u8fdb\u884c\u8bfb\u5199</li> <li>\u62cd\u6444\uff0c\u4f7f\u7528ioctl\u51fd\u6570\u63a7\u5236\uff0c\u8bbe\u7f6e\u7f13\u51b2\u533a\u7684\u5165\u961f\u548c\u51fa\u961f\u4e3a\u4e00\u4e2a\u62cd\u6444\u8fc7\u7a0b</li> <li>\u7ed3\u675f\u548c\u6e05\u7406\uff0c\u5305\u542b\u4f7f\u7528ioctl\u51fd\u6570\u5173\u95ed\u8bbe\u5907\uff0c\u4f7f\u7528munmap\u51fd\u6570\u89e3\u6620\u5c04\uff0c\u4f7f\u7528close\u51fd\u6570\u5173\u95ed\u8bbe\u5907\u6587\u4ef6</li> </ul>"},{"location":"OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/pke-doc/chapter7_device/#_12","title":"\u56fe\u7247\u89e3\u6790","text":"<p>\u5728\u672c\u5b9e\u9a8c\u7684\u7528\u6237\u7a0b\u5e8f\u4e2d\uff0c\u6211\u4eec\u5b9e\u73b0\u4e86\u4e00\u4e2a\u975e\u5e38\u7b80\u5355\u7684\u969c\u788d\u7269\u5224\u65ad\u7b97\u6cd5\uff1a\u8ba1\u7b97\u7070\u5ea6\u5c0f\u4e8e64\u7684\u50cf\u7d20\u70b9\u4e2a\u6570\uff0c\u5982\u679c\u4e2a\u6570\u5927\u4e8e\u50cf\u7d20\u70b9\u603b\u6570\u76847/10\uff0c\u5373\u8ba4\u4e3a\u524d\u65b9\u662f\u969c\u788d\u7269\u3002</p> <p>\u5e94\u7528\u7b2c21\u884c\u53ef\u4ee5\u770b\u5230\uff0c\u6211\u4eec\u4ece\u6444\u50cf\u5934\u83b7\u53d6\u7684\u6570\u636e\u662fYUYV\u683c\u5f0f\uff0c\u8bfb\u8005\u53ef\u8fdb\u884c\u67e5\u9605\uff0c\u5b83\u7528\u7070\u5ea6\u3001\u84dd\u8272\u8272\u5ea6\u3001\u7ea2\u8272\u8272\u5ea6\u4e09\u4e2a\u5c5e\u6027\u8868\u793a\u989c\u8272\uff0c\u6bcf\u4e2a\u50cf\u7d20\u70b9\u90fd\u6709\u7070\u5ea6\u5c5e\u6027\u3002\u7531\u4e8e\u6211\u4eec\u5206\u6790\u969c\u788d\u7269\u53ea\u9700\u8981\u7070\u5ea6\u56fe\uff0c\u6240\u4ee5\u53d6\u6bcf\u4e2a\u50cf\u7d20\u70b9\u7684\u7070\u5ea6\u5c5e\u6027\u5373\u53ef\u3002\u56e0\u6b64\u5bf9\u4e8e\u83b7\u53d6\u8fc7\u6765\u7684\u6570\u636e\u5220\u53bb\u5947\u6570\u7d22\u5f15\u7684\u6570\u636e\uff0c\u5c31\u53ef\u4ee5\u5f97\u5230\u7070\u5ea6\u56fe\u3002</p> <p>\u6ce8\u610f\uff1a\u5bf9\u4e8e\u7070\u5ea6\u9608\u503c\u7684\u8bbe\u5b9a\u53ef\u6839\u636e\u73af\u5883\u4eae\u5ea6\u8fdb\u884c\u4e00\u5b9a\u7684\u8c03\u6574\uff0c\u53ef\u4ee5\u5148\u6839\u636e\u6444\u50cf\u5934\u8fd4\u56de\u7684\u56fe\u50cf\u8fdb\u884c\u5206\u6790\uff0c\u8ba1\u7b97\u51fa\u5bf9\u5e94\u969c\u788d\u7269\u7684\u7070\u5ea6\u503c\uff1b\u7070\u5ea6\u9608\u503c\u8d8a\u7cbe\u786e\uff0c\u5c0f\u8f66\u5bf9\u4e8e\u969c\u788d\u7269\u7684\u8bc6\u522b\u5c06\u8d8a\u7075\u654f\uff0c\u5e76\u80fd\u5728\u5408\u7406\u7684\u8ddd\u79bb\u5185\u8bc6\u522b\u5230\u969c\u788d\u7269\u5e76\u505c\u8f66\u3002 \u867d\u7136\u5982\u6b64\uff0c\u8be5\u7b97\u6cd5\u4ecd\u4e0d\u662f\u975e\u5e38\u7cbe\u786e\u3002\u6240\u4ee5\uff0c\u8fd9\u91cc\u7ed9\u51fa\u7684\u969c\u788d\u7269\u5224\u65ad\u7b97\u6cd5\u4ec5\u4f9b\u53c2\u8003\uff0c\u6211\u4eec\u9f13\u52b1\u5927\u5bb6\u7f16\u5199\u66f4\u9ad8\u7ea7\u7684\u7b97\u6cd5\uff0c\u5b9e\u73b0\u66f4\u5f3a\u5927\u7684\u529f\u80fd\u3002</p> <p>\u5b9e\u9a8c\u5b8c\u6bd5\u540e\uff0c\u8bb0\u5f97\u63d0\u4ea4\u4fee\u6539\uff08\u547d\u4ee4\u884c\u4e2d-m\u540e\u7684\u5b57\u7b26\u4e32\u53ef\u81ea\u884c\u786e\u5b9a\uff09\uff0c\u4ee5\u4fbf\u5728\u540e\u7eed\u5b9e\u9a8c\u4e2d\u7ee7\u627flab4_3\u4e2d\u6240\u505a\u7684\u5de5\u4f5c\uff1a</p> <pre><code>$ git commit -a -m \"my work on lab4_3 is done.\"\n</code></pre>"},{"location":"%E5%89%8D%E7%AB%AF/HomePage/","title":"Roll's Home","text":"<p>\u5f00\u542f\u6211\u7684\u4e2a\u4eba\u4e3b\u9875\u4e4b\u65c5\uff01</p> <ul> <li>\u5f00\u59cb\u642d\u5efa\u81ea\u5df1\u7684\u4e3b\u98752023.6.9</li> <li>\u8fd9\u91cc\u8bb0\u5f55\u5728\u642d\u5efa\u4e3b\u9875\u65f6\u9047\u5230\u95ee\u9898</li> <li>\u76ee\u524d\u4ecd\u6253\u7b97\u7528cra\u548cantd\u8fd8\u6709\u5176\u4ed6\u7ec4\u4ef6\u6765\u5b9e\u73b0</li> <li>\u8fd9\u5c31\u610f\u5473\u7740\u6211\u9700\u8981\u5bf9\u6211\u7684\u4e91\u670d\u52a1\u5668\u6e05\u7406\u4e00\u756a</li> <li>\u52a0\u6cb9\u5427\uff01\u575a\u6301\u4e0b\u6765!</li> <li>\u653e\u4e0a\u4ed3\u5e93github</li> </ul>"},{"location":"%E5%89%8D%E7%AB%AF/HomePage/#steps","title":"Steps","text":"<ul> <li>\u9875\u9762\u901a\u8fc7useScroll\u8bbe\u8ba1</li> <li>\u914d\u7f6e\u4e00\u4e2a\u540e\u53f0\u5199\u535a\u5ba2</li> <li>\u8bbe\u8ba1\u6570\u636e\u5e93\u8bb0\u5f55\u535a\u5ba2\uff08\u8003\u8651\u662f\u5426\u901a\u8fc7markdown\u5f62\u5f0f\uff09</li> <li>\u5c55\u793a\u535a\u5ba2</li> <li>\u81ea\u6211\u4ecb\u7ecd</li> </ul>"},{"location":"%E5%89%8D%E7%AB%AF/HomePage/#design","title":"design","text":"<ul> <li>\u4e3b\u9875\u80cc\u666f\uff08\u6211\u559c\u6b22\u7684\u98ce\u683c\uff09</li> <li>\u4e3b\u9875\u5148\u7ed9\u51fa\u51e0\u4e2a\u724c\u724c\uff0c\u724c\u724c\u53ef\u4ee5</li> <li>\u56fe\u7247\u7ffb\u8f6c</li> <li>\u6587\u5b57\u7ffb\u8f6c</li> <li> <p>\u7ffb\u8f6c\u5230Roll\u7684\u65f6\u5019\u7ed9\u4e00\u4e2a\u7279\u6548</p> </li> <li> <p>\u53c2\u80031 \u53ef\u4ee5\u5b66\u4e60\u9876\u90e8\u5e95\u4e0b\u7684\u6eda\u52a8\u7684tag\uff0c\u7528\u6765\u5c55\u793a\u81ea\u5df1 \u8fd8\u53ef\u4ee5\u5b66\u4e60\u5361\u7247\u7684\u5e03\u5c40</p> </li> <li> <p>\u53c2\u80032 \u53ef\u4ee5\u5b66\u4e60\u9876\u90e8\u83dc\u5355\u680f\u7684button</p> </li> <li> <p>\u53c2\u80033 \u53ef\u4ee5\u5b66\u4e60\u9876\u90e8\u7684\u53cc\u8272\u8bbe\u8ba1</p> </li> <li> <p>\u53c2\u80034 \u53ef\u4ee5\u5b66\u4e60\u6eda\u52a8\u7684\u4ea4\u4e92</p> </li> <li> <p>coolors \u914d\u8272\u7f51\u7ad9</p> </li> </ul>"},{"location":"%E5%89%8D%E7%AB%AF/HomePage/#record","title":"record","text":"<ul> <li>\u4e86\u89e3\u5230\u4e86\u4e00\u4e2a\u5f88\u6709\u98ce\u683c\u7684\u8bbe\u8ba1\u5e08\uff08\u524d\u7aef\u5f00\u53d1\u8005\uff09302chanwoo,\u540c\u6837\u4f7f\u7528React\u5e93\uff0c\u5e76\u4e14\u4f7f\u7528\u4e86threeJS\u5f00\u53d1\u3002<code>\u53d1\u73b0\u4e86\u4ed6\u7684github\u4ed3\u5e93\uff01</code>\u8fd9\u91cc</li> <li>lottiefiles\u8fd9\u662f\u4e00\u4e2a\u6bd4gif\u66f4\u8f7b\u91cf\u7684animation\u683c\u5f0f\uff0c\u5728\u8fd9\u4e2a\u7f51\u9875\u4e0a\u80fd\u591f\u627e\u5230\u5f88\u591a\u514d\u8d39\u8d44\u6e90 \u4f7f\u7528 <code>Lottie JSON</code> \u6216 <code>dotLottie</code> \u52a8\u753b\u4f5c\u4e3a\u56fe\u6807\u3001\u7f29\u7565\u56fe\u3001\u9875\u9762\u80cc\u666f\u3001\u9875\u9762\u52a0\u8f7d\u5668\u3001\u81ea\u5b9a\u4e49\u52a8\u753b\u5149\u6807\u7b49\u7b49\u3002</li> <li>WebFlow:<code>Build with the power of code \u2014 without writing any</code>(\u5751\uff0c\u8981\u4ed8\u8d39\u624d\u80fd\u5bfc\u51fa\u4ee3\u7801\uff0c\u4f5c\u7528\u4e0d\u5927)</li> </ul>"},{"location":"%E5%89%8D%E7%AB%AF/HomePage/#failure","title":"failure","text":"<p>\u8e29\u8fc7\u7684\u5751</p> <ul> <li>\u4f7f\u7528Link\u8fdb\u884c\u56fe\u6807\u7684\u8df3\u8f6c\u65f6\u95f4\u65f6\u51fa\u73b0\u4e86\u9519\u8bef\uff0c\u53ef\u80fd\u4f1a\u6539\u53d8\u56fe\u6807\u7684\u6837\u5f0f</li> <li>\u91c7\u7528\u6eda\u52a8\u52a8\u753b\u65f6\u5e94\u8be5\u5173\u95ed\u7528\u6237\u6eda\u8f6e\u8f93\u5165\uff0c\u5426\u5219\u4f1a\u51fa\u73b0\u5361\u987f</li> <li>\u6253\u5305react\u6587\u4ef6\u65f6\u6ca1\u6709\u5728package.json\u4e2d\u6307\u5b9ahomePage</li> </ul>"},{"location":"%E5%89%8D%E7%AB%AF/LearnKoa/","title":"Koa2","text":"<p>\u5b66\u4e60\u76ee\u7684</p> <p>\u5c1d\u8bd5\u5728\u5b9d\u5854\u9762\u677f\u4e0a\u90e8\u7f72Koa\u670d\u52a1\u5668\u5e76\u63d0\u4f9bMysql\u7684acid\u7684api\u63a5\u53e3</p> <p>ZJAccelerator\u7cfb\u7edf\u540e\u7aef\u4ed3\u5e93github</p>"},{"location":"%E5%89%8D%E7%AB%AF/LearnReact/","title":"React+Antd","text":""},{"location":"%E5%89%8D%E7%AB%AF/LearnReact/#node","title":"Node\u5e38\u7528\u6307\u4ee4","text":"<ul> <li><code>npm init</code> \u521d\u59cb\u5316\u4e00\u4e2apackage.json</li> <li><code>npm install  modulename --save</code> \u5b89\u88c5\u67d0\u6a21\u5757</li> <li><code>npm install modulename@xxx --save</code>\u5b89\u88c5xxx\u7248\u672c\u53f7\u7684\u6a21\u5757</li> <li><code>npm install xxx -g</code>\u5168\u5c40\u5b89\u88c5</li> <li><code>npm uninstall modulename --save</code></li> <li><code>npm install devmodule --save-dev</code> \u5f00\u53d1\u6a21\u5757\u4e0b\u7528\u5230\u7684\u6a21\u5757(dependencies)</li> <li><code>npm update --save</code> \u6a21\u5757\u66f4\u65b0</li> <li><code>npm outdate</code> \u67e5\u770b\u8fc7\u671f\u6a21\u5757</li> <li><code>npm view xxx</code> \u67e5\u770b\u6a21\u5757</li> </ul>"},{"location":"%E5%89%8D%E7%AB%AF/LearnReact/#_1","title":"\u5b66\u4e60\u94fe\u63a5","text":"<p>TypeScript\u57fa\u7840</p> <p>\u5185\u5bb9\u5c0f\u591a\uff0c\u53ef\u4ee5\u7c97\u7565\u770b\u4e00\u4e0b\uff0c\u5176\u4e2d\u4e94\u3001TypeScript\u7c7b\u7684\u6982\u5ff5\u548c\u4f7f\u7528\u6bd4\u8f83\u91cd\u8981\uff0c\u56e0\u4e3a\u4f60\u5728\u4f7f\u7528antd\u7684\u65f6\u5019\u9700\u8981\u5927\u91cf\u7528\u5230\u7c7b\u7ec4\u4ef6</p> <p>React\u57fa\u7840</p> <p>\u7c97\u7565\u770b\u770b\uff0c\u4e86\u89e3\u5c31\u597d</p> <p>React\u5f00\u53d1\u8fdb\u9636</p> <p>\u8fd9\u4e2a\u6bd4\u8f83\u91cd\u8981\uff0c\u56e0\u4e3a\u91cc\u9762\u8bb2\u4e86</p> <ul> <li>create-react-app</li> <li>react-router-dom</li> <li>\u5168\u5c40\u72b6\u6001\u7ba1\u7406</li> <li>antd</li> </ul> <p>\u503c\u5f97\u5b66\u4e60\uff0c\u56e0\u4e3a\u91cc\u9762\u7684\u4e1c\u897f\u90fd\u662f\u4f60\u9700\u8981\u7528\u5230\u7684</p> <p>React Quick Start</p> <p>\u5f88\u77ed\u7684\u4e00\u4e2a\u6559\u7a0b\uff0c\u5927\u6982\u4e86\u89e3\u4e00\u4e0b\u7ec4\u4ef6\u548cuseState\u7684\u7528\u6cd5\uff0c\u53ef\u4ee5\u4e0d\u770b</p> <p>useState</p> <p>\u8fd9\u4e2a\u4f1a\u6bd4\u8f83\u91cd\u8981\uff0c\u4e00\u5b9a\u8981\u770b\u770b</p> <p>useEffect</p> <p>\u8fd9\u4e2a\u4e5f\u7528\u7684\u6bd4\u8f83\u591a</p> <p>npm\u5b98\u7f51</p> <p>\u4f60\u53ef\u4ee5\u5728\u8fd9\u91cc\u67e5\u627e\u4f60\u9700\u8981\u7528\u5230\u7684\u6a21\u5757\uff08\u5305/\u4f9d\u8d56\uff09</p>"},{"location":"%E5%89%8D%E7%AB%AF/LearnReact/#git","title":"git\u4ed3\u5e93","text":"<pre><code>git clone https://github.com/RollRoll520/Rml.git\n</code></pre> <p>\u53ef\u4ee5\u5728\u8d44\u6e90\u7ba1\u7406\u5668\u5bfc\u822a\u680f\u8f93\u5165cmd\u6253\u5f00\u5feb\u6377\u547d\u4ee4\u884c \u65b0\u5efa\u4e00\u4e2a\u6587\u4ef6\u5939\uff0c\u4f7f\u7528\u4ee5\u4e0a\u547d\u4ee4\u83b7\u53d6\u9879\u76ee \u62c9\u53d6\u4e4b\u540e\u5728\u6839\u76ee\u5f55\u4e0b\u547d\u4ee4\u884c\u4f7f\u7528 <code>npm i</code></p>"},{"location":"%E5%89%8D%E7%AB%AF/LearnWXMiniProgram/","title":"\u5fae\u4fe1\u5c0f\u7a0b\u5e8f","text":"\u5b66\u4e60\u76ee\u7684 <p>\u5b9e\u73b0\u4e00\u4e2a\u4f20\u64ad\u4f20\u7edf\u6587\u5316\u7684\u4ea4\u4e92\u5e73\u53f0</p> TodoFinished <p>Todo</p> <ul> <li> \u5b8c\u6210\u6587\u7ae0\u8be6\u60c5\u9875\u6837\u5f0f</li> <li> \u6dfb\u52a0\u5c55\u5385\u9875\u7684\u52a0\u8f7d\u753b\u9762</li> <li> \u5c1d\u8bd5\u4f7f\u7528\u53ef\u4ee5\u6ed1\u52a8\u7684\u753b\u5e03\u6765\u5c55\u793a\u5404\u4e2a\u5c55\u5385</li> <li> \u5236\u4f5c\u591a\u4e2a\u5c55\u5385\u7684\u5168\u666f\u73af\u5883\u6570\u636e</li> <li> \u5b9e\u73b0\u901a\u8fc7\u5207\u6362\u9875\u9762\u7684\u65b9\u5f0f\u66f4\u6362\u5c55\u5385\u573a\u666f\uff08\u4e4b\u540e\u53ef\u4ee5\u8003\u8651\u4f18\u5316\uff09</li> <li> \u642d\u5efa\u670d\u52a1\u5668\u63d0\u4f9b\u6570\u636e\u5e93\u63a5\u53e3</li> </ul> <p>Finished</p> <ul> <li> \u5b8c\u6210\u4e86\u9762\u5177\u7684\u5bfc\u51fa</li> <li> \u65e0\u6cd5\u52a0\u8f7d\u573a\u666f\u6a21\u578b\uff0c\u4f46\u4fee\u6539\u65b9\u6848\u4e3a\u5168\u666f\u56fe\u7247</li> <li> \u4f7f\u7528\u5168\u666f\u56fe\u7247\u4f5c\u4e3a\u73af\u5883\u6570\u636e\uff0c\u76f8\u673a\u80fd\u591f\u6839\u636e\u89e6\u6478\u5c4f\u5e55\u79fb\u52a8</li> <li> \u53ef\u4ee5\u505a\u5230\u70b9\u51fb\u4e8b\u4ef6\u7684\u76d1\u542c\uff0c\u4f46\u66f4\u6539<code>xr-assets</code>\u7684<code>url</code>\u4e4b\u540e\u5e76\u4e0d\u80fd\u505a\u5230\u6a21\u578b\u8d44\u6e90\u7684\u52a8\u6001\u52a0\u8f7d</li> </ul>"},{"location":"%E5%89%8D%E7%AB%AF/SoftBei-IMS/","title":"SoftBei-IMS","text":"<p>\u57fa\u4e8e\u673a\u5668\u5b66\u4e60\u7684\u5206\u5e03\u5f0f\u7cfb\u7edf\u6545\u969c\u8bca\u65ad\u7cfb\u7edf--\u5927\u8d5b\u5b98\u7f51</p> \u7b80\u4ecb\u7cfb\u7edf\u8981\u6c42\u6280\u672f\u6808\u5b98\u65b9\u6587\u6863\u94fe\u63a5 <p>\u8bb0\u5f55\u8bca\u65ad\u7cfb\u7edf\u524d\u540e\u7aef\u7684\u5b9e\u73b0</p> <ul> <li> \u8be5\u5e73\u53f0\u652f\u6301\u7528\u6237\u4e0a\u4f20\u8bad\u7ec3\u6570\u636e\u5e76\u5728\u7ebf\u8bad\u7ec3\uff0c\u8bad\u7ec3\u5b8c\u6210\u540e\u53ef\u4e0b\u8f7d\u8bad\u7ec3\u6a21\u578b</li> <li> \u8be5\u5e73\u53f0\u652f\u6301\u5355\u6761\u6216\u8005\u6279\u91cf\u6d4b\u8bd5\u6837\u672c\u4e0a\u4f20\uff0c\u5e76\u53ef\u89c6\u5316\u5206\u7c7b\u7ed3\u679c\uff0c\u540c\u65f6\u652f\u6301\u4e0b\u8f7d\u5206\u7c7b\u7ed3\u679c</li> <li> \u7cfb\u7edf\u8fd0\u884c\u6d41\u7545</li> <li> WEB\u7684UI\u754c\u9762\u7f8e\u89c2\u7b80\u6d01\u3001\u4eba\u673a\u4ea4\u4e92\u53cb\u597d</li> </ul> <ul> <li> React+Antd   \u8d1f\u8d23\u524d\u7aef\u6574\u4f53\u5e03\u5c40</li> <li> React-Spring   \u5b9e\u73b0\u66f4\u52a0\u7f8e\u89c2\u7684\u52a8\u753b\uff0c\u7f8e\u5316\u524d\u7aef</li> <li> Antv   \u7528\u4e8e\u6570\u636e\u53ef\u89c6\u5316</li> <li> Koa2   \u8d1f\u8d23\u540e\u7aef\u63a5\u53e3</li> </ul> <ul> <li>  Antd</li> <li>  Antv</li> <li> React-Spring</li> </ul>"},{"location":"%E5%89%8D%E7%AB%AF/SoftBei-IMS/#_1","title":"\u8bb0\u5f55","text":"<p>Landing\u7f16\u8f91\u5668</p> <p>\u4f7f\u7528<code>Landing</code>\u7f16\u8f91\u5668\u8bbe\u8ba1\u7f51\u9875\uff0c\u5bfc\u51fa\u540e\u53d1\u73b0\u4e0eantd5\u4e0d\u517c\u5bb9\uff01</p> <p>\u786e\u5b9e\u633a\u597d\u7684\uff0c\u800c\u4e14\u611f\u89c9\u6bd4<code>WebFlow</code>\u826f\u5fc3\u5f88\u591a\uff0c\u53ea\u53ef\u60dc\u4e0d\u517c\u5bb9antd5\uff0c\u5e76\u4e14\u662fjsx\u9879\u76ee</p> <p>\u867d\u7136\u65e0\u6cd5\u6b63\u5e38\u4f7f\u7528\uff0c\u4f46\u53ef\u4ee5\u4ece\u4e0b\u8f7d\u7684\u4ee3\u7801\u4e2d\u8fdb\u884c\u5b66\u4e60</p>"},{"location":"%E5%89%8D%E7%AB%AF/SoftBei-IMS/#0622record","title":"0622record","text":"<p>\u5c1d\u8bd5\u4fee\u6539lottieFile\u7684\u52a0\u8f7d\u65b9\u5f0f</p> origin:\u901a\u8fc7assets\u4e2d\u52a0\u8f7dpolish:\u4f18\u5316\u4e3a\u6309\u9700\u52a0\u8f7dpolish:\u4f18\u5316\u4e3a\u61d2\u52a0\u8f7dupdate:\u901a\u8fc7url\u52a0\u8f7dlottie <ul> <li>\u901a\u8fc7<code>MyLottie</code>\u7ec4\u4ef6\u5bf9<code>assets</code>\u4e2d\u7684<code>json</code>\u6587\u4ef6\u8fdb\u884c\u904d\u5386\u52a0\u8f7d</li> <li>\u5728\u521a\u52a0\u8f7d\u5b8c\u9875\u9762\u65f6\u4f1a\u51fa\u73b0\u77ed\u65f6\u95f4\u7684\u5361\u987f\u73b0\u8c61 \u52a0\u8f7d\u6240\u6709lottie\u6587\u4ef6<pre><code>const data = {};\nconst req = require.context(\"../../assets/\", true, /\\.json$/);\nreq.keys().forEach((filename) =&gt; {\ndata[filename.replace(/\\.\\/(.+)\\.json/, \"$1\")] = req(filename);\n});\n</code></pre></li> </ul> <ul> <li>\u539f\u6765\u7684\u65b9\u5f0f\u5728\u7ec4\u4ef6\u6302\u8f7d\u65f6\u4f1a\u5c06\u6240\u6709\u7684 <code>lottie</code> \u6587\u4ef6\u90fd\u52a0\u8f7d\u8fdb\u6765\uff0c\u8fd9\u6837\u4f1a\u5360\u7528\u8f83\u591a\u7684\u5185\u5b58\u548c\u7f51\u7edc\u5e26\u5bbd\uff0c\u56e0\u6b64\u5f53\u6587\u4ef6\u5939\u4e0b\u7684 <code>Lottie</code> \u6587\u4ef6\u8f83\u591a\u65f6\uff0c\u53ef\u80fd\u4f1a\u5bfc\u81f4\u9875\u9762\u52a0\u8f7d\u7f13\u6162\u6216\u8005\u5361\u987f\u3002</li> <li>\u4fee\u6539\u4e3a\uff1a\u5c06 <code>Lottie JSON</code> \u6587\u4ef6\u7684\u52a0\u8f7d\u653e\u5728\u7ec4\u4ef6\u7684\u56de\u8c03\u51fd\u6570\u4e2d\uff0c\u5728\u7ec4\u4ef6\u7684 <code>onLoad</code> \u56de\u8c03\u51fd\u6570\u4e2d\u52a0\u8f7d <code>Lottie JSON</code> \u6587\u4ef6\uff0c\u8fd9\u6837\u53ea\u6709\u5f53\u7ec4\u4ef6\u5b9e\u9645\u9700\u8981\u52a0\u8f7d\u67d0\u4e2a <code>lottie</code> \u6587\u4ef6\u65f6\u624d\u4f1a\u8fdb\u884c\u52a0\u8f7d\u3002</li> <li>\u6548\u679c\uff1a\u975e\u5e38\u660e\u663e\uff01\u51cf\u5c11\u4e86\u660e\u663e\u7684\u5361\u987f\uff0c\u4e5f\u4f18\u5316\u4e86\u5185\u5b58\u548c\u7f51\u7edc\u5e26\u5bbd \u6309\u9700\u52a0\u8f7dlottie\u6587\u4ef6<pre><code>useEffect(() =&gt; {\nconst fetchData = async () =&gt; {\nconst data = await import(`../../assets/${type}.json`);\nsetAnimationData(data);\n};\nfetchData();\n}, [type]);\n</code></pre></li> </ul> <ul> <li>\u61d2\u52a0\u8f7d\u662f\u6307\u5c06\u7ec4\u4ef6\u6216\u6a21\u5757\u7684\u52a0\u8f7d\u63a8\u8fdf\u5230\u7ec4\u4ef6\u6216\u6a21\u5757\u9996\u6b21\u4f7f\u7528\u65f6\u518d\u8fdb\u884c\u52a0\u8f7d\u3002</li> <li>\u4f7f\u7528 <code>React.lazy</code> \u6765\u52a8\u6001\u52a0\u8f7d <code>lottie</code> \u7ec4\u4ef6\uff0c\u7136\u540e\u4f7f\u7528 <code>Suspense</code> \u7ec4\u4ef6\u6765\u5305\u88f9\u9700\u8981\u61d2\u52a0\u8f7d\u7684\u7ec4\u4ef6\uff0c\u5e76\u63d0\u4f9b\u4e00\u4e2a <code>fallback</code> \u5c5e\u6027\uff0c\u6307\u5b9a\u7ec4\u4ef6\u52a0\u8f7d\u65f6\u7684 <code>loading</code> \u754c\u9762\u3002\u8fd9\u6837\uff0c\u5728\u7ec4\u4ef6\u9996\u6b21\u4f7f\u7528\u65f6\u624d\u4f1a\u8fdb\u884c\u52a0\u8f7d\uff0c\u53ef\u4ee5\u6709\u6548\u5730\u4f18\u5316\u9875\u9762\u52a0\u8f7d\u6027\u80fd\u3002</li> <li>\u6548\u679c\uff1a\u61d2\u52a0\u8f7d\u7528\u4e8e\u4f18\u5316\u9875\u9762\u52a0\u8f7d\u6027\u80fd\uff0c\u4f46\u5b9e\u9645\u4e0a\u6211\u4eec\u7684\u9875\u9762\u7684\u6240\u6709\u7ec4\u4ef6\u5728\u9996\u6b21\u52a0\u8f7d\u65f6\u90fd\u4f7f\u7528\u5230\u4e86\uff0c\u56e0\u6b64\u4f18\u5316\u6548\u679c\u4e0d\u660e\u663e\u3002</li> <li>\u4f18\u70b9\uff1a\u63d0\u4f9b\u4e86\u8d44\u6e90\u52a0\u8f7d\u672a\u6210\u529f\u7684loading\u5143\u7d20 \u61d2\u52a0\u8f7dlottie\u7ec4\u4ef6<pre><code>import { lazy, Suspense } from \"react\";\nconst LazyMyLottie = lazy(() =&gt; import(\"./MyLottie\"));\nconst App = () =&gt; {\nreturn (\n&lt;div&gt;\n&lt;Suspense fallback={&lt;div&gt;Loading...&lt;/div&gt;}&gt;\n&lt;LazyMyLottie type=\"lottie1\" /&gt;\n&lt;/Suspense&gt;\n&lt;Suspense fallback={&lt;div&gt;Loading...&lt;/div&gt;}&gt;\n&lt;LazyMyLottie type=\"lottie2\" /&gt;\n&lt;/Suspense&gt;\n&lt;Suspense fallback={&lt;div&gt;Loading...&lt;/div&gt;}&gt;\n&lt;LazyMyLottie type=\"lottie3\" /&gt;\n&lt;/Suspense&gt;\n&lt;/div&gt;\n);\n};\nexport default App;\n</code></pre></li> </ul> <ul> <li> finish</li> <li> todo:\u4fee\u6539\u5ba2\u6237\u7aef\u4ee3\u7406\uff0c\u907f\u5f00cors\u7b56\u7565</li> <li>\u5f53<code>lottie</code>\u6587\u4ef6\u8fc7\u591a\u65f6\uff0c\u5b58\u5728\u9700\u8981\u5c06<code>lottie</code>\u6587\u4ef6\u96c6\u4e2d\u653e\u5728\u670d\u52a1\u5668\u4e2d\u7684\u9700\u6c42\u3002</li> <li>\u5f53\u524d\u7684<code>lottie</code>\u52a0\u8f7d\u53ea\u80fd\u901a\u8fc7\u672c\u5730\u6587\u4ef6\u52a0\u8f7d\u3002</li> <li>\u5e0c\u671b\u8bbe\u8ba1\u7684\u7ec4\u4ef6\u4f7f\u7528\u65b9\u5f0f\u8db3\u591f\u7b80\u6d01\uff0c\u4fbf\u4e8e\u4f7f\u7528\uff0c\u4e14\u4e0d\u5f71\u54cd\u539f\u6765\u672c\u5730<code>lottie</code>\u7684\u4f7f\u7528\u3002</li> </ul>"},{"location":"%E5%89%8D%E7%AB%AF/SoftBei-IMS/#0625record","title":"0625record","text":"<p>\u4eca\u5929\u7684\u4efb\u52a1\uff1a\u901a\u8fc7\u4ee3\u7406\u89e3\u51b3\u8de8\u57df\uff01\u95ee\u9898\u5206\u6790\u5c1d\u8bd5\u7ed3\u8bba <ul> <li>\u5ba2\u6237\u7aef\u672a\u8bbe\u7f6e\u4ee3\u7406</li> <li> \u672a\u5b8c\u6210\uff0c\u56e0\u4e3a\u6536\u5230\u4e86chanwoo hwang\u7684\u56de\u4fe1</li> <li>OpenGL\u771f\u7684\u9700\u8981\u597d\u597d\u5b66\u5b66\uff01</li> <li>gsap\u4e0d\u9519\u7684\u5e93\uff01chan\u63a8\u8350\u7684</li> </ul> <ul> <li>json\u4e0d\u540c\u4e8e\u56fe\u7247\uff0c\u56fe\u7247\u4e0d\u53d7\u6d4f\u89c8\u5668cors\u5f71\u54cd\uff0c\u800cjson\u4f1a\u53d7\u5230\u9650\u5236</li> <li>\u6216\u8bb8\u76ee\u524d\u6765\u8bf4\uff0c\u5c06json\u6587\u4ef6\u653e\u5728\u540c\u4e00\u57df\u4e0b\u6700\u5408\u9002\uff0c\u6bd5\u7adflottie\u5f88\u8f7b\u91cf\uff01</li> </ul> </p>"},{"location":"%E5%89%8D%E7%AB%AF/SoftBei-IMS/#0626record","title":"0626record","text":"<p>\u4eca\u5929\u7684\u4efb\u52a1\uff1a\u6dfb\u52a0\u8bad\u7ec3\u9875\u7684\u5e03\u5c40\uff01todo\u4efb\u52a1 <ul> <li> \u5b66\u4e60easyDL\u7684\u5e03\u5c40\u8fdb\u884c\u8bbe\u8ba1</li> <li> \u4f7f\u7528\u5408\u9002\u7684lottie\u52a8\u753b\u8fdb\u884c\u7f8e\u5316</li> <li> \u6dfb\u52a0\u5927\u5e45\u7684\u7684\u52a8\u753b</li> <li> \u6574\u9f50\u7f8e\u89c2\u7684\u5e03\u5c40</li> </ul> </p>"},{"location":"%E5%89%8D%E7%AB%AF/SoftBei-IMS/#0628record","title":"0628record","text":"<p>\u5b8c\u62100626\u7684\u4efb\u52a1\uff0c\u5e76\u4e14\u8fdb\u884c\u4e86\u914d\u8272\u8c03\u6574\uff01experiencetodo <ul> <li>\u82b1\u4e86\u5f88\u4e45\u4fee\u6539<code>antd</code>\u4e2d\u6b65\u9aa4\u6761<code>Steps</code>\u7ec4\u4ef6\u7684\u6837\u5f0f\uff0c\u4f46\u662f\u65e0\u6cd5\u6b63\u5e38\u4fee\u6539\uff01\u4fee\u6539\u540e\u65e0\u6cd5\u6b63\u5e38\u4f7f\u7528\uff01</li> <li>\u589e\u52a0\u4e86\u8bad\u7ec3\u9875\u548c\u6d4b\u8bd5\u9875\u7684\u9000\u51fa\u529f\u80fd\u3002</li> <li>\u5199\u4e86\u4e00\u4e2a\u9000\u51fa\u8b66\u544a\u7684\u63d0\u793a\u6846\uff0c\u4f46\u662f\u4f3c\u4e4e\u590d\u7528\u6027\u4e0d\u9ad8\uff01\u56e0\u4e3a\u9700\u8981\u5728\u4f7f\u7528\u7684\u65f6\u5019\u4f20\u9012<code>onOK</code>\u548c<code>onCancel</code>\u51fd\u6570\u3002</li> <li>\u53d1\u73b0\u9700\u8981\u589e\u52a0\u5c55\u793a\u6570\u636e\u96c6\u8bb0\u5f55\u3001\u7ed3\u679c\u8bb0\u5f55\u7684\u9875\u9762\uff0c\u56e0\u4e3a\u5728\u4e0a\u4f20\u8bad\u7ec3\u96c6\u6216\u8005\u6d4b\u8bd5\u96c6\u4e4b\u540e\uff0c\u8fd9\u4e9b\u4fe1\u606f\u5bf9\u4e8e\u7528\u6237\u6765\u8bf4\u5c31\u65e0\u6cd5\u56de\u6eaf\u4e86\uff0c\u5e76\u4e14\u5f53\u8bad\u7ec3\u8bf7\u6c42\u51fa\u73b0\u95ee\u9898\u540e\uff0c\u8bad\u7ec3\u5c06\u4e0d\u53ef\u6062\u590d\u3002</li> </ul> <ul> <li> \u4e3a\u8bad\u7ec3\u9875\u548c\u6d4b\u8bd5\u9875\u6dfb\u52a0\u8df3\u8f6c\u529f\u80fd</li> <li> \u8bbe\u8ba1\u5408\u9002\u7684\u5e03\u5c40\uff0c\u4fdd\u8bc1\u754c\u9762\u7b80\u6d01\u3001\u4eba\u673a\u4ea4\u4e92\u597d</li> <li> \u6d45\u5c1dantv</li> <li> \u6dfb\u52a0\u8eab\u4efd\u8ba4\u8bc1\u529f\u80fd\uff08\u6682\u65f6\u4f7f\u7528zja\u7684\u540e\u7aef\uff09</li> <li> \u9700\u8981\u5f00\u59cb\u8c03\u6574\u540e\u7aef\uff0c\u62d3\u5c55zja\u540e\u7aef</li> </ul> </p>"}]}