
<!doctype html>
<html lang="zh" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../chapter4_memory/">
      
      
        <link rel="next" href="../chapter6_device_remove/">
      
      <link rel="icon" href="https://roll0814.cn/ftp-images/roll/indexIcon.jpg">
      <meta name="generator" content="mkdocs-1.4.2, mkdocs-material-9.1.3">
    
    
      
        <title>Chapter5 process - Roll Docs</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.c4a75a56.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.a0c5b2b5.min.css">
      
      

    
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="--md-primary-fg-color--light" data-md-color-accent="deep-purple">
  
    
    
      <script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#3" class="md-skip">
          跳转至
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="页眉">
    <a href="../.." title="Roll Docs" class="md-header__button md-logo" aria-label="Roll Docs" data-md-component="logo">
      
  <img src="https://roll0814.cn/ftp-images/roll/indexIcon.jpg" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Roll Docs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Chapter5 process
            
          </span>
        </div>
      </div>
    </div>
    
      <form class="md-header__option" data-md-component="palette">
        
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="--md-primary-fg-color--light" data-md-color-accent="deep-purple"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_1">
          
            <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_2" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31Z"/></svg>
            </label>
          
        
          
          <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="--md-primary-fg-color--dark" data-md-color-accent="blue"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_2">
          
            <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_1" hidden>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22Z"/></svg>
            </label>
          
        
      </form>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="搜索" placeholder="搜索" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="查找">
        
        <button type="reset" class="md-search__icon md-icon" title="清空当前内容" aria-label="清空当前内容" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            正在初始化搜索引擎
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/RollRoll520/RollDocs" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    RollRoll520/RollDocs
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="导航栏" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Roll Docs" class="md-nav__button md-logo" aria-label="Roll Docs" data-md-component="logo">
      
  <img src="https://roll0814.cn/ftp-images/roll/indexIcon.jpg" alt="logo">

    </a>
    Roll Docs
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/RollRoll520/RollDocs" title="前往仓库" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    RollRoll520/RollDocs
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../Welcome/" class="md-nav__link">
        Welcome
      </a>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" >
      
      
      
        <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="0">
          LearnTech
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_2">
          <span class="md-nav__icon md-icon"></span>
          LearnTech
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../LearnTech/LearnGLTF/" class="md-nav__link">
        LearnGLTF
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../LearnTech/LearnGit/" class="md-nav__link">
        LearnGit
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../LearnTech/LearnMkdocs/" class="md-nav__link">
        LearnMkdocs
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../LearnTech/LearnUnityCorgiEngine/" class="md-nav__link">
        Learn Unity Corgi Engine
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
      
      
      
        <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
          OS操作系统
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          OS操作系统
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../../OS%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/note/" class="md-nav__link">
        操作系统课程设计
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
      
      
      <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" checked>
      
      
      
        <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
          Pke doc
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="true">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          Pke doc
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../chapter1_riscv/" class="md-nav__link">
        Chapter1 riscv
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../chapter2_installation/" class="md-nav__link">
        Chapter2 installation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../chapter3_traps/" class="md-nav__link">
        Chapter3 traps
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../chapter4_memory/" class="md-nav__link">
        Chapter4 memory
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          Chapter5 process
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        Chapter5 process
      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    目录
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#51-3" class="md-nav__link">
    5.1 实验3的基础知识
  </a>
  
    <nav class="md-nav" aria-label="5.1 实验3的基础知识">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#511" class="md-nav__link">
    5.1.1 多任务环境下进程的封装
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#512" class="md-nav__link">
    5.1.2 进程的启动与终止
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#513" class="md-nav__link">
    5.1.3 就绪进程的管理与调度
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#52-lab3_1-fork" class="md-nav__link">
    5.2 lab3_1 进程创建（fork）
  </a>
  
    <nav class="md-nav" aria-label="5.2 lab3_1 进程创建（fork）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    给定应用
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    实验内容
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    实验指导
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#53-lab3_2-yield" class="md-nav__link">
    5.3 lab3_2 进程yield
  </a>
  
    <nav class="md-nav" aria-label="5.3 lab3_2 进程yield">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    给定应用
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    实验内容
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    实验指导
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#54-lab3_3" class="md-nav__link">
    5.4 lab3_3 循环轮转调度
  </a>
  
    <nav class="md-nav" aria-label="5.4 lab3_3 循环轮转调度">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    给定应用
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    实验内容
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    实验指导
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#55-lab3_challenge1" class="md-nav__link">
    5.5 lab3_challenge1 进程等待和数据段复制（难度：&#9733;&#9733;&#9734;&#9734;&#9734;）
  </a>
  
    <nav class="md-nav" aria-label="5.5 lab3_challenge1 进程等待和数据段复制（难度：&#9733;&#9733;&#9734;&#9734;&#9734;）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    给定应用
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    实验内容
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    实验指导
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#56-lab3_challenge2" class="md-nav__link">
    5.6 lab3_challenge2 实现信号量（难度：&#9733;&#9733;&#9733;&#9734;&#9734;）
  </a>
  
    <nav class="md-nav" aria-label="5.6 lab3_challenge2 实现信号量（难度：&#9733;&#9733;&#9733;&#9734;&#9734;）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    给定应用
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    实验内容
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    实验指导
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../chapter6_device_remove/" class="md-nav__link">
        Chapter6 device remove
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../chapter6_riscv_on_pynq/" class="md-nav__link">
        Chapter6 riscv on pynq
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../chapter7_device/" class="md-nav__link">
        Chapter7 device
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="目录">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      目录
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    目录
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#51-3" class="md-nav__link">
    5.1 实验3的基础知识
  </a>
  
    <nav class="md-nav" aria-label="5.1 实验3的基础知识">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#511" class="md-nav__link">
    5.1.1 多任务环境下进程的封装
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#512" class="md-nav__link">
    5.1.2 进程的启动与终止
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#513" class="md-nav__link">
    5.1.3 就绪进程的管理与调度
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#52-lab3_1-fork" class="md-nav__link">
    5.2 lab3_1 进程创建（fork）
  </a>
  
    <nav class="md-nav" aria-label="5.2 lab3_1 进程创建（fork）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    给定应用
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    实验内容
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    实验指导
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#53-lab3_2-yield" class="md-nav__link">
    5.3 lab3_2 进程yield
  </a>
  
    <nav class="md-nav" aria-label="5.3 lab3_2 进程yield">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    给定应用
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    实验内容
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_7" class="md-nav__link">
    实验指导
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#54-lab3_3" class="md-nav__link">
    5.4 lab3_3 循环轮转调度
  </a>
  
    <nav class="md-nav" aria-label="5.4 lab3_3 循环轮转调度">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_8" class="md-nav__link">
    给定应用
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_9" class="md-nav__link">
    实验内容
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_10" class="md-nav__link">
    实验指导
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#55-lab3_challenge1" class="md-nav__link">
    5.5 lab3_challenge1 进程等待和数据段复制（难度：&#9733;&#9733;&#9734;&#9734;&#9734;）
  </a>
  
    <nav class="md-nav" aria-label="5.5 lab3_challenge1 进程等待和数据段复制（难度：&#9733;&#9733;&#9734;&#9734;&#9734;）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_11" class="md-nav__link">
    给定应用
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_12" class="md-nav__link">
    实验内容
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_13" class="md-nav__link">
    实验指导
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#56-lab3_challenge2" class="md-nav__link">
    5.6 lab3_challenge2 实现信号量（难度：&#9733;&#9733;&#9733;&#9734;&#9734;）
  </a>
  
    <nav class="md-nav" aria-label="5.6 lab3_challenge2 实现信号量（难度：&#9733;&#9733;&#9733;&#9734;&#9734;）">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_14" class="md-nav__link">
    给定应用
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_15" class="md-nav__link">
    实验内容
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_16" class="md-nav__link">
    实验指导
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
    <a href="https://github.com/RollRoll520/RollDocs/edit/master/docs/pke-doc/chapter5_process.md" title="编辑此页" class="md-content__button md-icon">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M10 20H6V4h7v5h5v3.1l2-2V8l-6-6H6c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h4v-2m10.2-7c.1 0 .3.1.4.2l1.3 1.3c.2.2.2.6 0 .8l-1 1-2.1-2.1 1-1c.1-.1.2-.2.4-.2m0 3.9L14.1 23H12v-2.1l6.1-6.1 2.1 2.1Z"/></svg>
    </a>
  
  


<hr />
<hr />
<h1 id="3">第五章．实验3：进程管理</h1>
<h3 id="_1">目录</h3>
<ul>
<li><a href="#fundamental">5.1 实验3的基础知识</a> </li>
<li><a href="#subsec_process_structure">5.1.1 多任务环境下进程的封装</a></li>
<li><a href="#subsec_switch">5.1.2 进程的换入与换出</a></li>
<li><a href="#subsec_management">5.1.3 就绪进程的管理与调度</a></li>
<li><a href="#lab3_1_naive_fork">5.2 lab3_1 进程创建（fork）</a></li>
<li><a href="#lab3_1_app">给定应用</a></li>
<li><a href="#lab3_1_content">实验内容</a></li>
<li><a href="#lab3_1_guide">实验指导</a></li>
<li><a href="#lab3_2_yield">5.3 lab3_2 进程yield</a> </li>
<li><a href="#lab3_2_app">给定应用</a></li>
<li><a href="#lab3_2_content">实验内容</a></li>
<li><a href="#lab3_2_guide">实验指导</a></li>
<li><a href="#lab3_3_rrsched">5.4 lab3_3 循环轮转调度</a> </li>
<li><a href="#lab3_3_app">给定应用</a></li>
<li><a href="#lab3_3_content">实验内容</a></li>
<li><a href="#lab3_3_guide">实验指导</a></li>
<li><a href="#lab3_challenge1_wait">5.5 lab3_challenge1 进程等待和数据段复制（难度：&#9733;&#9733;&#9734;&#9734;&#9734;）</a> </li>
<li><a href="#lab3_challenge1_app">给定应用</a></li>
<li><a href="#lab3_challenge1_content">实验内容</a></li>
<li><a href="#lab3_challenge1_guide">实验指导</a></li>
<li><a href="#lab3_challenge2_semaphore">5.6 lab3_challenge2 实现信号量（难度：&#9733;&#9733;&#9733;&#9734;&#9734;）</a> </li>
<li><a href="#lab3_challenge2_app">给定应用</a></li>
<li><a href="#lab3_challenge2_content">实验内容</a></li>
<li><a href="#lab3_challenge2_guide">实验指导</a></li>
</ul>
<p><a name="fundamental"></a></p>
<h2 id="51-3">5.1 实验3的基础知识</h2>
<p>完成了实验1和实验2的读者，应该对PKE实验中的“进程”不会太陌生。因为实际上，我们从最开始的lab1_1开始就有了进程结构（struct process），只是在之前的实验中，进程结构中最重要的成员是trapframe和kstack，它们分别用来记录系统进入S模式前的进程上下文以及作为进入S模式后的操作系统栈。在实验3，我们将进入多任务环境，完成PKE实验环境下的进程创建、换入换出，以及进程调度相关实验。</p>
<p><a name="subsec_process_structure"></a></p>
<h3 id="511">5.1.1 多任务环境下进程的封装</h3>
<p>实验3跟之前的两个实验最大的不同，在于在实验3的3个基本实验中，PKE操作系统将需要支持多个进程的执行。为了对多任务环境进行支撑，PKE操作系统定义了一个“进程池”（见kernel/process.c文件）：</p>
<div class="language-C highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a><span class="w"> </span><span class="mi">29</span><span class="w"> </span><span class="c1">// process pool. added @lab3_1</span>
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a><span class="w"> </span><span class="mi">30</span><span class="w"> </span><span class="n">process</span><span class="w"> </span><span class="n">procs</span><span class="p">[</span><span class="n">NPROC</span><span class="p">];</span>
</span></code></pre></div>
<p>实际上，这个进程池就是一个包含NPROC（=32，见kernel/process.h文件）个process结构的数组。</p>
<p>接下来，PKE操作系统对进程的结构进行了扩充（见kernel/process.h文件）：</p>
<div class="language-C highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="w"> </span><span class="mi">58</span><span class="w">   </span><span class="c1">// points to a page that contains mapped_regions. below are added @lab3_1</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="w"> </span><span class="mi">59</span><span class="w">   </span><span class="n">mapped_region</span><span class="w"> </span><span class="o">*</span><span class="n">mapped_info</span><span class="p">;</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="w"> </span><span class="mi">60</span><span class="w">   </span><span class="c1">// next free mapped region in mapped_info</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a><span class="w"> </span><span class="mi">61</span><span class="w">   </span><span class="kt">int</span><span class="w"> </span><span class="n">total_mapped_region</span><span class="p">;</span>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="w"> </span><span class="mi">62</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="w"> </span><span class="mi">63</span><span class="w">   </span><span class="c1">// process id</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a><span class="w"> </span><span class="mi">64</span><span class="w">   </span><span class="n">uint64</span><span class="w"> </span><span class="n">pid</span><span class="p">;</span>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a><span class="w"> </span><span class="mi">65</span><span class="w">   </span><span class="c1">// process status</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a><span class="w"> </span><span class="mi">66</span><span class="w">   </span><span class="kt">int</span><span class="w"> </span><span class="n">status</span><span class="p">;</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a><span class="w"> </span><span class="mi">67</span><span class="w">   </span><span class="c1">// parent process</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a><span class="w"> </span><span class="mi">68</span><span class="w">   </span><span class="k">struct</span><span class="w"> </span><span class="nc">process_t</span><span class="w"> </span><span class="o">*</span><span class="n">parent</span><span class="p">;</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a><span class="w"> </span><span class="mi">69</span><span class="w">   </span><span class="c1">// next queue element</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a><span class="w"> </span><span class="mi">70</span><span class="w">   </span><span class="k">struct</span><span class="w"> </span><span class="nc">process_t</span><span class="w"> </span><span class="o">*</span><span class="n">queue_next</span><span class="p">;</span>
</span></code></pre></div>
<ul>
<li>前两项mapped_info和total_mapped_region用于对进程的虚拟地址空间（中的代码段、堆栈段等）进行跟踪，这些虚拟地址空间在进程创建（fork）时，将发挥重要作用。同时，这也是lab3_1的内容。PKE将进程可能拥有的段分为以下几个类型：</li>
</ul>
<div class="language-C highlight"><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="w"> </span><span class="mi">34</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="n">segment_type</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a><span class="w"> </span><span class="mi">35</span><span class="w">   </span><span class="n">CODE_SEGMENT</span><span class="p">,</span><span class="w">    </span><span class="c1">// ELF segment</span>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="w"> </span><span class="mi">36</span><span class="w">   </span><span class="n">DATA_SEGMENT</span><span class="p">,</span><span class="w">    </span><span class="c1">// ELF segment</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="w"> </span><span class="mi">37</span><span class="w">   </span><span class="n">STACK_SEGMENT</span><span class="p">,</span><span class="w">   </span><span class="c1">// runtime segment</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="w"> </span><span class="mi">38</span><span class="w">   </span><span class="n">CONTEXT_SEGMENT</span><span class="p">,</span><span class="w"> </span><span class="c1">// trapframe segment</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a><span class="w"> </span><span class="mi">39</span><span class="w">   </span><span class="n">SYSTEM_SEGMENT</span><span class="p">,</span><span class="w">  </span><span class="c1">// system segment</span>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a><span class="w"> </span><span class="mi">40</span><span class="w"> </span><span class="p">};</span>
</span></code></pre></div>
<p>其中CODE_SEGMENT表示该段是从可执行ELF文件中加载的代码段，DATA_SEGMENT为从ELF文件中加载的数据段，STACK_SEGMENT为进程自身的栈段，CONTEXT_SEGMENT为保存进程上下文的trapframe所对应的段，SYSTEM_SEGMENT为进程的系统段，如所映射的异常处理段。</p>
<ul>
<li>pid是进程的ID号，具有唯一性；</li>
<li>status记录了进程的状态，PKE操作系统在实验3给进程规定了以下几种状态：</li>
</ul>
<div class="language-C highlight"><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="w"> </span><span class="mi">25</span><span class="w"> </span><span class="k">enum</span><span class="w"> </span><span class="n">proc_status</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a><span class="w"> </span><span class="mi">26</span><span class="w">   </span><span class="n">FREE</span><span class="p">,</span><span class="w">            </span><span class="c1">// unused state</span>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="w"> </span><span class="mi">27</span><span class="w">   </span><span class="n">READY</span><span class="p">,</span><span class="w">           </span><span class="c1">// ready state</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="w"> </span><span class="mi">28</span><span class="w">   </span><span class="n">RUNNING</span><span class="p">,</span><span class="w">         </span><span class="c1">// currently running</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a><span class="w"> </span><span class="mi">29</span><span class="w">   </span><span class="n">BLOCKED</span><span class="p">,</span><span class="w">         </span><span class="c1">// waiting for something</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a><span class="w"> </span><span class="mi">30</span><span class="w">   </span><span class="n">ZOMBIE</span><span class="p">,</span><span class="w">          </span><span class="c1">// terminated but not reclaimed yet</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a><span class="w"> </span><span class="mi">31</span><span class="w"> </span><span class="p">};</span>
</span></code></pre></div>
<p>其中，FREE为自由态，表示进程结构可用；READY为就绪态，即进程所需的资源都已准备好，可以被调度执行；RUNNING表示该进程处于正在运行的状态；BLOCKED表示进程处于阻塞状态；ZOMBIE表示进程处于“僵尸”状态，进程的资源可以被释放和回收。</p>
<ul>
<li>parent用于记录进程的父进程；</li>
<li>queue_next用于将进程链接进各类队列（比如就绪队列）；</li>
<li>tick_count用于对进程进行记账，即记录它的执行经历了多少次的timer事件，将在lab3_3中实现循环轮转调度时使用。</li>
</ul>
<p><a name="subsec_switch"></a></p>
<h3 id="512">5.1.2 进程的启动与终止</h3>
<p>PKE实验中，创建一个进程需要先调用kernel/process.c文件中的alloc_process()函数：</p>
<div class="language-C highlight"><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="w"> </span><span class="mi">92</span><span class="w"> </span><span class="n">process</span><span class="o">*</span><span class="w"> </span><span class="n">alloc_process</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a><span class="w"> </span><span class="mi">93</span><span class="w">   </span><span class="c1">// locate the first usable process structure</span>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="w"> </span><span class="mi">94</span><span class="w">   </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="w"> </span><span class="mi">95</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a><span class="w"> </span><span class="mi">96</span><span class="w">   </span><span class="k">for</span><span class="p">(</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">NPROC</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="w"> </span><span class="p">)</span>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="w"> </span><span class="mi">97</span><span class="w">     </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">procs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">FREE</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a><span class="w"> </span><span class="mi">98</span>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="w"> </span><span class="mi">99</span><span class="w">   </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">i</span><span class="o">&gt;=</span><span class="n">NPROC</span><span class="w"> </span><span class="p">){</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a><span class="mi">100</span><span class="w">     </span><span class="n">panic</span><span class="p">(</span><span class="w"> </span><span class="s">&quot;cannot find any free process structure.</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"> </span><span class="p">);</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a><span class="mi">101</span><span class="w">     </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a><span class="mi">102</span><span class="w">   </span><span class="p">}</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a><span class="mi">103</span>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a><span class="mi">104</span><span class="w">   </span><span class="c1">// init proc[i]&#39;s vm space</span>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a><span class="mi">105</span><span class="w">   </span><span class="n">procs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">trapframe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">trapframe</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">alloc_page</span><span class="p">();</span><span class="w">  </span><span class="c1">//trapframe, used to save context</span>
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a><span class="mi">106</span><span class="w">   </span><span class="n">memset</span><span class="p">(</span><span class="n">procs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">trapframe</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">trapframe</span><span class="p">));</span>
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a><span class="mi">107</span>
</span><span id="__span-4-17"><a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a><span class="mi">108</span><span class="w">   </span><span class="c1">// page directory</span>
</span><span id="__span-4-18"><a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a><span class="mi">109</span><span class="w">   </span><span class="n">procs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pagetable</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">pagetable_t</span><span class="p">)</span><span class="n">alloc_page</span><span class="p">();</span>
</span><span id="__span-4-19"><a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a><span class="mi">110</span><span class="w">   </span><span class="n">memset</span><span class="p">((</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="n">procs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pagetable</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">);</span>
</span><span id="__span-4-20"><a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a><span class="mi">111</span>
</span><span id="__span-4-21"><a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a><span class="mi">112</span><span class="w">   </span><span class="n">procs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">kstack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">uint64</span><span class="p">)</span><span class="n">alloc_page</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">;</span><span class="w">   </span><span class="c1">//user kernel stack top</span>
</span><span id="__span-4-22"><a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a><span class="mi">113</span><span class="w">   </span><span class="n">uint64</span><span class="w"> </span><span class="n">user_stack</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">uint64</span><span class="p">)</span><span class="n">alloc_page</span><span class="p">();</span><span class="w">       </span><span class="c1">//phisical address of user stack bottom</span>
</span><span id="__span-4-23"><a id="__codelineno-4-23" name="__codelineno-4-23" href="#__codelineno-4-23"></a><span class="mi">114</span><span class="w">   </span><span class="n">procs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">trapframe</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">sp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">USER_STACK_TOP</span><span class="p">;</span><span class="w">  </span><span class="c1">//virtual address of user stack top</span>
</span><span id="__span-4-24"><a id="__codelineno-4-24" name="__codelineno-4-24" href="#__codelineno-4-24"></a><span class="mi">115</span>
</span><span id="__span-4-25"><a id="__codelineno-4-25" name="__codelineno-4-25" href="#__codelineno-4-25"></a><span class="mi">116</span><span class="w">   </span><span class="c1">// allocates a page to record memory regions (segments)</span>
</span><span id="__span-4-26"><a id="__codelineno-4-26" name="__codelineno-4-26" href="#__codelineno-4-26"></a><span class="mi">117</span><span class="w">   </span><span class="n">procs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mapped_info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">mapped_region</span><span class="o">*</span><span class="p">)</span><span class="n">alloc_page</span><span class="p">();</span>
</span><span id="__span-4-27"><a id="__codelineno-4-27" name="__codelineno-4-27" href="#__codelineno-4-27"></a><span class="mi">118</span><span class="w">   </span><span class="n">memset</span><span class="p">(</span><span class="w"> </span><span class="n">procs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mapped_info</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">PGSIZE</span><span class="w"> </span><span class="p">);</span>
</span><span id="__span-4-28"><a id="__codelineno-4-28" name="__codelineno-4-28" href="#__codelineno-4-28"></a><span class="mi">119</span>
</span><span id="__span-4-29"><a id="__codelineno-4-29" name="__codelineno-4-29" href="#__codelineno-4-29"></a><span class="mi">120</span><span class="w">   </span><span class="c1">// map user stack in userspace</span>
</span><span id="__span-4-30"><a id="__codelineno-4-30" name="__codelineno-4-30" href="#__codelineno-4-30"></a><span class="mi">121</span><span class="w">   </span><span class="n">user_vm_map</span><span class="p">((</span><span class="n">pagetable_t</span><span class="p">)</span><span class="n">procs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pagetable</span><span class="p">,</span><span class="w"> </span><span class="n">USER_STACK_TOP</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">,</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">,</span>
</span><span id="__span-4-31"><a id="__codelineno-4-31" name="__codelineno-4-31" href="#__codelineno-4-31"></a><span class="mi">122</span><span class="w">     </span><span class="n">user_stack</span><span class="p">,</span><span class="w"> </span><span class="n">prot_to_type</span><span class="p">(</span><span class="n">PROT_WRITE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PROT_READ</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">));</span>
</span><span id="__span-4-32"><a id="__codelineno-4-32" name="__codelineno-4-32" href="#__codelineno-4-32"></a><span class="mi">123</span><span class="w">   </span><span class="n">procs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mapped_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">va</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">USER_STACK_TOP</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">;</span>
</span><span id="__span-4-33"><a id="__codelineno-4-33" name="__codelineno-4-33" href="#__codelineno-4-33"></a><span class="mi">124</span><span class="w">   </span><span class="n">procs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mapped_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">npages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-4-34"><a id="__codelineno-4-34" name="__codelineno-4-34" href="#__codelineno-4-34"></a><span class="mi">125</span><span class="w">   </span><span class="n">procs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mapped_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">seg_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">STACK_SEGMENT</span><span class="p">;</span>
</span><span id="__span-4-35"><a id="__codelineno-4-35" name="__codelineno-4-35" href="#__codelineno-4-35"></a><span class="mi">126</span>
</span><span id="__span-4-36"><a id="__codelineno-4-36" name="__codelineno-4-36" href="#__codelineno-4-36"></a><span class="mi">127</span><span class="w">   </span><span class="c1">// map trapframe in user space (direct mapping as in kernel space).</span>
</span><span id="__span-4-37"><a id="__codelineno-4-37" name="__codelineno-4-37" href="#__codelineno-4-37"></a><span class="mi">128</span><span class="w">   </span><span class="n">user_vm_map</span><span class="p">((</span><span class="n">pagetable_t</span><span class="p">)</span><span class="n">procs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pagetable</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">uint64</span><span class="p">)</span><span class="n">procs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">trapframe</span><span class="p">,</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">,</span>
</span><span id="__span-4-38"><a id="__codelineno-4-38" name="__codelineno-4-38" href="#__codelineno-4-38"></a><span class="mi">129</span><span class="w">     </span><span class="p">(</span><span class="n">uint64</span><span class="p">)</span><span class="n">procs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">trapframe</span><span class="p">,</span><span class="w"> </span><span class="n">prot_to_type</span><span class="p">(</span><span class="n">PROT_WRITE</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PROT_READ</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>
</span><span id="__span-4-39"><a id="__codelineno-4-39" name="__codelineno-4-39" href="#__codelineno-4-39"></a><span class="mi">130</span><span class="w">   </span><span class="n">procs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mapped_info</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">va</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">uint64</span><span class="p">)</span><span class="n">procs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">trapframe</span><span class="p">;</span>
</span><span id="__span-4-40"><a id="__codelineno-4-40" name="__codelineno-4-40" href="#__codelineno-4-40"></a><span class="mi">131</span><span class="w">   </span><span class="n">procs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mapped_info</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">npages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-4-41"><a id="__codelineno-4-41" name="__codelineno-4-41" href="#__codelineno-4-41"></a><span class="mi">132</span><span class="w">   </span><span class="n">procs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mapped_info</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">seg_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CONTEXT_SEGMENT</span><span class="p">;</span>
</span><span id="__span-4-42"><a id="__codelineno-4-42" name="__codelineno-4-42" href="#__codelineno-4-42"></a><span class="mi">133</span>
</span><span id="__span-4-43"><a id="__codelineno-4-43" name="__codelineno-4-43" href="#__codelineno-4-43"></a><span class="mi">134</span><span class="w">   </span><span class="c1">// map S-mode trap vector section in user space (direct mapping as in kernel space)</span>
</span><span id="__span-4-44"><a id="__codelineno-4-44" name="__codelineno-4-44" href="#__codelineno-4-44"></a><span class="mi">135</span><span class="w">   </span><span class="c1">// we assume that the size of usertrap.S is smaller than a page.</span>
</span><span id="__span-4-45"><a id="__codelineno-4-45" name="__codelineno-4-45" href="#__codelineno-4-45"></a><span class="mi">136</span><span class="w">   </span><span class="n">user_vm_map</span><span class="p">((</span><span class="n">pagetable_t</span><span class="p">)</span><span class="n">procs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">pagetable</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">uint64</span><span class="p">)</span><span class="n">trap_sec_start</span><span class="p">,</span><span class="w"> </span><span class="n">PGSIZE</span><span class="p">,</span>
</span><span id="__span-4-46"><a id="__codelineno-4-46" name="__codelineno-4-46" href="#__codelineno-4-46"></a><span class="mi">137</span><span class="w">     </span><span class="p">(</span><span class="n">uint64</span><span class="p">)</span><span class="n">trap_sec_start</span><span class="p">,</span><span class="w"> </span><span class="n">prot_to_type</span><span class="p">(</span><span class="n">PROT_READ</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">PROT_EXEC</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">));</span>
</span><span id="__span-4-47"><a id="__codelineno-4-47" name="__codelineno-4-47" href="#__codelineno-4-47"></a><span class="mi">138</span><span class="w">   </span><span class="n">procs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mapped_info</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">va</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">uint64</span><span class="p">)</span><span class="n">trap_sec_start</span><span class="p">;</span>
</span><span id="__span-4-48"><a id="__codelineno-4-48" name="__codelineno-4-48" href="#__codelineno-4-48"></a><span class="mi">139</span><span class="w">   </span><span class="n">procs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mapped_info</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">npages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-4-49"><a id="__codelineno-4-49" name="__codelineno-4-49" href="#__codelineno-4-49"></a><span class="mi">140</span><span class="w">   </span><span class="n">procs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">mapped_info</span><span class="p">[</span><span class="mi">2</span><span class="p">].</span><span class="n">seg_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SYSTEM_SEGMENT</span><span class="p">;</span>
</span><span id="__span-4-50"><a id="__codelineno-4-50" name="__codelineno-4-50" href="#__codelineno-4-50"></a><span class="mi">141</span>
</span><span id="__span-4-51"><a id="__codelineno-4-51" name="__codelineno-4-51" href="#__codelineno-4-51"></a><span class="mi">142</span><span class="w">   </span><span class="n">sprint</span><span class="p">(</span><span class="s">&quot;in alloc_proc. user frame 0x%lx, user stack 0x%lx, user kstack 0x%lx </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
</span><span id="__span-4-52"><a id="__codelineno-4-52" name="__codelineno-4-52" href="#__codelineno-4-52"></a><span class="mi">143</span><span class="w">     </span><span class="n">procs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">trapframe</span><span class="p">,</span><span class="w"> </span><span class="n">procs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">trapframe</span><span class="o">-&gt;</span><span class="n">regs</span><span class="p">.</span><span class="n">sp</span><span class="p">,</span><span class="w"> </span><span class="n">procs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">kstack</span><span class="p">);</span>
</span><span id="__span-4-53"><a id="__codelineno-4-53" name="__codelineno-4-53" href="#__codelineno-4-53"></a><span class="mi">144</span>
</span><span id="__span-4-54"><a id="__codelineno-4-54" name="__codelineno-4-54" href="#__codelineno-4-54"></a><span class="mi">145</span><span class="w">   </span><span class="n">procs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">total_mapped_region</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">3</span><span class="p">;</span>
</span><span id="__span-4-55"><a id="__codelineno-4-55" name="__codelineno-4-55" href="#__codelineno-4-55"></a><span class="mi">146</span><span class="w">   </span><span class="c1">// return after initialization.</span>
</span><span id="__span-4-56"><a id="__codelineno-4-56" name="__codelineno-4-56" href="#__codelineno-4-56"></a><span class="mi">147</span><span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="o">&amp;</span><span class="n">procs</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
</span><span id="__span-4-57"><a id="__codelineno-4-57" name="__codelineno-4-57" href="#__codelineno-4-57"></a><span class="mi">148</span><span class="w"> </span><span class="p">}</span>
</span></code></pre></div>
<p>通过以上代码，可以发现alloc_process()函数除了找到一个空的进程结构外，还为新创建的进程建立了KERN_BASE以上逻辑地址的映射（这段代码在实验3之前位于kernel/kernel.c文件的load_user_program()函数中），并将映射信息保存到了进程结构中。</p>
<p>对于给定应用，PKE将通过调用load_bincode_from_host_elf()函数载入给定应用对应的ELF文件的各个段。之后被调用的elf_load()函数在载入段后，将对被载入的段进行判断，以记录它们的虚地址映射：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="w"> </span><span class="mi">65</span><span class="w"> </span><span class="n">elf_status</span><span class="w"> </span><span class="n">elf_load</span><span class="p">(</span><span class="n">elf_ctx</span><span class="w"> </span><span class="o">*</span><span class="n">ctx</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a><span class="w"> </span><span class="mi">66</span><span class="w">   </span><span class="c1">// elf_prog_header structure is defined in kernel/elf.h</span>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="w"> </span><span class="mi">67</span><span class="w">   </span><span class="n">elf_prog_header</span><span class="w"> </span><span class="n">ph_addr</span><span class="p">;</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="w"> </span><span class="mi">68</span><span class="w">   </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">off</span><span class="p">;</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a><span class="w"> </span><span class="mi">69</span>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="w"> </span><span class="mi">70</span><span class="w">   </span><span class="c1">// traverse the elf program segment headers</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a><span class="w"> </span><span class="mi">71</span><span class="w">   </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">off</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ehdr</span><span class="p">.</span><span class="n">phoff</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">ehdr</span><span class="p">.</span><span class="n">phnum</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">,</span><span class="w"> </span><span class="n">off</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">ph_addr</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a><span class="w"> </span><span class="mi">72</span><span class="w">     </span><span class="c1">// read segment headers</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a><span class="w"> </span><span class="mi">73</span><span class="w">     </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">elf_fpread</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">ph_addr</span><span class="p">,</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">ph_addr</span><span class="p">),</span><span class="w"> </span><span class="n">off</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="k">sizeof</span><span class="p">(</span><span class="n">ph_addr</span><span class="p">))</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">EL</span><span class="w">    </span><span class="n">_EIO</span><span class="p">;</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a><span class="w"> </span><span class="mi">74</span>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a><span class="w"> </span><span class="mi">75</span><span class="w">     </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ph_addr</span><span class="p">.</span><span class="n">type</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ELF_PROG_LOAD</span><span class="p">)</span><span class="w"> </span><span class="k">continue</span><span class="p">;</span>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a><span class="w"> </span><span class="mi">76</span><span class="w">     </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ph_addr</span><span class="p">.</span><span class="n">memsz</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ph_addr</span><span class="p">.</span><span class="n">filesz</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">EL_ERR</span><span class="p">;</span>
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a><span class="w"> </span><span class="mi">77</span><span class="w">     </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">ph_addr</span><span class="p">.</span><span class="n">vaddr</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">ph_addr</span><span class="p">.</span><span class="n">memsz</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">ph_addr</span><span class="p">.</span><span class="n">vaddr</span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="w"> </span><span class="n">EL_ERR</span><span class="p">;</span>
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a><span class="w"> </span><span class="mi">78</span>
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a><span class="w"> </span><span class="mi">79</span><span class="w">     </span><span class="c1">// allocate memory block before elf loading</span>
</span><span id="__span-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a><span class="w"> </span><span class="mi">80</span><span class="w">     </span><span class="kt">void</span><span class="w"> </span><span class="o">*</span><span class="n">dest</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">elf_alloc_mb</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">ph_addr</span><span class="p">.</span><span class="n">vaddr</span><span class="p">,</span><span class="w"> </span><span class="n">ph_addr</span><span class="p">.</span><span class="n">vaddr</span><span class="p">,</span><span class="w"> </span><span class="n">ph_addr</span><span class="p">.</span><span class="n">memsz</span><span class="p">);</span>
</span><span id="__span-5-17"><a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a><span class="w"> </span><span class="mi">81</span>
</span><span id="__span-5-18"><a id="__codelineno-5-18" name="__codelineno-5-18" href="#__codelineno-5-18"></a><span class="w"> </span><span class="mi">82</span><span class="w">     </span><span class="c1">// actual loading</span>
</span><span id="__span-5-19"><a id="__codelineno-5-19" name="__codelineno-5-19" href="#__codelineno-5-19"></a><span class="w"> </span><span class="mi">83</span><span class="w">     </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">elf_fpread</span><span class="p">(</span><span class="n">ctx</span><span class="p">,</span><span class="w"> </span><span class="n">dest</span><span class="p">,</span><span class="w"> </span><span class="n">ph_addr</span><span class="p">.</span><span class="n">memsz</span><span class="p">,</span><span class="w"> </span><span class="n">ph_addr</span><span class="p">.</span><span class="n">off</span><span class="p">)</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ph_addr</span><span class="p">.</span><span class="n">memsz</span><span class="p">)</span>
</span><span id="__span-5-20"><a id="__codelineno-5-20" name="__codelineno-5-20" href="#__codelineno-5-20"></a><span class="w"> </span><span class="mi">84</span><span class="w">       </span><span class="k">return</span><span class="w"> </span><span class="n">EL_EIO</span><span class="p">;</span>
</span><span id="__span-5-21"><a id="__codelineno-5-21" name="__codelineno-5-21" href="#__codelineno-5-21"></a><span class="w"> </span><span class="mi">85</span>
</span><span id="__span-5-22"><a id="__codelineno-5-22" name="__codelineno-5-22" href="#__codelineno-5-22"></a><span class="w"> </span><span class="mi">86</span><span class="w">     </span><span class="c1">// record the vm region in proc-&gt;mapped_info. added @lab3_1</span>
</span><span id="__span-5-23"><a id="__codelineno-5-23" name="__codelineno-5-23" href="#__codelineno-5-23"></a><span class="w"> </span><span class="mi">87</span><span class="w">     </span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="p">;</span>
</span><span id="__span-5-24"><a id="__codelineno-5-24" name="__codelineno-5-24" href="#__codelineno-5-24"></a><span class="w"> </span><span class="mi">88</span><span class="w">     </span><span class="k">for</span><span class="p">(</span><span class="w"> </span><span class="n">j</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">&lt;</span><span class="n">PGSIZE</span><span class="o">/</span><span class="k">sizeof</span><span class="p">(</span><span class="n">mapped_region</span><span class="p">);</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="c1">//seek the last mapped region</span>
</span><span id="__span-5-25"><a id="__codelineno-5-25" name="__codelineno-5-25" href="#__codelineno-5-25"></a><span class="w"> </span><span class="mi">89</span><span class="w">       </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">process</span><span class="o">*</span><span class="p">)(((</span><span class="n">elf_info</span><span class="o">*</span><span class="p">)(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">mapped_info</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">va</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mh">0x0</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-5-26"><a id="__codelineno-5-26" name="__codelineno-5-26" href="#__codelineno-5-26"></a><span class="w"> </span><span class="mi">90</span>
</span><span id="__span-5-27"><a id="__codelineno-5-27" name="__codelineno-5-27" href="#__codelineno-5-27"></a><span class="w"> </span><span class="mi">91</span><span class="w">     </span><span class="p">((</span><span class="n">process</span><span class="o">*</span><span class="p">)(((</span><span class="n">elf_info</span><span class="o">*</span><span class="p">)(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">mapped_info</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">va</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ph_addr</span><span class="p">.</span><span class="n">vaddr</span><span class="p">;</span>
</span><span id="__span-5-28"><a id="__codelineno-5-28" name="__codelineno-5-28" href="#__codelineno-5-28"></a><span class="w"> </span><span class="mi">92</span><span class="w">     </span><span class="p">((</span><span class="n">process</span><span class="o">*</span><span class="p">)(((</span><span class="n">elf_info</span><span class="o">*</span><span class="p">)(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">mapped_info</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">npages</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-5-29"><a id="__codelineno-5-29" name="__codelineno-5-29" href="#__codelineno-5-29"></a><span class="w"> </span><span class="mi">93</span>
</span><span id="__span-5-30"><a id="__codelineno-5-30" name="__codelineno-5-30" href="#__codelineno-5-30"></a><span class="w"> </span><span class="mi">94</span><span class="w">     </span><span class="c1">// SEGMENT_READABLE, SEGMENT_EXECUTABLE, SEGMENT_WRITABLE are defined in kernel/elf.h</span>
</span><span id="__span-5-31"><a id="__codelineno-5-31" name="__codelineno-5-31" href="#__codelineno-5-31"></a><span class="w"> </span><span class="mi">95</span><span class="w">     </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">ph_addr</span><span class="p">.</span><span class="n">flags</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">(</span><span class="n">SEGMENT_READABLE</span><span class="o">|</span><span class="n">SEGMENT_EXECUTABLE</span><span class="p">)</span><span class="w"> </span><span class="p">){</span>
</span><span id="__span-5-32"><a id="__codelineno-5-32" name="__codelineno-5-32" href="#__codelineno-5-32"></a><span class="w"> </span><span class="mi">96</span><span class="w">       </span><span class="p">((</span><span class="n">process</span><span class="o">*</span><span class="p">)(((</span><span class="n">elf_info</span><span class="o">*</span><span class="p">)(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">mapped_info</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">seg_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CODE_SEGMENT</span><span class="p">;</span>
</span><span id="__span-5-33"><a id="__codelineno-5-33" name="__codelineno-5-33" href="#__codelineno-5-33"></a><span class="w"> </span><span class="mi">97</span><span class="w">       </span><span class="n">sprint</span><span class="p">(</span><span class="w"> </span><span class="s">&quot;CODE_SEGMENT added at mapped info offset:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="p">);</span>
</span><span id="__span-5-34"><a id="__codelineno-5-34" name="__codelineno-5-34" href="#__codelineno-5-34"></a><span class="w"> </span><span class="mi">98</span><span class="w">     </span><span class="p">}</span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">ph_addr</span><span class="p">.</span><span class="n">flags</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="p">(</span><span class="n">SEGMENT_READABLE</span><span class="o">|</span><span class="n">SEGMENT_WRITABLE</span><span class="p">)</span><span class="w"> </span><span class="p">){</span>
</span><span id="__span-5-35"><a id="__codelineno-5-35" name="__codelineno-5-35" href="#__codelineno-5-35"></a><span class="w"> </span><span class="mi">99</span><span class="w">       </span><span class="p">((</span><span class="n">process</span><span class="o">*</span><span class="p">)(((</span><span class="n">elf_info</span><span class="o">*</span><span class="p">)(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">mapped_info</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">seg_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DATA_SEGMENT</span><span class="p">;</span>
</span><span id="__span-5-36"><a id="__codelineno-5-36" name="__codelineno-5-36" href="#__codelineno-5-36"></a><span class="mi">100</span><span class="w">       </span><span class="n">sprint</span><span class="p">(</span><span class="w"> </span><span class="s">&quot;DATA_SEGMENT added at mapped info offset:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="p">);</span>
</span><span id="__span-5-37"><a id="__codelineno-5-37" name="__codelineno-5-37" href="#__codelineno-5-37"></a><span class="mi">101</span><span class="w">     </span><span class="p">}</span><span class="k">else</span>
</span><span id="__span-5-38"><a id="__codelineno-5-38" name="__codelineno-5-38" href="#__codelineno-5-38"></a><span class="mi">102</span><span class="w">       </span><span class="n">panic</span><span class="p">(</span><span class="w"> </span><span class="s">&quot;unknown program segment encountered, segment flag:%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">ph_addr</span><span class="p">.</span><span class="n">flags</span><span class="w"> </span><span class="p">);</span>
</span><span id="__span-5-39"><a id="__codelineno-5-39" name="__codelineno-5-39" href="#__codelineno-5-39"></a><span class="mi">103</span>
</span><span id="__span-5-40"><a id="__codelineno-5-40" name="__codelineno-5-40" href="#__codelineno-5-40"></a><span class="mi">104</span><span class="w">     </span><span class="p">((</span><span class="n">process</span><span class="o">*</span><span class="p">)(((</span><span class="n">elf_info</span><span class="o">*</span><span class="p">)(</span><span class="n">ctx</span><span class="o">-&gt;</span><span class="n">info</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">p</span><span class="p">))</span><span class="o">-&gt;</span><span class="n">total_mapped_region</span><span class="w"> </span><span class="o">++</span><span class="p">;</span>
</span><span id="__span-5-41"><a id="__codelineno-5-41" name="__codelineno-5-41" href="#__codelineno-5-41"></a><span class="mi">105</span><span class="w">   </span><span class="p">}</span>
</span><span id="__span-5-42"><a id="__codelineno-5-42" name="__codelineno-5-42" href="#__codelineno-5-42"></a><span class="mi">106</span>
</span><span id="__span-5-43"><a id="__codelineno-5-43" name="__codelineno-5-43" href="#__codelineno-5-43"></a><span class="mi">107</span><span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="n">EL_OK</span><span class="p">;</span>
</span><span id="__span-5-44"><a id="__codelineno-5-44" name="__codelineno-5-44" href="#__codelineno-5-44"></a><span class="mi">108</span><span class="w"> </span><span class="p">}</span>
</span></code></pre></div>
<p>以上代码段中，第95--102行将对被载入的段的类型（ph_addr.flags）进行判断以确定它是代码段还是数据段。完成以上的虚地址空间到物理地址空间的映射后，将形成用户进程的虚地址空间结构（如<a href="../chapter4_memory/#user_vm_space">图4.5</a>所示）。</p>
<p>接下来，将通过switch_to()函数将所构造的进程投入执行：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="w"> </span><span class="mi">41</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">switch_to</span><span class="p">(</span><span class="n">process</span><span class="o">*</span><span class="w"> </span><span class="n">proc</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="w"> </span><span class="mi">42</span><span class="w">   </span><span class="n">assert</span><span class="p">(</span><span class="n">proc</span><span class="p">);</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="w"> </span><span class="mi">43</span><span class="w">   </span><span class="n">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">proc</span><span class="p">;</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="w"> </span><span class="mi">44</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="w"> </span><span class="mi">45</span><span class="w">   </span><span class="c1">// write the smode_trap_vector (64-bit func. address) defined in kernel/strap_vector.S</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="w"> </span><span class="mi">46</span><span class="w">   </span><span class="c1">// to the stvec privilege register, such that trap handler pointed by smode_trap_vector</span>
</span><span id="__span-6-7"><a id="__codelineno-6-7" name="__codelineno-6-7" href="#__codelineno-6-7"></a><span class="w"> </span><span class="mi">47</span><span class="w">   </span><span class="c1">// will be triggered when an interrupt occurs in S mode.</span>
</span><span id="__span-6-8"><a id="__codelineno-6-8" name="__codelineno-6-8" href="#__codelineno-6-8"></a><span class="w"> </span><span class="mi">48</span><span class="w">   </span><span class="n">write_csr</span><span class="p">(</span><span class="n">stvec</span><span class="p">,</span><span class="w"> </span><span class="p">(</span><span class="n">uint64</span><span class="p">)</span><span class="n">smode_trap_vector</span><span class="p">);</span>
</span><span id="__span-6-9"><a id="__codelineno-6-9" name="__codelineno-6-9" href="#__codelineno-6-9"></a><span class="w"> </span><span class="mi">49</span>
</span><span id="__span-6-10"><a id="__codelineno-6-10" name="__codelineno-6-10" href="#__codelineno-6-10"></a><span class="w"> </span><span class="mi">50</span><span class="w">   </span><span class="c1">// set up trapframe values (in process structure) that smode_trap_vector will need when</span>
</span><span id="__span-6-11"><a id="__codelineno-6-11" name="__codelineno-6-11" href="#__codelineno-6-11"></a><span class="w"> </span><span class="mi">51</span><span class="w">   </span><span class="c1">// the process next re-enters the kernel.</span>
</span><span id="__span-6-12"><a id="__codelineno-6-12" name="__codelineno-6-12" href="#__codelineno-6-12"></a><span class="w"> </span><span class="mi">52</span><span class="w">   </span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">trapframe</span><span class="o">-&gt;</span><span class="n">kernel_sp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">kstack</span><span class="p">;</span><span class="w">      </span><span class="c1">// process&#39;s kernel stack</span>
</span><span id="__span-6-13"><a id="__codelineno-6-13" name="__codelineno-6-13" href="#__codelineno-6-13"></a><span class="w"> </span><span class="mi">53</span><span class="w">   </span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">trapframe</span><span class="o">-&gt;</span><span class="n">kernel_satp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_csr</span><span class="p">(</span><span class="n">satp</span><span class="p">);</span><span class="w">  </span><span class="c1">// kernel page table</span>
</span><span id="__span-6-14"><a id="__codelineno-6-14" name="__codelineno-6-14" href="#__codelineno-6-14"></a><span class="w"> </span><span class="mi">54</span><span class="w">   </span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">trapframe</span><span class="o">-&gt;</span><span class="n">kernel_trap</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">uint64</span><span class="p">)</span><span class="n">smode_trap_handler</span><span class="p">;</span>
</span><span id="__span-6-15"><a id="__codelineno-6-15" name="__codelineno-6-15" href="#__codelineno-6-15"></a><span class="w"> </span><span class="mi">55</span>
</span><span id="__span-6-16"><a id="__codelineno-6-16" name="__codelineno-6-16" href="#__codelineno-6-16"></a><span class="w"> </span><span class="mi">56</span><span class="w">   </span><span class="c1">// SSTATUS_SPP and SSTATUS_SPIE are defined in kernel/riscv.h</span>
</span><span id="__span-6-17"><a id="__codelineno-6-17" name="__codelineno-6-17" href="#__codelineno-6-17"></a><span class="w"> </span><span class="mi">57</span><span class="w">   </span><span class="c1">// set S Previous Privilege mode (the SSTATUS_SPP bit in sstatus register) to User mode.</span>
</span><span id="__span-6-18"><a id="__codelineno-6-18" name="__codelineno-6-18" href="#__codelineno-6-18"></a><span class="w"> </span><span class="mi">58</span><span class="w">   </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">long</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">read_csr</span><span class="p">(</span><span class="n">sstatus</span><span class="p">);</span>
</span><span id="__span-6-19"><a id="__codelineno-6-19" name="__codelineno-6-19" href="#__codelineno-6-19"></a><span class="w"> </span><span class="mi">59</span><span class="w">   </span><span class="n">x</span><span class="w"> </span><span class="o">&amp;=</span><span class="w"> </span><span class="o">~</span><span class="n">SSTATUS_SPP</span><span class="p">;</span><span class="w">  </span><span class="c1">// clear SPP to 0 for user mode</span>
</span><span id="__span-6-20"><a id="__codelineno-6-20" name="__codelineno-6-20" href="#__codelineno-6-20"></a><span class="w"> </span><span class="mi">60</span><span class="w">   </span><span class="n">x</span><span class="w"> </span><span class="o">|=</span><span class="w"> </span><span class="n">SSTATUS_SPIE</span><span class="p">;</span><span class="w">  </span><span class="c1">// enable interrupts in user mode</span>
</span><span id="__span-6-21"><a id="__codelineno-6-21" name="__codelineno-6-21" href="#__codelineno-6-21"></a><span class="w"> </span><span class="mi">61</span>
</span><span id="__span-6-22"><a id="__codelineno-6-22" name="__codelineno-6-22" href="#__codelineno-6-22"></a><span class="w"> </span><span class="mi">62</span><span class="w">   </span><span class="c1">// write x back to &#39;sstatus&#39; register to enable interrupts, and sret destination mode.</span>
</span><span id="__span-6-23"><a id="__codelineno-6-23" name="__codelineno-6-23" href="#__codelineno-6-23"></a><span class="w"> </span><span class="mi">63</span><span class="w">   </span><span class="n">write_csr</span><span class="p">(</span><span class="n">sstatus</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">);</span>
</span><span id="__span-6-24"><a id="__codelineno-6-24" name="__codelineno-6-24" href="#__codelineno-6-24"></a><span class="w"> </span><span class="mi">64</span>
</span><span id="__span-6-25"><a id="__codelineno-6-25" name="__codelineno-6-25" href="#__codelineno-6-25"></a><span class="w"> </span><span class="mi">65</span><span class="w">   </span><span class="c1">// set S Exception Program Counter (sepc register) to the elf entry pc.</span>
</span><span id="__span-6-26"><a id="__codelineno-6-26" name="__codelineno-6-26" href="#__codelineno-6-26"></a><span class="w"> </span><span class="mi">66</span><span class="w">   </span><span class="n">write_csr</span><span class="p">(</span><span class="n">sepc</span><span class="p">,</span><span class="w"> </span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">trapframe</span><span class="o">-&gt;</span><span class="n">epc</span><span class="p">);</span>
</span><span id="__span-6-27"><a id="__codelineno-6-27" name="__codelineno-6-27" href="#__codelineno-6-27"></a><span class="w"> </span><span class="mi">67</span>
</span><span id="__span-6-28"><a id="__codelineno-6-28" name="__codelineno-6-28" href="#__codelineno-6-28"></a><span class="w"> </span><span class="mi">68</span><span class="w">   </span><span class="c1">// make user page table. macro MAKE_SATP is defined in kernel/riscv.h. added @lab2_1</span>
</span><span id="__span-6-29"><a id="__codelineno-6-29" name="__codelineno-6-29" href="#__codelineno-6-29"></a><span class="w"> </span><span class="mi">69</span><span class="w">   </span><span class="n">uint64</span><span class="w"> </span><span class="n">user_satp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MAKE_SATP</span><span class="p">(</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">pagetable</span><span class="p">);</span>
</span><span id="__span-6-30"><a id="__codelineno-6-30" name="__codelineno-6-30" href="#__codelineno-6-30"></a><span class="w"> </span><span class="mi">70</span>
</span><span id="__span-6-31"><a id="__codelineno-6-31" name="__codelineno-6-31" href="#__codelineno-6-31"></a><span class="w"> </span><span class="mi">71</span><span class="w">   </span><span class="c1">// return_to_user() is defined in kernel/strap_vector.S. switch to user mode with sret.</span>
</span><span id="__span-6-32"><a id="__codelineno-6-32" name="__codelineno-6-32" href="#__codelineno-6-32"></a><span class="w"> </span><span class="mi">72</span><span class="w">   </span><span class="c1">// note, return_to_user takes two parameters @ and after lab2_1.</span>
</span><span id="__span-6-33"><a id="__codelineno-6-33" name="__codelineno-6-33" href="#__codelineno-6-33"></a><span class="w"> </span><span class="mi">73</span><span class="w">   </span><span class="n">return_to_user</span><span class="p">(</span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">trapframe</span><span class="p">,</span><span class="w"> </span><span class="n">user_satp</span><span class="p">);</span>
</span><span id="__span-6-34"><a id="__codelineno-6-34" name="__codelineno-6-34" href="#__codelineno-6-34"></a><span class="w"> </span><span class="mi">74</span><span class="w"> </span><span class="p">}</span>
</span></code></pre></div>
<p>实际上，以上函数在<a href="../chapter3_traps/">实验1</a>就有所涉及，它的作用是将进程结构中的trapframe作为进程上下文恢复到RISC-V机器的通用寄存器中，并最后调用sret指令（通过return_to_user()函数）将进程投入执行。</p>
<p>不同于实验1和实验2，实验3的exit系统调用不能够直接将系统shutdown，因为一个进程的结束并不一定意味着系统中所有进程的完成。以下是实验3中exit系统调用的实现：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="w"> </span><span class="mi">34</span><span class="w"> </span><span class="kt">ssize_t</span><span class="w"> </span><span class="n">sys_user_exit</span><span class="p">(</span><span class="n">uint64</span><span class="w"> </span><span class="n">code</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="w"> </span><span class="mi">35</span><span class="w">   </span><span class="n">sprint</span><span class="p">(</span><span class="s">&quot;User exit with code:%d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">code</span><span class="p">);</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="w"> </span><span class="mi">36</span><span class="w">   </span><span class="c1">// reclaim the current process, and reschedule. added @lab3_1</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="w"> </span><span class="mi">37</span><span class="w">   </span><span class="n">free_process</span><span class="p">(</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="p">);</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="w"> </span><span class="mi">38</span><span class="w">   </span><span class="n">schedule</span><span class="p">();</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="w"> </span><span class="mi">39</span><span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="w"> </span><span class="mi">40</span><span class="w"> </span><span class="p">}</span>
</span></code></pre></div>
<p>可以看到，如果某进程调用了exit()系统调用，操作系统的处理方法是调用free_process()函数，将当前进程（也就是调用者）进行“释放”，然后转进程调度。其中free_process()函数（kernel/process.c文件）的实现非常简单：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="mi">153</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">free_process</span><span class="p">(</span><span class="w"> </span><span class="n">process</span><span class="o">*</span><span class="w"> </span><span class="n">proc</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="mi">154</span><span class="w">   </span><span class="c1">// we set the status to ZOMBIE, but cannot destruct its vm space immediately.</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="mi">155</span><span class="w">   </span><span class="c1">// since proc can be current process, and its user kernel stack is currently in use!</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="mi">156</span><span class="w">   </span><span class="c1">// but for proxy kernel, it (memory leaking) may NOT be a really serious issue,</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="mi">157</span><span class="w">   </span><span class="c1">// as it is different from regular OS, which needs to run 7x24.</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="mi">158</span><span class="w">   </span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ZOMBIE</span><span class="p">;</span>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="mi">159</span>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="mi">160</span><span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a><span class="mi">161</span><span class="w"> </span><span class="p">}</span>
</span></code></pre></div>
<p>可以看到，<strong>free_process()函数仅是将进程设为ZOMBIE状态，而不会将进程所占用的资源全部释放</strong>！这是因为free_process()函数的调用，说明操作系统当前是在S模式下运行，而按照PKE的设计思想，S态的运行将使用当前进程的用户系统栈（user kernel stack）。此时，如果将当前进程的内存空间进行释放，将导致操作系统本身的崩溃。所以释放进程时，PKE采用的是折衷的办法，即只将其设置为僵尸（ZOMBIE）状态，而不是立即将它所占用的资源进行释放。最后，schedule()函数的调用，将选择系统中可能存在的其他处于就绪状态的进程投入运行，它的处理逻辑我们将在下一节讨论。</p>
<p><a name="subsec_management"></a></p>
<h3 id="513">5.1.3 就绪进程的管理与调度</h3>
<p>PKE的操作系统设计了一个非常简单的就绪队列管理（因为实验3的基础实验并未涉及进程的阻塞，所以未设计阻塞队列），队列头在kernel/sched.c文件中定义：</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a>8 process* ready_queue_head = NULL;
</span></code></pre></div>
<p>将一个进程加入就绪队列，可以调用insert_to_ready_queue()函数：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="w"> </span><span class="mi">13</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">insert_to_ready_queue</span><span class="p">(</span><span class="w"> </span><span class="n">process</span><span class="o">*</span><span class="w"> </span><span class="n">proc</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a><span class="w"> </span><span class="mi">14</span><span class="w">   </span><span class="n">sprint</span><span class="p">(</span><span class="w"> </span><span class="s">&quot;going to insert process %d to ready queue.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">pid</span><span class="w"> </span><span class="p">);</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a><span class="w"> </span><span class="mi">15</span><span class="w">   </span><span class="c1">// if the queue is empty in the beginning</span>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a><span class="w"> </span><span class="mi">16</span><span class="w">   </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">ready_queue_head</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="nb">NULL</span><span class="w"> </span><span class="p">){</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a><span class="w"> </span><span class="mi">17</span><span class="w">     </span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">READY</span><span class="p">;</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a><span class="w"> </span><span class="mi">18</span><span class="w">     </span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">queue_next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a><span class="w"> </span><span class="mi">19</span><span class="w">     </span><span class="n">ready_queue_head</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">proc</span><span class="p">;</span>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a><span class="w"> </span><span class="mi">20</span><span class="w">     </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a><span class="w"> </span><span class="mi">21</span><span class="w">   </span><span class="p">}</span>
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a><span class="w"> </span><span class="mi">22</span>
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a><span class="w"> </span><span class="mi">23</span><span class="w">   </span><span class="c1">// ready queue is not empty</span>
</span><span id="__span-10-12"><a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a><span class="w"> </span><span class="mi">24</span><span class="w">   </span><span class="n">process</span><span class="w"> </span><span class="o">*</span><span class="n">p</span><span class="p">;</span>
</span><span id="__span-10-13"><a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a><span class="w"> </span><span class="mi">25</span><span class="w">   </span><span class="c1">// browse the ready queue to see if proc is already in-queue</span>
</span><span id="__span-10-14"><a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a><span class="w"> </span><span class="mi">26</span><span class="w">   </span><span class="k">for</span><span class="p">(</span><span class="w"> </span><span class="n">p</span><span class="o">=</span><span class="n">ready_queue_head</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">queue_next</span><span class="o">!=</span><span class="nb">NULL</span><span class="p">;</span><span class="w"> </span><span class="n">p</span><span class="o">=</span><span class="n">p</span><span class="o">-&gt;</span><span class="n">queue_next</span><span class="w"> </span><span class="p">)</span>
</span><span id="__span-10-15"><a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a><span class="w"> </span><span class="mi">27</span><span class="w">     </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">proc</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span><span class="w">  </span><span class="c1">//already in queue</span>
</span><span id="__span-10-16"><a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a><span class="w"> </span><span class="mi">28</span>
</span><span id="__span-10-17"><a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a><span class="w"> </span><span class="mi">29</span><span class="w">   </span><span class="c1">// p points to the last element of the ready queue</span>
</span><span id="__span-10-18"><a id="__codelineno-10-18" name="__codelineno-10-18" href="#__codelineno-10-18"></a><span class="w"> </span><span class="mi">30</span><span class="w">   </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">p</span><span class="o">==</span><span class="n">proc</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-10-19"><a id="__codelineno-10-19" name="__codelineno-10-19" href="#__codelineno-10-19"></a><span class="w"> </span><span class="mi">31</span><span class="w">   </span><span class="n">p</span><span class="o">-&gt;</span><span class="n">queue_next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">proc</span><span class="p">;</span>
</span><span id="__span-10-20"><a id="__codelineno-10-20" name="__codelineno-10-20" href="#__codelineno-10-20"></a><span class="w"> </span><span class="mi">32</span><span class="w">   </span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">READY</span><span class="p">;</span>
</span><span id="__span-10-21"><a id="__codelineno-10-21" name="__codelineno-10-21" href="#__codelineno-10-21"></a><span class="w"> </span><span class="mi">33</span><span class="w">   </span><span class="n">proc</span><span class="o">-&gt;</span><span class="n">queue_next</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">NULL</span><span class="p">;</span>
</span><span id="__span-10-22"><a id="__codelineno-10-22" name="__codelineno-10-22" href="#__codelineno-10-22"></a><span class="w"> </span><span class="mi">34</span>
</span><span id="__span-10-23"><a id="__codelineno-10-23" name="__codelineno-10-23" href="#__codelineno-10-23"></a><span class="w"> </span><span class="mi">35</span><span class="w">   </span><span class="k">return</span><span class="p">;</span>
</span><span id="__span-10-24"><a id="__codelineno-10-24" name="__codelineno-10-24" href="#__codelineno-10-24"></a><span class="w"> </span><span class="mi">36</span><span class="w"> </span><span class="p">}</span>
</span></code></pre></div>
<p>该函数首先（第16--21行）处理ready_queue_head为空（初始状态）的情况，如果就绪队列不为空，则将进程加入到队尾（第26--33行）。</p>
<p>PKE操作系统内核通过调用schedule()函数来完成进程的选择和换入：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="w"> </span><span class="mi">45</span><span class="w"> </span><span class="kt">void</span><span class="w"> </span><span class="n">schedule</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="w"> </span><span class="mi">46</span><span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="n">ready_queue_head</span><span class="w"> </span><span class="p">){</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a><span class="w"> </span><span class="mi">47</span><span class="w">     </span><span class="c1">// by default, if there are no ready process, and all processes are in the status of</span>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a><span class="w"> </span><span class="mi">48</span><span class="w">     </span><span class="c1">// FREE and ZOMBIE, we should shutdown the emulated RISC-V machine.</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a><span class="w"> </span><span class="mi">49</span><span class="w">     </span><span class="kt">int</span><span class="w"> </span><span class="n">should_shutdown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a><span class="w"> </span><span class="mi">50</span>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a><span class="w"> </span><span class="mi">51</span><span class="w">     </span><span class="k">for</span><span class="p">(</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">NPROC</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="w"> </span><span class="p">)</span>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a><span class="w"> </span><span class="mi">52</span><span class="w">       </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="n">procs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">FREE</span><span class="p">)</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="p">(</span><span class="n">procs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">ZOMBIE</span><span class="p">)</span><span class="w"> </span><span class="p">){</span>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a><span class="w"> </span><span class="mi">53</span><span class="w">         </span><span class="n">should_shutdown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a><span class="w"> </span><span class="mi">54</span><span class="w">         </span><span class="n">sprint</span><span class="p">(</span><span class="w"> </span><span class="s">&quot;ready queue empty, but process %d is not in free/zombie state:%d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span>
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a><span class="w"> </span><span class="mi">55</span><span class="w">           </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">procs</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">status</span><span class="w"> </span><span class="p">);</span>
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a><span class="w"> </span><span class="mi">56</span><span class="w">       </span><span class="p">}</span>
</span><span id="__span-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a><span class="w"> </span><span class="mi">57</span>
</span><span id="__span-11-14"><a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a><span class="w"> </span><span class="mi">58</span><span class="w">     </span><span class="k">if</span><span class="p">(</span><span class="w"> </span><span class="n">should_shutdown</span><span class="w"> </span><span class="p">){</span>
</span><span id="__span-11-15"><a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a><span class="w"> </span><span class="mi">59</span><span class="w">       </span><span class="n">sprint</span><span class="p">(</span><span class="w"> </span><span class="s">&quot;no more ready processes, system shutdown now.</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"> </span><span class="p">);</span>
</span><span id="__span-11-16"><a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a><span class="w"> </span><span class="mi">60</span><span class="w">       </span><span class="n">shutdown</span><span class="p">(</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">);</span>
</span><span id="__span-11-17"><a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a><span class="w"> </span><span class="mi">61</span><span class="w">     </span><span class="p">}</span><span class="k">else</span><span class="p">{</span>
</span><span id="__span-11-18"><a id="__codelineno-11-18" name="__codelineno-11-18" href="#__codelineno-11-18"></a><span class="w"> </span><span class="mi">62</span><span class="w">       </span><span class="n">panic</span><span class="p">(</span><span class="w"> </span><span class="s">&quot;Not handled: we should let system wait for unfinished processes.</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"> </span><span class="p">);</span>
</span><span id="__span-11-19"><a id="__codelineno-11-19" name="__codelineno-11-19" href="#__codelineno-11-19"></a><span class="w"> </span><span class="mi">63</span><span class="w">     </span><span class="p">}</span>
</span><span id="__span-11-20"><a id="__codelineno-11-20" name="__codelineno-11-20" href="#__codelineno-11-20"></a><span class="w"> </span><span class="mi">64</span><span class="w">   </span><span class="p">}</span>
</span><span id="__span-11-21"><a id="__codelineno-11-21" name="__codelineno-11-21" href="#__codelineno-11-21"></a><span class="w"> </span><span class="mi">65</span>
</span><span id="__span-11-22"><a id="__codelineno-11-22" name="__codelineno-11-22" href="#__codelineno-11-22"></a><span class="w"> </span><span class="mi">66</span><span class="w">   </span><span class="n">current</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ready_queue_head</span><span class="p">;</span>
</span><span id="__span-11-23"><a id="__codelineno-11-23" name="__codelineno-11-23" href="#__codelineno-11-23"></a><span class="w"> </span><span class="mi">67</span><span class="w">   </span><span class="n">assert</span><span class="p">(</span><span class="w"> </span><span class="n">current</span><span class="o">-&gt;</span><span class="n">status</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">READY</span><span class="w"> </span><span class="p">);</span>
</span><span id="__span-11-24"><a id="__codelineno-11-24" name="__codelineno-11-24" href="#__codelineno-11-24"></a><span class="w"> </span><span class="mi">68</span><span class="w">   </span><span class="n">ready_queue_head</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ready_queue_head</span><span class="o">-&gt;</span><span class="n">queue_next</span><span class="p">;</span>
</span><span id="__span-11-25"><a id="__codelineno-11-25" name="__codelineno-11-25" href="#__codelineno-11-25"></a><span class="w"> </span><span class="mi">69</span>
</span><span id="__span-11-26"><a id="__codelineno-11-26" name="__codelineno-11-26" href="#__codelineno-11-26"></a><span class="w"> </span><span class="mi">70</span><span class="w">   </span><span class="n">current</span><span class="o">-&gt;</span><span class="n">status</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">RUNNING</span><span class="p">;</span>
</span><span id="__span-11-27"><a id="__codelineno-11-27" name="__codelineno-11-27" href="#__codelineno-11-27"></a><span class="w"> </span><span class="mi">71</span><span class="w">   </span><span class="n">sprint</span><span class="p">(</span><span class="w"> </span><span class="s">&quot;going to schedule process %d to run.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">current</span><span class="o">-&gt;</span><span class="n">pid</span><span class="w"> </span><span class="p">);</span>
</span><span id="__span-11-28"><a id="__codelineno-11-28" name="__codelineno-11-28" href="#__codelineno-11-28"></a><span class="w"> </span><span class="mi">72</span><span class="w">   </span><span class="n">switch_to</span><span class="p">(</span><span class="w"> </span><span class="n">current</span><span class="w"> </span><span class="p">);</span>
</span><span id="__span-11-29"><a id="__codelineno-11-29" name="__codelineno-11-29" href="#__codelineno-11-29"></a><span class="w"> </span><span class="mi">73</span><span class="w"> </span><span class="p">}</span>
</span></code></pre></div>
<p>可以看到，schedule()函数首先判断就绪队列ready_queue_head是否为空，对于为空的情况（第46--64行），schedule()函数将判断系统中所有的进程是否全部都处于被释放（FREE）状态，或者僵尸（ZOMBIE）状态。如果是，则启动关（模拟RISC-V）机程序，否则应进入等待系统中进程结束的状态。但是，由于实验3的基础实验并无可能进入这样的状态，所以我们在这里调用了panic，等后续实验有可能进入这种状态后再进一步处理。</p>
<p>对于就绪队列非空的情况（第66--72行），处理就简单得多：只需要将就绪队列队首的进程换入执行即可。对于换入的过程，需要注意的是，要将被选中的进程从就绪队列中摘掉。</p>
<p><a name="lab3_1_naive_fork"></a></p>
<h2 id="52-lab3_1-fork">5.2 lab3_1 进程创建（fork）</h2>
<p><a name="lab3_1_app"></a></p>
<h4 id="_2"><strong>给定应用</strong></h4>
<ul>
<li>user/app_naive_fork.c</li>
</ul>
<div class="language-c highlight"><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="cm">/*</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a><span class="cm">  2  * The application of lab3_1.</span>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="cm">  3  * it simply forks a child process.</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a><span class="cm">  4  */</span>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a><span class="w">  </span><span class="mi">5</span>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="w">  </span><span class="mi">6</span><span class="w"> </span><span class="err">#</span><span class="n">include</span><span class="w"> </span><span class="s">&quot;user/user_lib.h&quot;</span>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a><span class="w">  </span><span class="mi">7</span><span class="w"> </span><span class="err">#</span><span class="n">include</span><span class="w"> </span><span class="s">&quot;util/types.h&quot;</span>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a><span class="w">  </span><span class="mi">8</span>
</span><span id="__span-12-9"><a id="__codelineno-12-9" name="__codelineno-12-9" href="#__codelineno-12-9"></a><span class="w">  </span><span class="mi">9</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-10"><a id="__codelineno-12-10" name="__codelineno-12-10" href="#__codelineno-12-10"></a><span class="w"> </span><span class="mi">10</span><span class="w">   </span><span class="n">uint64</span><span class="w"> </span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fork</span><span class="p">();</span>
</span><span id="__span-12-11"><a id="__codelineno-12-11" name="__codelineno-12-11" href="#__codelineno-12-11"></a><span class="w"> </span><span class="mi">11</span><span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-12"><a id="__codelineno-12-12" name="__codelineno-12-12" href="#__codelineno-12-12"></a><span class="w"> </span><span class="mi">12</span><span class="w">     </span><span class="n">printu</span><span class="p">(</span><span class="s">&quot;Child: Hello world!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-12-13"><a id="__codelineno-12-13" name="__codelineno-12-13" href="#__codelineno-12-13"></a><span class="w"> </span><span class="mi">13</span><span class="w">   </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-12-14"><a id="__codelineno-12-14" name="__codelineno-12-14" href="#__codelineno-12-14"></a><span class="w"> </span><span class="mi">14</span><span class="w">     </span><span class="n">printu</span><span class="p">(</span><span class="s">&quot;Parent: Hello world! child id %ld</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="p">);</span>
</span><span id="__span-12-15"><a id="__codelineno-12-15" name="__codelineno-12-15" href="#__codelineno-12-15"></a><span class="w"> </span><span class="mi">15</span><span class="w">   </span><span class="p">}</span>
</span><span id="__span-12-16"><a id="__codelineno-12-16" name="__codelineno-12-16" href="#__codelineno-12-16"></a><span class="w"> </span><span class="mi">16</span>
</span><span id="__span-12-17"><a id="__codelineno-12-17" name="__codelineno-12-17" href="#__codelineno-12-17"></a><span class="w"> </span><span class="mi">17</span><span class="w">   </span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-12-18"><a id="__codelineno-12-18" name="__codelineno-12-18" href="#__codelineno-12-18"></a><span class="w"> </span><span class="mi">18</span><span class="w"> </span><span class="p">}</span>
</span></code></pre></div>
<p>以上程序的行为非常简单：主进程调用fork()函数，后者产生一个系统调用，基于主进程这个模板创建它的子进程。</p>
<ul>
<li>（先提交lab2_3的答案，然后）切换到lab3_1，继承lab2_3及之前实验所做的修改，并make后的直接运行结果：</li>
</ul>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a>//切换到lab3_1
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a>$<span class="w"> </span>git<span class="w"> </span>checkout<span class="w"> </span>lab3_1_fork
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a>
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>//继承lab2_3以及之前的答案
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a>$<span class="w"> </span>git<span class="w"> </span>merge<span class="w"> </span>lab2_3_pagefault<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;continue to work on lab3_1&quot;</span>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a>
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a>//重新构造
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a>$<span class="w"> </span>make<span class="w"> </span>clean<span class="p">;</span><span class="w"> </span>make
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a>
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a>//运行构造结果
</span><span id="__span-13-11"><a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a>$<span class="w"> </span>spike<span class="w"> </span>./obj/riscv-pke<span class="w"> </span>./obj/app_naive_fork
</span><span id="__span-13-12"><a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a>In<span class="w"> </span>m_start,<span class="w"> </span>hartid:0
</span><span id="__span-13-13"><a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a>HTIF<span class="w"> </span>is<span class="w"> </span>available!
</span><span id="__span-13-14"><a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a><span class="o">(</span>Emulated<span class="o">)</span><span class="w"> </span>memory<span class="w"> </span>size:<span class="w"> </span><span class="m">2048</span><span class="w"> </span>MB
</span><span id="__span-13-15"><a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a>Enter<span class="w"> </span>supervisor<span class="w"> </span>mode...
</span><span id="__span-13-16"><a id="__codelineno-13-16" name="__codelineno-13-16" href="#__codelineno-13-16"></a>PKE<span class="w"> </span>kernel<span class="w"> </span>start<span class="w"> </span>0x0000000080000000,<span class="w"> </span>PKE<span class="w"> </span>kernel<span class="w"> </span>end:<span class="w"> </span>0x0000000080010000,<span class="w"> </span>PKE<span class="w"> </span>kernel<span class="w"> </span>size:<span class="w"> </span>0x0000000000010000<span class="w"> </span>.
</span><span id="__span-13-17"><a id="__codelineno-13-17" name="__codelineno-13-17" href="#__codelineno-13-17"></a>free<span class="w"> </span>physical<span class="w"> </span>memory<span class="w"> </span>address:<span class="w"> </span><span class="o">[</span>0x0000000080010000,<span class="w"> </span>0x0000000087ffffff<span class="o">]</span>
</span><span id="__span-13-18"><a id="__codelineno-13-18" name="__codelineno-13-18" href="#__codelineno-13-18"></a>kernel<span class="w"> </span>memory<span class="w"> </span>manager<span class="w"> </span>is<span class="w"> </span>initializing<span class="w"> </span>...
</span><span id="__span-13-19"><a id="__codelineno-13-19" name="__codelineno-13-19" href="#__codelineno-13-19"></a>KERN_BASE<span class="w"> </span>0x0000000080000000
</span><span id="__span-13-20"><a id="__codelineno-13-20" name="__codelineno-13-20" href="#__codelineno-13-20"></a>physical<span class="w"> </span>address<span class="w"> </span>of<span class="w"> </span>_etext<span class="w"> </span>is:<span class="w"> </span>0x0000000080005000
</span><span id="__span-13-21"><a id="__codelineno-13-21" name="__codelineno-13-21" href="#__codelineno-13-21"></a>kernel<span class="w"> </span>page<span class="w"> </span>table<span class="w"> </span>is<span class="w"> </span>on
</span><span id="__span-13-22"><a id="__codelineno-13-22" name="__codelineno-13-22" href="#__codelineno-13-22"></a>Switching<span class="w"> </span>to<span class="w"> </span>user<span class="w"> </span>mode...
</span><span id="__span-13-23"><a id="__codelineno-13-23" name="__codelineno-13-23" href="#__codelineno-13-23"></a><span class="k">in</span><span class="w"> </span>alloc_proc.<span class="w"> </span>user<span class="w"> </span>frame<span class="w"> </span>0x0000000087fbc000,<span class="w"> </span>user<span class="w"> </span>stack<span class="w"> </span>0x000000007ffff000,<span class="w"> </span>user<span class="w"> </span>kstack<span class="w"> </span>0x0000000087fbb000
</span><span id="__span-13-24"><a id="__codelineno-13-24" name="__codelineno-13-24" href="#__codelineno-13-24"></a>User<span class="w"> </span>application<span class="w"> </span>is<span class="w"> </span>loading.
</span><span id="__span-13-25"><a id="__codelineno-13-25" name="__codelineno-13-25" href="#__codelineno-13-25"></a>Application:<span class="w"> </span>./obj/app_naive_fork
</span><span id="__span-13-26"><a id="__codelineno-13-26" name="__codelineno-13-26" href="#__codelineno-13-26"></a>CODE_SEGMENT<span class="w"> </span>added<span class="w"> </span>at<span class="w"> </span>mapped<span class="w"> </span>info<span class="w"> </span>offset:3
</span><span id="__span-13-27"><a id="__codelineno-13-27" name="__codelineno-13-27" href="#__codelineno-13-27"></a>Application<span class="w"> </span>program<span class="w"> </span>entry<span class="w"> </span>point<span class="w"> </span><span class="o">(</span>virtual<span class="w"> </span>address<span class="o">)</span>:<span class="w"> </span>0x0000000000010078
</span><span id="__span-13-28"><a id="__codelineno-13-28" name="__codelineno-13-28" href="#__codelineno-13-28"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">0</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-13-29"><a id="__codelineno-13-29" name="__codelineno-13-29" href="#__codelineno-13-29"></a>going<span class="w"> </span>to<span class="w"> </span>schedule<span class="w"> </span>process<span class="w"> </span><span class="m">0</span><span class="w"> </span>to<span class="w"> </span>run.
</span><span id="__span-13-30"><a id="__codelineno-13-30" name="__codelineno-13-30" href="#__codelineno-13-30"></a>User<span class="w"> </span>call<span class="w"> </span>fork.
</span><span id="__span-13-31"><a id="__codelineno-13-31" name="__codelineno-13-31" href="#__codelineno-13-31"></a>will<span class="w"> </span>fork<span class="w"> </span>a<span class="w"> </span>child<span class="w"> </span>from<span class="w"> </span>parent<span class="w"> </span><span class="m">0</span>.
</span><span id="__span-13-32"><a id="__codelineno-13-32" name="__codelineno-13-32" href="#__codelineno-13-32"></a><span class="k">in</span><span class="w"> </span>alloc_proc.<span class="w"> </span>user<span class="w"> </span>frame<span class="w"> </span>0x0000000087faf000,<span class="w"> </span>user<span class="w"> </span>stack<span class="w"> </span>0x000000007ffff000,<span class="w"> </span>user<span class="w"> </span>kstack<span class="w"> </span>0x0000000087fae000
</span><span id="__span-13-33"><a id="__codelineno-13-33" name="__codelineno-13-33" href="#__codelineno-13-33"></a>You<span class="w"> </span>need<span class="w"> </span>to<span class="w"> </span>implement<span class="w"> </span>the<span class="w"> </span>code<span class="w"> </span>segment<span class="w"> </span>mapping<span class="w"> </span>of<span class="w"> </span>child<span class="w"> </span><span class="k">in</span><span class="w"> </span>lab3_1.
</span><span id="__span-13-34"><a id="__codelineno-13-34" name="__codelineno-13-34" href="#__codelineno-13-34"></a>
</span><span id="__span-13-35"><a id="__codelineno-13-35" name="__codelineno-13-35" href="#__codelineno-13-35"></a>System<span class="w"> </span>is<span class="w"> </span>shutting<span class="w"> </span>down<span class="w"> </span>with<span class="w"> </span><span class="nb">exit</span><span class="w"> </span>code<span class="w"> </span>-1.
</span></code></pre></div>
<p>从以上运行结果来看，应用程序的fork动作并未将子进程给创建出来并投入运行。按照提示，我们需要在PKE操作系统内核中实现子进程到父进程代码段的映射，以最终完成fork动作。</p>
<p>这里，既然涉及到了父进程的代码段，我们就可以先用readelf命令查看一下给定应用程序的可执行代码对应的ELF文件结构：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>$<span class="w"> </span>riscv64-unknown-elf-readelf<span class="w"> </span>-l<span class="w"> </span>./obj/app_naive_fork
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>Elf<span class="w"> </span>file<span class="w"> </span><span class="nb">type</span><span class="w"> </span>is<span class="w"> </span>EXEC<span class="w"> </span><span class="o">(</span>Executable<span class="w"> </span>file<span class="o">)</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a>Entry<span class="w"> </span>point<span class="w"> </span>0x10078
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>There<span class="w"> </span>is<span class="w"> </span><span class="m">1</span><span class="w"> </span>program<span class="w"> </span>header,<span class="w"> </span>starting<span class="w"> </span>at<span class="w"> </span>offset<span class="w"> </span><span class="m">64</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a>Program<span class="w"> </span>Headers:
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a><span class="w">  </span>Type<span class="w">           </span>Offset<span class="w">             </span>VirtAddr<span class="w">           </span>PhysAddr
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a><span class="w">                 </span>FileSiz<span class="w">            </span>MemSiz<span class="w">              </span>Flags<span class="w">  </span>Align
</span><span id="__span-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a><span class="w">  </span>LOAD<span class="w">           </span>0x0000000000000000<span class="w"> </span>0x0000000000010000<span class="w"> </span>0x0000000000010000
</span><span id="__span-14-11"><a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a><span class="w">                 </span>0x000000000000040c<span class="w"> </span>0x000000000000040c<span class="w">  </span>R<span class="w"> </span>E<span class="w">    </span>0x1000
</span><span id="__span-14-12"><a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a>
</span><span id="__span-14-13"><a id="__codelineno-14-13" name="__codelineno-14-13" href="#__codelineno-14-13"></a><span class="w"> </span>Section<span class="w"> </span>to<span class="w"> </span>Segment<span class="w"> </span>mapping:
</span><span id="__span-14-14"><a id="__codelineno-14-14" name="__codelineno-14-14" href="#__codelineno-14-14"></a><span class="w">  </span>Segment<span class="w"> </span>Sections...
</span><span id="__span-14-15"><a id="__codelineno-14-15" name="__codelineno-14-15" href="#__codelineno-14-15"></a><span class="w">   </span><span class="m">00</span><span class="w">     </span>.text<span class="w"> </span>.rodata
</span></code></pre></div>
<p>可以看到，app_naive_fork可执行文件只包含一个代码段（编号为00），应该来讲是最简单的可执行文件结构了（无须考虑数据段的问题）。如果要依据这样的父进程模板创建子进程，只需要将它的代码段映射（而非拷贝）到子进程的对应虚地址即可。</p>
<p><a name="lab3_1_content"></a></p>
<h4 id="_3"><strong>实验内容</strong></h4>
<p>完善操作系统内核kernel/process.c文件中的do_fork()函数，并最终获得以下预期结果：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a>$<span class="w"> </span>spike<span class="w"> </span>./obj/riscv-pke<span class="w"> </span>./obj/app_naive_fork
</span><span id="__span-15-2"><a id="__codelineno-15-2" name="__codelineno-15-2" href="#__codelineno-15-2"></a>In<span class="w"> </span>m_start,<span class="w"> </span>hartid:0
</span><span id="__span-15-3"><a id="__codelineno-15-3" name="__codelineno-15-3" href="#__codelineno-15-3"></a>HTIF<span class="w"> </span>is<span class="w"> </span>available!
</span><span id="__span-15-4"><a id="__codelineno-15-4" name="__codelineno-15-4" href="#__codelineno-15-4"></a><span class="o">(</span>Emulated<span class="o">)</span><span class="w"> </span>memory<span class="w"> </span>size:<span class="w"> </span><span class="m">2048</span><span class="w"> </span>MB
</span><span id="__span-15-5"><a id="__codelineno-15-5" name="__codelineno-15-5" href="#__codelineno-15-5"></a>Enter<span class="w"> </span>supervisor<span class="w"> </span>mode...
</span><span id="__span-15-6"><a id="__codelineno-15-6" name="__codelineno-15-6" href="#__codelineno-15-6"></a>PKE<span class="w"> </span>kernel<span class="w"> </span>start<span class="w"> </span>0x0000000080000000,<span class="w"> </span>PKE<span class="w"> </span>kernel<span class="w"> </span>end:<span class="w"> </span>0x0000000080010000,<span class="w"> </span>PKE<span class="w"> </span>kernel<span class="w"> </span>size:<span class="w"> </span>0x0000000000010000<span class="w"> </span>.
</span><span id="__span-15-7"><a id="__codelineno-15-7" name="__codelineno-15-7" href="#__codelineno-15-7"></a>free<span class="w"> </span>physical<span class="w"> </span>memory<span class="w"> </span>address:<span class="w"> </span><span class="o">[</span>0x0000000080010000,<span class="w"> </span>0x0000000087ffffff<span class="o">]</span>
</span><span id="__span-15-8"><a id="__codelineno-15-8" name="__codelineno-15-8" href="#__codelineno-15-8"></a>kernel<span class="w"> </span>memory<span class="w"> </span>manager<span class="w"> </span>is<span class="w"> </span>initializing<span class="w"> </span>...
</span><span id="__span-15-9"><a id="__codelineno-15-9" name="__codelineno-15-9" href="#__codelineno-15-9"></a>KERN_BASE<span class="w"> </span>0x0000000080000000
</span><span id="__span-15-10"><a id="__codelineno-15-10" name="__codelineno-15-10" href="#__codelineno-15-10"></a>physical<span class="w"> </span>address<span class="w"> </span>of<span class="w"> </span>_etext<span class="w"> </span>is:<span class="w"> </span>0x0000000080005000
</span><span id="__span-15-11"><a id="__codelineno-15-11" name="__codelineno-15-11" href="#__codelineno-15-11"></a>kernel<span class="w"> </span>page<span class="w"> </span>table<span class="w"> </span>is<span class="w"> </span>on
</span><span id="__span-15-12"><a id="__codelineno-15-12" name="__codelineno-15-12" href="#__codelineno-15-12"></a>Switching<span class="w"> </span>to<span class="w"> </span>user<span class="w"> </span>mode...
</span><span id="__span-15-13"><a id="__codelineno-15-13" name="__codelineno-15-13" href="#__codelineno-15-13"></a><span class="k">in</span><span class="w"> </span>alloc_proc.<span class="w"> </span>user<span class="w"> </span>frame<span class="w"> </span>0x0000000087fbc000,<span class="w"> </span>user<span class="w"> </span>stack<span class="w"> </span>0x000000007ffff000,<span class="w"> </span>user<span class="w"> </span>kstack<span class="w"> </span>0x0000000087fbb000
</span><span id="__span-15-14"><a id="__codelineno-15-14" name="__codelineno-15-14" href="#__codelineno-15-14"></a>User<span class="w"> </span>application<span class="w"> </span>is<span class="w"> </span>loading.
</span><span id="__span-15-15"><a id="__codelineno-15-15" name="__codelineno-15-15" href="#__codelineno-15-15"></a>Application:<span class="w"> </span>./obj/app_naive_fork
</span><span id="__span-15-16"><a id="__codelineno-15-16" name="__codelineno-15-16" href="#__codelineno-15-16"></a>CODE_SEGMENT<span class="w"> </span>added<span class="w"> </span>at<span class="w"> </span>mapped<span class="w"> </span>info<span class="w"> </span>offset:3
</span><span id="__span-15-17"><a id="__codelineno-15-17" name="__codelineno-15-17" href="#__codelineno-15-17"></a>Application<span class="w"> </span>program<span class="w"> </span>entry<span class="w"> </span>point<span class="w"> </span><span class="o">(</span>virtual<span class="w"> </span>address<span class="o">)</span>:<span class="w"> </span>0x0000000000010078
</span><span id="__span-15-18"><a id="__codelineno-15-18" name="__codelineno-15-18" href="#__codelineno-15-18"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">0</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-15-19"><a id="__codelineno-15-19" name="__codelineno-15-19" href="#__codelineno-15-19"></a>going<span class="w"> </span>to<span class="w"> </span>schedule<span class="w"> </span>process<span class="w"> </span><span class="m">0</span><span class="w"> </span>to<span class="w"> </span>run.
</span><span id="__span-15-20"><a id="__codelineno-15-20" name="__codelineno-15-20" href="#__codelineno-15-20"></a>User<span class="w"> </span>call<span class="w"> </span>fork.
</span><span id="__span-15-21"><a id="__codelineno-15-21" name="__codelineno-15-21" href="#__codelineno-15-21"></a>will<span class="w"> </span>fork<span class="w"> </span>a<span class="w"> </span>child<span class="w"> </span>from<span class="w"> </span>parent<span class="w"> </span><span class="m">0</span>.
</span><span id="__span-15-22"><a id="__codelineno-15-22" name="__codelineno-15-22" href="#__codelineno-15-22"></a><span class="k">in</span><span class="w"> </span>alloc_proc.<span class="w"> </span>user<span class="w"> </span>frame<span class="w"> </span>0x0000000087faf000,<span class="w"> </span>user<span class="w"> </span>stack<span class="w"> </span>0x000000007ffff000,<span class="w"> </span>user<span class="w"> </span>kstack<span class="w"> </span>0x0000000087fae000
</span><span id="__span-15-23"><a id="__codelineno-15-23" name="__codelineno-15-23" href="#__codelineno-15-23"></a>do_fork<span class="w"> </span>map<span class="w"> </span>code<span class="w"> </span>segment<span class="w"> </span>at<span class="w"> </span>pa:0000000087fb2000<span class="w"> </span>of<span class="w"> </span>parent<span class="w"> </span>to<span class="w"> </span>child<span class="w"> </span>at<span class="w"> </span>va:0000000000010000.
</span><span id="__span-15-24"><a id="__codelineno-15-24" name="__codelineno-15-24" href="#__codelineno-15-24"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">1</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-15-25"><a id="__codelineno-15-25" name="__codelineno-15-25" href="#__codelineno-15-25"></a>Parent:<span class="w"> </span>Hello<span class="w"> </span>world!<span class="w"> </span>child<span class="w"> </span>id<span class="w"> </span><span class="m">1</span>
</span><span id="__span-15-26"><a id="__codelineno-15-26" name="__codelineno-15-26" href="#__codelineno-15-26"></a>User<span class="w"> </span><span class="nb">exit</span><span class="w"> </span>with<span class="w"> </span>code:0.
</span><span id="__span-15-27"><a id="__codelineno-15-27" name="__codelineno-15-27" href="#__codelineno-15-27"></a>going<span class="w"> </span>to<span class="w"> </span>schedule<span class="w"> </span>process<span class="w"> </span><span class="m">1</span><span class="w"> </span>to<span class="w"> </span>run.
</span><span id="__span-15-28"><a id="__codelineno-15-28" name="__codelineno-15-28" href="#__codelineno-15-28"></a>Child:<span class="w"> </span>Hello<span class="w"> </span>world!
</span><span id="__span-15-29"><a id="__codelineno-15-29" name="__codelineno-15-29" href="#__codelineno-15-29"></a>User<span class="w"> </span><span class="nb">exit</span><span class="w"> </span>with<span class="w"> </span>code:0.
</span><span id="__span-15-30"><a id="__codelineno-15-30" name="__codelineno-15-30" href="#__codelineno-15-30"></a>no<span class="w"> </span>more<span class="w"> </span>ready<span class="w"> </span>processes,<span class="w"> </span>system<span class="w"> </span>shutdown<span class="w"> </span>now.
</span><span id="__span-15-31"><a id="__codelineno-15-31" name="__codelineno-15-31" href="#__codelineno-15-31"></a>System<span class="w"> </span>is<span class="w"> </span>shutting<span class="w"> </span>down<span class="w"> </span>with<span class="w"> </span><span class="nb">exit</span><span class="w"> </span>code<span class="w"> </span><span class="m">0</span>.
</span></code></pre></div>
<p>从以上运行结果来看，子进程已经被创建，且在其后被投入运行。</p>
<p><a name="lab3_1_guide"></a></p>
<h4 id="_4"><strong>实验指导</strong></h4>
<p>读者可以回顾<a href="../chapter3_traps/#syscall">lab1_1</a>中所学习到的系统调用的知识，从应用程序（user/app_naive_fork.c）开始，跟踪fork()函数的实现：</p>
<p>user/app_naive_fork.c --&gt; user/user_lib.c --&gt; kernel/strap_vector.S --&gt; kernel/strap.c --&gt; kernel/syscall.c</p>
<p>直至跟踪到kernel/process.c文件中的do_fork()函数：</p>
<div class="language-c highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="mi">170</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">do_fork</span><span class="p">(</span><span class="w"> </span><span class="n">process</span><span class="o">*</span><span class="w"> </span><span class="n">parent</span><span class="p">)</span>
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="mi">171</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="mi">172</span><span class="w">   </span><span class="n">sprint</span><span class="p">(</span><span class="w"> </span><span class="s">&quot;will fork a child from parent %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">pid</span><span class="w"> </span><span class="p">);</span>
</span><span id="__span-16-4"><a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="mi">173</span><span class="w">   </span><span class="n">process</span><span class="o">*</span><span class="w"> </span><span class="n">child</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">alloc_process</span><span class="p">();</span>
</span><span id="__span-16-5"><a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="mi">174</span>
</span><span id="__span-16-6"><a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a><span class="mi">175</span><span class="w">   </span><span class="k">for</span><span class="p">(</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">&lt;</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">total_mapped_region</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="w"> </span><span class="p">){</span>
</span><span id="__span-16-7"><a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="mi">176</span><span class="w">     </span><span class="c1">// browse parent&#39;s vm space, and copy its trapframe and data segments,</span>
</span><span id="__span-16-8"><a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a><span class="mi">177</span><span class="w">     </span><span class="c1">// map its code segment.</span>
</span><span id="__span-16-9"><a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a><span class="mi">178</span><span class="w">     </span><span class="k">switch</span><span class="p">(</span><span class="w"> </span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">mapped_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">seg_type</span><span class="w"> </span><span class="p">){</span>
</span><span id="__span-16-10"><a id="__codelineno-16-10" name="__codelineno-16-10" href="#__codelineno-16-10"></a><span class="mi">179</span><span class="w">       </span><span class="k">case</span><span class="w"> </span><span class="no">CONTEXT_SEGMENT</span><span class="p">:</span>
</span><span id="__span-16-11"><a id="__codelineno-16-11" name="__codelineno-16-11" href="#__codelineno-16-11"></a><span class="mi">180</span><span class="w">         </span><span class="o">*</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">trapframe</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">trapframe</span><span class="p">;</span>
</span><span id="__span-16-12"><a id="__codelineno-16-12" name="__codelineno-16-12" href="#__codelineno-16-12"></a><span class="mi">181</span><span class="w">         </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-16-13"><a id="__codelineno-16-13" name="__codelineno-16-13" href="#__codelineno-16-13"></a><span class="mi">182</span><span class="w">       </span><span class="k">case</span><span class="w"> </span><span class="no">STACK_SEGMENT</span><span class="p">:</span>
</span><span id="__span-16-14"><a id="__codelineno-16-14" name="__codelineno-16-14" href="#__codelineno-16-14"></a><span class="mi">183</span><span class="w">         </span><span class="n">memcpy</span><span class="p">(</span><span class="w"> </span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">lookup_pa</span><span class="p">(</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">pagetable</span><span class="p">,</span><span class="w"> </span><span class="n">child</span><span class="o">-&gt;</span><span class="n">mapped_info</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">va</span><span class="p">),</span>
</span><span id="__span-16-15"><a id="__codelineno-16-15" name="__codelineno-16-15" href="#__codelineno-16-15"></a><span class="mi">184</span><span class="w">           </span><span class="p">(</span><span class="kt">void</span><span class="o">*</span><span class="p">)</span><span class="n">lookup_pa</span><span class="p">(</span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">pagetable</span><span class="p">,</span><span class="w"> </span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">mapped_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">va</span><span class="p">),</span><span class="w"> </span><span class="n">PGSIZE</span><span class="w"> </span><span class="p">);</span>
</span><span id="__span-16-16"><a id="__codelineno-16-16" name="__codelineno-16-16" href="#__codelineno-16-16"></a><span class="mi">185</span><span class="w">         </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-16-17"><a id="__codelineno-16-17" name="__codelineno-16-17" href="#__codelineno-16-17"></a><span class="mi">186</span><span class="w">       </span><span class="k">case</span><span class="w"> </span><span class="no">CODE_SEGMENT</span><span class="p">:</span>
</span><span id="__span-16-18"><a id="__codelineno-16-18" name="__codelineno-16-18" href="#__codelineno-16-18"></a><span class="mi">187</span><span class="w">         </span><span class="c1">// TODO (lab3_1): implment the mapping of child code segment to parent&#39;s</span>
</span><span id="__span-16-19"><a id="__codelineno-16-19" name="__codelineno-16-19" href="#__codelineno-16-19"></a><span class="mi">188</span><span class="w">         </span><span class="c1">// code segment.</span>
</span><span id="__span-16-20"><a id="__codelineno-16-20" name="__codelineno-16-20" href="#__codelineno-16-20"></a><span class="mi">189</span><span class="w">         </span><span class="c1">// hint: the virtual address mapping of code segment is tracked in mapped_info</span>
</span><span id="__span-16-21"><a id="__codelineno-16-21" name="__codelineno-16-21" href="#__codelineno-16-21"></a><span class="mi">190</span><span class="w">         </span><span class="c1">// page of parent&#39;s process structure. use the information in mapped_info to</span>
</span><span id="__span-16-22"><a id="__codelineno-16-22" name="__codelineno-16-22" href="#__codelineno-16-22"></a><span class="mi">191</span><span class="w">         </span><span class="c1">// retrieve the virtual to physical mapping of code segment.</span>
</span><span id="__span-16-23"><a id="__codelineno-16-23" name="__codelineno-16-23" href="#__codelineno-16-23"></a><span class="mi">192</span><span class="w">         </span><span class="c1">// after having the mapping information, just map the corresponding virtual</span>
</span><span id="__span-16-24"><a id="__codelineno-16-24" name="__codelineno-16-24" href="#__codelineno-16-24"></a><span class="mi">193</span><span class="w">         </span><span class="c1">// address region of child to the physical pages that actually store the code</span>
</span><span id="__span-16-25"><a id="__codelineno-16-25" name="__codelineno-16-25" href="#__codelineno-16-25"></a><span class="mi">194</span><span class="w">         </span><span class="c1">// segment of parent process.</span>
</span><span id="__span-16-26"><a id="__codelineno-16-26" name="__codelineno-16-26" href="#__codelineno-16-26"></a><span class="mi">195</span><span class="w">         </span><span class="c1">// DO NOT COPY THE PHYSICAL PAGES, JUST MAP THEM.</span>
</span><span id="__span-16-27"><a id="__codelineno-16-27" name="__codelineno-16-27" href="#__codelineno-16-27"></a><span class="mi">196</span><span class="w">         </span><span class="n">panic</span><span class="p">(</span><span class="w"> </span><span class="s">&quot;You need to implement the code segment mapping of child in lab3_1.</span><span class="se">\n</span><span class="s">&quot;</span><span class="w"> </span><span class="p">);</span>
</span><span id="__span-16-28"><a id="__codelineno-16-28" name="__codelineno-16-28" href="#__codelineno-16-28"></a><span class="mi">197</span>
</span><span id="__span-16-29"><a id="__codelineno-16-29" name="__codelineno-16-29" href="#__codelineno-16-29"></a><span class="mi">198</span><span class="w">         </span><span class="c1">// after mapping, register the vm region (do not delete codes below!)</span>
</span><span id="__span-16-30"><a id="__codelineno-16-30" name="__codelineno-16-30" href="#__codelineno-16-30"></a><span class="mi">199</span><span class="w">         </span><span class="n">child</span><span class="o">-&gt;</span><span class="n">mapped_info</span><span class="p">[</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">total_mapped_region</span><span class="p">].</span><span class="n">va</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">mapped_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">va</span><span class="p">;</span>
</span><span id="__span-16-31"><a id="__codelineno-16-31" name="__codelineno-16-31" href="#__codelineno-16-31"></a><span class="mi">200</span><span class="w">         </span><span class="n">child</span><span class="o">-&gt;</span><span class="n">mapped_info</span><span class="p">[</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">total_mapped_region</span><span class="p">].</span><span class="n">npages</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-16-32"><a id="__codelineno-16-32" name="__codelineno-16-32" href="#__codelineno-16-32"></a><span class="mi">201</span><span class="w">           </span><span class="n">parent</span><span class="o">-&gt;</span><span class="n">mapped_info</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">npages</span><span class="p">;</span>
</span><span id="__span-16-33"><a id="__codelineno-16-33" name="__codelineno-16-33" href="#__codelineno-16-33"></a><span class="mi">202</span><span class="w">         </span><span class="n">child</span><span class="o">-&gt;</span><span class="n">mapped_info</span><span class="p">[</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">total_mapped_region</span><span class="p">].</span><span class="n">seg_type</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CODE_SEGMENT</span><span class="p">;</span>
</span><span id="__span-16-34"><a id="__codelineno-16-34" name="__codelineno-16-34" href="#__codelineno-16-34"></a><span class="mi">203</span><span class="w">         </span><span class="n">child</span><span class="o">-&gt;</span><span class="n">total_mapped_region</span><span class="o">++</span><span class="p">;</span>
</span><span id="__span-16-35"><a id="__codelineno-16-35" name="__codelineno-16-35" href="#__codelineno-16-35"></a><span class="mi">204</span><span class="w">         </span><span class="k">break</span><span class="p">;</span>
</span><span id="__span-16-36"><a id="__codelineno-16-36" name="__codelineno-16-36" href="#__codelineno-16-36"></a><span class="mi">205</span><span class="w">     </span><span class="p">}</span>
</span><span id="__span-16-37"><a id="__codelineno-16-37" name="__codelineno-16-37" href="#__codelineno-16-37"></a><span class="mi">206</span><span class="w">   </span><span class="p">}</span>
</span></code></pre></div>
<p>该函数使用第175--205行的循环来拷贝父进程的逻辑地址空间到其子进程。我们看到，对于trapframe段（case CONTEXT_SEGMENT）以及堆栈段（case CODE_SEGMENT），do_fork()函数采用了简单复制的办法来拷贝父进程的这两个段到子进程中，这样做的目的是将父进程的执行现场传递给子进程。</p>
<p>然而，对于父进程的代码段，子进程应该如何“继承”呢？通过第187--195行的注释，我们知道对于代码段，我们不应直接复制（减少系统开销），而应通过映射的办法，将子进程中对应的逻辑地址空间映射到其父进程中装载代码段的物理页面。这里，就要回到<a href="../chapter4_memory/#pagetablecook">实验2内存管理</a>部分，寻找合适的函数来实现了。注意对页面的权限设置（可读可执行）。</p>
<p><strong>实验完毕后，记得提交修改（命令行中-m后的字符串可自行确定），以便在后续实验中继承lab3_1中所做的工作</strong>：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a>$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>-a<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;my work on lab3_1 is done.&quot;</span>
</span></code></pre></div>
<p><a name="lab3_2_yield"></a></p>
<h2 id="53-lab3_2-yield">5.3 lab3_2 进程yield</h2>
<p><a name="lab3_2_app"></a></p>
<h4 id="_5"><strong>给定应用</strong></h4>
<ul>
<li>user/app_yield.c</li>
</ul>
<div class="language-C highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a><span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="cm">/*</span>
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a><span class="cm">  2  * The application of lab3_2.</span>
</span><span id="__span-18-3"><a id="__codelineno-18-3" name="__codelineno-18-3" href="#__codelineno-18-3"></a><span class="cm">  3  * parent and child processes intermittently give up their processors.</span>
</span><span id="__span-18-4"><a id="__codelineno-18-4" name="__codelineno-18-4" href="#__codelineno-18-4"></a><span class="cm">  4  */</span>
</span><span id="__span-18-5"><a id="__codelineno-18-5" name="__codelineno-18-5" href="#__codelineno-18-5"></a><span class="w">  </span><span class="mi">5</span>
</span><span id="__span-18-6"><a id="__codelineno-18-6" name="__codelineno-18-6" href="#__codelineno-18-6"></a><span class="w">  </span><span class="mi">6</span><span class="w"> </span><span class="err">#</span><span class="n">include</span><span class="w"> </span><span class="s">&quot;user/user_lib.h&quot;</span>
</span><span id="__span-18-7"><a id="__codelineno-18-7" name="__codelineno-18-7" href="#__codelineno-18-7"></a><span class="w">  </span><span class="mi">7</span><span class="w"> </span><span class="err">#</span><span class="n">include</span><span class="w"> </span><span class="s">&quot;util/types.h&quot;</span>
</span><span id="__span-18-8"><a id="__codelineno-18-8" name="__codelineno-18-8" href="#__codelineno-18-8"></a><span class="w">  </span><span class="mi">8</span>
</span><span id="__span-18-9"><a id="__codelineno-18-9" name="__codelineno-18-9" href="#__codelineno-18-9"></a><span class="w">  </span><span class="mi">9</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-18-10"><a id="__codelineno-18-10" name="__codelineno-18-10" href="#__codelineno-18-10"></a><span class="w"> </span><span class="mi">10</span><span class="w">   </span><span class="n">uint64</span><span class="w"> </span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fork</span><span class="p">();</span>
</span><span id="__span-18-11"><a id="__codelineno-18-11" name="__codelineno-18-11" href="#__codelineno-18-11"></a><span class="w"> </span><span class="mi">11</span><span class="w">   </span><span class="n">uint64</span><span class="w"> </span><span class="n">rounds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mh">0xffff</span><span class="p">;</span>
</span><span id="__span-18-12"><a id="__codelineno-18-12" name="__codelineno-18-12" href="#__codelineno-18-12"></a><span class="w"> </span><span class="mi">12</span><span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-18-13"><a id="__codelineno-18-13" name="__codelineno-18-13" href="#__codelineno-18-13"></a><span class="w"> </span><span class="mi">13</span><span class="w">     </span><span class="n">printu</span><span class="p">(</span><span class="s">&quot;Child: Hello world! </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-18-14"><a id="__codelineno-18-14" name="__codelineno-18-14" href="#__codelineno-18-14"></a><span class="w"> </span><span class="mi">14</span><span class="w">     </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint64</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">rounds</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-18-15"><a id="__codelineno-18-15" name="__codelineno-18-15" href="#__codelineno-18-15"></a><span class="w"> </span><span class="mi">15</span><span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">10000</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-18-16"><a id="__codelineno-18-16" name="__codelineno-18-16" href="#__codelineno-18-16"></a><span class="w"> </span><span class="mi">16</span><span class="w">         </span><span class="n">printu</span><span class="p">(</span><span class="s">&quot;Child running %ld </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>
</span><span id="__span-18-17"><a id="__codelineno-18-17" name="__codelineno-18-17" href="#__codelineno-18-17"></a><span class="w"> </span><span class="mi">17</span><span class="w">         </span><span class="n">yield</span><span class="p">();</span>
</span><span id="__span-18-18"><a id="__codelineno-18-18" name="__codelineno-18-18" href="#__codelineno-18-18"></a><span class="w"> </span><span class="mi">18</span><span class="w">       </span><span class="p">}</span>
</span><span id="__span-18-19"><a id="__codelineno-18-19" name="__codelineno-18-19" href="#__codelineno-18-19"></a><span class="w"> </span><span class="mi">19</span><span class="w">     </span><span class="p">}</span>
</span><span id="__span-18-20"><a id="__codelineno-18-20" name="__codelineno-18-20" href="#__codelineno-18-20"></a><span class="w"> </span><span class="mi">20</span><span class="w">   </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-18-21"><a id="__codelineno-18-21" name="__codelineno-18-21" href="#__codelineno-18-21"></a><span class="w"> </span><span class="mi">21</span><span class="w">     </span><span class="n">printu</span><span class="p">(</span><span class="s">&quot;Parent: Hello world! </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-18-22"><a id="__codelineno-18-22" name="__codelineno-18-22" href="#__codelineno-18-22"></a><span class="w"> </span><span class="mi">22</span><span class="w">     </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint64</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">rounds</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-18-23"><a id="__codelineno-18-23" name="__codelineno-18-23" href="#__codelineno-18-23"></a><span class="w"> </span><span class="mi">23</span><span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">10000</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-18-24"><a id="__codelineno-18-24" name="__codelineno-18-24" href="#__codelineno-18-24"></a><span class="w"> </span><span class="mi">24</span><span class="w">         </span><span class="n">printu</span><span class="p">(</span><span class="s">&quot;Parent running %ld </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>
</span><span id="__span-18-25"><a id="__codelineno-18-25" name="__codelineno-18-25" href="#__codelineno-18-25"></a><span class="w"> </span><span class="mi">25</span><span class="w">         </span><span class="n">yield</span><span class="p">();</span>
</span><span id="__span-18-26"><a id="__codelineno-18-26" name="__codelineno-18-26" href="#__codelineno-18-26"></a><span class="w"> </span><span class="mi">26</span><span class="w">       </span><span class="p">}</span>
</span><span id="__span-18-27"><a id="__codelineno-18-27" name="__codelineno-18-27" href="#__codelineno-18-27"></a><span class="w"> </span><span class="mi">27</span><span class="w">     </span><span class="p">}</span>
</span><span id="__span-18-28"><a id="__codelineno-18-28" name="__codelineno-18-28" href="#__codelineno-18-28"></a><span class="w"> </span><span class="mi">28</span><span class="w">   </span><span class="p">}</span>
</span><span id="__span-18-29"><a id="__codelineno-18-29" name="__codelineno-18-29" href="#__codelineno-18-29"></a><span class="w"> </span><span class="mi">29</span>
</span><span id="__span-18-30"><a id="__codelineno-18-30" name="__codelineno-18-30" href="#__codelineno-18-30"></a><span class="w"> </span><span class="mi">30</span><span class="w">   </span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-18-31"><a id="__codelineno-18-31" name="__codelineno-18-31" href="#__codelineno-18-31"></a><span class="w"> </span><span class="mi">31</span><span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-18-32"><a id="__codelineno-18-32" name="__codelineno-18-32" href="#__codelineno-18-32"></a><span class="w"> </span><span class="mi">32</span><span class="w"> </span><span class="p">}</span>
</span></code></pre></div>
<p>和lab3_1一样，以上的应用程序通过fork系统调用创建了一个子进程，接下来，父进程和子进程都进入了一个很长的循环。在循环中，无论是父进程还是子进程，在循环的次数是10000的整数倍时，除了打印信息外都调用了yield()函数，来释放自己的执行权（即CPU）。</p>
<ul>
<li>（先提交lab3_1的答案，然后）切换到lab3_2，继承lab3_1及之前实验所做的修改，并make后的直接运行结果：</li>
</ul>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a>//切换到lab3_2
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a>$<span class="w"> </span>git<span class="w"> </span>checkout<span class="w"> </span>lab3_2_yield
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a>
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a>//继承lab3_1以及之前的答案
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a>$<span class="w"> </span>git<span class="w"> </span>merge<span class="w"> </span>lab3_1_fork<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;continue to work on lab3_2&quot;</span>
</span><span id="__span-19-6"><a id="__codelineno-19-6" name="__codelineno-19-6" href="#__codelineno-19-6"></a>
</span><span id="__span-19-7"><a id="__codelineno-19-7" name="__codelineno-19-7" href="#__codelineno-19-7"></a>//重新构造
</span><span id="__span-19-8"><a id="__codelineno-19-8" name="__codelineno-19-8" href="#__codelineno-19-8"></a>$<span class="w"> </span>make<span class="w"> </span>clean<span class="p">;</span><span class="w"> </span>make
</span><span id="__span-19-9"><a id="__codelineno-19-9" name="__codelineno-19-9" href="#__codelineno-19-9"></a>
</span><span id="__span-19-10"><a id="__codelineno-19-10" name="__codelineno-19-10" href="#__codelineno-19-10"></a>//运行构造结果
</span><span id="__span-19-11"><a id="__codelineno-19-11" name="__codelineno-19-11" href="#__codelineno-19-11"></a>$<span class="w"> </span>spike<span class="w"> </span>./obj/riscv-pke<span class="w"> </span>./obj/app_yield
</span><span id="__span-19-12"><a id="__codelineno-19-12" name="__codelineno-19-12" href="#__codelineno-19-12"></a>In<span class="w"> </span>m_start,<span class="w"> </span>hartid:0
</span><span id="__span-19-13"><a id="__codelineno-19-13" name="__codelineno-19-13" href="#__codelineno-19-13"></a>HTIF<span class="w"> </span>is<span class="w"> </span>available!
</span><span id="__span-19-14"><a id="__codelineno-19-14" name="__codelineno-19-14" href="#__codelineno-19-14"></a><span class="o">(</span>Emulated<span class="o">)</span><span class="w"> </span>memory<span class="w"> </span>size:<span class="w"> </span><span class="m">2048</span><span class="w"> </span>MB
</span><span id="__span-19-15"><a id="__codelineno-19-15" name="__codelineno-19-15" href="#__codelineno-19-15"></a>Enter<span class="w"> </span>supervisor<span class="w"> </span>mode...
</span><span id="__span-19-16"><a id="__codelineno-19-16" name="__codelineno-19-16" href="#__codelineno-19-16"></a>PKE<span class="w"> </span>kernel<span class="w"> </span>start<span class="w"> </span>0x0000000080000000,<span class="w"> </span>PKE<span class="w"> </span>kernel<span class="w"> </span>end:<span class="w"> </span>0x0000000080010000,<span class="w"> </span>PKE<span class="w"> </span>kernel<span class="w"> </span>size:<span class="w"> </span>0x0000000000010000<span class="w"> </span>.
</span><span id="__span-19-17"><a id="__codelineno-19-17" name="__codelineno-19-17" href="#__codelineno-19-17"></a>free<span class="w"> </span>physical<span class="w"> </span>memory<span class="w"> </span>address:<span class="w"> </span><span class="o">[</span>0x0000000080010000,<span class="w"> </span>0x0000000087ffffff<span class="o">]</span>
</span><span id="__span-19-18"><a id="__codelineno-19-18" name="__codelineno-19-18" href="#__codelineno-19-18"></a>kernel<span class="w"> </span>memory<span class="w"> </span>manager<span class="w"> </span>is<span class="w"> </span>initializing<span class="w"> </span>...
</span><span id="__span-19-19"><a id="__codelineno-19-19" name="__codelineno-19-19" href="#__codelineno-19-19"></a>KERN_BASE<span class="w"> </span>0x0000000080000000
</span><span id="__span-19-20"><a id="__codelineno-19-20" name="__codelineno-19-20" href="#__codelineno-19-20"></a>physical<span class="w"> </span>address<span class="w"> </span>of<span class="w"> </span>_etext<span class="w"> </span>is:<span class="w"> </span>0x0000000080005000
</span><span id="__span-19-21"><a id="__codelineno-19-21" name="__codelineno-19-21" href="#__codelineno-19-21"></a>kernel<span class="w"> </span>page<span class="w"> </span>table<span class="w"> </span>is<span class="w"> </span>on
</span><span id="__span-19-22"><a id="__codelineno-19-22" name="__codelineno-19-22" href="#__codelineno-19-22"></a>Switching<span class="w"> </span>to<span class="w"> </span>user<span class="w"> </span>mode...
</span><span id="__span-19-23"><a id="__codelineno-19-23" name="__codelineno-19-23" href="#__codelineno-19-23"></a><span class="k">in</span><span class="w"> </span>alloc_proc.<span class="w"> </span>user<span class="w"> </span>frame<span class="w"> </span>0x0000000087fbc000,<span class="w"> </span>user<span class="w"> </span>stack<span class="w"> </span>0x000000007ffff000,<span class="w"> </span>user<span class="w"> </span>kstack<span class="w"> </span>0x0000000087fbb000
</span><span id="__span-19-24"><a id="__codelineno-19-24" name="__codelineno-19-24" href="#__codelineno-19-24"></a>User<span class="w"> </span>application<span class="w"> </span>is<span class="w"> </span>loading.
</span><span id="__span-19-25"><a id="__codelineno-19-25" name="__codelineno-19-25" href="#__codelineno-19-25"></a>Application:<span class="w"> </span>./obj/app_yield
</span><span id="__span-19-26"><a id="__codelineno-19-26" name="__codelineno-19-26" href="#__codelineno-19-26"></a>CODE_SEGMENT<span class="w"> </span>added<span class="w"> </span>at<span class="w"> </span>mapped<span class="w"> </span>info<span class="w"> </span>offset:3
</span><span id="__span-19-27"><a id="__codelineno-19-27" name="__codelineno-19-27" href="#__codelineno-19-27"></a>Application<span class="w"> </span>program<span class="w"> </span>entry<span class="w"> </span>point<span class="w"> </span><span class="o">(</span>virtual<span class="w"> </span>address<span class="o">)</span>:<span class="w"> </span>0x000000000001017c
</span><span id="__span-19-28"><a id="__codelineno-19-28" name="__codelineno-19-28" href="#__codelineno-19-28"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">0</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-19-29"><a id="__codelineno-19-29" name="__codelineno-19-29" href="#__codelineno-19-29"></a>going<span class="w"> </span>to<span class="w"> </span>schedule<span class="w"> </span>process<span class="w"> </span><span class="m">0</span><span class="w"> </span>to<span class="w"> </span>run.
</span><span id="__span-19-30"><a id="__codelineno-19-30" name="__codelineno-19-30" href="#__codelineno-19-30"></a>User<span class="w"> </span>call<span class="w"> </span>fork.
</span><span id="__span-19-31"><a id="__codelineno-19-31" name="__codelineno-19-31" href="#__codelineno-19-31"></a>will<span class="w"> </span>fork<span class="w"> </span>a<span class="w"> </span>child<span class="w"> </span>from<span class="w"> </span>parent<span class="w"> </span><span class="m">0</span>.
</span><span id="__span-19-32"><a id="__codelineno-19-32" name="__codelineno-19-32" href="#__codelineno-19-32"></a><span class="k">in</span><span class="w"> </span>alloc_proc.<span class="w"> </span>user<span class="w"> </span>frame<span class="w"> </span>0x0000000087faf000,<span class="w"> </span>user<span class="w"> </span>stack<span class="w"> </span>0x000000007ffff000,<span class="w"> </span>user<span class="w"> </span>kstack<span class="w"> </span>0x0000000087fae000
</span><span id="__span-19-33"><a id="__codelineno-19-33" name="__codelineno-19-33" href="#__codelineno-19-33"></a>do_fork<span class="w"> </span>map<span class="w"> </span>code<span class="w"> </span>segment<span class="w"> </span>at<span class="w"> </span>pa:0000000087fb2000<span class="w"> </span>of<span class="w"> </span>parent<span class="w"> </span>to<span class="w"> </span>child<span class="w"> </span>at<span class="w"> </span>va:0000000000010000.
</span><span id="__span-19-34"><a id="__codelineno-19-34" name="__codelineno-19-34" href="#__codelineno-19-34"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">1</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-19-35"><a id="__codelineno-19-35" name="__codelineno-19-35" href="#__codelineno-19-35"></a>Parent:<span class="w"> </span>Hello<span class="w"> </span>world!
</span><span id="__span-19-36"><a id="__codelineno-19-36" name="__codelineno-19-36" href="#__codelineno-19-36"></a>Parent<span class="w"> </span>running<span class="w"> </span><span class="m">0</span>
</span><span id="__span-19-37"><a id="__codelineno-19-37" name="__codelineno-19-37" href="#__codelineno-19-37"></a>You<span class="w"> </span>need<span class="w"> </span>to<span class="w"> </span>implement<span class="w"> </span>the<span class="w"> </span>yield<span class="w"> </span>syscall<span class="w"> </span><span class="k">in</span><span class="w"> </span>lab3_2.
</span><span id="__span-19-38"><a id="__codelineno-19-38" name="__codelineno-19-38" href="#__codelineno-19-38"></a>
</span><span id="__span-19-39"><a id="__codelineno-19-39" name="__codelineno-19-39" href="#__codelineno-19-39"></a>System<span class="w"> </span>is<span class="w"> </span>shutting<span class="w"> </span>down<span class="w"> </span>with<span class="w"> </span><span class="nb">exit</span><span class="w"> </span>code<span class="w"> </span>-1.
</span></code></pre></div>
<p>从以上输出来看，还是因为PKE操作系统中的yield()功能未完善，导致应用无法正常执行下去。</p>
<p><a name="lab3_2_content"></a></p>
<h4 id="_6"><strong>实验内容</strong></h4>
<p>完善yield系统调用，实现进程执行过程中的主动释放CPU的动作。实验完成后，获得以下预期结果：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-20-1"><a id="__codelineno-20-1" name="__codelineno-20-1" href="#__codelineno-20-1"></a>$<span class="w"> </span>spike<span class="w"> </span>./obj/riscv-pke<span class="w"> </span>./obj/app_yield
</span><span id="__span-20-2"><a id="__codelineno-20-2" name="__codelineno-20-2" href="#__codelineno-20-2"></a>In<span class="w"> </span>m_start,<span class="w"> </span>hartid:0
</span><span id="__span-20-3"><a id="__codelineno-20-3" name="__codelineno-20-3" href="#__codelineno-20-3"></a>HTIF<span class="w"> </span>is<span class="w"> </span>available!
</span><span id="__span-20-4"><a id="__codelineno-20-4" name="__codelineno-20-4" href="#__codelineno-20-4"></a><span class="o">(</span>Emulated<span class="o">)</span><span class="w"> </span>memory<span class="w"> </span>size:<span class="w"> </span><span class="m">2048</span><span class="w"> </span>MB
</span><span id="__span-20-5"><a id="__codelineno-20-5" name="__codelineno-20-5" href="#__codelineno-20-5"></a>Enter<span class="w"> </span>supervisor<span class="w"> </span>mode...
</span><span id="__span-20-6"><a id="__codelineno-20-6" name="__codelineno-20-6" href="#__codelineno-20-6"></a>PKE<span class="w"> </span>kernel<span class="w"> </span>start<span class="w"> </span>0x0000000080000000,<span class="w"> </span>PKE<span class="w"> </span>kernel<span class="w"> </span>end:<span class="w"> </span>0x0000000080010000,<span class="w"> </span>PKE<span class="w"> </span>kernel<span class="w"> </span>size:<span class="w"> </span>0x0000000000010000<span class="w"> </span>.
</span><span id="__span-20-7"><a id="__codelineno-20-7" name="__codelineno-20-7" href="#__codelineno-20-7"></a>free<span class="w"> </span>physical<span class="w"> </span>memory<span class="w"> </span>address:<span class="w"> </span><span class="o">[</span>0x0000000080010000,<span class="w"> </span>0x0000000087ffffff<span class="o">]</span>
</span><span id="__span-20-8"><a id="__codelineno-20-8" name="__codelineno-20-8" href="#__codelineno-20-8"></a>kernel<span class="w"> </span>memory<span class="w"> </span>manager<span class="w"> </span>is<span class="w"> </span>initializing<span class="w"> </span>...
</span><span id="__span-20-9"><a id="__codelineno-20-9" name="__codelineno-20-9" href="#__codelineno-20-9"></a>KERN_BASE<span class="w"> </span>0x0000000080000000
</span><span id="__span-20-10"><a id="__codelineno-20-10" name="__codelineno-20-10" href="#__codelineno-20-10"></a>physical<span class="w"> </span>address<span class="w"> </span>of<span class="w"> </span>_etext<span class="w"> </span>is:<span class="w"> </span>0x0000000080005000
</span><span id="__span-20-11"><a id="__codelineno-20-11" name="__codelineno-20-11" href="#__codelineno-20-11"></a>kernel<span class="w"> </span>page<span class="w"> </span>table<span class="w"> </span>is<span class="w"> </span>on
</span><span id="__span-20-12"><a id="__codelineno-20-12" name="__codelineno-20-12" href="#__codelineno-20-12"></a>Switching<span class="w"> </span>to<span class="w"> </span>user<span class="w"> </span>mode...
</span><span id="__span-20-13"><a id="__codelineno-20-13" name="__codelineno-20-13" href="#__codelineno-20-13"></a><span class="k">in</span><span class="w"> </span>alloc_proc.<span class="w"> </span>user<span class="w"> </span>frame<span class="w"> </span>0x0000000087fbc000,<span class="w"> </span>user<span class="w"> </span>stack<span class="w"> </span>0x000000007ffff000,<span class="w"> </span>user<span class="w"> </span>kstack<span class="w"> </span>0x0000000087fbb000
</span><span id="__span-20-14"><a id="__codelineno-20-14" name="__codelineno-20-14" href="#__codelineno-20-14"></a>User<span class="w"> </span>application<span class="w"> </span>is<span class="w"> </span>loading.
</span><span id="__span-20-15"><a id="__codelineno-20-15" name="__codelineno-20-15" href="#__codelineno-20-15"></a>Application:<span class="w"> </span>./obj/app_yield
</span><span id="__span-20-16"><a id="__codelineno-20-16" name="__codelineno-20-16" href="#__codelineno-20-16"></a>CODE_SEGMENT<span class="w"> </span>added<span class="w"> </span>at<span class="w"> </span>mapped<span class="w"> </span>info<span class="w"> </span>offset:3
</span><span id="__span-20-17"><a id="__codelineno-20-17" name="__codelineno-20-17" href="#__codelineno-20-17"></a>Application<span class="w"> </span>program<span class="w"> </span>entry<span class="w"> </span>point<span class="w"> </span><span class="o">(</span>virtual<span class="w"> </span>address<span class="o">)</span>:<span class="w"> </span>0x000000000001017c
</span><span id="__span-20-18"><a id="__codelineno-20-18" name="__codelineno-20-18" href="#__codelineno-20-18"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">0</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-20-19"><a id="__codelineno-20-19" name="__codelineno-20-19" href="#__codelineno-20-19"></a>going<span class="w"> </span>to<span class="w"> </span>schedule<span class="w"> </span>process<span class="w"> </span><span class="m">0</span><span class="w"> </span>to<span class="w"> </span>run.
</span><span id="__span-20-20"><a id="__codelineno-20-20" name="__codelineno-20-20" href="#__codelineno-20-20"></a>User<span class="w"> </span>call<span class="w"> </span>fork.
</span><span id="__span-20-21"><a id="__codelineno-20-21" name="__codelineno-20-21" href="#__codelineno-20-21"></a>will<span class="w"> </span>fork<span class="w"> </span>a<span class="w"> </span>child<span class="w"> </span>from<span class="w"> </span>parent<span class="w"> </span><span class="m">0</span>.
</span><span id="__span-20-22"><a id="__codelineno-20-22" name="__codelineno-20-22" href="#__codelineno-20-22"></a><span class="k">in</span><span class="w"> </span>alloc_proc.<span class="w"> </span>user<span class="w"> </span>frame<span class="w"> </span>0x0000000087faf000,<span class="w"> </span>user<span class="w"> </span>stack<span class="w"> </span>0x000000007ffff000,<span class="w"> </span>user<span class="w"> </span>kstack<span class="w"> </span>0x0000000087fae000
</span><span id="__span-20-23"><a id="__codelineno-20-23" name="__codelineno-20-23" href="#__codelineno-20-23"></a>do_fork<span class="w"> </span>map<span class="w"> </span>code<span class="w"> </span>segment<span class="w"> </span>at<span class="w"> </span>pa:0000000087fb2000<span class="w"> </span>of<span class="w"> </span>parent<span class="w"> </span>to<span class="w"> </span>child<span class="w"> </span>at<span class="w"> </span>va:0000000000010000.
</span><span id="__span-20-24"><a id="__codelineno-20-24" name="__codelineno-20-24" href="#__codelineno-20-24"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">1</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-20-25"><a id="__codelineno-20-25" name="__codelineno-20-25" href="#__codelineno-20-25"></a>Parent:<span class="w"> </span>Hello<span class="w"> </span>world!
</span><span id="__span-20-26"><a id="__codelineno-20-26" name="__codelineno-20-26" href="#__codelineno-20-26"></a>Parent<span class="w"> </span>running<span class="w"> </span><span class="m">0</span>
</span><span id="__span-20-27"><a id="__codelineno-20-27" name="__codelineno-20-27" href="#__codelineno-20-27"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">0</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-20-28"><a id="__codelineno-20-28" name="__codelineno-20-28" href="#__codelineno-20-28"></a>going<span class="w"> </span>to<span class="w"> </span>schedule<span class="w"> </span>process<span class="w"> </span><span class="m">1</span><span class="w"> </span>to<span class="w"> </span>run.
</span><span id="__span-20-29"><a id="__codelineno-20-29" name="__codelineno-20-29" href="#__codelineno-20-29"></a>Child:<span class="w"> </span>Hello<span class="w"> </span>world!
</span><span id="__span-20-30"><a id="__codelineno-20-30" name="__codelineno-20-30" href="#__codelineno-20-30"></a>Child<span class="w"> </span>running<span class="w"> </span><span class="m">0</span>
</span><span id="__span-20-31"><a id="__codelineno-20-31" name="__codelineno-20-31" href="#__codelineno-20-31"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">1</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-20-32"><a id="__codelineno-20-32" name="__codelineno-20-32" href="#__codelineno-20-32"></a>going<span class="w"> </span>to<span class="w"> </span>schedule<span class="w"> </span>process<span class="w"> </span><span class="m">0</span><span class="w"> </span>to<span class="w"> </span>run.
</span><span id="__span-20-33"><a id="__codelineno-20-33" name="__codelineno-20-33" href="#__codelineno-20-33"></a>Parent<span class="w"> </span>running<span class="w"> </span><span class="m">10000</span>
</span><span id="__span-20-34"><a id="__codelineno-20-34" name="__codelineno-20-34" href="#__codelineno-20-34"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">0</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-20-35"><a id="__codelineno-20-35" name="__codelineno-20-35" href="#__codelineno-20-35"></a>going<span class="w"> </span>to<span class="w"> </span>schedule<span class="w"> </span>process<span class="w"> </span><span class="m">1</span><span class="w"> </span>to<span class="w"> </span>run.
</span><span id="__span-20-36"><a id="__codelineno-20-36" name="__codelineno-20-36" href="#__codelineno-20-36"></a>Child<span class="w"> </span>running<span class="w"> </span><span class="m">10000</span>
</span><span id="__span-20-37"><a id="__codelineno-20-37" name="__codelineno-20-37" href="#__codelineno-20-37"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">1</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-20-38"><a id="__codelineno-20-38" name="__codelineno-20-38" href="#__codelineno-20-38"></a>going<span class="w"> </span>to<span class="w"> </span>schedule<span class="w"> </span>process<span class="w"> </span><span class="m">0</span><span class="w"> </span>to<span class="w"> </span>run.
</span><span id="__span-20-39"><a id="__codelineno-20-39" name="__codelineno-20-39" href="#__codelineno-20-39"></a>Parent<span class="w"> </span>running<span class="w"> </span><span class="m">20000</span>
</span><span id="__span-20-40"><a id="__codelineno-20-40" name="__codelineno-20-40" href="#__codelineno-20-40"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">0</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-20-41"><a id="__codelineno-20-41" name="__codelineno-20-41" href="#__codelineno-20-41"></a>going<span class="w"> </span>to<span class="w"> </span>schedule<span class="w"> </span>process<span class="w"> </span><span class="m">1</span><span class="w"> </span>to<span class="w"> </span>run.
</span><span id="__span-20-42"><a id="__codelineno-20-42" name="__codelineno-20-42" href="#__codelineno-20-42"></a>Child<span class="w"> </span>running<span class="w"> </span><span class="m">20000</span>
</span><span id="__span-20-43"><a id="__codelineno-20-43" name="__codelineno-20-43" href="#__codelineno-20-43"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">1</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-20-44"><a id="__codelineno-20-44" name="__codelineno-20-44" href="#__codelineno-20-44"></a>going<span class="w"> </span>to<span class="w"> </span>schedule<span class="w"> </span>process<span class="w"> </span><span class="m">0</span><span class="w"> </span>to<span class="w"> </span>run.
</span><span id="__span-20-45"><a id="__codelineno-20-45" name="__codelineno-20-45" href="#__codelineno-20-45"></a>Parent<span class="w"> </span>running<span class="w"> </span><span class="m">30000</span>
</span><span id="__span-20-46"><a id="__codelineno-20-46" name="__codelineno-20-46" href="#__codelineno-20-46"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">0</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-20-47"><a id="__codelineno-20-47" name="__codelineno-20-47" href="#__codelineno-20-47"></a>going<span class="w"> </span>to<span class="w"> </span>schedule<span class="w"> </span>process<span class="w"> </span><span class="m">1</span><span class="w"> </span>to<span class="w"> </span>run.
</span><span id="__span-20-48"><a id="__codelineno-20-48" name="__codelineno-20-48" href="#__codelineno-20-48"></a>Child<span class="w"> </span>running<span class="w"> </span><span class="m">30000</span>
</span><span id="__span-20-49"><a id="__codelineno-20-49" name="__codelineno-20-49" href="#__codelineno-20-49"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">1</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-20-50"><a id="__codelineno-20-50" name="__codelineno-20-50" href="#__codelineno-20-50"></a>going<span class="w"> </span>to<span class="w"> </span>schedule<span class="w"> </span>process<span class="w"> </span><span class="m">0</span><span class="w"> </span>to<span class="w"> </span>run.
</span><span id="__span-20-51"><a id="__codelineno-20-51" name="__codelineno-20-51" href="#__codelineno-20-51"></a>Parent<span class="w"> </span>running<span class="w"> </span><span class="m">40000</span>
</span><span id="__span-20-52"><a id="__codelineno-20-52" name="__codelineno-20-52" href="#__codelineno-20-52"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">0</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-20-53"><a id="__codelineno-20-53" name="__codelineno-20-53" href="#__codelineno-20-53"></a>going<span class="w"> </span>to<span class="w"> </span>schedule<span class="w"> </span>process<span class="w"> </span><span class="m">1</span><span class="w"> </span>to<span class="w"> </span>run.
</span><span id="__span-20-54"><a id="__codelineno-20-54" name="__codelineno-20-54" href="#__codelineno-20-54"></a>Child<span class="w"> </span>running<span class="w"> </span><span class="m">40000</span>
</span><span id="__span-20-55"><a id="__codelineno-20-55" name="__codelineno-20-55" href="#__codelineno-20-55"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">1</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-20-56"><a id="__codelineno-20-56" name="__codelineno-20-56" href="#__codelineno-20-56"></a>going<span class="w"> </span>to<span class="w"> </span>schedule<span class="w"> </span>process<span class="w"> </span><span class="m">0</span><span class="w"> </span>to<span class="w"> </span>run.
</span><span id="__span-20-57"><a id="__codelineno-20-57" name="__codelineno-20-57" href="#__codelineno-20-57"></a>Parent<span class="w"> </span>running<span class="w"> </span><span class="m">50000</span>
</span><span id="__span-20-58"><a id="__codelineno-20-58" name="__codelineno-20-58" href="#__codelineno-20-58"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">0</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-20-59"><a id="__codelineno-20-59" name="__codelineno-20-59" href="#__codelineno-20-59"></a>going<span class="w"> </span>to<span class="w"> </span>schedule<span class="w"> </span>process<span class="w"> </span><span class="m">1</span><span class="w"> </span>to<span class="w"> </span>run.
</span><span id="__span-20-60"><a id="__codelineno-20-60" name="__codelineno-20-60" href="#__codelineno-20-60"></a>Child<span class="w"> </span>running<span class="w"> </span><span class="m">50000</span>
</span><span id="__span-20-61"><a id="__codelineno-20-61" name="__codelineno-20-61" href="#__codelineno-20-61"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">1</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-20-62"><a id="__codelineno-20-62" name="__codelineno-20-62" href="#__codelineno-20-62"></a>going<span class="w"> </span>to<span class="w"> </span>schedule<span class="w"> </span>process<span class="w"> </span><span class="m">0</span><span class="w"> </span>to<span class="w"> </span>run.
</span><span id="__span-20-63"><a id="__codelineno-20-63" name="__codelineno-20-63" href="#__codelineno-20-63"></a>Parent<span class="w"> </span>running<span class="w"> </span><span class="m">60000</span>
</span><span id="__span-20-64"><a id="__codelineno-20-64" name="__codelineno-20-64" href="#__codelineno-20-64"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">0</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-20-65"><a id="__codelineno-20-65" name="__codelineno-20-65" href="#__codelineno-20-65"></a>going<span class="w"> </span>to<span class="w"> </span>schedule<span class="w"> </span>process<span class="w"> </span><span class="m">1</span><span class="w"> </span>to<span class="w"> </span>run.
</span><span id="__span-20-66"><a id="__codelineno-20-66" name="__codelineno-20-66" href="#__codelineno-20-66"></a>Child<span class="w"> </span>running<span class="w"> </span><span class="m">60000</span>
</span><span id="__span-20-67"><a id="__codelineno-20-67" name="__codelineno-20-67" href="#__codelineno-20-67"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">1</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-20-68"><a id="__codelineno-20-68" name="__codelineno-20-68" href="#__codelineno-20-68"></a>going<span class="w"> </span>to<span class="w"> </span>schedule<span class="w"> </span>process<span class="w"> </span><span class="m">0</span><span class="w"> </span>to<span class="w"> </span>run.
</span><span id="__span-20-69"><a id="__codelineno-20-69" name="__codelineno-20-69" href="#__codelineno-20-69"></a>User<span class="w"> </span><span class="nb">exit</span><span class="w"> </span>with<span class="w"> </span>code:0.
</span><span id="__span-20-70"><a id="__codelineno-20-70" name="__codelineno-20-70" href="#__codelineno-20-70"></a>going<span class="w"> </span>to<span class="w"> </span>schedule<span class="w"> </span>process<span class="w"> </span><span class="m">1</span><span class="w"> </span>to<span class="w"> </span>run.
</span><span id="__span-20-71"><a id="__codelineno-20-71" name="__codelineno-20-71" href="#__codelineno-20-71"></a>User<span class="w"> </span><span class="nb">exit</span><span class="w"> </span>with<span class="w"> </span>code:0.
</span><span id="__span-20-72"><a id="__codelineno-20-72" name="__codelineno-20-72" href="#__codelineno-20-72"></a>no<span class="w"> </span>more<span class="w"> </span>ready<span class="w"> </span>processes,<span class="w"> </span>system<span class="w"> </span>shutdown<span class="w"> </span>now.
</span><span id="__span-20-73"><a id="__codelineno-20-73" name="__codelineno-20-73" href="#__codelineno-20-73"></a>System<span class="w"> </span>is<span class="w"> </span>shutting<span class="w"> </span>down<span class="w"> </span>with<span class="w"> </span><span class="nb">exit</span><span class="w"> </span>code<span class="w"> </span><span class="m">0</span>.
</span></code></pre></div>
<p><a name="lab3_2_guide"></a></p>
<h4 id="_7"><strong>实验指导</strong></h4>
<p>进程释放CPU的动作应该是：</p>
<ul>
<li>将当前进程置为就绪状态（READY）；</li>
<li>将当前进程加入到就绪队列的队尾；</li>
<li>转进程调度。</li>
</ul>
<p><strong>实验完毕后，记得提交修改（命令行中-m后的字符串可自行确定），以便在后续实验中继承lab3_2中所做的工作</strong>：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-21-1"><a id="__codelineno-21-1" name="__codelineno-21-1" href="#__codelineno-21-1"></a>$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>-a<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;my work on lab3_2 is done.&quot;</span>
</span></code></pre></div>
<p><a name="lab3_3_rrsched"></a></p>
<h2 id="54-lab3_3">5.4 lab3_3 循环轮转调度</h2>
<p><a name="lab3_3_app"></a></p>
<h4 id="_8"><strong>给定应用</strong></h4>
<div class="language-C highlight"><pre><span></span><code><span id="__span-22-1"><a id="__codelineno-22-1" name="__codelineno-22-1" href="#__codelineno-22-1"></a><span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="cm">/*</span>
</span><span id="__span-22-2"><a id="__codelineno-22-2" name="__codelineno-22-2" href="#__codelineno-22-2"></a><span class="cm">  2  * The application of lab3_3.</span>
</span><span id="__span-22-3"><a id="__codelineno-22-3" name="__codelineno-22-3" href="#__codelineno-22-3"></a><span class="cm">  3  * parent and child processes never give up their processor during execution.</span>
</span><span id="__span-22-4"><a id="__codelineno-22-4" name="__codelineno-22-4" href="#__codelineno-22-4"></a><span class="cm">  4  */</span>
</span><span id="__span-22-5"><a id="__codelineno-22-5" name="__codelineno-22-5" href="#__codelineno-22-5"></a><span class="w">  </span><span class="mi">5</span>
</span><span id="__span-22-6"><a id="__codelineno-22-6" name="__codelineno-22-6" href="#__codelineno-22-6"></a><span class="w">  </span><span class="mi">6</span><span class="w"> </span><span class="err">#</span><span class="n">include</span><span class="w"> </span><span class="s">&quot;user/user_lib.h&quot;</span>
</span><span id="__span-22-7"><a id="__codelineno-22-7" name="__codelineno-22-7" href="#__codelineno-22-7"></a><span class="w">  </span><span class="mi">7</span><span class="w"> </span><span class="err">#</span><span class="n">include</span><span class="w"> </span><span class="s">&quot;util/types.h&quot;</span>
</span><span id="__span-22-8"><a id="__codelineno-22-8" name="__codelineno-22-8" href="#__codelineno-22-8"></a><span class="w">  </span><span class="mi">8</span>
</span><span id="__span-22-9"><a id="__codelineno-22-9" name="__codelineno-22-9" href="#__codelineno-22-9"></a><span class="w">  </span><span class="mi">9</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-22-10"><a id="__codelineno-22-10" name="__codelineno-22-10" href="#__codelineno-22-10"></a><span class="w"> </span><span class="mi">10</span><span class="w">   </span><span class="n">uint64</span><span class="w"> </span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fork</span><span class="p">();</span>
</span><span id="__span-22-11"><a id="__codelineno-22-11" name="__codelineno-22-11" href="#__codelineno-22-11"></a><span class="w"> </span><span class="mi">11</span><span class="w">   </span><span class="n">uint64</span><span class="w"> </span><span class="n">rounds</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">100000000</span><span class="p">;</span>
</span><span id="__span-22-12"><a id="__codelineno-22-12" name="__codelineno-22-12" href="#__codelineno-22-12"></a><span class="w"> </span><span class="mi">12</span><span class="w">   </span><span class="n">uint64</span><span class="w"> </span><span class="n">interval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">10000000</span><span class="p">;</span>
</span><span id="__span-22-13"><a id="__codelineno-22-13" name="__codelineno-22-13" href="#__codelineno-22-13"></a><span class="w"> </span><span class="mi">13</span><span class="w">   </span><span class="n">uint64</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-22-14"><a id="__codelineno-22-14" name="__codelineno-22-14" href="#__codelineno-22-14"></a><span class="w"> </span><span class="mi">14</span><span class="w">   </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-22-15"><a id="__codelineno-22-15" name="__codelineno-22-15" href="#__codelineno-22-15"></a><span class="w"> </span><span class="mi">15</span><span class="w">     </span><span class="n">printu</span><span class="p">(</span><span class="s">&quot;Child: Hello world! </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-22-16"><a id="__codelineno-22-16" name="__codelineno-22-16" href="#__codelineno-22-16"></a><span class="w"> </span><span class="mi">16</span><span class="w">     </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint64</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">rounds</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-22-17"><a id="__codelineno-22-17" name="__codelineno-22-17" href="#__codelineno-22-17"></a><span class="w"> </span><span class="mi">17</span><span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">interval</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">printu</span><span class="p">(</span><span class="s">&quot;Child running %ld </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>
</span><span id="__span-22-18"><a id="__codelineno-22-18" name="__codelineno-22-18" href="#__codelineno-22-18"></a><span class="w"> </span><span class="mi">18</span><span class="w">     </span><span class="p">}</span>
</span><span id="__span-22-19"><a id="__codelineno-22-19" name="__codelineno-22-19" href="#__codelineno-22-19"></a><span class="w"> </span><span class="mi">19</span><span class="w">   </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-22-20"><a id="__codelineno-22-20" name="__codelineno-22-20" href="#__codelineno-22-20"></a><span class="w"> </span><span class="mi">20</span><span class="w">     </span><span class="n">printu</span><span class="p">(</span><span class="s">&quot;Parent: Hello world! </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
</span><span id="__span-22-21"><a id="__codelineno-22-21" name="__codelineno-22-21" href="#__codelineno-22-21"></a><span class="w"> </span><span class="mi">21</span><span class="w">     </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">uint64</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">rounds</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-22-22"><a id="__codelineno-22-22" name="__codelineno-22-22" href="#__codelineno-22-22"></a><span class="w"> </span><span class="mi">22</span><span class="w">       </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">interval</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">printu</span><span class="p">(</span><span class="s">&quot;Parent running %ld </span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>
</span><span id="__span-22-23"><a id="__codelineno-22-23" name="__codelineno-22-23" href="#__codelineno-22-23"></a><span class="w"> </span><span class="mi">23</span><span class="w">     </span><span class="p">}</span>
</span><span id="__span-22-24"><a id="__codelineno-22-24" name="__codelineno-22-24" href="#__codelineno-22-24"></a><span class="w"> </span><span class="mi">24</span><span class="w">   </span><span class="p">}</span>
</span><span id="__span-22-25"><a id="__codelineno-22-25" name="__codelineno-22-25" href="#__codelineno-22-25"></a><span class="w"> </span><span class="mi">25</span>
</span><span id="__span-22-26"><a id="__codelineno-22-26" name="__codelineno-22-26" href="#__codelineno-22-26"></a><span class="w"> </span><span class="mi">26</span><span class="w">   </span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-22-27"><a id="__codelineno-22-27" name="__codelineno-22-27" href="#__codelineno-22-27"></a><span class="w"> </span><span class="mi">27</span><span class="w">   </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-22-28"><a id="__codelineno-22-28" name="__codelineno-22-28" href="#__codelineno-22-28"></a><span class="w"> </span><span class="mi">28</span><span class="w"> </span><span class="p">}</span>
</span></code></pre></div>
<p>和lab3_2类似，lab3_3给出的应用仍然是父子两个进程，他们的执行体都是两个大循环。但与lab3_2不同的是，这两个进程在执行各自循环体时，都没有主动释放CPU的动作。显然，这样的设计会导致某个进程长期占据CPU，而另一个进程无法得到执行。</p>
<ul>
<li>（先提交lab3_2的答案，然后）切换到lab3_3，继承lab3_2及之前实验所做的修改，并make后的直接运行结果：</li>
</ul>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-23-1"><a id="__codelineno-23-1" name="__codelineno-23-1" href="#__codelineno-23-1"></a>//切换到lab3_3
</span><span id="__span-23-2"><a id="__codelineno-23-2" name="__codelineno-23-2" href="#__codelineno-23-2"></a>$<span class="w"> </span>git<span class="w"> </span>checkout<span class="w"> </span>lab3_3_rrsched
</span><span id="__span-23-3"><a id="__codelineno-23-3" name="__codelineno-23-3" href="#__codelineno-23-3"></a>
</span><span id="__span-23-4"><a id="__codelineno-23-4" name="__codelineno-23-4" href="#__codelineno-23-4"></a>//继承lab3_2以及之前的答案
</span><span id="__span-23-5"><a id="__codelineno-23-5" name="__codelineno-23-5" href="#__codelineno-23-5"></a>$<span class="w"> </span>git<span class="w"> </span>merge<span class="w"> </span>lab3_2_yield<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;continue to work on lab3_3&quot;</span>
</span><span id="__span-23-6"><a id="__codelineno-23-6" name="__codelineno-23-6" href="#__codelineno-23-6"></a>
</span><span id="__span-23-7"><a id="__codelineno-23-7" name="__codelineno-23-7" href="#__codelineno-23-7"></a>//重新构造
</span><span id="__span-23-8"><a id="__codelineno-23-8" name="__codelineno-23-8" href="#__codelineno-23-8"></a>$<span class="w"> </span>make<span class="w"> </span>clean<span class="p">;</span><span class="w"> </span>make
</span><span id="__span-23-9"><a id="__codelineno-23-9" name="__codelineno-23-9" href="#__codelineno-23-9"></a>
</span><span id="__span-23-10"><a id="__codelineno-23-10" name="__codelineno-23-10" href="#__codelineno-23-10"></a>//运行构造结果
</span><span id="__span-23-11"><a id="__codelineno-23-11" name="__codelineno-23-11" href="#__codelineno-23-11"></a>$<span class="w"> </span>spike<span class="w"> </span>./obj/riscv-pke<span class="w"> </span>./obj/app_two_long_loops
</span><span id="__span-23-12"><a id="__codelineno-23-12" name="__codelineno-23-12" href="#__codelineno-23-12"></a>In<span class="w"> </span>m_start,<span class="w"> </span>hartid:0
</span><span id="__span-23-13"><a id="__codelineno-23-13" name="__codelineno-23-13" href="#__codelineno-23-13"></a>HTIF<span class="w"> </span>is<span class="w"> </span>available!
</span><span id="__span-23-14"><a id="__codelineno-23-14" name="__codelineno-23-14" href="#__codelineno-23-14"></a><span class="o">(</span>Emulated<span class="o">)</span><span class="w"> </span>memory<span class="w"> </span>size:<span class="w"> </span><span class="m">2048</span><span class="w"> </span>MB
</span><span id="__span-23-15"><a id="__codelineno-23-15" name="__codelineno-23-15" href="#__codelineno-23-15"></a>Enter<span class="w"> </span>supervisor<span class="w"> </span>mode...
</span><span id="__span-23-16"><a id="__codelineno-23-16" name="__codelineno-23-16" href="#__codelineno-23-16"></a>PKE<span class="w"> </span>kernel<span class="w"> </span>start<span class="w"> </span>0x0000000080000000,<span class="w"> </span>PKE<span class="w"> </span>kernel<span class="w"> </span>end:<span class="w"> </span>0x0000000080010000,<span class="w"> </span>PKE<span class="w"> </span>kernel<span class="w"> </span>size:<span class="w"> </span>0x0000000000010000<span class="w"> </span>.
</span><span id="__span-23-17"><a id="__codelineno-23-17" name="__codelineno-23-17" href="#__codelineno-23-17"></a>free<span class="w"> </span>physical<span class="w"> </span>memory<span class="w"> </span>address:<span class="w"> </span><span class="o">[</span>0x0000000080010000,<span class="w"> </span>0x0000000087ffffff<span class="o">]</span>
</span><span id="__span-23-18"><a id="__codelineno-23-18" name="__codelineno-23-18" href="#__codelineno-23-18"></a>kernel<span class="w"> </span>memory<span class="w"> </span>manager<span class="w"> </span>is<span class="w"> </span>initializing<span class="w"> </span>...
</span><span id="__span-23-19"><a id="__codelineno-23-19" name="__codelineno-23-19" href="#__codelineno-23-19"></a>KERN_BASE<span class="w"> </span>0x0000000080000000
</span><span id="__span-23-20"><a id="__codelineno-23-20" name="__codelineno-23-20" href="#__codelineno-23-20"></a>physical<span class="w"> </span>address<span class="w"> </span>of<span class="w"> </span>_etext<span class="w"> </span>is:<span class="w"> </span>0x0000000080005000
</span><span id="__span-23-21"><a id="__codelineno-23-21" name="__codelineno-23-21" href="#__codelineno-23-21"></a>kernel<span class="w"> </span>page<span class="w"> </span>table<span class="w"> </span>is<span class="w"> </span>on
</span><span id="__span-23-22"><a id="__codelineno-23-22" name="__codelineno-23-22" href="#__codelineno-23-22"></a>Switching<span class="w"> </span>to<span class="w"> </span>user<span class="w"> </span>mode...
</span><span id="__span-23-23"><a id="__codelineno-23-23" name="__codelineno-23-23" href="#__codelineno-23-23"></a><span class="k">in</span><span class="w"> </span>alloc_proc.<span class="w"> </span>user<span class="w"> </span>frame<span class="w"> </span>0x0000000087fbc000,<span class="w"> </span>user<span class="w"> </span>stack<span class="w"> </span>0x000000007ffff000,<span class="w"> </span>user<span class="w"> </span>kstack<span class="w"> </span>0x0000000087fbb000
</span><span id="__span-23-24"><a id="__codelineno-23-24" name="__codelineno-23-24" href="#__codelineno-23-24"></a>User<span class="w"> </span>application<span class="w"> </span>is<span class="w"> </span>loading.
</span><span id="__span-23-25"><a id="__codelineno-23-25" name="__codelineno-23-25" href="#__codelineno-23-25"></a>Application:<span class="w"> </span>./obj/app_two_long_loops
</span><span id="__span-23-26"><a id="__codelineno-23-26" name="__codelineno-23-26" href="#__codelineno-23-26"></a>CODE_SEGMENT<span class="w"> </span>added<span class="w"> </span>at<span class="w"> </span>mapped<span class="w"> </span>info<span class="w"> </span>offset:3
</span><span id="__span-23-27"><a id="__codelineno-23-27" name="__codelineno-23-27" href="#__codelineno-23-27"></a>Application<span class="w"> </span>program<span class="w"> </span>entry<span class="w"> </span>point<span class="w"> </span><span class="o">(</span>virtual<span class="w"> </span>address<span class="o">)</span>:<span class="w"> </span>0x000000000001017c
</span><span id="__span-23-28"><a id="__codelineno-23-28" name="__codelineno-23-28" href="#__codelineno-23-28"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">0</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-23-29"><a id="__codelineno-23-29" name="__codelineno-23-29" href="#__codelineno-23-29"></a>going<span class="w"> </span>to<span class="w"> </span>schedule<span class="w"> </span>process<span class="w"> </span><span class="m">0</span><span class="w"> </span>to<span class="w"> </span>run.
</span><span id="__span-23-30"><a id="__codelineno-23-30" name="__codelineno-23-30" href="#__codelineno-23-30"></a>User<span class="w"> </span>call<span class="w"> </span>fork.
</span><span id="__span-23-31"><a id="__codelineno-23-31" name="__codelineno-23-31" href="#__codelineno-23-31"></a>will<span class="w"> </span>fork<span class="w"> </span>a<span class="w"> </span>child<span class="w"> </span>from<span class="w"> </span>parent<span class="w"> </span><span class="m">0</span>.
</span><span id="__span-23-32"><a id="__codelineno-23-32" name="__codelineno-23-32" href="#__codelineno-23-32"></a><span class="k">in</span><span class="w"> </span>alloc_proc.<span class="w"> </span>user<span class="w"> </span>frame<span class="w"> </span>0x0000000087faf000,<span class="w"> </span>user<span class="w"> </span>stack<span class="w"> </span>0x000000007ffff000,<span class="w"> </span>user<span class="w"> </span>kstack<span class="w"> </span>0x0000000087fae000
</span><span id="__span-23-33"><a id="__codelineno-23-33" name="__codelineno-23-33" href="#__codelineno-23-33"></a>do_fork<span class="w"> </span>map<span class="w"> </span>code<span class="w"> </span>segment<span class="w"> </span>at<span class="w"> </span>pa:0000000087fb2000<span class="w"> </span>of<span class="w"> </span>parent<span class="w"> </span>to<span class="w"> </span>child<span class="w"> </span>at<span class="w"> </span>va:0000000000010000.
</span><span id="__span-23-34"><a id="__codelineno-23-34" name="__codelineno-23-34" href="#__codelineno-23-34"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">1</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-23-35"><a id="__codelineno-23-35" name="__codelineno-23-35" href="#__codelineno-23-35"></a>Parent:<span class="w"> </span>Hello<span class="w"> </span>world!
</span><span id="__span-23-36"><a id="__codelineno-23-36" name="__codelineno-23-36" href="#__codelineno-23-36"></a>Parent<span class="w"> </span>running<span class="w"> </span><span class="m">0</span>
</span><span id="__span-23-37"><a id="__codelineno-23-37" name="__codelineno-23-37" href="#__codelineno-23-37"></a>Parent<span class="w"> </span>running<span class="w"> </span><span class="m">10000000</span>
</span><span id="__span-23-38"><a id="__codelineno-23-38" name="__codelineno-23-38" href="#__codelineno-23-38"></a>Ticks<span class="w"> </span><span class="m">0</span>
</span><span id="__span-23-39"><a id="__codelineno-23-39" name="__codelineno-23-39" href="#__codelineno-23-39"></a>You<span class="w"> </span>need<span class="w"> </span>to<span class="w"> </span>further<span class="w"> </span>implement<span class="w"> </span>the<span class="w"> </span>timer<span class="w"> </span>handling<span class="w"> </span><span class="k">in</span><span class="w"> </span>lab3_3.
</span><span id="__span-23-40"><a id="__codelineno-23-40" name="__codelineno-23-40" href="#__codelineno-23-40"></a>
</span><span id="__span-23-41"><a id="__codelineno-23-41" name="__codelineno-23-41" href="#__codelineno-23-41"></a>System<span class="w"> </span>is<span class="w"> </span>shutting<span class="w"> </span>down<span class="w"> </span>with<span class="w"> </span><span class="nb">exit</span><span class="w"> </span>code<span class="w"> </span>-1.
</span></code></pre></div>
<p>回顾实验1的<a href="../chapter3_traps/#irq">lab1_3</a>，我们看到由于进程的执行体很长，执行过程中时钟中断被触发（输出中的“Ticks 0”）。显然，我们可以通过利用时钟中断来实现进程的循环轮转调度，避免由于一个进程的执行体过长，导致系统中其他进程无法得到调度的问题！</p>
<p><a name="lab3_3_content"></a></p>
<h4 id="_9"><strong>实验内容</strong></h4>
<p>实现kernel/strap.c文件中的rrsched()函数，获得以下预期结果：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-24-1"><a id="__codelineno-24-1" name="__codelineno-24-1" href="#__codelineno-24-1"></a>$<span class="w"> </span>spike<span class="w"> </span>./obj/riscv-pke<span class="w"> </span>./obj/app_two_long_loops
</span><span id="__span-24-2"><a id="__codelineno-24-2" name="__codelineno-24-2" href="#__codelineno-24-2"></a>In<span class="w"> </span>m_start,<span class="w"> </span>hartid:0
</span><span id="__span-24-3"><a id="__codelineno-24-3" name="__codelineno-24-3" href="#__codelineno-24-3"></a>HTIF<span class="w"> </span>is<span class="w"> </span>available!
</span><span id="__span-24-4"><a id="__codelineno-24-4" name="__codelineno-24-4" href="#__codelineno-24-4"></a><span class="o">(</span>Emulated<span class="o">)</span><span class="w"> </span>memory<span class="w"> </span>size:<span class="w"> </span><span class="m">2048</span><span class="w"> </span>MB
</span><span id="__span-24-5"><a id="__codelineno-24-5" name="__codelineno-24-5" href="#__codelineno-24-5"></a>Enter<span class="w"> </span>supervisor<span class="w"> </span>mode...
</span><span id="__span-24-6"><a id="__codelineno-24-6" name="__codelineno-24-6" href="#__codelineno-24-6"></a>PKE<span class="w"> </span>kernel<span class="w"> </span>start<span class="w"> </span>0x0000000080000000,<span class="w"> </span>PKE<span class="w"> </span>kernel<span class="w"> </span>end:<span class="w"> </span>0x0000000080010000,<span class="w"> </span>PKE<span class="w"> </span>kernel<span class="w"> </span>size:<span class="w"> </span>0x0000000000010000<span class="w"> </span>.
</span><span id="__span-24-7"><a id="__codelineno-24-7" name="__codelineno-24-7" href="#__codelineno-24-7"></a>free<span class="w"> </span>physical<span class="w"> </span>memory<span class="w"> </span>address:<span class="w"> </span><span class="o">[</span>0x0000000080010000,<span class="w"> </span>0x0000000087ffffff<span class="o">]</span>
</span><span id="__span-24-8"><a id="__codelineno-24-8" name="__codelineno-24-8" href="#__codelineno-24-8"></a>kernel<span class="w"> </span>memory<span class="w"> </span>manager<span class="w"> </span>is<span class="w"> </span>initializing<span class="w"> </span>...
</span><span id="__span-24-9"><a id="__codelineno-24-9" name="__codelineno-24-9" href="#__codelineno-24-9"></a>KERN_BASE<span class="w"> </span>0x0000000080000000
</span><span id="__span-24-10"><a id="__codelineno-24-10" name="__codelineno-24-10" href="#__codelineno-24-10"></a>physical<span class="w"> </span>address<span class="w"> </span>of<span class="w"> </span>_etext<span class="w"> </span>is:<span class="w"> </span>0x0000000080005000
</span><span id="__span-24-11"><a id="__codelineno-24-11" name="__codelineno-24-11" href="#__codelineno-24-11"></a>kernel<span class="w"> </span>page<span class="w"> </span>table<span class="w"> </span>is<span class="w"> </span>on
</span><span id="__span-24-12"><a id="__codelineno-24-12" name="__codelineno-24-12" href="#__codelineno-24-12"></a>Switching<span class="w"> </span>to<span class="w"> </span>user<span class="w"> </span>mode...
</span><span id="__span-24-13"><a id="__codelineno-24-13" name="__codelineno-24-13" href="#__codelineno-24-13"></a><span class="k">in</span><span class="w"> </span>alloc_proc.<span class="w"> </span>user<span class="w"> </span>frame<span class="w"> </span>0x0000000087fbc000,<span class="w"> </span>user<span class="w"> </span>stack<span class="w"> </span>0x000000007ffff000,<span class="w"> </span>user<span class="w"> </span>kstack<span class="w"> </span>0x0000000087fbb000
</span><span id="__span-24-14"><a id="__codelineno-24-14" name="__codelineno-24-14" href="#__codelineno-24-14"></a>User<span class="w"> </span>application<span class="w"> </span>is<span class="w"> </span>loading.
</span><span id="__span-24-15"><a id="__codelineno-24-15" name="__codelineno-24-15" href="#__codelineno-24-15"></a>Application:<span class="w"> </span>./obj/app_two_long_loops
</span><span id="__span-24-16"><a id="__codelineno-24-16" name="__codelineno-24-16" href="#__codelineno-24-16"></a>CODE_SEGMENT<span class="w"> </span>added<span class="w"> </span>at<span class="w"> </span>mapped<span class="w"> </span>info<span class="w"> </span>offset:3
</span><span id="__span-24-17"><a id="__codelineno-24-17" name="__codelineno-24-17" href="#__codelineno-24-17"></a>Application<span class="w"> </span>program<span class="w"> </span>entry<span class="w"> </span>point<span class="w"> </span><span class="o">(</span>virtual<span class="w"> </span>address<span class="o">)</span>:<span class="w"> </span>0x000000000001017c
</span><span id="__span-24-18"><a id="__codelineno-24-18" name="__codelineno-24-18" href="#__codelineno-24-18"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">0</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-24-19"><a id="__codelineno-24-19" name="__codelineno-24-19" href="#__codelineno-24-19"></a>going<span class="w"> </span>to<span class="w"> </span>schedule<span class="w"> </span>process<span class="w"> </span><span class="m">0</span><span class="w"> </span>to<span class="w"> </span>run.
</span><span id="__span-24-20"><a id="__codelineno-24-20" name="__codelineno-24-20" href="#__codelineno-24-20"></a>User<span class="w"> </span>call<span class="w"> </span>fork.
</span><span id="__span-24-21"><a id="__codelineno-24-21" name="__codelineno-24-21" href="#__codelineno-24-21"></a>will<span class="w"> </span>fork<span class="w"> </span>a<span class="w"> </span>child<span class="w"> </span>from<span class="w"> </span>parent<span class="w"> </span><span class="m">0</span>.
</span><span id="__span-24-22"><a id="__codelineno-24-22" name="__codelineno-24-22" href="#__codelineno-24-22"></a><span class="k">in</span><span class="w"> </span>alloc_proc.<span class="w"> </span>user<span class="w"> </span>frame<span class="w"> </span>0x0000000087faf000,<span class="w"> </span>user<span class="w"> </span>stack<span class="w"> </span>0x000000007ffff000,<span class="w"> </span>user<span class="w"> </span>kstack<span class="w"> </span>0x0000000087fae000
</span><span id="__span-24-23"><a id="__codelineno-24-23" name="__codelineno-24-23" href="#__codelineno-24-23"></a>do_fork<span class="w"> </span>map<span class="w"> </span>code<span class="w"> </span>segment<span class="w"> </span>at<span class="w"> </span>pa:0000000087fb2000<span class="w"> </span>of<span class="w"> </span>parent<span class="w"> </span>to<span class="w"> </span>child<span class="w"> </span>at<span class="w"> </span>va:0000000000010000.
</span><span id="__span-24-24"><a id="__codelineno-24-24" name="__codelineno-24-24" href="#__codelineno-24-24"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">1</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-24-25"><a id="__codelineno-24-25" name="__codelineno-24-25" href="#__codelineno-24-25"></a>Parent:<span class="w"> </span>Hello<span class="w"> </span>world!
</span><span id="__span-24-26"><a id="__codelineno-24-26" name="__codelineno-24-26" href="#__codelineno-24-26"></a>Parent<span class="w"> </span>running<span class="w"> </span><span class="m">0</span>
</span><span id="__span-24-27"><a id="__codelineno-24-27" name="__codelineno-24-27" href="#__codelineno-24-27"></a>Parent<span class="w"> </span>running<span class="w"> </span><span class="m">10000000</span>
</span><span id="__span-24-28"><a id="__codelineno-24-28" name="__codelineno-24-28" href="#__codelineno-24-28"></a>Ticks<span class="w"> </span><span class="m">0</span>
</span><span id="__span-24-29"><a id="__codelineno-24-29" name="__codelineno-24-29" href="#__codelineno-24-29"></a>Parent<span class="w"> </span>running<span class="w"> </span><span class="m">20000000</span>
</span><span id="__span-24-30"><a id="__codelineno-24-30" name="__codelineno-24-30" href="#__codelineno-24-30"></a>Ticks<span class="w"> </span><span class="m">1</span>
</span><span id="__span-24-31"><a id="__codelineno-24-31" name="__codelineno-24-31" href="#__codelineno-24-31"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">0</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-24-32"><a id="__codelineno-24-32" name="__codelineno-24-32" href="#__codelineno-24-32"></a>going<span class="w"> </span>to<span class="w"> </span>schedule<span class="w"> </span>process<span class="w"> </span><span class="m">1</span><span class="w"> </span>to<span class="w"> </span>run.
</span><span id="__span-24-33"><a id="__codelineno-24-33" name="__codelineno-24-33" href="#__codelineno-24-33"></a>Child:<span class="w"> </span>Hello<span class="w"> </span>world!
</span><span id="__span-24-34"><a id="__codelineno-24-34" name="__codelineno-24-34" href="#__codelineno-24-34"></a>Child<span class="w"> </span>running<span class="w"> </span><span class="m">0</span>
</span><span id="__span-24-35"><a id="__codelineno-24-35" name="__codelineno-24-35" href="#__codelineno-24-35"></a>Child<span class="w"> </span>running<span class="w"> </span><span class="m">10000000</span>
</span><span id="__span-24-36"><a id="__codelineno-24-36" name="__codelineno-24-36" href="#__codelineno-24-36"></a>Ticks<span class="w"> </span><span class="m">2</span>
</span><span id="__span-24-37"><a id="__codelineno-24-37" name="__codelineno-24-37" href="#__codelineno-24-37"></a>Child<span class="w"> </span>running<span class="w"> </span><span class="m">20000000</span>
</span><span id="__span-24-38"><a id="__codelineno-24-38" name="__codelineno-24-38" href="#__codelineno-24-38"></a>Ticks<span class="w"> </span><span class="m">3</span>
</span><span id="__span-24-39"><a id="__codelineno-24-39" name="__codelineno-24-39" href="#__codelineno-24-39"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">1</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-24-40"><a id="__codelineno-24-40" name="__codelineno-24-40" href="#__codelineno-24-40"></a>going<span class="w"> </span>to<span class="w"> </span>schedule<span class="w"> </span>process<span class="w"> </span><span class="m">0</span><span class="w"> </span>to<span class="w"> </span>run.
</span><span id="__span-24-41"><a id="__codelineno-24-41" name="__codelineno-24-41" href="#__codelineno-24-41"></a>Parent<span class="w"> </span>running<span class="w"> </span><span class="m">30000000</span>
</span><span id="__span-24-42"><a id="__codelineno-24-42" name="__codelineno-24-42" href="#__codelineno-24-42"></a>Ticks<span class="w"> </span><span class="m">4</span>
</span><span id="__span-24-43"><a id="__codelineno-24-43" name="__codelineno-24-43" href="#__codelineno-24-43"></a>Parent<span class="w"> </span>running<span class="w"> </span><span class="m">40000000</span>
</span><span id="__span-24-44"><a id="__codelineno-24-44" name="__codelineno-24-44" href="#__codelineno-24-44"></a>Ticks<span class="w"> </span><span class="m">5</span>
</span><span id="__span-24-45"><a id="__codelineno-24-45" name="__codelineno-24-45" href="#__codelineno-24-45"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">0</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-24-46"><a id="__codelineno-24-46" name="__codelineno-24-46" href="#__codelineno-24-46"></a>going<span class="w"> </span>to<span class="w"> </span>schedule<span class="w"> </span>process<span class="w"> </span><span class="m">1</span><span class="w"> </span>to<span class="w"> </span>run.
</span><span id="__span-24-47"><a id="__codelineno-24-47" name="__codelineno-24-47" href="#__codelineno-24-47"></a>Child<span class="w"> </span>running<span class="w"> </span><span class="m">30000000</span>
</span><span id="__span-24-48"><a id="__codelineno-24-48" name="__codelineno-24-48" href="#__codelineno-24-48"></a>Ticks<span class="w"> </span><span class="m">6</span>
</span><span id="__span-24-49"><a id="__codelineno-24-49" name="__codelineno-24-49" href="#__codelineno-24-49"></a>Child<span class="w"> </span>running<span class="w"> </span><span class="m">40000000</span>
</span><span id="__span-24-50"><a id="__codelineno-24-50" name="__codelineno-24-50" href="#__codelineno-24-50"></a>Ticks<span class="w"> </span><span class="m">7</span>
</span><span id="__span-24-51"><a id="__codelineno-24-51" name="__codelineno-24-51" href="#__codelineno-24-51"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">1</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-24-52"><a id="__codelineno-24-52" name="__codelineno-24-52" href="#__codelineno-24-52"></a>going<span class="w"> </span>to<span class="w"> </span>schedule<span class="w"> </span>process<span class="w"> </span><span class="m">0</span><span class="w"> </span>to<span class="w"> </span>run.
</span><span id="__span-24-53"><a id="__codelineno-24-53" name="__codelineno-24-53" href="#__codelineno-24-53"></a>Parent<span class="w"> </span>running<span class="w"> </span><span class="m">50000000</span>
</span><span id="__span-24-54"><a id="__codelineno-24-54" name="__codelineno-24-54" href="#__codelineno-24-54"></a>Parent<span class="w"> </span>running<span class="w"> </span><span class="m">60000000</span>
</span><span id="__span-24-55"><a id="__codelineno-24-55" name="__codelineno-24-55" href="#__codelineno-24-55"></a>Ticks<span class="w"> </span><span class="m">8</span>
</span><span id="__span-24-56"><a id="__codelineno-24-56" name="__codelineno-24-56" href="#__codelineno-24-56"></a>Parent<span class="w"> </span>running<span class="w"> </span><span class="m">70000000</span>
</span><span id="__span-24-57"><a id="__codelineno-24-57" name="__codelineno-24-57" href="#__codelineno-24-57"></a>Ticks<span class="w"> </span><span class="m">9</span>
</span><span id="__span-24-58"><a id="__codelineno-24-58" name="__codelineno-24-58" href="#__codelineno-24-58"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">0</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-24-59"><a id="__codelineno-24-59" name="__codelineno-24-59" href="#__codelineno-24-59"></a>going<span class="w"> </span>to<span class="w"> </span>schedule<span class="w"> </span>process<span class="w"> </span><span class="m">1</span><span class="w"> </span>to<span class="w"> </span>run.
</span><span id="__span-24-60"><a id="__codelineno-24-60" name="__codelineno-24-60" href="#__codelineno-24-60"></a>Child<span class="w"> </span>running<span class="w"> </span><span class="m">50000000</span>
</span><span id="__span-24-61"><a id="__codelineno-24-61" name="__codelineno-24-61" href="#__codelineno-24-61"></a>Child<span class="w"> </span>running<span class="w"> </span><span class="m">60000000</span>
</span><span id="__span-24-62"><a id="__codelineno-24-62" name="__codelineno-24-62" href="#__codelineno-24-62"></a>Ticks<span class="w"> </span><span class="m">10</span>
</span><span id="__span-24-63"><a id="__codelineno-24-63" name="__codelineno-24-63" href="#__codelineno-24-63"></a>Child<span class="w"> </span>running<span class="w"> </span><span class="m">70000000</span>
</span><span id="__span-24-64"><a id="__codelineno-24-64" name="__codelineno-24-64" href="#__codelineno-24-64"></a>Ticks<span class="w"> </span><span class="m">11</span>
</span><span id="__span-24-65"><a id="__codelineno-24-65" name="__codelineno-24-65" href="#__codelineno-24-65"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">1</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-24-66"><a id="__codelineno-24-66" name="__codelineno-24-66" href="#__codelineno-24-66"></a>going<span class="w"> </span>to<span class="w"> </span>schedule<span class="w"> </span>process<span class="w"> </span><span class="m">0</span><span class="w"> </span>to<span class="w"> </span>run.
</span><span id="__span-24-67"><a id="__codelineno-24-67" name="__codelineno-24-67" href="#__codelineno-24-67"></a>Parent<span class="w"> </span>running<span class="w"> </span><span class="m">80000000</span>
</span><span id="__span-24-68"><a id="__codelineno-24-68" name="__codelineno-24-68" href="#__codelineno-24-68"></a>Ticks<span class="w"> </span><span class="m">12</span>
</span><span id="__span-24-69"><a id="__codelineno-24-69" name="__codelineno-24-69" href="#__codelineno-24-69"></a>Parent<span class="w"> </span>running<span class="w"> </span><span class="m">90000000</span>
</span><span id="__span-24-70"><a id="__codelineno-24-70" name="__codelineno-24-70" href="#__codelineno-24-70"></a>Ticks<span class="w"> </span><span class="m">13</span>
</span><span id="__span-24-71"><a id="__codelineno-24-71" name="__codelineno-24-71" href="#__codelineno-24-71"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">0</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-24-72"><a id="__codelineno-24-72" name="__codelineno-24-72" href="#__codelineno-24-72"></a>going<span class="w"> </span>to<span class="w"> </span>schedule<span class="w"> </span>process<span class="w"> </span><span class="m">1</span><span class="w"> </span>to<span class="w"> </span>run.
</span><span id="__span-24-73"><a id="__codelineno-24-73" name="__codelineno-24-73" href="#__codelineno-24-73"></a>Child<span class="w"> </span>running<span class="w"> </span><span class="m">80000000</span>
</span><span id="__span-24-74"><a id="__codelineno-24-74" name="__codelineno-24-74" href="#__codelineno-24-74"></a>Ticks<span class="w"> </span><span class="m">14</span>
</span><span id="__span-24-75"><a id="__codelineno-24-75" name="__codelineno-24-75" href="#__codelineno-24-75"></a>Child<span class="w"> </span>running<span class="w"> </span><span class="m">90000000</span>
</span><span id="__span-24-76"><a id="__codelineno-24-76" name="__codelineno-24-76" href="#__codelineno-24-76"></a>Ticks<span class="w"> </span><span class="m">15</span>
</span><span id="__span-24-77"><a id="__codelineno-24-77" name="__codelineno-24-77" href="#__codelineno-24-77"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">1</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-24-78"><a id="__codelineno-24-78" name="__codelineno-24-78" href="#__codelineno-24-78"></a>going<span class="w"> </span>to<span class="w"> </span>schedule<span class="w"> </span>process<span class="w"> </span><span class="m">0</span><span class="w"> </span>to<span class="w"> </span>run.
</span><span id="__span-24-79"><a id="__codelineno-24-79" name="__codelineno-24-79" href="#__codelineno-24-79"></a>User<span class="w"> </span><span class="nb">exit</span><span class="w"> </span>with<span class="w"> </span>code:0.
</span><span id="__span-24-80"><a id="__codelineno-24-80" name="__codelineno-24-80" href="#__codelineno-24-80"></a>going<span class="w"> </span>to<span class="w"> </span>schedule<span class="w"> </span>process<span class="w"> </span><span class="m">1</span><span class="w"> </span>to<span class="w"> </span>run.
</span><span id="__span-24-81"><a id="__codelineno-24-81" name="__codelineno-24-81" href="#__codelineno-24-81"></a>User<span class="w"> </span><span class="nb">exit</span><span class="w"> </span>with<span class="w"> </span>code:0.
</span><span id="__span-24-82"><a id="__codelineno-24-82" name="__codelineno-24-82" href="#__codelineno-24-82"></a>no<span class="w"> </span>more<span class="w"> </span>ready<span class="w"> </span>processes,<span class="w"> </span>system<span class="w"> </span>shutdown<span class="w"> </span>now.
</span><span id="__span-24-83"><a id="__codelineno-24-83" name="__codelineno-24-83" href="#__codelineno-24-83"></a>System<span class="w"> </span>is<span class="w"> </span>shutting<span class="w"> </span>down<span class="w"> </span>with<span class="w"> </span><span class="nb">exit</span><span class="w"> </span>code<span class="w"> </span><span class="m">0</span>.
</span></code></pre></div>
<p><a name="lab3_3_guide"></a></p>
<h4 id="_10"><strong>实验指导</strong></h4>
<p>实际上，如果单纯为了实现进程的轮转，避免单个进程长期霸占CPU的情况，只需要简单地在时钟中断被触发时做重新调度即可。然而，为了实现时间片的概念，以及控制进程在单时间片内获得的执行长度，我们在kernel/sched.h文件中定义了“时间片”的长度：</p>
<div class="language-C highlight"><pre><span></span><code><span id="__span-25-1"><a id="__codelineno-25-1" name="__codelineno-25-1" href="#__codelineno-25-1"></a><span class="w">  </span><span class="mi">6</span><span class="w"> </span><span class="c1">//length of a time slice, in number of ticks</span>
</span><span id="__span-25-2"><a id="__codelineno-25-2" name="__codelineno-25-2" href="#__codelineno-25-2"></a><span class="w">  </span><span class="mi">7</span><span class="w"> </span><span class="err">#</span><span class="n">define</span><span class="w"> </span><span class="n">TIME_SLICE_LEN</span><span class="w">  </span><span class="mi">2</span>
</span></code></pre></div>
<p>可以看到时间片的长度（TIME_SLICE_LEN）为2个ticks，这就意味着我们要每隔两个ticks触发一次进程重新调度动作。</p>
<p>为配合调度的实现，我们在进程结构中定义了整型成员（参见<a href="#subsec_process_structure">5.1.1</a>）tick_count，完善kernel/strap.c文件中的rrsched()函数，以实现循环轮转调度时，应采取的逻辑为：</p>
<ul>
<li>判断当前进程的tick_count加1后是否大于等于TIME_SLICE_LEN？</li>
<li>若答案为yes，则应将当前进程的tick_count清零，并将当前进程加入就绪队列，转进程调度；</li>
<li>若答案为no，则应将当前进程的tick_count加1，并返回。</li>
</ul>
<p><strong>实验完毕后，记得提交修改（命令行中-m后的字符串可自行确定），以便在后续实验中继承lab3_3中所做的工作</strong>：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-26-1"><a id="__codelineno-26-1" name="__codelineno-26-1" href="#__codelineno-26-1"></a>$<span class="w"> </span>git<span class="w"> </span>commit<span class="w"> </span>-a<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;my work on lab3_3 is done.&quot;</span>
</span></code></pre></div>
<p><a name="lab3_challenge1_wait"></a></p>
<h2 id="55-lab3_challenge1">5.5 lab3_challenge1 进程等待和数据段复制（难度：&#9733;&#9733;&#9734;&#9734;&#9734;）</h2>
<p><a name="lab3_challenge1_app"></a></p>
<h4 id="_11"><strong>给定应用</strong></h4>
<ul>
<li>user/app_wait.c</li>
</ul>
<div class="language-c highlight"><pre><span></span><code><span id="__span-27-1"><a id="__codelineno-27-1" name="__codelineno-27-1" href="#__codelineno-27-1"></a><span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="cm">/*                                                                             </span>
</span><span id="__span-27-2"><a id="__codelineno-27-2" name="__codelineno-27-2" href="#__codelineno-27-2"></a><span class="cm">  2  * This app fork a child process, and the child process fork a grandchild process.</span>
</span><span id="__span-27-3"><a id="__codelineno-27-3" name="__codelineno-27-3" href="#__codelineno-27-3"></a><span class="cm">  3  * every process waits for its own child exit then prints.                     </span>
</span><span id="__span-27-4"><a id="__codelineno-27-4" name="__codelineno-27-4" href="#__codelineno-27-4"></a><span class="cm">  4  * Three processes also write their own global variables &quot;flag&quot;</span>
</span><span id="__span-27-5"><a id="__codelineno-27-5" name="__codelineno-27-5" href="#__codelineno-27-5"></a><span class="cm">  5  * to different values.</span>
</span><span id="__span-27-6"><a id="__codelineno-27-6" name="__codelineno-27-6" href="#__codelineno-27-6"></a><span class="cm">  6  */</span>
</span><span id="__span-27-7"><a id="__codelineno-27-7" name="__codelineno-27-7" href="#__codelineno-27-7"></a><span class="w">  </span><span class="mi">7</span><span class="w"> </span>
</span><span id="__span-27-8"><a id="__codelineno-27-8" name="__codelineno-27-8" href="#__codelineno-27-8"></a><span class="w">  </span><span class="mi">8</span><span class="w"> </span><span class="err">#</span><span class="n">include</span><span class="w"> </span><span class="s">&quot;user/user_lib.h&quot;</span>
</span><span id="__span-27-9"><a id="__codelineno-27-9" name="__codelineno-27-9" href="#__codelineno-27-9"></a><span class="w">  </span><span class="mi">9</span><span class="w"> </span><span class="err">#</span><span class="n">include</span><span class="w"> </span><span class="s">&quot;util/types.h&quot;</span>
</span><span id="__span-27-10"><a id="__codelineno-27-10" name="__codelineno-27-10" href="#__codelineno-27-10"></a><span class="w"> </span><span class="mi">10</span><span class="w"> </span>
</span><span id="__span-27-11"><a id="__codelineno-27-11" name="__codelineno-27-11" href="#__codelineno-27-11"></a><span class="w"> </span><span class="mi">11</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">flag</span><span class="p">;</span>
</span><span id="__span-27-12"><a id="__codelineno-27-12" name="__codelineno-27-12" href="#__codelineno-27-12"></a><span class="w"> </span><span class="mi">12</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-27-13"><a id="__codelineno-27-13" name="__codelineno-27-13" href="#__codelineno-27-13"></a><span class="w"> </span><span class="mi">13</span><span class="w">     </span><span class="n">flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-27-14"><a id="__codelineno-27-14" name="__codelineno-27-14" href="#__codelineno-27-14"></a><span class="w"> </span><span class="mi">14</span><span class="w">     </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fork</span><span class="p">();</span>
</span><span id="__span-27-15"><a id="__codelineno-27-15" name="__codelineno-27-15" href="#__codelineno-27-15"></a><span class="w"> </span><span class="mi">15</span><span class="w">     </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-27-16"><a id="__codelineno-27-16" name="__codelineno-27-16" href="#__codelineno-27-16"></a><span class="w"> </span><span class="mi">16</span><span class="w">         </span><span class="n">flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
</span><span id="__span-27-17"><a id="__codelineno-27-17" name="__codelineno-27-17" href="#__codelineno-27-17"></a><span class="w"> </span><span class="mi">17</span><span class="w">         </span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fork</span><span class="p">();</span>
</span><span id="__span-27-18"><a id="__codelineno-27-18" name="__codelineno-27-18" href="#__codelineno-27-18"></a><span class="w"> </span><span class="mi">18</span><span class="w">         </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-27-19"><a id="__codelineno-27-19" name="__codelineno-27-19" href="#__codelineno-27-19"></a><span class="w"> </span><span class="mi">19</span><span class="w">             </span><span class="n">flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
</span><span id="__span-27-20"><a id="__codelineno-27-20" name="__codelineno-27-20" href="#__codelineno-27-20"></a><span class="w"> </span><span class="mi">20</span><span class="w">             </span><span class="n">printu</span><span class="p">(</span><span class="s">&quot;Grandchild process end, flag = %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">flag</span><span class="p">);</span>
</span><span id="__span-27-21"><a id="__codelineno-27-21" name="__codelineno-27-21" href="#__codelineno-27-21"></a><span class="w"> </span><span class="mi">21</span><span class="w">         </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-27-22"><a id="__codelineno-27-22" name="__codelineno-27-22" href="#__codelineno-27-22"></a><span class="w"> </span><span class="mi">22</span><span class="w">             </span><span class="n">wait</span><span class="p">(</span><span class="n">pid</span><span class="p">);</span>
</span><span id="__span-27-23"><a id="__codelineno-27-23" name="__codelineno-27-23" href="#__codelineno-27-23"></a><span class="w"> </span><span class="mi">23</span><span class="w">             </span><span class="n">printu</span><span class="p">(</span><span class="s">&quot;Child process end, flag = %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">flag</span><span class="p">);</span>
</span><span id="__span-27-24"><a id="__codelineno-27-24" name="__codelineno-27-24" href="#__codelineno-27-24"></a><span class="w"> </span><span class="mi">24</span><span class="w">         </span><span class="p">}</span>
</span><span id="__span-27-25"><a id="__codelineno-27-25" name="__codelineno-27-25" href="#__codelineno-27-25"></a><span class="w"> </span><span class="mi">25</span><span class="w">     </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-27-26"><a id="__codelineno-27-26" name="__codelineno-27-26" href="#__codelineno-27-26"></a><span class="w"> </span><span class="mi">26</span><span class="w">         </span><span class="n">wait</span><span class="p">(</span><span class="mi">-1</span><span class="p">);</span>
</span><span id="__span-27-27"><a id="__codelineno-27-27" name="__codelineno-27-27" href="#__codelineno-27-27"></a><span class="w"> </span><span class="mi">27</span><span class="w">         </span><span class="n">printu</span><span class="p">(</span><span class="s">&quot;Parent process end, flag = %d.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">flag</span><span class="p">);</span>
</span><span id="__span-27-28"><a id="__codelineno-27-28" name="__codelineno-27-28" href="#__codelineno-27-28"></a><span class="w"> </span><span class="mi">28</span><span class="w">     </span><span class="p">}</span>
</span><span id="__span-27-29"><a id="__codelineno-27-29" name="__codelineno-27-29" href="#__codelineno-27-29"></a><span class="w"> </span><span class="mi">29</span><span class="w">     </span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-27-30"><a id="__codelineno-27-30" name="__codelineno-27-30" href="#__codelineno-27-30"></a><span class="w"> </span><span class="mi">30</span><span class="w">     </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-27-31"><a id="__codelineno-27-31" name="__codelineno-27-31" href="#__codelineno-27-31"></a><span class="w"> </span><span class="mi">31</span><span class="w"> </span><span class="p">}</span>
</span></code></pre></div>
<p>wait系统调用是进程管理中一个非常重要的系统调用，它主要有两大功能：</p>
<ul>
<li>当一个进程退出之后，它所占用的资源并不一定能够立即回收，比如该进程的内核栈目前就正用来进行系统调用处理。对于这种问题，一种典型的做法是当进程退出的时候内核立即回收一部分资源并将该进程标记为僵尸进程。由父进程调用wait函数的时候再回收该进程的其他资源。</li>
<li>父进程的有些操作需要子进程运行结束后获得结果才能继续执行，这时wait函数起到进程同步的作用。</li>
</ul>
<p>在以上程序中，父进程把flag变量赋值为0，然后fork生成一个子进程，接着通过wait函数等待子进程的退出。子进程把自己的变量flag赋值为1，然后fork生成孙子进程，接着通过wait函数等待孙子进程的退出。孙子进程给自己的变量flag赋值为2并在退出时输出信息，然后子进程退出时输出信息，最后父进程退出时输出信息。由于fork之后父子进程的数据段相互独立（同一虚拟地址对应不同的物理地址），子进程对全局变量的赋值不影响父进程全局变量的值，因此结果如下：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-28-1"><a id="__codelineno-28-1" name="__codelineno-28-1" href="#__codelineno-28-1"></a>In<span class="w"> </span>m_start,<span class="w"> </span>hartid:0
</span><span id="__span-28-2"><a id="__codelineno-28-2" name="__codelineno-28-2" href="#__codelineno-28-2"></a>HTIF<span class="w"> </span>is<span class="w"> </span>available!
</span><span id="__span-28-3"><a id="__codelineno-28-3" name="__codelineno-28-3" href="#__codelineno-28-3"></a><span class="o">(</span>Emulated<span class="o">)</span><span class="w"> </span>memory<span class="w"> </span>size:<span class="w"> </span><span class="m">2048</span><span class="w"> </span>MB
</span><span id="__span-28-4"><a id="__codelineno-28-4" name="__codelineno-28-4" href="#__codelineno-28-4"></a>Enter<span class="w"> </span>supervisor<span class="w"> </span>mode...
</span><span id="__span-28-5"><a id="__codelineno-28-5" name="__codelineno-28-5" href="#__codelineno-28-5"></a>PKE<span class="w"> </span>kernel<span class="w"> </span>start<span class="w"> </span>0x0000000080000000,<span class="w"> </span>PKE<span class="w"> </span>kernel<span class="w"> </span>end:<span class="w"> </span>0x0000000080009000,<span class="w"> </span>PKE<span class="w"> </span>kernel<span class="w"> </span>size:<span class="w"> </span>0x0000000000009000<span class="w"> </span>.
</span><span id="__span-28-6"><a id="__codelineno-28-6" name="__codelineno-28-6" href="#__codelineno-28-6"></a>free<span class="w"> </span>physical<span class="w"> </span>memory<span class="w"> </span>address:<span class="w"> </span><span class="o">[</span>0x0000000080009000,<span class="w"> </span>0x0000000087ffffff<span class="o">]</span><span class="w"> </span>
</span><span id="__span-28-7"><a id="__codelineno-28-7" name="__codelineno-28-7" href="#__codelineno-28-7"></a>kernel<span class="w"> </span>memory<span class="w"> </span>manager<span class="w"> </span>is<span class="w"> </span>initializing<span class="w"> </span>...
</span><span id="__span-28-8"><a id="__codelineno-28-8" name="__codelineno-28-8" href="#__codelineno-28-8"></a>KERN_BASE<span class="w"> </span>0x0000000080000000
</span><span id="__span-28-9"><a id="__codelineno-28-9" name="__codelineno-28-9" href="#__codelineno-28-9"></a>physical<span class="w"> </span>address<span class="w"> </span>of<span class="w"> </span>_etext<span class="w"> </span>is:<span class="w"> </span>0x0000000080005000
</span><span id="__span-28-10"><a id="__codelineno-28-10" name="__codelineno-28-10" href="#__codelineno-28-10"></a>kernel<span class="w"> </span>page<span class="w"> </span>table<span class="w"> </span>is<span class="w"> </span>on<span class="w"> </span>
</span><span id="__span-28-11"><a id="__codelineno-28-11" name="__codelineno-28-11" href="#__codelineno-28-11"></a>Switch<span class="w"> </span>to<span class="w"> </span>user<span class="w"> </span>mode...
</span><span id="__span-28-12"><a id="__codelineno-28-12" name="__codelineno-28-12" href="#__codelineno-28-12"></a><span class="k">in</span><span class="w"> </span>alloc_proc.<span class="w"> </span>user<span class="w"> </span>frame<span class="w"> </span>0x0000000087fbc000,<span class="w"> </span>user<span class="w"> </span>stack<span class="w"> </span>0x000000007ffff000,<span class="w"> </span>user<span class="w"> </span>kstack<span class="w"> </span>0x0000000087fbb000<span class="w"> </span>
</span><span id="__span-28-13"><a id="__codelineno-28-13" name="__codelineno-28-13" href="#__codelineno-28-13"></a>User<span class="w"> </span>application<span class="w"> </span>is<span class="w"> </span>loading.
</span><span id="__span-28-14"><a id="__codelineno-28-14" name="__codelineno-28-14" href="#__codelineno-28-14"></a>Application:<span class="w"> </span>obj/app_wait
</span><span id="__span-28-15"><a id="__codelineno-28-15" name="__codelineno-28-15" href="#__codelineno-28-15"></a>CODE_SEGMENT<span class="w"> </span>added<span class="w"> </span>at<span class="w"> </span>mapped<span class="w"> </span>info<span class="w"> </span>offset:3
</span><span id="__span-28-16"><a id="__codelineno-28-16" name="__codelineno-28-16" href="#__codelineno-28-16"></a>DATA_SEGMENT<span class="w"> </span>added<span class="w"> </span>at<span class="w"> </span>mapped<span class="w"> </span>info<span class="w"> </span>offset:4
</span><span id="__span-28-17"><a id="__codelineno-28-17" name="__codelineno-28-17" href="#__codelineno-28-17"></a>Application<span class="w"> </span>program<span class="w"> </span>entry<span class="w"> </span>point<span class="w"> </span><span class="o">(</span>virtual<span class="w"> </span>address<span class="o">)</span>:<span class="w"> </span>0x00000000000100b0
</span><span id="__span-28-18"><a id="__codelineno-28-18" name="__codelineno-28-18" href="#__codelineno-28-18"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">0</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-28-19"><a id="__codelineno-28-19" name="__codelineno-28-19" href="#__codelineno-28-19"></a>going<span class="w"> </span>to<span class="w"> </span>schedule<span class="w"> </span>process<span class="w"> </span><span class="m">0</span><span class="w"> </span>to<span class="w"> </span>run.
</span><span id="__span-28-20"><a id="__codelineno-28-20" name="__codelineno-28-20" href="#__codelineno-28-20"></a>User<span class="w"> </span>call<span class="w"> </span>fork.
</span><span id="__span-28-21"><a id="__codelineno-28-21" name="__codelineno-28-21" href="#__codelineno-28-21"></a>will<span class="w"> </span>fork<span class="w"> </span>a<span class="w"> </span>child<span class="w"> </span>from<span class="w"> </span>parent<span class="w"> </span><span class="m">0</span>.
</span><span id="__span-28-22"><a id="__codelineno-28-22" name="__codelineno-28-22" href="#__codelineno-28-22"></a><span class="k">in</span><span class="w"> </span>alloc_proc.<span class="w"> </span>user<span class="w"> </span>frame<span class="w"> </span>0x0000000087fae000,<span class="w"> </span>user<span class="w"> </span>stack<span class="w"> </span>0x000000007ffff000,<span class="w"> </span>user<span class="w"> </span>kstack<span class="w"> </span>0x0000000087fad000<span class="w"> </span>
</span><span id="__span-28-23"><a id="__codelineno-28-23" name="__codelineno-28-23" href="#__codelineno-28-23"></a>do_fork<span class="w"> </span>map<span class="w"> </span>code<span class="w"> </span>segment<span class="w"> </span>at<span class="w"> </span>pa:0000000087fb2000<span class="w"> </span>of<span class="w"> </span>parent<span class="w"> </span>to<span class="w"> </span>child<span class="w"> </span>at<span class="w"> </span>va:0000000000010000.
</span><span id="__span-28-24"><a id="__codelineno-28-24" name="__codelineno-28-24" href="#__codelineno-28-24"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">1</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-28-25"><a id="__codelineno-28-25" name="__codelineno-28-25" href="#__codelineno-28-25"></a>going<span class="w"> </span>to<span class="w"> </span>schedule<span class="w"> </span>process<span class="w"> </span><span class="m">1</span><span class="w"> </span>to<span class="w"> </span>run.
</span><span id="__span-28-26"><a id="__codelineno-28-26" name="__codelineno-28-26" href="#__codelineno-28-26"></a>User<span class="w"> </span>call<span class="w"> </span>fork.
</span><span id="__span-28-27"><a id="__codelineno-28-27" name="__codelineno-28-27" href="#__codelineno-28-27"></a>will<span class="w"> </span>fork<span class="w"> </span>a<span class="w"> </span>child<span class="w"> </span>from<span class="w"> </span>parent<span class="w"> </span><span class="m">1</span>.
</span><span id="__span-28-28"><a id="__codelineno-28-28" name="__codelineno-28-28" href="#__codelineno-28-28"></a><span class="k">in</span><span class="w"> </span>alloc_proc.<span class="w"> </span>user<span class="w"> </span>frame<span class="w"> </span>0x0000000087fa1000,<span class="w"> </span>user<span class="w"> </span>stack<span class="w"> </span>0x000000007ffff000,<span class="w"> </span>user<span class="w"> </span>kstack<span class="w"> </span>0x0000000087fa0000<span class="w"> </span>
</span><span id="__span-28-29"><a id="__codelineno-28-29" name="__codelineno-28-29" href="#__codelineno-28-29"></a>do_fork<span class="w"> </span>map<span class="w"> </span>code<span class="w"> </span>segment<span class="w"> </span>at<span class="w"> </span>pa:0000000087fb2000<span class="w"> </span>of<span class="w"> </span>parent<span class="w"> </span>to<span class="w"> </span>child<span class="w"> </span>at<span class="w"> </span>va:0000000000010000.
</span><span id="__span-28-30"><a id="__codelineno-28-30" name="__codelineno-28-30" href="#__codelineno-28-30"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">2</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-28-31"><a id="__codelineno-28-31" name="__codelineno-28-31" href="#__codelineno-28-31"></a>going<span class="w"> </span>to<span class="w"> </span>schedule<span class="w"> </span>process<span class="w"> </span><span class="m">2</span><span class="w"> </span>to<span class="w"> </span>run.
</span><span id="__span-28-32"><a id="__codelineno-28-32" name="__codelineno-28-32" href="#__codelineno-28-32"></a>Grandchild<span class="w"> </span>process<span class="w"> </span>end,<span class="w"> </span><span class="nv">flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">2</span>.
</span><span id="__span-28-33"><a id="__codelineno-28-33" name="__codelineno-28-33" href="#__codelineno-28-33"></a>User<span class="w"> </span><span class="nb">exit</span><span class="w"> </span>with<span class="w"> </span>code:0.
</span><span id="__span-28-34"><a id="__codelineno-28-34" name="__codelineno-28-34" href="#__codelineno-28-34"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">1</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-28-35"><a id="__codelineno-28-35" name="__codelineno-28-35" href="#__codelineno-28-35"></a>going<span class="w"> </span>to<span class="w"> </span>schedule<span class="w"> </span>process<span class="w"> </span><span class="m">1</span><span class="w"> </span>to<span class="w"> </span>run.
</span><span id="__span-28-36"><a id="__codelineno-28-36" name="__codelineno-28-36" href="#__codelineno-28-36"></a>Child<span class="w"> </span>process<span class="w"> </span>end,<span class="w"> </span><span class="nv">flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">1</span>.
</span><span id="__span-28-37"><a id="__codelineno-28-37" name="__codelineno-28-37" href="#__codelineno-28-37"></a>User<span class="w"> </span><span class="nb">exit</span><span class="w"> </span>with<span class="w"> </span>code:0.
</span><span id="__span-28-38"><a id="__codelineno-28-38" name="__codelineno-28-38" href="#__codelineno-28-38"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">0</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-28-39"><a id="__codelineno-28-39" name="__codelineno-28-39" href="#__codelineno-28-39"></a>going<span class="w"> </span>to<span class="w"> </span>schedule<span class="w"> </span>process<span class="w"> </span><span class="m">0</span><span class="w"> </span>to<span class="w"> </span>run.
</span><span id="__span-28-40"><a id="__codelineno-28-40" name="__codelineno-28-40" href="#__codelineno-28-40"></a>Parent<span class="w"> </span>process<span class="w"> </span>end,<span class="w"> </span><span class="nv">flag</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="m">0</span>.
</span><span id="__span-28-41"><a id="__codelineno-28-41" name="__codelineno-28-41" href="#__codelineno-28-41"></a>User<span class="w"> </span><span class="nb">exit</span><span class="w"> </span>with<span class="w"> </span>code:0.
</span><span id="__span-28-42"><a id="__codelineno-28-42" name="__codelineno-28-42" href="#__codelineno-28-42"></a>no<span class="w"> </span>more<span class="w"> </span>ready<span class="w"> </span>processes,<span class="w"> </span>system<span class="w"> </span>shutdown<span class="w"> </span>now.
</span><span id="__span-28-43"><a id="__codelineno-28-43" name="__codelineno-28-43" href="#__codelineno-28-43"></a>System<span class="w"> </span>is<span class="w"> </span>shutting<span class="w"> </span>down<span class="w"> </span>with<span class="w"> </span><span class="nb">exit</span><span class="w"> </span>code<span class="w"> </span><span class="m">0</span>.
</span></code></pre></div>
<p><a name="lab3_challenge1_content"></a></p>
<h4 id="_12">实验内容</h4>
<p>本实验为挑战实验，基础代码将继承和使用lab3_3完成后的代码：</p>
<ul>
<li>（先提交lab3_3的答案，然后）切换到lab3_challenge1_wait、继承lab3_3中所做修改：</li>
</ul>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-29-1"><a id="__codelineno-29-1" name="__codelineno-29-1" href="#__codelineno-29-1"></a>//切换到lab3_challenge1_wait
</span><span id="__span-29-2"><a id="__codelineno-29-2" name="__codelineno-29-2" href="#__codelineno-29-2"></a>$<span class="w"> </span>git<span class="w"> </span>checkout<span class="w"> </span>lab3_challenge1_wait
</span><span id="__span-29-3"><a id="__codelineno-29-3" name="__codelineno-29-3" href="#__codelineno-29-3"></a>
</span><span id="__span-29-4"><a id="__codelineno-29-4" name="__codelineno-29-4" href="#__codelineno-29-4"></a>//继承lab3_3以及之前的答案
</span><span id="__span-29-5"><a id="__codelineno-29-5" name="__codelineno-29-5" href="#__codelineno-29-5"></a>$<span class="w"> </span>git<span class="w"> </span>merge<span class="w"> </span>lab3_3_rrsched<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;continue to work on lab3_challenge1&quot;</span>
</span></code></pre></div>
<p>注意：<strong>不同于基础实验，挑战实验的基础代码具有更大的不完整性，可能无法直接通过构造过程。</strong>
同样，不同于基础实验，我们在代码中也并未专门地哪些地方的代码需要填写，哪些地方的代码无须填写。这样，我们留给读者更大的“想象空间”。</p>
<ul>
<li>本实验的具体要求为：</li>
<li>通过修改PKE内核和系统调用，为用户程序提供wait函数的功能，wait函数接受一个参数pid：<ul>
<li>当pid为-1时，父进程等待任意一个子进程退出即返回子进程的pid；</li>
<li>当pid大于0时，父进程等待进程号为pid的子进程退出即返回子进程的pid；</li>
<li>如果pid不合法或pid大于0且pid对应的进程不是当前进程的子进程，返回-1。</li>
</ul>
</li>
<li>补充do_fork函数，实验3_1实现了代码段的复制，你需要继续实现数据段的复制并保证fork后父子进程的数据段相互独立。</li>
<li>注意：最终测试程序可能和给出的用户程序不同，但都只涉及wait函数、fork函数和全局变量读写的相关操作。</li>
</ul>
<p><a name="lab3_challenge1_guide"></a></p>
<h4 id="_13">实验指导</h4>
<ul>
<li>你对内核代码的修改可能包含添加系统调用、在内核中实现wait函数的功能以及对do_fork函数的完善。</li>
</ul>
<p><strong>注意：完成实验内容后，请读者另外编写应用，对自己的实现进行检测。</strong></p>
<p><strong>另外，后续的基础实验代码并不依赖挑战实验，所以读者可自行决定是否将自己的工作提交到本地代码仓库中（当然，提交到本地仓库是个好习惯，至少能保存自己的“作品”）。</strong></p>
<p><a name="lab3_challenge2_semaphore"></a></p>
<h2 id="56-lab3_challenge2">5.6 lab3_challenge2 实现信号量（难度：&#9733;&#9733;&#9733;&#9734;&#9734;）</h2>
<p><a name="lab3_challenge2_app"></a></p>
<h4 id="_14"><strong>给定应用</strong></h4>
<ul>
<li>user/app_semaphore.c</li>
</ul>
<div class="language-c highlight"><pre><span></span><code><span id="__span-30-1"><a id="__codelineno-30-1" name="__codelineno-30-1" href="#__codelineno-30-1"></a><span class="w">  </span><span class="mi">1</span><span class="w"> </span><span class="cm">/*                                                                                                         2 * This app create two child process.</span>
</span><span id="__span-30-2"><a id="__codelineno-30-2" name="__codelineno-30-2" href="#__codelineno-30-2"></a><span class="cm">  3 * Use semaphores to control the order of</span>
</span><span id="__span-30-3"><a id="__codelineno-30-3" name="__codelineno-30-3" href="#__codelineno-30-3"></a><span class="cm">  4 * the main process and two child processes print info. </span>
</span><span id="__span-30-4"><a id="__codelineno-30-4" name="__codelineno-30-4" href="#__codelineno-30-4"></a><span class="cm">  5 */</span>
</span><span id="__span-30-5"><a id="__codelineno-30-5" name="__codelineno-30-5" href="#__codelineno-30-5"></a><span class="w">  </span><span class="mi">6</span><span class="w"> </span><span class="err">#</span><span class="n">include</span><span class="w"> </span><span class="s">&quot;user/user_lib.h&quot;</span>
</span><span id="__span-30-6"><a id="__codelineno-30-6" name="__codelineno-30-6" href="#__codelineno-30-6"></a><span class="w">  </span><span class="mi">7</span><span class="w"> </span><span class="err">#</span><span class="n">include</span><span class="w"> </span><span class="s">&quot;util/types.h&quot;</span>
</span><span id="__span-30-7"><a id="__codelineno-30-7" name="__codelineno-30-7" href="#__codelineno-30-7"></a><span class="w">  </span><span class="mi">8</span><span class="w"> </span>
</span><span id="__span-30-8"><a id="__codelineno-30-8" name="__codelineno-30-8" href="#__codelineno-30-8"></a><span class="w">  </span><span class="mi">9</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">main</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-30-9"><a id="__codelineno-30-9" name="__codelineno-30-9" href="#__codelineno-30-9"></a><span class="w"> </span><span class="mi">10</span><span class="w">     </span><span class="kt">int</span><span class="w"> </span><span class="n">main_sem</span><span class="p">,</span><span class="w"> </span><span class="n">child_sem</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span><span id="__span-30-10"><a id="__codelineno-30-10" name="__codelineno-30-10" href="#__codelineno-30-10"></a><span class="w"> </span><span class="mi">11</span><span class="w">     </span><span class="n">main_sem</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sem_new</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
</span><span id="__span-30-11"><a id="__codelineno-30-11" name="__codelineno-30-11" href="#__codelineno-30-11"></a><span class="w"> </span><span class="mi">12</span><span class="w">     </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="n">child_sem</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sem_new</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-30-12"><a id="__codelineno-30-12" name="__codelineno-30-12" href="#__codelineno-30-12"></a><span class="w"> </span><span class="mi">13</span><span class="w">     </span><span class="kt">int</span><span class="w"> </span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fork</span><span class="p">();</span>
</span><span id="__span-30-13"><a id="__codelineno-30-13" name="__codelineno-30-13" href="#__codelineno-30-13"></a><span class="w"> </span><span class="mi">14</span><span class="w">     </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-30-14"><a id="__codelineno-30-14" name="__codelineno-30-14" href="#__codelineno-30-14"></a><span class="w"> </span><span class="mi">15</span><span class="w">         </span><span class="n">pid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fork</span><span class="p">();</span>
</span><span id="__span-30-15"><a id="__codelineno-30-15" name="__codelineno-30-15" href="#__codelineno-30-15"></a><span class="w"> </span><span class="mi">16</span><span class="w">         </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-30-16"><a id="__codelineno-30-16" name="__codelineno-30-16" href="#__codelineno-30-16"></a><span class="w"> </span><span class="mi">17</span><span class="w">             </span><span class="n">sem_P</span><span class="p">(</span><span class="n">child_sem</span><span class="p">[</span><span class="n">pid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">]);</span>
</span><span id="__span-30-17"><a id="__codelineno-30-17" name="__codelineno-30-17" href="#__codelineno-30-17"></a><span class="w"> </span><span class="mi">18</span><span class="w">             </span><span class="n">printu</span><span class="p">(</span><span class="s">&quot;Child%d print %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">pid</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>
</span><span id="__span-30-18"><a id="__codelineno-30-18" name="__codelineno-30-18" href="#__codelineno-30-18"></a><span class="w"> </span><span class="mi">19</span><span class="w">             </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">pid</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="n">sem_V</span><span class="p">(</span><span class="n">child_sem</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="n">sem_V</span><span class="p">(</span><span class="n">main_sem</span><span class="p">);</span>
</span><span id="__span-30-19"><a id="__codelineno-30-19" name="__codelineno-30-19" href="#__codelineno-30-19"></a><span class="w"> </span><span class="mi">20</span><span class="w">         </span><span class="p">}</span>
</span><span id="__span-30-20"><a id="__codelineno-30-20" name="__codelineno-30-20" href="#__codelineno-30-20"></a><span class="w"> </span><span class="mi">21</span><span class="w">     </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-30-21"><a id="__codelineno-30-21" name="__codelineno-30-21" href="#__codelineno-30-21"></a><span class="w"> </span><span class="mi">22</span><span class="w">         </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-30-22"><a id="__codelineno-30-22" name="__codelineno-30-22" href="#__codelineno-30-22"></a><span class="w"> </span><span class="mi">23</span><span class="w">             </span><span class="n">sem_P</span><span class="p">(</span><span class="n">main_sem</span><span class="p">);</span>
</span><span id="__span-30-23"><a id="__codelineno-30-23" name="__codelineno-30-23" href="#__codelineno-30-23"></a><span class="w"> </span><span class="mi">24</span><span class="w">             </span><span class="n">printu</span><span class="p">(</span><span class="s">&quot;Parent print %d</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">);</span>
</span><span id="__span-30-24"><a id="__codelineno-30-24" name="__codelineno-30-24" href="#__codelineno-30-24"></a><span class="w"> </span><span class="mi">25</span><span class="w">             </span><span class="n">sem_V</span><span class="p">(</span><span class="n">child_sem</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
</span><span id="__span-30-25"><a id="__codelineno-30-25" name="__codelineno-30-25" href="#__codelineno-30-25"></a><span class="w"> </span><span class="mi">26</span><span class="w">         </span><span class="p">}</span>
</span><span id="__span-30-26"><a id="__codelineno-30-26" name="__codelineno-30-26" href="#__codelineno-30-26"></a><span class="w"> </span><span class="mi">27</span><span class="w">     </span><span class="p">}</span>
</span><span id="__span-30-27"><a id="__codelineno-30-27" name="__codelineno-30-27" href="#__codelineno-30-27"></a><span class="w"> </span><span class="mi">28</span><span class="w">     </span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
</span><span id="__span-30-28"><a id="__codelineno-30-28" name="__codelineno-30-28" href="#__codelineno-30-28"></a><span class="w"> </span><span class="mi">29</span><span class="w">     </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</span><span id="__span-30-29"><a id="__codelineno-30-29" name="__codelineno-30-29" href="#__codelineno-30-29"></a><span class="w"> </span><span class="mi">30</span><span class="w"> </span><span class="p">}</span>
</span></code></pre></div>
<p>以上程序通过信号量的增减，控制主进程和两个子进程的输出按主进程，第一个子进程，第二个子进程，主进程，第一个子进程，第二个子进程……这样的顺序轮流输出，如上面的应用预期输出如下：</p>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-31-1"><a id="__codelineno-31-1" name="__codelineno-31-1" href="#__codelineno-31-1"></a>In<span class="w"> </span>m_start,<span class="w"> </span>hartid:0
</span><span id="__span-31-2"><a id="__codelineno-31-2" name="__codelineno-31-2" href="#__codelineno-31-2"></a>HTIF<span class="w"> </span>is<span class="w"> </span>available!
</span><span id="__span-31-3"><a id="__codelineno-31-3" name="__codelineno-31-3" href="#__codelineno-31-3"></a><span class="o">(</span>Emulated<span class="o">)</span><span class="w"> </span>memory<span class="w"> </span>size:<span class="w"> </span><span class="m">2048</span><span class="w"> </span>MB
</span><span id="__span-31-4"><a id="__codelineno-31-4" name="__codelineno-31-4" href="#__codelineno-31-4"></a>Enter<span class="w"> </span>supervisor<span class="w"> </span>mode...
</span><span id="__span-31-5"><a id="__codelineno-31-5" name="__codelineno-31-5" href="#__codelineno-31-5"></a>PKE<span class="w"> </span>kernel<span class="w"> </span>start<span class="w"> </span>0x0000000080000000,<span class="w"> </span>PKE<span class="w"> </span>kernel<span class="w"> </span>end:<span class="w"> </span>0x0000000080009000,<span class="w"> </span>PKE<span class="w"> </span>kernel<span class="w"> </span>size:<span class="w"> </span>0x0000000000009000<span class="w"> </span>.
</span><span id="__span-31-6"><a id="__codelineno-31-6" name="__codelineno-31-6" href="#__codelineno-31-6"></a>free<span class="w"> </span>physical<span class="w"> </span>memory<span class="w"> </span>address:<span class="w"> </span><span class="o">[</span>0x0000000080009000,<span class="w"> </span>0x0000000087ffffff<span class="o">]</span><span class="w"> </span>
</span><span id="__span-31-7"><a id="__codelineno-31-7" name="__codelineno-31-7" href="#__codelineno-31-7"></a>kernel<span class="w"> </span>memory<span class="w"> </span>manager<span class="w"> </span>is<span class="w"> </span>initializing<span class="w"> </span>...
</span><span id="__span-31-8"><a id="__codelineno-31-8" name="__codelineno-31-8" href="#__codelineno-31-8"></a>KERN_BASE<span class="w"> </span>0x0000000080000000
</span><span id="__span-31-9"><a id="__codelineno-31-9" name="__codelineno-31-9" href="#__codelineno-31-9"></a>physical<span class="w"> </span>address<span class="w"> </span>of<span class="w"> </span>_etext<span class="w"> </span>is:<span class="w"> </span>0x0000000080005000
</span><span id="__span-31-10"><a id="__codelineno-31-10" name="__codelineno-31-10" href="#__codelineno-31-10"></a>kernel<span class="w"> </span>page<span class="w"> </span>table<span class="w"> </span>is<span class="w"> </span>on<span class="w"> </span>
</span><span id="__span-31-11"><a id="__codelineno-31-11" name="__codelineno-31-11" href="#__codelineno-31-11"></a>Switch<span class="w"> </span>to<span class="w"> </span>user<span class="w"> </span>mode...
</span><span id="__span-31-12"><a id="__codelineno-31-12" name="__codelineno-31-12" href="#__codelineno-31-12"></a><span class="k">in</span><span class="w"> </span>alloc_proc.<span class="w"> </span>user<span class="w"> </span>frame<span class="w"> </span>0x0000000087fbc000,<span class="w"> </span>user<span class="w"> </span>stack<span class="w"> </span>0x000000007ffff000,<span class="w"> </span>user<span class="w"> </span>kstack<span class="w"> </span>0x0000000087fbb000<span class="w"> </span>
</span><span id="__span-31-13"><a id="__codelineno-31-13" name="__codelineno-31-13" href="#__codelineno-31-13"></a>User<span class="w"> </span>application<span class="w"> </span>is<span class="w"> </span>loading.
</span><span id="__span-31-14"><a id="__codelineno-31-14" name="__codelineno-31-14" href="#__codelineno-31-14"></a>Application:<span class="w"> </span>obj/app_semaphore
</span><span id="__span-31-15"><a id="__codelineno-31-15" name="__codelineno-31-15" href="#__codelineno-31-15"></a>CODE_SEGMENT<span class="w"> </span>added<span class="w"> </span>at<span class="w"> </span>mapped<span class="w"> </span>info<span class="w"> </span>offset:3
</span><span id="__span-31-16"><a id="__codelineno-31-16" name="__codelineno-31-16" href="#__codelineno-31-16"></a>DATA_SEGMENT<span class="w"> </span>added<span class="w"> </span>at<span class="w"> </span>mapped<span class="w"> </span>info<span class="w"> </span>offset:4
</span><span id="__span-31-17"><a id="__codelineno-31-17" name="__codelineno-31-17" href="#__codelineno-31-17"></a>Application<span class="w"> </span>program<span class="w"> </span>entry<span class="w"> </span>point<span class="w"> </span><span class="o">(</span>virtual<span class="w"> </span>address<span class="o">)</span>:<span class="w"> </span>0x00000000000100b0
</span><span id="__span-31-18"><a id="__codelineno-31-18" name="__codelineno-31-18" href="#__codelineno-31-18"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">0</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-31-19"><a id="__codelineno-31-19" name="__codelineno-31-19" href="#__codelineno-31-19"></a>going<span class="w"> </span>to<span class="w"> </span>schedule<span class="w"> </span>process<span class="w"> </span><span class="m">0</span><span class="w"> </span>to<span class="w"> </span>run.
</span><span id="__span-31-20"><a id="__codelineno-31-20" name="__codelineno-31-20" href="#__codelineno-31-20"></a>User<span class="w"> </span>call<span class="w"> </span>fork.
</span><span id="__span-31-21"><a id="__codelineno-31-21" name="__codelineno-31-21" href="#__codelineno-31-21"></a>will<span class="w"> </span>fork<span class="w"> </span>a<span class="w"> </span>child<span class="w"> </span>from<span class="w"> </span>parent<span class="w"> </span><span class="m">0</span>.
</span><span id="__span-31-22"><a id="__codelineno-31-22" name="__codelineno-31-22" href="#__codelineno-31-22"></a><span class="k">in</span><span class="w"> </span>alloc_proc.<span class="w"> </span>user<span class="w"> </span>frame<span class="w"> </span>0x0000000087fae000,<span class="w"> </span>user<span class="w"> </span>stack<span class="w"> </span>0x000000007ffff000,<span class="w"> </span>user<span class="w"> </span>kstack<span class="w"> </span>0x0000000087fad000<span class="w"> </span>
</span><span id="__span-31-23"><a id="__codelineno-31-23" name="__codelineno-31-23" href="#__codelineno-31-23"></a>do_fork<span class="w"> </span>map<span class="w"> </span>code<span class="w"> </span>segment<span class="w"> </span>at<span class="w"> </span>pa:0000000087fb2000<span class="w"> </span>of<span class="w"> </span>parent<span class="w"> </span>to<span class="w"> </span>child<span class="w"> </span>at<span class="w"> </span>va:0000000000010000.
</span><span id="__span-31-24"><a id="__codelineno-31-24" name="__codelineno-31-24" href="#__codelineno-31-24"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">1</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-31-25"><a id="__codelineno-31-25" name="__codelineno-31-25" href="#__codelineno-31-25"></a>Parent<span class="w"> </span>print<span class="w"> </span><span class="m">0</span>
</span><span id="__span-31-26"><a id="__codelineno-31-26" name="__codelineno-31-26" href="#__codelineno-31-26"></a>going<span class="w"> </span>to<span class="w"> </span>schedule<span class="w"> </span>process<span class="w"> </span><span class="m">1</span><span class="w"> </span>to<span class="w"> </span>run.
</span><span id="__span-31-27"><a id="__codelineno-31-27" name="__codelineno-31-27" href="#__codelineno-31-27"></a>User<span class="w"> </span>call<span class="w"> </span>fork.
</span><span id="__span-31-28"><a id="__codelineno-31-28" name="__codelineno-31-28" href="#__codelineno-31-28"></a>will<span class="w"> </span>fork<span class="w"> </span>a<span class="w"> </span>child<span class="w"> </span>from<span class="w"> </span>parent<span class="w"> </span><span class="m">1</span>.
</span><span id="__span-31-29"><a id="__codelineno-31-29" name="__codelineno-31-29" href="#__codelineno-31-29"></a><span class="k">in</span><span class="w"> </span>alloc_proc.<span class="w"> </span>user<span class="w"> </span>frame<span class="w"> </span>0x0000000087fa2000,<span class="w"> </span>user<span class="w"> </span>stack<span class="w"> </span>0x000000007ffff000,<span class="w"> </span>user<span class="w"> </span>kstack<span class="w"> </span>0x0000000087fa1000<span class="w"> </span>
</span><span id="__span-31-30"><a id="__codelineno-31-30" name="__codelineno-31-30" href="#__codelineno-31-30"></a>do_fork<span class="w"> </span>map<span class="w"> </span>code<span class="w"> </span>segment<span class="w"> </span>at<span class="w"> </span>pa:0000000087fb2000<span class="w"> </span>of<span class="w"> </span>parent<span class="w"> </span>to<span class="w"> </span>child<span class="w"> </span>at<span class="w"> </span>va:0000000000010000.
</span><span id="__span-31-31"><a id="__codelineno-31-31" name="__codelineno-31-31" href="#__codelineno-31-31"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">2</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-31-32"><a id="__codelineno-31-32" name="__codelineno-31-32" href="#__codelineno-31-32"></a>Child0<span class="w"> </span>print<span class="w"> </span><span class="m">0</span>
</span><span id="__span-31-33"><a id="__codelineno-31-33" name="__codelineno-31-33" href="#__codelineno-31-33"></a>going<span class="w"> </span>to<span class="w"> </span>schedule<span class="w"> </span>process<span class="w"> </span><span class="m">2</span><span class="w"> </span>to<span class="w"> </span>run.
</span><span id="__span-31-34"><a id="__codelineno-31-34" name="__codelineno-31-34" href="#__codelineno-31-34"></a>Child1<span class="w"> </span>print<span class="w"> </span><span class="m">0</span>
</span><span id="__span-31-35"><a id="__codelineno-31-35" name="__codelineno-31-35" href="#__codelineno-31-35"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">0</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-31-36"><a id="__codelineno-31-36" name="__codelineno-31-36" href="#__codelineno-31-36"></a>going<span class="w"> </span>to<span class="w"> </span>schedule<span class="w"> </span>process<span class="w"> </span><span class="m">0</span><span class="w"> </span>to<span class="w"> </span>run.
</span><span id="__span-31-37"><a id="__codelineno-31-37" name="__codelineno-31-37" href="#__codelineno-31-37"></a>Parent<span class="w"> </span>print<span class="w"> </span><span class="m">1</span>
</span><span id="__span-31-38"><a id="__codelineno-31-38" name="__codelineno-31-38" href="#__codelineno-31-38"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">1</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-31-39"><a id="__codelineno-31-39" name="__codelineno-31-39" href="#__codelineno-31-39"></a>going<span class="w"> </span>to<span class="w"> </span>schedule<span class="w"> </span>process<span class="w"> </span><span class="m">1</span><span class="w"> </span>to<span class="w"> </span>run.
</span><span id="__span-31-40"><a id="__codelineno-31-40" name="__codelineno-31-40" href="#__codelineno-31-40"></a>Child0<span class="w"> </span>print<span class="w"> </span><span class="m">1</span>
</span><span id="__span-31-41"><a id="__codelineno-31-41" name="__codelineno-31-41" href="#__codelineno-31-41"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">2</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-31-42"><a id="__codelineno-31-42" name="__codelineno-31-42" href="#__codelineno-31-42"></a>going<span class="w"> </span>to<span class="w"> </span>schedule<span class="w"> </span>process<span class="w"> </span><span class="m">2</span><span class="w"> </span>to<span class="w"> </span>run.
</span><span id="__span-31-43"><a id="__codelineno-31-43" name="__codelineno-31-43" href="#__codelineno-31-43"></a>Child1<span class="w"> </span>print<span class="w"> </span><span class="m">1</span>
</span><span id="__span-31-44"><a id="__codelineno-31-44" name="__codelineno-31-44" href="#__codelineno-31-44"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">0</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-31-45"><a id="__codelineno-31-45" name="__codelineno-31-45" href="#__codelineno-31-45"></a>going<span class="w"> </span>to<span class="w"> </span>schedule<span class="w"> </span>process<span class="w"> </span><span class="m">0</span><span class="w"> </span>to<span class="w"> </span>run.
</span><span id="__span-31-46"><a id="__codelineno-31-46" name="__codelineno-31-46" href="#__codelineno-31-46"></a>Parent<span class="w"> </span>print<span class="w"> </span><span class="m">2</span>
</span><span id="__span-31-47"><a id="__codelineno-31-47" name="__codelineno-31-47" href="#__codelineno-31-47"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">1</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-31-48"><a id="__codelineno-31-48" name="__codelineno-31-48" href="#__codelineno-31-48"></a>going<span class="w"> </span>to<span class="w"> </span>schedule<span class="w"> </span>process<span class="w"> </span><span class="m">1</span><span class="w"> </span>to<span class="w"> </span>run.
</span><span id="__span-31-49"><a id="__codelineno-31-49" name="__codelineno-31-49" href="#__codelineno-31-49"></a>Child0<span class="w"> </span>print<span class="w"> </span><span class="m">2</span>
</span><span id="__span-31-50"><a id="__codelineno-31-50" name="__codelineno-31-50" href="#__codelineno-31-50"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">2</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-31-51"><a id="__codelineno-31-51" name="__codelineno-31-51" href="#__codelineno-31-51"></a>going<span class="w"> </span>to<span class="w"> </span>schedule<span class="w"> </span>process<span class="w"> </span><span class="m">2</span><span class="w"> </span>to<span class="w"> </span>run.
</span><span id="__span-31-52"><a id="__codelineno-31-52" name="__codelineno-31-52" href="#__codelineno-31-52"></a>Child1<span class="w"> </span>print<span class="w"> </span><span class="m">2</span>
</span><span id="__span-31-53"><a id="__codelineno-31-53" name="__codelineno-31-53" href="#__codelineno-31-53"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">0</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-31-54"><a id="__codelineno-31-54" name="__codelineno-31-54" href="#__codelineno-31-54"></a>going<span class="w"> </span>to<span class="w"> </span>schedule<span class="w"> </span>process<span class="w"> </span><span class="m">0</span><span class="w"> </span>to<span class="w"> </span>run.
</span><span id="__span-31-55"><a id="__codelineno-31-55" name="__codelineno-31-55" href="#__codelineno-31-55"></a>Parent<span class="w"> </span>print<span class="w"> </span><span class="m">3</span>
</span><span id="__span-31-56"><a id="__codelineno-31-56" name="__codelineno-31-56" href="#__codelineno-31-56"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">1</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-31-57"><a id="__codelineno-31-57" name="__codelineno-31-57" href="#__codelineno-31-57"></a>going<span class="w"> </span>to<span class="w"> </span>schedule<span class="w"> </span>process<span class="w"> </span><span class="m">1</span><span class="w"> </span>to<span class="w"> </span>run.
</span><span id="__span-31-58"><a id="__codelineno-31-58" name="__codelineno-31-58" href="#__codelineno-31-58"></a>Child0<span class="w"> </span>print<span class="w"> </span><span class="m">3</span>
</span><span id="__span-31-59"><a id="__codelineno-31-59" name="__codelineno-31-59" href="#__codelineno-31-59"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">2</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-31-60"><a id="__codelineno-31-60" name="__codelineno-31-60" href="#__codelineno-31-60"></a>going<span class="w"> </span>to<span class="w"> </span>schedule<span class="w"> </span>process<span class="w"> </span><span class="m">2</span><span class="w"> </span>to<span class="w"> </span>run.
</span><span id="__span-31-61"><a id="__codelineno-31-61" name="__codelineno-31-61" href="#__codelineno-31-61"></a>Child1<span class="w"> </span>print<span class="w"> </span><span class="m">3</span>
</span><span id="__span-31-62"><a id="__codelineno-31-62" name="__codelineno-31-62" href="#__codelineno-31-62"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">0</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-31-63"><a id="__codelineno-31-63" name="__codelineno-31-63" href="#__codelineno-31-63"></a>going<span class="w"> </span>to<span class="w"> </span>schedule<span class="w"> </span>process<span class="w"> </span><span class="m">0</span><span class="w"> </span>to<span class="w"> </span>run.
</span><span id="__span-31-64"><a id="__codelineno-31-64" name="__codelineno-31-64" href="#__codelineno-31-64"></a>Parent<span class="w"> </span>print<span class="w"> </span><span class="m">4</span>
</span><span id="__span-31-65"><a id="__codelineno-31-65" name="__codelineno-31-65" href="#__codelineno-31-65"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">1</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-31-66"><a id="__codelineno-31-66" name="__codelineno-31-66" href="#__codelineno-31-66"></a>going<span class="w"> </span>to<span class="w"> </span>schedule<span class="w"> </span>process<span class="w"> </span><span class="m">1</span><span class="w"> </span>to<span class="w"> </span>run.
</span><span id="__span-31-67"><a id="__codelineno-31-67" name="__codelineno-31-67" href="#__codelineno-31-67"></a>Child0<span class="w"> </span>print<span class="w"> </span><span class="m">4</span>
</span><span id="__span-31-68"><a id="__codelineno-31-68" name="__codelineno-31-68" href="#__codelineno-31-68"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">2</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-31-69"><a id="__codelineno-31-69" name="__codelineno-31-69" href="#__codelineno-31-69"></a>going<span class="w"> </span>to<span class="w"> </span>schedule<span class="w"> </span>process<span class="w"> </span><span class="m">2</span><span class="w"> </span>to<span class="w"> </span>run.
</span><span id="__span-31-70"><a id="__codelineno-31-70" name="__codelineno-31-70" href="#__codelineno-31-70"></a>Child1<span class="w"> </span>print<span class="w"> </span><span class="m">4</span>
</span><span id="__span-31-71"><a id="__codelineno-31-71" name="__codelineno-31-71" href="#__codelineno-31-71"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">0</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-31-72"><a id="__codelineno-31-72" name="__codelineno-31-72" href="#__codelineno-31-72"></a>going<span class="w"> </span>to<span class="w"> </span>schedule<span class="w"> </span>process<span class="w"> </span><span class="m">0</span><span class="w"> </span>to<span class="w"> </span>run.
</span><span id="__span-31-73"><a id="__codelineno-31-73" name="__codelineno-31-73" href="#__codelineno-31-73"></a>Parent<span class="w"> </span>print<span class="w"> </span><span class="m">5</span>
</span><span id="__span-31-74"><a id="__codelineno-31-74" name="__codelineno-31-74" href="#__codelineno-31-74"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">1</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-31-75"><a id="__codelineno-31-75" name="__codelineno-31-75" href="#__codelineno-31-75"></a>going<span class="w"> </span>to<span class="w"> </span>schedule<span class="w"> </span>process<span class="w"> </span><span class="m">1</span><span class="w"> </span>to<span class="w"> </span>run.
</span><span id="__span-31-76"><a id="__codelineno-31-76" name="__codelineno-31-76" href="#__codelineno-31-76"></a>Child0<span class="w"> </span>print<span class="w"> </span><span class="m">5</span>
</span><span id="__span-31-77"><a id="__codelineno-31-77" name="__codelineno-31-77" href="#__codelineno-31-77"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">2</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-31-78"><a id="__codelineno-31-78" name="__codelineno-31-78" href="#__codelineno-31-78"></a>going<span class="w"> </span>to<span class="w"> </span>schedule<span class="w"> </span>process<span class="w"> </span><span class="m">2</span><span class="w"> </span>to<span class="w"> </span>run.
</span><span id="__span-31-79"><a id="__codelineno-31-79" name="__codelineno-31-79" href="#__codelineno-31-79"></a>Child1<span class="w"> </span>print<span class="w"> </span><span class="m">5</span>
</span><span id="__span-31-80"><a id="__codelineno-31-80" name="__codelineno-31-80" href="#__codelineno-31-80"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">0</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-31-81"><a id="__codelineno-31-81" name="__codelineno-31-81" href="#__codelineno-31-81"></a>going<span class="w"> </span>to<span class="w"> </span>schedule<span class="w"> </span>process<span class="w"> </span><span class="m">0</span><span class="w"> </span>to<span class="w"> </span>run.
</span><span id="__span-31-82"><a id="__codelineno-31-82" name="__codelineno-31-82" href="#__codelineno-31-82"></a>Parent<span class="w"> </span>print<span class="w"> </span><span class="m">6</span>
</span><span id="__span-31-83"><a id="__codelineno-31-83" name="__codelineno-31-83" href="#__codelineno-31-83"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">1</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-31-84"><a id="__codelineno-31-84" name="__codelineno-31-84" href="#__codelineno-31-84"></a>going<span class="w"> </span>to<span class="w"> </span>schedule<span class="w"> </span>process<span class="w"> </span><span class="m">1</span><span class="w"> </span>to<span class="w"> </span>run.
</span><span id="__span-31-85"><a id="__codelineno-31-85" name="__codelineno-31-85" href="#__codelineno-31-85"></a>Child0<span class="w"> </span>print<span class="w"> </span><span class="m">6</span>
</span><span id="__span-31-86"><a id="__codelineno-31-86" name="__codelineno-31-86" href="#__codelineno-31-86"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">2</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-31-87"><a id="__codelineno-31-87" name="__codelineno-31-87" href="#__codelineno-31-87"></a>going<span class="w"> </span>to<span class="w"> </span>schedule<span class="w"> </span>process<span class="w"> </span><span class="m">2</span><span class="w"> </span>to<span class="w"> </span>run.
</span><span id="__span-31-88"><a id="__codelineno-31-88" name="__codelineno-31-88" href="#__codelineno-31-88"></a>Child1<span class="w"> </span>print<span class="w"> </span><span class="m">6</span>
</span><span id="__span-31-89"><a id="__codelineno-31-89" name="__codelineno-31-89" href="#__codelineno-31-89"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">0</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-31-90"><a id="__codelineno-31-90" name="__codelineno-31-90" href="#__codelineno-31-90"></a>going<span class="w"> </span>to<span class="w"> </span>schedule<span class="w"> </span>process<span class="w"> </span><span class="m">0</span><span class="w"> </span>to<span class="w"> </span>run.
</span><span id="__span-31-91"><a id="__codelineno-31-91" name="__codelineno-31-91" href="#__codelineno-31-91"></a>Parent<span class="w"> </span>print<span class="w"> </span><span class="m">7</span>
</span><span id="__span-31-92"><a id="__codelineno-31-92" name="__codelineno-31-92" href="#__codelineno-31-92"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">1</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-31-93"><a id="__codelineno-31-93" name="__codelineno-31-93" href="#__codelineno-31-93"></a>going<span class="w"> </span>to<span class="w"> </span>schedule<span class="w"> </span>process<span class="w"> </span><span class="m">1</span><span class="w"> </span>to<span class="w"> </span>run.
</span><span id="__span-31-94"><a id="__codelineno-31-94" name="__codelineno-31-94" href="#__codelineno-31-94"></a>Child0<span class="w"> </span>print<span class="w"> </span><span class="m">7</span>
</span><span id="__span-31-95"><a id="__codelineno-31-95" name="__codelineno-31-95" href="#__codelineno-31-95"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">2</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-31-96"><a id="__codelineno-31-96" name="__codelineno-31-96" href="#__codelineno-31-96"></a>going<span class="w"> </span>to<span class="w"> </span>schedule<span class="w"> </span>process<span class="w"> </span><span class="m">2</span><span class="w"> </span>to<span class="w"> </span>run.
</span><span id="__span-31-97"><a id="__codelineno-31-97" name="__codelineno-31-97" href="#__codelineno-31-97"></a>Child1<span class="w"> </span>print<span class="w"> </span><span class="m">7</span>
</span><span id="__span-31-98"><a id="__codelineno-31-98" name="__codelineno-31-98" href="#__codelineno-31-98"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">0</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-31-99"><a id="__codelineno-31-99" name="__codelineno-31-99" href="#__codelineno-31-99"></a>going<span class="w"> </span>to<span class="w"> </span>schedule<span class="w"> </span>process<span class="w"> </span><span class="m">0</span><span class="w"> </span>to<span class="w"> </span>run.
</span><span id="__span-31-100"><a id="__codelineno-31-100" name="__codelineno-31-100" href="#__codelineno-31-100"></a>Parent<span class="w"> </span>print<span class="w"> </span><span class="m">8</span>
</span><span id="__span-31-101"><a id="__codelineno-31-101" name="__codelineno-31-101" href="#__codelineno-31-101"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">1</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-31-102"><a id="__codelineno-31-102" name="__codelineno-31-102" href="#__codelineno-31-102"></a>going<span class="w"> </span>to<span class="w"> </span>schedule<span class="w"> </span>process<span class="w"> </span><span class="m">1</span><span class="w"> </span>to<span class="w"> </span>run.
</span><span id="__span-31-103"><a id="__codelineno-31-103" name="__codelineno-31-103" href="#__codelineno-31-103"></a>Child0<span class="w"> </span>print<span class="w"> </span><span class="m">8</span>
</span><span id="__span-31-104"><a id="__codelineno-31-104" name="__codelineno-31-104" href="#__codelineno-31-104"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">2</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-31-105"><a id="__codelineno-31-105" name="__codelineno-31-105" href="#__codelineno-31-105"></a>going<span class="w"> </span>to<span class="w"> </span>schedule<span class="w"> </span>process<span class="w"> </span><span class="m">2</span><span class="w"> </span>to<span class="w"> </span>run.
</span><span id="__span-31-106"><a id="__codelineno-31-106" name="__codelineno-31-106" href="#__codelineno-31-106"></a>Child1<span class="w"> </span>print<span class="w"> </span><span class="m">8</span>
</span><span id="__span-31-107"><a id="__codelineno-31-107" name="__codelineno-31-107" href="#__codelineno-31-107"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">0</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-31-108"><a id="__codelineno-31-108" name="__codelineno-31-108" href="#__codelineno-31-108"></a>going<span class="w"> </span>to<span class="w"> </span>schedule<span class="w"> </span>process<span class="w"> </span><span class="m">0</span><span class="w"> </span>to<span class="w"> </span>run.
</span><span id="__span-31-109"><a id="__codelineno-31-109" name="__codelineno-31-109" href="#__codelineno-31-109"></a>Parent<span class="w"> </span>print<span class="w"> </span><span class="m">9</span>
</span><span id="__span-31-110"><a id="__codelineno-31-110" name="__codelineno-31-110" href="#__codelineno-31-110"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">1</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-31-111"><a id="__codelineno-31-111" name="__codelineno-31-111" href="#__codelineno-31-111"></a>User<span class="w"> </span><span class="nb">exit</span><span class="w"> </span>with<span class="w"> </span>code:0.
</span><span id="__span-31-112"><a id="__codelineno-31-112" name="__codelineno-31-112" href="#__codelineno-31-112"></a>going<span class="w"> </span>to<span class="w"> </span>schedule<span class="w"> </span>process<span class="w"> </span><span class="m">1</span><span class="w"> </span>to<span class="w"> </span>run.
</span><span id="__span-31-113"><a id="__codelineno-31-113" name="__codelineno-31-113" href="#__codelineno-31-113"></a>Child0<span class="w"> </span>print<span class="w"> </span><span class="m">9</span>
</span><span id="__span-31-114"><a id="__codelineno-31-114" name="__codelineno-31-114" href="#__codelineno-31-114"></a>going<span class="w"> </span>to<span class="w"> </span>insert<span class="w"> </span>process<span class="w"> </span><span class="m">2</span><span class="w"> </span>to<span class="w"> </span>ready<span class="w"> </span>queue.
</span><span id="__span-31-115"><a id="__codelineno-31-115" name="__codelineno-31-115" href="#__codelineno-31-115"></a>User<span class="w"> </span><span class="nb">exit</span><span class="w"> </span>with<span class="w"> </span>code:0.
</span><span id="__span-31-116"><a id="__codelineno-31-116" name="__codelineno-31-116" href="#__codelineno-31-116"></a>going<span class="w"> </span>to<span class="w"> </span>schedule<span class="w"> </span>process<span class="w"> </span><span class="m">2</span><span class="w"> </span>to<span class="w"> </span>run.
</span><span id="__span-31-117"><a id="__codelineno-31-117" name="__codelineno-31-117" href="#__codelineno-31-117"></a>Child1<span class="w"> </span>print<span class="w"> </span><span class="m">9</span>
</span><span id="__span-31-118"><a id="__codelineno-31-118" name="__codelineno-31-118" href="#__codelineno-31-118"></a>User<span class="w"> </span><span class="nb">exit</span><span class="w"> </span>with<span class="w"> </span>code:0.
</span><span id="__span-31-119"><a id="__codelineno-31-119" name="__codelineno-31-119" href="#__codelineno-31-119"></a>no<span class="w"> </span>more<span class="w"> </span>ready<span class="w"> </span>processes,<span class="w"> </span>system<span class="w"> </span>shutdown<span class="w"> </span>now.
</span><span id="__span-31-120"><a id="__codelineno-31-120" name="__codelineno-31-120" href="#__codelineno-31-120"></a>System<span class="w"> </span>is<span class="w"> </span>shutting<span class="w"> </span>down<span class="w"> </span>with<span class="w"> </span><span class="nb">exit</span><span class="w"> </span>code<span class="w"> </span><span class="m">0</span>.
</span></code></pre></div>
<p><a name="lab3_challenge2_content"></a></p>
<h4 id="_15">实验内容</h4>
<p>本实验为挑战实验，基础代码将继承和使用lab3_3完成后的代码：</p>
<ul>
<li>（先提交lab3_3的答案，然后）切换到lab3_challenge2_semaphore、继承lab3_3中所做修改：</li>
</ul>
<div class="language-bash highlight"><pre><span></span><code><span id="__span-32-1"><a id="__codelineno-32-1" name="__codelineno-32-1" href="#__codelineno-32-1"></a>//切换到lab3_challenge2_semaphore
</span><span id="__span-32-2"><a id="__codelineno-32-2" name="__codelineno-32-2" href="#__codelineno-32-2"></a>$<span class="w"> </span>git<span class="w"> </span>checkout<span class="w"> </span>lab3_challenge2_semaphore
</span><span id="__span-32-3"><a id="__codelineno-32-3" name="__codelineno-32-3" href="#__codelineno-32-3"></a>
</span><span id="__span-32-4"><a id="__codelineno-32-4" name="__codelineno-32-4" href="#__codelineno-32-4"></a>//继承lab3_3以及之前的答案
</span><span id="__span-32-5"><a id="__codelineno-32-5" name="__codelineno-32-5" href="#__codelineno-32-5"></a>$<span class="w"> </span>git<span class="w"> </span>merge<span class="w"> </span>lab3_3_rrsched<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;continue to work on lab3_challenge1&quot;</span>
</span></code></pre></div>
<p><strong>注意：不同于基础实验，挑战实验的基础代码具有更大的不完整性，可能无法直接通过构造过程。</strong>
同样，不同于基础实验，我们在代码中也并未专门地哪些地方的代码需要填写，哪些地方的代码无须填写。这样，我们留给读者更大的“想象空间”。</p>
<ul>
<li>本实验的具体要求为：通过修改PKE内核和系统调用，为用户程序提供信号量功能。</li>
<li>注意：最终测试程序<strong>可能和给出的用户程序不同</strong>，但都只涉及信号量的相关操作。</li>
<li>提示：信号灯的结构<strong>不能开太大</strong>，否则会导致kernel_size出现问题</li>
</ul>
<p><a name="lab3_challenge2_guide"></a></p>
<h4 id="_16">实验指导</h4>
<ul>
<li>你对内核代码的修改可能包含以下内容：</li>
<li>添加系统调用，使得用户对信号量的操作可以在内核态处理</li>
<li>在内核中实现信号量的分配、释放和PV操作，当P操作处于等待状态时能够触发进程调度</li>
</ul>
<p><strong>注意：完成实验内容后，请读者另外编写应用，对自己的实现进行检测。</strong></p>
<p><strong>另外，后续的基础实验代码并不依赖挑战实验，所以读者可自行决定是否将自己的工作提交到本地代码仓库中（当然，提交到本地仓库是个好习惯，至少能保存自己的“作品”）。</strong></p>





                
              </article>
            </div>
          
          
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
            回到页面顶部
          </button>
        
      </main>
      
        <footer class="md-footer">
  
    
      
      <nav class="md-footer__inner md-grid" aria-label="页脚" >
        
          
          <a href="../chapter4_memory/" class="md-footer__link md-footer__link--prev" aria-label="上一页: Chapter4 memory" rel="prev">
            <div class="md-footer__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
            </div>
            <div class="md-footer__title">
              <div class="md-ellipsis">
                <span class="md-footer__direction">
                  上一页
                </span>
                Chapter4 memory
              </div>
            </div>
          </a>
        
        
          
          <a href="../chapter6_device_remove/" class="md-footer__link md-footer__link--next" aria-label="下一页: Chapter6 device remove" rel="next">
            <div class="md-footer__title">
              <div class="md-ellipsis">
                <span class="md-footer__direction">
                  下一页
                </span>
                Chapter6 device remove
              </div>
            </div>
            <div class="md-footer__button md-icon">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"/></svg>
            </div>
          </a>
        
      </nav>
    
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Copyright &copy; 2022 - 2023 Mr.Roll
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
    <a href="https://space.bilibili.com/445528299" target="_blank" rel="noopener" title="一只roll" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.3.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2023 Fonticons, Inc.--><path d="M488.6 104.1c16.7 18.1 24.4 39.7 23.3 65.7v202.4c-.4 26.4-9.2 48.1-26.5 65.1-17.2 17-39.1 25.9-65.5 26.7H92.02c-26.45-.8-48.21-9.8-65.28-27.2C9.682 419.4.767 396.5 0 368.2V169.8c.767-26 9.682-47.6 26.74-65.7C43.81 87.75 65.57 78.77 92.02 78h29.38L96.05 52.19c-5.75-5.73-8.63-13-8.63-21.79 0-8.8 2.88-16.06 8.63-21.797C101.8 2.868 109.1 0 117.9 0s16.1 2.868 21.9 8.603L213.1 78h88l74.5-69.397C381.7 2.868 389.2 0 398 0c8.8 0 16.1 2.868 21.9 8.603 5.7 5.737 8.6 12.997 8.6 21.797 0 8.79-2.9 16.06-8.6 21.79L394.6 78h29.3c26.4.77 48 9.75 64.7 26.1zm-38.8 69.7c-.4-9.6-3.7-17.4-10.7-23.5-5.2-6.1-14-9.4-22.7-9.8H96.05c-9.59.4-17.45 3.7-23.58 9.8-6.14 6.1-9.4 13.9-9.78 23.5v194.4c0 9.2 3.26 17 9.78 23.5s14.38 9.8 23.58 9.8H416.4c9.2 0 17-3.3 23.3-9.8 6.3-6.5 9.7-14.3 10.1-23.5V173.8zm-264.3 42.7c6.3 6.3 9.7 14.1 10.1 23.2V273c-.4 9.2-3.7 16.9-9.8 23.2-6.2 6.3-14 9.5-23.6 9.5-9.6 0-17.5-3.2-23.6-9.5-6.1-6.3-9.4-14-9.8-23.2v-33.3c.4-9.1 3.8-16.9 10.1-23.2 6.3-6.3 13.2-9.6 23.3-10 9.2.4 17 3.7 23.3 10zm191.5 0c6.3 6.3 9.7 14.1 10.1 23.2V273c-.4 9.2-3.7 16.9-9.8 23.2-6.1 6.3-14 9.5-23.6 9.5-9.6 0-17.4-3.2-23.6-9.5-7-6.3-9.4-14-9.7-23.2v-33.3c.3-9.1 3.7-16.9 10-23.2 6.3-6.3 14.1-9.6 23.3-10 9.2.4 17 3.7 23.3 10z"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["content.action.edit", "navigation.footer", "navigation.instant", "navigation.tracking", "navigation.top", "content.code.copy"], "search": "../../assets/javascripts/workers/search.208ed371.min.js", "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.efa0ade1.min.js"></script>
      
        <script src="../../javascripts/extra.js"></script>
      
        <script src="../../javascripts/shortcuts.js"></script>
      
    
  </body>
</html>